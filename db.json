{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/minos/source/CNAME","path":"CNAME","modified":0,"renderable":1},{"_id":"themes/minos/source/baidu_verify_yIFJ6q4kkQ.html","path":"baidu_verify_yIFJ6q4kkQ.html","modified":0,"renderable":1},{"_id":"themes/minos/source/baidu_verify_CXKjj3fklD.html","path":"baidu_verify_CXKjj3fklD.html","modified":0,"renderable":1},{"_id":"source/images/egg-cluster/3.jpg","path":"images/egg-cluster/3.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-cluster/1.jpg","path":"images/egg-cluster/1.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/3.jpg","path":"images/js-capture-error/3.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/8.jpg","path":"images/js-capture-error/8.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/6.jpg","path":"images/js-capture-error/6.jpg","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/monitor.pptx","path":"images/node-perf-heapdump-flame-graph/monitor.pptx","modified":0,"renderable":0},{"_id":"source/images/summary-2019/2.jpg","path":"images/summary-2019/2.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-libuv-timer-event-loop/image-20200301145547994.png","path":"images/v8-libuv-timer-event-loop/image-20200301145547994.png","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/1.jpg","path":"images/vue-component-extends/1.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/2.jpg","path":"images/vue-component-extends/2.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/4.jpg","path":"images/vue-component-extends/4.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/3.jpg","path":"images/vue-component-extends/3.jpg","modified":0,"renderable":0},{"_id":"themes/minos/source/css/insight.scss","path":"css/insight.scss","modified":0,"renderable":1},{"_id":"themes/minos/source/images/check.svg","path":"images/check.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/css/style.scss","path":"css/style.scss","modified":0,"renderable":1},{"_id":"themes/minos/source/images/question.svg","path":"images/question.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/logo.png","path":"images/logo.png","modified":0,"renderable":1},{"_id":"themes/minos/source/images/exclamation.svg","path":"images/exclamation.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/info.svg","path":"images/info.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/quote-left.svg","path":"images/quote-left.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/js/script.js","path":"js/script.js","modified":0,"renderable":1},{"_id":"themes/minos/source/js/insight.js","path":"js/insight.js","modified":0,"renderable":1},{"_id":"source/images/egg-cluster/4.jpg","path":"images/egg-cluster/4.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-cluster/2.jpg","path":"images/egg-cluster/2.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/9.jpg","path":"images/js-capture-error/9.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/7.jpg","path":"images/js-capture-error/7.jpg","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.svg","path":"images/node-perf-heapdump-flame-graph/node-flamegraph.svg","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version/arch.png","path":"images/node-gateway-ssr-multi-version/arch.png","modified":0,"renderable":0},{"_id":"source/images/v8-libuv-timer-event-loop/loop_iteration.png","path":"images/v8-libuv-timer-event-loop/loop_iteration.png","modified":0,"renderable":0},{"_id":"source/images/bec/2.jpeg","path":"images/bec/2.jpeg","modified":0,"renderable":0},{"_id":"source/images/egg-boot/egg-boot.jpg","path":"images/egg-boot/egg-boot.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/10.jpg","path":"images/js-capture-error/10.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/4.jpg","path":"images/js-capture-error/4.jpg","modified":0,"renderable":0},{"_id":"source/images/js-css-image-loading/1.png","path":"images/js-css-image-loading/1.png","modified":0,"renderable":0},{"_id":"source/images/nodejs-istio-k8s-docker/book-app.png","path":"images/nodejs-istio-k8s-docker/book-app.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-29.jpg","modified":0,"renderable":0},{"_id":"source/images/summary-2019/1.png","path":"images/summary-2019/1.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-26.jpg","modified":0,"renderable":0},{"_id":"source/images/bec/1.jpeg","path":"images/bec/1.jpeg","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_01.png","path":"images/node-perf-heapdump-flame-graph/connection_01.png","modified":0,"renderable":0},{"_id":"source/images/monitor-hub/image-20200403185942130.png","path":"images/monitor-hub/image-20200403185942130.png","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/heapdump_01.png","path":"images/node-perf-heapdump-flame-graph/heapdump_01.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-04.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-19.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-18.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-20.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-27.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-31.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-30.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-28.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/not-change-types-1.png","path":"images/v8-parser-compiler/not-change-types-1.png","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/not-change-types-2.png","path":"images/v8-parser-compiler/not-change-types-2.png","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/not-change-types-3.png","path":"images/v8-parser-compiler/not-change-types-3.png","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_02.png","path":"images/node-perf-heapdump-flame-graph/connection_02.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-06.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-07.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-09.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-17.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parse-time.png","path":"images/v8-parser-compiler/parse-time.png","modified":0,"renderable":0},{"_id":"source/images/monitor-hub/image-20200403210837664.png","path":"images/monitor-hub/image-20200403210837664.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-05.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-08.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-10.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-11.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-13.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-25.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-24.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-12.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parse-time-2.png","path":"images/v8-parser-compiler/parse-time-2.png","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/1.png","path":"images/js-capture-error/1.png","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/5.jpg","path":"images/js-capture-error/5.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parser-phase.png","path":"images/v8-parser-compiler/parser-phase.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-21.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-02.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-23.png","path":"images/travel-zhoushan/travel-zhoushan-23.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-32.png","path":"images/travel-zhoushan/travel-zhoushan-32.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-22.jpg","modified":0,"renderable":0},{"_id":"source/images/nodejs-istio-k8s-docker/arch.jpg","path":"images/nodejs-istio-k8s-docker/arch.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parse-time-1.png","path":"images/v8-parser-compiler/parse-time-1.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-16.png","path":"images/travel-zhoushan/travel-zhoushan-16.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-03.png","path":"images/travel-zhoushan/travel-zhoushan-03.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-12.jpg","path":"images/travel-zhoushan/travel-zhoushan-12.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-01.png","path":"images/travel-zhoushan/travel-zhoushan-01.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-13.jpg","path":"images/travel-zhoushan/travel-zhoushan-13.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/2.jpg","path":"images/js-capture-error/2.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/v8-pare-compile-cost.png","path":"images/v8-parser-compiler/v8-pare-compile-cost.png","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.png","path":"images/node-perf-heapdump-flame-graph/node-flamegraph.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-29.jpg","path":"images/travel-zhoushan/travel-zhoushan-29.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/27.jpg","path":"images/traveling-to-the-philippines/27.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/26.jpg","path":"images/traveling-to-the-philippines/26.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-15.mp4","path":"images/travel-zhoushan/travel-zhoushan-15.mp4","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/2.jpg","path":"images/traveling-to-the-philippines/2.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/13.jpg","path":"images/traveling-to-the-philippines/13.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/25.jpg","path":"images/traveling-to-the-philippines/25.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-04.jpg","path":"images/travel-zhoushan/travel-zhoushan-04.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-26.jpg","path":"images/travel-zhoushan/travel-zhoushan-26.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/6.jpg","path":"images/traveling-to-the-philippines/6.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/11.jpg","path":"images/traveling-to-the-philippines/11.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/9.jpg","path":"images/traveling-to-the-philippines/9.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/12.jpg","path":"images/traveling-to-the-philippines/12.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/34.jpg","path":"images/traveling-to-the-philippines/34.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-24.jpg","path":"images/travel-zhoushan/travel-zhoushan-24.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-28.jpg","path":"images/travel-zhoushan/travel-zhoushan-28.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/17.jpg","path":"images/traveling-to-the-philippines/17.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/3.jpg","path":"images/traveling-to-the-philippines/3.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/4.jpg","path":"images/traveling-to-the-philippines/4.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/23.jpg","path":"images/traveling-to-the-philippines/23.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-17.jpg","path":"images/travel-zhoushan/travel-zhoushan-17.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/20.jpg","path":"images/traveling-to-the-philippines/20.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-05.jpg","path":"images/travel-zhoushan/travel-zhoushan-05.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/31.jpg","path":"images/traveling-to-the-philippines/31.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-09.jpg","path":"images/travel-zhoushan/travel-zhoushan-09.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-30.jpg","path":"images/travel-zhoushan/travel-zhoushan-30.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/14.jpg","path":"images/traveling-to-the-philippines/14.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-27.jpg","path":"images/travel-zhoushan/travel-zhoushan-27.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/30.jpg","path":"images/traveling-to-the-philippines/30.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-19.jpg","path":"images/travel-zhoushan/travel-zhoushan-19.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/1.jpg","path":"images/traveling-to-the-philippines/1.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-31.jpg","path":"images/travel-zhoushan/travel-zhoushan-31.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/32.jpg","path":"images/traveling-to-the-philippines/32.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-20.jpg","path":"images/travel-zhoushan/travel-zhoushan-20.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-08.jpg","path":"images/travel-zhoushan/travel-zhoushan-08.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-18.jpg","path":"images/travel-zhoushan/travel-zhoushan-18.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-25.jpg","path":"images/travel-zhoushan/travel-zhoushan-25.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/10.jpg","path":"images/traveling-to-the-philippines/10.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/29.jpg","path":"images/traveling-to-the-philippines/29.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/8.jpg","path":"images/traveling-to-the-philippines/8.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/28.jpg","path":"images/traveling-to-the-philippines/28.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-10.jpg","path":"images/travel-zhoushan/travel-zhoushan-10.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-21.jpg","path":"images/travel-zhoushan/travel-zhoushan-21.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/24.jpg","path":"images/traveling-to-the-philippines/24.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/16.jpg","path":"images/traveling-to-the-philippines/16.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-06.jpg","path":"images/travel-zhoushan/travel-zhoushan-06.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-11.jpg","path":"images/travel-zhoushan/travel-zhoushan-11.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/7.jpg","path":"images/traveling-to-the-philippines/7.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-02.jpg","path":"images/travel-zhoushan/travel-zhoushan-02.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/15.jpg","path":"images/traveling-to-the-philippines/15.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/33.jpeg","path":"images/traveling-to-the-philippines/33.jpeg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-07.jpg","path":"images/travel-zhoushan/travel-zhoushan-07.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/22.jpg","path":"images/traveling-to-the-philippines/22.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-22.jpg","path":"images/travel-zhoushan/travel-zhoushan-22.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/21.jpg","path":"images/traveling-to-the-philippines/21.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/19.jpg","path":"images/traveling-to-the-philippines/19.jpg","modified":0,"renderable":0},{"_id":"source/images/lighthouse/report.png","path":"images/lighthouse/report.png","modified":0,"renderable":0}],"Cache":[{"_id":"themes/minos/.gitignore","hash":"8b02e7219e2dd9b50d198819fd7d8f74ebc9db2a","modified":1594119839725},{"_id":"themes/minos/README.md","hash":"ba6b4e134d718704cfd030e106bf24d6ef8b496d","modified":1594119839726},{"_id":"themes/minos/LICENSE","hash":"ca01a2d52b59346e82f079c593df6cb26dd9a7a5","modified":1594119839725},{"_id":"themes/minos/_config.yml.example","hash":"28c6c5604380fb6cc5a99639fa445c40205764ba","modified":1594119839726},{"_id":"themes/minos/package.json","hash":"f9d450db80149dea6c372990cdf51dfde901e5cc","modified":1594119839745},{"_id":"source/_posts/egg-boot.md","hash":"f6096e8d4e2886307ba0d4c7667a5484ea010be7","modified":1594116685586},{"_id":"source/_posts/child_process-exec-fork-spawn.md","hash":"a384d8ce73e31c9248ab04667df9b3129391aa3b","modified":1594116685586},{"_id":"source/_posts/bec.md","hash":"87b9350ffd9ac0a4b83fb6001161c55be96ead5d","modified":1594116685585},{"_id":"source/_posts/egg-cluster.md","hash":"908503ecfe15cbc6e366bf032b4055a1ea1b37a6","modified":1594116685586},{"_id":"source/_posts/lighthouse-ci-1.md","hash":"a62700abc5fc954ac1c307a83aef0ce9bced3561","modified":1594130430607},{"_id":"source/_posts/express-gateway.md","hash":"5ce9bf574dbcc036c5ff9b9bc5051b8dd0127aeb","modified":1594116685587},{"_id":"source/_posts/js-capture-error.md","hash":"c204a4727649e9faa26dcf5647c2b28b2d44b4d4","modified":1594116685587},{"_id":"source/_posts/js-css-image-loading.md","hash":"4886ed93878da0dcf0daa86eb004b06509dd97b5","modified":1594116685587},{"_id":"source/_posts/monitor-hub.md","hash":"7ce2a737deb11834817a9b1899e91d48686c5aca","modified":1594116685587},{"_id":"source/_posts/node-gateway-ssr-multi-version.md","hash":"dff2e134ddb0c9c687c00361853f99e58af048da","modified":1594116685587},{"_id":"source/_posts/node-perf-heapdump-flame-graph.md","hash":"bf426a3a8b92d628c808d0a3d289eadcbb81eb49","modified":1594116685588},{"_id":"source/_posts/nodejs-istio-k8s-docker.md","hash":"c3ec267a1bd71b85ba3637860ae99eed780dcdbb","modified":1594116685589},{"_id":"source/_posts/node-js-net-cluster-fork.md","hash":"62ae91d7cd88e33d1bd6ef6baa3e933e5b9c0aa1","modified":1594116685588},{"_id":"source/_posts/summary-2019.md","hash":"0f60f3a3216df42f40f5cc5cc4eab97f37b5b536","modified":1594116685589},{"_id":"source/_posts/the-quality-of-a-company-first-look-at-HR-department.md","hash":"6ec330223a159cd72eb0c698228a2fc59586e0c8","modified":1594116685589},{"_id":"source/_posts/travel-zhoushan.md","hash":"16b4f3f9b64a3acc68c304b34a0550f4f171f3bc","modified":1594116685589},{"_id":"source/_posts/traveling-to-the-philippines.md","hash":"1f1c0d1bdc5ead8ae92793b136a77f5b9491f099","modified":1594116685590},{"_id":"source/_posts/v8-libuv-timer-event-loop.md","hash":"4061a6f647fb2105ecf586ea7f69fa227c6930c2","modified":1594116685590},{"_id":"source/_posts/v8-parser-compiler-javascript.md","hash":"c28522efcd24306d26459f8615d97eab9b1b55fd","modified":1594116685591},{"_id":"source/_posts/vue-component-extends.md","hash":"37a4738d36d3621ab86e407e036a621be79baeec","modified":1594116685591},{"_id":"themes/minos/languages/es.yml","hash":"5c35950221411e34e7a9821d0b0671da9a458d8c","modified":1594119839727},{"_id":"themes/minos/languages/en.yml","hash":"ef98c8674fed78f2350598ee8b15fcd53fbd2ae5","modified":1594119839727},{"_id":"themes/minos/languages/ko.yml","hash":"1acf3f959f1d2b4f7a77e7e82851821aa8635362","modified":1594119839728},{"_id":"themes/minos/scripts/01_check.js","hash":"b26b19011a6eb61e61419331a7f9c5fdf553d830","modified":1594119839745},{"_id":"themes/minos/scripts/10_i18n.js","hash":"346a09259e15913871e12c7418a639b8d65df570","modified":1594119839746},{"_id":"themes/minos/scripts/99_config.js","hash":"d41a5df0a442728fbc66514476fe043e416d7438","modified":1594119839746},{"_id":"themes/minos/languages/ru.yml","hash":"8e5a58176bf943432ba6e4f1981d9b98fdea36a4","modified":1594119839728},{"_id":"themes/minos/scripts/99_tags.js","hash":"91369a4d8376bc981a9bad9c5dde4b3e775e5cb5","modified":1594119839747},{"_id":"themes/minos/scripts/rfc5646.js","hash":"8ecf38d0ec7145720ea8e888da314131712770e8","modified":1594119839748},{"_id":"themes/minos/languages/zh-cn.yml","hash":"9c5a489b11a056d1ea7b9d4a0e127aef9e192ee4","modified":1594119839729},{"_id":"themes/minos/scripts/99_content.js","hash":"5d19de210e9172a9acb61667a26810899fce917d","modified":1594119839747},{"_id":"themes/minos/layout/archive.ejs","hash":"e3eefe819d61b4d0ee069bb705a9f5707a8bf3da","modified":1594119839729},{"_id":"themes/minos/layout/category.ejs","hash":"403c646878834964883ac41e63952f7b1595c0ba","modified":1594119839730},{"_id":"themes/minos/layout/layout.ejs","hash":"0d0dc44ac98ad02f877a7fdc47108379bda36518","modified":1594119839741},{"_id":"themes/minos/layout/post.ejs","hash":"68b84a717efc5ca59ee9eb6202ccf05c5a8abda5","modified":1594119839742},{"_id":"themes/minos/layout/categories.ejs","hash":"fff6f911d0f548ee749292bc1942f8fbbb1fbfe7","modified":1594119839730},{"_id":"themes/minos/layout/index.ejs","hash":"dff9e199d394f82c5416b814f9e644edbe4090f0","modified":1594119839741},{"_id":"themes/minos/layout/tag.ejs","hash":"5593c7cf9618ef5650c779ed9d75424f057aa210","modified":1594119839744},{"_id":"themes/minos/source/CNAME","hash":"a0004ff224f009d980f11ebe05076d886e4a62b0","modified":1594119839748},{"_id":"themes/minos/source/baidu_verify_yIFJ6q4kkQ.html","hash":"ea49a0fba4306b904b14c9257b691b51814ed4f7","modified":1594119839749},{"_id":"themes/minos/layout/tags.ejs","hash":"e4a9909119294f131a45f10b2cb1058af5fb9be1","modified":1594119839744},{"_id":"themes/minos/source/baidu_verify_CXKjj3fklD.html","hash":"7d4c19a87c3c2c0291ca044329a4eecb199a5cfe","modified":1594119839748},{"_id":"source/images/egg-cluster/3.jpg","hash":"2e999d8632a8a784f778c48b4c26238ce61dfad5","modified":1594116685598},{"_id":"source/images/egg-cluster/1.jpg","hash":"862150374047d825dc6cf409a86c4ca75e132c86","modified":1594116685596},{"_id":"source/images/js-capture-error/3.jpg","hash":"8ab14ad4b43d54cd690218c0a9205ae8d5f102de","modified":1594116685612},{"_id":"source/images/js-capture-error/8.jpg","hash":"d16542cad83c53000902969dca6604833675dd5b","modified":1594116685616},{"_id":"source/images/js-capture-error/6.jpg","hash":"4df941e78df71a066d31a4e4d9f7a2acf6663c8a","modified":1594116685615},{"_id":"source/images/node-perf-heapdump-flame-graph/monitor.pptx","hash":"5bc6ab601976c87a5a8a749d383732b7e5f1a4e3","modified":1594116685634},{"_id":"source/images/summary-2019/2.jpg","hash":"70d8c75bfc4dca70ce90c96b712ca0032ac1ee25","modified":1594116685649},{"_id":"source/images/v8-libuv-timer-event-loop/image-20200301145547994.png","hash":"ee45995af24bc027413f4e3d277ff17a7adebcbd","modified":1594116687218},{"_id":"source/images/vue-component-extends/1.jpg","hash":"f8ed085d61eac35e39a75469cec2fb53184c8f99","modified":1594116687256},{"_id":"source/images/vue-component-extends/2.jpg","hash":"849929e4e6cb963667a09efe4ffb6b1dc1c30052","modified":1594116687256},{"_id":"source/images/vue-component-extends/4.jpg","hash":"9b02fc2442e9c12e70a3f2099e080a8abbfce0f8","modified":1594116687257},{"_id":"source/images/vue-component-extends/3.jpg","hash":"34366ce9fa8f6d101918ee510b87d50a980f1898","modified":1594116687257},{"_id":"themes/minos/layout/comment/changyan.ejs","hash":"9ccc7ec354b968e60bdcfcd1dba451d38de61f12","modified":1594119839731},{"_id":"themes/minos/layout/comment/disqus.ejs","hash":"a2becdc02214a673c804af93488489807fa2c99c","modified":1594119839731},{"_id":"themes/minos/layout/comment/gitment.ejs","hash":"430416210933b7edcbfcc67ede4aa55539da2750","modified":1594119839732},{"_id":"themes/minos/layout/comment/isso.ejs","hash":"cc6a43bd24be764086f88ad7c5c97ff04df87e0b","modified":1594119839733},{"_id":"themes/minos/layout/comment/facebook.ejs","hash":"e73b6f93d98b27ba9068c1685874ecccfbac737b","modified":1594119839732},{"_id":"themes/minos/layout/comment/youyan.ejs","hash":"3d6cf9c523a7a5510ec2864bb29f861f9bb78af3","modified":1594119839735},{"_id":"themes/minos/layout/comment/valine.ejs","hash":"350f28986dd610ebdfdeb16dc618d1d034312af1","modified":1594119839734},{"_id":"themes/minos/layout/comment/livere.ejs","hash":"12ff9a345f6bba2f732f592e39508c2afde89b00","modified":1594119839733},{"_id":"themes/minos/layout/common/article.ejs","hash":"5b45c9ee074d0d92cf9f227971968fadafef5d2e","modified":1594119839737},{"_id":"themes/minos/layout/common/navbar.ejs","hash":"88e14ed41b4ed23bb4516c4db882a52b3cad5586","modified":1594119839739},{"_id":"themes/minos/layout/common/head.ejs","hash":"5242cd321d6c9c0245948c0ba2b55e777f5492a0","modified":1594119839738},{"_id":"themes/minos/layout/common/footer.ejs","hash":"367c5f2e69c66d4d6fbd8beeade0b60024ce9e6e","modified":1594119839737},{"_id":"themes/minos/layout/common/languages.ejs","hash":"89665c656a1ffebc9c97f03e7f9c12dd1d90702a","modified":1594119839738},{"_id":"themes/minos/layout/common/paginator.ejs","hash":"8f5060e4c8a86a3f4e58455c41c98e831e23e4a4","modified":1594119839740},{"_id":"themes/minos/layout/common/scripts.ejs","hash":"7a5a5271930423b95046836597e30e31fa708f66","modified":1594119839740},{"_id":"themes/minos/layout/plugins/gallery.ejs","hash":"7c2becafdf6b60e677cdd5756b9d55eba2af4944","modified":1594119839742},{"_id":"themes/minos/layout/plugins/google-analytics.ejs","hash":"2a9d944a60aff7df27def5215bdc071e605c3c42","modified":1594119839742},{"_id":"themes/minos/layout/plugins/mathjax.ejs","hash":"b460310078d3506dce8dccc67310e3b9b3c124a9","modified":1594119839742},{"_id":"themes/minos/layout/search/google-cse.ejs","hash":"a6bf5c30339735126efa7efa684f9eb14dd6136a","modified":1594119839743},{"_id":"themes/minos/layout/share/sharethis.ejs","hash":"4f2c40f790f3be0a4e79db04f02ea41ba2f4d4c0","modified":1594119839744},{"_id":"themes/minos/layout/common/adv.ejs","hash":"01516deef98a21f349812351476d44d2e4c245c4","modified":1594119839736},{"_id":"themes/minos/layout/search/insight.ejs","hash":"6fb7d27ef40145d8587b46b44a43516135b5a81a","modified":1594119839743},{"_id":"themes/minos/layout/share/addthis.ejs","hash":"f1c5f337333009d5f00dfbac4864a16ef8f9cb8d","modified":1594119839743},{"_id":"themes/minos/source/css/insight.scss","hash":"f785fc6574d2853c660be39b2e3149d4846b577f","modified":1594119839749},{"_id":"themes/minos/source/images/check.svg","hash":"029b8b3523b7daa4005983b4463cd93408308aab","modified":1594119839751},{"_id":"themes/minos/source/css/style.scss","hash":"48d8b2bc475a26b4354c1717cdd131952aef5718","modified":1594119839751},{"_id":"themes/minos/source/images/question.svg","hash":"7153fa2a0c21e32da6a1f96a333d8b66a178569d","modified":1594119839753},{"_id":"themes/minos/source/images/logo.png","hash":"4e012d9ba58cb8f87ee775262ef871c158ac5948","modified":1594119839752},{"_id":"themes/minos/source/images/exclamation.svg","hash":"b2db56f2cc13fce73dbea46c7b446d9bcb3bf0fd","modified":1594119839751},{"_id":"themes/minos/source/images/info.svg","hash":"c8aa387e935ba9a7fa72c5dd000b7d46f2e030c4","modified":1594119839752},{"_id":"themes/minos/source/images/quote-left.svg","hash":"d2561fa8d13e63ff196b71232a5968415ec6e372","modified":1594119839753},{"_id":"themes/minos/source/js/script.js","hash":"6b670ec4f90fb43b21a0bbd750a217af5d8aab6b","modified":1594119839754},{"_id":"themes/minos/source/js/insight.js","hash":"eb23c31141784eef7300f1d1c548950e77883f56","modified":1594119839753},{"_id":"source/images/egg-cluster/4.jpg","hash":"31f6945a8694b2cbbb7bc8906ca166b96cc0803e","modified":1594116685599},{"_id":"source/images/egg-cluster/2.jpg","hash":"3f3006fab2f9e349a3cd43708c8f5fce54c1083e","modified":1594116685597},{"_id":"source/images/js-capture-error/9.jpg","hash":"0d70c8c909842dc05faf690ee1496d98093e8e87","modified":1594116685616},{"_id":"source/images/js-capture-error/7.jpg","hash":"2048e9e10834e569f9ac9d13befbbeab25e0db98","modified":1594116685615},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.svg","hash":"103ef757e41c3246d893f06e482e8682ab5ef1df","modified":1594116685643},{"_id":"source/images/node-gateway-ssr-multi-version/arch.png","hash":"2e3b70aae25d01ec24cdb3dea9461cb2f8ccf6d5","modified":1594116685626},{"_id":"source/images/v8-libuv-timer-event-loop/loop_iteration.png","hash":"b1d06a5e6d9965267cbddc95219a325e85b3ad2b","modified":1594116687218},{"_id":"source/images/bec/2.jpeg","hash":"42aa67b3eaa413a0d98e32bc1be92e9b81044e67","modified":1594116685594},{"_id":"source/images/egg-boot/egg-boot.jpg","hash":"1929f0597221ba9d865bf88c8ebe18ab3b6a83a6","modified":1594116685595},{"_id":"source/images/js-capture-error/10.jpg","hash":"990afee0f1c758900bbe01a93cb2713ce18f825b","modified":1594116685603},{"_id":"source/images/js-capture-error/4.jpg","hash":"c2a26768421ef97bbfd6cf6e13484c93f622202b","modified":1594116685613},{"_id":"source/images/js-css-image-loading/1.png","hash":"199fffb885dde4ce13b60b4f1394be4206fc562e","modified":1594116685618},{"_id":"source/images/nodejs-istio-k8s-docker/book-app.png","hash":"648f6fc10d7e088f30efb0ad0bb08e143737a3c1","modified":1594116685648},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg","hash":"029f1682134caee2658d729e22cbcc258cd39654","modified":1594116685670},{"_id":"source/images/summary-2019/1.png","hash":"655187e02155f10971fe9f163a66074550f29155","modified":1594116685649},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg","hash":"5082c1e85542f1e6e84f40ed90eeaa6a8d1dbe7a","modified":1594116685669},{"_id":"source/images/bec/1.jpeg","hash":"3d518ead7f234d224ad987089dc9abbfc44914a7","modified":1594116685592},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_01.png","hash":"aa9e23b48cfc40528b142c19e019904fd84d2023","modified":1594116685629},{"_id":"source/images/monitor-hub/image-20200403185942130.png","hash":"1cd2b816b28379319621c6d5b64f226ff6854ed1","modified":1594116685620},{"_id":"source/images/node-perf-heapdump-flame-graph/heapdump_01.png","hash":"c30667247e0244f0d0a6cf529da72a6449afe651","modified":1594116685633},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg","hash":"2982f2cd7c06f1b14ca41db91c7092e9cc5206b4","modified":1594116685651},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg","hash":"c830ac739f78b03a03377239257cebb87febd6d4","modified":1594116685660},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg","hash":"2d29c5722ddaaa7cafa4bdee76c489a78fec439c","modified":1594116685660},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg","hash":"0e1b7775a6f0516481a363969e9ab4d37def3f54","modified":1594116685661},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg","hash":"e7f56cab7af9c047abc4272ad8c3409ead3ad663","modified":1594116685669},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg","hash":"a3b2ef5a334b629fa4e18263b5b132abd5d16541","modified":1594116685671},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg","hash":"d0e9ea419aaf7ea366bd1a4d9eb9689935f2305e","modified":1594116685671},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg","hash":"750783ca8fea2c0f2bf16b77d68ffb9fb8a0fa08","modified":1594116685670},{"_id":"source/images/v8-parser-compiler/not-change-types-1.png","hash":"fe446fdd1f610c3f19e6230e81b6c226ccc6de3f","modified":1594116687220},{"_id":"source/images/v8-parser-compiler/not-change-types-2.png","hash":"ab851928246605eb0bd616d6054a86174bec094c","modified":1594116687221},{"_id":"source/images/v8-parser-compiler/not-change-types-3.png","hash":"67f392afae56f849a98469156955c988019dd164","modified":1594116687227},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_02.png","hash":"46096c60b811ac5f923bbc177369c54765b3f018","modified":1594116685632},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg","hash":"7ff38eb37caee04ee91091a2e6ea0084510d505f","modified":1594116685652},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg","hash":"031da43506b73b3ff0029d9929c47021544e3a0d","modified":1594116685653},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg","hash":"a68ab75a84afaf83421a2559f3a84c819b47aee4","modified":1594116685654},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg","hash":"f4aaa1e3fb2b886a0583785a8543d891c8f7a3ae","modified":1594116685659},{"_id":"source/images/v8-parser-compiler/parse-time.png","hash":"fb656e7b12618b464a89f55457ca4e10e74d0b61","modified":1594116687240},{"_id":"source/images/monitor-hub/image-20200403210837664.png","hash":"2310aeb85168982b8e83b167bebd97e25198a046","modified":1594116685622},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg","hash":"4b152e2db8fcb10aba35c92f36aca475825f284a","modified":1594116685652},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg","hash":"c692bb49352bd50a4b37804626f7bebcc0d481b9","modified":1594116685653},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg","hash":"52c555ae72305fb8b3d918ade392bc562324edbc","modified":1594116685655},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg","hash":"a7b3909cff8c02bbec4a0e574e571f144c3af3ff","modified":1594116685656},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg","hash":"7a56c40ea9699e56311d4dd521dc727e9389cb1d","modified":1594116685657},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg","hash":"c057b812fe43486a785b397beea307be4bfab119","modified":1594116685668},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg","hash":"9b5ba7108e28db706c6df61d044fb38c2e099fb0","modified":1594116685665},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg","hash":"3114758346437c5fb21de28f43defa51c8e8eb1e","modified":1594116685657},{"_id":"source/images/v8-parser-compiler/parse-time-2.png","hash":"02e8ee4c9774696248b101f0b161163209ec5cfa","modified":1594116687236},{"_id":"source/images/js-capture-error/1.png","hash":"dacb219805eddb286537551536ee485f06f2ee89","modified":1594116685602},{"_id":"source/images/js-capture-error/5.jpg","hash":"0582a343ea918d89bf3927a061e6f9fd34008755","modified":1594116685614},{"_id":"source/images/v8-parser-compiler/parser-phase.png","hash":"e7a3a59548e4e12625198ccbc703aa43af26fe84","modified":1594116687244},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg","hash":"89e1ce7b5ff9583c9c5c00bc333cc96b3621adc4","modified":1594116685662},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg","hash":"afe1491a544cebfb9f5a50d93b8ee9de7720d07c","modified":1594116685650},{"_id":"source/images/travel-zhoushan/travel-zhoushan-23.png","hash":"0b220b29e01c603619cc0e43ecf8188e2f1bbc5b","modified":1594116686096},{"_id":"source/images/travel-zhoushan/travel-zhoushan-32.png","hash":"7bc5f30bc360006afd5c9a9b5db45e64dcffc90d","modified":1594116686296},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg","hash":"ceaefc338091cf00f390566f1bee28a85307d22b","modified":1594116685662},{"_id":"source/images/nodejs-istio-k8s-docker/arch.jpg","hash":"b75734a1049f76fa33c9e26f4864da33d3876df9","modified":1594116685646},{"_id":"source/images/v8-parser-compiler/parse-time-1.png","hash":"47aa703918420af77205acd2dad7f60749266a16","modified":1594116687233},{"_id":"source/images/travel-zhoushan/travel-zhoushan-16.png","hash":"5104979e08693d7777c21afc3bd90aaeae487acd","modified":1594116685944},{"_id":"source/images/travel-zhoushan/travel-zhoushan-03.png","hash":"a5353d5d6952bfbc9ab32ff08cace44deef3c9f7","modified":1594116685712},{"_id":"source/images/travel-zhoushan/travel-zhoushan-12.jpg","hash":"f379cdb4ac2109ffe2d1d016950620c7d1c17b47","modified":1594116685908},{"_id":"source/images/travel-zhoushan/travel-zhoushan-01.png","hash":"c82df63b6f3873c4495430971ecad76fa44afd62","modified":1594116685680},{"_id":"source/images/travel-zhoushan/travel-zhoushan-13.jpg","hash":"16ad58171a226cfb0e00f26ec53bb62ba3f684c7","modified":1594116685924},{"_id":"source/images/js-capture-error/2.jpg","hash":"75a01876e36c3470e2589b8f3c30bb55b20e1a9e","modified":1594116685612},{"_id":"source/images/v8-parser-compiler/v8-pare-compile-cost.png","hash":"ec6e1f86d094fae4a15102a24ceae28e1a76b71d","modified":1594116687247},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.png","hash":"444d87431a45f3e4c6ca2d2511de8e0cd12e7d1b","modified":1594116685642},{"_id":"source/images/travel-zhoushan/travel-zhoushan-29.jpg","hash":"348566a2036e2cc505f1a1bb5913e159f2e485dd","modified":1594116686241},{"_id":"source/images/traveling-to-the-philippines/27.jpg","hash":"4e15125876b160a47f66fe0835fb26efcc37e456","modified":1594116686798},{"_id":"source/images/traveling-to-the-philippines/26.jpg","hash":"17d6879785c31dc08c8625d2b54672c277e880ae","modified":1594116686781},{"_id":"source/images/travel-zhoushan/travel-zhoushan-15.mp4","hash":"43cd9598df59af319fe3e010b53965c700cf16c8","modified":1594116685931},{"_id":"source/images/traveling-to-the-philippines/2.jpg","hash":"3d1b5fe7a18c3b157d7a76931a24134516f1df2b","modified":1594116686574},{"_id":"source/images/traveling-to-the-philippines/13.jpg","hash":"86666ad42e2c18f8df3b3bb438e383e7aab19b26","modified":1594116686415},{"_id":"source/images/traveling-to-the-philippines/25.jpg","hash":"fb8326a57bddda0a8ff03966041b78d335019441","modified":1594116686754},{"_id":"source/images/travel-zhoushan/travel-zhoushan-04.jpg","hash":"cf166199ee1d541d0456d7061aeb3100dbb7c7ff","modified":1594116685723},{"_id":"source/images/travel-zhoushan/travel-zhoushan-26.jpg","hash":"0dd35c9e96125c3ab6e40157b3f8070b288d7e3b","modified":1594116686163},{"_id":"source/images/traveling-to-the-philippines/6.jpg","hash":"afb158c4f30418d27c35298e833bc4c5aecbbe14","modified":1594116687123},{"_id":"source/images/traveling-to-the-philippines/11.jpg","hash":"f2f6843fb714053053631e0d60f4a84e93b130f1","modified":1594116686363},{"_id":"source/images/traveling-to-the-philippines/9.jpg","hash":"c1425a41b66d74ab1608a45f63f486640a4c2072","modified":1594116687204},{"_id":"source/images/traveling-to-the-philippines/12.jpg","hash":"dcb70fbb7bf5e0b9419d74e3cdfdc45052eb19a1","modified":1594116686392},{"_id":"source/images/traveling-to-the-philippines/34.jpg","hash":"5dc39ae840f701145ec5f0fbbcb56615781f5233","modified":1594116687078},{"_id":"source/images/travel-zhoushan/travel-zhoushan-24.jpg","hash":"264c7a63264ee5332738b3a99817989b38a61819","modified":1594116686110},{"_id":"source/images/travel-zhoushan/travel-zhoushan-28.jpg","hash":"587f64edad989dcfeaff693ff755916335b54c94","modified":1594116686219},{"_id":"source/images/traveling-to-the-philippines/17.jpg","hash":"3eefa5a106856f685427d3a7322841b7ebcd36cb","modified":1594116686519},{"_id":"source/images/traveling-to-the-philippines/3.jpg","hash":"a505e8b86786f108e626d482c08774e46920139d","modified":1594116686876},{"_id":"source/images/traveling-to-the-philippines/4.jpg","hash":"e0631786797fea0feb1e84ff174270f792eb4255","modified":1594116687101},{"_id":"source/images/traveling-to-the-philippines/23.jpg","hash":"eb7a3d220d5870d49a34d54a8dd53f2774eeffc2","modified":1594116686692},{"_id":"source/images/travel-zhoushan/travel-zhoushan-17.jpg","hash":"8fe28b82a34569ceb18913b5dc795dd8d56deabb","modified":1594116685954},{"_id":"source/images/traveling-to-the-philippines/20.jpg","hash":"68f8036efb53cae3adf8bc445a6f30897b5ed234","modified":1594116686596},{"_id":"source/images/travel-zhoushan/travel-zhoushan-05.jpg","hash":"d7fe5055a1f180956e681e38beb49898238b3963","modified":1594116685744},{"_id":"source/images/traveling-to-the-philippines/31.jpg","hash":"69d4edc45e6f4e40d31b51351555b91013a44510","modified":1594116686918},{"_id":"source/images/travel-zhoushan/travel-zhoushan-09.jpg","hash":"cc60d174362ec7d60e0c11d9dc45d0dc7ba96e4c","modified":1594116685843},{"_id":"source/images/travel-zhoushan/travel-zhoushan-30.jpg","hash":"5168ee4903f6891ecc6dee81c9071ea5cd4d9f11","modified":1594116686257},{"_id":"source/images/traveling-to-the-philippines/14.jpg","hash":"d4fb952d4f8ce6df905c4e3304308807722ded7d","modified":1594116686437},{"_id":"source/images/travel-zhoushan/travel-zhoushan-27.jpg","hash":"675b38ad451c65f8df5b8aaa7b47a1448a4f0a5d","modified":1594116686191},{"_id":"source/images/traveling-to-the-philippines/30.jpg","hash":"83c2db4773744d39f66c1d52e51f53971c5afcaf","modified":1594116686894},{"_id":"source/images/travel-zhoushan/travel-zhoushan-19.jpg","hash":"b55c1563ed9bc5306277b6d41f009524849d246a","modified":1594116686000},{"_id":"source/images/traveling-to-the-philippines/1.jpg","hash":"b1fa05a24083c98a28b934344f1bdf5a67df06f0","modified":1594116686306},{"_id":"source/images/travel-zhoushan/travel-zhoushan-31.jpg","hash":"c6ccb78e1da3bcd0279af135a504bbbb11ea646a","modified":1594116686283},{"_id":"source/images/traveling-to-the-philippines/32.jpg","hash":"42a513f3038d178f52ec6601da1ce74d93cee165","modified":1594116687026},{"_id":"source/images/travel-zhoushan/travel-zhoushan-20.jpg","hash":"7c43901d421c36aa2ccd048867db904ff86e5f91","modified":1594116686027},{"_id":"source/images/travel-zhoushan/travel-zhoushan-08.jpg","hash":"7a667808d1aa7684164259cdda466bb62ca1f617","modified":1594116685820},{"_id":"source/images/travel-zhoushan/travel-zhoushan-18.jpg","hash":"b0891f3a3b64bb64155cc7d417b9679660ebb589","modified":1594116685975},{"_id":"source/images/travel-zhoushan/travel-zhoushan-25.jpg","hash":"770bab21f8890fb3951f97efcd2d3147e19d6b87","modified":1594116686136},{"_id":"source/images/traveling-to-the-philippines/10.jpg","hash":"0b2f9ef30a378d3af94492a9f5472bb365a4f61a","modified":1594116686335},{"_id":"source/images/traveling-to-the-philippines/29.jpg","hash":"416513cc33a1ee5c5290fca1dcc6bf1dde2f837b","modified":1594116686838},{"_id":"source/images/traveling-to-the-philippines/8.jpg","hash":"472272b727cb7da43edde1d504f983e6fc34ad8c","modified":1594116687178},{"_id":"source/images/traveling-to-the-philippines/28.jpg","hash":"0c26af42740f5c1579efb1afecfff73cf0a6fee6","modified":1594116686817},{"_id":"source/images/travel-zhoushan/travel-zhoushan-10.jpg","hash":"f07e56dbb331068eb3330448f53fa1e79774a553","modified":1594116685869},{"_id":"source/images/travel-zhoushan/travel-zhoushan-21.jpg","hash":"52ecd7fb0a5f963a8127590591d4a3850b1dec75","modified":1594116686049},{"_id":"source/images/traveling-to-the-philippines/24.jpg","hash":"e487c3820c05646939bf32c0ee75c8d297230442","modified":1594116686714},{"_id":"source/images/traveling-to-the-philippines/16.jpg","hash":"d8049cceba3e0e37b60227071c6e832d330c6ce8","modified":1594116686491},{"_id":"source/images/travel-zhoushan/travel-zhoushan-06.jpg","hash":"4b52d8525264fa7c2b0b115fedb60f3e58ae7332","modified":1594116685770},{"_id":"source/images/travel-zhoushan/travel-zhoushan-11.jpg","hash":"92cc948f3787754e4787ad08370236a40bde67bb","modified":1594116685893},{"_id":"source/images/traveling-to-the-philippines/7.jpg","hash":"1a58dcad2808f5d5973c6b9095bc7e70b10a77eb","modified":1594116687150},{"_id":"source/images/travel-zhoushan/travel-zhoushan-02.jpg","hash":"a09fa91e40653b84356bf9ef283e3e712518e4c4","modified":1594116685693},{"_id":"source/images/traveling-to-the-philippines/15.jpg","hash":"1236ad3788f5f58a9a2bf0e739e72aeecf78a7a4","modified":1594116686466},{"_id":"source/images/traveling-to-the-philippines/33.jpeg","hash":"0c442a5b7cd93eec6e56c59e814d97361121c238","modified":1594116687045},{"_id":"source/images/travel-zhoushan/travel-zhoushan-07.jpg","hash":"5ab19fbe4f011e2a77a4932912d0edcdfb577ae3","modified":1594116685791},{"_id":"source/images/traveling-to-the-philippines/22.jpg","hash":"2e0e76e19e6b3224f5aef6666853fc76bec5e040","modified":1594116686656},{"_id":"source/images/travel-zhoushan/travel-zhoushan-22.jpg","hash":"84c28148493d37d9dbaa050866af2498b64a54e3","modified":1594116686074},{"_id":"source/images/traveling-to-the-philippines/21.jpg","hash":"4c6034c62b008a531593252d4a0dacfd6afe7a5b","modified":1594116686621},{"_id":"source/images/traveling-to-the-philippines/19.jpg","hash":"1d7e6d3b9652d43eb331c2a65201339c0d6c6544","modified":1594116686537},{"_id":"source/images/lighthouse/report.png","hash":"12d66e89769f29802519f68f399255e931247b36","modified":1594140247497},{"_id":"source/.DS_Store","hash":"2f0e6368e064886426e3c12fa62835661062a445","modified":1594140239323},{"_id":"source/_posts/lighthouse.md","hash":"70794b143712d6404919e48aceee4986484aaf95","modified":1594220228648}],"Category":[{"name":"JavaScript","_id":"ckcc0bs5h0002d12iguz5x1er"},{"name":"work","_id":"ckcc0bs5s0007d12i55rhv16a"},{"name":"架构","_id":"ckcc0bs6a000od12ihlgzwobt"},{"name":"travel","_id":"ckcc0bs6r001bd12i099h5srq"}],"Data":[],"Page":[],"Post":[{"title":"Eggjs Boot","keywords":"Eggjs Boot,Eggjs启动,Eggjs源码分析","description":"This article will introduce the boot of Eggjs that is a Node.js web framework.It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.","date":"2019-05-09T07:01:08.568Z","_content":"\n### **#Preface**\n\nThis article will introduce the boot of [Eggjs](<https://eggjs.org/>) that is a Node.js web framework.\n\nIt is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.\n\nEggjs has a few major libs, egg-core、egg、egg-cluster、egg-bin、egg-scripts and so on.\n\n**egg-core**: it extends Koa and is as a parent object of every agent and worker.\n\n**egg**: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.\n\n**egg-cluster**: it creates a cluster and manages them.\n\n**egg-scripts and Egg-bin**: their job is run the whole app in a different environment.\n\n<br/>\n\n_**Tips: We will discuss Eggjs with basing 2.x.x version.**_\n\n<br/>\n\n<!-- more -->\n\n## **#Scan Libs Code**\n\n_* The directory and the code segment are not whole content after this post, these major are only for a better explanation._\n\n### **egg-core**\n\n```\n— lib\n  — / loader (dir)\n  — mixin (dir)\n  — utils (dir)\n  egg.js\n  lifecycle.js\n```\n\nThe above is the directory structure of egg-core.The _**egg.js**_ and folder of the _**loader**_ are important to point for this lib.\n\nSee egg.js\n\n```javascript\nconst KoaApplication = require('koa')\nconst Lifecycle = require('./lifecycle')\n\nclass EggCore extends KoaApplication {\n  constructor(options = {}) {\n    // ...\n    this.lifecycle = new Lifecycle({\n      baseDir: options.baseDir,\n      app: this,\n      logger: this.console\n    })\n\n    const Loader = this[EGG_LOADER]\n    assert(Loader, \"Symbol.for('egg#loader') is required\")\n    this.loader = new Loader({\n      baseDir: options.baseDir,\n      app: this,\n      plugins: options.plugins,\n      logger: this.console,\n      serverScope: options.serverScope,\n      env: options.env\n    })\n    // ...\n  }\n  beforeStart(scope) {\n    this.lifecycle.registerBeforeStart(scope)\n  }\n  ready(flagOrFunction) {\n    return this.lifecycle.ready(flagOrFunction)\n  }\n  get [EGG_LOADER]() {\n    return require('./loader/egg_loader')\n  }\n}\n```\n\nFirst, we can know why it is called that bases on Koa because EggCore extends KoaApplication.\n\nSecond, it defines a few new fields in the construction function, such as _lifecycle_ and _loader_. The _loader_ field helps app for creating important feature include config、plugin、controller、extend、router、middleware、service and so on, it will load some js file in the special directory when the app is starting.\n\nAnother side, both _beforeStart_ and _ready_ often are called when we need to write some plugins.\n\n### **egg**\n\n```\n— / app\n— / config\n— / lib\n  - / core\n    - / messenger\n  - / jsdoc\n  - / loader\n  - agent.js\n  - application.js\n  - egg.js\n  - start.js\n- index.js\n```\n\nThere is an egg.js file that is the same name in the egg-core, but it bases on _EggCore Class_ and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.\n\nSee egg.js\n\n```javascript\nconst EggCore = require('egg-core').EggCore\nconst cluster = require('cluster-client')\nconst Messenger = require('./core/messenger')\n\nclass EggApplication extends EggCore {\n  constructor(options = {}) {\n    this.loader.loadConfig()\n    this.messenger = Messenger.create(this)\n\n    // trigger serverDidReady hook when all app workers\n    // and agent worker is ready\n    this.messenger.once('egg-ready', () => {\n      this.lifecycle.triggerServerDidReady()\n    })\n\n    this.ready(() =>\n      process.nextTick(() => {\n        const dumpStartTime = Date.now()\n        this.dumpConfig()\n        this.dumpTiming()\n        this.coreLogger.info(\n          '[egg:core] dump config after ready, %s',\n          ms(Date.now() - dumpStartTime)\n        )\n      })\n    )\n\n    this.cluster = (clientClass, options) => {\n      options = Object.assign({}, this.config.clusterClient, options, {\n        singleMode: this.options.mode === 'single',\n        // cluster need a port that can't conflict on the environment\n        port: this.options.clusterPort,\n        // agent worker is leader, app workers are follower\n        isLeader: this.type === 'agent',\n        logger: this.coreLogger\n      })\n      const client = cluster(clientClass, options)\n      this._patchClusterClient(client)\n      return client\n    }\n  }\n}\n```\n\nSee agent.js and application.js\n\n```javascript\n// agent.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AgentWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Agent extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'agent'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AgentWorkerLoader\n  }\n}\n\n// application.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AppWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Application extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'application'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AppWorkerLoader\n  }\n}\n```\n\nWe can see that they override the _EGG_LOADER_ property, which uses to create a new _loader_ field in the construction of EggCore that is their parent class. Finally, they call the _load_ function.\n\nWe have the base application code. rNext, look a few of libs for starting web app.\n\n### **egg-scripts and egg-bin**\n\nBoth these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don't know them at most of time.\n\n```javascript\n// package.json\n{\n  \"scripts\": {\n    \"start\": \"env egg-scripts start\",\n    \"dev\": \"env egg-bin dev\",\n    \"stop\": \"egg-scripts stop\",\n    \"debug\": \"egg-bin debug\",\n    \"test\": \"npm run lint -- --fix && npm run test-local\",\n    \"test-local\": \"env egg-bin test\",\n    \"cov\": \"egg-bin cov\"\n}\n```\n\nThe _scripts_ command of this eggjs app conforms to the above description.\n\n### **egg-cluster**\n\nThe cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.\n\n```\n- / lib\n  - / utils\n  - agent_worker.js\n  - app_worker.js\n  - master.js\n- index.js\n```\n\nI had written an [article](/2019/01/18/egg-cluster) about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.\n\n## **#From start to getting the first request**\n\n**What happens when we input `npm run dev` or `npm start` in the terminal?**\n\n- **egg-scripts(prod):** it can require _framework_ by `child_process.spawn` and calls _startCluster_ function.\n- **egg-bin(dev):** it can require _framework_ by `child_process.fork` and calls _startCluster_ function.\n- `[parent process]`: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the `framework` is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as `--framework { your path }`\n\n**Pseudo Code**\n\n```javascript\n// egg-scripts\n// parent process\nconst spawn = require('child_process').spawn // create new process\nspawn('node', 'require({{ framework path }}).startCluster(...)', options))\n\n// egg-bin\n// parent process\nconst cp = require('child_process')\ncp.fork('require({{ framework path }}).startCluster(...)', args, options) // create new process\n```\n\nEgg-scripts uses `spawn` function to require framework while egg-scripts calls `fork` function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.\n\nWe have two processes. In general, this newly created process is called the master process.\n\n**Why is the master process called birdge?**\n\n```javascript\n// egg index.js\nexports.startCluster = require('egg-cluster').startCluster\n```\n\nActually, we exec `egg-cluster`'s startCluster function when we require the framework. We open `index.js` file in the egg-cluster lib. \n\n__First, it is real enter point for whole web app.__\n\n```javascript\n// index.js\nconst Master = require('./lib/master')\nexports.startCluster = function(options, callback) {\n  new Master(options).ready(callback)\n}\n\n// ./lib/master.js\nconst ready = require('get-ready')\nconst detectPort = require('detect-port')\nconst Manager = require('./utils/manager')\nconst Messenger = require('./utils/messenger')\n\nclass Master extends EventEmitter {\n  constructor(options) {\n    super()\n    this.options = parseOptions(options)\n    this.workerManager = new Manager()\n    this.messenger = new Messenger(this)\n\n    ready.mixin(this)\n\n    this.ready(() => {\n      this.isStarted = true\n      const action = 'egg-ready'\n      this.messenger.send({\n        action,\n        to: 'parent',\n        data: { port: this[REALPORT], address: this[APP_ADDRESS] }\n      })\n      this.messenger.send({ action, to: 'app', data: this.options })\n      this.messenger.send({ action, to: 'agent', data: this.options })\n\n      // start check agent and worker status\n      if (this.isProduction) {\n        this.workerManager.startCheck()\n      }\n    })\n\n    // fork app workers after agent started\n    this.once('agent-start', this.forkAppWorkers.bind(this))\n\n    detectPort((err, port) => {\n      /* istanbul ignore if */\n      if (err) {\n        err.name = 'ClusterPortConflictError'\n        err.message = '[master] try get free port error, ' + err.message\n        this.logger.error(err)\n        process.exit(1)\n      }\n      this.options.clusterPort = port\n      this.forkAgentWorker()\n    })\n  }\n  forkAppWorkers() {\n    // ...\n    cluster.on('fork', worker => {\n      // ...\n      worker.on('message', msg => {\n        if (typeof msg === 'string') msg = { action: msg, data: msg };\n        msg.from = 'app';\n        this.messenger.send(msg);\n      });\n      // ...\n    })\n  }\n  forkAgentWorker() {\n    // ...\n    agentWorker.on('message', msg => {\n      if (typeof msg === 'string') msg = { action: msg, data: msg };\n      msg.from = 'agent';\n      this.messenger.send(msg);\n    });\n    // ...\n  }\n}\n\n\n// the callback of ready function will be trigger after all major boots had been loaded\n\n// forkAgentWorker\nconst agent = new Agent(options)\nagent.ready(err => {\n  if (err) return\n  process.send({ action: 'agent-start', to: 'master' })\n})\n\n// fork a single worker\nconst app = new Application(options);\nfunction startServer(err) {  \n  let server;\n  if (options.https) {\n    const httpsOptions = Object.assign({}, options.https, {\n      key: fs.readFileSync(options.https.key),\n      cert: fs.readFileSync(options.https.cert),\n    });\n    server = require('https').createServer(httpsOptions, app.callback());\n  } else {\n    server = require('http').createServer(app.callback());\n  }\n\n  // emit `server` event in app\n  app.emit('server', server);\n  \n  server.listen(...args);\n}\napp.ready(startServer);\n```\n\nOn the other hand, this web will be constructed during creating a `Master` object.\n\n- workerManager: it will hold on all worker porcesses.\n- messenger: we make `master` a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an [article(Chinese)]([http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works怎么通信呢-IPC)) about it.\n\n> - The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)\n> - EggApplication maintain the other Messenge instance （egg/lib/core/messenger.js）\n> - Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master\n\n- ready.mixin & this.ready: 'get-ready' often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.\n\n- detectPort: apply for an available port, default is 7001.If Successly, it will `fork` an agent process and register a callback message for new created an agent object.\n\n- `[agent process]`: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.\n\n  - loadPlugin: find all plugin, record their dir paths => this.dirs\n\n  - loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.\n  - loadAgentExtend: load and merge all of the extending of agent object  (*app > plugin > core*)\n  - loadContextExtend: load and merge all of the extending of context object  (*app > plugin > core*)\n  - loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.【[Application Startup Configuration(official)](https://eggjs.org/en/basics/app-start.html)】. It help you for better writing a few plugins.\n  - Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending `'agent-start'` to the master process.\n\n![egg boot process](/images/egg-boot/egg-boot.jpg)\n\n- `[master process]`: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get `'agent-start'` message from the agent process. It will open a new relatable load, we take a single worker process example.\n\n- `[a single worker process]`: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.\n\n  - loadPlugin: same as the agent\n\n  - loadConfig: same as the agent\n\n  - loadApplicationExtend: same as the agent  (*app > plugin > core*)\n\n  - loadRequestExtend: load and merge all of the extending of request object (*app > plugin > core*)\n\n  - loadResponseExtend: load and merge all of the extending of response object (*app > plugin > core*)\n\n  - loadContextExtend: same as the agent\n\n  - loadHelperExtend: load and merge all of the extending of helper object (*app > plugin > core*)\n\n  - loadCustomApp: same as the agent （*app > plugin*）\n\n  - loadService: load and merge all of the extending of helper object （*app > plugin*）\n\n  - loadMiddleware: load middlewares and iterate them => mw, if it conforms the middleware standard, it will be used with app.use(mw) （*app > plugin > core*）\n\n  - loadController: iterate all controllers' functions => key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only *app*). This middleware will be triggered when getting a new request, the Controller is defined in the `app/controller ` directory and the key is it's function.\n\n    ```javascript\n    function methodToMiddleware(Controller, key) {\n      return function classControllerMiddleware(...args) {\n        const controller = new Controller(this);\n        if (!this.app.config.controller || !this.app.config.controller.supportParams) {\n          args = [ this ];\n        }\n        return utils.callFn(controller[key], args, controller);\n      };\n    }\n    ```\n\n    \n\n  - loadRouter: it makes request’s path associated with the controllers' function that has been become to middleware (only *app*)\n\n  - loadCustomLoader: load ourselves function to create some built-in objects for app object or other.[Customloader](https://eggjs.org/en/advanced/loader.html#customloader)\n\n- `[master process]`: it listens to all worker processes and triggers the master's ready once they have finished booting.\n- send `egg-ready` to the parent process, the agent process, the app worker processes\n- Last, traverse BOOTS and run serverDidReady function of each item.\n\nIt is the whole boot for Eggjs framework but doesn't include, such as restarting a worker process when it exits or disconnects,  shuting down...\n\n__Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.__\n\n\n\n**What happens when web app get an Http request?**\n\n*We only discuss Eggjs code in the applaction layer. :)*\n\nThe `agent` can't deal with any request because it doesn't listen port. All request always hand over to `workers`. We look at creating worker code, it will run a app.callback function and listen port when it has booted.\n\nThis callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller's function.\n\n```javascript\n// koa/lib/application\nclass Application extends Emitter {\n  callback() {\n    const fn = compose(this.middleware);\n\n    if (!this.listenerCount('error')) this.on('error', this.onerror);\n\n    const handleRequest = (req, res) => {\n      const ctx = this.createContext(req, res);\n      return this.handleRequest(ctx, fn);\n    };\n\n    return handleRequest;\n  }\n  handleRequest(ctx, fnMiddleware) {\n    const res = ctx.res;\n    res.statusCode = 404;\n    const onerror = err => ctx.onerror(err);\n    const handleResponse = () => respond(ctx);\n    onFinished(res, onerror);\n    return fnMiddleware(ctx).then(handleResponse).catch(onerror);\n  }\n}\n\n// egg/lib/application\nclass Application extends EggApplication {\n\thandleRequest(ctx, fnMiddleware) {\n    this.emit('request', ctx)\n    super.handleRequest(ctx, fnMiddleware)\n    onFinished(ctx.res, () => this.emit('response', ctx))\n  }\n}\n```\n\n\n\n__In summary, we have know how to boot web app and deal with request in Eggjs.__ When we know it, we can easily write some plugins and middlewares to finish the business requirements.\n\n","source":"_posts/egg-boot.md","raw":"---\ntitle: Eggjs Boot\ncategory: JavaScript\nkeywords: Eggjs Boot,Eggjs启动,Eggjs源码分析\ndescription: This article will introduce the boot of Eggjs that is a Node.js web framework.It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.\ntags:\n  - Node.js\n  - JavaScript\ndate: 2019-05-09T15:01:08.568Z\n---\n\n### **#Preface**\n\nThis article will introduce the boot of [Eggjs](<https://eggjs.org/>) that is a Node.js web framework.\n\nIt is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.\n\nEggjs has a few major libs, egg-core、egg、egg-cluster、egg-bin、egg-scripts and so on.\n\n**egg-core**: it extends Koa and is as a parent object of every agent and worker.\n\n**egg**: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.\n\n**egg-cluster**: it creates a cluster and manages them.\n\n**egg-scripts and Egg-bin**: their job is run the whole app in a different environment.\n\n<br/>\n\n_**Tips: We will discuss Eggjs with basing 2.x.x version.**_\n\n<br/>\n\n<!-- more -->\n\n## **#Scan Libs Code**\n\n_* The directory and the code segment are not whole content after this post, these major are only for a better explanation._\n\n### **egg-core**\n\n```\n— lib\n  — / loader (dir)\n  — mixin (dir)\n  — utils (dir)\n  egg.js\n  lifecycle.js\n```\n\nThe above is the directory structure of egg-core.The _**egg.js**_ and folder of the _**loader**_ are important to point for this lib.\n\nSee egg.js\n\n```javascript\nconst KoaApplication = require('koa')\nconst Lifecycle = require('./lifecycle')\n\nclass EggCore extends KoaApplication {\n  constructor(options = {}) {\n    // ...\n    this.lifecycle = new Lifecycle({\n      baseDir: options.baseDir,\n      app: this,\n      logger: this.console\n    })\n\n    const Loader = this[EGG_LOADER]\n    assert(Loader, \"Symbol.for('egg#loader') is required\")\n    this.loader = new Loader({\n      baseDir: options.baseDir,\n      app: this,\n      plugins: options.plugins,\n      logger: this.console,\n      serverScope: options.serverScope,\n      env: options.env\n    })\n    // ...\n  }\n  beforeStart(scope) {\n    this.lifecycle.registerBeforeStart(scope)\n  }\n  ready(flagOrFunction) {\n    return this.lifecycle.ready(flagOrFunction)\n  }\n  get [EGG_LOADER]() {\n    return require('./loader/egg_loader')\n  }\n}\n```\n\nFirst, we can know why it is called that bases on Koa because EggCore extends KoaApplication.\n\nSecond, it defines a few new fields in the construction function, such as _lifecycle_ and _loader_. The _loader_ field helps app for creating important feature include config、plugin、controller、extend、router、middleware、service and so on, it will load some js file in the special directory when the app is starting.\n\nAnother side, both _beforeStart_ and _ready_ often are called when we need to write some plugins.\n\n### **egg**\n\n```\n— / app\n— / config\n— / lib\n  - / core\n    - / messenger\n  - / jsdoc\n  - / loader\n  - agent.js\n  - application.js\n  - egg.js\n  - start.js\n- index.js\n```\n\nThere is an egg.js file that is the same name in the egg-core, but it bases on _EggCore Class_ and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.\n\nSee egg.js\n\n```javascript\nconst EggCore = require('egg-core').EggCore\nconst cluster = require('cluster-client')\nconst Messenger = require('./core/messenger')\n\nclass EggApplication extends EggCore {\n  constructor(options = {}) {\n    this.loader.loadConfig()\n    this.messenger = Messenger.create(this)\n\n    // trigger serverDidReady hook when all app workers\n    // and agent worker is ready\n    this.messenger.once('egg-ready', () => {\n      this.lifecycle.triggerServerDidReady()\n    })\n\n    this.ready(() =>\n      process.nextTick(() => {\n        const dumpStartTime = Date.now()\n        this.dumpConfig()\n        this.dumpTiming()\n        this.coreLogger.info(\n          '[egg:core] dump config after ready, %s',\n          ms(Date.now() - dumpStartTime)\n        )\n      })\n    )\n\n    this.cluster = (clientClass, options) => {\n      options = Object.assign({}, this.config.clusterClient, options, {\n        singleMode: this.options.mode === 'single',\n        // cluster need a port that can't conflict on the environment\n        port: this.options.clusterPort,\n        // agent worker is leader, app workers are follower\n        isLeader: this.type === 'agent',\n        logger: this.coreLogger\n      })\n      const client = cluster(clientClass, options)\n      this._patchClusterClient(client)\n      return client\n    }\n  }\n}\n```\n\nSee agent.js and application.js\n\n```javascript\n// agent.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AgentWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Agent extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'agent'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AgentWorkerLoader\n  }\n}\n\n// application.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AppWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Application extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'application'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AppWorkerLoader\n  }\n}\n```\n\nWe can see that they override the _EGG_LOADER_ property, which uses to create a new _loader_ field in the construction of EggCore that is their parent class. Finally, they call the _load_ function.\n\nWe have the base application code. rNext, look a few of libs for starting web app.\n\n### **egg-scripts and egg-bin**\n\nBoth these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don't know them at most of time.\n\n```javascript\n// package.json\n{\n  \"scripts\": {\n    \"start\": \"env egg-scripts start\",\n    \"dev\": \"env egg-bin dev\",\n    \"stop\": \"egg-scripts stop\",\n    \"debug\": \"egg-bin debug\",\n    \"test\": \"npm run lint -- --fix && npm run test-local\",\n    \"test-local\": \"env egg-bin test\",\n    \"cov\": \"egg-bin cov\"\n}\n```\n\nThe _scripts_ command of this eggjs app conforms to the above description.\n\n### **egg-cluster**\n\nThe cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.\n\n```\n- / lib\n  - / utils\n  - agent_worker.js\n  - app_worker.js\n  - master.js\n- index.js\n```\n\nI had written an [article](/2019/01/18/egg-cluster) about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.\n\n## **#From start to getting the first request**\n\n**What happens when we input `npm run dev` or `npm start` in the terminal?**\n\n- **egg-scripts(prod):** it can require _framework_ by `child_process.spawn` and calls _startCluster_ function.\n- **egg-bin(dev):** it can require _framework_ by `child_process.fork` and calls _startCluster_ function.\n- `[parent process]`: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the `framework` is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as `--framework { your path }`\n\n**Pseudo Code**\n\n```javascript\n// egg-scripts\n// parent process\nconst spawn = require('child_process').spawn // create new process\nspawn('node', 'require({{ framework path }}).startCluster(...)', options))\n\n// egg-bin\n// parent process\nconst cp = require('child_process')\ncp.fork('require({{ framework path }}).startCluster(...)', args, options) // create new process\n```\n\nEgg-scripts uses `spawn` function to require framework while egg-scripts calls `fork` function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.\n\nWe have two processes. In general, this newly created process is called the master process.\n\n**Why is the master process called birdge?**\n\n```javascript\n// egg index.js\nexports.startCluster = require('egg-cluster').startCluster\n```\n\nActually, we exec `egg-cluster`'s startCluster function when we require the framework. We open `index.js` file in the egg-cluster lib. \n\n__First, it is real enter point for whole web app.__\n\n```javascript\n// index.js\nconst Master = require('./lib/master')\nexports.startCluster = function(options, callback) {\n  new Master(options).ready(callback)\n}\n\n// ./lib/master.js\nconst ready = require('get-ready')\nconst detectPort = require('detect-port')\nconst Manager = require('./utils/manager')\nconst Messenger = require('./utils/messenger')\n\nclass Master extends EventEmitter {\n  constructor(options) {\n    super()\n    this.options = parseOptions(options)\n    this.workerManager = new Manager()\n    this.messenger = new Messenger(this)\n\n    ready.mixin(this)\n\n    this.ready(() => {\n      this.isStarted = true\n      const action = 'egg-ready'\n      this.messenger.send({\n        action,\n        to: 'parent',\n        data: { port: this[REALPORT], address: this[APP_ADDRESS] }\n      })\n      this.messenger.send({ action, to: 'app', data: this.options })\n      this.messenger.send({ action, to: 'agent', data: this.options })\n\n      // start check agent and worker status\n      if (this.isProduction) {\n        this.workerManager.startCheck()\n      }\n    })\n\n    // fork app workers after agent started\n    this.once('agent-start', this.forkAppWorkers.bind(this))\n\n    detectPort((err, port) => {\n      /* istanbul ignore if */\n      if (err) {\n        err.name = 'ClusterPortConflictError'\n        err.message = '[master] try get free port error, ' + err.message\n        this.logger.error(err)\n        process.exit(1)\n      }\n      this.options.clusterPort = port\n      this.forkAgentWorker()\n    })\n  }\n  forkAppWorkers() {\n    // ...\n    cluster.on('fork', worker => {\n      // ...\n      worker.on('message', msg => {\n        if (typeof msg === 'string') msg = { action: msg, data: msg };\n        msg.from = 'app';\n        this.messenger.send(msg);\n      });\n      // ...\n    })\n  }\n  forkAgentWorker() {\n    // ...\n    agentWorker.on('message', msg => {\n      if (typeof msg === 'string') msg = { action: msg, data: msg };\n      msg.from = 'agent';\n      this.messenger.send(msg);\n    });\n    // ...\n  }\n}\n\n\n// the callback of ready function will be trigger after all major boots had been loaded\n\n// forkAgentWorker\nconst agent = new Agent(options)\nagent.ready(err => {\n  if (err) return\n  process.send({ action: 'agent-start', to: 'master' })\n})\n\n// fork a single worker\nconst app = new Application(options);\nfunction startServer(err) {  \n  let server;\n  if (options.https) {\n    const httpsOptions = Object.assign({}, options.https, {\n      key: fs.readFileSync(options.https.key),\n      cert: fs.readFileSync(options.https.cert),\n    });\n    server = require('https').createServer(httpsOptions, app.callback());\n  } else {\n    server = require('http').createServer(app.callback());\n  }\n\n  // emit `server` event in app\n  app.emit('server', server);\n  \n  server.listen(...args);\n}\napp.ready(startServer);\n```\n\nOn the other hand, this web will be constructed during creating a `Master` object.\n\n- workerManager: it will hold on all worker porcesses.\n- messenger: we make `master` a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an [article(Chinese)]([http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works怎么通信呢-IPC)) about it.\n\n> - The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)\n> - EggApplication maintain the other Messenge instance （egg/lib/core/messenger.js）\n> - Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master\n\n- ready.mixin & this.ready: 'get-ready' often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.\n\n- detectPort: apply for an available port, default is 7001.If Successly, it will `fork` an agent process and register a callback message for new created an agent object.\n\n- `[agent process]`: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.\n\n  - loadPlugin: find all plugin, record their dir paths => this.dirs\n\n  - loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.\n  - loadAgentExtend: load and merge all of the extending of agent object  (*app > plugin > core*)\n  - loadContextExtend: load and merge all of the extending of context object  (*app > plugin > core*)\n  - loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.【[Application Startup Configuration(official)](https://eggjs.org/en/basics/app-start.html)】. It help you for better writing a few plugins.\n  - Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending `'agent-start'` to the master process.\n\n![egg boot process](/images/egg-boot/egg-boot.jpg)\n\n- `[master process]`: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get `'agent-start'` message from the agent process. It will open a new relatable load, we take a single worker process example.\n\n- `[a single worker process]`: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.\n\n  - loadPlugin: same as the agent\n\n  - loadConfig: same as the agent\n\n  - loadApplicationExtend: same as the agent  (*app > plugin > core*)\n\n  - loadRequestExtend: load and merge all of the extending of request object (*app > plugin > core*)\n\n  - loadResponseExtend: load and merge all of the extending of response object (*app > plugin > core*)\n\n  - loadContextExtend: same as the agent\n\n  - loadHelperExtend: load and merge all of the extending of helper object (*app > plugin > core*)\n\n  - loadCustomApp: same as the agent （*app > plugin*）\n\n  - loadService: load and merge all of the extending of helper object （*app > plugin*）\n\n  - loadMiddleware: load middlewares and iterate them => mw, if it conforms the middleware standard, it will be used with app.use(mw) （*app > plugin > core*）\n\n  - loadController: iterate all controllers' functions => key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only *app*). This middleware will be triggered when getting a new request, the Controller is defined in the `app/controller ` directory and the key is it's function.\n\n    ```javascript\n    function methodToMiddleware(Controller, key) {\n      return function classControllerMiddleware(...args) {\n        const controller = new Controller(this);\n        if (!this.app.config.controller || !this.app.config.controller.supportParams) {\n          args = [ this ];\n        }\n        return utils.callFn(controller[key], args, controller);\n      };\n    }\n    ```\n\n    \n\n  - loadRouter: it makes request’s path associated with the controllers' function that has been become to middleware (only *app*)\n\n  - loadCustomLoader: load ourselves function to create some built-in objects for app object or other.[Customloader](https://eggjs.org/en/advanced/loader.html#customloader)\n\n- `[master process]`: it listens to all worker processes and triggers the master's ready once they have finished booting.\n- send `egg-ready` to the parent process, the agent process, the app worker processes\n- Last, traverse BOOTS and run serverDidReady function of each item.\n\nIt is the whole boot for Eggjs framework but doesn't include, such as restarting a worker process when it exits or disconnects,  shuting down...\n\n__Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.__\n\n\n\n**What happens when web app get an Http request?**\n\n*We only discuss Eggjs code in the applaction layer. :)*\n\nThe `agent` can't deal with any request because it doesn't listen port. All request always hand over to `workers`. We look at creating worker code, it will run a app.callback function and listen port when it has booted.\n\nThis callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller's function.\n\n```javascript\n// koa/lib/application\nclass Application extends Emitter {\n  callback() {\n    const fn = compose(this.middleware);\n\n    if (!this.listenerCount('error')) this.on('error', this.onerror);\n\n    const handleRequest = (req, res) => {\n      const ctx = this.createContext(req, res);\n      return this.handleRequest(ctx, fn);\n    };\n\n    return handleRequest;\n  }\n  handleRequest(ctx, fnMiddleware) {\n    const res = ctx.res;\n    res.statusCode = 404;\n    const onerror = err => ctx.onerror(err);\n    const handleResponse = () => respond(ctx);\n    onFinished(res, onerror);\n    return fnMiddleware(ctx).then(handleResponse).catch(onerror);\n  }\n}\n\n// egg/lib/application\nclass Application extends EggApplication {\n\thandleRequest(ctx, fnMiddleware) {\n    this.emit('request', ctx)\n    super.handleRequest(ctx, fnMiddleware)\n    onFinished(ctx.res, () => this.emit('response', ctx))\n  }\n}\n```\n\n\n\n__In summary, we have know how to boot web app and deal with request in Eggjs.__ When we know it, we can easily write some plugins and middlewares to finish the business requirements.\n\n","slug":"egg-boot","published":1,"updated":"2020-07-07T10:11:25.586Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs570000d12iwhc9qpyq","content":"<h3 id=\"Preface\"><a href=\"#Preface\" class=\"headerlink\" title=\"#Preface\"></a><strong>#Preface</strong></h3><p>This article will introduce the boot of <a href=\"https://eggjs.org/\" target=\"_blank\" rel=\"noopener\">Eggjs</a> that is a Node.js web framework.</p>\n<p>It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.</p>\n<p>Eggjs has a few major libs, egg-core、egg、egg-cluster、egg-bin、egg-scripts and so on.</p>\n<p><strong>egg-core</strong>: it extends Koa and is as a parent object of every agent and worker.</p>\n<p><strong>egg</strong>: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.</p>\n<p><strong>egg-cluster</strong>: it creates a cluster and manages them.</p>\n<p><strong>egg-scripts and Egg-bin</strong>: their job is run the whole app in a different environment.</p>\n<p><br></p>\n<p><em><strong>Tips: We will discuss Eggjs with basing 2.x.x version.</strong></em></p>\n<p><br></p>\n<a id=\"more\"></a>\n<h2 id=\"Scan-Libs-Code\"><a href=\"#Scan-Libs-Code\" class=\"headerlink\" title=\"#Scan Libs Code\"></a><strong>#Scan Libs Code</strong></h2><p><em>* The directory and the code segment are not whole content after this post, these major are only for a better explanation.</em></p>\n<h3 id=\"egg-core\"><a href=\"#egg-core\" class=\"headerlink\" title=\"egg-core\"></a><strong>egg-core</strong></h3><figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">— lib</span><br><span class=\"line\">  — / loader (dir)</span><br><span class=\"line\">  — mixin (dir)</span><br><span class=\"line\">  — utils (dir)</span><br><span class=\"line\">  egg.js</span><br><span class=\"line\">  lifecycle.js</span><br></pre></td></tr></table></figure>\n<p>The above is the directory structure of egg-core.The <em><strong>egg.js</strong></em> and folder of the <em><strong>loader</strong></em> are important to point for this lib.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> KoaApplication = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Lifecycle = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./lifecycle'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">EggCore</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">KoaApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.lifecycle = <span class=\"hljs-keyword\">new</span> Lifecycle(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"hljs-keyword\">this</span>,</span><br><span class=\"line\">      logger: <span class=\"hljs-keyword\">this</span>.console</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> Loader = <span class=\"hljs-keyword\">this</span>[EGG_LOADER]</span><br><span class=\"line\">    assert(Loader, <span class=\"hljs-string\">\"Symbol.for('egg#loader') is required\"</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader = <span class=\"hljs-keyword\">new</span> Loader(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"hljs-keyword\">this</span>,</span><br><span class=\"line\">      plugins: options.plugins,</span><br><span class=\"line\">      logger: <span class=\"hljs-keyword\">this</span>.console,</span><br><span class=\"line\">      serverScope: options.serverScope,</span><br><span class=\"line\">      env: options.env</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  beforeStart(scope) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.lifecycle.registerBeforeStart(scope)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ready(flagOrFunction) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.lifecycle.ready(flagOrFunction)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader/egg_loader'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>First, we can know why it is called that bases on Koa because EggCore extends KoaApplication.</p>\n<p>Second, it defines a few new fields in the construction function, such as <em>lifecycle</em> and <em>loader</em>. The <em>loader</em> field helps app for creating important feature include config、plugin、controller、extend、router、middleware、service and so on, it will load some js file in the special directory when the app is starting.</p>\n<p>Another side, both <em>beforeStart</em> and <em>ready</em> often are called when we need to write some plugins.</p>\n<h3 id=\"egg\"><a href=\"#egg\" class=\"headerlink\" title=\"egg\"></a><strong>egg</strong></h3><figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">— / app</span><br><span class=\"line\">— / config</span><br><span class=\"line\">— / lib</span><br><span class=\"line\">  - / core</span><br><span class=\"line\">    - / messenger</span><br><span class=\"line\">  - / jsdoc</span><br><span class=\"line\">  - / loader</span><br><span class=\"line\">  - agent.js</span><br><span class=\"line\">  - application.js</span><br><span class=\"line\">  - egg.js</span><br><span class=\"line\">  - start.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>There is an egg.js file that is the same name in the egg-core, but it bases on <em>EggCore Class</em> and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> EggCore = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'egg-core'</span>).EggCore</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> cluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'cluster-client'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Messenger = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./core/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">EggApplication</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggCore</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader.loadConfig()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.messenger = Messenger.create(<span class=\"hljs-keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// trigger serverDidReady hook when all app workers</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// and agent worker is ready</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.messenger.once(<span class=\"hljs-string\">'egg-ready'</span>, () =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.lifecycle.triggerServerDidReady()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.ready(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span></span><br><span class=\"line\">      process.nextTick(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> dumpStartTime = <span class=\"hljs-built_in\">Date</span>.now()</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.dumpConfig()</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.dumpTiming()</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.coreLogger.info(</span><br><span class=\"line\">          <span class=\"hljs-string\">'[egg:core] dump config after ready, %s'</span>,</span><br><span class=\"line\">          ms(<span class=\"hljs-built_in\">Date</span>.now() - dumpStartTime)</span><br><span class=\"line\">        )</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.cluster = <span class=\"hljs-function\">(<span class=\"hljs-params\">clientClass, options</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      options = <span class=\"hljs-built_in\">Object</span>.assign(&#123;&#125;, <span class=\"hljs-keyword\">this</span>.config.clusterClient, options, &#123;</span><br><span class=\"line\">        singleMode: <span class=\"hljs-keyword\">this</span>.options.mode === <span class=\"hljs-string\">'single'</span>,</span><br><span class=\"line\">        <span class=\"hljs-comment\">// cluster need a port that can't conflict on the environment</span></span><br><span class=\"line\">        port: <span class=\"hljs-keyword\">this</span>.options.clusterPort,</span><br><span class=\"line\">        <span class=\"hljs-comment\">// agent worker is leader, app workers are follower</span></span><br><span class=\"line\">        isLeader: <span class=\"hljs-keyword\">this</span>.type === <span class=\"hljs-string\">'agent'</span>,</span><br><span class=\"line\">        logger: <span class=\"hljs-keyword\">this</span>.coreLogger</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> client = cluster(clientClass, options)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>._patchClusterClient(client)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> client</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>See agent.js and application.js</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// agent.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EggApplication = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> AgentWorkerLoader = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader'</span>).AgentWorkerLoader</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EGG_LOADER = <span class=\"hljs-built_in\">Symbol</span>.for(<span class=\"hljs-string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Agent</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"hljs-string\">'agent'</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> AgentWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// application.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EggApplication = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> AgentWorkerLoader = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader'</span>).AppWorkerLoader</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EGG_LOADER = <span class=\"hljs-built_in\">Symbol</span>.for(<span class=\"hljs-string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"hljs-string\">'application'</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> AppWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>We can see that they override the _EGG_LOADER_ property, which uses to create a new <em>loader</em> field in the construction of EggCore that is their parent class. Finally, they call the <em>load</em> function.</p>\n<p>We have the base application code. rNext, look a few of libs for starting web app.</p>\n<h3 id=\"egg-scripts-and-egg-bin\"><a href=\"#egg-scripts-and-egg-bin\" class=\"headerlink\" title=\"egg-scripts and egg-bin\"></a><strong>egg-scripts and egg-bin</strong></h3><p>Both these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don’t know them at most of time.</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// package.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-string\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"hljs-string\">\"start\"</span>: <span class=\"hljs-string\">\"env egg-scripts start\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"dev\"</span>: <span class=\"hljs-string\">\"env egg-bin dev\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"stop\"</span>: <span class=\"hljs-string\">\"egg-scripts stop\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"debug\"</span>: <span class=\"hljs-string\">\"egg-bin debug\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"test\"</span>: <span class=\"hljs-string\">\"npm run lint -- --fix &amp;&amp; npm run test-local\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"test-local\"</span>: <span class=\"hljs-string\">\"env egg-bin test\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"cov\"</span>: <span class=\"hljs-string\">\"egg-bin cov\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The <em>scripts</em> command of this eggjs app conforms to the above description.</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a><strong>egg-cluster</strong></h3><p>The cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.</p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- / lib</span><br><span class=\"line\">  - / utils</span><br><span class=\"line\">  - agent_worker.js</span><br><span class=\"line\">  - app_worker.js</span><br><span class=\"line\">  - master.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>I had written an <a href=\"/2019/01/18/egg-cluster\">article</a> about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.</p>\n<h2 id=\"From-start-to-getting-the-first-request\"><a href=\"#From-start-to-getting-the-first-request\" class=\"headerlink\" title=\"#From start to getting the first request\"></a><strong>#From start to getting the first request</strong></h2><p><strong>What happens when we input <code>npm run dev</code> or <code>npm start</code> in the terminal?</strong></p>\n<ul>\n<li><strong>egg-scripts(prod):</strong> it can require <em>framework</em> by <code>child_process.spawn</code> and calls <em>startCluster</em> function.</li>\n<li><strong>egg-bin(dev):</strong> it can require <em>framework</em> by <code>child_process.fork</code> and calls <em>startCluster</em> function.</li>\n<li><code>[parent process]</code>: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the <code>framework</code> is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as <code>--framework { your path }</code></li>\n</ul>\n<p><strong>Pseudo Code</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-scripts</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// parent process</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> spawn = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>).spawn <span class=\"hljs-comment\">// create new process</span></span><br><span class=\"line\">spawn(<span class=\"hljs-string\">'node'</span>, <span class=\"hljs-string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, options))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// egg-bin</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// parent process</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> cp = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>)</span><br><span class=\"line\">cp.fork(<span class=\"hljs-string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, args, options) <span class=\"hljs-comment\">// create new process</span></span><br></pre></td></tr></table></figure>\n<p>Egg-scripts uses <code>spawn</code> function to require framework while egg-scripts calls <code>fork</code> function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.</p>\n<p>We have two processes. In general, this newly created process is called the master process.</p>\n<p><strong>Why is the master process called birdge?</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg index.js</span></span><br><span class=\"line\">exports.startCluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'egg-cluster'</span>).startCluster</span><br></pre></td></tr></table></figure>\n<p>Actually, we exec <code>egg-cluster</code>‘s startCluster function when we require the framework. We open <code>index.js</code> file in the egg-cluster lib. </p>\n<p><strong>First, it is real enter point for whole web app.</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// index.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Master = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./lib/master'</span>)</span><br><span class=\"line\">exports.startCluster = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// ./lib/master.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> ready = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'get-ready'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> detectPort = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'detect-port'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Manager = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./utils/manager'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Messenger = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./utils/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.options = parseOptions(options)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.workerManager = <span class=\"hljs-keyword\">new</span> Manager()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.messenger = <span class=\"hljs-keyword\">new</span> Messenger(<span class=\"hljs-keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    ready.mixin(<span class=\"hljs-keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.ready(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.isStarted = <span class=\"hljs-literal\">true</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> action = <span class=\"hljs-string\">'egg-ready'</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(&#123;</span><br><span class=\"line\">        action,</span><br><span class=\"line\">        to: <span class=\"hljs-string\">'parent'</span>,</span><br><span class=\"line\">        data: &#123; <span class=\"hljs-attr\">port</span>: <span class=\"hljs-keyword\">this</span>[REALPORT], <span class=\"hljs-attr\">address</span>: <span class=\"hljs-keyword\">this</span>[APP_ADDRESS] &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(&#123; action, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'app'</span>, <span class=\"hljs-attr\">data</span>: <span class=\"hljs-keyword\">this</span>.options &#125;)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(&#123; action, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'agent'</span>, <span class=\"hljs-attr\">data</span>: <span class=\"hljs-keyword\">this</span>.options &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// start check agent and worker status</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.isProduction) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.workerManager.startCheck()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// fork app workers after agent started</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.once(<span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-keyword\">this</span>.forkAppWorkers.bind(<span class=\"hljs-keyword\">this</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    detectPort(<span class=\"hljs-function\">(<span class=\"hljs-params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">/* istanbul ignore if */</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (err) &#123;</span><br><span class=\"line\">        err.name = <span class=\"hljs-string\">'ClusterPortConflictError'</span></span><br><span class=\"line\">        err.message = <span class=\"hljs-string\">'[master] try get free port error, '</span> + err.message</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.logger.error(err)</span><br><span class=\"line\">        process.exit(<span class=\"hljs-number\">1</span>)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.options.clusterPort = port</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.forkAgentWorker()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAppWorkers() &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    cluster.on(<span class=\"hljs-string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">      worker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">        msg.from = <span class=\"hljs-string\">'app'</span>;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAgentWorker() &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    agentWorker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">      msg.from = <span class=\"hljs-string\">'agent'</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// the callback of ready function will be trigger after all major boots had been loaded</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// forkAgentWorker</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> agent = <span class=\"hljs-keyword\">new</span> Agent(options)</span><br><span class=\"line\">agent.ready(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (err) <span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">  process.send(&#123; <span class=\"hljs-attr\">action</span>: <span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'master'</span> &#125;)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// fork a single worker</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-keyword\">new</span> Application(options);</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">startServer</span>(<span class=\"hljs-params\">err</span>) </span>&#123;  </span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> server;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (options.https) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> httpsOptions = <span class=\"hljs-built_in\">Object</span>.assign(&#123;&#125;, options.https, &#123;</span><br><span class=\"line\">      key: fs.readFileSync(options.https.key),</span><br><span class=\"line\">      cert: fs.readFileSync(options.https.cert),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    server = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'https'</span>).createServer(httpsOptions, app.callback());</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">    server = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'http'</span>).createServer(app.callback());</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// emit `server` event in app</span></span><br><span class=\"line\">  app.emit(<span class=\"hljs-string\">'server'</span>, server);</span><br><span class=\"line\">  </span><br><span class=\"line\">  server.listen(...args);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">app.ready(startServer);</span><br></pre></td></tr></table></figure>\n<p>On the other hand, this web will be constructed during creating a <code>Master</code> object.</p>\n<ul>\n<li>workerManager: it will hold on all worker porcesses.</li>\n<li>messenger: we make <code>master</code> a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an <a href=\"[http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works怎么通信呢-IPC\">article(Chinese)</a>) about it.</li>\n</ul>\n<blockquote>\n<ul>\n<li>The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)</li>\n<li>EggApplication maintain the other Messenge instance （egg/lib/core/messenger.js）</li>\n<li>Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master</li>\n</ul>\n</blockquote>\n<ul>\n<li><p>ready.mixin &amp; this.ready: ‘get-ready’ often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.</p>\n</li>\n<li><p>detectPort: apply for an available port, default is 7001.If Successly, it will <code>fork</code> an agent process and register a callback message for new created an agent object.</p>\n</li>\n<li><p><code>[agent process]</code>: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.</p>\n<ul>\n<li><p>loadPlugin: find all plugin, record their dir paths =&gt; this.dirs</p>\n</li>\n<li><p>loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.</p>\n</li>\n<li>loadAgentExtend: load and merge all of the extending of agent object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadContextExtend: load and merge all of the extending of context object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.【<a href=\"https://eggjs.org/en/basics/app-start.html\" target=\"_blank\" rel=\"noopener\">Application Startup Configuration(official)</a>】. It help you for better writing a few plugins.</li>\n<li>Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending <code>&#39;agent-start&#39;</code> to the master process.</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"/images/egg-boot/egg-boot.jpg\" alt=\"egg boot process\"></p>\n<ul>\n<li><p><code>[master process]</code>: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get <code>&#39;agent-start&#39;</code> message from the agent process. It will open a new relatable load, we take a single worker process example.</p>\n</li>\n<li><p><code>[a single worker process]</code>: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.</p>\n<ul>\n<li><p>loadPlugin: same as the agent</p>\n</li>\n<li><p>loadConfig: same as the agent</p>\n</li>\n<li><p>loadApplicationExtend: same as the agent  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadRequestExtend: load and merge all of the extending of request object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadResponseExtend: load and merge all of the extending of response object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadContextExtend: same as the agent</p>\n</li>\n<li><p>loadHelperExtend: load and merge all of the extending of helper object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadCustomApp: same as the agent （<em>app &gt; plugin</em>）</p>\n</li>\n<li><p>loadService: load and merge all of the extending of helper object （<em>app &gt; plugin</em>）</p>\n</li>\n<li><p>loadMiddleware: load middlewares and iterate them =&gt; mw, if it conforms the middleware standard, it will be used with app.use(mw) （<em>app &gt; plugin &gt; core</em>）</p>\n</li>\n<li><p>loadController: iterate all controllers’ functions =&gt; key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only <em>app</em>). This middleware will be triggered when getting a new request, the Controller is defined in the <code>app/controller</code> directory and the key is it’s function.</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">methodToMiddleware</span>(<span class=\"hljs-params\">Controller, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">classControllerMiddleware</span>(<span class=\"hljs-params\">...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> controller = <span class=\"hljs-keyword\">new</span> Controller(<span class=\"hljs-keyword\">this</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-keyword\">this</span>.app.config.controller || !<span class=\"hljs-keyword\">this</span>.app.config.controller.supportParams) &#123;</span><br><span class=\"line\">      args = [ <span class=\"hljs-keyword\">this</span> ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> utils.callFn(controller[key], args, controller);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>loadRouter: it makes request’s path associated with the controllers’ function that has been become to middleware (only <em>app</em>)</p>\n</li>\n<li><p>loadCustomLoader: load ourselves function to create some built-in objects for app object or other.<a href=\"https://eggjs.org/en/advanced/loader.html#customloader\" target=\"_blank\" rel=\"noopener\">Customloader</a></p>\n</li>\n</ul>\n<ul>\n<li><code>[master process]</code>: it listens to all worker processes and triggers the master’s ready once they have finished booting.</li>\n<li>send <code>egg-ready</code> to the parent process, the agent process, the app worker processes</li>\n<li>Last, traverse BOOTS and run serverDidReady function of each item.</li>\n</ul>\n<p>It is the whole boot for Eggjs framework but doesn’t include, such as restarting a worker process when it exits or disconnects,  shuting down…</p>\n<p><strong>Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.</strong></p>\n<p><strong>What happens when web app get an Http request?</strong></p>\n<p><em>We only discuss Eggjs code in the applaction layer. :)</em></p>\n<p>The <code>agent</code> can’t deal with any request because it doesn’t listen port. All request always hand over to <code>workers</code>. We look at creating worker code, it will run a app.callback function and listen port when it has booted.</p>\n<p>This callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller’s function.</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// koa/lib/application</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Emitter</span> </span>&#123;</span><br><span class=\"line\">  callback() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> fn = compose(<span class=\"hljs-keyword\">this</span>.middleware);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-keyword\">this</span>.listenerCount(<span class=\"hljs-string\">'error'</span>)) <span class=\"hljs-keyword\">this</span>.on(<span class=\"hljs-string\">'error'</span>, <span class=\"hljs-keyword\">this</span>.onerror);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> handleRequest = <span class=\"hljs-function\">(<span class=\"hljs-params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> ctx = <span class=\"hljs-keyword\">this</span>.createContext(req, res);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.handleRequest(ctx, fn);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> handleRequest;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  handleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> res = ctx.res;</span><br><span class=\"line\">    res.statusCode = <span class=\"hljs-number\">404</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> onerror = <span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> ctx.onerror(err);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> handleResponse = <span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> respond(ctx);</span><br><span class=\"line\">    onFinished(res, onerror);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> fnMiddleware(ctx).then(handleResponse).catch(onerror);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// egg/lib/application</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">\thandleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.emit(<span class=\"hljs-string\">'request'</span>, ctx)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>.handleRequest(ctx, fnMiddleware)</span><br><span class=\"line\">    onFinished(ctx.res, () =&gt; <span class=\"hljs-keyword\">this</span>.emit(<span class=\"hljs-string\">'response'</span>, ctx))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>In summary, we have know how to boot web app and deal with request in Eggjs.</strong> When we know it, we can easily write some plugins and middlewares to finish the business requirements.</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<h3 id=\"Preface\"><a href=\"#Preface\" class=\"headerlink\" title=\"#Preface\"></a><strong>#Preface</strong></h3><p>This article will introduce the boot of <a href=\"https://eggjs.org/\" target=\"_blank\" rel=\"noopener\">Eggjs</a> that is a Node.js web framework.</p>\n<p>It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.</p>\n<p>Eggjs has a few major libs, egg-core、egg、egg-cluster、egg-bin、egg-scripts and so on.</p>\n<p><strong>egg-core</strong>: it extends Koa and is as a parent object of every agent and worker.</p>\n<p><strong>egg</strong>: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.</p>\n<p><strong>egg-cluster</strong>: it creates a cluster and manages them.</p>\n<p><strong>egg-scripts and Egg-bin</strong>: their job is run the whole app in a different environment.</p>\n<p><br></p>\n<p><em><strong>Tips: We will discuss Eggjs with basing 2.x.x version.</strong></em></p>\n<p><br></p>","more":"<h2 id=\"Scan-Libs-Code\"><a href=\"#Scan-Libs-Code\" class=\"headerlink\" title=\"#Scan Libs Code\"></a><strong>#Scan Libs Code</strong></h2><p><em>* The directory and the code segment are not whole content after this post, these major are only for a better explanation.</em></p>\n<h3 id=\"egg-core\"><a href=\"#egg-core\" class=\"headerlink\" title=\"egg-core\"></a><strong>egg-core</strong></h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">— lib</span><br><span class=\"line\">  — / loader (dir)</span><br><span class=\"line\">  — mixin (dir)</span><br><span class=\"line\">  — utils (dir)</span><br><span class=\"line\">  egg.js</span><br><span class=\"line\">  lifecycle.js</span><br></pre></td></tr></table></figure>\n<p>The above is the directory structure of egg-core.The <em><strong>egg.js</strong></em> and folder of the <em><strong>loader</strong></em> are important to point for this lib.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> KoaApplication = <span class=\"built_in\">require</span>(<span class=\"string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Lifecycle = <span class=\"built_in\">require</span>(<span class=\"string\">'./lifecycle'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EggCore</span> <span class=\"keyword\">extends</span> <span class=\"title\">KoaApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.lifecycle = <span class=\"keyword\">new</span> Lifecycle(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"keyword\">this</span>,</span><br><span class=\"line\">      logger: <span class=\"keyword\">this</span>.console</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> Loader = <span class=\"keyword\">this</span>[EGG_LOADER]</span><br><span class=\"line\">    assert(Loader, <span class=\"string\">\"Symbol.for('egg#loader') is required\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader = <span class=\"keyword\">new</span> Loader(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"keyword\">this</span>,</span><br><span class=\"line\">      plugins: options.plugins,</span><br><span class=\"line\">      logger: <span class=\"keyword\">this</span>.console,</span><br><span class=\"line\">      serverScope: options.serverScope,</span><br><span class=\"line\">      env: options.env</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  beforeStart(scope) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.lifecycle.registerBeforeStart(scope)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ready(flagOrFunction) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.lifecycle.ready(flagOrFunction)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">require</span>(<span class=\"string\">'./loader/egg_loader'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>First, we can know why it is called that bases on Koa because EggCore extends KoaApplication.</p>\n<p>Second, it defines a few new fields in the construction function, such as <em>lifecycle</em> and <em>loader</em>. The <em>loader</em> field helps app for creating important feature include config、plugin、controller、extend、router、middleware、service and so on, it will load some js file in the special directory when the app is starting.</p>\n<p>Another side, both <em>beforeStart</em> and <em>ready</em> often are called when we need to write some plugins.</p>\n<h3 id=\"egg\"><a href=\"#egg\" class=\"headerlink\" title=\"egg\"></a><strong>egg</strong></h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">— / app</span><br><span class=\"line\">— / config</span><br><span class=\"line\">— / lib</span><br><span class=\"line\">  - / core</span><br><span class=\"line\">    - / messenger</span><br><span class=\"line\">  - / jsdoc</span><br><span class=\"line\">  - / loader</span><br><span class=\"line\">  - agent.js</span><br><span class=\"line\">  - application.js</span><br><span class=\"line\">  - egg.js</span><br><span class=\"line\">  - start.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>There is an egg.js file that is the same name in the egg-core, but it bases on <em>EggCore Class</em> and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> EggCore = <span class=\"built_in\">require</span>(<span class=\"string\">'egg-core'</span>).EggCore</span><br><span class=\"line\"><span class=\"keyword\">const</span> cluster = <span class=\"built_in\">require</span>(<span class=\"string\">'cluster-client'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Messenger = <span class=\"built_in\">require</span>(<span class=\"string\">'./core/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EggApplication</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggCore</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader.loadConfig()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messenger = Messenger.create(<span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// trigger serverDidReady hook when all app workers</span></span><br><span class=\"line\">    <span class=\"comment\">// and agent worker is ready</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messenger.once(<span class=\"string\">'egg-ready'</span>, () =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.lifecycle.triggerServerDidReady()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.ready(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span></span><br><span class=\"line\">      process.nextTick(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> dumpStartTime = <span class=\"built_in\">Date</span>.now()</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.dumpConfig()</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.dumpTiming()</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.coreLogger.info(</span><br><span class=\"line\">          <span class=\"string\">'[egg:core] dump config after ready, %s'</span>,</span><br><span class=\"line\">          ms(<span class=\"built_in\">Date</span>.now() - dumpStartTime)</span><br><span class=\"line\">        )</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.cluster = <span class=\"function\">(<span class=\"params\">clientClass, options</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      options = <span class=\"built_in\">Object</span>.assign(&#123;&#125;, <span class=\"keyword\">this</span>.config.clusterClient, options, &#123;</span><br><span class=\"line\">        singleMode: <span class=\"keyword\">this</span>.options.mode === <span class=\"string\">'single'</span>,</span><br><span class=\"line\">        <span class=\"comment\">// cluster need a port that can't conflict on the environment</span></span><br><span class=\"line\">        port: <span class=\"keyword\">this</span>.options.clusterPort,</span><br><span class=\"line\">        <span class=\"comment\">// agent worker is leader, app workers are follower</span></span><br><span class=\"line\">        isLeader: <span class=\"keyword\">this</span>.type === <span class=\"string\">'agent'</span>,</span><br><span class=\"line\">        logger: <span class=\"keyword\">this</span>.coreLogger</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"keyword\">const</span> client = cluster(clientClass, options)</span><br><span class=\"line\">      <span class=\"keyword\">this</span>._patchClusterClient(client)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> client</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>See agent.js and application.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// agent.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> EggApplication = <span class=\"built_in\">require</span>(<span class=\"string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> AgentWorkerLoader = <span class=\"built_in\">require</span>(<span class=\"string\">'./loader'</span>).AgentWorkerLoader</span><br><span class=\"line\"><span class=\"keyword\">const</span> EGG_LOADER = <span class=\"built_in\">Symbol</span>.for(<span class=\"string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Agent</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"string\">'agent'</span></span><br><span class=\"line\">    <span class=\"keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> AgentWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// application.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> EggApplication = <span class=\"built_in\">require</span>(<span class=\"string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> AgentWorkerLoader = <span class=\"built_in\">require</span>(<span class=\"string\">'./loader'</span>).AppWorkerLoader</span><br><span class=\"line\"><span class=\"keyword\">const</span> EGG_LOADER = <span class=\"built_in\">Symbol</span>.for(<span class=\"string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"string\">'application'</span></span><br><span class=\"line\">    <span class=\"keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> AppWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>We can see that they override the _EGG_LOADER_ property, which uses to create a new <em>loader</em> field in the construction of EggCore that is their parent class. Finally, they call the <em>load</em> function.</p>\n<p>We have the base application code. rNext, look a few of libs for starting web app.</p>\n<h3 id=\"egg-scripts-and-egg-bin\"><a href=\"#egg-scripts-and-egg-bin\" class=\"headerlink\" title=\"egg-scripts and egg-bin\"></a><strong>egg-scripts and egg-bin</strong></h3><p>Both these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don’t know them at most of time.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// package.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"start\"</span>: <span class=\"string\">\"env egg-scripts start\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"dev\"</span>: <span class=\"string\">\"env egg-bin dev\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"stop\"</span>: <span class=\"string\">\"egg-scripts stop\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"debug\"</span>: <span class=\"string\">\"egg-bin debug\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"test\"</span>: <span class=\"string\">\"npm run lint -- --fix &amp;&amp; npm run test-local\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"test-local\"</span>: <span class=\"string\">\"env egg-bin test\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"cov\"</span>: <span class=\"string\">\"egg-bin cov\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The <em>scripts</em> command of this eggjs app conforms to the above description.</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a><strong>egg-cluster</strong></h3><p>The cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- / lib</span><br><span class=\"line\">  - / utils</span><br><span class=\"line\">  - agent_worker.js</span><br><span class=\"line\">  - app_worker.js</span><br><span class=\"line\">  - master.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>I had written an <a href=\"/2019/01/18/egg-cluster\">article</a> about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.</p>\n<h2 id=\"From-start-to-getting-the-first-request\"><a href=\"#From-start-to-getting-the-first-request\" class=\"headerlink\" title=\"#From start to getting the first request\"></a><strong>#From start to getting the first request</strong></h2><p><strong>What happens when we input <code>npm run dev</code> or <code>npm start</code> in the terminal?</strong></p>\n<ul>\n<li><strong>egg-scripts(prod):</strong> it can require <em>framework</em> by <code>child_process.spawn</code> and calls <em>startCluster</em> function.</li>\n<li><strong>egg-bin(dev):</strong> it can require <em>framework</em> by <code>child_process.fork</code> and calls <em>startCluster</em> function.</li>\n<li><code>[parent process]</code>: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the <code>framework</code> is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as <code>--framework { your path }</code></li>\n</ul>\n<p><strong>Pseudo Code</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-scripts</span></span><br><span class=\"line\"><span class=\"comment\">// parent process</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> spawn = <span class=\"built_in\">require</span>(<span class=\"string\">'child_process'</span>).spawn <span class=\"comment\">// create new process</span></span><br><span class=\"line\">spawn(<span class=\"string\">'node'</span>, <span class=\"string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, options))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// egg-bin</span></span><br><span class=\"line\"><span class=\"comment\">// parent process</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> cp = <span class=\"built_in\">require</span>(<span class=\"string\">'child_process'</span>)</span><br><span class=\"line\">cp.fork(<span class=\"string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, args, options) <span class=\"comment\">// create new process</span></span><br></pre></td></tr></table></figure>\n<p>Egg-scripts uses <code>spawn</code> function to require framework while egg-scripts calls <code>fork</code> function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.</p>\n<p>We have two processes. In general, this newly created process is called the master process.</p>\n<p><strong>Why is the master process called birdge?</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg index.js</span></span><br><span class=\"line\">exports.startCluster = <span class=\"built_in\">require</span>(<span class=\"string\">'egg-cluster'</span>).startCluster</span><br></pre></td></tr></table></figure>\n<p>Actually, we exec <code>egg-cluster</code>‘s startCluster function when we require the framework. We open <code>index.js</code> file in the egg-cluster lib. </p>\n<p><strong>First, it is real enter point for whole web app.</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// index.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> Master = <span class=\"built_in\">require</span>(<span class=\"string\">'./lib/master'</span>)</span><br><span class=\"line\">exports.startCluster = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ./lib/master.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> ready = <span class=\"built_in\">require</span>(<span class=\"string\">'get-ready'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> detectPort = <span class=\"built_in\">require</span>(<span class=\"string\">'detect-port'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Manager = <span class=\"built_in\">require</span>(<span class=\"string\">'./utils/manager'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Messenger = <span class=\"built_in\">require</span>(<span class=\"string\">'./utils/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">super</span>()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.options = parseOptions(options)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.workerManager = <span class=\"keyword\">new</span> Manager()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messenger = <span class=\"keyword\">new</span> Messenger(<span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    ready.mixin(<span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.ready(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.isStarted = <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> action = <span class=\"string\">'egg-ready'</span></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(&#123;</span><br><span class=\"line\">        action,</span><br><span class=\"line\">        to: <span class=\"string\">'parent'</span>,</span><br><span class=\"line\">        data: &#123; <span class=\"attr\">port</span>: <span class=\"keyword\">this</span>[REALPORT], <span class=\"attr\">address</span>: <span class=\"keyword\">this</span>[APP_ADDRESS] &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(&#123; action, <span class=\"attr\">to</span>: <span class=\"string\">'app'</span>, <span class=\"attr\">data</span>: <span class=\"keyword\">this</span>.options &#125;)</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(&#123; action, <span class=\"attr\">to</span>: <span class=\"string\">'agent'</span>, <span class=\"attr\">data</span>: <span class=\"keyword\">this</span>.options &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// start check agent and worker status</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isProduction) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.workerManager.startCheck()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// fork app workers after agent started</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.once(<span class=\"string\">'agent-start'</span>, <span class=\"keyword\">this</span>.forkAppWorkers.bind(<span class=\"keyword\">this</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    detectPort(<span class=\"function\">(<span class=\"params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* istanbul ignore if */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">        err.name = <span class=\"string\">'ClusterPortConflictError'</span></span><br><span class=\"line\">        err.message = <span class=\"string\">'[master] try get free port error, '</span> + err.message</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.logger.error(err)</span><br><span class=\"line\">        process.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.options.clusterPort = port</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.forkAgentWorker()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAppWorkers() &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    cluster.on(<span class=\"string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">      worker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">        msg.from = <span class=\"string\">'app'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAgentWorker() &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    agentWorker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">      msg.from = <span class=\"string\">'agent'</span>;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// the callback of ready function will be trigger after all major boots had been loaded</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// forkAgentWorker</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> agent = <span class=\"keyword\">new</span> Agent(options)</span><br><span class=\"line\">agent.ready(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (err) <span class=\"keyword\">return</span></span><br><span class=\"line\">  process.send(&#123; <span class=\"attr\">action</span>: <span class=\"string\">'agent-start'</span>, <span class=\"attr\">to</span>: <span class=\"string\">'master'</span> &#125;)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// fork a single worker</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> Application(options);</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">startServer</span>(<span class=\"params\">err</span>) </span>&#123;  </span><br><span class=\"line\">  <span class=\"keyword\">let</span> server;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (options.https) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> httpsOptions = <span class=\"built_in\">Object</span>.assign(&#123;&#125;, options.https, &#123;</span><br><span class=\"line\">      key: fs.readFileSync(options.https.key),</span><br><span class=\"line\">      cert: fs.readFileSync(options.https.cert),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    server = <span class=\"built_in\">require</span>(<span class=\"string\">'https'</span>).createServer(httpsOptions, app.callback());</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    server = <span class=\"built_in\">require</span>(<span class=\"string\">'http'</span>).createServer(app.callback());</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// emit `server` event in app</span></span><br><span class=\"line\">  app.emit(<span class=\"string\">'server'</span>, server);</span><br><span class=\"line\">  </span><br><span class=\"line\">  server.listen(...args);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">app.ready(startServer);</span><br></pre></td></tr></table></figure>\n<p>On the other hand, this web will be constructed during creating a <code>Master</code> object.</p>\n<ul>\n<li>workerManager: it will hold on all worker porcesses.</li>\n<li>messenger: we make <code>master</code> a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an <a href=\"[http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works怎么通信呢-IPC\">article(Chinese)</a>) about it.</li>\n</ul>\n<blockquote>\n<ul>\n<li>The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)</li>\n<li>EggApplication maintain the other Messenge instance （egg/lib/core/messenger.js）</li>\n<li>Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master</li>\n</ul>\n</blockquote>\n<ul>\n<li><p>ready.mixin &amp; this.ready: ‘get-ready’ often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.</p>\n</li>\n<li><p>detectPort: apply for an available port, default is 7001.If Successly, it will <code>fork</code> an agent process and register a callback message for new created an agent object.</p>\n</li>\n<li><p><code>[agent process]</code>: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.</p>\n<ul>\n<li><p>loadPlugin: find all plugin, record their dir paths =&gt; this.dirs</p>\n</li>\n<li><p>loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.</p>\n</li>\n<li>loadAgentExtend: load and merge all of the extending of agent object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadContextExtend: load and merge all of the extending of context object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.【<a href=\"https://eggjs.org/en/basics/app-start.html\" target=\"_blank\" rel=\"noopener\">Application Startup Configuration(official)</a>】. It help you for better writing a few plugins.</li>\n<li>Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending <code>&#39;agent-start&#39;</code> to the master process.</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"/images/egg-boot/egg-boot.jpg\" alt=\"egg boot process\"></p>\n<ul>\n<li><p><code>[master process]</code>: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get <code>&#39;agent-start&#39;</code> message from the agent process. It will open a new relatable load, we take a single worker process example.</p>\n</li>\n<li><p><code>[a single worker process]</code>: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.</p>\n<ul>\n<li><p>loadPlugin: same as the agent</p>\n</li>\n<li><p>loadConfig: same as the agent</p>\n</li>\n<li><p>loadApplicationExtend: same as the agent  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadRequestExtend: load and merge all of the extending of request object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadResponseExtend: load and merge all of the extending of response object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadContextExtend: same as the agent</p>\n</li>\n<li><p>loadHelperExtend: load and merge all of the extending of helper object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadCustomApp: same as the agent （<em>app &gt; plugin</em>）</p>\n</li>\n<li><p>loadService: load and merge all of the extending of helper object （<em>app &gt; plugin</em>）</p>\n</li>\n<li><p>loadMiddleware: load middlewares and iterate them =&gt; mw, if it conforms the middleware standard, it will be used with app.use(mw) （<em>app &gt; plugin &gt; core</em>）</p>\n</li>\n<li><p>loadController: iterate all controllers’ functions =&gt; key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only <em>app</em>). This middleware will be triggered when getting a new request, the Controller is defined in the <code>app/controller</code> directory and the key is it’s function.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">methodToMiddleware</span>(<span class=\"params\">Controller, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">classControllerMiddleware</span>(<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> controller = <span class=\"keyword\">new</span> Controller(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.app.config.controller || !<span class=\"keyword\">this</span>.app.config.controller.supportParams) &#123;</span><br><span class=\"line\">      args = [ <span class=\"keyword\">this</span> ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> utils.callFn(controller[key], args, controller);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>loadRouter: it makes request’s path associated with the controllers’ function that has been become to middleware (only <em>app</em>)</p>\n</li>\n<li><p>loadCustomLoader: load ourselves function to create some built-in objects for app object or other.<a href=\"https://eggjs.org/en/advanced/loader.html#customloader\" target=\"_blank\" rel=\"noopener\">Customloader</a></p>\n</li>\n</ul>\n<ul>\n<li><code>[master process]</code>: it listens to all worker processes and triggers the master’s ready once they have finished booting.</li>\n<li>send <code>egg-ready</code> to the parent process, the agent process, the app worker processes</li>\n<li>Last, traverse BOOTS and run serverDidReady function of each item.</li>\n</ul>\n<p>It is the whole boot for Eggjs framework but doesn’t include, such as restarting a worker process when it exits or disconnects,  shuting down…</p>\n<p><strong>Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.</strong></p>\n<p><strong>What happens when web app get an Http request?</strong></p>\n<p><em>We only discuss Eggjs code in the applaction layer. :)</em></p>\n<p>The <code>agent</code> can’t deal with any request because it doesn’t listen port. All request always hand over to <code>workers</code>. We look at creating worker code, it will run a app.callback function and listen port when it has booted.</p>\n<p>This callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller’s function.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// koa/lib/application</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title\">Emitter</span> </span>&#123;</span><br><span class=\"line\">  callback() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> fn = compose(<span class=\"keyword\">this</span>.middleware);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.listenerCount(<span class=\"string\">'error'</span>)) <span class=\"keyword\">this</span>.on(<span class=\"string\">'error'</span>, <span class=\"keyword\">this</span>.onerror);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> handleRequest = <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> ctx = <span class=\"keyword\">this</span>.createContext(req, res);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.handleRequest(ctx, fn);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> handleRequest;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  handleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> res = ctx.res;</span><br><span class=\"line\">    res.statusCode = <span class=\"number\">404</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> onerror = <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> ctx.onerror(err);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> handleResponse = <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> respond(ctx);</span><br><span class=\"line\">    onFinished(res, onerror);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> fnMiddleware(ctx).then(handleResponse).catch(onerror);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// egg/lib/application</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">\thandleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.emit(<span class=\"string\">'request'</span>, ctx)</span><br><span class=\"line\">    <span class=\"keyword\">super</span>.handleRequest(ctx, fnMiddleware)</span><br><span class=\"line\">    onFinished(ctx.res, () =&gt; <span class=\"keyword\">this</span>.emit(<span class=\"string\">'response'</span>, ctx))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>In summary, we have know how to boot web app and deal with request in Eggjs.</strong> When we know it, we can easily write some plugins and middlewares to finish the business requirements.</p>"},{"title":"Set A Flag","date":"2019-06-19T05:30:00.000Z","_content":"##### Practice speaking and listening, pass the BEC exam.\n\n\n![book1](/images/bec/1.jpeg)\n![book2](/images/bec/2.jpeg)\n","source":"_posts/bec.md","raw":"---\ntitle: Set A Flag\ncategory: work\ndate: 2019-06-19T13:30:00.000Z\n---\n##### Practice speaking and listening, pass the BEC exam.\n\n\n![book1](/images/bec/1.jpeg)\n![book2](/images/bec/2.jpeg)\n","slug":"bec","published":1,"updated":"2020-07-07T10:11:25.585Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs5d0001d12i4s9mkjdx","content":"<h5 id=\"Practice-speaking-and-listening-pass-the-BEC-exam\"><a href=\"#Practice-speaking-and-listening-pass-the-BEC-exam\" class=\"headerlink\" title=\"Practice speaking and listening, pass the BEC exam.\"></a>Practice speaking and listening, pass the BEC exam.</h5><p><img src=\"/images/bec/1.jpeg\" alt=\"book1\"><br><img src=\"/images/bec/2.jpeg\" alt=\"book2\"></p>\n","site":{"data":{}},"_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"","more":"<h5 id=\"Practice-speaking-and-listening-pass-the-BEC-exam\"><a href=\"#Practice-speaking-and-listening-pass-the-BEC-exam\" class=\"headerlink\" title=\"Practice speaking and listening, pass the BEC exam.\"></a>Practice speaking and listening, pass the BEC exam.</h5><p><img src=\"/images/bec/1.jpeg\" alt=\"book1\"><br><img src=\"/images/bec/2.jpeg\" alt=\"book2\"></p>\n"},{"title":"Express Gateway","keywords":"Express,Gateway,Node.js 网关","description":"为了更好的做BFF层，最近看了一些网关资料，Node.js的网关类库相对薄弱很多。Express Gateway，背靠强大的Express社区，很多现成的中间件可以运用其中，省去了不少开发成本和风险。","date":"2020-01-22T07:32:03.586Z","_content":"\n为了更好的做BFF层，最近看了一些网关资料，Node.js的网关类库相对薄弱很多，主要有2个\n\n- [Express Gateway](https://www.express-gateway.io/)\n- [Moleculer](https://moleculer.services/)\n\n和Lua [Kong](https://konghq.com/)相比缺少很多刚需，比如金丝雀发布、灰度发布等等；和Java Zuul等相比，又少了很多中文文档。但是不管如何这2个是Javascript技术栈的，对于一个Node.js程序工作者来说怎能不香呢？\n\n今天我们主要介绍**Express Gateway**，背靠强大的Express社区，很多现成的中间件可以运用其中，省去了不少开发成本和风险。一些不是很大的项目或者没有时间慢慢构建底层的团队来说，我觉得可以试试。\n\n<!-- more -->\n\n<br/>\n\n## 基础概念\n\n### **Endpoints**\n\nURL的集合，分为2类：\n\n- API endpoints\n- Service endpoints\n\nAPI endpoints是暴露给外网访问的，通过它将请求转发到具体的内网Service endpoints服务上。\n\n\n\n### **Policies**\n\n策略（policy）以Express Middleware的方式相互组织，作用在API请求和网关的响应上，包含触发条件、具体行为和参数。\n\n\n\n### **Pipelines**\n\n一个管道（pipeline）是API endpoints上一组策略（policies）的连接关系，管道里的策略被定义和执行。通过管道配置各种策略，一个API请求由API endpoint接受。在管道里的最后一个策略通常是代理，它将请求路由到一个service endpoint。\n\n\n\n<br/>\n\n\n\n## 安装\n\n官方的[Installation](https://www.express-gateway.io/getting-started/)，可以通过CLI命令快速启动一个项目\n\n```javascript\nnpm install -g express-gateway\n\neg gateway create\n\ncd `Dir Path` && npm start\n```\n\n**2个重要的配置文件**\n\n- system.config.yml：主要是数据库、加密方式、session等等\n- gateway.config.yml：主要就是路由相关的策略\n\n在浏览器里输入 http://localhost:8080/ip ，就会被路由到 https://httpbin.org/ip 这个网站，获得一个JSON数据\n\n```json\n{\n  \"origin\": \"180.167.xxx.xxx\"\n}\n```\n\n当然这是一个超级简单的例，用的是自带的proxy策略，如果有多个微服务节点默认使用的是`round-robin`做负载均衡，除此之外是`static`方式，只能指定死IP或URL了，显然无法满足真实的场景，很多时候需要我们自己根据实际的情况做代理开发，比如从注册中心获取微服务IP和端口做路由转发。\n\n\n\n## 例子\n\n具体的代码可以在[express-gateway-example](https://github.com/miser/express-gateway-example)查看。\n\n- 使用JWT做用户登录验证\n- 2个微服务，一个是`account`，另一个是`banner`\n  - account: 用户登录和需要验证有效身份后显示用户ID\n  - banner: 无需登录就能访问2个banner图片\n\n在新的文件夹下（express-gateway-example），通过eg(express-gateway)和express命令工具分别生成网关项目gateway和2个微服务项目account、banner，另外新建一个存放JWT秘钥的目录`secret-files`，在该目录下通过下面命令创建新的秘钥\n\n```c\nopenssl genrsa -out private.pem 512\nopenssl rsa -in private.pem -outform PEM -pubout -out public.pem\n\n```\n\n**修改网关配置**\n\n```yaml\n// gateway.config.yml\nhttp:\n  port: 8080\n# admin:\n#   port: 9876\n#   host: localhost\napiEndpoints:\n  login:\n    host: localhost\n    paths: '/account/login'\n  account:\n    host: localhost\n    paths: '/account/*'\n  banner:\n    host: localhost\n    paths: '/banner/*'\nserviceEndpoints:\n  accountSrv:\n    url: 'http://localhost:3001'\n  bannerSrv:\n    url: 'http://localhost:3002'\npolicies:\n  - jwt\n  - proxy\npipelines:\n  login:\n    apiEndpoints:\n      - login\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv \n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n\n```\n\n**3个apiEndpoints**\n\n- login：访问path _/account/login_\n- account：访问path _/account/*_\n- banner：访问path _/banner/*_\n\n**2个serviceEndpoints**\n\n- accountSrv：对应`account`服务，本地端口3001\n- bannerSrv：对应`banner`服务，本地端口3002\n\n**配置pipelines**\n\n- login和banner这2个apiEndpoints被分别简单的路由到各自的微服务上\n- account这个apiEndpoints除了路由外还有JWT策略，action告诉系统它将以URL query的token字段传递加密的认证信息\n\n**启动项目和访问它们**\n\n在各个目录下通过`npm start`分别启动它们，通过Postman GET请求http://localhost:8080/account/profile 发现返回401，可见没有通过token验证就会返回401，符合pipelines里account的配置；GET 请求http://localhost:8080/banner/ 会正常返回数据，它没有被JWT策略约束\n\n```\n{\"code\":200,\"message\":\"success\",\"data\":[\"/images/1.png\",\"/images/2.png\"]}\n```\n\n**获取token**\n\nPOST http://localhost:8080/account/login ,它在配置中也未加JWT策略，返回如下：\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"token\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"\n}\n```\n\n将token以URL query形式传参，重新访问profile接口，就正常返回用户ID了\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": {\n        \"id\": \"2020\"\n    }\n}\n```\n\n上述就是一个简单的Gateway简单的例子，除开内置的一些策略（中间件）外，我们还可以自己开发一些中间件来满足具体需求——**`插件`**。\n\n<br/>\n\n## 插件\n\n插件分两种：\n\n- [Conditions](https://www.express-gateway.io/docs/policies/customization/conditions/)\n\n- [Policies](https://www.express-gateway.io/docs/policies/)\n\n无论是上述哪一个，写好后都要注册到网关中，在gateway项目中新建`plugins`目录，及其子目录`policies`、`conditions`， 和`manifest.js`、`policies/index.js`、`conditions/index.js`文件\n\n```javascript\n// manifest.js\nmodule.exports = {\n  version: '0.0.1',\n  init: function (pluginContext) {\n    const policy = require('./policies/index.js');\n    pluginContext.registerPolicy(policy);\n\n    const condition = require('./conditions/index.js');\n    pluginContext.registerCondition(condition);\n  }\n}\n```\n\n通过registerPolicy和registerCondition将策略和条件注册到网关系统中，另外在`system.config.yml`配置文件中添加插件的配置路径\n\n```yaml\n// system.config.yml\nplugins:\n  example:\n    package: './plugins/manifest.js'\n```\n\n\n\n**Conditions 条件**\n\n它通过定义一个方法来判断是否执行或跳过一个策略\n\n> ##### `function (req, conditionConfig) => true/false` Handler\n>\n> - Executes on each request in current pipeline. If not matched will prevent policy from being fired\n\n在上面的例子中，我们在apiEndpoints和pipelines都定义了一个login，其实它是accountSrv的一个特殊的存在，除了login其它的url地址都是受JWT策略约束的，按照之前的写法显得格外的冗余，我们可以通过一个Condition来做改进，重新改写gateway.config.yml\n\n```yaml\n// gateway.config.yml\napiEndpoints:\n  # login:\n  #   host: localhost\n  #   paths: '/account/login'\n  \n# ...\n\npipelines:\n  # login:\n  #   apiEndpoints:\n  #     - login\n  #   policies:\n  #     - proxy:\n  #         - action:\n  #             serviceEndpoint: accountSrv \n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - \n            condition:\n              name: 'white-list'\n              list: ['/account/login']\n            action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n```\n\n我们看到在jwt下面多了一个condition，然后在`conditions/index.js`里实现一个简单的URL Path 过滤\n\n```javascript\nmodule.exports = {\n  name: 'white-list',\n  schema: {\n    $id: 'white-list',\n  },\n  handler: conditionConfig => req => {\n    return conditionConfig.list.indexOf(req.url) < 0;\n  }\n};\n```\n\n这个Condition就完成了白名单功能了。\n\n\n\n**Policies 策略**\n\n它通过一个中间件方法对所有流入网关请求的预处理\n\n结合上面的banner接口，我们新开发了一个v2版本的banner列表接口`/banner/v2/list`，为了老版本的客户端依旧能通过`/banner`接口访问到新的v2版本，我们需要做一个URL替换\n\n```yaml\npipelines:\n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - rewrite:\n          - action:\n              search: '/banner'\n              replace: '/banner/v1/list'\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n```\n\n在`policies/index.js`添加替换方法\n\n```javascript\nmodule.exports = {\n  name: 'rewrite',\n  schema: {\n    $id: 'rewrite',\n  },\n  policy: (actionParams) => {\n    return (req, res, next) => {\n      req.url = req.url.replace(actionParams.search, actionParams.replace);\n      next()\n    };\n  }\n};\n```\n\n当我们再GET http://localhost:8080/banner/ 时候，将返回新的v2版本的数据\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": [\n        \"/images/v2_1.png\"\n    ]\n}\n```\n\n至此，简单的URL地址替换就完成了。\n\n\n\n<br/>\n\n<br/>\n\n\n\n## 总结\n\n上诉只是Express-Gateway的一角，还有很多有趣灵活的功能值得慢慢探索。BFF层最为整个大系统的前沿征地，而网关更是前沿的前沿，配合GraphQL我相信能不断释放出JavaScript快速开发和迭代的能力，为客户端提供更好的服务和需求响应。","source":"_posts/express-gateway.md","raw":"---\ntitle: Express Gateway\ncategory: JavaScript\nkeywords: Express,Gateway,Node.js 网关\ndescription: 为了更好的做BFF层，最近看了一些网关资料，Node.js的网关类库相对薄弱很多。Express Gateway，背靠强大的Express社区，很多现成的中间件可以运用其中，省去了不少开发成本和风险。\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-01-22T15:32:03.586Z\n---\n\n为了更好的做BFF层，最近看了一些网关资料，Node.js的网关类库相对薄弱很多，主要有2个\n\n- [Express Gateway](https://www.express-gateway.io/)\n- [Moleculer](https://moleculer.services/)\n\n和Lua [Kong](https://konghq.com/)相比缺少很多刚需，比如金丝雀发布、灰度发布等等；和Java Zuul等相比，又少了很多中文文档。但是不管如何这2个是Javascript技术栈的，对于一个Node.js程序工作者来说怎能不香呢？\n\n今天我们主要介绍**Express Gateway**，背靠强大的Express社区，很多现成的中间件可以运用其中，省去了不少开发成本和风险。一些不是很大的项目或者没有时间慢慢构建底层的团队来说，我觉得可以试试。\n\n<!-- more -->\n\n<br/>\n\n## 基础概念\n\n### **Endpoints**\n\nURL的集合，分为2类：\n\n- API endpoints\n- Service endpoints\n\nAPI endpoints是暴露给外网访问的，通过它将请求转发到具体的内网Service endpoints服务上。\n\n\n\n### **Policies**\n\n策略（policy）以Express Middleware的方式相互组织，作用在API请求和网关的响应上，包含触发条件、具体行为和参数。\n\n\n\n### **Pipelines**\n\n一个管道（pipeline）是API endpoints上一组策略（policies）的连接关系，管道里的策略被定义和执行。通过管道配置各种策略，一个API请求由API endpoint接受。在管道里的最后一个策略通常是代理，它将请求路由到一个service endpoint。\n\n\n\n<br/>\n\n\n\n## 安装\n\n官方的[Installation](https://www.express-gateway.io/getting-started/)，可以通过CLI命令快速启动一个项目\n\n```javascript\nnpm install -g express-gateway\n\neg gateway create\n\ncd `Dir Path` && npm start\n```\n\n**2个重要的配置文件**\n\n- system.config.yml：主要是数据库、加密方式、session等等\n- gateway.config.yml：主要就是路由相关的策略\n\n在浏览器里输入 http://localhost:8080/ip ，就会被路由到 https://httpbin.org/ip 这个网站，获得一个JSON数据\n\n```json\n{\n  \"origin\": \"180.167.xxx.xxx\"\n}\n```\n\n当然这是一个超级简单的例，用的是自带的proxy策略，如果有多个微服务节点默认使用的是`round-robin`做负载均衡，除此之外是`static`方式，只能指定死IP或URL了，显然无法满足真实的场景，很多时候需要我们自己根据实际的情况做代理开发，比如从注册中心获取微服务IP和端口做路由转发。\n\n\n\n## 例子\n\n具体的代码可以在[express-gateway-example](https://github.com/miser/express-gateway-example)查看。\n\n- 使用JWT做用户登录验证\n- 2个微服务，一个是`account`，另一个是`banner`\n  - account: 用户登录和需要验证有效身份后显示用户ID\n  - banner: 无需登录就能访问2个banner图片\n\n在新的文件夹下（express-gateway-example），通过eg(express-gateway)和express命令工具分别生成网关项目gateway和2个微服务项目account、banner，另外新建一个存放JWT秘钥的目录`secret-files`，在该目录下通过下面命令创建新的秘钥\n\n```c\nopenssl genrsa -out private.pem 512\nopenssl rsa -in private.pem -outform PEM -pubout -out public.pem\n\n```\n\n**修改网关配置**\n\n```yaml\n// gateway.config.yml\nhttp:\n  port: 8080\n# admin:\n#   port: 9876\n#   host: localhost\napiEndpoints:\n  login:\n    host: localhost\n    paths: '/account/login'\n  account:\n    host: localhost\n    paths: '/account/*'\n  banner:\n    host: localhost\n    paths: '/banner/*'\nserviceEndpoints:\n  accountSrv:\n    url: 'http://localhost:3001'\n  bannerSrv:\n    url: 'http://localhost:3002'\npolicies:\n  - jwt\n  - proxy\npipelines:\n  login:\n    apiEndpoints:\n      - login\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv \n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n\n```\n\n**3个apiEndpoints**\n\n- login：访问path _/account/login_\n- account：访问path _/account/*_\n- banner：访问path _/banner/*_\n\n**2个serviceEndpoints**\n\n- accountSrv：对应`account`服务，本地端口3001\n- bannerSrv：对应`banner`服务，本地端口3002\n\n**配置pipelines**\n\n- login和banner这2个apiEndpoints被分别简单的路由到各自的微服务上\n- account这个apiEndpoints除了路由外还有JWT策略，action告诉系统它将以URL query的token字段传递加密的认证信息\n\n**启动项目和访问它们**\n\n在各个目录下通过`npm start`分别启动它们，通过Postman GET请求http://localhost:8080/account/profile 发现返回401，可见没有通过token验证就会返回401，符合pipelines里account的配置；GET 请求http://localhost:8080/banner/ 会正常返回数据，它没有被JWT策略约束\n\n```\n{\"code\":200,\"message\":\"success\",\"data\":[\"/images/1.png\",\"/images/2.png\"]}\n```\n\n**获取token**\n\nPOST http://localhost:8080/account/login ,它在配置中也未加JWT策略，返回如下：\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"token\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"\n}\n```\n\n将token以URL query形式传参，重新访问profile接口，就正常返回用户ID了\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": {\n        \"id\": \"2020\"\n    }\n}\n```\n\n上述就是一个简单的Gateway简单的例子，除开内置的一些策略（中间件）外，我们还可以自己开发一些中间件来满足具体需求——**`插件`**。\n\n<br/>\n\n## 插件\n\n插件分两种：\n\n- [Conditions](https://www.express-gateway.io/docs/policies/customization/conditions/)\n\n- [Policies](https://www.express-gateway.io/docs/policies/)\n\n无论是上述哪一个，写好后都要注册到网关中，在gateway项目中新建`plugins`目录，及其子目录`policies`、`conditions`， 和`manifest.js`、`policies/index.js`、`conditions/index.js`文件\n\n```javascript\n// manifest.js\nmodule.exports = {\n  version: '0.0.1',\n  init: function (pluginContext) {\n    const policy = require('./policies/index.js');\n    pluginContext.registerPolicy(policy);\n\n    const condition = require('./conditions/index.js');\n    pluginContext.registerCondition(condition);\n  }\n}\n```\n\n通过registerPolicy和registerCondition将策略和条件注册到网关系统中，另外在`system.config.yml`配置文件中添加插件的配置路径\n\n```yaml\n// system.config.yml\nplugins:\n  example:\n    package: './plugins/manifest.js'\n```\n\n\n\n**Conditions 条件**\n\n它通过定义一个方法来判断是否执行或跳过一个策略\n\n> ##### `function (req, conditionConfig) => true/false` Handler\n>\n> - Executes on each request in current pipeline. If not matched will prevent policy from being fired\n\n在上面的例子中，我们在apiEndpoints和pipelines都定义了一个login，其实它是accountSrv的一个特殊的存在，除了login其它的url地址都是受JWT策略约束的，按照之前的写法显得格外的冗余，我们可以通过一个Condition来做改进，重新改写gateway.config.yml\n\n```yaml\n// gateway.config.yml\napiEndpoints:\n  # login:\n  #   host: localhost\n  #   paths: '/account/login'\n  \n# ...\n\npipelines:\n  # login:\n  #   apiEndpoints:\n  #     - login\n  #   policies:\n  #     - proxy:\n  #         - action:\n  #             serviceEndpoint: accountSrv \n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - \n            condition:\n              name: 'white-list'\n              list: ['/account/login']\n            action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n```\n\n我们看到在jwt下面多了一个condition，然后在`conditions/index.js`里实现一个简单的URL Path 过滤\n\n```javascript\nmodule.exports = {\n  name: 'white-list',\n  schema: {\n    $id: 'white-list',\n  },\n  handler: conditionConfig => req => {\n    return conditionConfig.list.indexOf(req.url) < 0;\n  }\n};\n```\n\n这个Condition就完成了白名单功能了。\n\n\n\n**Policies 策略**\n\n它通过一个中间件方法对所有流入网关请求的预处理\n\n结合上面的banner接口，我们新开发了一个v2版本的banner列表接口`/banner/v2/list`，为了老版本的客户端依旧能通过`/banner`接口访问到新的v2版本，我们需要做一个URL替换\n\n```yaml\npipelines:\n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - rewrite:\n          - action:\n              search: '/banner'\n              replace: '/banner/v1/list'\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n```\n\n在`policies/index.js`添加替换方法\n\n```javascript\nmodule.exports = {\n  name: 'rewrite',\n  schema: {\n    $id: 'rewrite',\n  },\n  policy: (actionParams) => {\n    return (req, res, next) => {\n      req.url = req.url.replace(actionParams.search, actionParams.replace);\n      next()\n    };\n  }\n};\n```\n\n当我们再GET http://localhost:8080/banner/ 时候，将返回新的v2版本的数据\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": [\n        \"/images/v2_1.png\"\n    ]\n}\n```\n\n至此，简单的URL地址替换就完成了。\n\n\n\n<br/>\n\n<br/>\n\n\n\n## 总结\n\n上诉只是Express-Gateway的一角，还有很多有趣灵活的功能值得慢慢探索。BFF层最为整个大系统的前沿征地，而网关更是前沿的前沿，配合GraphQL我相信能不断释放出JavaScript快速开发和迭代的能力，为客户端提供更好的服务和需求响应。","slug":"express-gateway","published":1,"updated":"2020-07-07T10:11:25.587Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs5k0004d12ir6oazsoe","content":"<p>为了更好的做BFF层，最近看了一些网关资料，Node.js的网关类库相对薄弱很多，主要有2个</p>\n<ul>\n<li><a href=\"https://www.express-gateway.io/\" target=\"_blank\" rel=\"noopener\">Express Gateway</a></li>\n<li><a href=\"https://moleculer.services/\" target=\"_blank\" rel=\"noopener\">Moleculer</a></li>\n</ul>\n<p>和Lua <a href=\"https://konghq.com/\" target=\"_blank\" rel=\"noopener\">Kong</a>相比缺少很多刚需，比如金丝雀发布、灰度发布等等；和Java Zuul等相比，又少了很多中文文档。但是不管如何这2个是Javascript技术栈的，对于一个Node.js程序工作者来说怎能不香呢？</p>\n<p>今天我们主要介绍<strong>Express Gateway</strong>，背靠强大的Express社区，很多现成的中间件可以运用其中，省去了不少开发成本和风险。一些不是很大的项目或者没有时间慢慢构建底层的团队来说，我觉得可以试试。</p>\n<a id=\"more\"></a>\n<p><br></p>\n<h2 id=\"基础概念\"><a href=\"#基础概念\" class=\"headerlink\" title=\"基础概念\"></a>基础概念</h2><h3 id=\"Endpoints\"><a href=\"#Endpoints\" class=\"headerlink\" title=\"Endpoints\"></a><strong>Endpoints</strong></h3><p>URL的集合，分为2类：</p>\n<ul>\n<li>API endpoints</li>\n<li>Service endpoints</li>\n</ul>\n<p>API endpoints是暴露给外网访问的，通过它将请求转发到具体的内网Service endpoints服务上。</p>\n<h3 id=\"Policies\"><a href=\"#Policies\" class=\"headerlink\" title=\"Policies\"></a><strong>Policies</strong></h3><p>策略（policy）以Express Middleware的方式相互组织，作用在API请求和网关的响应上，包含触发条件、具体行为和参数。</p>\n<h3 id=\"Pipelines\"><a href=\"#Pipelines\" class=\"headerlink\" title=\"Pipelines\"></a><strong>Pipelines</strong></h3><p>一个管道（pipeline）是API endpoints上一组策略（policies）的连接关系，管道里的策略被定义和执行。通过管道配置各种策略，一个API请求由API endpoint接受。在管道里的最后一个策略通常是代理，它将请求路由到一个service endpoint。</p>\n<p><br></p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>官方的<a href=\"https://www.express-gateway.io/getting-started/\" target=\"_blank\" rel=\"noopener\">Installation</a>，可以通过CLI命令快速启动一个项目</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g express-gateway</span><br><span class=\"line\"></span><br><span class=\"line\">eg gateway create</span><br><span class=\"line\"></span><br><span class=\"line\">cd <span class=\"hljs-string\">`Dir Path`</span> &amp;&amp; npm start</span><br></pre></td></tr></table></figure>\n<p><strong>2个重要的配置文件</strong></p>\n<ul>\n<li>system.config.yml：主要是数据库、加密方式、session等等</li>\n<li>gateway.config.yml：主要就是路由相关的策略</li>\n</ul>\n<p>在浏览器里输入 <a href=\"http://localhost:8080/ip\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/ip</a> ，就会被路由到 <a href=\"https://httpbin.org/ip\" target=\"_blank\" rel=\"noopener\">https://httpbin.org/ip</a> 这个网站，获得一个JSON数据</p>\n<figure class=\"highlight json hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"origin\"</span>: <span class=\"hljs-string\">\"180.167.xxx.xxx\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当然这是一个超级简单的例，用的是自带的proxy策略，如果有多个微服务节点默认使用的是<code>round-robin</code>做负载均衡，除此之外是<code>static</code>方式，只能指定死IP或URL了，显然无法满足真实的场景，很多时候需要我们自己根据实际的情况做代理开发，比如从注册中心获取微服务IP和端口做路由转发。</p>\n<h2 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h2><p>具体的代码可以在<a href=\"https://github.com/miser/express-gateway-example\" target=\"_blank\" rel=\"noopener\">express-gateway-example</a>查看。</p>\n<ul>\n<li>使用JWT做用户登录验证</li>\n<li>2个微服务，一个是<code>account</code>，另一个是<code>banner</code><ul>\n<li>account: 用户登录和需要验证有效身份后显示用户ID</li>\n<li>banner: 无需登录就能访问2个banner图片</li>\n</ul>\n</li>\n</ul>\n<p>在新的文件夹下（express-gateway-example），通过eg(express-gateway)和express命令工具分别生成网关项目gateway和2个微服务项目account、banner，另外新建一个存放JWT秘钥的目录<code>secret-files</code>，在该目录下通过下面命令创建新的秘钥</p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl genrsa -out <span class=\"hljs-keyword\">private</span>.pem <span class=\"hljs-number\">512</span></span><br><span class=\"line\">openssl rsa -in <span class=\"hljs-keyword\">private</span>.pem -outform PEM -pubout -out <span class=\"hljs-keyword\">public</span>.pem</span><br></pre></td></tr></table></figure>\n<p><strong>修改网关配置</strong></p>\n<figure class=\"highlight yaml hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"hljs-attr\">http:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  port:</span> <span class=\"hljs-number\">8080</span></span><br><span class=\"line\"><span class=\"hljs-comment\"># admin:</span></span><br><span class=\"line\"><span class=\"hljs-comment\">#   port: 9876</span></span><br><span class=\"line\"><span class=\"hljs-comment\">#   host: localhost</span></span><br><span class=\"line\"><span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  login:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    host:</span> <span class=\"hljs-string\">localhost</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    paths:</span> <span class=\"hljs-string\">'/account/login'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  account:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    host:</span> <span class=\"hljs-string\">localhost</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    paths:</span> <span class=\"hljs-string\">'/account/*'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  banner:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    host:</span> <span class=\"hljs-string\">localhost</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    paths:</span> <span class=\"hljs-string\">'/banner/*'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">serviceEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  accountSrv:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    url:</span> <span class=\"hljs-string\">'http://localhost:3001'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  bannerSrv:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    url:</span> <span class=\"hljs-string\">'http://localhost:3002'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">policies:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">  -</span> <span class=\"hljs-string\">jwt</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">  -</span> <span class=\"hljs-string\">proxy</span></span><br><span class=\"line\"><span class=\"hljs-attr\">pipelines:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  login:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> <span class=\"hljs-string\">login</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    policies:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              serviceEndpoint:</span> <span class=\"hljs-string\">accountSrv</span> </span><br><span class=\"line\"><span class=\"hljs-attr\">  banner:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> <span class=\"hljs-string\">banner</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    policies:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              serviceEndpoint:</span> <span class=\"hljs-string\">bannerSrv</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  account:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> <span class=\"hljs-string\">account</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    policies:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - jwt:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              jwtExtractor:</span> <span class=\"hljs-string\">'query'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              jwtExtractorField:</span> <span class=\"hljs-string\">'token'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              checkCredentialExistence:</span> <span class=\"hljs-literal\">false</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              secretOrPublicKeyFile:</span> <span class=\"hljs-string\">'../secret-files/public.pem'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              serviceEndpoint:</span> <span class=\"hljs-string\">accountSrv</span></span><br></pre></td></tr></table></figure>\n<p><strong>3个apiEndpoints</strong></p>\n<ul>\n<li>login：访问path <em>/account/login</em></li>\n<li>account：访问path <em>/account/*</em></li>\n<li>banner：访问path <em>/banner/*</em></li>\n</ul>\n<p><strong>2个serviceEndpoints</strong></p>\n<ul>\n<li>accountSrv：对应<code>account</code>服务，本地端口3001</li>\n<li>bannerSrv：对应<code>banner</code>服务，本地端口3002</li>\n</ul>\n<p><strong>配置pipelines</strong></p>\n<ul>\n<li>login和banner这2个apiEndpoints被分别简单的路由到各自的微服务上</li>\n<li>account这个apiEndpoints除了路由外还有JWT策略，action告诉系统它将以URL query的token字段传递加密的认证信息</li>\n</ul>\n<p><strong>启动项目和访问它们</strong></p>\n<p>在各个目录下通过<code>npm start</code>分别启动它们，通过Postman GET请求<a href=\"http://localhost:8080/account/profile\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/account/profile</a> 发现返回401，可见没有通过token验证就会返回401，符合pipelines里account的配置；GET 请求<a href=\"http://localhost:8080/banner/\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/banner/</a> 会正常返回数据，它没有被JWT策略约束</p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;code&quot;:200,&quot;message&quot;:&quot;success&quot;,&quot;data&quot;:[&quot;/images/1.png&quot;,&quot;/images/2.png&quot;]&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>获取token</strong></p>\n<p>POST <a href=\"http://localhost:8080/account/login\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/account/login</a> ,它在配置中也未加JWT策略，返回如下：</p>\n<figure class=\"highlight json hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"code\"</span>: <span class=\"hljs-number\">200</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"message\"</span>: <span class=\"hljs-string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"token\"</span>: <span class=\"hljs-string\">\"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>将token以URL query形式传参，重新访问profile接口，就正常返回用户ID了</p>\n<figure class=\"highlight json hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"code\"</span>: <span class=\"hljs-number\">200</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"message\"</span>: <span class=\"hljs-string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"data\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"hljs-attr\">\"id\"</span>: <span class=\"hljs-string\">\"2020\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述就是一个简单的Gateway简单的例子，除开内置的一些策略（中间件）外，我们还可以自己开发一些中间件来满足具体需求——<strong><code>插件</code></strong>。</p>\n<p><br></p>\n<h2 id=\"插件\"><a href=\"#插件\" class=\"headerlink\" title=\"插件\"></a>插件</h2><p>插件分两种：</p>\n<ul>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/customization/conditions/\" target=\"_blank\" rel=\"noopener\">Conditions</a></p>\n</li>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/\" target=\"_blank\" rel=\"noopener\">Policies</a></p>\n</li>\n</ul>\n<p>无论是上述哪一个，写好后都要注册到网关中，在gateway项目中新建<code>plugins</code>目录，及其子目录<code>policies</code>、<code>conditions</code>， 和<code>manifest.js</code>、<code>policies/index.js</code>、<code>conditions/index.js</code>文件</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// manifest.js</span></span><br><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  version: <span class=\"hljs-string\">'0.0.1'</span>,</span><br><span class=\"line\">  init: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">pluginContext</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> policy = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./policies/index.js'</span>);</span><br><span class=\"line\">    pluginContext.registerPolicy(policy);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> condition = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./conditions/index.js'</span>);</span><br><span class=\"line\">    pluginContext.registerCondition(condition);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过registerPolicy和registerCondition将策略和条件注册到网关系统中，另外在<code>system.config.yml</code>配置文件中添加插件的配置路径</p>\n<figure class=\"highlight yaml hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">system.config.yml</span></span><br><span class=\"line\"><span class=\"hljs-attr\">plugins:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  example:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    package:</span> <span class=\"hljs-string\">'./plugins/manifest.js'</span></span><br></pre></td></tr></table></figure>\n<p><strong>Conditions 条件</strong></p>\n<p>它通过定义一个方法来判断是否执行或跳过一个策略</p>\n<blockquote>\n<h5 id=\"function-req-conditionConfig-gt-true-false-Handler\"><a href=\"#function-req-conditionConfig-gt-true-false-Handler\" class=\"headerlink\" title=\"function (req, conditionConfig) =&gt; true/false Handler\"></a><code>function (req, conditionConfig) =&gt; true/false</code> Handler</h5><ul>\n<li>Executes on each request in current pipeline. If not matched will prevent policy from being fired</li>\n</ul>\n</blockquote>\n<p>在上面的例子中，我们在apiEndpoints和pipelines都定义了一个login，其实它是accountSrv的一个特殊的存在，除了login其它的url地址都是受JWT策略约束的，按照之前的写法显得格外的冗余，我们可以通过一个Condition来做改进，重新改写gateway.config.yml</p>\n<figure class=\"highlight yaml hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\"># login:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   host: localhost</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   paths: '/account/login'</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"hljs-comment\"># ...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-attr\">pipelines:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\"># login:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#     - login</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   policies:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#     - proxy:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#         - action:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#             serviceEndpoint: accountSrv </span></span><br><span class=\"line\"><span class=\"hljs-attr\">  account:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> <span class=\"hljs-string\">account</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    policies:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - jwt:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">          -</span> </span><br><span class=\"line\"><span class=\"hljs-attr\">            condition:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              name:</span> <span class=\"hljs-string\">'white-list'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              list:</span> <span class=\"hljs-string\">['/account/login']</span></span><br><span class=\"line\"><span class=\"hljs-attr\">            action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              jwtExtractor:</span> <span class=\"hljs-string\">'query'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              jwtExtractorField:</span> <span class=\"hljs-string\">'token'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              checkCredentialExistence:</span> <span class=\"hljs-literal\">false</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              secretOrPublicKeyFile:</span> <span class=\"hljs-string\">'../secret-files/public.pem'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              serviceEndpoint:</span> <span class=\"hljs-string\">accountSrv</span></span><br></pre></td></tr></table></figure>\n<p>我们看到在jwt下面多了一个condition，然后在<code>conditions/index.js</code>里实现一个简单的URL Path 过滤</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  name: <span class=\"hljs-string\">'white-list'</span>,</span><br><span class=\"line\">  schema: &#123;</span><br><span class=\"line\">    $id: <span class=\"hljs-string\">'white-list'</span>,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  handler: <span class=\"hljs-function\"><span class=\"hljs-params\">conditionConfig</span> =&gt;</span> req =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> conditionConfig.list.indexOf(req.url) &lt; <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>这个Condition就完成了白名单功能了。</p>\n<p><strong>Policies 策略</strong></p>\n<p>它通过一个中间件方法对所有流入网关请求的预处理</p>\n<p>结合上面的banner接口，我们新开发了一个v2版本的banner列表接口<code>/banner/v2/list</code>，为了老版本的客户端依旧能通过<code>/banner</code>接口访问到新的v2版本，我们需要做一个URL替换</p>\n<figure class=\"highlight yaml hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-attr\">pipelines:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  banner:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> <span class=\"hljs-string\">banner</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    policies:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - rewrite:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              search:</span> <span class=\"hljs-string\">'/banner'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              replace:</span> <span class=\"hljs-string\">'/banner/v1/list'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              serviceEndpoint:</span> <span class=\"hljs-string\">bannerSrv</span></span><br></pre></td></tr></table></figure>\n<p>在<code>policies/index.js</code>添加替换方法</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  name: <span class=\"hljs-string\">'rewrite'</span>,</span><br><span class=\"line\">  schema: &#123;</span><br><span class=\"line\">    $id: <span class=\"hljs-string\">'rewrite'</span>,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  policy: <span class=\"hljs-function\">(<span class=\"hljs-params\">actionParams</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-function\">(<span class=\"hljs-params\">req, res, next</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      req.url = req.url.replace(actionParams.search, actionParams.replace);</span><br><span class=\"line\">      next()</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>当我们再GET <a href=\"http://localhost:8080/banner/\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/banner/</a> 时候，将返回新的v2版本的数据</p>\n<figure class=\"highlight json hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"code\"</span>: <span class=\"hljs-number\">200</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"message\"</span>: <span class=\"hljs-string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"data\"</span>: [</span><br><span class=\"line\">        <span class=\"hljs-string\">\"/images/v2_1.png\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>至此，简单的URL地址替换就完成了。</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>上诉只是Express-Gateway的一角，还有很多有趣灵活的功能值得慢慢探索。BFF层最为整个大系统的前沿征地，而网关更是前沿的前沿，配合GraphQL我相信能不断释放出JavaScript快速开发和迭代的能力，为客户端提供更好的服务和需求响应。</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p>为了更好的做BFF层，最近看了一些网关资料，Node.js的网关类库相对薄弱很多，主要有2个</p>\n<ul>\n<li><a href=\"https://www.express-gateway.io/\" target=\"_blank\" rel=\"noopener\">Express Gateway</a></li>\n<li><a href=\"https://moleculer.services/\" target=\"_blank\" rel=\"noopener\">Moleculer</a></li>\n</ul>\n<p>和Lua <a href=\"https://konghq.com/\" target=\"_blank\" rel=\"noopener\">Kong</a>相比缺少很多刚需，比如金丝雀发布、灰度发布等等；和Java Zuul等相比，又少了很多中文文档。但是不管如何这2个是Javascript技术栈的，对于一个Node.js程序工作者来说怎能不香呢？</p>\n<p>今天我们主要介绍<strong>Express Gateway</strong>，背靠强大的Express社区，很多现成的中间件可以运用其中，省去了不少开发成本和风险。一些不是很大的项目或者没有时间慢慢构建底层的团队来说，我觉得可以试试。</p>","more":"<p><br></p>\n<h2 id=\"基础概念\"><a href=\"#基础概念\" class=\"headerlink\" title=\"基础概念\"></a>基础概念</h2><h3 id=\"Endpoints\"><a href=\"#Endpoints\" class=\"headerlink\" title=\"Endpoints\"></a><strong>Endpoints</strong></h3><p>URL的集合，分为2类：</p>\n<ul>\n<li>API endpoints</li>\n<li>Service endpoints</li>\n</ul>\n<p>API endpoints是暴露给外网访问的，通过它将请求转发到具体的内网Service endpoints服务上。</p>\n<h3 id=\"Policies\"><a href=\"#Policies\" class=\"headerlink\" title=\"Policies\"></a><strong>Policies</strong></h3><p>策略（policy）以Express Middleware的方式相互组织，作用在API请求和网关的响应上，包含触发条件、具体行为和参数。</p>\n<h3 id=\"Pipelines\"><a href=\"#Pipelines\" class=\"headerlink\" title=\"Pipelines\"></a><strong>Pipelines</strong></h3><p>一个管道（pipeline）是API endpoints上一组策略（policies）的连接关系，管道里的策略被定义和执行。通过管道配置各种策略，一个API请求由API endpoint接受。在管道里的最后一个策略通常是代理，它将请求路由到一个service endpoint。</p>\n<p><br></p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>官方的<a href=\"https://www.express-gateway.io/getting-started/\" target=\"_blank\" rel=\"noopener\">Installation</a>，可以通过CLI命令快速启动一个项目</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g express-gateway</span><br><span class=\"line\"></span><br><span class=\"line\">eg gateway create</span><br><span class=\"line\"></span><br><span class=\"line\">cd <span class=\"string\">`Dir Path`</span> &amp;&amp; npm start</span><br></pre></td></tr></table></figure>\n<p><strong>2个重要的配置文件</strong></p>\n<ul>\n<li>system.config.yml：主要是数据库、加密方式、session等等</li>\n<li>gateway.config.yml：主要就是路由相关的策略</li>\n</ul>\n<p>在浏览器里输入 <a href=\"http://localhost:8080/ip\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/ip</a> ，就会被路由到 <a href=\"https://httpbin.org/ip\" target=\"_blank\" rel=\"noopener\">https://httpbin.org/ip</a> 这个网站，获得一个JSON数据</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"origin\"</span>: <span class=\"string\">\"180.167.xxx.xxx\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当然这是一个超级简单的例，用的是自带的proxy策略，如果有多个微服务节点默认使用的是<code>round-robin</code>做负载均衡，除此之外是<code>static</code>方式，只能指定死IP或URL了，显然无法满足真实的场景，很多时候需要我们自己根据实际的情况做代理开发，比如从注册中心获取微服务IP和端口做路由转发。</p>\n<h2 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h2><p>具体的代码可以在<a href=\"https://github.com/miser/express-gateway-example\" target=\"_blank\" rel=\"noopener\">express-gateway-example</a>查看。</p>\n<ul>\n<li>使用JWT做用户登录验证</li>\n<li>2个微服务，一个是<code>account</code>，另一个是<code>banner</code><ul>\n<li>account: 用户登录和需要验证有效身份后显示用户ID</li>\n<li>banner: 无需登录就能访问2个banner图片</li>\n</ul>\n</li>\n</ul>\n<p>在新的文件夹下（express-gateway-example），通过eg(express-gateway)和express命令工具分别生成网关项目gateway和2个微服务项目account、banner，另外新建一个存放JWT秘钥的目录<code>secret-files</code>，在该目录下通过下面命令创建新的秘钥</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl genrsa -out <span class=\"keyword\">private</span>.pem <span class=\"number\">512</span></span><br><span class=\"line\">openssl rsa -in <span class=\"keyword\">private</span>.pem -outform PEM -pubout -out <span class=\"keyword\">public</span>.pem</span><br></pre></td></tr></table></figure>\n<p><strong>修改网关配置</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"attr\">http:</span></span><br><span class=\"line\"><span class=\"attr\">  port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"comment\"># admin:</span></span><br><span class=\"line\"><span class=\"comment\">#   port: 9876</span></span><br><span class=\"line\"><span class=\"comment\">#   host: localhost</span></span><br><span class=\"line\"><span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\"><span class=\"attr\">  login:</span></span><br><span class=\"line\"><span class=\"attr\">    host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\"><span class=\"attr\">    paths:</span> <span class=\"string\">'/account/login'</span></span><br><span class=\"line\"><span class=\"attr\">  account:</span></span><br><span class=\"line\"><span class=\"attr\">    host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\"><span class=\"attr\">    paths:</span> <span class=\"string\">'/account/*'</span></span><br><span class=\"line\"><span class=\"attr\">  banner:</span></span><br><span class=\"line\"><span class=\"attr\">    host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\"><span class=\"attr\">    paths:</span> <span class=\"string\">'/banner/*'</span></span><br><span class=\"line\"><span class=\"attr\">serviceEndpoints:</span></span><br><span class=\"line\"><span class=\"attr\">  accountSrv:</span></span><br><span class=\"line\"><span class=\"attr\">    url:</span> <span class=\"string\">'http://localhost:3001'</span></span><br><span class=\"line\"><span class=\"attr\">  bannerSrv:</span></span><br><span class=\"line\"><span class=\"attr\">    url:</span> <span class=\"string\">'http://localhost:3002'</span></span><br><span class=\"line\"><span class=\"attr\">policies:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">jwt</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">proxy</span></span><br><span class=\"line\"><span class=\"attr\">pipelines:</span></span><br><span class=\"line\"><span class=\"attr\">  login:</span></span><br><span class=\"line\"><span class=\"attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">login</span></span><br><span class=\"line\"><span class=\"attr\">    policies:</span></span><br><span class=\"line\"><span class=\"attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceEndpoint:</span> <span class=\"string\">accountSrv</span> </span><br><span class=\"line\"><span class=\"attr\">  banner:</span></span><br><span class=\"line\"><span class=\"attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">banner</span></span><br><span class=\"line\"><span class=\"attr\">    policies:</span></span><br><span class=\"line\"><span class=\"attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceEndpoint:</span> <span class=\"string\">bannerSrv</span></span><br><span class=\"line\"><span class=\"attr\">  account:</span></span><br><span class=\"line\"><span class=\"attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">account</span></span><br><span class=\"line\"><span class=\"attr\">    policies:</span></span><br><span class=\"line\"><span class=\"attr\">      - jwt:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              jwtExtractor:</span> <span class=\"string\">'query'</span></span><br><span class=\"line\"><span class=\"attr\">              jwtExtractorField:</span> <span class=\"string\">'token'</span></span><br><span class=\"line\"><span class=\"attr\">              checkCredentialExistence:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">              secretOrPublicKeyFile:</span> <span class=\"string\">'../secret-files/public.pem'</span></span><br><span class=\"line\"><span class=\"attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceEndpoint:</span> <span class=\"string\">accountSrv</span></span><br></pre></td></tr></table></figure>\n<p><strong>3个apiEndpoints</strong></p>\n<ul>\n<li>login：访问path <em>/account/login</em></li>\n<li>account：访问path <em>/account/*</em></li>\n<li>banner：访问path <em>/banner/*</em></li>\n</ul>\n<p><strong>2个serviceEndpoints</strong></p>\n<ul>\n<li>accountSrv：对应<code>account</code>服务，本地端口3001</li>\n<li>bannerSrv：对应<code>banner</code>服务，本地端口3002</li>\n</ul>\n<p><strong>配置pipelines</strong></p>\n<ul>\n<li>login和banner这2个apiEndpoints被分别简单的路由到各自的微服务上</li>\n<li>account这个apiEndpoints除了路由外还有JWT策略，action告诉系统它将以URL query的token字段传递加密的认证信息</li>\n</ul>\n<p><strong>启动项目和访问它们</strong></p>\n<p>在各个目录下通过<code>npm start</code>分别启动它们，通过Postman GET请求<a href=\"http://localhost:8080/account/profile\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/account/profile</a> 发现返回401，可见没有通过token验证就会返回401，符合pipelines里account的配置；GET 请求<a href=\"http://localhost:8080/banner/\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/banner/</a> 会正常返回数据，它没有被JWT策略约束</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;code&quot;:200,&quot;message&quot;:&quot;success&quot;,&quot;data&quot;:[&quot;/images/1.png&quot;,&quot;/images/2.png&quot;]&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>获取token</strong></p>\n<p>POST <a href=\"http://localhost:8080/account/login\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/account/login</a> ,它在配置中也未加JWT策略，返回如下：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"code\"</span>: <span class=\"number\">200</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"message\"</span>: <span class=\"string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"token\"</span>: <span class=\"string\">\"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>将token以URL query形式传参，重新访问profile接口，就正常返回用户ID了</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"code\"</span>: <span class=\"number\">200</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"message\"</span>: <span class=\"string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"data\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"2020\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述就是一个简单的Gateway简单的例子，除开内置的一些策略（中间件）外，我们还可以自己开发一些中间件来满足具体需求——<strong><code>插件</code></strong>。</p>\n<p><br></p>\n<h2 id=\"插件\"><a href=\"#插件\" class=\"headerlink\" title=\"插件\"></a>插件</h2><p>插件分两种：</p>\n<ul>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/customization/conditions/\" target=\"_blank\" rel=\"noopener\">Conditions</a></p>\n</li>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/\" target=\"_blank\" rel=\"noopener\">Policies</a></p>\n</li>\n</ul>\n<p>无论是上述哪一个，写好后都要注册到网关中，在gateway项目中新建<code>plugins</code>目录，及其子目录<code>policies</code>、<code>conditions</code>， 和<code>manifest.js</code>、<code>policies/index.js</code>、<code>conditions/index.js</code>文件</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// manifest.js</span></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  version: <span class=\"string\">'0.0.1'</span>,</span><br><span class=\"line\">  init: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">pluginContext</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> policy = <span class=\"built_in\">require</span>(<span class=\"string\">'./policies/index.js'</span>);</span><br><span class=\"line\">    pluginContext.registerPolicy(policy);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> condition = <span class=\"built_in\">require</span>(<span class=\"string\">'./conditions/index.js'</span>);</span><br><span class=\"line\">    pluginContext.registerCondition(condition);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过registerPolicy和registerCondition将策略和条件注册到网关系统中，另外在<code>system.config.yml</code>配置文件中添加插件的配置路径</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">system.config.yml</span></span><br><span class=\"line\"><span class=\"attr\">plugins:</span></span><br><span class=\"line\"><span class=\"attr\">  example:</span></span><br><span class=\"line\"><span class=\"attr\">    package:</span> <span class=\"string\">'./plugins/manifest.js'</span></span><br></pre></td></tr></table></figure>\n<p><strong>Conditions 条件</strong></p>\n<p>它通过定义一个方法来判断是否执行或跳过一个策略</p>\n<blockquote>\n<h5 id=\"function-req-conditionConfig-gt-true-false-Handler\"><a href=\"#function-req-conditionConfig-gt-true-false-Handler\" class=\"headerlink\" title=\"function (req, conditionConfig) =&gt; true/false Handler\"></a><code>function (req, conditionConfig) =&gt; true/false</code> Handler</h5><ul>\n<li>Executes on each request in current pipeline. If not matched will prevent policy from being fired</li>\n</ul>\n</blockquote>\n<p>在上面的例子中，我们在apiEndpoints和pipelines都定义了一个login，其实它是accountSrv的一个特殊的存在，除了login其它的url地址都是受JWT策略约束的，按照之前的写法显得格外的冗余，我们可以通过一个Condition来做改进，重新改写gateway.config.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"comment\"># login:</span></span><br><span class=\"line\">  <span class=\"comment\">#   host: localhost</span></span><br><span class=\"line\">  <span class=\"comment\">#   paths: '/account/login'</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># ...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">pipelines:</span></span><br><span class=\"line\">  <span class=\"comment\"># login:</span></span><br><span class=\"line\">  <span class=\"comment\">#   apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"comment\">#     - login</span></span><br><span class=\"line\">  <span class=\"comment\">#   policies:</span></span><br><span class=\"line\">  <span class=\"comment\">#     - proxy:</span></span><br><span class=\"line\">  <span class=\"comment\">#         - action:</span></span><br><span class=\"line\">  <span class=\"comment\">#             serviceEndpoint: accountSrv </span></span><br><span class=\"line\"><span class=\"attr\">  account:</span></span><br><span class=\"line\"><span class=\"attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">account</span></span><br><span class=\"line\"><span class=\"attr\">    policies:</span></span><br><span class=\"line\"><span class=\"attr\">      - jwt:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> </span><br><span class=\"line\"><span class=\"attr\">            condition:</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">'white-list'</span></span><br><span class=\"line\"><span class=\"attr\">              list:</span> <span class=\"string\">['/account/login']</span></span><br><span class=\"line\"><span class=\"attr\">            action:</span></span><br><span class=\"line\"><span class=\"attr\">              jwtExtractor:</span> <span class=\"string\">'query'</span></span><br><span class=\"line\"><span class=\"attr\">              jwtExtractorField:</span> <span class=\"string\">'token'</span></span><br><span class=\"line\"><span class=\"attr\">              checkCredentialExistence:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">              secretOrPublicKeyFile:</span> <span class=\"string\">'../secret-files/public.pem'</span></span><br><span class=\"line\"><span class=\"attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceEndpoint:</span> <span class=\"string\">accountSrv</span></span><br></pre></td></tr></table></figure>\n<p>我们看到在jwt下面多了一个condition，然后在<code>conditions/index.js</code>里实现一个简单的URL Path 过滤</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  name: <span class=\"string\">'white-list'</span>,</span><br><span class=\"line\">  schema: &#123;</span><br><span class=\"line\">    $id: <span class=\"string\">'white-list'</span>,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  handler: <span class=\"function\"><span class=\"params\">conditionConfig</span> =&gt;</span> req =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> conditionConfig.list.indexOf(req.url) &lt; <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>这个Condition就完成了白名单功能了。</p>\n<p><strong>Policies 策略</strong></p>\n<p>它通过一个中间件方法对所有流入网关请求的预处理</p>\n<p>结合上面的banner接口，我们新开发了一个v2版本的banner列表接口<code>/banner/v2/list</code>，为了老版本的客户端依旧能通过<code>/banner</code>接口访问到新的v2版本，我们需要做一个URL替换</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">pipelines:</span></span><br><span class=\"line\"><span class=\"attr\">  banner:</span></span><br><span class=\"line\"><span class=\"attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">banner</span></span><br><span class=\"line\"><span class=\"attr\">    policies:</span></span><br><span class=\"line\"><span class=\"attr\">      - rewrite:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              search:</span> <span class=\"string\">'/banner'</span></span><br><span class=\"line\"><span class=\"attr\">              replace:</span> <span class=\"string\">'/banner/v1/list'</span></span><br><span class=\"line\"><span class=\"attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceEndpoint:</span> <span class=\"string\">bannerSrv</span></span><br></pre></td></tr></table></figure>\n<p>在<code>policies/index.js</code>添加替换方法</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  name: <span class=\"string\">'rewrite'</span>,</span><br><span class=\"line\">  schema: &#123;</span><br><span class=\"line\">    $id: <span class=\"string\">'rewrite'</span>,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  policy: <span class=\"function\">(<span class=\"params\">actionParams</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\">(<span class=\"params\">req, res, next</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      req.url = req.url.replace(actionParams.search, actionParams.replace);</span><br><span class=\"line\">      next()</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>当我们再GET <a href=\"http://localhost:8080/banner/\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/banner/</a> 时候，将返回新的v2版本的数据</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"code\"</span>: <span class=\"number\">200</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"message\"</span>: <span class=\"string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"data\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"/images/v2_1.png\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>至此，简单的URL地址替换就完成了。</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>上诉只是Express-Gateway的一角，还有很多有趣灵活的功能值得慢慢探索。BFF层最为整个大系统的前沿征地，而网关更是前沿的前沿，配合GraphQL我相信能不断释放出JavaScript快速开发和迭代的能力，为客户端提供更好的服务和需求响应。</p>"},{"title":"前端错误捕获提交错误日志","date":"2018-10-23T02:29:29.089Z","_content":"\n#### 为什么需要捕获？\n\n前端代码运行在客户端的浏览器里，当客户端（浏览器）出现任何问题，在没有错误日志的情况下，我们都是不知道问题发生在哪，我们只能依靠猜测或者自己不断尝试才知道，或者永远不知道问题。\n\n#### 客户端怎么捕获？\n\n1.通过window.onerror，可惜只能获得基础的js错误，Promise、async/await 里的错误无法捕获，它收到同源决策的影响\n\n2.Promise 通过__catch__方法\n\n3.async/await 通过 __try - catch__\n\n4.Vue可以通过全局Vue.config.errorHandler去获得非Promise、async/await里的错误，可以理解为Vue里的window.onerror\n\n<!-- more -->\n\n#### 不同的捕获错误用法（测试环境 chrome & https://jsbin.com）\n\n##### [window.onerror](https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror)\n\n```js\nwindow.onerror = function(message, source, lineno, colno, error) {\n    /*\n    message：错误信息（字符串）。可用于HTML onerror=\"\"处理程序中的event。\n    source：发生错误的脚本URL（字符串）\n    lineno：发生错误的行号（数字）\n    colno：发生错误的列号（数字）\n    error：Error对象（对象）\n    */\n}\n```\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nlet data\nlet info = data.info\n\n/* console 输出\n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 6,\n  3: 17,\n  4: [object Error] { ... }\n}\n*/\n```\n\n虽然__onerror__无法捕获Promise里的错误，但是如果Promise里面是被setTimeout包裹的js还是能捕获的\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction timer () {\n  setTimeout(function () {\n     let data\n     let info = data.info\n  }, 100)\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n     timer()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n  })\n}\n\np().then(function() {\n  console.log('running then')\n})\n.catch(function(error){\n  console.log(error)\n  console.log('outer error')\n})\n\n/* console 输出\n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 8,\n  3: 22,\n  4: [object Error] { ... }\n}\n*/\n```\n\n\n\n##### [Promise catch](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)\n\n##### Q：如果没有catch方法，是否能捕获Promise里的错误？\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n  console.log('onerror')\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log('running then')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console 没有任何输出\n*/\n```\n\n我们通过上面的代码发现，Promise里的错误无论在__try - catch__还是__onerror__里都无法被捕获\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log(res)\n    console.log('running then')\n  }).catch(function(error){\n    console.log(error)\n    console.log('outer error')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console 输出\n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n\"running then\"\n*/\n```\n\n通过上面代码发现，已经被捕获的错误代码，在外层不会再被捕获而是继续执行then里的方法，可见在一条Promise链上的错误，会被之后最近的__catch__捕获。\n\n##### [async/await](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function) 通过 __try - catch__\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  let res = await p()\n  console.log(res)\n})()\n\n/* console 没有任何输出\n*/\n```\n\n我们通过上面的代码发现，Promise构造函数里的错误并没有被__onerror__捕获\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    resolve('resolve')\n  })\n}\n(async function () {\n  let res = await p()\n  console.log('get res')\n  errorFn()\n})()\n\n/* console 输出\nget res\n*/\n```\n\n虽然Promise正常执行，但是当后续的代码出错__onerror__依旧没有被捕获\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console 输出\n[object Error] { ... }\n\"try - catch\"\n*/\n```\n\n__try - catch__捕获了\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console 输出\n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n*/\n```\n\n从上面代码我们知道，如果Promise构造函数里的错误被它自己catch的话，那么 async/await 后续的 __try - catch__将不再对它捕获\n\n##### [Vue.config.errorHandler](https://cn.vuejs.org/v2/api/index.html#errorHandler)\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  // handle error\n  // `info` 是 Vue 特定的错误信息，比如错误所在的生命周期钩子\n  // 只在 2.2.0+ 可用\n}\n```\n\n> 指定组件的渲染和观察期间未捕获错误的处理函数。这个处理函数被调用时，可获取错误信息和 Vue 实例。\n\n我们该如何去理解官方对errorHandler的解释呢？通过 vue-cli构建工具，创建一个非常基础的vue项目，做一些实验。\n\n测试代码库：https://github.com/miser/vue-capture-error\n\n在main.js\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  console.log(arguments)\n  console.log('vue errorHandler')\n}\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.normal()\n  },\n  methods: {\n    normal () {\n      let data\n      let info = data.info\n    }\n  }\n  // ...  \n}\n\n/* 刷新页面 console 输出\n0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal …\n1: VueComponent {_uid: 1, _isVue: true, $options: {…}, _renderProxy: Proxy, _self: VueComponent, …}\n2: \"created hook\n*/\n```\n\n从上面代码可以看出，errorHandler确实可以满足我们的需求，在一个统一的地方捕获代码的错误，但是真的如此吗？上文也提到errorHandler和window.onerror类似，那么当我们使用Promse或者async/await时会不会得愿以偿。\n\njs中的异步很大一部分来自网络请求，那么在这我们用 [axios](https://github.com/axios/axios) （它做了一层ajax与Promise之间的封装）。\n\nmain.js里添加\n\n```js\nconst request = axios.create()\nrequest.interceptors.response.use(response => {\n  return response\n})\n\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      reject(err)\n    })\n  })\n}\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch1()\n  },\n  methods: {\n    fetch1 () {\n        Vue.request('https://api1.github.com/')\n\t      .then(response => {\n            console.log(response)\n          })\n    }\n  }\n  // ...  \n}\n```\n\napi.github.com 会返回 github的api列表，当我们拼错域名，比如上面代码中的api1.github.com时，那肯定是无法获得我们想要的，可是errorHandler并没有获得该错误，不过幸好，我们可以在全局统一的Vue.request里的catch方法去统一捕获网络层面的错误。那如果是非网络层面的呢？比如数据请求回来了，但是绑定数据的时候，后端因为业务的修改等原因并没有返回我们需要的字段，造成Promise.then方法的业务处理错误。\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n      .then(response => {\n        let data = response.data\n        let info = data.api.info\n      })\n    }\n  }\n  // ...  \n}\n```\n\n上诉代码运行后，errorHandler同样未能捕获错误，从vue的issue里面去查询关于捕获Promise或者async/await时，会得到作者的答复:\n\n> https://github.com/vuejs/vue/issues/6551\n>\n> Vue cannot capture errors that are thrown asynchronously, similar to how try... catch won't catch async errors. It's your responsibility to handle async errors properly, e.g. using Promise.catch  — @yyx990803\n\n那么该怎么办，不可能每个地方都加Promise.catch方法吧！\n\n> https://github.com/vuejs/vue/issues/7653\n>\n> @Doeke 在这个地方给出一个解决方案，通过全局mixin，给那些Promise方法外面包一层Promise，在这个外层Promise链上catch里面的错误，不过这样需要做代码的约定，就是原来的方法需要返回一个Promise对象。\n\nmain.js里添加@Doeke的思路\n\n```js\nVue.mixin({\n  beforeCreate: function () {\n    const methods = this.$options.methods || {}\n    Object.entries(methods).forEach(([key, method]) => {\n      if (method._asyncWrapped) return\n      const wrappedMethod = function (...args) {\n        const result = method.apply(this, args)\n        const resultIsPromise = result && typeof result.then === 'function'\n        if (!resultIsPromise) return result\n\n        return new Promise(async (resolve, reject) => {\n          try {\n            resolve(await result)\n          } catch (error) {\n            if (!error._handled) {\n              const errorHandler = Vue.config.errorHandler\n              errorHandler(error)\n              error._handled = true\n            }\n            reject(error)\n          }\n        })\n      }\n      wrappedMethod._asyncWrapped = true\n      methods[key] = wrappedMethod\n    })\n  }\n})\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n    this.fetch3()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch2\n        })\n    },\n    fetch3 () {\n      return Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch3\n        })\n    }\n  }\n  // ...  \n}\n```\n\n通过运行并观察console打印可以看出，fetch3的错误被errorHandler捕获，而fetch2的错误并没有。\n\n那么Promise里的错误统一捕获的问题差不多应该解决了，那么async/await的呢？\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch4()\n    this.fetch5()\n  },\n  methods: {\n    async fetch4 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch4\n    },\n    async fetch5 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch5\n      return response\n    }\n  }\n  // ...  \n}\n```\n\nfetch4并没有返回Promise，fetch5返回的也不是Promise对象，但是当运行的时候我们会发现fetch4和fetch5的错误信息都被捕获了，这是为什么呢？因为async/await本身就是Promise的语法糖，在 [babeljs](https://babeljs.io) 官网的 “Try it out\" 尝试用 async/await，你会发现最后编译后的代码就是在外包了一层Promise。\n\n#### 在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\n\n__网络层__：可以在axios.create创建的实例中\n\n__逻辑层__：非Promise本身就会被errorHandler捕获；Promise相关的可以通过全局mixin给返回Promise对象的方法做一个外层包装，统一catch并调用errorHandler处理（__*这个方法的是否有副作用还需要研究!*__）\n\n#### 捕获的错误存放在哪？\n\n__# 自己简易服务 ？__\n\n感觉成本很大（人力和工时）\n\n__# 官方推荐的 [Sentry](https://sentry.io/)  __\n\n注册后安装官方的JS SDK\n\n```\nnpm install raven-js --save\n```\n\n修改main.js\n\n```js\n// ...\nimport Raven from 'raven-js'\nimport RavenVue from 'raven-js/plugins/vue'\n\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044') // sentry token\n  .addPlugin(RavenVue, Vue)\n  .install()\n\nVue.config.errorHandler = function (err, vm, info) {\n  Raven.captureException(err)\n}\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      Raven.captureException(err)\n      reject(err)\n    })\n  })\n}\n// ...\n```\n\n修改App.vue （我们从最普通的js测试起）\n```js\n// ...\ncreated () {\n    this.normal()\n    // this.fetch1()\n    // this.fetch2()\n    // this.fetch3()\n    // this.fetch4()\n    // this.fetch5()\n}\n// ...\n```\n\n打开sentry页面查看\n![错误报告列表](/images/js-capture-error/1.png)\n![错误报告详情（模糊了IP部分）](/images/js-capture-error/2.jpg)\n我们通过上面2张图片可以看出，sentry自带一个简单的issue管理功能，此外详情页面的错误栈已经方便我们知道问题出在哪里了。\n\n测试fetch1的ajax请求错误\n![成功截获api1.github.com这个错误域名](/images/js-capture-error/3.jpg)\n\n除了fetch2无法被捕获外（之前提过，它没有返回Promise对象），其它的都能被捕获。不过Promise和async/await的错误栈比较少。尤其是Promise.then里的错误，如下2张图的对比：\n\n![Promise.then里的错误](/images/js-capture-error/4.jpg)\n![async/await里的错误](/images/js-capture-error/5.jpg)\n\n除了默认的数据的收集外，还能收集一些其他数据，比如用户信息\n\n```js\nRaven.setUser({\n    name: 'miser name',\n    id: 'miser id'\n  })\n```\n![用户信息顺收集](/images/js-capture-error/6.jpg)\n\n__我们测试了代码未被压缩的情况，如果代码压缩了呢？__\n\n![通过npm run build 压缩代码打开首页，一脸懵逼](/images/js-capture-error/7.jpg)\n\n显然我们不能直观的获得错误定位，不过sentry提供[SourceMaps](https://github.com/google/closure-compiler/wiki/Source-Maps)存储服务，它能方便的debug被压缩的代码。\n\n我们可以通过[webpack-sentry-plugin](https://www.npmjs.com/package/webpack-sentry-plugin)工具将整个上传过程写进webpack里，因为我们的实验环境是vue3，所以我们创建一个vue.config.js文件\n\n```js\nconst SentryPlugin = require('webpack-sentry-plugin')\n\nmodule.exports = {\n  configureWebpack: {\n    plugins: [\n      new SentryPlugin({\n        organization: 'fe-org', // 组织名称 类似公司名吧（一个用户下可以有多个组织）\n        project: 'popcorn-vue', // 项目名称 （一个组织下可以有多个项目）\n        apiKey: '17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150',\n        release: '1.2.4-beta' // 发布后的代码和这个对应，可以找到这个sourcemaps\n      })\n    ]\n  }\n}\n\n```\n修改main.js\n```js\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044', {\n    release: '1.2.4-beta' // 新增\n  })\n  .addPlugin(RavenVue, Vue)\n  .install()\n```\n\n```\nnpm run build\n```\n\n查看sentry里popcorn-vue项目中的__版本__\n\n![1.2.4-beta是目前的，1.2.3-beta是以前版本](/images/js-capture-error/8.jpg)\n![点击 1.2.4-beta 进去，很容易找到刚刚上传的js和js.map文件](/images/js-capture-error/9.jpg)\n\n\n我们打开build完的index.html，虽然错误成功捕获但依旧和上图的一样，无法被SourceMaps解析，大概的原因是js和js.map的目录结构问题。\n\n这个issue https://github.com/getsentry/sentry-electron/issues/54 是一个很经典的例子，它犯了2个错误\n\n-- 仅仅传了js.map而没有传被压缩的js文件，它们应该一一对应的上传到服务器上\n-- js和js.map目录路径不匹配\n\n这2个原因都会导致无法正常解析被压缩的文件。\n\n那么不直接通过浏览器打开index.html（file:///******/vue-capture-error/dist/index.html），通过nginx去模拟正式环境。\n```\nbrew install nginx\nnginx\n```\n\n将build出的代码dist拷贝到nginx默认目录下 /usr/local/var/www/，打开浏览器http://localhost:8080\n\n回到sentry中查看新的错误记录\n\n![已经很详细的记录了出错的方法](/images/js-capture-error/10.jpg)\n\n","source":"_posts/js-capture-error.md","raw":"---\ntitle: 前端错误捕获提交错误日志\ncategory: JavaScript\ndate: 2018-10-23T10:29:29.089Z\n---\n\n#### 为什么需要捕获？\n\n前端代码运行在客户端的浏览器里，当客户端（浏览器）出现任何问题，在没有错误日志的情况下，我们都是不知道问题发生在哪，我们只能依靠猜测或者自己不断尝试才知道，或者永远不知道问题。\n\n#### 客户端怎么捕获？\n\n1.通过window.onerror，可惜只能获得基础的js错误，Promise、async/await 里的错误无法捕获，它收到同源决策的影响\n\n2.Promise 通过__catch__方法\n\n3.async/await 通过 __try - catch__\n\n4.Vue可以通过全局Vue.config.errorHandler去获得非Promise、async/await里的错误，可以理解为Vue里的window.onerror\n\n<!-- more -->\n\n#### 不同的捕获错误用法（测试环境 chrome & https://jsbin.com）\n\n##### [window.onerror](https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror)\n\n```js\nwindow.onerror = function(message, source, lineno, colno, error) {\n    /*\n    message：错误信息（字符串）。可用于HTML onerror=\"\"处理程序中的event。\n    source：发生错误的脚本URL（字符串）\n    lineno：发生错误的行号（数字）\n    colno：发生错误的列号（数字）\n    error：Error对象（对象）\n    */\n}\n```\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nlet data\nlet info = data.info\n\n/* console 输出\n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 6,\n  3: 17,\n  4: [object Error] { ... }\n}\n*/\n```\n\n虽然__onerror__无法捕获Promise里的错误，但是如果Promise里面是被setTimeout包裹的js还是能捕获的\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction timer () {\n  setTimeout(function () {\n     let data\n     let info = data.info\n  }, 100)\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n     timer()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n  })\n}\n\np().then(function() {\n  console.log('running then')\n})\n.catch(function(error){\n  console.log(error)\n  console.log('outer error')\n})\n\n/* console 输出\n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 8,\n  3: 22,\n  4: [object Error] { ... }\n}\n*/\n```\n\n\n\n##### [Promise catch](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)\n\n##### Q：如果没有catch方法，是否能捕获Promise里的错误？\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n  console.log('onerror')\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log('running then')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console 没有任何输出\n*/\n```\n\n我们通过上面的代码发现，Promise里的错误无论在__try - catch__还是__onerror__里都无法被捕获\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log(res)\n    console.log('running then')\n  }).catch(function(error){\n    console.log(error)\n    console.log('outer error')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console 输出\n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n\"running then\"\n*/\n```\n\n通过上面代码发现，已经被捕获的错误代码，在外层不会再被捕获而是继续执行then里的方法，可见在一条Promise链上的错误，会被之后最近的__catch__捕获。\n\n##### [async/await](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function) 通过 __try - catch__\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  let res = await p()\n  console.log(res)\n})()\n\n/* console 没有任何输出\n*/\n```\n\n我们通过上面的代码发现，Promise构造函数里的错误并没有被__onerror__捕获\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    resolve('resolve')\n  })\n}\n(async function () {\n  let res = await p()\n  console.log('get res')\n  errorFn()\n})()\n\n/* console 输出\nget res\n*/\n```\n\n虽然Promise正常执行，但是当后续的代码出错__onerror__依旧没有被捕获\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console 输出\n[object Error] { ... }\n\"try - catch\"\n*/\n```\n\n__try - catch__捕获了\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console 输出\n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n*/\n```\n\n从上面代码我们知道，如果Promise构造函数里的错误被它自己catch的话，那么 async/await 后续的 __try - catch__将不再对它捕获\n\n##### [Vue.config.errorHandler](https://cn.vuejs.org/v2/api/index.html#errorHandler)\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  // handle error\n  // `info` 是 Vue 特定的错误信息，比如错误所在的生命周期钩子\n  // 只在 2.2.0+ 可用\n}\n```\n\n> 指定组件的渲染和观察期间未捕获错误的处理函数。这个处理函数被调用时，可获取错误信息和 Vue 实例。\n\n我们该如何去理解官方对errorHandler的解释呢？通过 vue-cli构建工具，创建一个非常基础的vue项目，做一些实验。\n\n测试代码库：https://github.com/miser/vue-capture-error\n\n在main.js\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  console.log(arguments)\n  console.log('vue errorHandler')\n}\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.normal()\n  },\n  methods: {\n    normal () {\n      let data\n      let info = data.info\n    }\n  }\n  // ...  \n}\n\n/* 刷新页面 console 输出\n0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal …\n1: VueComponent {_uid: 1, _isVue: true, $options: {…}, _renderProxy: Proxy, _self: VueComponent, …}\n2: \"created hook\n*/\n```\n\n从上面代码可以看出，errorHandler确实可以满足我们的需求，在一个统一的地方捕获代码的错误，但是真的如此吗？上文也提到errorHandler和window.onerror类似，那么当我们使用Promse或者async/await时会不会得愿以偿。\n\njs中的异步很大一部分来自网络请求，那么在这我们用 [axios](https://github.com/axios/axios) （它做了一层ajax与Promise之间的封装）。\n\nmain.js里添加\n\n```js\nconst request = axios.create()\nrequest.interceptors.response.use(response => {\n  return response\n})\n\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      reject(err)\n    })\n  })\n}\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch1()\n  },\n  methods: {\n    fetch1 () {\n        Vue.request('https://api1.github.com/')\n\t      .then(response => {\n            console.log(response)\n          })\n    }\n  }\n  // ...  \n}\n```\n\napi.github.com 会返回 github的api列表，当我们拼错域名，比如上面代码中的api1.github.com时，那肯定是无法获得我们想要的，可是errorHandler并没有获得该错误，不过幸好，我们可以在全局统一的Vue.request里的catch方法去统一捕获网络层面的错误。那如果是非网络层面的呢？比如数据请求回来了，但是绑定数据的时候，后端因为业务的修改等原因并没有返回我们需要的字段，造成Promise.then方法的业务处理错误。\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n      .then(response => {\n        let data = response.data\n        let info = data.api.info\n      })\n    }\n  }\n  // ...  \n}\n```\n\n上诉代码运行后，errorHandler同样未能捕获错误，从vue的issue里面去查询关于捕获Promise或者async/await时，会得到作者的答复:\n\n> https://github.com/vuejs/vue/issues/6551\n>\n> Vue cannot capture errors that are thrown asynchronously, similar to how try... catch won't catch async errors. It's your responsibility to handle async errors properly, e.g. using Promise.catch  — @yyx990803\n\n那么该怎么办，不可能每个地方都加Promise.catch方法吧！\n\n> https://github.com/vuejs/vue/issues/7653\n>\n> @Doeke 在这个地方给出一个解决方案，通过全局mixin，给那些Promise方法外面包一层Promise，在这个外层Promise链上catch里面的错误，不过这样需要做代码的约定，就是原来的方法需要返回一个Promise对象。\n\nmain.js里添加@Doeke的思路\n\n```js\nVue.mixin({\n  beforeCreate: function () {\n    const methods = this.$options.methods || {}\n    Object.entries(methods).forEach(([key, method]) => {\n      if (method._asyncWrapped) return\n      const wrappedMethod = function (...args) {\n        const result = method.apply(this, args)\n        const resultIsPromise = result && typeof result.then === 'function'\n        if (!resultIsPromise) return result\n\n        return new Promise(async (resolve, reject) => {\n          try {\n            resolve(await result)\n          } catch (error) {\n            if (!error._handled) {\n              const errorHandler = Vue.config.errorHandler\n              errorHandler(error)\n              error._handled = true\n            }\n            reject(error)\n          }\n        })\n      }\n      wrappedMethod._asyncWrapped = true\n      methods[key] = wrappedMethod\n    })\n  }\n})\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n    this.fetch3()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch2\n        })\n    },\n    fetch3 () {\n      return Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch3\n        })\n    }\n  }\n  // ...  \n}\n```\n\n通过运行并观察console打印可以看出，fetch3的错误被errorHandler捕获，而fetch2的错误并没有。\n\n那么Promise里的错误统一捕获的问题差不多应该解决了，那么async/await的呢？\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch4()\n    this.fetch5()\n  },\n  methods: {\n    async fetch4 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch4\n    },\n    async fetch5 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch5\n      return response\n    }\n  }\n  // ...  \n}\n```\n\nfetch4并没有返回Promise，fetch5返回的也不是Promise对象，但是当运行的时候我们会发现fetch4和fetch5的错误信息都被捕获了，这是为什么呢？因为async/await本身就是Promise的语法糖，在 [babeljs](https://babeljs.io) 官网的 “Try it out\" 尝试用 async/await，你会发现最后编译后的代码就是在外包了一层Promise。\n\n#### 在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\n\n__网络层__：可以在axios.create创建的实例中\n\n__逻辑层__：非Promise本身就会被errorHandler捕获；Promise相关的可以通过全局mixin给返回Promise对象的方法做一个外层包装，统一catch并调用errorHandler处理（__*这个方法的是否有副作用还需要研究!*__）\n\n#### 捕获的错误存放在哪？\n\n__# 自己简易服务 ？__\n\n感觉成本很大（人力和工时）\n\n__# 官方推荐的 [Sentry](https://sentry.io/)  __\n\n注册后安装官方的JS SDK\n\n```\nnpm install raven-js --save\n```\n\n修改main.js\n\n```js\n// ...\nimport Raven from 'raven-js'\nimport RavenVue from 'raven-js/plugins/vue'\n\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044') // sentry token\n  .addPlugin(RavenVue, Vue)\n  .install()\n\nVue.config.errorHandler = function (err, vm, info) {\n  Raven.captureException(err)\n}\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      Raven.captureException(err)\n      reject(err)\n    })\n  })\n}\n// ...\n```\n\n修改App.vue （我们从最普通的js测试起）\n```js\n// ...\ncreated () {\n    this.normal()\n    // this.fetch1()\n    // this.fetch2()\n    // this.fetch3()\n    // this.fetch4()\n    // this.fetch5()\n}\n// ...\n```\n\n打开sentry页面查看\n![错误报告列表](/images/js-capture-error/1.png)\n![错误报告详情（模糊了IP部分）](/images/js-capture-error/2.jpg)\n我们通过上面2张图片可以看出，sentry自带一个简单的issue管理功能，此外详情页面的错误栈已经方便我们知道问题出在哪里了。\n\n测试fetch1的ajax请求错误\n![成功截获api1.github.com这个错误域名](/images/js-capture-error/3.jpg)\n\n除了fetch2无法被捕获外（之前提过，它没有返回Promise对象），其它的都能被捕获。不过Promise和async/await的错误栈比较少。尤其是Promise.then里的错误，如下2张图的对比：\n\n![Promise.then里的错误](/images/js-capture-error/4.jpg)\n![async/await里的错误](/images/js-capture-error/5.jpg)\n\n除了默认的数据的收集外，还能收集一些其他数据，比如用户信息\n\n```js\nRaven.setUser({\n    name: 'miser name',\n    id: 'miser id'\n  })\n```\n![用户信息顺收集](/images/js-capture-error/6.jpg)\n\n__我们测试了代码未被压缩的情况，如果代码压缩了呢？__\n\n![通过npm run build 压缩代码打开首页，一脸懵逼](/images/js-capture-error/7.jpg)\n\n显然我们不能直观的获得错误定位，不过sentry提供[SourceMaps](https://github.com/google/closure-compiler/wiki/Source-Maps)存储服务，它能方便的debug被压缩的代码。\n\n我们可以通过[webpack-sentry-plugin](https://www.npmjs.com/package/webpack-sentry-plugin)工具将整个上传过程写进webpack里，因为我们的实验环境是vue3，所以我们创建一个vue.config.js文件\n\n```js\nconst SentryPlugin = require('webpack-sentry-plugin')\n\nmodule.exports = {\n  configureWebpack: {\n    plugins: [\n      new SentryPlugin({\n        organization: 'fe-org', // 组织名称 类似公司名吧（一个用户下可以有多个组织）\n        project: 'popcorn-vue', // 项目名称 （一个组织下可以有多个项目）\n        apiKey: '17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150',\n        release: '1.2.4-beta' // 发布后的代码和这个对应，可以找到这个sourcemaps\n      })\n    ]\n  }\n}\n\n```\n修改main.js\n```js\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044', {\n    release: '1.2.4-beta' // 新增\n  })\n  .addPlugin(RavenVue, Vue)\n  .install()\n```\n\n```\nnpm run build\n```\n\n查看sentry里popcorn-vue项目中的__版本__\n\n![1.2.4-beta是目前的，1.2.3-beta是以前版本](/images/js-capture-error/8.jpg)\n![点击 1.2.4-beta 进去，很容易找到刚刚上传的js和js.map文件](/images/js-capture-error/9.jpg)\n\n\n我们打开build完的index.html，虽然错误成功捕获但依旧和上图的一样，无法被SourceMaps解析，大概的原因是js和js.map的目录结构问题。\n\n这个issue https://github.com/getsentry/sentry-electron/issues/54 是一个很经典的例子，它犯了2个错误\n\n-- 仅仅传了js.map而没有传被压缩的js文件，它们应该一一对应的上传到服务器上\n-- js和js.map目录路径不匹配\n\n这2个原因都会导致无法正常解析被压缩的文件。\n\n那么不直接通过浏览器打开index.html（file:///******/vue-capture-error/dist/index.html），通过nginx去模拟正式环境。\n```\nbrew install nginx\nnginx\n```\n\n将build出的代码dist拷贝到nginx默认目录下 /usr/local/var/www/，打开浏览器http://localhost:8080\n\n回到sentry中查看新的错误记录\n\n![已经很详细的记录了出错的方法](/images/js-capture-error/10.jpg)\n\n","slug":"js-capture-error","published":1,"updated":"2020-07-07T10:11:25.587Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs5q0006d12ims95wvqz","content":"<h4 id=\"为什么需要捕获？\"><a href=\"#为什么需要捕获？\" class=\"headerlink\" title=\"为什么需要捕获？\"></a>为什么需要捕获？</h4><p>前端代码运行在客户端的浏览器里，当客户端（浏览器）出现任何问题，在没有错误日志的情况下，我们都是不知道问题发生在哪，我们只能依靠猜测或者自己不断尝试才知道，或者永远不知道问题。</p>\n<h4 id=\"客户端怎么捕获？\"><a href=\"#客户端怎么捕获？\" class=\"headerlink\" title=\"客户端怎么捕获？\"></a>客户端怎么捕获？</h4><p>1.通过window.onerror，可惜只能获得基础的js错误，Promise、async/await 里的错误无法捕获，它收到同源决策的影响</p>\n<p>2.Promise 通过<strong>catch</strong>方法</p>\n<p>3.async/await 通过 <strong>try - catch</strong></p>\n<p>4.Vue可以通过全局Vue.config.errorHandler去获得非Promise、async/await里的错误，可以理解为Vue里的window.onerror</p>\n<a id=\"more\"></a>\n<h4 id=\"不同的捕获错误用法（测试环境-chrome-amp-https-jsbin-com）\"><a href=\"#不同的捕获错误用法（测试环境-chrome-amp-https-jsbin-com）\" class=\"headerlink\" title=\"不同的捕获错误用法（测试环境 chrome &amp; https://jsbin.com）\"></a>不同的捕获错误用法（测试环境 chrome &amp; <a href=\"https://jsbin.com）\" target=\"_blank\" rel=\"noopener\">https://jsbin.com）</a></h4><h5 id=\"window-onerror\"><a href=\"#window-onerror\" class=\"headerlink\" title=\"window.onerror\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror\" target=\"_blank\" rel=\"noopener\">window.onerror</a></h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">message, source, lineno, colno, error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">/*</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    message：错误信息（字符串）。可用于HTML onerror=\"\"处理程序中的event。</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    source：发生错误的脚本URL（字符串）</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    lineno：发生错误的行号（数字）</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    colno：发生错误的列号（数字）</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    error：Error对象（对象）</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    */</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  2: 6,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  3: 17,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>虽然<strong>onerror</strong>无法捕获Promise里的错误，但是如果Promise里面是被setTimeout包裹的js还是能捕获的</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">timer</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">     <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">     <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">100</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">     timer()</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'inner error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">p().then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'running then'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">.catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">error</span>)</span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'outer error'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  2: 8,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  3: 22,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"Promise-catch\"><a href=\"#Promise-catch\" class=\"headerlink\" title=\"Promise catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch\" target=\"_blank\" rel=\"noopener\">Promise catch</a></h5><h5 id=\"Q：如果没有catch方法，是否能捕获Promise里的错误？\"><a href=\"#Q：如果没有catch方法，是否能捕获Promise里的错误？\" class=\"headerlink\" title=\"Q：如果没有catch方法，是否能捕获Promise里的错误？\"></a>Q：如果没有catch方法，是否能捕获Promise里的错误？</h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'onerror'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'running then'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 没有任何输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>我们通过上面的代码发现，Promise里的错误无论在<strong>try - catch</strong>还是<strong>onerror</strong>里都无法被捕获</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'running then'</span>)</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">error</span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'outer error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"running then\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>通过上面代码发现，已经被捕获的错误代码，在外层不会再被捕获而是继续执行then里的方法，可见在一条Promise链上的错误，会被之后最近的<strong>catch</strong>捕获。</p>\n<h5 id=\"async-await-通过-try-catch\"><a href=\"#async-await-通过-try-catch\" class=\"headerlink\" title=\"async/await 通过 try - catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function\" target=\"_blank\" rel=\"noopener\">async/await</a> 通过 <strong>try - catch</strong></h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 没有任何输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>我们通过上面的代码发现，Promise构造函数里的错误并没有被<strong>onerror</strong>捕获</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    resolve(<span class=\"hljs-string\">'resolve'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'get res'</span>)</span><br><span class=\"line\">  errorFn()</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">get res</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>虽然Promise正常执行，但是当后续的代码出错<strong>onerror</strong>依旧没有被捕获</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"try - catch\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><strong>try - catch</strong>捕获了</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>从上面代码我们知道，如果Promise构造函数里的错误被它自己catch的话，那么 async/await 后续的 <strong>try - catch</strong>将不再对它捕获</p>\n<h5 id=\"Vue-config-errorHandler\"><a href=\"#Vue-config-errorHandler\" class=\"headerlink\" title=\"Vue.config.errorHandler\"></a><a href=\"https://cn.vuejs.org/v2/api/index.html#errorHandler\" target=\"_blank\" rel=\"noopener\">Vue.config.errorHandler</a></h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// handle error</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// `info` 是 Vue 特定的错误信息，比如错误所在的生命周期钩子</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 只在 2.2.0+ 可用</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>指定组件的渲染和观察期间未捕获错误的处理函数。这个处理函数被调用时，可获取错误信息和 Vue 实例。</p>\n</blockquote>\n<p>我们该如何去理解官方对errorHandler的解释呢？通过 vue-cli构建工具，创建一个非常基础的vue项目，做一些实验。</p>\n<p>测试代码库：<a href=\"https://github.com/miser/vue-capture-error\" target=\"_blank\" rel=\"noopener\">https://github.com/miser/vue-capture-error</a></p>\n<p>在main.js</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'vue errorHandler'</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.normal()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    normal () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* 刷新页面 console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal …</span></span><br><span class=\"line\"><span class=\"hljs-comment\">1: VueComponent &#123;_uid: 1, _isVue: true, $options: &#123;…&#125;, _renderProxy: Proxy, _self: VueComponent, …&#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">2: \"created hook</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>从上面代码可以看出，errorHandler确实可以满足我们的需求，在一个统一的地方捕获代码的错误，但是真的如此吗？上文也提到errorHandler和window.onerror类似，那么当我们使用Promse或者async/await时会不会得愿以偿。</p>\n<p>js中的异步很大一部分来自网络请求，那么在这我们用 <a href=\"https://github.com/axios/axios\" target=\"_blank\" rel=\"noopener\">axios</a> （它做了一层ajax与Promise之间的封装）。</p>\n<p>main.js里添加</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> request = axios.create()</span><br><span class=\"line\">request.interceptors.response.use(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> response</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.request = <span class=\"hljs-function\">(<span class=\"hljs-params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"hljs-function\"><span class=\"hljs-params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch1()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch1 () &#123;</span><br><span class=\"line\">        Vue.request(<span class=\"hljs-string\">'https://api1.github.com/'</span>)</span><br><span class=\"line\">\t      .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"hljs-built_in\">console</span>.log(response)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>api.github.com 会返回 github的api列表，当我们拼错域名，比如上面代码中的api1.github.com时，那肯定是无法获得我们想要的，可是errorHandler并没有获得该错误，不过幸好，我们可以在全局统一的Vue.request里的catch方法去统一捕获网络层面的错误。那如果是非网络层面的呢？比如数据请求回来了，但是绑定数据的时候，后端因为业务的修改等原因并没有返回我们需要的字段，造成Promise.then方法的业务处理错误。</p>\n<p>在App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch2()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> info = data.api.info</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上诉代码运行后，errorHandler同样未能捕获错误，从vue的issue里面去查询关于捕获Promise或者async/await时，会得到作者的答复:</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/6551\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/6551</a></p>\n<p>Vue cannot capture errors that are thrown asynchronously, similar to how try… catch won’t catch async errors. It’s your responsibility to handle async errors properly, e.g. using Promise.catch  — @yyx990803</p>\n</blockquote>\n<p>那么该怎么办，不可能每个地方都加Promise.catch方法吧！</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/7653\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/7653</a></p>\n<p>@Doeke 在这个地方给出一个解决方案，通过全局mixin，给那些Promise方法外面包一层Promise，在这个外层Promise链上catch里面的错误，不过这样需要做代码的约定，就是原来的方法需要返回一个Promise对象。</p>\n</blockquote>\n<p>main.js里添加@Doeke的思路</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.mixin(&#123;</span><br><span class=\"line\">  beforeCreate: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> methods = <span class=\"hljs-keyword\">this</span>.$options.methods || &#123;&#125;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">Object</span>.entries(methods).forEach(<span class=\"hljs-function\">(<span class=\"hljs-params\">[key, method]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (method._asyncWrapped) <span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> wrappedMethod = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">...args</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> result = method.apply(<span class=\"hljs-keyword\">this</span>, args)</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> resultIsPromise = result &amp;&amp; <span class=\"hljs-keyword\">typeof</span> result.then === <span class=\"hljs-string\">'function'</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (!resultIsPromise) <span class=\"hljs-keyword\">return</span> result</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-keyword\">async</span> (resolve, reject) =&gt; &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">            resolve(<span class=\"hljs-keyword\">await</span> result)</span><br><span class=\"line\">          &#125; <span class=\"hljs-keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span> (!error._handled) &#123;</span><br><span class=\"line\">              <span class=\"hljs-keyword\">const</span> errorHandler = Vue.config.errorHandler</span><br><span class=\"line\">              errorHandler(error)</span><br><span class=\"line\">              error._handled = <span class=\"hljs-literal\">true</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            reject(error)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      wrappedMethod._asyncWrapped = <span class=\"hljs-literal\">true</span></span><br><span class=\"line\">      methods[key] = wrappedMethod</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch2()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch3()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> info = data.api.fetch2</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    fetch3 () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> info = data.api.fetch3</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过运行并观察console打印可以看出，fetch3的错误被errorHandler捕获，而fetch2的错误并没有。</p>\n<p>那么Promise里的错误统一捕获的问题差不多应该解决了，那么async/await的呢？</p>\n<p>在App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch4()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch5()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> fetch4 () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> response = <span class=\"hljs-keyword\">await</span> Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.api.fetch4</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> fetch5 () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> response = <span class=\"hljs-keyword\">await</span> Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.api.fetch5</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> response</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>fetch4并没有返回Promise，fetch5返回的也不是Promise对象，但是当运行的时候我们会发现fetch4和fetch5的错误信息都被捕获了，这是为什么呢？因为async/await本身就是Promise的语法糖，在 <a href=\"https://babeljs.io\" target=\"_blank\" rel=\"noopener\">babeljs</a> 官网的 “Try it out” 尝试用 async/await，你会发现最后编译后的代码就是在外包了一层Promise。</p>\n<h4 id=\"在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\"><a href=\"#在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\" class=\"headerlink\" title=\"在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\"></a>在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）</h4><p><strong>网络层</strong>：可以在axios.create创建的实例中</p>\n<p><strong>逻辑层</strong>：非Promise本身就会被errorHandler捕获；Promise相关的可以通过全局mixin给返回Promise对象的方法做一个外层包装，统一catch并调用errorHandler处理（<strong><em>这个方法的是否有副作用还需要研究!</em></strong>）</p>\n<h4 id=\"捕获的错误存放在哪？\"><a href=\"#捕获的错误存放在哪？\" class=\"headerlink\" title=\"捕获的错误存放在哪？\"></a>捕获的错误存放在哪？</h4><p><strong># 自己简易服务 ？</strong></p>\n<p>感觉成本很大（人力和工时）</p>\n<p><strong># 官方推荐的 <a href=\"https://sentry.io/\" target=\"_blank\" rel=\"noopener\">Sentry</a>  </strong></p>\n<p>注册后安装官方的JS SDK</p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install raven-js --save</span><br></pre></td></tr></table></figure>\n<p>修改main.js</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> Raven <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'raven-js'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> RavenVue <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'raven-js/plugins/vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"hljs-string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>) <span class=\"hljs-comment\">// sentry token</span></span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.errorHandler = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  Raven.captureException(err)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Vue.request = <span class=\"hljs-function\">(<span class=\"hljs-params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"hljs-function\"><span class=\"hljs-params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      Raven.captureException(err)</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<p>修改App.vue （我们从最普通的js测试起）<br><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.normal()</span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch1()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch2()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch3()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch4()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch5()</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></table></figure></p>\n<p>打开sentry页面查看<br><img src=\"/images/js-capture-error/1.png\" alt=\"错误报告列表\"><br><img src=\"/images/js-capture-error/2.jpg\" alt=\"错误报告详情（模糊了IP部分）\"><br>我们通过上面2张图片可以看出，sentry自带一个简单的issue管理功能，此外详情页面的错误栈已经方便我们知道问题出在哪里了。</p>\n<p>测试fetch1的ajax请求错误<br><img src=\"/images/js-capture-error/3.jpg\" alt=\"成功截获api1.github.com这个错误域名\"></p>\n<p>除了fetch2无法被捕获外（之前提过，它没有返回Promise对象），其它的都能被捕获。不过Promise和async/await的错误栈比较少。尤其是Promise.then里的错误，如下2张图的对比：</p>\n<p><img src=\"/images/js-capture-error/4.jpg\" alt=\"Promise.then里的错误\"><br><img src=\"/images/js-capture-error/5.jpg\" alt=\"async/await里的错误\"></p>\n<p>除了默认的数据的收集外，还能收集一些其他数据，比如用户信息</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven.setUser(&#123;</span><br><span class=\"line\">    name: <span class=\"hljs-string\">'miser name'</span>,</span><br><span class=\"line\">    id: <span class=\"hljs-string\">'miser id'</span></span><br><span class=\"line\">  &#125;)</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/js-capture-error/6.jpg\" alt=\"用户信息顺收集\"></p>\n<p><strong>我们测试了代码未被压缩的情况，如果代码压缩了呢？</strong></p>\n<p><img src=\"/images/js-capture-error/7.jpg\" alt=\"通过npm run build 压缩代码打开首页，一脸懵逼\"></p>\n<p>显然我们不能直观的获得错误定位，不过sentry提供<a href=\"https://github.com/google/closure-compiler/wiki/Source-Maps\" target=\"_blank\" rel=\"noopener\">SourceMaps</a>存储服务，它能方便的debug被压缩的代码。</p>\n<p>我们可以通过<a href=\"https://www.npmjs.com/package/webpack-sentry-plugin\" target=\"_blank\" rel=\"noopener\">webpack-sentry-plugin</a>工具将整个上传过程写进webpack里，因为我们的实验环境是vue3，所以我们创建一个vue.config.js文件</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> SentryPlugin = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'webpack-sentry-plugin'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  configureWebpack: &#123;</span><br><span class=\"line\">    plugins: [</span><br><span class=\"line\">      <span class=\"hljs-keyword\">new</span> SentryPlugin(&#123;</span><br><span class=\"line\">        organization: <span class=\"hljs-string\">'fe-org'</span>, <span class=\"hljs-comment\">// 组织名称 类似公司名吧（一个用户下可以有多个组织）</span></span><br><span class=\"line\">        project: <span class=\"hljs-string\">'popcorn-vue'</span>, <span class=\"hljs-comment\">// 项目名称 （一个组织下可以有多个项目）</span></span><br><span class=\"line\">        apiKey: <span class=\"hljs-string\">'17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150'</span>,</span><br><span class=\"line\">        release: <span class=\"hljs-string\">'1.2.4-beta'</span> <span class=\"hljs-comment\">// 发布后的代码和这个对应，可以找到这个sourcemaps</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修改main.js<br><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"hljs-string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>, &#123;</span><br><span class=\"line\">    release: <span class=\"hljs-string\">'1.2.4-beta'</span> <span class=\"hljs-comment\">// 新增</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run build</span><br></pre></td></tr></table></figure>\n<p>查看sentry里popcorn-vue项目中的<strong>版本</strong></p>\n<p><img src=\"/images/js-capture-error/8.jpg\" alt=\"1.2.4-beta是目前的，1.2.3-beta是以前版本\"><br><img src=\"/images/js-capture-error/9.jpg\" alt=\"点击 1.2.4-beta 进去，很容易找到刚刚上传的js和js.map文件\"></p>\n<p>我们打开build完的index.html，虽然错误成功捕获但依旧和上图的一样，无法被SourceMaps解析，大概的原因是js和js.map的目录结构问题。</p>\n<p>这个issue <a href=\"https://github.com/getsentry/sentry-electron/issues/54\" target=\"_blank\" rel=\"noopener\">https://github.com/getsentry/sentry-electron/issues/54</a> 是一个很经典的例子，它犯了2个错误</p>\n<p>– 仅仅传了js.map而没有传被压缩的js文件，它们应该一一对应的上传到服务器上<br>– js和js.map目录路径不匹配</p>\n<p>这2个原因都会导致无法正常解析被压缩的文件。</p>\n<p>那么不直接通过浏览器打开index.html（file:///<strong>**</strong>/vue-capture-error/dist/index.html），通过nginx去模拟正式环境。<br><figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install nginx</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure></p>\n<p>将build出的代码dist拷贝到nginx默认目录下 /usr/local/var/www/，打开浏览器<a href=\"http://localhost:8080\" target=\"_blank\" rel=\"noopener\">http://localhost:8080</a></p>\n<p>回到sentry中查看新的错误记录</p>\n<p><img src=\"/images/js-capture-error/10.jpg\" alt=\"已经很详细的记录了出错的方法\"></p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[],"excerpt":"<h4 id=\"为什么需要捕获？\"><a href=\"#为什么需要捕获？\" class=\"headerlink\" title=\"为什么需要捕获？\"></a>为什么需要捕获？</h4><p>前端代码运行在客户端的浏览器里，当客户端（浏览器）出现任何问题，在没有错误日志的情况下，我们都是不知道问题发生在哪，我们只能依靠猜测或者自己不断尝试才知道，或者永远不知道问题。</p>\n<h4 id=\"客户端怎么捕获？\"><a href=\"#客户端怎么捕获？\" class=\"headerlink\" title=\"客户端怎么捕获？\"></a>客户端怎么捕获？</h4><p>1.通过window.onerror，可惜只能获得基础的js错误，Promise、async/await 里的错误无法捕获，它收到同源决策的影响</p>\n<p>2.Promise 通过<strong>catch</strong>方法</p>\n<p>3.async/await 通过 <strong>try - catch</strong></p>\n<p>4.Vue可以通过全局Vue.config.errorHandler去获得非Promise、async/await里的错误，可以理解为Vue里的window.onerror</p>","more":"<h4 id=\"不同的捕获错误用法（测试环境-chrome-amp-https-jsbin-com）\"><a href=\"#不同的捕获错误用法（测试环境-chrome-amp-https-jsbin-com）\" class=\"headerlink\" title=\"不同的捕获错误用法（测试环境 chrome &amp; https://jsbin.com）\"></a>不同的捕获错误用法（测试环境 chrome &amp; <a href=\"https://jsbin.com）\" target=\"_blank\" rel=\"noopener\">https://jsbin.com）</a></h4><h5 id=\"window-onerror\"><a href=\"#window-onerror\" class=\"headerlink\" title=\"window.onerror\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror\" target=\"_blank\" rel=\"noopener\">window.onerror</a></h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">message, source, lineno, colno, error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    message：错误信息（字符串）。可用于HTML onerror=\"\"处理程序中的event。</span></span><br><span class=\"line\"><span class=\"comment\">    source：发生错误的脚本URL（字符串）</span></span><br><span class=\"line\"><span class=\"comment\">    lineno：发生错误的行号（数字）</span></span><br><span class=\"line\"><span class=\"comment\">    colno：发生错误的列号（数字）</span></span><br><span class=\"line\"><span class=\"comment\">    error：Error对象（对象）</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> data</span><br><span class=\"line\"><span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"comment\">  2: 6,</span></span><br><span class=\"line\"><span class=\"comment\">  3: 17,</span></span><br><span class=\"line\"><span class=\"comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>虽然<strong>onerror</strong>无法捕获Promise里的错误，但是如果Promise里面是被setTimeout包裹的js还是能捕获的</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">timer</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">     <span class=\"keyword\">let</span> data</span><br><span class=\"line\">     <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">  &#125;, <span class=\"number\">100</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">     timer()</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'inner error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">p().then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'running then'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">.catch(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">error</span>)</span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'outer error'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"comment\">  2: 8,</span></span><br><span class=\"line\"><span class=\"comment\">  3: 22,</span></span><br><span class=\"line\"><span class=\"comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"Promise-catch\"><a href=\"#Promise-catch\" class=\"headerlink\" title=\"Promise catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch\" target=\"_blank\" rel=\"noopener\">Promise catch</a></h5><h5 id=\"Q：如果没有catch方法，是否能捕获Promise里的错误？\"><a href=\"#Q：如果没有catch方法，是否能捕获Promise里的错误？\" class=\"headerlink\" title=\"Q：如果没有catch方法，是否能捕获Promise里的错误？\"></a>Q：如果没有catch方法，是否能捕获Promise里的错误？</h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'onerror'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'running then'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 没有任何输出</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>我们通过上面的代码发现，Promise里的错误无论在<strong>try - catch</strong>还是<strong>onerror</strong>里都无法被捕获</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'running then'</span>)</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">error</span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'outer error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">\"running then\"</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>通过上面代码发现，已经被捕获的错误代码，在外层不会再被捕获而是继续执行then里的方法，可见在一条Promise链上的错误，会被之后最近的<strong>catch</strong>捕获。</p>\n<h5 id=\"async-await-通过-try-catch\"><a href=\"#async-await-通过-try-catch\" class=\"headerlink\" title=\"async/await 通过 try - catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function\" target=\"_blank\" rel=\"noopener\">async/await</a> 通过 <strong>try - catch</strong></h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 没有任何输出</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>我们通过上面的代码发现，Promise构造函数里的错误并没有被<strong>onerror</strong>捕获</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    resolve(<span class=\"string\">'resolve'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'get res'</span>)</span><br><span class=\"line\">  errorFn()</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">get res</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>虽然Promise正常执行，但是当后续的代码出错<strong>onerror</strong>依旧没有被捕获</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">\"try - catch\"</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><strong>try - catch</strong>捕获了</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>从上面代码我们知道，如果Promise构造函数里的错误被它自己catch的话，那么 async/await 后续的 <strong>try - catch</strong>将不再对它捕获</p>\n<h5 id=\"Vue-config-errorHandler\"><a href=\"#Vue-config-errorHandler\" class=\"headerlink\" title=\"Vue.config.errorHandler\"></a><a href=\"https://cn.vuejs.org/v2/api/index.html#errorHandler\" target=\"_blank\" rel=\"noopener\">Vue.config.errorHandler</a></h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// handle error</span></span><br><span class=\"line\">  <span class=\"comment\">// `info` 是 Vue 特定的错误信息，比如错误所在的生命周期钩子</span></span><br><span class=\"line\">  <span class=\"comment\">// 只在 2.2.0+ 可用</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>指定组件的渲染和观察期间未捕获错误的处理函数。这个处理函数被调用时，可获取错误信息和 Vue 实例。</p>\n</blockquote>\n<p>我们该如何去理解官方对errorHandler的解释呢？通过 vue-cli构建工具，创建一个非常基础的vue项目，做一些实验。</p>\n<p>测试代码库：<a href=\"https://github.com/miser/vue-capture-error\" target=\"_blank\" rel=\"noopener\">https://github.com/miser/vue-capture-error</a></p>\n<p>在main.js</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'vue errorHandler'</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.normal()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    normal () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* 刷新页面 console 输出</span></span><br><span class=\"line\"><span class=\"comment\">0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal …</span></span><br><span class=\"line\"><span class=\"comment\">1: VueComponent &#123;_uid: 1, _isVue: true, $options: &#123;…&#125;, _renderProxy: Proxy, _self: VueComponent, …&#125;</span></span><br><span class=\"line\"><span class=\"comment\">2: \"created hook</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>从上面代码可以看出，errorHandler确实可以满足我们的需求，在一个统一的地方捕获代码的错误，但是真的如此吗？上文也提到errorHandler和window.onerror类似，那么当我们使用Promse或者async/await时会不会得愿以偿。</p>\n<p>js中的异步很大一部分来自网络请求，那么在这我们用 <a href=\"https://github.com/axios/axios\" target=\"_blank\" rel=\"noopener\">axios</a> （它做了一层ajax与Promise之间的封装）。</p>\n<p>main.js里添加</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> request = axios.create()</span><br><span class=\"line\">request.interceptors.response.use(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> response</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.request = <span class=\"function\">(<span class=\"params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch1()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch1 () &#123;</span><br><span class=\"line\">        Vue.request(<span class=\"string\">'https://api1.github.com/'</span>)</span><br><span class=\"line\">\t      .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(response)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>api.github.com 会返回 github的api列表，当我们拼错域名，比如上面代码中的api1.github.com时，那肯定是无法获得我们想要的，可是errorHandler并没有获得该错误，不过幸好，我们可以在全局统一的Vue.request里的catch方法去统一捕获网络层面的错误。那如果是非网络层面的呢？比如数据请求回来了，但是绑定数据的时候，后端因为业务的修改等原因并没有返回我们需要的字段，造成Promise.then方法的业务处理错误。</p>\n<p>在App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch2()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">        <span class=\"keyword\">let</span> info = data.api.info</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上诉代码运行后，errorHandler同样未能捕获错误，从vue的issue里面去查询关于捕获Promise或者async/await时，会得到作者的答复:</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/6551\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/6551</a></p>\n<p>Vue cannot capture errors that are thrown asynchronously, similar to how try… catch won’t catch async errors. It’s your responsibility to handle async errors properly, e.g. using Promise.catch  — @yyx990803</p>\n</blockquote>\n<p>那么该怎么办，不可能每个地方都加Promise.catch方法吧！</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/7653\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/7653</a></p>\n<p>@Doeke 在这个地方给出一个解决方案，通过全局mixin，给那些Promise方法外面包一层Promise，在这个外层Promise链上catch里面的错误，不过这样需要做代码的约定，就是原来的方法需要返回一个Promise对象。</p>\n</blockquote>\n<p>main.js里添加@Doeke的思路</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.mixin(&#123;</span><br><span class=\"line\">  beforeCreate: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> methods = <span class=\"keyword\">this</span>.$options.methods || &#123;&#125;</span><br><span class=\"line\">    <span class=\"built_in\">Object</span>.entries(methods).forEach(<span class=\"function\">(<span class=\"params\">[key, method]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (method._asyncWrapped) <span class=\"keyword\">return</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> wrappedMethod = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> result = method.apply(<span class=\"keyword\">this</span>, args)</span><br><span class=\"line\">        <span class=\"keyword\">const</span> resultIsPromise = result &amp;&amp; <span class=\"keyword\">typeof</span> result.then === <span class=\"string\">'function'</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!resultIsPromise) <span class=\"keyword\">return</span> result</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"keyword\">async</span> (resolve, reject) =&gt; &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            resolve(<span class=\"keyword\">await</span> result)</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!error._handled) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">const</span> errorHandler = Vue.config.errorHandler</span><br><span class=\"line\">              errorHandler(error)</span><br><span class=\"line\">              error._handled = <span class=\"literal\">true</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            reject(error)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      wrappedMethod._asyncWrapped = <span class=\"literal\">true</span></span><br><span class=\"line\">      methods[key] = wrappedMethod</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch2()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch3()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"keyword\">let</span> info = data.api.fetch2</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    fetch3 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"keyword\">let</span> info = data.api.fetch3</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过运行并观察console打印可以看出，fetch3的错误被errorHandler捕获，而fetch2的错误并没有。</p>\n<p>那么Promise里的错误统一捕获的问题差不多应该解决了，那么async/await的呢？</p>\n<p>在App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch4()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch5()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    <span class=\"keyword\">async</span> fetch4 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> response = <span class=\"keyword\">await</span> Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.api.fetch4</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"keyword\">async</span> fetch5 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> response = <span class=\"keyword\">await</span> Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.api.fetch5</span><br><span class=\"line\">      <span class=\"keyword\">return</span> response</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>fetch4并没有返回Promise，fetch5返回的也不是Promise对象，但是当运行的时候我们会发现fetch4和fetch5的错误信息都被捕获了，这是为什么呢？因为async/await本身就是Promise的语法糖，在 <a href=\"https://babeljs.io\" target=\"_blank\" rel=\"noopener\">babeljs</a> 官网的 “Try it out” 尝试用 async/await，你会发现最后编译后的代码就是在外包了一层Promise。</p>\n<h4 id=\"在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\"><a href=\"#在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\" class=\"headerlink\" title=\"在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\"></a>在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）</h4><p><strong>网络层</strong>：可以在axios.create创建的实例中</p>\n<p><strong>逻辑层</strong>：非Promise本身就会被errorHandler捕获；Promise相关的可以通过全局mixin给返回Promise对象的方法做一个外层包装，统一catch并调用errorHandler处理（<strong><em>这个方法的是否有副作用还需要研究!</em></strong>）</p>\n<h4 id=\"捕获的错误存放在哪？\"><a href=\"#捕获的错误存放在哪？\" class=\"headerlink\" title=\"捕获的错误存放在哪？\"></a>捕获的错误存放在哪？</h4><p><strong># 自己简易服务 ？</strong></p>\n<p>感觉成本很大（人力和工时）</p>\n<p><strong># 官方推荐的 <a href=\"https://sentry.io/\" target=\"_blank\" rel=\"noopener\">Sentry</a>  </strong></p>\n<p>注册后安装官方的JS SDK</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install raven-js --save</span><br></pre></td></tr></table></figure>\n<p>修改main.js</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> Raven <span class=\"keyword\">from</span> <span class=\"string\">'raven-js'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> RavenVue <span class=\"keyword\">from</span> <span class=\"string\">'raven-js/plugins/vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>) <span class=\"comment\">// sentry token</span></span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.errorHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  Raven.captureException(err)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Vue.request = <span class=\"function\">(<span class=\"params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      Raven.captureException(err)</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<p>修改App.vue （我们从最普通的js测试起）<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.normal()</span><br><span class=\"line\">    <span class=\"comment\">// this.fetch1()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch2()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch3()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch4()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch5()</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure></p>\n<p>打开sentry页面查看<br><img src=\"/images/js-capture-error/1.png\" alt=\"错误报告列表\"><br><img src=\"/images/js-capture-error/2.jpg\" alt=\"错误报告详情（模糊了IP部分）\"><br>我们通过上面2张图片可以看出，sentry自带一个简单的issue管理功能，此外详情页面的错误栈已经方便我们知道问题出在哪里了。</p>\n<p>测试fetch1的ajax请求错误<br><img src=\"/images/js-capture-error/3.jpg\" alt=\"成功截获api1.github.com这个错误域名\"></p>\n<p>除了fetch2无法被捕获外（之前提过，它没有返回Promise对象），其它的都能被捕获。不过Promise和async/await的错误栈比较少。尤其是Promise.then里的错误，如下2张图的对比：</p>\n<p><img src=\"/images/js-capture-error/4.jpg\" alt=\"Promise.then里的错误\"><br><img src=\"/images/js-capture-error/5.jpg\" alt=\"async/await里的错误\"></p>\n<p>除了默认的数据的收集外，还能收集一些其他数据，比如用户信息</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven.setUser(&#123;</span><br><span class=\"line\">    name: <span class=\"string\">'miser name'</span>,</span><br><span class=\"line\">    id: <span class=\"string\">'miser id'</span></span><br><span class=\"line\">  &#125;)</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/js-capture-error/6.jpg\" alt=\"用户信息顺收集\"></p>\n<p><strong>我们测试了代码未被压缩的情况，如果代码压缩了呢？</strong></p>\n<p><img src=\"/images/js-capture-error/7.jpg\" alt=\"通过npm run build 压缩代码打开首页，一脸懵逼\"></p>\n<p>显然我们不能直观的获得错误定位，不过sentry提供<a href=\"https://github.com/google/closure-compiler/wiki/Source-Maps\" target=\"_blank\" rel=\"noopener\">SourceMaps</a>存储服务，它能方便的debug被压缩的代码。</p>\n<p>我们可以通过<a href=\"https://www.npmjs.com/package/webpack-sentry-plugin\" target=\"_blank\" rel=\"noopener\">webpack-sentry-plugin</a>工具将整个上传过程写进webpack里，因为我们的实验环境是vue3，所以我们创建一个vue.config.js文件</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> SentryPlugin = <span class=\"built_in\">require</span>(<span class=\"string\">'webpack-sentry-plugin'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  configureWebpack: &#123;</span><br><span class=\"line\">    plugins: [</span><br><span class=\"line\">      <span class=\"keyword\">new</span> SentryPlugin(&#123;</span><br><span class=\"line\">        organization: <span class=\"string\">'fe-org'</span>, <span class=\"comment\">// 组织名称 类似公司名吧（一个用户下可以有多个组织）</span></span><br><span class=\"line\">        project: <span class=\"string\">'popcorn-vue'</span>, <span class=\"comment\">// 项目名称 （一个组织下可以有多个项目）</span></span><br><span class=\"line\">        apiKey: <span class=\"string\">'17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150'</span>,</span><br><span class=\"line\">        release: <span class=\"string\">'1.2.4-beta'</span> <span class=\"comment\">// 发布后的代码和这个对应，可以找到这个sourcemaps</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修改main.js<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>, &#123;</span><br><span class=\"line\">    release: <span class=\"string\">'1.2.4-beta'</span> <span class=\"comment\">// 新增</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run build</span><br></pre></td></tr></table></figure>\n<p>查看sentry里popcorn-vue项目中的<strong>版本</strong></p>\n<p><img src=\"/images/js-capture-error/8.jpg\" alt=\"1.2.4-beta是目前的，1.2.3-beta是以前版本\"><br><img src=\"/images/js-capture-error/9.jpg\" alt=\"点击 1.2.4-beta 进去，很容易找到刚刚上传的js和js.map文件\"></p>\n<p>我们打开build完的index.html，虽然错误成功捕获但依旧和上图的一样，无法被SourceMaps解析，大概的原因是js和js.map的目录结构问题。</p>\n<p>这个issue <a href=\"https://github.com/getsentry/sentry-electron/issues/54\" target=\"_blank\" rel=\"noopener\">https://github.com/getsentry/sentry-electron/issues/54</a> 是一个很经典的例子，它犯了2个错误</p>\n<p>– 仅仅传了js.map而没有传被压缩的js文件，它们应该一一对应的上传到服务器上<br>– js和js.map目录路径不匹配</p>\n<p>这2个原因都会导致无法正常解析被压缩的文件。</p>\n<p>那么不直接通过浏览器打开index.html（file:///<strong>**</strong>/vue-capture-error/dist/index.html），通过nginx去模拟正式环境。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install nginx</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure></p>\n<p>将build出的代码dist拷贝到nginx默认目录下 /usr/local/var/www/，打开浏览器<a href=\"http://localhost:8080\" target=\"_blank\" rel=\"noopener\">http://localhost:8080</a></p>\n<p>回到sentry中查看新的错误记录</p>\n<p><img src=\"/images/js-capture-error/10.jpg\" alt=\"已经很详细的记录了出错的方法\"></p>"},{"title":"CSS、JS文件对网页的影响","date":"2018-09-23T22:45:00.000Z","_content":"\n我们常说浏览器是单线程的，那么我们在加载资源的时候页面是在等待加载完成呢？还是继续执行后续的操作？加载不同资源对浏览器的操作会有相同响应吗？我们可以通过一个一个简单的实验测试来了解。\n\n<!-- more -->\n\n## 环境\n\n*所有资源均在localhost，浏览器chrome 69，不同浏览器或版本会有少许不同*\n\n-- css\n  - css1.css 2秒后返回 body { background-color: #444 }\n  - css2.css 立即返回 body { font-size: 50px;font-weight: bold; }\n\n-- js\n  - js1.js 1秒后返回 console.log(\"js1.js loaded\") \n  - js2.js 立即返回 console.log(\"js2.js loaded\")\n  - js3.js 3秒后返回 console.log(\"js2.js loaded\")\n\n-- image\n  - img1.png 3秒后 返回一张黄色js图片\n  - img2.png 立即返回一张 nodejs图片\n\n\n服务器端代码：\n\n```js\nconst Koa = require('koa')\nconst Router = require('koa-router')\nconst views = require('koa-views')\nconst fs = require('fs')\n\nconst app = new Koa()\nconst router = new Router()\n\napp.use(views(__dirname + '/views'))\n\nrouter.get('/', async (ctx, next) => {\n  await ctx.render('index.html')\n})\n\nrouter.get('/css1.css', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'text/css')\n    ctx.body = 'body { background-color: #444 }'\n    resolve()\n  }, 1000 * 2)\n}))\n\nrouter.get('/css2.css', async ctx => {\n  ctx.set('Content-Type', 'text/css')\n  ctx.body = 'body { font-size: 50px;font-weight: bold; }'\n})\n\nrouter.get('/js1.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js1.js loaded\")'\n    resolve()\n  }, 1000)\n}))\n\nrouter.get('/js2.js', async ctx => {\n  ctx.body = 'console.log(\"js2.js loaded\")'\n})\n\nrouter.get('/js3.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js3.js loaded\")'\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img1.png', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'image/png; charset=UTF-8')\n    ctx.body = fs.createReadStream('1.png')\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img2.png', async ctx => {\n  ctx.set('Content-Type', 'image/png; charset=UTF-8')\n  ctx.body = fs.createReadStream('2.png')\n})\n\napp\n  .use(router.routes())\n  .use(router.allowedMethods())\n\napp.listen(3000)\n```\n\n## 实验一： CSS加载是否影响DOM解析\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\napp元素对象\ntest: 1947.620849609375ms\n-->\n```\n\n从控制台的输出可以看到 app 元素会被正确输出，2秒左右再输出 test 的时间，可见__CSS加载并不会阻碍DOM解析__。\n\n## 实验二： CSS加载是否影响JS执行和DOM渲染\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\njs1.js loaded\njs2.js loaded\n(index):17 test: 1921.02099609375ms\n-->\n```\n\n当打开index.html页面后，会发现所有资源均同时发起了请求，页面会先处于白屏加载状态（DOM无法渲染），当2秒（左右）后页面除img1.png未渲染外，其它样式和图片均渲染。\n\n从控制台的输出可以看出，虽然js比css快1秒左右加载完毕，但是此刻是处于阻塞状态并没有执行，当css加载完成后，才从上至下的执行（虽然js2.js比js1.js早加载好，但是执行的时候还是从上至下的），当css1.css加载完成后，页面立即渲染，图片img1.png晚1秒左右显示。可见__CSS加载会阻碍JS执行和DOM的渲染__。\n\n## 实验三： JS加载是否影响DOM解析和渲染\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\nnull\njs3.js loaded\ntest: 2943.9951171875ms\n-->\n```\n\n我们仅引入一个js3.js文件，设置它的返回时间为3秒，从控制台的输出可以看到 app 元素没有被正确输出（输出null），3秒左右再输出 test 的时间，可见__JS加载会阻碍DOM解析，既然解析都被影响自然必定影响渲染了__。\n\n## 实验四： DOM的DOMContentLoaded和onLoad事件\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n    console.time('testDOMContentLoaded')\n    console.time('testonload')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n    window.onload = function () {\n      console.timeEnd('testonload')\n    }\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n\t<script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\njs1.js loaded\njs2.js loaded\ntest: 1955.489990234375ms\ntestDOMContentLoaded: 1956.044189453125ms\ntestonload: 2964.078857421875ms\n-->\n```\n\n我们通过控制台会发现 testDOMContentLoaded 会在2秒左右打印出来，testonload会在3秒左右打印出来，由此可知__DOMContentLoaded是js和css文件的加载后触发，onload是整个页面所有资源加载完后触发（比如图片等）__。\n\n## 实验五： script async 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script async type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3个js文件都加上\"async\",会发现输出顺序是\n- testDOMContentLoaded 会立即打印出来\n- app元素对象\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\n之后我们将js1.js上的\"async\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- testDOMContentLoaded 1秒左右时间\n- js2.js loaded\n- js3.js loaded\n\n之后我们将js3.js上的\"async\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n可见__async会打乱js的执行顺序，有async的js文件哪个先加载完哪个先执行，DOMContentLoaded的触发时间不在和async有关系，不会影响页面的渲染和解析__\n\n## 实验六： script defer 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n\n```\n\n3个js文件都加上\"defer\",会发现输出顺序是\n\n- app元素对象\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n这和没有加defer和async时一样\n\n之后我们将js1.js上的\"defer\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n这和没有加defer和async时一样\n\n之后我们将js3.js上的\"defer\"移除，会发现输出顺序是\n- js1.js loaded\n- js3.js loaded\n- js2.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n可见__defer会打乱js的执行顺序，有defer的js文件会晚于没有的，但是它们（含有defer）依旧保持从上而下依次执行，DOMContentLoaded的触发时间晚于defer，不会影响页面的渲染和解析__\n\n## 实验七： script defer & async 都加上 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script async defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3个js文件都加上\"async\",会发现输出顺序是\n- testDOMContentLoaded 会立即打印出来\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\nasync优先级比defer高\n\n## 实验八： 动态创建script\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\">\n    var head = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 3; i++) {\n      var script = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- testDOMContentLoaded 会立即打印出来\n- appEl 对象\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\n如果我们动态创建js1.js和js2.js，将js3.js依旧按照常规写法写在页面中的话\n\nindex.html\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"js3.js\"></script>\n  <script type=\"text/javascript\">\n    var head = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 2; i++) {\n      var script = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- appEl 为 null 立即打印出来\n- js3.js loaded \n- testDOMContentLoaded 3秒左右会立即打印出来\n- js2.js loaded\n- js1.js loaded\n\n可见__动态创建script基本是同时加载，哪个先加载完哪个先执行，但是他们都晚于DOMContentLoaded事件__\n\n\n## 总结\nCSS加载会阻塞DOM渲染和JS执行，但是不影响页DOM解析；JS加载会阻塞DOM解析和渲染，给script标签加上defer & async属性将不再影响DOM解析和渲染，async 是哪个先返回先执行按个，defer会晚于常规标签同时按照含有defer属性的script加载的顺序执行","source":"_posts/js-css-image-loading.md","raw":"---\ntitle: CSS、JS文件对网页的影响\ncategory: JavaScript\ndate: 2018-09-24T06:45:00.000Z\n---\n\n我们常说浏览器是单线程的，那么我们在加载资源的时候页面是在等待加载完成呢？还是继续执行后续的操作？加载不同资源对浏览器的操作会有相同响应吗？我们可以通过一个一个简单的实验测试来了解。\n\n<!-- more -->\n\n## 环境\n\n*所有资源均在localhost，浏览器chrome 69，不同浏览器或版本会有少许不同*\n\n-- css\n  - css1.css 2秒后返回 body { background-color: #444 }\n  - css2.css 立即返回 body { font-size: 50px;font-weight: bold; }\n\n-- js\n  - js1.js 1秒后返回 console.log(\"js1.js loaded\") \n  - js2.js 立即返回 console.log(\"js2.js loaded\")\n  - js3.js 3秒后返回 console.log(\"js2.js loaded\")\n\n-- image\n  - img1.png 3秒后 返回一张黄色js图片\n  - img2.png 立即返回一张 nodejs图片\n\n\n服务器端代码：\n\n```js\nconst Koa = require('koa')\nconst Router = require('koa-router')\nconst views = require('koa-views')\nconst fs = require('fs')\n\nconst app = new Koa()\nconst router = new Router()\n\napp.use(views(__dirname + '/views'))\n\nrouter.get('/', async (ctx, next) => {\n  await ctx.render('index.html')\n})\n\nrouter.get('/css1.css', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'text/css')\n    ctx.body = 'body { background-color: #444 }'\n    resolve()\n  }, 1000 * 2)\n}))\n\nrouter.get('/css2.css', async ctx => {\n  ctx.set('Content-Type', 'text/css')\n  ctx.body = 'body { font-size: 50px;font-weight: bold; }'\n})\n\nrouter.get('/js1.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js1.js loaded\")'\n    resolve()\n  }, 1000)\n}))\n\nrouter.get('/js2.js', async ctx => {\n  ctx.body = 'console.log(\"js2.js loaded\")'\n})\n\nrouter.get('/js3.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js3.js loaded\")'\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img1.png', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'image/png; charset=UTF-8')\n    ctx.body = fs.createReadStream('1.png')\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img2.png', async ctx => {\n  ctx.set('Content-Type', 'image/png; charset=UTF-8')\n  ctx.body = fs.createReadStream('2.png')\n})\n\napp\n  .use(router.routes())\n  .use(router.allowedMethods())\n\napp.listen(3000)\n```\n\n## 实验一： CSS加载是否影响DOM解析\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\napp元素对象\ntest: 1947.620849609375ms\n-->\n```\n\n从控制台的输出可以看到 app 元素会被正确输出，2秒左右再输出 test 的时间，可见__CSS加载并不会阻碍DOM解析__。\n\n## 实验二： CSS加载是否影响JS执行和DOM渲染\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\njs1.js loaded\njs2.js loaded\n(index):17 test: 1921.02099609375ms\n-->\n```\n\n当打开index.html页面后，会发现所有资源均同时发起了请求，页面会先处于白屏加载状态（DOM无法渲染），当2秒（左右）后页面除img1.png未渲染外，其它样式和图片均渲染。\n\n从控制台的输出可以看出，虽然js比css快1秒左右加载完毕，但是此刻是处于阻塞状态并没有执行，当css加载完成后，才从上至下的执行（虽然js2.js比js1.js早加载好，但是执行的时候还是从上至下的），当css1.css加载完成后，页面立即渲染，图片img1.png晚1秒左右显示。可见__CSS加载会阻碍JS执行和DOM的渲染__。\n\n## 实验三： JS加载是否影响DOM解析和渲染\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\nnull\njs3.js loaded\ntest: 2943.9951171875ms\n-->\n```\n\n我们仅引入一个js3.js文件，设置它的返回时间为3秒，从控制台的输出可以看到 app 元素没有被正确输出（输出null），3秒左右再输出 test 的时间，可见__JS加载会阻碍DOM解析，既然解析都被影响自然必定影响渲染了__。\n\n## 实验四： DOM的DOMContentLoaded和onLoad事件\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n    console.time('testDOMContentLoaded')\n    console.time('testonload')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n    window.onload = function () {\n      console.timeEnd('testonload')\n    }\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n\t<script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\njs1.js loaded\njs2.js loaded\ntest: 1955.489990234375ms\ntestDOMContentLoaded: 1956.044189453125ms\ntestonload: 2964.078857421875ms\n-->\n```\n\n我们通过控制台会发现 testDOMContentLoaded 会在2秒左右打印出来，testonload会在3秒左右打印出来，由此可知__DOMContentLoaded是js和css文件的加载后触发，onload是整个页面所有资源加载完后触发（比如图片等）__。\n\n## 实验五： script async 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script async type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3个js文件都加上\"async\",会发现输出顺序是\n- testDOMContentLoaded 会立即打印出来\n- app元素对象\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\n之后我们将js1.js上的\"async\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- testDOMContentLoaded 1秒左右时间\n- js2.js loaded\n- js3.js loaded\n\n之后我们将js3.js上的\"async\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n可见__async会打乱js的执行顺序，有async的js文件哪个先加载完哪个先执行，DOMContentLoaded的触发时间不在和async有关系，不会影响页面的渲染和解析__\n\n## 实验六： script defer 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n\n```\n\n3个js文件都加上\"defer\",会发现输出顺序是\n\n- app元素对象\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n这和没有加defer和async时一样\n\n之后我们将js1.js上的\"defer\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n这和没有加defer和async时一样\n\n之后我们将js3.js上的\"defer\"移除，会发现输出顺序是\n- js1.js loaded\n- js3.js loaded\n- js2.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n可见__defer会打乱js的执行顺序，有defer的js文件会晚于没有的，但是它们（含有defer）依旧保持从上而下依次执行，DOMContentLoaded的触发时间晚于defer，不会影响页面的渲染和解析__\n\n## 实验七： script defer & async 都加上 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script async defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3个js文件都加上\"async\",会发现输出顺序是\n- testDOMContentLoaded 会立即打印出来\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\nasync优先级比defer高\n\n## 实验八： 动态创建script\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\">\n    var head = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 3; i++) {\n      var script = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- testDOMContentLoaded 会立即打印出来\n- appEl 对象\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\n如果我们动态创建js1.js和js2.js，将js3.js依旧按照常规写法写在页面中的话\n\nindex.html\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"js3.js\"></script>\n  <script type=\"text/javascript\">\n    var head = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 2; i++) {\n      var script = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- appEl 为 null 立即打印出来\n- js3.js loaded \n- testDOMContentLoaded 3秒左右会立即打印出来\n- js2.js loaded\n- js1.js loaded\n\n可见__动态创建script基本是同时加载，哪个先加载完哪个先执行，但是他们都晚于DOMContentLoaded事件__\n\n\n## 总结\nCSS加载会阻塞DOM渲染和JS执行，但是不影响页DOM解析；JS加载会阻塞DOM解析和渲染，给script标签加上defer & async属性将不再影响DOM解析和渲染，async 是哪个先返回先执行按个，defer会晚于常规标签同时按照含有defer属性的script加载的顺序执行","slug":"js-css-image-loading","published":1,"updated":"2020-07-07T10:11:25.587Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs5t0009d12idrzu6e7l","content":"<p>我们常说浏览器是单线程的，那么我们在加载资源的时候页面是在等待加载完成呢？还是继续执行后续的操作？加载不同资源对浏览器的操作会有相同响应吗？我们可以通过一个一个简单的实验测试来了解。</p>\n<a id=\"more\"></a>\n<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p><em>所有资源均在localhost，浏览器chrome 69，不同浏览器或版本会有少许不同</em></p>\n<p>– css</p>\n<ul>\n<li>css1.css 2秒后返回 body { background-color: #444 }</li>\n<li>css2.css 立即返回 body { font-size: 50px;font-weight: bold; }</li>\n</ul>\n<p>– js</p>\n<ul>\n<li>js1.js 1秒后返回 console.log(“js1.js loaded”) </li>\n<li>js2.js 立即返回 console.log(“js2.js loaded”)</li>\n<li>js3.js 3秒后返回 console.log(“js2.js loaded”)</li>\n</ul>\n<p>– image</p>\n<ul>\n<li>img1.png 3秒后 返回一张黄色js图片</li>\n<li>img2.png 立即返回一张 nodejs图片</li>\n</ul>\n<p>服务器端代码：</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> Koa = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Router = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa-router'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> views = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa-views'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> fs = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'fs'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-keyword\">new</span> Koa()</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> router = <span class=\"hljs-keyword\">new</span> Router()</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(views(__dirname + <span class=\"hljs-string\">'/views'</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/'</span>, <span class=\"hljs-keyword\">async</span> (ctx, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">await</span> ctx.render(<span class=\"hljs-string\">'index.html'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/css1.css'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'text/css'</span>)</span><br><span class=\"line\">    ctx.body = <span class=\"hljs-string\">'body &#123; background-color: #444 &#125;'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">2</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/css2.css'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'text/css'</span>)</span><br><span class=\"line\">  ctx.body = <span class=\"hljs-string\">'body &#123; font-size: 50px;font-weight: bold; &#125;'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/js1.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"hljs-string\">'console.log(\"js1.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/js2.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.body = <span class=\"hljs-string\">'console.log(\"js2.js loaded\")'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/js3.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"hljs-string\">'console.log(\"js3.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/img1.png'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">    ctx.body = fs.createReadStream(<span class=\"hljs-string\">'1.png'</span>)</span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/img2.png'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">  ctx.body = fs.createReadStream(<span class=\"hljs-string\">'2.png'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app</span><br><span class=\"line\">  .use(router.routes())</span><br><span class=\"line\">  .use(router.allowedMethods())</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(<span class=\"hljs-number\">3000</span>)</span><br></pre></td></tr></table></figure>\n<h2 id=\"实验一：-CSS加载是否影响DOM解析\"><a href=\"#实验一：-CSS加载是否影响DOM解析\" class=\"headerlink\" title=\"实验一： CSS加载是否影响DOM解析\"></a>实验一： CSS加载是否影响DOM解析</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">app元素对象</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 1947.620849609375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>从控制台的输出可以看到 app 元素会被正确输出，2秒左右再输出 test 的时间，可见<strong>CSS加载并不会阻碍DOM解析</strong>。</p>\n<h2 id=\"实验二：-CSS加载是否影响JS执行和DOM渲染\"><a href=\"#实验二：-CSS加载是否影响JS执行和DOM渲染\" class=\"headerlink\" title=\"实验二： CSS加载是否影响JS执行和DOM渲染\"></a>实验二： CSS加载是否影响JS执行和DOM渲染</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">(index):17 test: 1921.02099609375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>当打开index.html页面后，会发现所有资源均同时发起了请求，页面会先处于白屏加载状态（DOM无法渲染），当2秒（左右）后页面除img1.png未渲染外，其它样式和图片均渲染。</p>\n<p>从控制台的输出可以看出，虽然js比css快1秒左右加载完毕，但是此刻是处于阻塞状态并没有执行，当css加载完成后，才从上至下的执行（虽然js2.js比js1.js早加载好，但是执行的时候还是从上至下的），当css1.css加载完成后，页面立即渲染，图片img1.png晚1秒左右显示。可见<strong>CSS加载会阻碍JS执行和DOM的渲染</strong>。</p>\n<h2 id=\"实验三：-JS加载是否影响DOM解析和渲染\"><a href=\"#实验三：-JS加载是否影响DOM解析和渲染\" class=\"headerlink\" title=\"实验三： JS加载是否影响DOM解析和渲染\"></a>实验三： JS加载是否影响DOM解析和渲染</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">null</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js3.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 2943.9951171875ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们仅引入一个js3.js文件，设置它的返回时间为3秒，从控制台的输出可以看到 app 元素没有被正确输出（输出null），3秒左右再输出 test 的时间，可见<strong>JS加载会阻碍DOM解析，既然解析都被影响自然必定影响渲染了</strong>。</p>\n<h2 id=\"实验四：-DOM的DOMContentLoaded和onLoad事件\"><a href=\"#实验四：-DOM的DOMContentLoaded和onLoad事件\" class=\"headerlink\" title=\"实验四： DOM的DOMContentLoaded和onLoad事件\"></a>实验四： DOM的DOMContentLoaded和onLoad事件</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">window</span>.onload = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 1955.489990234375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">testDOMContentLoaded: 1956.044189453125ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">testonload: 2964.078857421875ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们通过控制台会发现 testDOMContentLoaded 会在2秒左右打印出来，testonload会在3秒左右打印出来，由此可知<strong>DOMContentLoaded是js和css文件的加载后触发，onload是整个页面所有资源加载完后触发（比如图片等）</strong>。</p>\n<h2 id=\"实验五：-script-async-属性\"><a href=\"#实验五：-script-async-属性\" class=\"headerlink\" title=\"实验五： script async 属性\"></a>实验五： script async 属性</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”async”,会发现输出顺序是</p>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>app元素对象</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>之后我们将js1.js上的”async”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>testDOMContentLoaded 1秒左右时间</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>之后我们将js3.js上的”async”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>可见<strong>async会打乱js的执行顺序，有async的js文件哪个先加载完哪个先执行，DOMContentLoaded的触发时间不在和async有关系，不会影响页面的渲染和解析</strong></p>\n<h2 id=\"实验六：-script-defer-属性\"><a href=\"#实验六：-script-defer-属性\" class=\"headerlink\" title=\"实验六： script defer 属性\"></a>实验六： script defer 属性</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”defer”,会发现输出顺序是</p>\n<ul>\n<li>app元素对象</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>这和没有加defer和async时一样</p>\n<p>之后我们将js1.js上的”defer”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>这和没有加defer和async时一样</p>\n<p>之后我们将js3.js上的”defer”移除，会发现输出顺序是</p>\n<ul>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n<li>js2.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>可见<strong>defer会打乱js的执行顺序，有defer的js文件会晚于没有的，但是它们（含有defer）依旧保持从上而下依次执行，DOMContentLoaded的触发时间晚于defer，不会影响页面的渲染和解析</strong></p>\n<h2 id=\"实验七：-script-defer-amp-async-都加上-属性\"><a href=\"#实验七：-script-defer-amp-async-都加上-属性\" class=\"headerlink\" title=\"实验七： script defer &amp; async 都加上 属性\"></a>实验七： script defer &amp; async 都加上 属性</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”async”,会发现输出顺序是</p>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>async优先级比defer高</p>\n<h2 id=\"实验八：-动态创建script\"><a href=\"#实验八：-动态创建script\" class=\"headerlink\" title=\"实验八： 动态创建script\"></a>实验八： 动态创建script</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-keyword\">var</span> appEl = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">var</span> head = <span class=\"hljs-built_in\">document</span>.getElementsByTagName(<span class=\"hljs-string\">'head'</span>)[<span class=\"hljs-number\">0</span>]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">3</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">var</span> script = <span class=\"hljs-built_in\">document</span>.createElement(<span class=\"hljs-string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.type = <span class=\"hljs-string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.src = <span class=\"hljs-string\">'js'</span> + (i + <span class=\"hljs-number\">1</span>) + <span class=\"hljs-string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>appEl 对象</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>如果我们动态创建js1.js和js2.js，将js3.js依旧按照常规写法写在页面中的话</p>\n<p>index.html<br><figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-keyword\">var</span> appEl = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">var</span> head = <span class=\"hljs-built_in\">document</span>.getElementsByTagName(<span class=\"hljs-string\">'head'</span>)[<span class=\"hljs-number\">0</span>]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">2</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">var</span> script = <span class=\"hljs-built_in\">document</span>.createElement(<span class=\"hljs-string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.type = <span class=\"hljs-string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.src = <span class=\"hljs-string\">'js'</span> + (i + <span class=\"hljs-number\">1</span>) + <span class=\"hljs-string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>appEl 为 null 立即打印出来</li>\n<li>js3.js loaded </li>\n<li>testDOMContentLoaded 3秒左右会立即打印出来</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n</ul>\n<p>可见<strong>动态创建script基本是同时加载，哪个先加载完哪个先执行，但是他们都晚于DOMContentLoaded事件</strong></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>CSS加载会阻塞DOM渲染和JS执行，但是不影响页DOM解析；JS加载会阻塞DOM解析和渲染，给script标签加上defer &amp; async属性将不再影响DOM解析和渲染，async 是哪个先返回先执行按个，defer会晚于常规标签同时按照含有defer属性的script加载的顺序执行</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[],"excerpt":"<p>我们常说浏览器是单线程的，那么我们在加载资源的时候页面是在等待加载完成呢？还是继续执行后续的操作？加载不同资源对浏览器的操作会有相同响应吗？我们可以通过一个一个简单的实验测试来了解。</p>","more":"<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p><em>所有资源均在localhost，浏览器chrome 69，不同浏览器或版本会有少许不同</em></p>\n<p>– css</p>\n<ul>\n<li>css1.css 2秒后返回 body { background-color: #444 }</li>\n<li>css2.css 立即返回 body { font-size: 50px;font-weight: bold; }</li>\n</ul>\n<p>– js</p>\n<ul>\n<li>js1.js 1秒后返回 console.log(“js1.js loaded”) </li>\n<li>js2.js 立即返回 console.log(“js2.js loaded”)</li>\n<li>js3.js 3秒后返回 console.log(“js2.js loaded”)</li>\n</ul>\n<p>– image</p>\n<ul>\n<li>img1.png 3秒后 返回一张黄色js图片</li>\n<li>img2.png 立即返回一张 nodejs图片</li>\n</ul>\n<p>服务器端代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> Koa = <span class=\"built_in\">require</span>(<span class=\"string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Router = <span class=\"built_in\">require</span>(<span class=\"string\">'koa-router'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> views = <span class=\"built_in\">require</span>(<span class=\"string\">'koa-views'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">'fs'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> Koa()</span><br><span class=\"line\"><span class=\"keyword\">const</span> router = <span class=\"keyword\">new</span> Router()</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(views(__dirname + <span class=\"string\">'/views'</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/'</span>, <span class=\"keyword\">async</span> (ctx, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">await</span> ctx.render(<span class=\"string\">'index.html'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/css1.css'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'text/css'</span>)</span><br><span class=\"line\">    ctx.body = <span class=\"string\">'body &#123; background-color: #444 &#125;'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">2</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/css2.css'</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'text/css'</span>)</span><br><span class=\"line\">  ctx.body = <span class=\"string\">'body &#123; font-size: 50px;font-weight: bold; &#125;'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/js1.js'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"string\">'console.log(\"js1.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/js2.js'</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.body = <span class=\"string\">'console.log(\"js2.js loaded\")'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/js3.js'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"string\">'console.log(\"js3.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/img1.png'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">    ctx.body = fs.createReadStream(<span class=\"string\">'1.png'</span>)</span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/img2.png'</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">  ctx.body = fs.createReadStream(<span class=\"string\">'2.png'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app</span><br><span class=\"line\">  .use(router.routes())</span><br><span class=\"line\">  .use(router.allowedMethods())</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(<span class=\"number\">3000</span>)</span><br></pre></td></tr></table></figure>\n<h2 id=\"实验一：-CSS加载是否影响DOM解析\"><a href=\"#实验一：-CSS加载是否影响DOM解析\" class=\"headerlink\" title=\"实验一： CSS加载是否影响DOM解析\"></a>实验一： CSS加载是否影响DOM解析</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"comment\">app元素对象</span></span><br><span class=\"line\"><span class=\"comment\">test: 1947.620849609375ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>从控制台的输出可以看到 app 元素会被正确输出，2秒左右再输出 test 的时间，可见<strong>CSS加载并不会阻碍DOM解析</strong>。</p>\n<h2 id=\"实验二：-CSS加载是否影响JS执行和DOM渲染\"><a href=\"#实验二：-CSS加载是否影响JS执行和DOM渲染\" class=\"headerlink\" title=\"实验二： CSS加载是否影响JS执行和DOM渲染\"></a>实验二： CSS加载是否影响JS执行和DOM渲染</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">(index):17 test: 1921.02099609375ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>当打开index.html页面后，会发现所有资源均同时发起了请求，页面会先处于白屏加载状态（DOM无法渲染），当2秒（左右）后页面除img1.png未渲染外，其它样式和图片均渲染。</p>\n<p>从控制台的输出可以看出，虽然js比css快1秒左右加载完毕，但是此刻是处于阻塞状态并没有执行，当css加载完成后，才从上至下的执行（虽然js2.js比js1.js早加载好，但是执行的时候还是从上至下的），当css1.css加载完成后，页面立即渲染，图片img1.png晚1秒左右显示。可见<strong>CSS加载会阻碍JS执行和DOM的渲染</strong>。</p>\n<h2 id=\"实验三：-JS加载是否影响DOM解析和渲染\"><a href=\"#实验三：-JS加载是否影响DOM解析和渲染\" class=\"headerlink\" title=\"实验三： JS加载是否影响DOM解析和渲染\"></a>实验三： JS加载是否影响DOM解析和渲染</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"comment\">null</span></span><br><span class=\"line\"><span class=\"comment\">js3.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">test: 2943.9951171875ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们仅引入一个js3.js文件，设置它的返回时间为3秒，从控制台的输出可以看到 app 元素没有被正确输出（输出null），3秒左右再输出 test 的时间，可见<strong>JS加载会阻碍DOM解析，既然解析都被影响自然必定影响渲染了</strong>。</p>\n<h2 id=\"实验四：-DOM的DOMContentLoaded和onLoad事件\"><a href=\"#实验四：-DOM的DOMContentLoaded和onLoad事件\" class=\"headerlink\" title=\"实验四： DOM的DOMContentLoaded和onLoad事件\"></a>实验四： DOM的DOMContentLoaded和onLoad事件</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">test: 1955.489990234375ms</span></span><br><span class=\"line\"><span class=\"comment\">testDOMContentLoaded: 1956.044189453125ms</span></span><br><span class=\"line\"><span class=\"comment\">testonload: 2964.078857421875ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们通过控制台会发现 testDOMContentLoaded 会在2秒左右打印出来，testonload会在3秒左右打印出来，由此可知<strong>DOMContentLoaded是js和css文件的加载后触发，onload是整个页面所有资源加载完后触发（比如图片等）</strong>。</p>\n<h2 id=\"实验五：-script-async-属性\"><a href=\"#实验五：-script-async-属性\" class=\"headerlink\" title=\"实验五： script async 属性\"></a>实验五： script async 属性</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”async”,会发现输出顺序是</p>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>app元素对象</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>之后我们将js1.js上的”async”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>testDOMContentLoaded 1秒左右时间</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>之后我们将js3.js上的”async”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>可见<strong>async会打乱js的执行顺序，有async的js文件哪个先加载完哪个先执行，DOMContentLoaded的触发时间不在和async有关系，不会影响页面的渲染和解析</strong></p>\n<h2 id=\"实验六：-script-defer-属性\"><a href=\"#实验六：-script-defer-属性\" class=\"headerlink\" title=\"实验六： script defer 属性\"></a>实验六： script defer 属性</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”defer”,会发现输出顺序是</p>\n<ul>\n<li>app元素对象</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>这和没有加defer和async时一样</p>\n<p>之后我们将js1.js上的”defer”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>这和没有加defer和async时一样</p>\n<p>之后我们将js3.js上的”defer”移除，会发现输出顺序是</p>\n<ul>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n<li>js2.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>可见<strong>defer会打乱js的执行顺序，有defer的js文件会晚于没有的，但是它们（含有defer）依旧保持从上而下依次执行，DOMContentLoaded的触发时间晚于defer，不会影响页面的渲染和解析</strong></p>\n<h2 id=\"实验七：-script-defer-amp-async-都加上-属性\"><a href=\"#实验七：-script-defer-amp-async-都加上-属性\" class=\"headerlink\" title=\"实验七： script defer &amp; async 都加上 属性\"></a>实验七： script defer &amp; async 都加上 属性</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”async”,会发现输出顺序是</p>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>async优先级比defer高</p>\n<h2 id=\"实验八：-动态创建script\"><a href=\"#实验八：-动态创建script\" class=\"headerlink\" title=\"实验八： 动态创建script\"></a>实验八： 动态创建script</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"keyword\">var</span> appEl = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> head = <span class=\"built_in\">document</span>.getElementsByTagName(<span class=\"string\">'head'</span>)[<span class=\"number\">0</span>]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">3</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> script = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      script.type = <span class=\"string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"javascript\">      script.src = <span class=\"string\">'js'</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>appEl 对象</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>如果我们动态创建js1.js和js2.js，将js3.js依旧按照常规写法写在页面中的话</p>\n<p>index.html<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"keyword\">var</span> appEl = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> head = <span class=\"built_in\">document</span>.getElementsByTagName(<span class=\"string\">'head'</span>)[<span class=\"number\">0</span>]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">2</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> script = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      script.type = <span class=\"string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"javascript\">      script.src = <span class=\"string\">'js'</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>appEl 为 null 立即打印出来</li>\n<li>js3.js loaded </li>\n<li>testDOMContentLoaded 3秒左右会立即打印出来</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n</ul>\n<p>可见<strong>动态创建script基本是同时加载，哪个先加载完哪个先执行，但是他们都晚于DOMContentLoaded事件</strong></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>CSS加载会阻塞DOM渲染和JS执行，但是不影响页DOM解析；JS加载会阻塞DOM解析和渲染，给script标签加上defer &amp; async属性将不再影响DOM解析和渲染，async 是哪个先返回先执行按个，defer会晚于常规标签同时按照含有defer属性的script加载的顺序执行</p>"},{"title":"简单梳理Node.js创建子进程的方法（上）","keywords":"Node.js,子进程创建,Node.js源码","description":"Node.js 创建子进程的方法常用的有如下几种。child_process, exec、execFile、fork、spawn；cluster, fork。","date":"2020-04-06T00:09:36.472Z","_content":"\n**Node.js 创建子进程的方法常用的有如下几种：**\n\n**child_process**\n\n- [exec](http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback): 衍生一个 shell 然后在该 shell 中执行 `command`，并缓冲任何产生的输出，最大缓存 1024\\*1024 个字节。\n- [execFile](http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback): 函数类似`exec`，但默认情况下不会衍生 shell。 相反，指定的可执行文件`file` 会作为新进程直接地衍生，使其比`exec` 稍微更高效。和`exec`一样，它也有最大 1024\\*1204 个字节的显示缓存。\n- [fork](http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options): 是 `spawn`的一个特例，专门用于衍生新的 Node.js 进程。 与`spawn`一样返回`ChildProcess`对象。 返回的`ChildProcess`将会内置一个额外的通信通道，允许消息在父进程和子进程之间来回传递。\n- [spawn](http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options): 上诉的几个方法其实都是通过 spawn 实现的。\n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): 衍生出一个新的工作进程，这只能通过主进程调用。\n\n<!-- more -->\n\n<br/>\n\n### **翻翻源码看看他们怎么实现的**\n\n源码版本和之前的[libuv & Node.js EventLoop （一）](https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/)一样\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**child_process**源码位置\n\n```javascript\nNode \n  - lib \n  \t- internal \n  \t\t- child_process.js \n  \t- child_process.js;\n```\n\n在`lib/child_process.js`文件中，定义了`exec`、`execFile`、`fork`和`spawn`等方法，它们最后都会调用在`lib/internal/child_process.js`文件中的`spawn`方法。\n\n<br/>\n\n**exec**\n\n```javascript\n// lib/child_process.js\nfunction exec(command, options, callback) {\n  const opts = normalizeExecArgs(command, options, callback);\n  return module.exports.execFile(opts.file, opts.options, opts.callback);\n}\nfunction normalizeExecArgs(command, options, callback) {\n  if (typeof options === \"function\") {\n    callback = options;\n    options = undefined;\n  }\n\n  // Make a shallow copy so we don't clobber the user's options object.\n  options = { ...options };\n  options.shell = typeof options.shell === \"string\" ? options.shell : true;\n\n  return {\n    file: command,\n    options: options,\n    callback: callback,\n  };\n}\n```\n\n从上面发现 exec 其实就是封装了参数，主要是开启`shell`参数，然后调用 execFile 方法。\n\n<br/>\n\n**execFile**\n\n```javascript\n// lib/child_process.js\nfunction execFile(file /* , args, options, callback */) {\n  let args = [];\n  let callback;\n  let options;\n\n  // ...\n\n  options = {\n    encoding: \"utf8\",\n    timeout: 0,\n    maxBuffer: MAX_BUFFER,\n    killSignal: \"SIGTERM\",\n    cwd: null,\n    env: null,\n    shell: false, // execFile 默认是不开启shell\n    ...options,\n  };\n\n  // 通过spawn方法创建子进程\n  const child = spawn(file, args, {\n    cwd: options.cwd,\n    env: options.env,\n    gid: options.gid,\n    uid: options.uid,\n    shell: options.shell,\n    windowsHide: !!options.windowsHide,\n    windowsVerbatimArguments: !!options.windowsVerbatimArguments,\n  });\n\n  var encoding;\n  const _stdout = []; // 输出的内容\n  const _stderr = []; // 出错的内容\n  // ...\n  var stdoutLen = 0; // 输出内容的长度\n  var stderrLen = 0; // 出错内容的长度\n  var killed = false; // 是否已经被杀死\n  var exited = false; // 是否已经退出\n  var timeoutId; // 是否有定时器\n\n  var ex = null; // 出错的上下文对象\n\n  var cmd = file; // 命令或文件\n\n  // 退出回调方法\n  function exithandler(code, signal) {\n    if (exited) return;\n    exited = true;\n\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      timeoutId = null;\n    }\n\n    if (!callback) return;\n\n    // merge chunks\n    var stdout;\n    var stderr;\n    if (encoding || (child.stdout && child.stdout.readableEncoding)) {\n      stdout = _stdout.join(\"\");\n    } else {\n      stdout = Buffer.concat(_stdout); // 如果不传入 encoding 参数，默认是Buffer拼接输出\n    }\n    if (encoding || (child.stderr && child.stderr.readableEncoding)) {\n      stderr = _stderr.join(\"\");\n    } else {\n      stderr = Buffer.concat(_stderr); // 如果不传入 encoding 参数，默认是Buffer拼接输出\n    }\n\n    if (!ex && code === 0 && signal === null) {\n      callback(null, stdout, stderr); // 没有错误，执行回调\n      return;\n    }\n\n    if (args.length !== 0) cmd += ` ${args.join(\" \")}`;\n\n    if (!ex) {\n      // eslint-disable-next-line no-restricted-syntax\n      ex = new Error(\"Command failed: \" + cmd + \"\\n\" + stderr);\n      ex.killed = child.killed || killed;\n      ex.code = code < 0 ? getSystemErrorName(code) : code;\n      ex.signal = signal;\n    }\n\n    ex.cmd = cmd;\n    callback(ex, stdout, stderr); // 有错误，执行回调\n  }\n\n  function errorhandler(e) {\n    ex = e;\n\n    // child.stdout 和 child.stderr 都销毁\n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    exithandler();\n  }\n\n  function kill() {\n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    killed = true;\n    try {\n      child.kill(options.killSignal);\n    } catch (e) {\n      ex = e;\n      exithandler();\n    }\n  }\n\n  // 如果定义了子进程的超时时间，就定时销毁它\n  if (options.timeout > 0) {\n    timeoutId = setTimeout(function delayedKill() {\n      kill();\n      timeoutId = null;\n    }, options.timeout);\n  }\n\n  if (child.stdout) {\n    if (encoding) child.stdout.setEncoding(encoding);\n\n    child.stdout.on(\"data\", function onChildStdout(chunk) {\n      const encoding = child.stdout.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stdoutLen += length; // 不断累加输出的长度\n\n      if (stdoutLen > options.maxBuffer) {\n        // 超过的话就报错\n        const truncatedLen = options.maxBuffer - (stdoutLen - length);\n        _stdout.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stdout\");\n        kill();\n      } else {\n        _stdout.push(chunk); // 不断累积chunk\n      }\n    });\n  }\n\n  // 整体逻辑和上面的child.stdout基本一致\n  if (child.stderr) {\n    if (encoding) child.stderr.setEncoding(encoding);\n\n    child.stderr.on(\"data\", function onChildStderr(chunk) {\n      const encoding = child.stderr.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stderrLen += length;\n\n      if (stderrLen > options.maxBuffer) {\n        const truncatedLen = options.maxBuffer - (stderrLen - length);\n        _stderr.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stderr\");\n        kill();\n      } else {\n        _stderr.push(chunk);\n      }\n    });\n  }\n\n  child.addListener(\"close\", exithandler);\n  child.addListener(\"error\", errorhandler);\n\n  return child;\n}\n```\n\n`exec`和`execFile`最大的一个区别就是参数`shell`默认是否开启，其它基本都是相同的。另外，它们对输出的内容有大小限制是在`child.stderr.on('data')`和`child.stdout.on('data')`获取数据时候被限制。\n\n如果不做类似的规定，`_stderr`和`_stdout`无限被输出，那么内存会不断的膨胀导致性能问题，甚至程序奔溃。（这是我猜的原因）\n\n另外说到底，**最后还是对`spawn`方法的封装了调用。**\n\n<br/>\n\n**fork**\n\n```javascript\n// lib/child_process.js\nfunction fork(modulePath /* , args, options */) {\n  // Get options and args arguments.\n  var execArgv;\n  var options = {};\n  var args = [];\n\n  // ...\n\n  // fork方法的stdio参数，必须带有一个ipc参数\n  if (typeof options.stdio === \"string\") {\n    options.stdio = stdioStringToArray(options.stdio, \"ipc\");\n  } else if (!Array.isArray(options.stdio)) {\n    // Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,\n    // and stderr from the parent if silent isn't set.\n    options.stdio = stdioStringToArray(\n      options.silent ? \"pipe\" : \"inherit\",\n      \"ipc\"\n    );\n  } else if (!options.stdio.includes(\"ipc\")) {\n    throw new ERR_CHILD_PROCESS_IPC_REQUIRED(\"options.stdio\");\n  }\n\n  options.execPath = options.execPath || process.execPath; // 默认用父进程的Node执行文件\n  options.shell = false; // 不开启 shell\n\n  return spawn(options.execPath, args, options);\n}\n```\n\n从上面代码有个非常引人注意就是 12~22 行，fork 方法的 stdio 参数，必须带有一个 ipc 参数，这个`ipc`的作用将在后续深入挖掘后介绍。最后也是调用`spawn`创建子进程。\n\n<br/>\n\n**spawn**\n\n```javascript\n// lib/child_process.js\nfunction spawn(file, args, options) {\n  const child = new ChildProcess();\n\n  options = normalizeSpawnArguments(file, args, options);\n  debug(\"spawn\", options);\n  child.spawn(options);\n\n  return child;\n}\n```\n\n`lib/child_process.js`里的 spawn 方法就简单的将传入的参数做整理，然后直接调用 ChildProcess 实例对象的 spawn。\n\n<br/>\n\n**ChildProcess**\n\n```javascript\n// `lib/internal/child_process.js`\nfunction ChildProcess() {\n  EventEmitter.call(this);\n\n  // ...\n\n  this._handle = new Process(); // new 出一个 ProcessWrap 对象 （ process_wrap.cc）\n}\n\nChildProcess.prototype.spawn = function (options) {\n  let i = 0;\n\n  // 默认使用 pipe\n  let stdio = options.stdio || \"pipe\";\n\n  // 重置stdio变量，这个是个很重要的方法，后续将继续介绍\n  stdio = getValidStdio(stdio, false);\n\n  const ipc = stdio.ipc;\n  const ipcFd = stdio.ipcFd;\n  stdio = options.stdio = stdio.stdio;\n\n  // ...\n\n  // 调用ProcessWrap对应的spawn去创建新进程\n  const err = this._handle.spawn(options);\n\n  // 如果err存在，就会有相关代码处理创建子进程出错的场景\n  // ...\n\n  this.pid = this._handle.pid;\n\n  for (i = 0; i < stdio.length; i++) {\n    const stream = stdio[i];\n    // ...\n    if (stream.handle) {\n      // When i === 0 - we're dealing with stdin\n      // (which is the only one writable pipe).\n      // 创建 socket\n      stream.socket = createSocket(\n        this.pid !== 0 ? stream.handle : null,\n        i > 0\n      );\n\n      if (i > 0 && this.pid !== 0) {\n        this._closesNeeded++;\n        stream.socket.on(\"close\", () => {\n          maybeClose(this);\n        });\n      }\n    }\n  }\n  this.stdin =\n    stdio.length >= 1 && stdio[0].socket !== undefined ? stdio[0].socket : null;\n  this.stdout =\n    stdio.length >= 2 && stdio[1].socket !== undefined ? stdio[1].socket : null;\n  this.stderr =\n    stdio.length >= 3 && stdio[2].socket !== undefined ? stdio[2].socket : null;\n\n  this.stdio = [];\n\n  for (i = 0; i < stdio.length; i++)\n    this.stdio.push(stdio[i].socket === undefined ? null : stdio[i].socket);\n\n  // Add .send() method and start listening for IPC data\n  // setupChannel 方法很长，主要就是实现了数据的发送和接受\n  if (ipc !== undefined) setupChannel(this, ipc);\n\n  return err;\n};\n\nfunction stdioStringToArray(stdio, channel) {\n  // 主要将stdio参数格式化为[xxx,xxx,xxx]形式的数组\n  // 如果有channel，[xxx,xxx,xxx,channel]\n}\n\nfunction getValidStdio(stdio, sync) {\n  var ipc;\n  var ipcFd;\n\n  stdio = stdio.reduce((acc, stdio, i) => {\n    function cleanup() {\n      for (var i = 0; i < acc.length; i++) {\n        if ((acc[i].type === \"pipe\" || acc[i].type === \"ipc\") && acc[i].handle)\n          acc[i].handle.close();\n      }\n    }\n\n    if (stdio === \"ignore\") {\n      acc.push({ type: \"ignore\" }); // 子进程的输出不需要在控制台显示\n    } else if (stdio === \"pipe\" || (typeof stdio === \"number\" && stdio < 0)) {\n      var a = {\n        type: \"pipe\",\n        readable: i === 0, // 0是stdin，需要读\n        writable: i !== 0, // 1是stdout，2是stderr 需要写\n      };\n      // spawn 调用的时候，sync为false，为stdin、stdout、stderr创建一个SOCKET类型Pipe\n      if (!sync) a.handle = new Pipe(PipeConstants.SOCKET);\n\n      acc.push(a);\n    } else if (stdio === \"ipc\") {\n      // 创建一个IPC类型Pipe\n      ipc = new Pipe(PipeConstants.IPC);\n      ipcFd = i; // ipc位置\n\n      acc.push({\n        type: \"pipe\",\n        handle: ipc,\n        ipc: true,\n      });\n    } else if (stdio === \"inherit\") {\n      acc.push({\n        type: \"inherit\",\n        fd: i,\n      });\n    }\n    // ...还有很多代码，不在讨论范围\n    return acc;\n  }, []);\n\n  return { stdio, ipc, ipcFd };\n}\n```\n\n`ChildProcess`并不能直接创建新的进程，需要底层 V8 的帮助，在构造函数里面直接 new ProcessWrap 赋给了 this.\\_handle。\n\n`ChildProcess.prototype.spawn`开始主要处理主要的[`stdio`](http://nodejs.cn/api/child_process.html#child_process_options_stdio)参数，明确父子进程通过哪些方式来获取数据信息，官方文档给出了一些示例，如果不清楚可以多做点实验。如果是`pipe`或者是`ipc`都会实例化一个 Pipe 对象，只是参数类型不同。\n\n```c\n// pipe_wrap.cc\nvoid PipeWrap::New(const FunctionCallbackInfo<Value>& args) {\n  switch (type) {\n    case SOCKET:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = false;\n      break;\n    case IPC:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = true;\n      break;\n  }\n  new PipeWrap(env, args.This(), provider, ipc);\n}\nPipeWrap::PipeWrap(Environment* env,\n                   Local<Object> object,\n                   ProviderType provider,\n                   bool ipc)\n    : ConnectionWrap(env, object, provider) {\n  int r = uv_pipe_init(env->event_loop(), &handle_, ipc);\n}\n// deps/uv/src/unix/pipe.c\nint uv_pipe_init(uv_loop_t* loop, uv_pipe_t* handle, int ipc) {\n  uv__stream_init(loop, (uv_stream_t*)handle, UV_NAMED_PIPE);\n  handle->shutdown_req = NULL;\n  handle->connect_req = NULL;\n  handle->pipe_fname = NULL;\n  handle->ipc = ipc;\n  return 0;\n}\n```\n\n它们唯一的区别就是`uv_pipe_t`的 ipc 参数是 true 还是 false，**所有的事件都被老老实实的绑定在 libuv 上**。\n\n回到`ChildProcess.prototype.spawn`中，已经重置了 stdio 参数后，到了真正创建子进程的地方了，`this._handle.spawn(options);`，通过`process_wrap.cc`里的 ProcessWrap.Spawn 去创建，整个创建方法也极长，主要是对传入的参数进行处理，然后再调用`uv_spawn`。\n\n```c\n// deps/uv/src/unix/process.c\nint uv_spawn(uv_loop_t* loop,\n             uv_process_t* process,\n             const uv_process_options_t* options) {\n#if defined(__APPLE__) && (TARGET_OS_TV || TARGET_OS_WATCH)\n  /* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */\n  return UV_ENOSYS;\n#else\n  // ...\n\n  uv_signal_start(&loop->child_watcher, uv__chld, SIGCHLD);\n\n  /* Acquire write lock to prevent opening new fds in worker threads */\n  uv_rwlock_wrlock(&loop->cloexec_lock);\n  pid = fork();\n\n  if (pid == -1) {\n    err = UV__ERR(errno);\n    uv_rwlock_wrunlock(&loop->cloexec_lock);\n    uv__close(signal_pipe[0]);\n    uv__close(signal_pipe[1]);\n    goto error;\n  }\n\n  if (pid == 0) {\n    uv__process_child_init(options, stdio_count, pipes, signal_pipe[1]);\n    abort();\n  }\n\n  /* Release lock in parent process */\n  uv_rwlock_wrunlock(&loop->cloexec_lock);\n  uv__close(signal_pipe[1]);\n\n  // ...\n}\n```\n\n通过系统层面的`fork`函数创建子进程，由于 fork 的特殊性，一次调用返回二次，当返回 0 的时候回执行子进程的逻辑，回去通过`uv__process_child_init`初始化整个子进程的上下文信息。\n\n再回到`ChildProcess.prototype.spawn`中，遍历`stdio`，如果成员有 handle 字段，就通过`createSocket`为其创建一个 socket 对象\n\n```javascript\nfunction createSocket(pipe, readable) {\n  return net.Socket({ handle: pipe, readable, writable: !readable });\n}\n```\n\n无论是参数`stdio`是 pipe 还是 ipc 都会创建 socket，在父子进程通信的时候，父进程通过子进程暴露出来的 stdin、stdout 和 stderr 来展示子进程执行的信息，缺乏之间的数据互通性，这也是导致`exec`和`execFile`可使用的场景有限，而`fork`会带一个 ipc 参数给 stdio 参数（可以回过去翻翻 fork 源码），所以可以执行父子进程的通信操作，比如 send 方法等，具体的实现可以看`setupChannel`。\n\n<br/>\n\n<br/>\n\n**综上，**Node.js 在`child_process`里创建进程的流程大致梳理了下，在 JavaScript 层面并没有什么复杂的，在 libuv 层面注册了很多相关的事件，有空可以研究研究。之后会写一篇关于 cluster.fork 的介绍，其实就是对 child_process.fork 更多的封装。\n","source":"_posts/child_process-exec-fork-spawn.md","raw":"---\ntitle: 简单梳理Node.js创建子进程的方法（上）\ncategory: JavaScript\nkeywords: Node.js,子进程创建,Node.js源码\ndescription: Node.js 创建子进程的方法常用的有如下几种。child_process, exec、execFile、fork、spawn；cluster, fork。\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-04-06T08:09:36.472Z\n---\n\n**Node.js 创建子进程的方法常用的有如下几种：**\n\n**child_process**\n\n- [exec](http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback): 衍生一个 shell 然后在该 shell 中执行 `command`，并缓冲任何产生的输出，最大缓存 1024\\*1024 个字节。\n- [execFile](http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback): 函数类似`exec`，但默认情况下不会衍生 shell。 相反，指定的可执行文件`file` 会作为新进程直接地衍生，使其比`exec` 稍微更高效。和`exec`一样，它也有最大 1024\\*1204 个字节的显示缓存。\n- [fork](http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options): 是 `spawn`的一个特例，专门用于衍生新的 Node.js 进程。 与`spawn`一样返回`ChildProcess`对象。 返回的`ChildProcess`将会内置一个额外的通信通道，允许消息在父进程和子进程之间来回传递。\n- [spawn](http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options): 上诉的几个方法其实都是通过 spawn 实现的。\n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): 衍生出一个新的工作进程，这只能通过主进程调用。\n\n<!-- more -->\n\n<br/>\n\n### **翻翻源码看看他们怎么实现的**\n\n源码版本和之前的[libuv & Node.js EventLoop （一）](https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/)一样\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**child_process**源码位置\n\n```javascript\nNode \n  - lib \n  \t- internal \n  \t\t- child_process.js \n  \t- child_process.js;\n```\n\n在`lib/child_process.js`文件中，定义了`exec`、`execFile`、`fork`和`spawn`等方法，它们最后都会调用在`lib/internal/child_process.js`文件中的`spawn`方法。\n\n<br/>\n\n**exec**\n\n```javascript\n// lib/child_process.js\nfunction exec(command, options, callback) {\n  const opts = normalizeExecArgs(command, options, callback);\n  return module.exports.execFile(opts.file, opts.options, opts.callback);\n}\nfunction normalizeExecArgs(command, options, callback) {\n  if (typeof options === \"function\") {\n    callback = options;\n    options = undefined;\n  }\n\n  // Make a shallow copy so we don't clobber the user's options object.\n  options = { ...options };\n  options.shell = typeof options.shell === \"string\" ? options.shell : true;\n\n  return {\n    file: command,\n    options: options,\n    callback: callback,\n  };\n}\n```\n\n从上面发现 exec 其实就是封装了参数，主要是开启`shell`参数，然后调用 execFile 方法。\n\n<br/>\n\n**execFile**\n\n```javascript\n// lib/child_process.js\nfunction execFile(file /* , args, options, callback */) {\n  let args = [];\n  let callback;\n  let options;\n\n  // ...\n\n  options = {\n    encoding: \"utf8\",\n    timeout: 0,\n    maxBuffer: MAX_BUFFER,\n    killSignal: \"SIGTERM\",\n    cwd: null,\n    env: null,\n    shell: false, // execFile 默认是不开启shell\n    ...options,\n  };\n\n  // 通过spawn方法创建子进程\n  const child = spawn(file, args, {\n    cwd: options.cwd,\n    env: options.env,\n    gid: options.gid,\n    uid: options.uid,\n    shell: options.shell,\n    windowsHide: !!options.windowsHide,\n    windowsVerbatimArguments: !!options.windowsVerbatimArguments,\n  });\n\n  var encoding;\n  const _stdout = []; // 输出的内容\n  const _stderr = []; // 出错的内容\n  // ...\n  var stdoutLen = 0; // 输出内容的长度\n  var stderrLen = 0; // 出错内容的长度\n  var killed = false; // 是否已经被杀死\n  var exited = false; // 是否已经退出\n  var timeoutId; // 是否有定时器\n\n  var ex = null; // 出错的上下文对象\n\n  var cmd = file; // 命令或文件\n\n  // 退出回调方法\n  function exithandler(code, signal) {\n    if (exited) return;\n    exited = true;\n\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      timeoutId = null;\n    }\n\n    if (!callback) return;\n\n    // merge chunks\n    var stdout;\n    var stderr;\n    if (encoding || (child.stdout && child.stdout.readableEncoding)) {\n      stdout = _stdout.join(\"\");\n    } else {\n      stdout = Buffer.concat(_stdout); // 如果不传入 encoding 参数，默认是Buffer拼接输出\n    }\n    if (encoding || (child.stderr && child.stderr.readableEncoding)) {\n      stderr = _stderr.join(\"\");\n    } else {\n      stderr = Buffer.concat(_stderr); // 如果不传入 encoding 参数，默认是Buffer拼接输出\n    }\n\n    if (!ex && code === 0 && signal === null) {\n      callback(null, stdout, stderr); // 没有错误，执行回调\n      return;\n    }\n\n    if (args.length !== 0) cmd += ` ${args.join(\" \")}`;\n\n    if (!ex) {\n      // eslint-disable-next-line no-restricted-syntax\n      ex = new Error(\"Command failed: \" + cmd + \"\\n\" + stderr);\n      ex.killed = child.killed || killed;\n      ex.code = code < 0 ? getSystemErrorName(code) : code;\n      ex.signal = signal;\n    }\n\n    ex.cmd = cmd;\n    callback(ex, stdout, stderr); // 有错误，执行回调\n  }\n\n  function errorhandler(e) {\n    ex = e;\n\n    // child.stdout 和 child.stderr 都销毁\n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    exithandler();\n  }\n\n  function kill() {\n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    killed = true;\n    try {\n      child.kill(options.killSignal);\n    } catch (e) {\n      ex = e;\n      exithandler();\n    }\n  }\n\n  // 如果定义了子进程的超时时间，就定时销毁它\n  if (options.timeout > 0) {\n    timeoutId = setTimeout(function delayedKill() {\n      kill();\n      timeoutId = null;\n    }, options.timeout);\n  }\n\n  if (child.stdout) {\n    if (encoding) child.stdout.setEncoding(encoding);\n\n    child.stdout.on(\"data\", function onChildStdout(chunk) {\n      const encoding = child.stdout.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stdoutLen += length; // 不断累加输出的长度\n\n      if (stdoutLen > options.maxBuffer) {\n        // 超过的话就报错\n        const truncatedLen = options.maxBuffer - (stdoutLen - length);\n        _stdout.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stdout\");\n        kill();\n      } else {\n        _stdout.push(chunk); // 不断累积chunk\n      }\n    });\n  }\n\n  // 整体逻辑和上面的child.stdout基本一致\n  if (child.stderr) {\n    if (encoding) child.stderr.setEncoding(encoding);\n\n    child.stderr.on(\"data\", function onChildStderr(chunk) {\n      const encoding = child.stderr.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stderrLen += length;\n\n      if (stderrLen > options.maxBuffer) {\n        const truncatedLen = options.maxBuffer - (stderrLen - length);\n        _stderr.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stderr\");\n        kill();\n      } else {\n        _stderr.push(chunk);\n      }\n    });\n  }\n\n  child.addListener(\"close\", exithandler);\n  child.addListener(\"error\", errorhandler);\n\n  return child;\n}\n```\n\n`exec`和`execFile`最大的一个区别就是参数`shell`默认是否开启，其它基本都是相同的。另外，它们对输出的内容有大小限制是在`child.stderr.on('data')`和`child.stdout.on('data')`获取数据时候被限制。\n\n如果不做类似的规定，`_stderr`和`_stdout`无限被输出，那么内存会不断的膨胀导致性能问题，甚至程序奔溃。（这是我猜的原因）\n\n另外说到底，**最后还是对`spawn`方法的封装了调用。**\n\n<br/>\n\n**fork**\n\n```javascript\n// lib/child_process.js\nfunction fork(modulePath /* , args, options */) {\n  // Get options and args arguments.\n  var execArgv;\n  var options = {};\n  var args = [];\n\n  // ...\n\n  // fork方法的stdio参数，必须带有一个ipc参数\n  if (typeof options.stdio === \"string\") {\n    options.stdio = stdioStringToArray(options.stdio, \"ipc\");\n  } else if (!Array.isArray(options.stdio)) {\n    // Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,\n    // and stderr from the parent if silent isn't set.\n    options.stdio = stdioStringToArray(\n      options.silent ? \"pipe\" : \"inherit\",\n      \"ipc\"\n    );\n  } else if (!options.stdio.includes(\"ipc\")) {\n    throw new ERR_CHILD_PROCESS_IPC_REQUIRED(\"options.stdio\");\n  }\n\n  options.execPath = options.execPath || process.execPath; // 默认用父进程的Node执行文件\n  options.shell = false; // 不开启 shell\n\n  return spawn(options.execPath, args, options);\n}\n```\n\n从上面代码有个非常引人注意就是 12~22 行，fork 方法的 stdio 参数，必须带有一个 ipc 参数，这个`ipc`的作用将在后续深入挖掘后介绍。最后也是调用`spawn`创建子进程。\n\n<br/>\n\n**spawn**\n\n```javascript\n// lib/child_process.js\nfunction spawn(file, args, options) {\n  const child = new ChildProcess();\n\n  options = normalizeSpawnArguments(file, args, options);\n  debug(\"spawn\", options);\n  child.spawn(options);\n\n  return child;\n}\n```\n\n`lib/child_process.js`里的 spawn 方法就简单的将传入的参数做整理，然后直接调用 ChildProcess 实例对象的 spawn。\n\n<br/>\n\n**ChildProcess**\n\n```javascript\n// `lib/internal/child_process.js`\nfunction ChildProcess() {\n  EventEmitter.call(this);\n\n  // ...\n\n  this._handle = new Process(); // new 出一个 ProcessWrap 对象 （ process_wrap.cc）\n}\n\nChildProcess.prototype.spawn = function (options) {\n  let i = 0;\n\n  // 默认使用 pipe\n  let stdio = options.stdio || \"pipe\";\n\n  // 重置stdio变量，这个是个很重要的方法，后续将继续介绍\n  stdio = getValidStdio(stdio, false);\n\n  const ipc = stdio.ipc;\n  const ipcFd = stdio.ipcFd;\n  stdio = options.stdio = stdio.stdio;\n\n  // ...\n\n  // 调用ProcessWrap对应的spawn去创建新进程\n  const err = this._handle.spawn(options);\n\n  // 如果err存在，就会有相关代码处理创建子进程出错的场景\n  // ...\n\n  this.pid = this._handle.pid;\n\n  for (i = 0; i < stdio.length; i++) {\n    const stream = stdio[i];\n    // ...\n    if (stream.handle) {\n      // When i === 0 - we're dealing with stdin\n      // (which is the only one writable pipe).\n      // 创建 socket\n      stream.socket = createSocket(\n        this.pid !== 0 ? stream.handle : null,\n        i > 0\n      );\n\n      if (i > 0 && this.pid !== 0) {\n        this._closesNeeded++;\n        stream.socket.on(\"close\", () => {\n          maybeClose(this);\n        });\n      }\n    }\n  }\n  this.stdin =\n    stdio.length >= 1 && stdio[0].socket !== undefined ? stdio[0].socket : null;\n  this.stdout =\n    stdio.length >= 2 && stdio[1].socket !== undefined ? stdio[1].socket : null;\n  this.stderr =\n    stdio.length >= 3 && stdio[2].socket !== undefined ? stdio[2].socket : null;\n\n  this.stdio = [];\n\n  for (i = 0; i < stdio.length; i++)\n    this.stdio.push(stdio[i].socket === undefined ? null : stdio[i].socket);\n\n  // Add .send() method and start listening for IPC data\n  // setupChannel 方法很长，主要就是实现了数据的发送和接受\n  if (ipc !== undefined) setupChannel(this, ipc);\n\n  return err;\n};\n\nfunction stdioStringToArray(stdio, channel) {\n  // 主要将stdio参数格式化为[xxx,xxx,xxx]形式的数组\n  // 如果有channel，[xxx,xxx,xxx,channel]\n}\n\nfunction getValidStdio(stdio, sync) {\n  var ipc;\n  var ipcFd;\n\n  stdio = stdio.reduce((acc, stdio, i) => {\n    function cleanup() {\n      for (var i = 0; i < acc.length; i++) {\n        if ((acc[i].type === \"pipe\" || acc[i].type === \"ipc\") && acc[i].handle)\n          acc[i].handle.close();\n      }\n    }\n\n    if (stdio === \"ignore\") {\n      acc.push({ type: \"ignore\" }); // 子进程的输出不需要在控制台显示\n    } else if (stdio === \"pipe\" || (typeof stdio === \"number\" && stdio < 0)) {\n      var a = {\n        type: \"pipe\",\n        readable: i === 0, // 0是stdin，需要读\n        writable: i !== 0, // 1是stdout，2是stderr 需要写\n      };\n      // spawn 调用的时候，sync为false，为stdin、stdout、stderr创建一个SOCKET类型Pipe\n      if (!sync) a.handle = new Pipe(PipeConstants.SOCKET);\n\n      acc.push(a);\n    } else if (stdio === \"ipc\") {\n      // 创建一个IPC类型Pipe\n      ipc = new Pipe(PipeConstants.IPC);\n      ipcFd = i; // ipc位置\n\n      acc.push({\n        type: \"pipe\",\n        handle: ipc,\n        ipc: true,\n      });\n    } else if (stdio === \"inherit\") {\n      acc.push({\n        type: \"inherit\",\n        fd: i,\n      });\n    }\n    // ...还有很多代码，不在讨论范围\n    return acc;\n  }, []);\n\n  return { stdio, ipc, ipcFd };\n}\n```\n\n`ChildProcess`并不能直接创建新的进程，需要底层 V8 的帮助，在构造函数里面直接 new ProcessWrap 赋给了 this.\\_handle。\n\n`ChildProcess.prototype.spawn`开始主要处理主要的[`stdio`](http://nodejs.cn/api/child_process.html#child_process_options_stdio)参数，明确父子进程通过哪些方式来获取数据信息，官方文档给出了一些示例，如果不清楚可以多做点实验。如果是`pipe`或者是`ipc`都会实例化一个 Pipe 对象，只是参数类型不同。\n\n```c\n// pipe_wrap.cc\nvoid PipeWrap::New(const FunctionCallbackInfo<Value>& args) {\n  switch (type) {\n    case SOCKET:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = false;\n      break;\n    case IPC:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = true;\n      break;\n  }\n  new PipeWrap(env, args.This(), provider, ipc);\n}\nPipeWrap::PipeWrap(Environment* env,\n                   Local<Object> object,\n                   ProviderType provider,\n                   bool ipc)\n    : ConnectionWrap(env, object, provider) {\n  int r = uv_pipe_init(env->event_loop(), &handle_, ipc);\n}\n// deps/uv/src/unix/pipe.c\nint uv_pipe_init(uv_loop_t* loop, uv_pipe_t* handle, int ipc) {\n  uv__stream_init(loop, (uv_stream_t*)handle, UV_NAMED_PIPE);\n  handle->shutdown_req = NULL;\n  handle->connect_req = NULL;\n  handle->pipe_fname = NULL;\n  handle->ipc = ipc;\n  return 0;\n}\n```\n\n它们唯一的区别就是`uv_pipe_t`的 ipc 参数是 true 还是 false，**所有的事件都被老老实实的绑定在 libuv 上**。\n\n回到`ChildProcess.prototype.spawn`中，已经重置了 stdio 参数后，到了真正创建子进程的地方了，`this._handle.spawn(options);`，通过`process_wrap.cc`里的 ProcessWrap.Spawn 去创建，整个创建方法也极长，主要是对传入的参数进行处理，然后再调用`uv_spawn`。\n\n```c\n// deps/uv/src/unix/process.c\nint uv_spawn(uv_loop_t* loop,\n             uv_process_t* process,\n             const uv_process_options_t* options) {\n#if defined(__APPLE__) && (TARGET_OS_TV || TARGET_OS_WATCH)\n  /* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */\n  return UV_ENOSYS;\n#else\n  // ...\n\n  uv_signal_start(&loop->child_watcher, uv__chld, SIGCHLD);\n\n  /* Acquire write lock to prevent opening new fds in worker threads */\n  uv_rwlock_wrlock(&loop->cloexec_lock);\n  pid = fork();\n\n  if (pid == -1) {\n    err = UV__ERR(errno);\n    uv_rwlock_wrunlock(&loop->cloexec_lock);\n    uv__close(signal_pipe[0]);\n    uv__close(signal_pipe[1]);\n    goto error;\n  }\n\n  if (pid == 0) {\n    uv__process_child_init(options, stdio_count, pipes, signal_pipe[1]);\n    abort();\n  }\n\n  /* Release lock in parent process */\n  uv_rwlock_wrunlock(&loop->cloexec_lock);\n  uv__close(signal_pipe[1]);\n\n  // ...\n}\n```\n\n通过系统层面的`fork`函数创建子进程，由于 fork 的特殊性，一次调用返回二次，当返回 0 的时候回执行子进程的逻辑，回去通过`uv__process_child_init`初始化整个子进程的上下文信息。\n\n再回到`ChildProcess.prototype.spawn`中，遍历`stdio`，如果成员有 handle 字段，就通过`createSocket`为其创建一个 socket 对象\n\n```javascript\nfunction createSocket(pipe, readable) {\n  return net.Socket({ handle: pipe, readable, writable: !readable });\n}\n```\n\n无论是参数`stdio`是 pipe 还是 ipc 都会创建 socket，在父子进程通信的时候，父进程通过子进程暴露出来的 stdin、stdout 和 stderr 来展示子进程执行的信息，缺乏之间的数据互通性，这也是导致`exec`和`execFile`可使用的场景有限，而`fork`会带一个 ipc 参数给 stdio 参数（可以回过去翻翻 fork 源码），所以可以执行父子进程的通信操作，比如 send 方法等，具体的实现可以看`setupChannel`。\n\n<br/>\n\n<br/>\n\n**综上，**Node.js 在`child_process`里创建进程的流程大致梳理了下，在 JavaScript 层面并没有什么复杂的，在 libuv 层面注册了很多相关的事件，有空可以研究研究。之后会写一篇关于 cluster.fork 的介绍，其实就是对 child_process.fork 更多的封装。\n","slug":"child_process-exec-fork-spawn","published":1,"updated":"2020-07-07T10:11:25.586Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs5w000ad12irl0yaj38","content":"<p><strong>Node.js 创建子进程的方法常用的有如下几种：</strong></p>\n<p><strong>child_process</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback\" target=\"_blank\" rel=\"noopener\">exec</a>: 衍生一个 shell 然后在该 shell 中执行 <code>command</code>，并缓冲任何产生的输出，最大缓存 1024*1024 个字节。</li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback\" target=\"_blank\" rel=\"noopener\">execFile</a>: 函数类似<code>exec</code>，但默认情况下不会衍生 shell。 相反，指定的可执行文件<code>file</code> 会作为新进程直接地衍生，使其比<code>exec</code> 稍微更高效。和<code>exec</code>一样，它也有最大 1024*1204 个字节的显示缓存。</li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options\" target=\"_blank\" rel=\"noopener\">fork</a>: 是 <code>spawn</code>的一个特例，专门用于衍生新的 Node.js 进程。 与<code>spawn</code>一样返回<code>ChildProcess</code>对象。 返回的<code>ChildProcess</code>将会内置一个额外的通信通道，允许消息在父进程和子进程之间来回传递。</li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options\" target=\"_blank\" rel=\"noopener\">spawn</a>: 上诉的几个方法其实都是通过 spawn 实现的。</li>\n</ul>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\" target=\"_blank\" rel=\"noopener\">fork</a>: 衍生出一个新的工作进程，这只能通过主进程调用。</li>\n</ul>\n<a id=\"more\"></a>\n<p><br></p>\n<h3 id=\"翻翻源码看看他们怎么实现的\"><a href=\"#翻翻源码看看他们怎么实现的\" class=\"headerlink\" title=\"翻翻源码看看他们怎么实现的\"></a><strong>翻翻源码看看他们怎么实现的</strong></h3><p>源码版本和之前的<a href=\"https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/\" target=\"_blank\" rel=\"noopener\">libuv &amp; Node.js EventLoop （一）</a>一样</p>\n<figure class=\"highlight markdown hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p><strong>child_process</strong>源码位置</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Node </span><br><span class=\"line\">  - lib </span><br><span class=\"line\">  \t- internal </span><br><span class=\"line\">  \t\t- child_process.js </span><br><span class=\"line\">  \t- child_process.js;</span><br></pre></td></tr></table></figure>\n<p>在<code>lib/child_process.js</code>文件中，定义了<code>exec</code>、<code>execFile</code>、<code>fork</code>和<code>spawn</code>等方法，它们最后都会调用在<code>lib/internal/child_process.js</code>文件中的<code>spawn</code>方法。</p>\n<p><br></p>\n<p><strong>exec</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">exec</span>(<span class=\"hljs-params\">command, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> opts = normalizeExecArgs(command, options, callback);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">module</span>.exports.execFile(opts.file, opts.options, opts.callback);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">normalizeExecArgs</span>(<span class=\"hljs-params\">command, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> options === <span class=\"hljs-string\">\"function\"</span>) &#123;</span><br><span class=\"line\">    callback = options;</span><br><span class=\"line\">    options = <span class=\"hljs-literal\">undefined</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Make a shallow copy so we don't clobber the user's options object.</span></span><br><span class=\"line\">  options = &#123; ...options &#125;;</span><br><span class=\"line\">  options.shell = <span class=\"hljs-keyword\">typeof</span> options.shell === <span class=\"hljs-string\">\"string\"</span> ? options.shell : <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> &#123;</span><br><span class=\"line\">    file: command,</span><br><span class=\"line\">    options: options,</span><br><span class=\"line\">    callback: callback,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>从上面发现 exec 其实就是封装了参数，主要是开启<code>shell</code>参数，然后调用 execFile 方法。</p>\n<p><br></p>\n<p><strong>execFile</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">execFile</span>(<span class=\"hljs-params\">file <span class=\"hljs-regexp\">/* , args, options, callback */</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> args = [];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> callback;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> options;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  options = &#123;</span><br><span class=\"line\">    encoding: <span class=\"hljs-string\">\"utf8\"</span>,</span><br><span class=\"line\">    timeout: <span class=\"hljs-number\">0</span>,</span><br><span class=\"line\">    maxBuffer: MAX_BUFFER,</span><br><span class=\"line\">    killSignal: <span class=\"hljs-string\">\"SIGTERM\"</span>,</span><br><span class=\"line\">    cwd: <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">    env: <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">    shell: <span class=\"hljs-literal\">false</span>, <span class=\"hljs-comment\">// execFile 默认是不开启shell</span></span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 通过spawn方法创建子进程</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> child = spawn(file, args, &#123;</span><br><span class=\"line\">    cwd: options.cwd,</span><br><span class=\"line\">    env: options.env,</span><br><span class=\"line\">    gid: options.gid,</span><br><span class=\"line\">    uid: options.uid,</span><br><span class=\"line\">    shell: options.shell,</span><br><span class=\"line\">    windowsHide: !!options.windowsHide,</span><br><span class=\"line\">    windowsVerbatimArguments: !!options.windowsVerbatimArguments,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> encoding;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> _stdout = []; <span class=\"hljs-comment\">// 输出的内容</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> _stderr = []; <span class=\"hljs-comment\">// 出错的内容</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> stdoutLen = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// 输出内容的长度</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> stderrLen = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// 出错内容的长度</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> killed = <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">// 是否已经被杀死</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> exited = <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">// 是否已经退出</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> timeoutId; <span class=\"hljs-comment\">// 是否有定时器</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> ex = <span class=\"hljs-literal\">null</span>; <span class=\"hljs-comment\">// 出错的上下文对象</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> cmd = file; <span class=\"hljs-comment\">// 命令或文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 退出回调方法</span></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">exithandler</span>(<span class=\"hljs-params\">code, signal</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (exited) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    exited = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (timeoutId) &#123;</span><br><span class=\"line\">      clearTimeout(timeoutId);</span><br><span class=\"line\">      timeoutId = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!callback) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// merge chunks</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> stdout;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> stderr;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding || (child.stdout &amp;&amp; child.stdout.readableEncoding)) &#123;</span><br><span class=\"line\">      stdout = _stdout.join(<span class=\"hljs-string\">\"\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">      stdout = Buffer.concat(_stdout); <span class=\"hljs-comment\">// 如果不传入 encoding 参数，默认是Buffer拼接输出</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding || (child.stderr &amp;&amp; child.stderr.readableEncoding)) &#123;</span><br><span class=\"line\">      stderr = _stderr.join(<span class=\"hljs-string\">\"\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">      stderr = Buffer.concat(_stderr); <span class=\"hljs-comment\">// 如果不传入 encoding 参数，默认是Buffer拼接输出</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!ex &amp;&amp; code === <span class=\"hljs-number\">0</span> &amp;&amp; signal === <span class=\"hljs-literal\">null</span>) &#123;</span><br><span class=\"line\">      callback(<span class=\"hljs-literal\">null</span>, stdout, stderr); <span class=\"hljs-comment\">// 没有错误，执行回调</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (args.length !== <span class=\"hljs-number\">0</span>) cmd += <span class=\"hljs-string\">` <span class=\"hljs-subst\">$&#123;args.join(<span class=\"hljs-string\">\" \"</span>)&#125;</span>`</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!ex) &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// eslint-disable-next-line no-restricted-syntax</span></span><br><span class=\"line\">      ex = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Error</span>(<span class=\"hljs-string\">\"Command failed: \"</span> + cmd + <span class=\"hljs-string\">\"\\n\"</span> + stderr);</span><br><span class=\"line\">      ex.killed = child.killed || killed;</span><br><span class=\"line\">      ex.code = code &lt; <span class=\"hljs-number\">0</span> ? getSystemErrorName(code) : code;</span><br><span class=\"line\">      ex.signal = signal;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ex.cmd = cmd;</span><br><span class=\"line\">    callback(ex, stdout, stderr); <span class=\"hljs-comment\">// 有错误，执行回调</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorhandler</span>(<span class=\"hljs-params\">e</span>) </span>&#123;</span><br><span class=\"line\">    ex = e;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// child.stdout 和 child.stderr 都销毁</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.stdout) child.stdout.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.stderr) child.stderr.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    exithandler();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">kill</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.stdout) child.stdout.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.stderr) child.stderr.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    killed = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">      child.kill(options.killSignal);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">      ex = e;</span><br><span class=\"line\">      exithandler();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 如果定义了子进程的超时时间，就定时销毁它</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (options.timeout &gt; <span class=\"hljs-number\">0</span>) &#123;</span><br><span class=\"line\">    timeoutId = setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">delayedKill</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">      kill();</span><br><span class=\"line\">      timeoutId = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">    &#125;, options.timeout);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (child.stdout) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding) child.stdout.setEncoding(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.stdout.on(<span class=\"hljs-string\">\"data\"</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">onChildStdout</span>(<span class=\"hljs-params\">chunk</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> encoding = child.stdout.readableEncoding;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? Buffer.byteLength(chunk, encoding)</span><br><span class=\"line\">        : chunk.length;</span><br><span class=\"line\">      stdoutLen += length; <span class=\"hljs-comment\">// 不断累加输出的长度</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (stdoutLen &gt; options.maxBuffer) &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// 超过的话就报错</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> truncatedLen = options.maxBuffer - (stdoutLen - length);</span><br><span class=\"line\">        _stdout.push(chunk.slice(<span class=\"hljs-number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"hljs-keyword\">new</span> ERR_CHILD_PROCESS_STDIO_MAXBUFFER(<span class=\"hljs-string\">\"stdout\"</span>);</span><br><span class=\"line\">        kill();</span><br><span class=\"line\">      &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">        _stdout.push(chunk); <span class=\"hljs-comment\">// 不断累积chunk</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 整体逻辑和上面的child.stdout基本一致</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (child.stderr) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding) child.stderr.setEncoding(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.stderr.on(<span class=\"hljs-string\">\"data\"</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">onChildStderr</span>(<span class=\"hljs-params\">chunk</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> encoding = child.stderr.readableEncoding;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? Buffer.byteLength(chunk, encoding)</span><br><span class=\"line\">        : chunk.length;</span><br><span class=\"line\">      stderrLen += length;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (stderrLen &gt; options.maxBuffer) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> truncatedLen = options.maxBuffer - (stderrLen - length);</span><br><span class=\"line\">        _stderr.push(chunk.slice(<span class=\"hljs-number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"hljs-keyword\">new</span> ERR_CHILD_PROCESS_STDIO_MAXBUFFER(<span class=\"hljs-string\">\"stderr\"</span>);</span><br><span class=\"line\">        kill();</span><br><span class=\"line\">      &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">        _stderr.push(chunk);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  child.addListener(<span class=\"hljs-string\">\"close\"</span>, exithandler);</span><br><span class=\"line\">  child.addListener(<span class=\"hljs-string\">\"error\"</span>, errorhandler);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> child;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>exec</code>和<code>execFile</code>最大的一个区别就是参数<code>shell</code>默认是否开启，其它基本都是相同的。另外，它们对输出的内容有大小限制是在<code>child.stderr.on(&#39;data&#39;)</code>和<code>child.stdout.on(&#39;data&#39;)</code>获取数据时候被限制。</p>\n<p>如果不做类似的规定，<code>_stderr</code>和<code>_stdout</code>无限被输出，那么内存会不断的膨胀导致性能问题，甚至程序奔溃。（这是我猜的原因）</p>\n<p>另外说到底，<strong>最后还是对<code>spawn</code>方法的封装了调用。</strong></p>\n<p><br></p>\n<p><strong>fork</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">fork</span>(<span class=\"hljs-params\">modulePath <span class=\"hljs-regexp\">/* , args, options */</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// Get options and args arguments.</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> execArgv;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> options = &#123;&#125;;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> args = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// fork方法的stdio参数，必须带有一个ipc参数</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> options.stdio === <span class=\"hljs-string\">\"string\"</span>) &#123;</span><br><span class=\"line\">    options.stdio = stdioStringToArray(options.stdio, <span class=\"hljs-string\">\"ipc\"</span>);</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-built_in\">Array</span>.isArray(options.stdio)) &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// and stderr from the parent if silent isn't set.</span></span><br><span class=\"line\">    options.stdio = stdioStringToArray(</span><br><span class=\"line\">      options.silent ? <span class=\"hljs-string\">\"pipe\"</span> : <span class=\"hljs-string\">\"inherit\"</span>,</span><br><span class=\"line\">      <span class=\"hljs-string\">\"ipc\"</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!options.stdio.includes(<span class=\"hljs-string\">\"ipc\"</span>)) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> ERR_CHILD_PROCESS_IPC_REQUIRED(<span class=\"hljs-string\">\"options.stdio\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  options.execPath = options.execPath || process.execPath; <span class=\"hljs-comment\">// 默认用父进程的Node执行文件</span></span><br><span class=\"line\">  options.shell = <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">// 不开启 shell</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> spawn(options.execPath, args, options);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>从上面代码有个非常引人注意就是 12~22 行，fork 方法的 stdio 参数，必须带有一个 ipc 参数，这个<code>ipc</code>的作用将在后续深入挖掘后介绍。最后也是调用<code>spawn</code>创建子进程。</p>\n<p><br></p>\n<p><strong>spawn</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">spawn</span>(<span class=\"hljs-params\">file, args, options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> child = <span class=\"hljs-keyword\">new</span> ChildProcess();</span><br><span class=\"line\"></span><br><span class=\"line\">  options = normalizeSpawnArguments(file, args, options);</span><br><span class=\"line\">  debug(<span class=\"hljs-string\">\"spawn\"</span>, options);</span><br><span class=\"line\">  child.spawn(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> child;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>lib/child_process.js</code>里的 spawn 方法就简单的将传入的参数做整理，然后直接调用 ChildProcess 实例对象的 spawn。</p>\n<p><br></p>\n<p><strong>ChildProcess</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// `lib/internal/child_process.js`</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">ChildProcess</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  EventEmitter.call(<span class=\"hljs-keyword\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>._handle = <span class=\"hljs-keyword\">new</span> Process(); <span class=\"hljs-comment\">// new 出一个 ProcessWrap 对象 （ process_wrap.cc）</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">ChildProcess.prototype.spawn = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 默认使用 pipe</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> stdio = options.stdio || <span class=\"hljs-string\">\"pipe\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 重置stdio变量，这个是个很重要的方法，后续将继续介绍</span></span><br><span class=\"line\">  stdio = getValidStdio(stdio, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> ipc = stdio.ipc;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> ipcFd = stdio.ipcFd;</span><br><span class=\"line\">  stdio = options.stdio = stdio.stdio;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 调用ProcessWrap对应的spawn去创建新进程</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> err = <span class=\"hljs-keyword\">this</span>._handle.spawn(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 如果err存在，就会有相关代码处理创建子进程出错的场景</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.pid = <span class=\"hljs-keyword\">this</span>._handle.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; stdio.length; i++) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> stream = stdio[i];</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (stream.handle) &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// When i === 0 - we're dealing with stdin</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// (which is the only one writable pipe).</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// 创建 socket</span></span><br><span class=\"line\">      stream.socket = createSocket(</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.pid !== <span class=\"hljs-number\">0</span> ? stream.handle : <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">        i &gt; <span class=\"hljs-number\">0</span></span><br><span class=\"line\">      );</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (i &gt; <span class=\"hljs-number\">0</span> &amp;&amp; <span class=\"hljs-keyword\">this</span>.pid !== <span class=\"hljs-number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>._closesNeeded++;</span><br><span class=\"line\">        stream.socket.on(<span class=\"hljs-string\">\"close\"</span>, () =&gt; &#123;</span><br><span class=\"line\">          maybeClose(<span class=\"hljs-keyword\">this</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.stdin =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"hljs-number\">1</span> &amp;&amp; stdio[<span class=\"hljs-number\">0</span>].socket !== <span class=\"hljs-literal\">undefined</span> ? stdio[<span class=\"hljs-number\">0</span>].socket : <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.stdout =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"hljs-number\">2</span> &amp;&amp; stdio[<span class=\"hljs-number\">1</span>].socket !== <span class=\"hljs-literal\">undefined</span> ? stdio[<span class=\"hljs-number\">1</span>].socket : <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.stderr =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"hljs-number\">3</span> &amp;&amp; stdio[<span class=\"hljs-number\">2</span>].socket !== <span class=\"hljs-literal\">undefined</span> ? stdio[<span class=\"hljs-number\">2</span>].socket : <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.stdio = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; stdio.length; i++)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.stdio.push(stdio[i].socket === <span class=\"hljs-literal\">undefined</span> ? <span class=\"hljs-literal\">null</span> : stdio[i].socket);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Add .send() method and start listening for IPC data</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// setupChannel 方法很长，主要就是实现了数据的发送和接受</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (ipc !== <span class=\"hljs-literal\">undefined</span>) setupChannel(<span class=\"hljs-keyword\">this</span>, ipc);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> err;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">stdioStringToArray</span>(<span class=\"hljs-params\">stdio, channel</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// 主要将stdio参数格式化为[xxx,xxx,xxx]形式的数组</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 如果有channel，[xxx,xxx,xxx,channel]</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getValidStdio</span>(<span class=\"hljs-params\">stdio, sync</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> ipc;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> ipcFd;</span><br><span class=\"line\"></span><br><span class=\"line\">  stdio = stdio.reduce(<span class=\"hljs-function\">(<span class=\"hljs-params\">acc, stdio, i</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">cleanup</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; acc.length; i++) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> ((acc[i].type === <span class=\"hljs-string\">\"pipe\"</span> || acc[i].type === <span class=\"hljs-string\">\"ipc\"</span>) &amp;&amp; acc[i].handle)</span><br><span class=\"line\">          acc[i].handle.close();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"ignore\"</span>) &#123;</span><br><span class=\"line\">      acc.push(&#123; <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">\"ignore\"</span> &#125;); <span class=\"hljs-comment\">// 子进程的输出不需要在控制台显示</span></span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"pipe\"</span> || (<span class=\"hljs-keyword\">typeof</span> stdio === <span class=\"hljs-string\">\"number\"</span> &amp;&amp; stdio &lt; <span class=\"hljs-number\">0</span>)) &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">var</span> a = &#123;</span><br><span class=\"line\">        type: <span class=\"hljs-string\">\"pipe\"</span>,</span><br><span class=\"line\">        readable: i === <span class=\"hljs-number\">0</span>, <span class=\"hljs-comment\">// 0是stdin，需要读</span></span><br><span class=\"line\">        writable: i !== <span class=\"hljs-number\">0</span>, <span class=\"hljs-comment\">// 1是stdout，2是stderr 需要写</span></span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// spawn 调用的时候，sync为false，为stdin、stdout、stderr创建一个SOCKET类型Pipe</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (!sync) a.handle = <span class=\"hljs-keyword\">new</span> Pipe(PipeConstants.SOCKET);</span><br><span class=\"line\"></span><br><span class=\"line\">      acc.push(a);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"ipc\"</span>) &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// 创建一个IPC类型Pipe</span></span><br><span class=\"line\">      ipc = <span class=\"hljs-keyword\">new</span> Pipe(PipeConstants.IPC);</span><br><span class=\"line\">      ipcFd = i; <span class=\"hljs-comment\">// ipc位置</span></span><br><span class=\"line\"></span><br><span class=\"line\">      acc.push(&#123;</span><br><span class=\"line\">        type: <span class=\"hljs-string\">\"pipe\"</span>,</span><br><span class=\"line\">        handle: ipc,</span><br><span class=\"line\">        ipc: <span class=\"hljs-literal\">true</span>,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"inherit\"</span>) &#123;</span><br><span class=\"line\">      acc.push(&#123;</span><br><span class=\"line\">        type: <span class=\"hljs-string\">\"inherit\"</span>,</span><br><span class=\"line\">        fd: i,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...还有很多代码，不在讨论范围</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> acc;</span><br><span class=\"line\">  &#125;, []);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> &#123; stdio, ipc, ipcFd &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>ChildProcess</code>并不能直接创建新的进程，需要底层 V8 的帮助，在构造函数里面直接 new ProcessWrap 赋给了 this._handle。</p>\n<p><code>ChildProcess.prototype.spawn</code>开始主要处理主要的<a href=\"http://nodejs.cn/api/child_process.html#child_process_options_stdio\" target=\"_blank\" rel=\"noopener\"><code>stdio</code></a>参数，明确父子进程通过哪些方式来获取数据信息，官方文档给出了一些示例，如果不清楚可以多做点实验。如果是<code>pipe</code>或者是<code>ipc</code>都会实例化一个 Pipe 对象，只是参数类型不同。</p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// pipe_wrap.cc</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">void</span> PipeWrap::New(<span class=\"hljs-keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args) &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">switch</span> (type) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">case</span> SOCKET:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">case</span> IPC:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">new</span> PipeWrap(env, args.This(), provider, ipc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">PipeWrap::PipeWrap(Environment* env,</span><br><span class=\"line\">                   Local&lt;Object&gt; object,</span><br><span class=\"line\">                   ProviderType provider,</span><br><span class=\"line\">                   <span class=\"hljs-keyword\">bool</span> ipc)</span><br><span class=\"line\">    : ConnectionWrap(env, object, provider) &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">int</span> r = uv_pipe_init(env-&gt;event_loop(), &amp;handle_, ipc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// deps/uv/src/unix/pipe.c</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">uv_pipe_init</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop, <span class=\"hljs-keyword\">uv_pipe_t</span>* handle, <span class=\"hljs-keyword\">int</span> ipc)</span> </span>&#123;</span><br><span class=\"line\">  uv__stream_init(loop, (<span class=\"hljs-keyword\">uv_stream_t</span>*)handle, UV_NAMED_PIPE);</span><br><span class=\"line\">  handle-&gt;shutdown_req = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;connect_req = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;pipe_fname = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;ipc = ipc;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>它们唯一的区别就是<code>uv_pipe_t</code>的 ipc 参数是 true 还是 false，<strong>所有的事件都被老老实实的绑定在 libuv 上</strong>。</p>\n<p>回到<code>ChildProcess.prototype.spawn</code>中，已经重置了 stdio 参数后，到了真正创建子进程的地方了，<code>this._handle.spawn(options);</code>，通过<code>process_wrap.cc</code>里的 ProcessWrap.Spawn 去创建，整个创建方法也极长，主要是对传入的参数进行处理，然后再调用<code>uv_spawn</code>。</p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// deps/uv/src/unix/process.c</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">uv_spawn</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">             <span class=\"hljs-keyword\">uv_process_t</span>* process,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">             <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">uv_process_options_t</span>* options)</span> </span>&#123;</span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">if</span> defined(__APPLE__) &amp;&amp; (TARGET_OS_TV || TARGET_OS_WATCH)</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> UV_ENOSYS;</span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">else</span></span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  uv_signal_start(&amp;loop-&gt;child_watcher, uv__chld, SIGCHLD);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* Acquire write lock to prevent opening new fds in worker threads */</span></span><br><span class=\"line\">  uv_rwlock_wrlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  pid = fork();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (pid == <span class=\"hljs-number\">-1</span>) &#123;</span><br><span class=\"line\">    err = UV__ERR(errno);</span><br><span class=\"line\">    uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"hljs-number\">0</span>]);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"hljs-number\">1</span>]);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">goto</span> error;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (pid == <span class=\"hljs-number\">0</span>) &#123;</span><br><span class=\"line\">    uv__process_child_init(options, stdio_count, pipes, signal_pipe[<span class=\"hljs-number\">1</span>]);</span><br><span class=\"line\">    <span class=\"hljs-built_in\">abort</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* Release lock in parent process */</span></span><br><span class=\"line\">  uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  uv__close(signal_pipe[<span class=\"hljs-number\">1</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过系统层面的<code>fork</code>函数创建子进程，由于 fork 的特殊性，一次调用返回二次，当返回 0 的时候回执行子进程的逻辑，回去通过<code>uv__process_child_init</code>初始化整个子进程的上下文信息。</p>\n<p>再回到<code>ChildProcess.prototype.spawn</code>中，遍历<code>stdio</code>，如果成员有 handle 字段，就通过<code>createSocket</code>为其创建一个 socket 对象</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">createSocket</span>(<span class=\"hljs-params\">pipe, readable</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> net.Socket(&#123; <span class=\"hljs-attr\">handle</span>: pipe, readable, <span class=\"hljs-attr\">writable</span>: !readable &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>无论是参数<code>stdio</code>是 pipe 还是 ipc 都会创建 socket，在父子进程通信的时候，父进程通过子进程暴露出来的 stdin、stdout 和 stderr 来展示子进程执行的信息，缺乏之间的数据互通性，这也是导致<code>exec</code>和<code>execFile</code>可使用的场景有限，而<code>fork</code>会带一个 ipc 参数给 stdio 参数（可以回过去翻翻 fork 源码），所以可以执行父子进程的通信操作，比如 send 方法等，具体的实现可以看<code>setupChannel</code>。</p>\n<p><br></p>\n<p><br></p>\n<p><strong>综上，</strong>Node.js 在<code>child_process</code>里创建进程的流程大致梳理了下，在 JavaScript 层面并没有什么复杂的，在 libuv 层面注册了很多相关的事件，有空可以研究研究。之后会写一篇关于 cluster.fork 的介绍，其实就是对 child_process.fork 更多的封装。</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p><strong>Node.js 创建子进程的方法常用的有如下几种：</strong></p>\n<p><strong>child_process</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback\" target=\"_blank\" rel=\"noopener\">exec</a>: 衍生一个 shell 然后在该 shell 中执行 <code>command</code>，并缓冲任何产生的输出，最大缓存 1024*1024 个字节。</li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback\" target=\"_blank\" rel=\"noopener\">execFile</a>: 函数类似<code>exec</code>，但默认情况下不会衍生 shell。 相反，指定的可执行文件<code>file</code> 会作为新进程直接地衍生，使其比<code>exec</code> 稍微更高效。和<code>exec</code>一样，它也有最大 1024*1204 个字节的显示缓存。</li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options\" target=\"_blank\" rel=\"noopener\">fork</a>: 是 <code>spawn</code>的一个特例，专门用于衍生新的 Node.js 进程。 与<code>spawn</code>一样返回<code>ChildProcess</code>对象。 返回的<code>ChildProcess</code>将会内置一个额外的通信通道，允许消息在父进程和子进程之间来回传递。</li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options\" target=\"_blank\" rel=\"noopener\">spawn</a>: 上诉的几个方法其实都是通过 spawn 实现的。</li>\n</ul>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\" target=\"_blank\" rel=\"noopener\">fork</a>: 衍生出一个新的工作进程，这只能通过主进程调用。</li>\n</ul>","more":"<p><br></p>\n<h3 id=\"翻翻源码看看他们怎么实现的\"><a href=\"#翻翻源码看看他们怎么实现的\" class=\"headerlink\" title=\"翻翻源码看看他们怎么实现的\"></a><strong>翻翻源码看看他们怎么实现的</strong></h3><p>源码版本和之前的<a href=\"https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/\" target=\"_blank\" rel=\"noopener\">libuv &amp; Node.js EventLoop （一）</a>一样</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"section\">#define V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"section\">#define V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"section\">#define V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"section\">#define V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"section\">#define NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"section\">#define NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"section\">#define NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p><strong>child_process</strong>源码位置</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Node </span><br><span class=\"line\">  - lib </span><br><span class=\"line\">  \t- internal </span><br><span class=\"line\">  \t\t- child_process.js </span><br><span class=\"line\">  \t- child_process.js;</span><br></pre></td></tr></table></figure>\n<p>在<code>lib/child_process.js</code>文件中，定义了<code>exec</code>、<code>execFile</code>、<code>fork</code>和<code>spawn</code>等方法，它们最后都会调用在<code>lib/internal/child_process.js</code>文件中的<code>spawn</code>方法。</p>\n<p><br></p>\n<p><strong>exec</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">exec</span>(<span class=\"params\">command, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> opts = normalizeExecArgs(command, options, callback);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">module</span>.exports.execFile(opts.file, opts.options, opts.callback);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">normalizeExecArgs</span>(<span class=\"params\">command, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options === <span class=\"string\">\"function\"</span>) &#123;</span><br><span class=\"line\">    callback = options;</span><br><span class=\"line\">    options = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Make a shallow copy so we don't clobber the user's options object.</span></span><br><span class=\"line\">  options = &#123; ...options &#125;;</span><br><span class=\"line\">  options.shell = <span class=\"keyword\">typeof</span> options.shell === <span class=\"string\">\"string\"</span> ? options.shell : <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">    file: command,</span><br><span class=\"line\">    options: options,</span><br><span class=\"line\">    callback: callback,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>从上面发现 exec 其实就是封装了参数，主要是开启<code>shell</code>参数，然后调用 execFile 方法。</p>\n<p><br></p>\n<p><strong>execFile</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">execFile</span>(<span class=\"params\">file <span class=\"regexp\">/* , args, options, callback */</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> args = [];</span><br><span class=\"line\">  <span class=\"keyword\">let</span> callback;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> options;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  options = &#123;</span><br><span class=\"line\">    encoding: <span class=\"string\">\"utf8\"</span>,</span><br><span class=\"line\">    timeout: <span class=\"number\">0</span>,</span><br><span class=\"line\">    maxBuffer: MAX_BUFFER,</span><br><span class=\"line\">    killSignal: <span class=\"string\">\"SIGTERM\"</span>,</span><br><span class=\"line\">    cwd: <span class=\"literal\">null</span>,</span><br><span class=\"line\">    env: <span class=\"literal\">null</span>,</span><br><span class=\"line\">    shell: <span class=\"literal\">false</span>, <span class=\"comment\">// execFile 默认是不开启shell</span></span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 通过spawn方法创建子进程</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> child = spawn(file, args, &#123;</span><br><span class=\"line\">    cwd: options.cwd,</span><br><span class=\"line\">    env: options.env,</span><br><span class=\"line\">    gid: options.gid,</span><br><span class=\"line\">    uid: options.uid,</span><br><span class=\"line\">    shell: options.shell,</span><br><span class=\"line\">    windowsHide: !!options.windowsHide,</span><br><span class=\"line\">    windowsVerbatimArguments: !!options.windowsVerbatimArguments,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> encoding;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> _stdout = []; <span class=\"comment\">// 输出的内容</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> _stderr = []; <span class=\"comment\">// 出错的内容</span></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> stdoutLen = <span class=\"number\">0</span>; <span class=\"comment\">// 输出内容的长度</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> stderrLen = <span class=\"number\">0</span>; <span class=\"comment\">// 出错内容的长度</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> killed = <span class=\"literal\">false</span>; <span class=\"comment\">// 是否已经被杀死</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> exited = <span class=\"literal\">false</span>; <span class=\"comment\">// 是否已经退出</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> timeoutId; <span class=\"comment\">// 是否有定时器</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> ex = <span class=\"literal\">null</span>; <span class=\"comment\">// 出错的上下文对象</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> cmd = file; <span class=\"comment\">// 命令或文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 退出回调方法</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">exithandler</span>(<span class=\"params\">code, signal</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (exited) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    exited = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeoutId) &#123;</span><br><span class=\"line\">      clearTimeout(timeoutId);</span><br><span class=\"line\">      timeoutId = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!callback) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// merge chunks</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> stdout;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> stderr;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding || (child.stdout &amp;&amp; child.stdout.readableEncoding)) &#123;</span><br><span class=\"line\">      stdout = _stdout.join(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      stdout = Buffer.concat(_stdout); <span class=\"comment\">// 如果不传入 encoding 参数，默认是Buffer拼接输出</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding || (child.stderr &amp;&amp; child.stderr.readableEncoding)) &#123;</span><br><span class=\"line\">      stderr = _stderr.join(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      stderr = Buffer.concat(_stderr); <span class=\"comment\">// 如果不传入 encoding 参数，默认是Buffer拼接输出</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ex &amp;&amp; code === <span class=\"number\">0</span> &amp;&amp; signal === <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">      callback(<span class=\"literal\">null</span>, stdout, stderr); <span class=\"comment\">// 没有错误，执行回调</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (args.length !== <span class=\"number\">0</span>) cmd += <span class=\"string\">` <span class=\"subst\">$&#123;args.join(<span class=\"string\">\" \"</span>)&#125;</span>`</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ex) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// eslint-disable-next-line no-restricted-syntax</span></span><br><span class=\"line\">      ex = <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">\"Command failed: \"</span> + cmd + <span class=\"string\">\"\\n\"</span> + stderr);</span><br><span class=\"line\">      ex.killed = child.killed || killed;</span><br><span class=\"line\">      ex.code = code &lt; <span class=\"number\">0</span> ? getSystemErrorName(code) : code;</span><br><span class=\"line\">      ex.signal = signal;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ex.cmd = cmd;</span><br><span class=\"line\">    callback(ex, stdout, stderr); <span class=\"comment\">// 有错误，执行回调</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorhandler</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">    ex = e;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// child.stdout 和 child.stderr 都销毁</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.stdout) child.stdout.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.stderr) child.stderr.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    exithandler();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">kill</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.stdout) child.stdout.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.stderr) child.stderr.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    killed = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      child.kill(options.killSignal);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">      ex = e;</span><br><span class=\"line\">      exithandler();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 如果定义了子进程的超时时间，就定时销毁它</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (options.timeout &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    timeoutId = setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">delayedKill</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      kill();</span><br><span class=\"line\">      timeoutId = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;, options.timeout);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (child.stdout) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding) child.stdout.setEncoding(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.stdout.on(<span class=\"string\">\"data\"</span>, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onChildStdout</span>(<span class=\"params\">chunk</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> encoding = child.stdout.readableEncoding;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? Buffer.byteLength(chunk, encoding)</span><br><span class=\"line\">        : chunk.length;</span><br><span class=\"line\">      stdoutLen += length; <span class=\"comment\">// 不断累加输出的长度</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (stdoutLen &gt; options.maxBuffer) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 超过的话就报错</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> truncatedLen = options.maxBuffer - (stdoutLen - length);</span><br><span class=\"line\">        _stdout.push(chunk.slice(<span class=\"number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"keyword\">new</span> ERR_CHILD_PROCESS_STDIO_MAXBUFFER(<span class=\"string\">\"stdout\"</span>);</span><br><span class=\"line\">        kill();</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        _stdout.push(chunk); <span class=\"comment\">// 不断累积chunk</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 整体逻辑和上面的child.stdout基本一致</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (child.stderr) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding) child.stderr.setEncoding(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.stderr.on(<span class=\"string\">\"data\"</span>, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onChildStderr</span>(<span class=\"params\">chunk</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> encoding = child.stderr.readableEncoding;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? Buffer.byteLength(chunk, encoding)</span><br><span class=\"line\">        : chunk.length;</span><br><span class=\"line\">      stderrLen += length;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (stderrLen &gt; options.maxBuffer) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> truncatedLen = options.maxBuffer - (stderrLen - length);</span><br><span class=\"line\">        _stderr.push(chunk.slice(<span class=\"number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"keyword\">new</span> ERR_CHILD_PROCESS_STDIO_MAXBUFFER(<span class=\"string\">\"stderr\"</span>);</span><br><span class=\"line\">        kill();</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        _stderr.push(chunk);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  child.addListener(<span class=\"string\">\"close\"</span>, exithandler);</span><br><span class=\"line\">  child.addListener(<span class=\"string\">\"error\"</span>, errorhandler);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> child;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>exec</code>和<code>execFile</code>最大的一个区别就是参数<code>shell</code>默认是否开启，其它基本都是相同的。另外，它们对输出的内容有大小限制是在<code>child.stderr.on(&#39;data&#39;)</code>和<code>child.stdout.on(&#39;data&#39;)</code>获取数据时候被限制。</p>\n<p>如果不做类似的规定，<code>_stderr</code>和<code>_stdout</code>无限被输出，那么内存会不断的膨胀导致性能问题，甚至程序奔溃。（这是我猜的原因）</p>\n<p>另外说到底，<strong>最后还是对<code>spawn</code>方法的封装了调用。</strong></p>\n<p><br></p>\n<p><strong>fork</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">fork</span>(<span class=\"params\">modulePath <span class=\"regexp\">/* , args, options */</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// Get options and args arguments.</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> execArgv;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> options = &#123;&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> args = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// fork方法的stdio参数，必须带有一个ipc参数</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options.stdio === <span class=\"string\">\"string\"</span>) &#123;</span><br><span class=\"line\">    options.stdio = stdioStringToArray(options.stdio, <span class=\"string\">\"ipc\"</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!<span class=\"built_in\">Array</span>.isArray(options.stdio)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,</span></span><br><span class=\"line\">    <span class=\"comment\">// and stderr from the parent if silent isn't set.</span></span><br><span class=\"line\">    options.stdio = stdioStringToArray(</span><br><span class=\"line\">      options.silent ? <span class=\"string\">\"pipe\"</span> : <span class=\"string\">\"inherit\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"ipc\"</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!options.stdio.includes(<span class=\"string\">\"ipc\"</span>)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ERR_CHILD_PROCESS_IPC_REQUIRED(<span class=\"string\">\"options.stdio\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  options.execPath = options.execPath || process.execPath; <span class=\"comment\">// 默认用父进程的Node执行文件</span></span><br><span class=\"line\">  options.shell = <span class=\"literal\">false</span>; <span class=\"comment\">// 不开启 shell</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> spawn(options.execPath, args, options);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>从上面代码有个非常引人注意就是 12~22 行，fork 方法的 stdio 参数，必须带有一个 ipc 参数，这个<code>ipc</code>的作用将在后续深入挖掘后介绍。最后也是调用<code>spawn</code>创建子进程。</p>\n<p><br></p>\n<p><strong>spawn</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">spawn</span>(<span class=\"params\">file, args, options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> child = <span class=\"keyword\">new</span> ChildProcess();</span><br><span class=\"line\"></span><br><span class=\"line\">  options = normalizeSpawnArguments(file, args, options);</span><br><span class=\"line\">  debug(<span class=\"string\">\"spawn\"</span>, options);</span><br><span class=\"line\">  child.spawn(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> child;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>lib/child_process.js</code>里的 spawn 方法就简单的将传入的参数做整理，然后直接调用 ChildProcess 实例对象的 spawn。</p>\n<p><br></p>\n<p><strong>ChildProcess</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// `lib/internal/child_process.js`</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ChildProcess</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  EventEmitter.call(<span class=\"keyword\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>._handle = <span class=\"keyword\">new</span> Process(); <span class=\"comment\">// new 出一个 ProcessWrap 对象 （ process_wrap.cc）</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">ChildProcess.prototype.spawn = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 默认使用 pipe</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> stdio = options.stdio || <span class=\"string\">\"pipe\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 重置stdio变量，这个是个很重要的方法，后续将继续介绍</span></span><br><span class=\"line\">  stdio = getValidStdio(stdio, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> ipc = stdio.ipc;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> ipcFd = stdio.ipcFd;</span><br><span class=\"line\">  stdio = options.stdio = stdio.stdio;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 调用ProcessWrap对应的spawn去创建新进程</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> err = <span class=\"keyword\">this</span>._handle.spawn(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 如果err存在，就会有相关代码处理创建子进程出错的场景</span></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.pid = <span class=\"keyword\">this</span>._handle.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; stdio.length; i++) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> stream = stdio[i];</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (stream.handle) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// When i === 0 - we're dealing with stdin</span></span><br><span class=\"line\">      <span class=\"comment\">// (which is the only one writable pipe).</span></span><br><span class=\"line\">      <span class=\"comment\">// 创建 socket</span></span><br><span class=\"line\">      stream.socket = createSocket(</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.pid !== <span class=\"number\">0</span> ? stream.handle : <span class=\"literal\">null</span>,</span><br><span class=\"line\">        i &gt; <span class=\"number\">0</span></span><br><span class=\"line\">      );</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (i &gt; <span class=\"number\">0</span> &amp;&amp; <span class=\"keyword\">this</span>.pid !== <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>._closesNeeded++;</span><br><span class=\"line\">        stream.socket.on(<span class=\"string\">\"close\"</span>, () =&gt; &#123;</span><br><span class=\"line\">          maybeClose(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.stdin =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"number\">1</span> &amp;&amp; stdio[<span class=\"number\">0</span>].socket !== <span class=\"literal\">undefined</span> ? stdio[<span class=\"number\">0</span>].socket : <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.stdout =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"number\">2</span> &amp;&amp; stdio[<span class=\"number\">1</span>].socket !== <span class=\"literal\">undefined</span> ? stdio[<span class=\"number\">1</span>].socket : <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.stderr =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"number\">3</span> &amp;&amp; stdio[<span class=\"number\">2</span>].socket !== <span class=\"literal\">undefined</span> ? stdio[<span class=\"number\">2</span>].socket : <span class=\"literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.stdio = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; stdio.length; i++)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.stdio.push(stdio[i].socket === <span class=\"literal\">undefined</span> ? <span class=\"literal\">null</span> : stdio[i].socket);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Add .send() method and start listening for IPC data</span></span><br><span class=\"line\">  <span class=\"comment\">// setupChannel 方法很长，主要就是实现了数据的发送和接受</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ipc !== <span class=\"literal\">undefined</span>) setupChannel(<span class=\"keyword\">this</span>, ipc);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> err;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">stdioStringToArray</span>(<span class=\"params\">stdio, channel</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 主要将stdio参数格式化为[xxx,xxx,xxx]形式的数组</span></span><br><span class=\"line\">  <span class=\"comment\">// 如果有channel，[xxx,xxx,xxx,channel]</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getValidStdio</span>(<span class=\"params\">stdio, sync</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ipc;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ipcFd;</span><br><span class=\"line\"></span><br><span class=\"line\">  stdio = stdio.reduce(<span class=\"function\">(<span class=\"params\">acc, stdio, i</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cleanup</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; acc.length; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((acc[i].type === <span class=\"string\">\"pipe\"</span> || acc[i].type === <span class=\"string\">\"ipc\"</span>) &amp;&amp; acc[i].handle)</span><br><span class=\"line\">          acc[i].handle.close();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (stdio === <span class=\"string\">\"ignore\"</span>) &#123;</span><br><span class=\"line\">      acc.push(&#123; <span class=\"attr\">type</span>: <span class=\"string\">\"ignore\"</span> &#125;); <span class=\"comment\">// 子进程的输出不需要在控制台显示</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (stdio === <span class=\"string\">\"pipe\"</span> || (<span class=\"keyword\">typeof</span> stdio === <span class=\"string\">\"number\"</span> &amp;&amp; stdio &lt; <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> a = &#123;</span><br><span class=\"line\">        type: <span class=\"string\">\"pipe\"</span>,</span><br><span class=\"line\">        readable: i === <span class=\"number\">0</span>, <span class=\"comment\">// 0是stdin，需要读</span></span><br><span class=\"line\">        writable: i !== <span class=\"number\">0</span>, <span class=\"comment\">// 1是stdout，2是stderr 需要写</span></span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">      <span class=\"comment\">// spawn 调用的时候，sync为false，为stdin、stdout、stderr创建一个SOCKET类型Pipe</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!sync) a.handle = <span class=\"keyword\">new</span> Pipe(PipeConstants.SOCKET);</span><br><span class=\"line\"></span><br><span class=\"line\">      acc.push(a);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (stdio === <span class=\"string\">\"ipc\"</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 创建一个IPC类型Pipe</span></span><br><span class=\"line\">      ipc = <span class=\"keyword\">new</span> Pipe(PipeConstants.IPC);</span><br><span class=\"line\">      ipcFd = i; <span class=\"comment\">// ipc位置</span></span><br><span class=\"line\"></span><br><span class=\"line\">      acc.push(&#123;</span><br><span class=\"line\">        type: <span class=\"string\">\"pipe\"</span>,</span><br><span class=\"line\">        handle: ipc,</span><br><span class=\"line\">        ipc: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (stdio === <span class=\"string\">\"inherit\"</span>) &#123;</span><br><span class=\"line\">      acc.push(&#123;</span><br><span class=\"line\">        type: <span class=\"string\">\"inherit\"</span>,</span><br><span class=\"line\">        fd: i,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// ...还有很多代码，不在讨论范围</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> acc;</span><br><span class=\"line\">  &#125;, []);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123; stdio, ipc, ipcFd &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>ChildProcess</code>并不能直接创建新的进程，需要底层 V8 的帮助，在构造函数里面直接 new ProcessWrap 赋给了 this._handle。</p>\n<p><code>ChildProcess.prototype.spawn</code>开始主要处理主要的<a href=\"http://nodejs.cn/api/child_process.html#child_process_options_stdio\" target=\"_blank\" rel=\"noopener\"><code>stdio</code></a>参数，明确父子进程通过哪些方式来获取数据信息，官方文档给出了一些示例，如果不清楚可以多做点实验。如果是<code>pipe</code>或者是<code>ipc</code>都会实例化一个 Pipe 对象，只是参数类型不同。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// pipe_wrap.cc</span></span><br><span class=\"line\"><span class=\"keyword\">void</span> PipeWrap::New(<span class=\"keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">switch</span> (type) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> SOCKET:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"literal\">false</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> IPC:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"literal\">true</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">new</span> PipeWrap(env, args.This(), provider, ipc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">PipeWrap::PipeWrap(Environment* env,</span><br><span class=\"line\">                   Local&lt;Object&gt; object,</span><br><span class=\"line\">                   ProviderType provider,</span><br><span class=\"line\">                   <span class=\"keyword\">bool</span> ipc)</span><br><span class=\"line\">    : ConnectionWrap(env, object, provider) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> r = uv_pipe_init(env-&gt;event_loop(), &amp;handle_, ipc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// deps/uv/src/unix/pipe.c</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">uv_pipe_init</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop, <span class=\"keyword\">uv_pipe_t</span>* handle, <span class=\"keyword\">int</span> ipc)</span> </span>&#123;</span><br><span class=\"line\">  uv__stream_init(loop, (<span class=\"keyword\">uv_stream_t</span>*)handle, UV_NAMED_PIPE);</span><br><span class=\"line\">  handle-&gt;shutdown_req = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;connect_req = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;pipe_fname = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;ipc = ipc;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>它们唯一的区别就是<code>uv_pipe_t</code>的 ipc 参数是 true 还是 false，<strong>所有的事件都被老老实实的绑定在 libuv 上</strong>。</p>\n<p>回到<code>ChildProcess.prototype.spawn</code>中，已经重置了 stdio 参数后，到了真正创建子进程的地方了，<code>this._handle.spawn(options);</code>，通过<code>process_wrap.cc</code>里的 ProcessWrap.Spawn 去创建，整个创建方法也极长，主要是对传入的参数进行处理，然后再调用<code>uv_spawn</code>。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// deps/uv/src/unix/process.c</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">uv_spawn</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">             <span class=\"keyword\">uv_process_t</span>* process,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">             <span class=\"keyword\">const</span> <span class=\"keyword\">uv_process_options_t</span>* options)</span> </span>&#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> defined(__APPLE__) &amp;&amp; (TARGET_OS_TV || TARGET_OS_WATCH)</span></span><br><span class=\"line\">  <span class=\"comment\">/* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> UV_ENOSYS;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">else</span></span></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  uv_signal_start(&amp;loop-&gt;child_watcher, uv__chld, SIGCHLD);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Acquire write lock to prevent opening new fds in worker threads */</span></span><br><span class=\"line\">  uv_rwlock_wrlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  pid = fork();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pid == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">    err = UV__ERR(errno);</span><br><span class=\"line\">    uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> error;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    uv__process_child_init(options, stdio_count, pipes, signal_pipe[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"built_in\">abort</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Release lock in parent process */</span></span><br><span class=\"line\">  uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  uv__close(signal_pipe[<span class=\"number\">1</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过系统层面的<code>fork</code>函数创建子进程，由于 fork 的特殊性，一次调用返回二次，当返回 0 的时候回执行子进程的逻辑，回去通过<code>uv__process_child_init</code>初始化整个子进程的上下文信息。</p>\n<p>再回到<code>ChildProcess.prototype.spawn</code>中，遍历<code>stdio</code>，如果成员有 handle 字段，就通过<code>createSocket</code>为其创建一个 socket 对象</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createSocket</span>(<span class=\"params\">pipe, readable</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> net.Socket(&#123; <span class=\"attr\">handle</span>: pipe, readable, <span class=\"attr\">writable</span>: !readable &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>无论是参数<code>stdio</code>是 pipe 还是 ipc 都会创建 socket，在父子进程通信的时候，父进程通过子进程暴露出来的 stdin、stdout 和 stderr 来展示子进程执行的信息，缺乏之间的数据互通性，这也是导致<code>exec</code>和<code>execFile</code>可使用的场景有限，而<code>fork</code>会带一个 ipc 参数给 stdio 参数（可以回过去翻翻 fork 源码），所以可以执行父子进程的通信操作，比如 send 方法等，具体的实现可以看<code>setupChannel</code>。</p>\n<p><br></p>\n<p><br></p>\n<p><strong>综上，</strong>Node.js 在<code>child_process</code>里创建进程的流程大致梳理了下，在 JavaScript 层面并没有什么复杂的，在 libuv 层面注册了很多相关的事件，有空可以研究研究。之后会写一篇关于 cluster.fork 的介绍，其实就是对 child_process.fork 更多的封装。</p>"},{"title":"Node.js 监控中心架构迭代","keywords":"Express,Gateway,Node.js 网关","description":"为了更好的做BFF层，最近看了一些网关资料，Node.js的网关类库相对薄弱很多。Express Gateway，背靠强大的Express社区，很多现成的中间件可以运用其中，省去了不少开发成本和风险。","date":"2020-04-02T23:17:29.367Z","_content":"\n之前写了一篇[收集 Node.js 应用的内存堆栈快照和 CPU 火焰图](https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/)文章，其中的架构非常粗糙，但是初步算是满足了现在的监控需求。不过随着业务的增长，单台**TCP Server**可定无法满足高可用的需求，一旦出现问题那就没办法持续使用了，所以需要一个重新设计和改造。\n\n<!-- more -->\n\n![粗糙的1.0版本](/images/monitor-hub/image-20200403185942130.png)\n\n**大致流程介绍：**\n\n一个 Docker 中，可能运行多个 Node.js 进程，比如 Egg.js 框架，另外`Helper Process`是用来做火焰图采集的，前面的文章提到过，目前它的功能相对单一应该被优化。\n\n所有的 Node.js 进程都会被看做事一个`Client`通过 TCP 长连接连入`Server`，他们做双向通信，Client 将心跳和监控数据（CPU、内存、EventLoop、GC 等）源源不断送入 Server 中，Server 将对用的数据存入到 ES 中。\n\n用户通过`Admin Web`可以查看每个应用的基础数据图表，发送生成内存堆栈信息和 CPU 火焰图的信息给指定的 Client，Client 生成文件后上传到`FS`（文件系统），之后 Admin Web 去 FS 上抓取该文件。\n\n**Q:为什么是这样一个粗糙的设计？**\n\n- 以快速上线去生产验证可用性为目标之一，尽量减少对其它系统的依赖，依赖`ES`是为了存数据、`FS`是为了存文件，过多的依赖对于部署上线还是测试链路都是增加成本，在人力有限的情况下拖的越久越容易杀死项目。\n\n**Q:为什么用长链接而不是短链接？**\n\n- 长链接的好处在简单模型下有个最大的好处就是我不需要去维护客户端是否存活，因为一旦客户端挂了，那么它就会自动断开，既能发送监控警报，又不需要做相关的治理工作，治理工作又是一个细活。\n- 另外客户端没有将数据集中定时批量发送，而是每次取到相关数据就发送给 Server。为了减少开销就用了长链接，自定义的协议传输效率也高。\n- 在开发过程中，长链接的开发模型比短连接复杂很多，不容易维护。\n\n**Q:目前遇到的问题和思考**\n\n- 单机 Server 一旦挂了就没办法继续监控，导致的风险极大，需要做集群，但是长链接并不适合做扩展，所以必须长改短。\n- 如果 Server 是集群，那势必需要 Client 去找到它，那么将引入`服务注册和发现`功能，比如 Eureka、Consul 等，将 Client、Server 和 Admin Web 连入。\n- 有了 Eureka、Consul 之类中间件，其实 Admin Web 可以直接通过它找到 Client，不过为了功能单一性，还是让 Server 转发用户命令。\n- 之前的 Helper Process 是在做火焰图时候临时加入，所有的`Worker Process`都是平等的 Client，在启动它的时候存在竞争问题，哪里一个 Client 去启动它呢？可以做一个类似 Egg.js 的启动命令，有 Master 进程、数个 Worker 进程已经一个 Helper Process。当然在 Egg.js 框架里，完全可以用 Agent 进程代替它，写个相关插件即可。\n- 如果所有的 Client 和 Helper Process 都在 Master 下，那么我们可以通过 Helper Process 代理将所有的 Client 基础数据批量上传到 Server，通过父进程 Master 做转发，这样也减轻了不断传数据的性能瓶颈；另外所有的 Client 注册到注册中心也不合适，也可以通过 Helper Process 代理，这样每个 Docker 就一个服务注册了。\n- 生成文件的过程是漫长的，不可能让短链接一直等，所以需要一个消息列队去通知 Admin Web，XXXX Client 的 XXXX 文件已经好了，让它去 FS 上拉取，需要引入 RMQ 等。\n- 为 Admin Web 可以方便获取 Client 列表，可以将注册中心里的服务信息格式处理后存在 Redis 中，这样就引入了 Redis，如果不平凡刷新这个列表可以每次读取注册中心里的数据做格式处理。\n\n![迭代2.0版本](/images/monitor-hub/image-20200403210837664.png)\n\n**综上思考**，Server 依旧做信息的存储和命令的转发工作，Admin Web 依旧是操作命令的入口，而整个 Client 端偏向 Egg.js 的风格。渐渐的整个监控中心就变得像一个微服务集群那样存在和运行，不同阶段有不同阶段的任务目标，讲不定之后会有新的挑战需要迭代。\n","source":"_posts/monitor-hub.md","raw":"---\ntitle: Node.js 监控中心架构迭代\ncategory: JavaScript\nkeywords: Express,Gateway,Node.js 网关\ndescription: 为了更好的做BFF层，最近看了一些网关资料，Node.js的网关类库相对薄弱很多。Express Gateway，背靠强大的Express社区，很多现成的中间件可以运用其中，省去了不少开发成本和风险。\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-04-03T07:17:29.367Z\n---\n\n之前写了一篇[收集 Node.js 应用的内存堆栈快照和 CPU 火焰图](https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/)文章，其中的架构非常粗糙，但是初步算是满足了现在的监控需求。不过随着业务的增长，单台**TCP Server**可定无法满足高可用的需求，一旦出现问题那就没办法持续使用了，所以需要一个重新设计和改造。\n\n<!-- more -->\n\n![粗糙的1.0版本](/images/monitor-hub/image-20200403185942130.png)\n\n**大致流程介绍：**\n\n一个 Docker 中，可能运行多个 Node.js 进程，比如 Egg.js 框架，另外`Helper Process`是用来做火焰图采集的，前面的文章提到过，目前它的功能相对单一应该被优化。\n\n所有的 Node.js 进程都会被看做事一个`Client`通过 TCP 长连接连入`Server`，他们做双向通信，Client 将心跳和监控数据（CPU、内存、EventLoop、GC 等）源源不断送入 Server 中，Server 将对用的数据存入到 ES 中。\n\n用户通过`Admin Web`可以查看每个应用的基础数据图表，发送生成内存堆栈信息和 CPU 火焰图的信息给指定的 Client，Client 生成文件后上传到`FS`（文件系统），之后 Admin Web 去 FS 上抓取该文件。\n\n**Q:为什么是这样一个粗糙的设计？**\n\n- 以快速上线去生产验证可用性为目标之一，尽量减少对其它系统的依赖，依赖`ES`是为了存数据、`FS`是为了存文件，过多的依赖对于部署上线还是测试链路都是增加成本，在人力有限的情况下拖的越久越容易杀死项目。\n\n**Q:为什么用长链接而不是短链接？**\n\n- 长链接的好处在简单模型下有个最大的好处就是我不需要去维护客户端是否存活，因为一旦客户端挂了，那么它就会自动断开，既能发送监控警报，又不需要做相关的治理工作，治理工作又是一个细活。\n- 另外客户端没有将数据集中定时批量发送，而是每次取到相关数据就发送给 Server。为了减少开销就用了长链接，自定义的协议传输效率也高。\n- 在开发过程中，长链接的开发模型比短连接复杂很多，不容易维护。\n\n**Q:目前遇到的问题和思考**\n\n- 单机 Server 一旦挂了就没办法继续监控，导致的风险极大，需要做集群，但是长链接并不适合做扩展，所以必须长改短。\n- 如果 Server 是集群，那势必需要 Client 去找到它，那么将引入`服务注册和发现`功能，比如 Eureka、Consul 等，将 Client、Server 和 Admin Web 连入。\n- 有了 Eureka、Consul 之类中间件，其实 Admin Web 可以直接通过它找到 Client，不过为了功能单一性，还是让 Server 转发用户命令。\n- 之前的 Helper Process 是在做火焰图时候临时加入，所有的`Worker Process`都是平等的 Client，在启动它的时候存在竞争问题，哪里一个 Client 去启动它呢？可以做一个类似 Egg.js 的启动命令，有 Master 进程、数个 Worker 进程已经一个 Helper Process。当然在 Egg.js 框架里，完全可以用 Agent 进程代替它，写个相关插件即可。\n- 如果所有的 Client 和 Helper Process 都在 Master 下，那么我们可以通过 Helper Process 代理将所有的 Client 基础数据批量上传到 Server，通过父进程 Master 做转发，这样也减轻了不断传数据的性能瓶颈；另外所有的 Client 注册到注册中心也不合适，也可以通过 Helper Process 代理，这样每个 Docker 就一个服务注册了。\n- 生成文件的过程是漫长的，不可能让短链接一直等，所以需要一个消息列队去通知 Admin Web，XXXX Client 的 XXXX 文件已经好了，让它去 FS 上拉取，需要引入 RMQ 等。\n- 为 Admin Web 可以方便获取 Client 列表，可以将注册中心里的服务信息格式处理后存在 Redis 中，这样就引入了 Redis，如果不平凡刷新这个列表可以每次读取注册中心里的数据做格式处理。\n\n![迭代2.0版本](/images/monitor-hub/image-20200403210837664.png)\n\n**综上思考**，Server 依旧做信息的存储和命令的转发工作，Admin Web 依旧是操作命令的入口，而整个 Client 端偏向 Egg.js 的风格。渐渐的整个监控中心就变得像一个微服务集群那样存在和运行，不同阶段有不同阶段的任务目标，讲不定之后会有新的挑战需要迭代。\n","slug":"monitor-hub","published":1,"updated":"2020-07-07T10:11:25.587Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs60000ed12iio0rfwo6","content":"<p>之前写了一篇<a href=\"https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/\" target=\"_blank\" rel=\"noopener\">收集 Node.js 应用的内存堆栈快照和 CPU 火焰图</a>文章，其中的架构非常粗糙，但是初步算是满足了现在的监控需求。不过随着业务的增长，单台<strong>TCP Server</strong>可定无法满足高可用的需求，一旦出现问题那就没办法持续使用了，所以需要一个重新设计和改造。</p>\n<a id=\"more\"></a>\n<p><img src=\"/images/monitor-hub/image-20200403185942130.png\" alt=\"粗糙的1.0版本\"></p>\n<p><strong>大致流程介绍：</strong></p>\n<p>一个 Docker 中，可能运行多个 Node.js 进程，比如 Egg.js 框架，另外<code>Helper Process</code>是用来做火焰图采集的，前面的文章提到过，目前它的功能相对单一应该被优化。</p>\n<p>所有的 Node.js 进程都会被看做事一个<code>Client</code>通过 TCP 长连接连入<code>Server</code>，他们做双向通信，Client 将心跳和监控数据（CPU、内存、EventLoop、GC 等）源源不断送入 Server 中，Server 将对用的数据存入到 ES 中。</p>\n<p>用户通过<code>Admin Web</code>可以查看每个应用的基础数据图表，发送生成内存堆栈信息和 CPU 火焰图的信息给指定的 Client，Client 生成文件后上传到<code>FS</code>（文件系统），之后 Admin Web 去 FS 上抓取该文件。</p>\n<p><strong>Q:为什么是这样一个粗糙的设计？</strong></p>\n<ul>\n<li>以快速上线去生产验证可用性为目标之一，尽量减少对其它系统的依赖，依赖<code>ES</code>是为了存数据、<code>FS</code>是为了存文件，过多的依赖对于部署上线还是测试链路都是增加成本，在人力有限的情况下拖的越久越容易杀死项目。</li>\n</ul>\n<p><strong>Q:为什么用长链接而不是短链接？</strong></p>\n<ul>\n<li>长链接的好处在简单模型下有个最大的好处就是我不需要去维护客户端是否存活，因为一旦客户端挂了，那么它就会自动断开，既能发送监控警报，又不需要做相关的治理工作，治理工作又是一个细活。</li>\n<li>另外客户端没有将数据集中定时批量发送，而是每次取到相关数据就发送给 Server。为了减少开销就用了长链接，自定义的协议传输效率也高。</li>\n<li>在开发过程中，长链接的开发模型比短连接复杂很多，不容易维护。</li>\n</ul>\n<p><strong>Q:目前遇到的问题和思考</strong></p>\n<ul>\n<li>单机 Server 一旦挂了就没办法继续监控，导致的风险极大，需要做集群，但是长链接并不适合做扩展，所以必须长改短。</li>\n<li>如果 Server 是集群，那势必需要 Client 去找到它，那么将引入<code>服务注册和发现</code>功能，比如 Eureka、Consul 等，将 Client、Server 和 Admin Web 连入。</li>\n<li>有了 Eureka、Consul 之类中间件，其实 Admin Web 可以直接通过它找到 Client，不过为了功能单一性，还是让 Server 转发用户命令。</li>\n<li>之前的 Helper Process 是在做火焰图时候临时加入，所有的<code>Worker Process</code>都是平等的 Client，在启动它的时候存在竞争问题，哪里一个 Client 去启动它呢？可以做一个类似 Egg.js 的启动命令，有 Master 进程、数个 Worker 进程已经一个 Helper Process。当然在 Egg.js 框架里，完全可以用 Agent 进程代替它，写个相关插件即可。</li>\n<li>如果所有的 Client 和 Helper Process 都在 Master 下，那么我们可以通过 Helper Process 代理将所有的 Client 基础数据批量上传到 Server，通过父进程 Master 做转发，这样也减轻了不断传数据的性能瓶颈；另外所有的 Client 注册到注册中心也不合适，也可以通过 Helper Process 代理，这样每个 Docker 就一个服务注册了。</li>\n<li>生成文件的过程是漫长的，不可能让短链接一直等，所以需要一个消息列队去通知 Admin Web，XXXX Client 的 XXXX 文件已经好了，让它去 FS 上拉取，需要引入 RMQ 等。</li>\n<li>为 Admin Web 可以方便获取 Client 列表，可以将注册中心里的服务信息格式处理后存在 Redis 中，这样就引入了 Redis，如果不平凡刷新这个列表可以每次读取注册中心里的数据做格式处理。</li>\n</ul>\n<p><img src=\"/images/monitor-hub/image-20200403210837664.png\" alt=\"迭代2.0版本\"></p>\n<p><strong>综上思考</strong>，Server 依旧做信息的存储和命令的转发工作，Admin Web 依旧是操作命令的入口，而整个 Client 端偏向 Egg.js 的风格。渐渐的整个监控中心就变得像一个微服务集群那样存在和运行，不同阶段有不同阶段的任务目标，讲不定之后会有新的挑战需要迭代。</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p>之前写了一篇<a href=\"https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/\" target=\"_blank\" rel=\"noopener\">收集 Node.js 应用的内存堆栈快照和 CPU 火焰图</a>文章，其中的架构非常粗糙，但是初步算是满足了现在的监控需求。不过随着业务的增长，单台<strong>TCP Server</strong>可定无法满足高可用的需求，一旦出现问题那就没办法持续使用了，所以需要一个重新设计和改造。</p>","more":"<p><img src=\"/images/monitor-hub/image-20200403185942130.png\" alt=\"粗糙的1.0版本\"></p>\n<p><strong>大致流程介绍：</strong></p>\n<p>一个 Docker 中，可能运行多个 Node.js 进程，比如 Egg.js 框架，另外<code>Helper Process</code>是用来做火焰图采集的，前面的文章提到过，目前它的功能相对单一应该被优化。</p>\n<p>所有的 Node.js 进程都会被看做事一个<code>Client</code>通过 TCP 长连接连入<code>Server</code>，他们做双向通信，Client 将心跳和监控数据（CPU、内存、EventLoop、GC 等）源源不断送入 Server 中，Server 将对用的数据存入到 ES 中。</p>\n<p>用户通过<code>Admin Web</code>可以查看每个应用的基础数据图表，发送生成内存堆栈信息和 CPU 火焰图的信息给指定的 Client，Client 生成文件后上传到<code>FS</code>（文件系统），之后 Admin Web 去 FS 上抓取该文件。</p>\n<p><strong>Q:为什么是这样一个粗糙的设计？</strong></p>\n<ul>\n<li>以快速上线去生产验证可用性为目标之一，尽量减少对其它系统的依赖，依赖<code>ES</code>是为了存数据、<code>FS</code>是为了存文件，过多的依赖对于部署上线还是测试链路都是增加成本，在人力有限的情况下拖的越久越容易杀死项目。</li>\n</ul>\n<p><strong>Q:为什么用长链接而不是短链接？</strong></p>\n<ul>\n<li>长链接的好处在简单模型下有个最大的好处就是我不需要去维护客户端是否存活，因为一旦客户端挂了，那么它就会自动断开，既能发送监控警报，又不需要做相关的治理工作，治理工作又是一个细活。</li>\n<li>另外客户端没有将数据集中定时批量发送，而是每次取到相关数据就发送给 Server。为了减少开销就用了长链接，自定义的协议传输效率也高。</li>\n<li>在开发过程中，长链接的开发模型比短连接复杂很多，不容易维护。</li>\n</ul>\n<p><strong>Q:目前遇到的问题和思考</strong></p>\n<ul>\n<li>单机 Server 一旦挂了就没办法继续监控，导致的风险极大，需要做集群，但是长链接并不适合做扩展，所以必须长改短。</li>\n<li>如果 Server 是集群，那势必需要 Client 去找到它，那么将引入<code>服务注册和发现</code>功能，比如 Eureka、Consul 等，将 Client、Server 和 Admin Web 连入。</li>\n<li>有了 Eureka、Consul 之类中间件，其实 Admin Web 可以直接通过它找到 Client，不过为了功能单一性，还是让 Server 转发用户命令。</li>\n<li>之前的 Helper Process 是在做火焰图时候临时加入，所有的<code>Worker Process</code>都是平等的 Client，在启动它的时候存在竞争问题，哪里一个 Client 去启动它呢？可以做一个类似 Egg.js 的启动命令，有 Master 进程、数个 Worker 进程已经一个 Helper Process。当然在 Egg.js 框架里，完全可以用 Agent 进程代替它，写个相关插件即可。</li>\n<li>如果所有的 Client 和 Helper Process 都在 Master 下，那么我们可以通过 Helper Process 代理将所有的 Client 基础数据批量上传到 Server，通过父进程 Master 做转发，这样也减轻了不断传数据的性能瓶颈；另外所有的 Client 注册到注册中心也不合适，也可以通过 Helper Process 代理，这样每个 Docker 就一个服务注册了。</li>\n<li>生成文件的过程是漫长的，不可能让短链接一直等，所以需要一个消息列队去通知 Admin Web，XXXX Client 的 XXXX 文件已经好了，让它去 FS 上拉取，需要引入 RMQ 等。</li>\n<li>为 Admin Web 可以方便获取 Client 列表，可以将注册中心里的服务信息格式处理后存在 Redis 中，这样就引入了 Redis，如果不平凡刷新这个列表可以每次读取注册中心里的数据做格式处理。</li>\n</ul>\n<p><img src=\"/images/monitor-hub/image-20200403210837664.png\" alt=\"迭代2.0版本\"></p>\n<p><strong>综上思考</strong>，Server 依旧做信息的存储和命令的转发工作，Admin Web 依旧是操作命令的入口，而整个 Client 端偏向 Egg.js 的风格。渐渐的整个监控中心就变得像一个微服务集群那样存在和运行，不同阶段有不同阶段的任务目标，讲不定之后会有新的挑战需要迭代。</p>"},{"title":"Node.js服务支持多SSR版本（适合测试环境）","date":"2020-06-29T06:59:30.000Z","keys":"网关,gateway,SSR,服务器渲染,多版本","_content":"\n### 背景\n\n通常，系统环境分为生产、测试和开发等多套，测试又可能因为验证不同的业务版本、BUG 部署 N 套， 意味着每套环境都会有一整套系统，从入口网关到大量的微服务节点，还有数据库等等。人力上需要有人去维护它们，无论是用于测试数还是系统的运维工作，每多一套系统都需要额外部署和购买大量资源，其中很多服务节点的版本是相同的，这都大大增加了成本。\n\n为了解决这样的问题，我们可以通过网关路由的方式，比如测试环境，所有的应用都部署在一套环境中，通过 HTTP Header 信息将不同的应用通过路由串联起来，大概如下：\n\nServer A V1 -> Server B V1\n\nServer A V2 -> Server B 其它版本\n\n<!-- more -->\n<br/>\n\n### 前端资源怎么区分多版本\n\n**这里的 SSR 服务，基本是移动端的 hybrid 应用，所以在 Native 打开它时可以在 HTTP Header 注入版本信息，如果 PC 端，可以通过其它方式告诉服务器需要路由的版本，比如 URL Query 或 Cookie 之类**\n\n1. 前置一个网关应用，在收到版本信息后，路由到 SSR 服务\n\n优点：\n\n- 无需改变当前的 SSR 服务\n\n缺点：\n\n- 作为 SSR 服务，其本身已经是一个网关，再前置一个网关有些奇怪\n- 每部署一个 SSR 服务节点，可能就需要更新前置网关的配置，需要 2 步操作\n- 需要多个 Docker 部署不同版本的 SSR 服务\n\n2. 改造 SSR 服务，收到 HTTP Header 版本信息后，在内部做版本的路由\n\n优点：\n\n- 一个 SSR 应用，就一个 Docker\n- 只要告诉一个应用（SSR）当前有哪些是需要使用的版本即可\n\n缺点：\n\n- 市面上大部分的 SSR 框架都是对应一个 SSR 版本的，不存在多版本并行，需要一定的开发和维护\n\n**综合考虑，既然是为了节省整体成本，那就彻底点，选择了第二个方案，一劳永逸。**\n\n<br/>\n\n### 改造 SSR 服务\n\n#### CI\\CD 阶段\n\n打包客户端和服务器资源，上传到静态服务器上，其中包含重要的 client-manifest.json 和 server-manifest.json，两者记录的是资源的名称和其对应的资源访问路径，client-manifest.json 用于在服务渲染时候根据资源名插入指定的访问路径，server-manifest.json 用于将资源从静态服务器下载到 Node.js 服务器上，用于 SSR 用。\n\n#### 启动和运行阶段\n\n- 访问配置中心，找到该应用的部署版本，比如 ['v1,'v2']\n- 与本地版本做 diff 算法，算出新增和遗弃的版本\n- 拉去新版本的 SSR 文件到本地磁盘\n- 路由解析，因为内部的 SSR 技术被广泛应用，为了不改动代码，通过@babel/parser 和 @babel/traverse 这两个类库，先将代码转成 AST，再解析出路由信息\n- 移除本地遗弃的 SSR 文件\n- 将新的路由信息更新到路由表中\n- 定时执行上述步骤\n\n我们用的是 Egg.js，所以上述步骤在 Agent 中完成，再广播给所有 Worker 进程。另外，为了更好的迭代和任务划分，使用[PlugBoard](https://mlib.wang/plugboard/?s=blog)插件化所有步骤。\n\n![架构](/images/node-gateway-ssr-multi-version/arch.png)\n\n客户端发起访问，找到对应的路由版本（如果没有走默认路由），路由请求，有缓存直接输出，没有就走 SSR 流程，查找该版本的 client-manifest.json，找到对应的浏览器访问路径，返回给客户端。\n\n至此，整个方案的流程完毕。项目上线后，可以通过关闭多版本共存的参数，按照市面上的常规流程运行应用。如果小团队的运维体系薄弱（没有 K8S 之类运维系统），也能用该套方案实现一定的蓝绿发布等。\n","source":"_posts/node-gateway-ssr-multi-version.md","raw":"---\ntitle: Node.js服务支持多SSR版本（适合测试环境）\ndate: 2020-06-29 14:59:30\ncategory: 架构\ntags:\n  - 架构\nkeys: 网关,gateway,SSR,服务器渲染,多版本\n---\n\n### 背景\n\n通常，系统环境分为生产、测试和开发等多套，测试又可能因为验证不同的业务版本、BUG 部署 N 套， 意味着每套环境都会有一整套系统，从入口网关到大量的微服务节点，还有数据库等等。人力上需要有人去维护它们，无论是用于测试数还是系统的运维工作，每多一套系统都需要额外部署和购买大量资源，其中很多服务节点的版本是相同的，这都大大增加了成本。\n\n为了解决这样的问题，我们可以通过网关路由的方式，比如测试环境，所有的应用都部署在一套环境中，通过 HTTP Header 信息将不同的应用通过路由串联起来，大概如下：\n\nServer A V1 -> Server B V1\n\nServer A V2 -> Server B 其它版本\n\n<!-- more -->\n<br/>\n\n### 前端资源怎么区分多版本\n\n**这里的 SSR 服务，基本是移动端的 hybrid 应用，所以在 Native 打开它时可以在 HTTP Header 注入版本信息，如果 PC 端，可以通过其它方式告诉服务器需要路由的版本，比如 URL Query 或 Cookie 之类**\n\n1. 前置一个网关应用，在收到版本信息后，路由到 SSR 服务\n\n优点：\n\n- 无需改变当前的 SSR 服务\n\n缺点：\n\n- 作为 SSR 服务，其本身已经是一个网关，再前置一个网关有些奇怪\n- 每部署一个 SSR 服务节点，可能就需要更新前置网关的配置，需要 2 步操作\n- 需要多个 Docker 部署不同版本的 SSR 服务\n\n2. 改造 SSR 服务，收到 HTTP Header 版本信息后，在内部做版本的路由\n\n优点：\n\n- 一个 SSR 应用，就一个 Docker\n- 只要告诉一个应用（SSR）当前有哪些是需要使用的版本即可\n\n缺点：\n\n- 市面上大部分的 SSR 框架都是对应一个 SSR 版本的，不存在多版本并行，需要一定的开发和维护\n\n**综合考虑，既然是为了节省整体成本，那就彻底点，选择了第二个方案，一劳永逸。**\n\n<br/>\n\n### 改造 SSR 服务\n\n#### CI\\CD 阶段\n\n打包客户端和服务器资源，上传到静态服务器上，其中包含重要的 client-manifest.json 和 server-manifest.json，两者记录的是资源的名称和其对应的资源访问路径，client-manifest.json 用于在服务渲染时候根据资源名插入指定的访问路径，server-manifest.json 用于将资源从静态服务器下载到 Node.js 服务器上，用于 SSR 用。\n\n#### 启动和运行阶段\n\n- 访问配置中心，找到该应用的部署版本，比如 ['v1,'v2']\n- 与本地版本做 diff 算法，算出新增和遗弃的版本\n- 拉去新版本的 SSR 文件到本地磁盘\n- 路由解析，因为内部的 SSR 技术被广泛应用，为了不改动代码，通过@babel/parser 和 @babel/traverse 这两个类库，先将代码转成 AST，再解析出路由信息\n- 移除本地遗弃的 SSR 文件\n- 将新的路由信息更新到路由表中\n- 定时执行上述步骤\n\n我们用的是 Egg.js，所以上述步骤在 Agent 中完成，再广播给所有 Worker 进程。另外，为了更好的迭代和任务划分，使用[PlugBoard](https://mlib.wang/plugboard/?s=blog)插件化所有步骤。\n\n![架构](/images/node-gateway-ssr-multi-version/arch.png)\n\n客户端发起访问，找到对应的路由版本（如果没有走默认路由），路由请求，有缓存直接输出，没有就走 SSR 流程，查找该版本的 client-manifest.json，找到对应的浏览器访问路径，返回给客户端。\n\n至此，整个方案的流程完毕。项目上线后，可以通过关闭多版本共存的参数，按照市面上的常规流程运行应用。如果小团队的运维体系薄弱（没有 K8S 之类运维系统），也能用该套方案实现一定的蓝绿发布等。\n","slug":"node-gateway-ssr-multi-version","published":1,"updated":"2020-07-07T10:11:25.587Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs63000hd12ihv1bmsa1","content":"<h3 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h3><p>通常，系统环境分为生产、测试和开发等多套，测试又可能因为验证不同的业务版本、BUG 部署 N 套， 意味着每套环境都会有一整套系统，从入口网关到大量的微服务节点，还有数据库等等。人力上需要有人去维护它们，无论是用于测试数还是系统的运维工作，每多一套系统都需要额外部署和购买大量资源，其中很多服务节点的版本是相同的，这都大大增加了成本。</p>\n<p>为了解决这样的问题，我们可以通过网关路由的方式，比如测试环境，所有的应用都部署在一套环境中，通过 HTTP Header 信息将不同的应用通过路由串联起来，大概如下：</p>\n<p>Server A V1 -&gt; Server B V1</p>\n<p>Server A V2 -&gt; Server B 其它版本</p>\n<a id=\"more\"></a>\n<p><br></p>\n<h3 id=\"前端资源怎么区分多版本\"><a href=\"#前端资源怎么区分多版本\" class=\"headerlink\" title=\"前端资源怎么区分多版本\"></a>前端资源怎么区分多版本</h3><p><strong>这里的 SSR 服务，基本是移动端的 hybrid 应用，所以在 Native 打开它时可以在 HTTP Header 注入版本信息，如果 PC 端，可以通过其它方式告诉服务器需要路由的版本，比如 URL Query 或 Cookie 之类</strong></p>\n<ol>\n<li>前置一个网关应用，在收到版本信息后，路由到 SSR 服务</li>\n</ol>\n<p>优点：</p>\n<ul>\n<li>无需改变当前的 SSR 服务</li>\n</ul>\n<p>缺点：</p>\n<ul>\n<li>作为 SSR 服务，其本身已经是一个网关，再前置一个网关有些奇怪</li>\n<li>每部署一个 SSR 服务节点，可能就需要更新前置网关的配置，需要 2 步操作</li>\n<li>需要多个 Docker 部署不同版本的 SSR 服务</li>\n</ul>\n<ol start=\"2\">\n<li>改造 SSR 服务，收到 HTTP Header 版本信息后，在内部做版本的路由</li>\n</ol>\n<p>优点：</p>\n<ul>\n<li>一个 SSR 应用，就一个 Docker</li>\n<li>只要告诉一个应用（SSR）当前有哪些是需要使用的版本即可</li>\n</ul>\n<p>缺点：</p>\n<ul>\n<li>市面上大部分的 SSR 框架都是对应一个 SSR 版本的，不存在多版本并行，需要一定的开发和维护</li>\n</ul>\n<p><strong>综合考虑，既然是为了节省整体成本，那就彻底点，选择了第二个方案，一劳永逸。</strong></p>\n<p><br></p>\n<h3 id=\"改造-SSR-服务\"><a href=\"#改造-SSR-服务\" class=\"headerlink\" title=\"改造 SSR 服务\"></a>改造 SSR 服务</h3><h4 id=\"CI-CD-阶段\"><a href=\"#CI-CD-阶段\" class=\"headerlink\" title=\"CI\\CD 阶段\"></a>CI\\CD 阶段</h4><p>打包客户端和服务器资源，上传到静态服务器上，其中包含重要的 client-manifest.json 和 server-manifest.json，两者记录的是资源的名称和其对应的资源访问路径，client-manifest.json 用于在服务渲染时候根据资源名插入指定的访问路径，server-manifest.json 用于将资源从静态服务器下载到 Node.js 服务器上，用于 SSR 用。</p>\n<h4 id=\"启动和运行阶段\"><a href=\"#启动和运行阶段\" class=\"headerlink\" title=\"启动和运行阶段\"></a>启动和运行阶段</h4><ul>\n<li>访问配置中心，找到该应用的部署版本，比如 [‘v1,’v2’]</li>\n<li>与本地版本做 diff 算法，算出新增和遗弃的版本</li>\n<li>拉去新版本的 SSR 文件到本地磁盘</li>\n<li>路由解析，因为内部的 SSR 技术被广泛应用，为了不改动代码，通过@babel/parser 和 @babel/traverse 这两个类库，先将代码转成 AST，再解析出路由信息</li>\n<li>移除本地遗弃的 SSR 文件</li>\n<li>将新的路由信息更新到路由表中</li>\n<li>定时执行上述步骤</li>\n</ul>\n<p>我们用的是 Egg.js，所以上述步骤在 Agent 中完成，再广播给所有 Worker 进程。另外，为了更好的迭代和任务划分，使用<a href=\"https://mlib.wang/plugboard/?s=blog\">PlugBoard</a>插件化所有步骤。</p>\n<p><img src=\"/images/node-gateway-ssr-multi-version/arch.png\" alt=\"架构\"></p>\n<p>客户端发起访问，找到对应的路由版本（如果没有走默认路由），路由请求，有缓存直接输出，没有就走 SSR 流程，查找该版本的 client-manifest.json，找到对应的浏览器访问路径，返回给客户端。</p>\n<p>至此，整个方案的流程完毕。项目上线后，可以通过关闭多版本共存的参数，按照市面上的常规流程运行应用。如果小团队的运维体系薄弱（没有 K8S 之类运维系统），也能用该套方案实现一定的蓝绿发布等。</p>\n","site":{"data":{}},"_categories":[{"name":"架构","path":"categories/架构/"}],"_tags":[{"name":"架构","path":"tags/架构/"}],"excerpt":"<h3 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h3><p>通常，系统环境分为生产、测试和开发等多套，测试又可能因为验证不同的业务版本、BUG 部署 N 套， 意味着每套环境都会有一整套系统，从入口网关到大量的微服务节点，还有数据库等等。人力上需要有人去维护它们，无论是用于测试数还是系统的运维工作，每多一套系统都需要额外部署和购买大量资源，其中很多服务节点的版本是相同的，这都大大增加了成本。</p>\n<p>为了解决这样的问题，我们可以通过网关路由的方式，比如测试环境，所有的应用都部署在一套环境中，通过 HTTP Header 信息将不同的应用通过路由串联起来，大概如下：</p>\n<p>Server A V1 -&gt; Server B V1</p>\n<p>Server A V2 -&gt; Server B 其它版本</p>","more":"<p><br></p>\n<h3 id=\"前端资源怎么区分多版本\"><a href=\"#前端资源怎么区分多版本\" class=\"headerlink\" title=\"前端资源怎么区分多版本\"></a>前端资源怎么区分多版本</h3><p><strong>这里的 SSR 服务，基本是移动端的 hybrid 应用，所以在 Native 打开它时可以在 HTTP Header 注入版本信息，如果 PC 端，可以通过其它方式告诉服务器需要路由的版本，比如 URL Query 或 Cookie 之类</strong></p>\n<ol>\n<li>前置一个网关应用，在收到版本信息后，路由到 SSR 服务</li>\n</ol>\n<p>优点：</p>\n<ul>\n<li>无需改变当前的 SSR 服务</li>\n</ul>\n<p>缺点：</p>\n<ul>\n<li>作为 SSR 服务，其本身已经是一个网关，再前置一个网关有些奇怪</li>\n<li>每部署一个 SSR 服务节点，可能就需要更新前置网关的配置，需要 2 步操作</li>\n<li>需要多个 Docker 部署不同版本的 SSR 服务</li>\n</ul>\n<ol start=\"2\">\n<li>改造 SSR 服务，收到 HTTP Header 版本信息后，在内部做版本的路由</li>\n</ol>\n<p>优点：</p>\n<ul>\n<li>一个 SSR 应用，就一个 Docker</li>\n<li>只要告诉一个应用（SSR）当前有哪些是需要使用的版本即可</li>\n</ul>\n<p>缺点：</p>\n<ul>\n<li>市面上大部分的 SSR 框架都是对应一个 SSR 版本的，不存在多版本并行，需要一定的开发和维护</li>\n</ul>\n<p><strong>综合考虑，既然是为了节省整体成本，那就彻底点，选择了第二个方案，一劳永逸。</strong></p>\n<p><br></p>\n<h3 id=\"改造-SSR-服务\"><a href=\"#改造-SSR-服务\" class=\"headerlink\" title=\"改造 SSR 服务\"></a>改造 SSR 服务</h3><h4 id=\"CI-CD-阶段\"><a href=\"#CI-CD-阶段\" class=\"headerlink\" title=\"CI\\CD 阶段\"></a>CI\\CD 阶段</h4><p>打包客户端和服务器资源，上传到静态服务器上，其中包含重要的 client-manifest.json 和 server-manifest.json，两者记录的是资源的名称和其对应的资源访问路径，client-manifest.json 用于在服务渲染时候根据资源名插入指定的访问路径，server-manifest.json 用于将资源从静态服务器下载到 Node.js 服务器上，用于 SSR 用。</p>\n<h4 id=\"启动和运行阶段\"><a href=\"#启动和运行阶段\" class=\"headerlink\" title=\"启动和运行阶段\"></a>启动和运行阶段</h4><ul>\n<li>访问配置中心，找到该应用的部署版本，比如 [‘v1,’v2’]</li>\n<li>与本地版本做 diff 算法，算出新增和遗弃的版本</li>\n<li>拉去新版本的 SSR 文件到本地磁盘</li>\n<li>路由解析，因为内部的 SSR 技术被广泛应用，为了不改动代码，通过@babel/parser 和 @babel/traverse 这两个类库，先将代码转成 AST，再解析出路由信息</li>\n<li>移除本地遗弃的 SSR 文件</li>\n<li>将新的路由信息更新到路由表中</li>\n<li>定时执行上述步骤</li>\n</ul>\n<p>我们用的是 Egg.js，所以上述步骤在 Agent 中完成，再广播给所有 Worker 进程。另外，为了更好的迭代和任务划分，使用<a href=\"https://mlib.wang/plugboard/?s=blog\">PlugBoard</a>插件化所有步骤。</p>\n<p><img src=\"/images/node-gateway-ssr-multi-version/arch.png\" alt=\"架构\"></p>\n<p>客户端发起访问，找到对应的路由版本（如果没有走默认路由），路由请求，有缓存直接输出，没有就走 SSR 流程，查找该版本的 client-manifest.json，找到对应的浏览器访问路径，返回给客户端。</p>\n<p>至此，整个方案的流程完毕。项目上线后，可以通过关闭多版本共存的参数，按照市面上的常规流程运行应用。如果小团队的运维体系薄弱（没有 K8S 之类运维系统），也能用该套方案实现一定的蓝绿发布等。</p>"},{"title":"收集Node.js应用的内存堆栈快照和CPU火焰图","keywords":"内存堆栈快照,CPU火焰图","description":"如果你在一家对数据安全性很高的公司工作，团队规定不允许提交数据到第三方服务上，甚至连服务器内存、CPU使用情况等监控数据都不行，那对于像Alinode这样监控和排查问题的大杀器基本都是无福享用了。大多数情况不得不面临自己开发一套类似监控体制去为生产环境保驾护航。","date":"2020-02-20T23:31:54.489Z","_content":"\n如果你在一家对数据安全性很高的公司工作，团队规定不允许提交数据到第三方服务上，甚至连服务器内存、CPU使用情况等监控数据都不行，那对于像[Alinode](https://cn.aliyun.com/product/nodejs)这样监控和排查问题的大杀器基本都是无福享用了。大多数情况不得不面临自己开发一套类似监控体制去为生产环境保驾护航。\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n## 数据\n\n*Node.js是单进程的，即使像Egg.js这样的项目存在Agent、多个Worker进程，但依旧应该把它们分为独立的进程对待，所以监控的粒度是进程级别。*\n\n#### 基础数据\n\n- 进程级别：内存、CPU、EventLoop、GC、调用该系统的时间消耗、该系统调用它人系统的时间消耗等。\n- 系统级别：负载均衡 （`os.loadavg()`）\n\n上述这些数据，有些Node.js API直接暴露出来，有些需要写C++扩展去调用底层的V8 API来获取，好在市面上存在比较多的此类类库，比如[IBM appmetrics](https://github.com/RuntimeTools/appmetrics)就不错，它还有很多额外的监控数据可以收集，`主动`定时将它们提交到Elasticsearch，在用Grafana加载出来，还是很容易做到的。\n\n<br/>\n\n#### 内存堆栈快照\n\n- 通过多份内存堆栈快照可以帮助我们定位内存溢出的原因。\n\n#### [CPU火焰图](http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html)\n\n- 通过它可以让我们知道是代码的哪部分导致CPU非常繁忙。\n\n上面这2个文件在系统调优和排查问题时起到至关重要的帮助，但是它们都是以文件的形式存储，又不像`基础数据`那么简易可以直接塞进DB里；另外获取这些资源过程是影响应用性能的，比如`内存堆栈快照`因为要罗列出所有的堆栈对象相互之间的关系和字节大小需要一定的计算量和时间，在此过程中系统处于无法响应的状态。为此，我们需要设计一套方法，在需要的时候去通知对应的Node.js进程，`被动`生成这些文件，而不是向先前那样`主动`收集。\n\n<br/>\n\n<br/>\n\n## 命令&传输\n\n我们需要通过一些方法，告诉对应的Node.js进程该干些什么事情，是生成内存堆栈快照还是CPU火焰图，又或是别的什么。需要一个发送`命令`的地方，也需要一种方式将命令发送给指定的Node.js进程。将一个个孤立的Node.js进程连接起来有很多方式，比如TCP，或者HTTP。\n\n我个人比较倾向用TCP，长链、双向、数据帧也轻巧很多，等等。像下图那样将他们连起来，**仅用来示意，具体细节会有些不同，简单的粗暴将单箭头表示HTTP，双箭头表示TCP双向。**\n\n![连接示意图](/images/node-perf-heapdump-flame-graph/connection_01.png)\n\n- **命令发送：**一般会有一个Web界面，通过按钮提交命令请求。\n- **Hub：**一个TCP服务，接受命令并将其转发到对应的Node.js进程上。\n- **Node.js Process:** 可能一台服务器（或者Docker等）就一个Node.js进程，如Express；也有可能如Egg.js一样是多个Node.js进程。\n- **DFS：**因为现在的服务基本都是部署在像Docker这样虚拟机上的，服务出现问题或人工原因很容易随时被系统销毁导致生产的快照或火焰图丢失，所以需要有个文件服务器持久化它们，因此一旦文件生产后就推送到文件服务器上待使用者去下载它们。\n\n<br/>\n\n<br/>\n\n## 内存堆栈快照\n\nNode.js Process监听到发来的`命令`，通过调用[heapdump](https://www.npmjs.com/package/heapdump)很容易获得内存堆栈快照，再将文件推送到DFS上。如果想像`Alinode`那样自动又直接显示内存信息的话，改下[devtools-frontend](https://github.com/ChromeDevTools/devtools-frontend)，将其加入到系统中即可。\n\n![devtools 自动加载内存快照](/images/node-perf-heapdump-flame-graph/heapdump_01.png)\n\n<br/>\n\n<br/>\n\n## CPU火焰图\n\n火焰图比其它的数据麻烦很多，官方有专门的[文档](https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/)说明了整个流程，总的来说需要[perf](http://www.brendangregg.com/perf.html)和[FlameGraph](https://github.com/brendangregg/FlameGraph)这两个工具，具体的方法随意Google都能查到很多，就不多叙述了，关键是如何将它融入到上述的框架中呢？\n\n假设和之前一样，Node.js进程用`socket.on(\"readable\",callback)` 或 `socket.on(\"data\",callback)`接受命令，并在callback中开启一个新的进程来执行`perf`等shell脚本，那么生成的火焰图不准确，为何？\n\nNode.js是单进程，JavaScript部分是事件循环，密集计算会阻塞其它的操作，比如运行一个`斐波那契数列`计算。此刻，其它的异步任务就算完成也无法得到执行，比如底层IO获得了命令，但是由于JavaScript堵塞了而无法执行`callback`创建新进程执行shell脚本。等到`斐波那契数列`执行完后，callback才被执行。而我们火焰图需要排查的就是什么导致CPU一直繁忙的嗡嗡作响，而上述的问题就是密集的斐波那契数列计算，但是由于JavaScript的执行机制而有可能错过了开启perf的时机。大多数的时候，我们都是发现进程阻塞了或者CPU一直处于繁忙而去主动命令进程开启`perf`排查问题，所以这个方法获得的数据并不准确。\n\n如果当前进程一直进程因为繁忙而无法执行新的JavaScript命令，那么我们是否可以通过一个简单的辅助进程来帮忙开启shell脚本呢？\n\n### 实验\n\n因为perf需要Linux环境，我们可以通过Docker在本地启动一个Node.js容器实验下，以Node.js 12为例。\n\n下载完对应版本的Node.js Docker后，通过下面命令开启一个新的容器，必须带`--privileged`不然无法使用perf。\n\n```shell\ndocker run --privileged -itd node:12-buster /bin/bash // 启动\n\ndocker attach xxxx  // 进入\n```\n\n进入Docker容器后安装`perf`\n\n```shell\napt-get update\n\napt-get install linux-perf\n\nperf_4.19 // 执行该命令查看是否安装成功，不同的linux内核版本对应不同的perf版本\n```\n\n[代码](https://github.com/miser/test-perf)\n\n```javascript\n// index.js\nconst {fork } = require('child_process')\nfork('./helper')\n\nfibonacci(50)\n\nfunction fibonacci(n) {\n  if(n==0 || n == 1) return n;\n  return fibonacci(n-1) + fibonacci(n-2);\n}\n\n// helper.js\nconst fs = require('fs');\nconst path = require('path');\nconst { spawn, exec } = require('child_process');\nconst unzipper = require(\"unzipper\");\n\nconst perfCMD = 'perf_4.19'\nconst perfTime = 60;\n\n\nfunction execCMD(cmd, callback) {\n  return new Promise((resolve, reject) => {\n    exec(cmd, (error, stdout, stderr) => {\n      console.log('shell: ',cmd)\n      if (error) {\n        console.error(`执行的错误: ${error}`);\n        reject(error)\n      }\n      if(callback) {\n        callback(stdout, stderr, resolve, reject);\n      } else {\n        resolve()\n      }\n    });\n  })\n}\n\nclass Flame {\n  constructor() {\n\n    this.nodes = [];\n\n    this._init().catch(function(e){\n      console.log(e)\n    })\n  }\n\n  _init () {\n    return new Promise((resolve, reject) => {\n      const zipFilePath = path.join('.', 'FlameGraph.zip')\n      const saveDir = process.cwd();\n      fs.createReadStream(zipFilePath)\n        .pipe(unzipper.Extract({ path: saveDir }))\n        .on(\"error\", reject)\n        .on(\"finish\", () => {\n          console.log(\"zip finish\");\n          resolve();\n        });\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/stackcollapse-perf.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/flamegraph.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '{print $2}'`;\n      return execCMD(cmd, (stdout, stderr, resolve, reject) => {\n        this.nodes = stdout.split('\\n').filter( pid => pid && pid != process.pid)\n        resolve();\n      });\n    });\n  }\n\n  _chownMapFile(){\n    const cmd = `chown root /tmp/perf-${this.nodes[0]}.map && ${perfCMD} script > nodestacks`;\n    execCMD(cmd).then(() => {\n      this._genFlameGraph();\n    })\n  }\n\n  _genFlameGraph(){\n    const cmd = `./FlameGraph/stackcollapse-perf.pl < nodestacks | ./FlameGraph/flamegraph.pl --colors js > node-flamegraph-${process.pid}.svg`\n    execCMD(cmd).then(() => {\n      console.log('had completed');\n    })\n  }\n\n  record() {\n    const cmd = `${perfCMD} record -F 99 -p ${this.nodes[0]} -g -- sleep ${perfTime}`;\n    execCMD(cmd).then(() => {\n      const t = 1000 * (perfTime + 5);\n      setTimeout(() => {\n        this._chownMapFile()\n      }, 1000 * (perfTime + 5))\n    })\n  }\n}\n\nconst flame = new Flame();\nsetTimeout(() => {\n  // 模拟收到tcp命令\n  flame.record();\n}, 1000 * 5)\n\n```\n\n```json\n// package.json\n{\n  \"name\": \"test-perf\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"dev\": \"node --perf-basic-prof index.js\",\n    \"clear\": \"rm isolate-* & rm node-flamegraph-*.svg & rm -rf FlameGraph\"\n  },\n  \"keywords\": [],\n  \"author\": \"\",\n  \"license\": \"ISC\",\n  \"dependencies\": {\n    \"unzipper\": \"^0.10.8\"\n  }\n}\n\n```\n\n\n\n- index.js: 创建一个辅助进程；执行斐波那契数列计算\n- hepler.js: 将压缩的FlameGraph.zip解压 => 给相关文件执行权限 => 获得当前系统中除自己以外的Node.js进程号（因为可能是多个，所以是个数组，例子中假设就一个进程）=> 定时模拟获得生成火焰图的命令 => 执行 perf record => 延迟5秒后生成火焰图\n- package.json: 启动 index.js 需要加上`--perf-basic-prof`命令行参数；另外还需要`unzipper`类包\n\n将他们通过docker cp 从本地上传到docker中，并执行npm i安装依赖。\n\n```shell\nnpm run dev // 开始实验\n```\n\n随着一阵的风扇狂响（CPU密集计算）之后，火焰图也生成好了，大致如下：\n\n![CPU火焰图](/images/node-perf-heapdump-flame-graph/node-flamegraph.png)\n\n之前的框架也做部分调整，每个容器需要一个Helper.js进程\n\n![调整后的框架](/images/node-perf-heapdump-flame-graph/connection_02.png)\n\n\n\n\n\n#### 总结\n\n我觉得程序员和程序猿之间的差别就在有没有一套好的监控体系和善用监控调优及排查问题的方法。如果没办法使用现成的第三方服务，往往需要自己动手去搭建，无论业务多么繁忙，唯有趁手的“兵器”才能取得真经，这是需要据理力争的东西。只有水下的冰够厚，水上的冰山才能更高。","source":"_posts/node-perf-heapdump-flame-graph.md","raw":"---\ntitle: 收集Node.js应用的内存堆栈快照和CPU火焰图\ncategory: JavaScript\nkeywords: 内存堆栈快照,CPU火焰图\ndescription: 如果你在一家对数据安全性很高的公司工作，团队规定不允许提交数据到第三方服务上，甚至连服务器内存、CPU使用情况等监控数据都不行，那对于像Alinode这样监控和排查问题的大杀器基本都是无福享用了。大多数情况不得不面临自己开发一套类似监控体制去为生产环境保驾护航。\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-02-21T07:31:54.489Z\n---\n\n如果你在一家对数据安全性很高的公司工作，团队规定不允许提交数据到第三方服务上，甚至连服务器内存、CPU使用情况等监控数据都不行，那对于像[Alinode](https://cn.aliyun.com/product/nodejs)这样监控和排查问题的大杀器基本都是无福享用了。大多数情况不得不面临自己开发一套类似监控体制去为生产环境保驾护航。\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n## 数据\n\n*Node.js是单进程的，即使像Egg.js这样的项目存在Agent、多个Worker进程，但依旧应该把它们分为独立的进程对待，所以监控的粒度是进程级别。*\n\n#### 基础数据\n\n- 进程级别：内存、CPU、EventLoop、GC、调用该系统的时间消耗、该系统调用它人系统的时间消耗等。\n- 系统级别：负载均衡 （`os.loadavg()`）\n\n上述这些数据，有些Node.js API直接暴露出来，有些需要写C++扩展去调用底层的V8 API来获取，好在市面上存在比较多的此类类库，比如[IBM appmetrics](https://github.com/RuntimeTools/appmetrics)就不错，它还有很多额外的监控数据可以收集，`主动`定时将它们提交到Elasticsearch，在用Grafana加载出来，还是很容易做到的。\n\n<br/>\n\n#### 内存堆栈快照\n\n- 通过多份内存堆栈快照可以帮助我们定位内存溢出的原因。\n\n#### [CPU火焰图](http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html)\n\n- 通过它可以让我们知道是代码的哪部分导致CPU非常繁忙。\n\n上面这2个文件在系统调优和排查问题时起到至关重要的帮助，但是它们都是以文件的形式存储，又不像`基础数据`那么简易可以直接塞进DB里；另外获取这些资源过程是影响应用性能的，比如`内存堆栈快照`因为要罗列出所有的堆栈对象相互之间的关系和字节大小需要一定的计算量和时间，在此过程中系统处于无法响应的状态。为此，我们需要设计一套方法，在需要的时候去通知对应的Node.js进程，`被动`生成这些文件，而不是向先前那样`主动`收集。\n\n<br/>\n\n<br/>\n\n## 命令&传输\n\n我们需要通过一些方法，告诉对应的Node.js进程该干些什么事情，是生成内存堆栈快照还是CPU火焰图，又或是别的什么。需要一个发送`命令`的地方，也需要一种方式将命令发送给指定的Node.js进程。将一个个孤立的Node.js进程连接起来有很多方式，比如TCP，或者HTTP。\n\n我个人比较倾向用TCP，长链、双向、数据帧也轻巧很多，等等。像下图那样将他们连起来，**仅用来示意，具体细节会有些不同，简单的粗暴将单箭头表示HTTP，双箭头表示TCP双向。**\n\n![连接示意图](/images/node-perf-heapdump-flame-graph/connection_01.png)\n\n- **命令发送：**一般会有一个Web界面，通过按钮提交命令请求。\n- **Hub：**一个TCP服务，接受命令并将其转发到对应的Node.js进程上。\n- **Node.js Process:** 可能一台服务器（或者Docker等）就一个Node.js进程，如Express；也有可能如Egg.js一样是多个Node.js进程。\n- **DFS：**因为现在的服务基本都是部署在像Docker这样虚拟机上的，服务出现问题或人工原因很容易随时被系统销毁导致生产的快照或火焰图丢失，所以需要有个文件服务器持久化它们，因此一旦文件生产后就推送到文件服务器上待使用者去下载它们。\n\n<br/>\n\n<br/>\n\n## 内存堆栈快照\n\nNode.js Process监听到发来的`命令`，通过调用[heapdump](https://www.npmjs.com/package/heapdump)很容易获得内存堆栈快照，再将文件推送到DFS上。如果想像`Alinode`那样自动又直接显示内存信息的话，改下[devtools-frontend](https://github.com/ChromeDevTools/devtools-frontend)，将其加入到系统中即可。\n\n![devtools 自动加载内存快照](/images/node-perf-heapdump-flame-graph/heapdump_01.png)\n\n<br/>\n\n<br/>\n\n## CPU火焰图\n\n火焰图比其它的数据麻烦很多，官方有专门的[文档](https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/)说明了整个流程，总的来说需要[perf](http://www.brendangregg.com/perf.html)和[FlameGraph](https://github.com/brendangregg/FlameGraph)这两个工具，具体的方法随意Google都能查到很多，就不多叙述了，关键是如何将它融入到上述的框架中呢？\n\n假设和之前一样，Node.js进程用`socket.on(\"readable\",callback)` 或 `socket.on(\"data\",callback)`接受命令，并在callback中开启一个新的进程来执行`perf`等shell脚本，那么生成的火焰图不准确，为何？\n\nNode.js是单进程，JavaScript部分是事件循环，密集计算会阻塞其它的操作，比如运行一个`斐波那契数列`计算。此刻，其它的异步任务就算完成也无法得到执行，比如底层IO获得了命令，但是由于JavaScript堵塞了而无法执行`callback`创建新进程执行shell脚本。等到`斐波那契数列`执行完后，callback才被执行。而我们火焰图需要排查的就是什么导致CPU一直繁忙的嗡嗡作响，而上述的问题就是密集的斐波那契数列计算，但是由于JavaScript的执行机制而有可能错过了开启perf的时机。大多数的时候，我们都是发现进程阻塞了或者CPU一直处于繁忙而去主动命令进程开启`perf`排查问题，所以这个方法获得的数据并不准确。\n\n如果当前进程一直进程因为繁忙而无法执行新的JavaScript命令，那么我们是否可以通过一个简单的辅助进程来帮忙开启shell脚本呢？\n\n### 实验\n\n因为perf需要Linux环境，我们可以通过Docker在本地启动一个Node.js容器实验下，以Node.js 12为例。\n\n下载完对应版本的Node.js Docker后，通过下面命令开启一个新的容器，必须带`--privileged`不然无法使用perf。\n\n```shell\ndocker run --privileged -itd node:12-buster /bin/bash // 启动\n\ndocker attach xxxx  // 进入\n```\n\n进入Docker容器后安装`perf`\n\n```shell\napt-get update\n\napt-get install linux-perf\n\nperf_4.19 // 执行该命令查看是否安装成功，不同的linux内核版本对应不同的perf版本\n```\n\n[代码](https://github.com/miser/test-perf)\n\n```javascript\n// index.js\nconst {fork } = require('child_process')\nfork('./helper')\n\nfibonacci(50)\n\nfunction fibonacci(n) {\n  if(n==0 || n == 1) return n;\n  return fibonacci(n-1) + fibonacci(n-2);\n}\n\n// helper.js\nconst fs = require('fs');\nconst path = require('path');\nconst { spawn, exec } = require('child_process');\nconst unzipper = require(\"unzipper\");\n\nconst perfCMD = 'perf_4.19'\nconst perfTime = 60;\n\n\nfunction execCMD(cmd, callback) {\n  return new Promise((resolve, reject) => {\n    exec(cmd, (error, stdout, stderr) => {\n      console.log('shell: ',cmd)\n      if (error) {\n        console.error(`执行的错误: ${error}`);\n        reject(error)\n      }\n      if(callback) {\n        callback(stdout, stderr, resolve, reject);\n      } else {\n        resolve()\n      }\n    });\n  })\n}\n\nclass Flame {\n  constructor() {\n\n    this.nodes = [];\n\n    this._init().catch(function(e){\n      console.log(e)\n    })\n  }\n\n  _init () {\n    return new Promise((resolve, reject) => {\n      const zipFilePath = path.join('.', 'FlameGraph.zip')\n      const saveDir = process.cwd();\n      fs.createReadStream(zipFilePath)\n        .pipe(unzipper.Extract({ path: saveDir }))\n        .on(\"error\", reject)\n        .on(\"finish\", () => {\n          console.log(\"zip finish\");\n          resolve();\n        });\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/stackcollapse-perf.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/flamegraph.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '{print $2}'`;\n      return execCMD(cmd, (stdout, stderr, resolve, reject) => {\n        this.nodes = stdout.split('\\n').filter( pid => pid && pid != process.pid)\n        resolve();\n      });\n    });\n  }\n\n  _chownMapFile(){\n    const cmd = `chown root /tmp/perf-${this.nodes[0]}.map && ${perfCMD} script > nodestacks`;\n    execCMD(cmd).then(() => {\n      this._genFlameGraph();\n    })\n  }\n\n  _genFlameGraph(){\n    const cmd = `./FlameGraph/stackcollapse-perf.pl < nodestacks | ./FlameGraph/flamegraph.pl --colors js > node-flamegraph-${process.pid}.svg`\n    execCMD(cmd).then(() => {\n      console.log('had completed');\n    })\n  }\n\n  record() {\n    const cmd = `${perfCMD} record -F 99 -p ${this.nodes[0]} -g -- sleep ${perfTime}`;\n    execCMD(cmd).then(() => {\n      const t = 1000 * (perfTime + 5);\n      setTimeout(() => {\n        this._chownMapFile()\n      }, 1000 * (perfTime + 5))\n    })\n  }\n}\n\nconst flame = new Flame();\nsetTimeout(() => {\n  // 模拟收到tcp命令\n  flame.record();\n}, 1000 * 5)\n\n```\n\n```json\n// package.json\n{\n  \"name\": \"test-perf\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"dev\": \"node --perf-basic-prof index.js\",\n    \"clear\": \"rm isolate-* & rm node-flamegraph-*.svg & rm -rf FlameGraph\"\n  },\n  \"keywords\": [],\n  \"author\": \"\",\n  \"license\": \"ISC\",\n  \"dependencies\": {\n    \"unzipper\": \"^0.10.8\"\n  }\n}\n\n```\n\n\n\n- index.js: 创建一个辅助进程；执行斐波那契数列计算\n- hepler.js: 将压缩的FlameGraph.zip解压 => 给相关文件执行权限 => 获得当前系统中除自己以外的Node.js进程号（因为可能是多个，所以是个数组，例子中假设就一个进程）=> 定时模拟获得生成火焰图的命令 => 执行 perf record => 延迟5秒后生成火焰图\n- package.json: 启动 index.js 需要加上`--perf-basic-prof`命令行参数；另外还需要`unzipper`类包\n\n将他们通过docker cp 从本地上传到docker中，并执行npm i安装依赖。\n\n```shell\nnpm run dev // 开始实验\n```\n\n随着一阵的风扇狂响（CPU密集计算）之后，火焰图也生成好了，大致如下：\n\n![CPU火焰图](/images/node-perf-heapdump-flame-graph/node-flamegraph.png)\n\n之前的框架也做部分调整，每个容器需要一个Helper.js进程\n\n![调整后的框架](/images/node-perf-heapdump-flame-graph/connection_02.png)\n\n\n\n\n\n#### 总结\n\n我觉得程序员和程序猿之间的差别就在有没有一套好的监控体系和善用监控调优及排查问题的方法。如果没办法使用现成的第三方服务，往往需要自己动手去搭建，无论业务多么繁忙，唯有趁手的“兵器”才能取得真经，这是需要据理力争的东西。只有水下的冰够厚，水上的冰山才能更高。","slug":"node-perf-heapdump-flame-graph","published":1,"updated":"2020-07-07T10:11:25.588Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs67000ld12i883r2soz","content":"<p>如果你在一家对数据安全性很高的公司工作，团队规定不允许提交数据到第三方服务上，甚至连服务器内存、CPU使用情况等监控数据都不行，那对于像<a href=\"https://cn.aliyun.com/product/nodejs\" target=\"_blank\" rel=\"noopener\">Alinode</a>这样监控和排查问题的大杀器基本都是无福享用了。大多数情况不得不面临自己开发一套类似监控体制去为生产环境保驾护航。</p>\n<a id=\"more\"></a>\n<p><br></p>\n<p><br></p>\n<h2 id=\"数据\"><a href=\"#数据\" class=\"headerlink\" title=\"数据\"></a>数据</h2><p><em>Node.js是单进程的，即使像Egg.js这样的项目存在Agent、多个Worker进程，但依旧应该把它们分为独立的进程对待，所以监控的粒度是进程级别。</em></p>\n<h4 id=\"基础数据\"><a href=\"#基础数据\" class=\"headerlink\" title=\"基础数据\"></a>基础数据</h4><ul>\n<li>进程级别：内存、CPU、EventLoop、GC、调用该系统的时间消耗、该系统调用它人系统的时间消耗等。</li>\n<li>系统级别：负载均衡 （<code>os.loadavg()</code>）</li>\n</ul>\n<p>上述这些数据，有些Node.js API直接暴露出来，有些需要写C++扩展去调用底层的V8 API来获取，好在市面上存在比较多的此类类库，比如<a href=\"https://github.com/RuntimeTools/appmetrics\" target=\"_blank\" rel=\"noopener\">IBM appmetrics</a>就不错，它还有很多额外的监控数据可以收集，<code>主动</code>定时将它们提交到Elasticsearch，在用Grafana加载出来，还是很容易做到的。</p>\n<p><br></p>\n<h4 id=\"内存堆栈快照\"><a href=\"#内存堆栈快照\" class=\"headerlink\" title=\"内存堆栈快照\"></a>内存堆栈快照</h4><ul>\n<li>通过多份内存堆栈快照可以帮助我们定位内存溢出的原因。</li>\n</ul>\n<h4 id=\"CPU火焰图\"><a href=\"#CPU火焰图\" class=\"headerlink\" title=\"CPU火焰图\"></a><a href=\"http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html\" target=\"_blank\" rel=\"noopener\">CPU火焰图</a></h4><ul>\n<li>通过它可以让我们知道是代码的哪部分导致CPU非常繁忙。</li>\n</ul>\n<p>上面这2个文件在系统调优和排查问题时起到至关重要的帮助，但是它们都是以文件的形式存储，又不像<code>基础数据</code>那么简易可以直接塞进DB里；另外获取这些资源过程是影响应用性能的，比如<code>内存堆栈快照</code>因为要罗列出所有的堆栈对象相互之间的关系和字节大小需要一定的计算量和时间，在此过程中系统处于无法响应的状态。为此，我们需要设计一套方法，在需要的时候去通知对应的Node.js进程，<code>被动</code>生成这些文件，而不是向先前那样<code>主动</code>收集。</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"命令-amp-传输\"><a href=\"#命令-amp-传输\" class=\"headerlink\" title=\"命令&amp;传输\"></a>命令&amp;传输</h2><p>我们需要通过一些方法，告诉对应的Node.js进程该干些什么事情，是生成内存堆栈快照还是CPU火焰图，又或是别的什么。需要一个发送<code>命令</code>的地方，也需要一种方式将命令发送给指定的Node.js进程。将一个个孤立的Node.js进程连接起来有很多方式，比如TCP，或者HTTP。</p>\n<p>我个人比较倾向用TCP，长链、双向、数据帧也轻巧很多，等等。像下图那样将他们连起来，<strong>仅用来示意，具体细节会有些不同，简单的粗暴将单箭头表示HTTP，双箭头表示TCP双向。</strong></p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_01.png\" alt=\"连接示意图\"></p>\n<ul>\n<li><strong>命令发送：</strong>一般会有一个Web界面，通过按钮提交命令请求。</li>\n<li><strong>Hub：</strong>一个TCP服务，接受命令并将其转发到对应的Node.js进程上。</li>\n<li><strong>Node.js Process:</strong> 可能一台服务器（或者Docker等）就一个Node.js进程，如Express；也有可能如Egg.js一样是多个Node.js进程。</li>\n<li><strong>DFS：</strong>因为现在的服务基本都是部署在像Docker这样虚拟机上的，服务出现问题或人工原因很容易随时被系统销毁导致生产的快照或火焰图丢失，所以需要有个文件服务器持久化它们，因此一旦文件生产后就推送到文件服务器上待使用者去下载它们。</li>\n</ul>\n<p><br></p>\n<p><br></p>\n<h2 id=\"内存堆栈快照-1\"><a href=\"#内存堆栈快照-1\" class=\"headerlink\" title=\"内存堆栈快照\"></a>内存堆栈快照</h2><p>Node.js Process监听到发来的<code>命令</code>，通过调用<a href=\"https://www.npmjs.com/package/heapdump\" target=\"_blank\" rel=\"noopener\">heapdump</a>很容易获得内存堆栈快照，再将文件推送到DFS上。如果想像<code>Alinode</code>那样自动又直接显示内存信息的话，改下<a href=\"https://github.com/ChromeDevTools/devtools-frontend\" target=\"_blank\" rel=\"noopener\">devtools-frontend</a>，将其加入到系统中即可。</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/heapdump_01.png\" alt=\"devtools 自动加载内存快照\"></p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"CPU火焰图-1\"><a href=\"#CPU火焰图-1\" class=\"headerlink\" title=\"CPU火焰图\"></a>CPU火焰图</h2><p>火焰图比其它的数据麻烦很多，官方有专门的<a href=\"https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/\" target=\"_blank\" rel=\"noopener\">文档</a>说明了整个流程，总的来说需要<a href=\"http://www.brendangregg.com/perf.html\" target=\"_blank\" rel=\"noopener\">perf</a>和<a href=\"https://github.com/brendangregg/FlameGraph\" target=\"_blank\" rel=\"noopener\">FlameGraph</a>这两个工具，具体的方法随意Google都能查到很多，就不多叙述了，关键是如何将它融入到上述的框架中呢？</p>\n<p>假设和之前一样，Node.js进程用<code>socket.on(&quot;readable&quot;,callback)</code> 或 <code>socket.on(&quot;data&quot;,callback)</code>接受命令，并在callback中开启一个新的进程来执行<code>perf</code>等shell脚本，那么生成的火焰图不准确，为何？</p>\n<p>Node.js是单进程，JavaScript部分是事件循环，密集计算会阻塞其它的操作，比如运行一个<code>斐波那契数列</code>计算。此刻，其它的异步任务就算完成也无法得到执行，比如底层IO获得了命令，但是由于JavaScript堵塞了而无法执行<code>callback</code>创建新进程执行shell脚本。等到<code>斐波那契数列</code>执行完后，callback才被执行。而我们火焰图需要排查的就是什么导致CPU一直繁忙的嗡嗡作响，而上述的问题就是密集的斐波那契数列计算，但是由于JavaScript的执行机制而有可能错过了开启perf的时机。大多数的时候，我们都是发现进程阻塞了或者CPU一直处于繁忙而去主动命令进程开启<code>perf</code>排查问题，所以这个方法获得的数据并不准确。</p>\n<p>如果当前进程一直进程因为繁忙而无法执行新的JavaScript命令，那么我们是否可以通过一个简单的辅助进程来帮忙开启shell脚本呢？</p>\n<h3 id=\"实验\"><a href=\"#实验\" class=\"headerlink\" title=\"实验\"></a>实验</h3><p>因为perf需要Linux环境，我们可以通过Docker在本地启动一个Node.js容器实验下，以Node.js 12为例。</p>\n<p>下载完对应版本的Node.js Docker后，通过下面命令开启一个新的容器，必须带<code>--privileged</code>不然无法使用perf。</p>\n<figure class=\"highlight shell hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --privileged -itd node:12-buster /bin/bash // 启动</span><br><span class=\"line\"></span><br><span class=\"line\">docker attach xxxx  // 进入</span><br></pre></td></tr></table></figure>\n<p>进入Docker容器后安装<code>perf</code></p>\n<figure class=\"highlight shell hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\">apt-get install linux-perf</span><br><span class=\"line\"></span><br><span class=\"line\">perf_4.19 // 执行该命令查看是否安装成功，不同的linux内核版本对应不同的perf版本</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://github.com/miser/test-perf\" target=\"_blank\" rel=\"noopener\">代码</a></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// index.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123;fork &#125; = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>)</span><br><span class=\"line\">fork(<span class=\"hljs-string\">'./helper'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">fibonacci(<span class=\"hljs-number\">50</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">fibonacci</span>(<span class=\"hljs-params\">n</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span>(n==<span class=\"hljs-number\">0</span> || n == <span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">return</span> n;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> fibonacci(n<span class=\"hljs-number\">-1</span>) + fibonacci(n<span class=\"hljs-number\">-2</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// helper.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> fs = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'fs'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> path = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'path'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123; spawn, exec &#125; = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> unzipper = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">\"unzipper\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> perfCMD = <span class=\"hljs-string\">'perf_4.19'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> perfTime = <span class=\"hljs-number\">60</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">execCMD</span>(<span class=\"hljs-params\">cmd, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    exec(cmd, (error, stdout, stderr) =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'shell: '</span>,cmd)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (error) &#123;</span><br><span class=\"line\">        <span class=\"hljs-built_in\">console</span>.error(<span class=\"hljs-string\">`执行的错误: <span class=\"hljs-subst\">$&#123;error&#125;</span>`</span>);</span><br><span class=\"line\">        reject(error)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span>(callback) &#123;</span><br><span class=\"line\">        callback(stdout, stderr, resolve, reject);</span><br><span class=\"line\">      &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">        resolve()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Flame</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.nodes = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>._init().catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>)</span>&#123;</span><br><span class=\"line\">      <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _init () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> zipFilePath = path.join(<span class=\"hljs-string\">'.'</span>, <span class=\"hljs-string\">'FlameGraph.zip'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> saveDir = process.cwd();</span><br><span class=\"line\">      fs.createReadStream(zipFilePath)</span><br><span class=\"line\">        .pipe(unzipper.Extract(&#123; <span class=\"hljs-attr\">path</span>: saveDir &#125;))</span><br><span class=\"line\">        .on(<span class=\"hljs-string\">\"error\"</span>, reject)</span><br><span class=\"line\">        .on(<span class=\"hljs-string\">\"finish\"</span>, () =&gt; &#123;</span><br><span class=\"line\">          <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">\"zip finish\"</span>);</span><br><span class=\"line\">          resolve();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`chmod 700 ./FlameGraph/stackcollapse-perf.pl`</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> execCMD(cmd);</span><br><span class=\"line\">    &#125;).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`chmod 700 ./FlameGraph/flamegraph.pl`</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> execCMD(cmd);</span><br><span class=\"line\">    &#125;).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '&#123;print $2&#125;'`</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> execCMD(cmd, (stdout, stderr, resolve, reject) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.nodes = stdout.split(<span class=\"hljs-string\">'\\n'</span>).filter( <span class=\"hljs-function\"><span class=\"hljs-params\">pid</span> =&gt;</span> pid &amp;&amp; pid != process.pid)</span><br><span class=\"line\">        resolve();</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _chownMapFile()&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`chown root /tmp/perf-<span class=\"hljs-subst\">$&#123;<span class=\"hljs-keyword\">this</span>.nodes[<span class=\"hljs-number\">0</span>]&#125;</span>.map &amp;&amp; <span class=\"hljs-subst\">$&#123;perfCMD&#125;</span> script &gt; nodestacks`</span>;</span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>._genFlameGraph();</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _genFlameGraph()&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`./FlameGraph/stackcollapse-perf.pl &lt; nodestacks | ./FlameGraph/flamegraph.pl --colors js &gt; node-flamegraph-<span class=\"hljs-subst\">$&#123;process.pid&#125;</span>.svg`</span></span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'had completed'</span>);</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  record() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`<span class=\"hljs-subst\">$&#123;perfCMD&#125;</span> record -F 99 -p <span class=\"hljs-subst\">$&#123;<span class=\"hljs-keyword\">this</span>.nodes[<span class=\"hljs-number\">0</span>]&#125;</span> -g -- sleep <span class=\"hljs-subst\">$&#123;perfTime&#125;</span>`</span>;</span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> t = <span class=\"hljs-number\">1000</span> * (perfTime + <span class=\"hljs-number\">5</span>);</span><br><span class=\"line\">      setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>._chownMapFile()</span><br><span class=\"line\">      &#125;, <span class=\"hljs-number\">1000</span> * (perfTime + <span class=\"hljs-number\">5</span>))</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> flame = <span class=\"hljs-keyword\">new</span> Flame();</span><br><span class=\"line\">setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// 模拟收到tcp命令</span></span><br><span class=\"line\">  flame.record();</span><br><span class=\"line\">&#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">5</span>)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight json hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// package.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"name\"</span>: <span class=\"hljs-string\">\"test-perf\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"version\"</span>: <span class=\"hljs-string\">\"1.0.0\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"description\"</span>: <span class=\"hljs-string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"main\"</span>: <span class=\"hljs-string\">\"index.js\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"dev\"</span>: <span class=\"hljs-string\">\"node --perf-basic-prof index.js\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"clear\"</span>: <span class=\"hljs-string\">\"rm isolate-* &amp; rm node-flamegraph-*.svg &amp; rm -rf FlameGraph\"</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"keywords\"</span>: [],</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"author\"</span>: <span class=\"hljs-string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"license\"</span>: <span class=\"hljs-string\">\"ISC\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"dependencies\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"unzipper\"</span>: <span class=\"hljs-string\">\"^0.10.8\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>index.js: 创建一个辅助进程；执行斐波那契数列计算</li>\n<li>hepler.js: 将压缩的FlameGraph.zip解压 =&gt; 给相关文件执行权限 =&gt; 获得当前系统中除自己以外的Node.js进程号（因为可能是多个，所以是个数组，例子中假设就一个进程）=&gt; 定时模拟获得生成火焰图的命令 =&gt; 执行 perf record =&gt; 延迟5秒后生成火焰图</li>\n<li>package.json: 启动 index.js 需要加上<code>--perf-basic-prof</code>命令行参数；另外还需要<code>unzipper</code>类包</li>\n</ul>\n<p>将他们通过docker cp 从本地上传到docker中，并执行npm i安装依赖。</p>\n<figure class=\"highlight shell hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run dev // 开始实验</span><br></pre></td></tr></table></figure>\n<p>随着一阵的风扇狂响（CPU密集计算）之后，火焰图也生成好了，大致如下：</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/node-flamegraph.png\" alt=\"CPU火焰图\"></p>\n<p>之前的框架也做部分调整，每个容器需要一个Helper.js进程</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_02.png\" alt=\"调整后的框架\"></p>\n<h4 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h4><p>我觉得程序员和程序猿之间的差别就在有没有一套好的监控体系和善用监控调优及排查问题的方法。如果没办法使用现成的第三方服务，往往需要自己动手去搭建，无论业务多么繁忙，唯有趁手的“兵器”才能取得真经，这是需要据理力争的东西。只有水下的冰够厚，水上的冰山才能更高。</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p>如果你在一家对数据安全性很高的公司工作，团队规定不允许提交数据到第三方服务上，甚至连服务器内存、CPU使用情况等监控数据都不行，那对于像<a href=\"https://cn.aliyun.com/product/nodejs\" target=\"_blank\" rel=\"noopener\">Alinode</a>这样监控和排查问题的大杀器基本都是无福享用了。大多数情况不得不面临自己开发一套类似监控体制去为生产环境保驾护航。</p>","more":"<p><br></p>\n<p><br></p>\n<h2 id=\"数据\"><a href=\"#数据\" class=\"headerlink\" title=\"数据\"></a>数据</h2><p><em>Node.js是单进程的，即使像Egg.js这样的项目存在Agent、多个Worker进程，但依旧应该把它们分为独立的进程对待，所以监控的粒度是进程级别。</em></p>\n<h4 id=\"基础数据\"><a href=\"#基础数据\" class=\"headerlink\" title=\"基础数据\"></a>基础数据</h4><ul>\n<li>进程级别：内存、CPU、EventLoop、GC、调用该系统的时间消耗、该系统调用它人系统的时间消耗等。</li>\n<li>系统级别：负载均衡 （<code>os.loadavg()</code>）</li>\n</ul>\n<p>上述这些数据，有些Node.js API直接暴露出来，有些需要写C++扩展去调用底层的V8 API来获取，好在市面上存在比较多的此类类库，比如<a href=\"https://github.com/RuntimeTools/appmetrics\" target=\"_blank\" rel=\"noopener\">IBM appmetrics</a>就不错，它还有很多额外的监控数据可以收集，<code>主动</code>定时将它们提交到Elasticsearch，在用Grafana加载出来，还是很容易做到的。</p>\n<p><br></p>\n<h4 id=\"内存堆栈快照\"><a href=\"#内存堆栈快照\" class=\"headerlink\" title=\"内存堆栈快照\"></a>内存堆栈快照</h4><ul>\n<li>通过多份内存堆栈快照可以帮助我们定位内存溢出的原因。</li>\n</ul>\n<h4 id=\"CPU火焰图\"><a href=\"#CPU火焰图\" class=\"headerlink\" title=\"CPU火焰图\"></a><a href=\"http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html\" target=\"_blank\" rel=\"noopener\">CPU火焰图</a></h4><ul>\n<li>通过它可以让我们知道是代码的哪部分导致CPU非常繁忙。</li>\n</ul>\n<p>上面这2个文件在系统调优和排查问题时起到至关重要的帮助，但是它们都是以文件的形式存储，又不像<code>基础数据</code>那么简易可以直接塞进DB里；另外获取这些资源过程是影响应用性能的，比如<code>内存堆栈快照</code>因为要罗列出所有的堆栈对象相互之间的关系和字节大小需要一定的计算量和时间，在此过程中系统处于无法响应的状态。为此，我们需要设计一套方法，在需要的时候去通知对应的Node.js进程，<code>被动</code>生成这些文件，而不是向先前那样<code>主动</code>收集。</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"命令-amp-传输\"><a href=\"#命令-amp-传输\" class=\"headerlink\" title=\"命令&amp;传输\"></a>命令&amp;传输</h2><p>我们需要通过一些方法，告诉对应的Node.js进程该干些什么事情，是生成内存堆栈快照还是CPU火焰图，又或是别的什么。需要一个发送<code>命令</code>的地方，也需要一种方式将命令发送给指定的Node.js进程。将一个个孤立的Node.js进程连接起来有很多方式，比如TCP，或者HTTP。</p>\n<p>我个人比较倾向用TCP，长链、双向、数据帧也轻巧很多，等等。像下图那样将他们连起来，<strong>仅用来示意，具体细节会有些不同，简单的粗暴将单箭头表示HTTP，双箭头表示TCP双向。</strong></p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_01.png\" alt=\"连接示意图\"></p>\n<ul>\n<li><strong>命令发送：</strong>一般会有一个Web界面，通过按钮提交命令请求。</li>\n<li><strong>Hub：</strong>一个TCP服务，接受命令并将其转发到对应的Node.js进程上。</li>\n<li><strong>Node.js Process:</strong> 可能一台服务器（或者Docker等）就一个Node.js进程，如Express；也有可能如Egg.js一样是多个Node.js进程。</li>\n<li><strong>DFS：</strong>因为现在的服务基本都是部署在像Docker这样虚拟机上的，服务出现问题或人工原因很容易随时被系统销毁导致生产的快照或火焰图丢失，所以需要有个文件服务器持久化它们，因此一旦文件生产后就推送到文件服务器上待使用者去下载它们。</li>\n</ul>\n<p><br></p>\n<p><br></p>\n<h2 id=\"内存堆栈快照-1\"><a href=\"#内存堆栈快照-1\" class=\"headerlink\" title=\"内存堆栈快照\"></a>内存堆栈快照</h2><p>Node.js Process监听到发来的<code>命令</code>，通过调用<a href=\"https://www.npmjs.com/package/heapdump\" target=\"_blank\" rel=\"noopener\">heapdump</a>很容易获得内存堆栈快照，再将文件推送到DFS上。如果想像<code>Alinode</code>那样自动又直接显示内存信息的话，改下<a href=\"https://github.com/ChromeDevTools/devtools-frontend\" target=\"_blank\" rel=\"noopener\">devtools-frontend</a>，将其加入到系统中即可。</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/heapdump_01.png\" alt=\"devtools 自动加载内存快照\"></p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"CPU火焰图-1\"><a href=\"#CPU火焰图-1\" class=\"headerlink\" title=\"CPU火焰图\"></a>CPU火焰图</h2><p>火焰图比其它的数据麻烦很多，官方有专门的<a href=\"https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/\" target=\"_blank\" rel=\"noopener\">文档</a>说明了整个流程，总的来说需要<a href=\"http://www.brendangregg.com/perf.html\" target=\"_blank\" rel=\"noopener\">perf</a>和<a href=\"https://github.com/brendangregg/FlameGraph\" target=\"_blank\" rel=\"noopener\">FlameGraph</a>这两个工具，具体的方法随意Google都能查到很多，就不多叙述了，关键是如何将它融入到上述的框架中呢？</p>\n<p>假设和之前一样，Node.js进程用<code>socket.on(&quot;readable&quot;,callback)</code> 或 <code>socket.on(&quot;data&quot;,callback)</code>接受命令，并在callback中开启一个新的进程来执行<code>perf</code>等shell脚本，那么生成的火焰图不准确，为何？</p>\n<p>Node.js是单进程，JavaScript部分是事件循环，密集计算会阻塞其它的操作，比如运行一个<code>斐波那契数列</code>计算。此刻，其它的异步任务就算完成也无法得到执行，比如底层IO获得了命令，但是由于JavaScript堵塞了而无法执行<code>callback</code>创建新进程执行shell脚本。等到<code>斐波那契数列</code>执行完后，callback才被执行。而我们火焰图需要排查的就是什么导致CPU一直繁忙的嗡嗡作响，而上述的问题就是密集的斐波那契数列计算，但是由于JavaScript的执行机制而有可能错过了开启perf的时机。大多数的时候，我们都是发现进程阻塞了或者CPU一直处于繁忙而去主动命令进程开启<code>perf</code>排查问题，所以这个方法获得的数据并不准确。</p>\n<p>如果当前进程一直进程因为繁忙而无法执行新的JavaScript命令，那么我们是否可以通过一个简单的辅助进程来帮忙开启shell脚本呢？</p>\n<h3 id=\"实验\"><a href=\"#实验\" class=\"headerlink\" title=\"实验\"></a>实验</h3><p>因为perf需要Linux环境，我们可以通过Docker在本地启动一个Node.js容器实验下，以Node.js 12为例。</p>\n<p>下载完对应版本的Node.js Docker后，通过下面命令开启一个新的容器，必须带<code>--privileged</code>不然无法使用perf。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --privileged -itd node:12-buster /bin/bash // 启动</span><br><span class=\"line\"></span><br><span class=\"line\">docker attach xxxx  // 进入</span><br></pre></td></tr></table></figure>\n<p>进入Docker容器后安装<code>perf</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\">apt-get install linux-perf</span><br><span class=\"line\"></span><br><span class=\"line\">perf_4.19 // 执行该命令查看是否安装成功，不同的linux内核版本对应不同的perf版本</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://github.com/miser/test-perf\" target=\"_blank\" rel=\"noopener\">代码</a></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// index.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123;fork &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'child_process'</span>)</span><br><span class=\"line\">fork(<span class=\"string\">'./helper'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">fibonacci(<span class=\"number\">50</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">fibonacci</span>(<span class=\"params\">n</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(n==<span class=\"number\">0</span> || n == <span class=\"number\">1</span>) <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> fibonacci(n<span class=\"number\">-1</span>) + fibonacci(n<span class=\"number\">-2</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// helper.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">'fs'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; spawn, exec &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'child_process'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> unzipper = <span class=\"built_in\">require</span>(<span class=\"string\">\"unzipper\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> perfCMD = <span class=\"string\">'perf_4.19'</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> perfTime = <span class=\"number\">60</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">execCMD</span>(<span class=\"params\">cmd, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    exec(cmd, (error, stdout, stderr) =&gt; &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">'shell: '</span>,cmd)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (error) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.error(<span class=\"string\">`执行的错误: <span class=\"subst\">$&#123;error&#125;</span>`</span>);</span><br><span class=\"line\">        reject(error)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(callback) &#123;</span><br><span class=\"line\">        callback(stdout, stderr, resolve, reject);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        resolve()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Flame</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.nodes = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>._init().catch(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>)</span>&#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _init () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> zipFilePath = path.join(<span class=\"string\">'.'</span>, <span class=\"string\">'FlameGraph.zip'</span>)</span><br><span class=\"line\">      <span class=\"keyword\">const</span> saveDir = process.cwd();</span><br><span class=\"line\">      fs.createReadStream(zipFilePath)</span><br><span class=\"line\">        .pipe(unzipper.Extract(&#123; <span class=\"attr\">path</span>: saveDir &#125;))</span><br><span class=\"line\">        .on(<span class=\"string\">\"error\"</span>, reject)</span><br><span class=\"line\">        .on(<span class=\"string\">\"finish\"</span>, () =&gt; &#123;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.log(<span class=\"string\">\"zip finish\"</span>);</span><br><span class=\"line\">          resolve();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> cmd = <span class=\"string\">`chmod 700 ./FlameGraph/stackcollapse-perf.pl`</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> execCMD(cmd);</span><br><span class=\"line\">    &#125;).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> cmd = <span class=\"string\">`chmod 700 ./FlameGraph/flamegraph.pl`</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> execCMD(cmd);</span><br><span class=\"line\">    &#125;).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> cmd = <span class=\"string\">`ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '&#123;print $2&#125;'`</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> execCMD(cmd, (stdout, stderr, resolve, reject) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.nodes = stdout.split(<span class=\"string\">'\\n'</span>).filter( <span class=\"function\"><span class=\"params\">pid</span> =&gt;</span> pid &amp;&amp; pid != process.pid)</span><br><span class=\"line\">        resolve();</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _chownMapFile()&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cmd = <span class=\"string\">`chown root /tmp/perf-<span class=\"subst\">$&#123;<span class=\"keyword\">this</span>.nodes[<span class=\"number\">0</span>]&#125;</span>.map &amp;&amp; <span class=\"subst\">$&#123;perfCMD&#125;</span> script &gt; nodestacks`</span>;</span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>._genFlameGraph();</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _genFlameGraph()&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cmd = <span class=\"string\">`./FlameGraph/stackcollapse-perf.pl &lt; nodestacks | ./FlameGraph/flamegraph.pl --colors js &gt; node-flamegraph-<span class=\"subst\">$&#123;process.pid&#125;</span>.svg`</span></span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">'had completed'</span>);</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  record() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cmd = <span class=\"string\">`<span class=\"subst\">$&#123;perfCMD&#125;</span> record -F 99 -p <span class=\"subst\">$&#123;<span class=\"keyword\">this</span>.nodes[<span class=\"number\">0</span>]&#125;</span> -g -- sleep <span class=\"subst\">$&#123;perfTime&#125;</span>`</span>;</span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> t = <span class=\"number\">1000</span> * (perfTime + <span class=\"number\">5</span>);</span><br><span class=\"line\">      setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>._chownMapFile()</span><br><span class=\"line\">      &#125;, <span class=\"number\">1000</span> * (perfTime + <span class=\"number\">5</span>))</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> flame = <span class=\"keyword\">new</span> Flame();</span><br><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 模拟收到tcp命令</span></span><br><span class=\"line\">  flame.record();</span><br><span class=\"line\">&#125;, <span class=\"number\">1000</span> * <span class=\"number\">5</span>)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// package.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"name\"</span>: <span class=\"string\">\"test-perf\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"version\"</span>: <span class=\"string\">\"1.0.0\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"description\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"main\"</span>: <span class=\"string\">\"index.js\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"dev\"</span>: <span class=\"string\">\"node --perf-basic-prof index.js\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"clear\"</span>: <span class=\"string\">\"rm isolate-* &amp; rm node-flamegraph-*.svg &amp; rm -rf FlameGraph\"</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">\"keywords\"</span>: [],</span><br><span class=\"line\">  <span class=\"attr\">\"author\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"license\"</span>: <span class=\"string\">\"ISC\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"dependencies\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"unzipper\"</span>: <span class=\"string\">\"^0.10.8\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>index.js: 创建一个辅助进程；执行斐波那契数列计算</li>\n<li>hepler.js: 将压缩的FlameGraph.zip解压 =&gt; 给相关文件执行权限 =&gt; 获得当前系统中除自己以外的Node.js进程号（因为可能是多个，所以是个数组，例子中假设就一个进程）=&gt; 定时模拟获得生成火焰图的命令 =&gt; 执行 perf record =&gt; 延迟5秒后生成火焰图</li>\n<li>package.json: 启动 index.js 需要加上<code>--perf-basic-prof</code>命令行参数；另外还需要<code>unzipper</code>类包</li>\n</ul>\n<p>将他们通过docker cp 从本地上传到docker中，并执行npm i安装依赖。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run dev // 开始实验</span><br></pre></td></tr></table></figure>\n<p>随着一阵的风扇狂响（CPU密集计算）之后，火焰图也生成好了，大致如下：</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/node-flamegraph.png\" alt=\"CPU火焰图\"></p>\n<p>之前的框架也做部分调整，每个容器需要一个Helper.js进程</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_02.png\" alt=\"调整后的框架\"></p>\n<h4 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h4><p>我觉得程序员和程序猿之间的差别就在有没有一套好的监控体系和善用监控调优及排查问题的方法。如果没办法使用现成的第三方服务，往往需要自己动手去搭建，无论业务多么繁忙，唯有趁手的“兵器”才能取得真经，这是需要据理力争的东西。只有水下的冰够厚，水上的冰山才能更高。</p>"},{"layout":"minos","title":"Istio简单概念","date":"2020-06-28T02:00:00.000Z","keywords":"Istio,Node.js,JavaScript,前端","description":"学Istio必定要学习K8s Docker等基本的运维知识，那么在设计一个BFF层的时候必定会考虑到是不是符合它们的设计哲学，是否是一个方便维护的应用 某个节点压力大的时候该怎么办 某个节点出现问题该怎么排查等等","_content":"\n_文章中主要是一些概念，简单记录这段时间对 Istio 的学习。_\n\n对于全栈来说，学习 Istio 还是很有必要的，在此过程中还要学习 K8s、Docker 等基本的运维知识，那么在设计 BFF 层时候也会考虑到部署、扩容、金丝雀发布等问题，提升程序的健壮性。\n\n### JavaScript 全栈\n\n在 JavaScript 流行的今天，各种框架层出不穷，无论是学习前端的 3 架马车（React\\Vue\\Angular）、还是运用后端的 Node.js 框架（Express\\Koa\\Egg.js）等，最后你都会前后端通吃，它们被 JavaScript 这门语言串联在了一起，尤其是当你去翻阅大量前端使用的 CLI 工具源码的时候，几乎都有 Express 的影子，所以在 JavaScript 技术栈里，前后端（这里的后端不是指复杂的后端架构和设计）本身并不分家。_当然复杂的后端或前端工作并不适合全栈工程师去做，那也是后话了。_\n\n<br/>\n\n### BFF 层\n\n这些年来提出了 BFF 层的概念，根据业务的不同，不同公司有自己的设计和实现，比如将纯前端从 Nginx 移到了 Node.js Server 运行环境、服务端渲染（SSR）、生成或者拼接业务数据返回给前端使用（Node.js 微服务、GraphQL 等）...\n\n<br/>\n\n### Node.js 微服务\n\n自己也做过很长一段时间的全栈，用 Node.js 开发后端业务，把数据吐给前端，不需要等着后端同事返回数据或者来回沟通的烦恼。现在做后端必定会遇到微服务的概念，不同的微服务有自己的 SDK 等工具帮助完成相关的注册发现，大多数情况下它们对 Java 的支持度最好，Node.js 有时候并不友善，要完善你不得不去写一些代码，比如熔断、报警等等，也是带来大量的开发测试成本。如果不幸公司内部 Java 组选择了不支持 Node.js 的架构，那么简直是灾难。\n\n**微服务的 SDK 基本上和网络通讯相关，下文的网络化可以解决这个问题。**\n\n<!-- more -->\n\n<br/>\n\n### 部署\n\n手动拷贝代码到服务器上 》 Docker 化 》 K8s\n\n如果没有 K8s，只是 Docker 的话，部署过程还是很僵硬的。有了 K8s：\n\n- 自动化的容器部署\n- 按需扩展、收缩和替换\n- Docker 之间的负载均衡\n- 轻松升级版本和一键回滚\n- 认证\n- 服务的发现\n- 基础的服务监控和监控检查\n- ...\n\nK8s 可以相对轻松地管理成千上万的微服务，但是正如前面提到，因为微服务的语言不通，导致不通微服务在网络层面的功能完整性是不同的（SDK 的支持度不同），产生木桶效应。为了避免这个效应要么增加人员投入到不完善的 SDK 开发当中保持其迭代和稳定，要么聚集大量支持度较高的 SDK 开发者去完成业务工作。其实这个都是在浪费人力资源。\n\n<br/>\n\n### 网格化\n\n网格化增加了服务之间通信的便捷性，解决了微服务不同语言 SDK 的差异问题，每个微服务只要聚焦自身的业务而不再需要关心服务之间的熔断、报警等问题。\n\nIstio 构建在 K8s 之上，是网格化概念的一个实现，我就以它为例。\n\n![Istio 架构](/images/nodejs-istio-k8s-docker/arch.jpg)\n\n服务 A 和服务 B 并不直接通信，而是通过代理的方式，这个代理基本上支持 HTTP/1.1、HTTP/2、gRPC 或 TCP 等协议。\n\n#### Envoy\n\n在 Istio 中默认使用**Envoy**作为这个代理的实现，我们称之为 Sidecar，把微服务网络通信的 SDK 抽取出来，统一交给这个 Sidecar 管理控制。\n\n主要的功能：\n\n- HTTP 7 层路由\n- 支持多种通信协议\n- 服务发现和动态配置\n- 健康检查\n- 高级负载均衡\n- 将流量行为和数据提取，转发给 Mixer 组件\n\n原理，K8s 环境中，同一个 Pod 内的不同容器间共享网络栈，使得 Sidecar 可以接管进出这个容器的网络流量。\n\n#### Pilot\n\n配置和管理 Envoy 代理，比如流量规则、超时、熔断等，将这些信息通过通过 API 转我 Envoy 理解的格式，并广播给它们。\n\n#### Mixer\n\nEnvoy 通信时候，都会向 Mixer 发出预检请求，验证行为的有效性、上报数据等，为了提高性能可以使用缓存和异步提交数据。\n\n主要功能：\n\n- 策略：Istio 依仗该功能实现限流、黑白名单等功能\n- 遥测：Istio 通过它收集所有的流量数据\n\n#### Citadel\n\n身份和证书管理\n\n#### Galley\n\nGalley 是 Istio 的配置验证、提取、处理和分发组件。\n\n### 实例\n\n官方 [Bookinfo 应用](https://istio.io/latest/zh/docs/examples/bookinfo/)，它由 Python、Java、Ruby、Node.js，4 种语言框架组成。实例中实现了多版本切换、金丝雀发布等等。各个模块只要专注在自己的业务领域，不需要关心网络控制。\n\n![Bookinfo 应用 架构](/images/nodejs-istio-k8s-docker/book-app.png)\n\n网格化逐渐成为未来趋势，很多大厂在对内部系统做大量改造和升级，作为全栈工程师和架构师来说也需要紧跟时代的步伐。\n","source":"_posts/nodejs-istio-k8s-docker.md","raw":"---\nlayout: minos\ntitle: Istio简单概念\ndate: 2020-06-28 10:00:00\ncategory: 架构\ntags:\n  - 架构\n  - 运维\nkeywords: Istio,Node.js,JavaScript,前端\ndescription: 学Istio必定要学习K8s Docker等基本的运维知识，那么在设计一个BFF层的时候必定会考虑到是不是符合它们的设计哲学，是否是一个方便维护的应用 某个节点压力大的时候该怎么办 某个节点出现问题该怎么排查等等\n---\n\n_文章中主要是一些概念，简单记录这段时间对 Istio 的学习。_\n\n对于全栈来说，学习 Istio 还是很有必要的，在此过程中还要学习 K8s、Docker 等基本的运维知识，那么在设计 BFF 层时候也会考虑到部署、扩容、金丝雀发布等问题，提升程序的健壮性。\n\n### JavaScript 全栈\n\n在 JavaScript 流行的今天，各种框架层出不穷，无论是学习前端的 3 架马车（React\\Vue\\Angular）、还是运用后端的 Node.js 框架（Express\\Koa\\Egg.js）等，最后你都会前后端通吃，它们被 JavaScript 这门语言串联在了一起，尤其是当你去翻阅大量前端使用的 CLI 工具源码的时候，几乎都有 Express 的影子，所以在 JavaScript 技术栈里，前后端（这里的后端不是指复杂的后端架构和设计）本身并不分家。_当然复杂的后端或前端工作并不适合全栈工程师去做，那也是后话了。_\n\n<br/>\n\n### BFF 层\n\n这些年来提出了 BFF 层的概念，根据业务的不同，不同公司有自己的设计和实现，比如将纯前端从 Nginx 移到了 Node.js Server 运行环境、服务端渲染（SSR）、生成或者拼接业务数据返回给前端使用（Node.js 微服务、GraphQL 等）...\n\n<br/>\n\n### Node.js 微服务\n\n自己也做过很长一段时间的全栈，用 Node.js 开发后端业务，把数据吐给前端，不需要等着后端同事返回数据或者来回沟通的烦恼。现在做后端必定会遇到微服务的概念，不同的微服务有自己的 SDK 等工具帮助完成相关的注册发现，大多数情况下它们对 Java 的支持度最好，Node.js 有时候并不友善，要完善你不得不去写一些代码，比如熔断、报警等等，也是带来大量的开发测试成本。如果不幸公司内部 Java 组选择了不支持 Node.js 的架构，那么简直是灾难。\n\n**微服务的 SDK 基本上和网络通讯相关，下文的网络化可以解决这个问题。**\n\n<!-- more -->\n\n<br/>\n\n### 部署\n\n手动拷贝代码到服务器上 》 Docker 化 》 K8s\n\n如果没有 K8s，只是 Docker 的话，部署过程还是很僵硬的。有了 K8s：\n\n- 自动化的容器部署\n- 按需扩展、收缩和替换\n- Docker 之间的负载均衡\n- 轻松升级版本和一键回滚\n- 认证\n- 服务的发现\n- 基础的服务监控和监控检查\n- ...\n\nK8s 可以相对轻松地管理成千上万的微服务，但是正如前面提到，因为微服务的语言不通，导致不通微服务在网络层面的功能完整性是不同的（SDK 的支持度不同），产生木桶效应。为了避免这个效应要么增加人员投入到不完善的 SDK 开发当中保持其迭代和稳定，要么聚集大量支持度较高的 SDK 开发者去完成业务工作。其实这个都是在浪费人力资源。\n\n<br/>\n\n### 网格化\n\n网格化增加了服务之间通信的便捷性，解决了微服务不同语言 SDK 的差异问题，每个微服务只要聚焦自身的业务而不再需要关心服务之间的熔断、报警等问题。\n\nIstio 构建在 K8s 之上，是网格化概念的一个实现，我就以它为例。\n\n![Istio 架构](/images/nodejs-istio-k8s-docker/arch.jpg)\n\n服务 A 和服务 B 并不直接通信，而是通过代理的方式，这个代理基本上支持 HTTP/1.1、HTTP/2、gRPC 或 TCP 等协议。\n\n#### Envoy\n\n在 Istio 中默认使用**Envoy**作为这个代理的实现，我们称之为 Sidecar，把微服务网络通信的 SDK 抽取出来，统一交给这个 Sidecar 管理控制。\n\n主要的功能：\n\n- HTTP 7 层路由\n- 支持多种通信协议\n- 服务发现和动态配置\n- 健康检查\n- 高级负载均衡\n- 将流量行为和数据提取，转发给 Mixer 组件\n\n原理，K8s 环境中，同一个 Pod 内的不同容器间共享网络栈，使得 Sidecar 可以接管进出这个容器的网络流量。\n\n#### Pilot\n\n配置和管理 Envoy 代理，比如流量规则、超时、熔断等，将这些信息通过通过 API 转我 Envoy 理解的格式，并广播给它们。\n\n#### Mixer\n\nEnvoy 通信时候，都会向 Mixer 发出预检请求，验证行为的有效性、上报数据等，为了提高性能可以使用缓存和异步提交数据。\n\n主要功能：\n\n- 策略：Istio 依仗该功能实现限流、黑白名单等功能\n- 遥测：Istio 通过它收集所有的流量数据\n\n#### Citadel\n\n身份和证书管理\n\n#### Galley\n\nGalley 是 Istio 的配置验证、提取、处理和分发组件。\n\n### 实例\n\n官方 [Bookinfo 应用](https://istio.io/latest/zh/docs/examples/bookinfo/)，它由 Python、Java、Ruby、Node.js，4 种语言框架组成。实例中实现了多版本切换、金丝雀发布等等。各个模块只要专注在自己的业务领域，不需要关心网络控制。\n\n![Bookinfo 应用 架构](/images/nodejs-istio-k8s-docker/book-app.png)\n\n网格化逐渐成为未来趋势，很多大厂在对内部系统做大量改造和升级，作为全栈工程师和架构师来说也需要紧跟时代的步伐。\n","slug":"nodejs-istio-k8s-docker","published":1,"updated":"2020-07-07T10:11:25.589Z","comments":1,"photos":[],"link":"","_id":"ckcc0bs6a000pd12iw204eeos","content":"<p><em>文章中主要是一些概念，简单记录这段时间对 Istio 的学习。</em></p>\n<p>对于全栈来说，学习 Istio 还是很有必要的，在此过程中还要学习 K8s、Docker 等基本的运维知识，那么在设计 BFF 层时候也会考虑到部署、扩容、金丝雀发布等问题，提升程序的健壮性。</p>\n<h3 id=\"JavaScript-全栈\"><a href=\"#JavaScript-全栈\" class=\"headerlink\" title=\"JavaScript 全栈\"></a>JavaScript 全栈</h3><p>在 JavaScript 流行的今天，各种框架层出不穷，无论是学习前端的 3 架马车（React\\Vue\\Angular）、还是运用后端的 Node.js 框架（Express\\Koa\\Egg.js）等，最后你都会前后端通吃，它们被 JavaScript 这门语言串联在了一起，尤其是当你去翻阅大量前端使用的 CLI 工具源码的时候，几乎都有 Express 的影子，所以在 JavaScript 技术栈里，前后端（这里的后端不是指复杂的后端架构和设计）本身并不分家。<em>当然复杂的后端或前端工作并不适合全栈工程师去做，那也是后话了。</em></p>\n<p><br></p>\n<h3 id=\"BFF-层\"><a href=\"#BFF-层\" class=\"headerlink\" title=\"BFF 层\"></a>BFF 层</h3><p>这些年来提出了 BFF 层的概念，根据业务的不同，不同公司有自己的设计和实现，比如将纯前端从 Nginx 移到了 Node.js Server 运行环境、服务端渲染（SSR）、生成或者拼接业务数据返回给前端使用（Node.js 微服务、GraphQL 等）…</p>\n<p><br></p>\n<h3 id=\"Node-js-微服务\"><a href=\"#Node-js-微服务\" class=\"headerlink\" title=\"Node.js 微服务\"></a>Node.js 微服务</h3><p>自己也做过很长一段时间的全栈，用 Node.js 开发后端业务，把数据吐给前端，不需要等着后端同事返回数据或者来回沟通的烦恼。现在做后端必定会遇到微服务的概念，不同的微服务有自己的 SDK 等工具帮助完成相关的注册发现，大多数情况下它们对 Java 的支持度最好，Node.js 有时候并不友善，要完善你不得不去写一些代码，比如熔断、报警等等，也是带来大量的开发测试成本。如果不幸公司内部 Java 组选择了不支持 Node.js 的架构，那么简直是灾难。</p>\n<p><strong>微服务的 SDK 基本上和网络通讯相关，下文的网络化可以解决这个问题。</strong></p>\n<a id=\"more\"></a>\n<p><br></p>\n<h3 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h3><p>手动拷贝代码到服务器上 》 Docker 化 》 K8s</p>\n<p>如果没有 K8s，只是 Docker 的话，部署过程还是很僵硬的。有了 K8s：</p>\n<ul>\n<li>自动化的容器部署</li>\n<li>按需扩展、收缩和替换</li>\n<li>Docker 之间的负载均衡</li>\n<li>轻松升级版本和一键回滚</li>\n<li>认证</li>\n<li>服务的发现</li>\n<li>基础的服务监控和监控检查</li>\n<li>…</li>\n</ul>\n<p>K8s 可以相对轻松地管理成千上万的微服务，但是正如前面提到，因为微服务的语言不通，导致不通微服务在网络层面的功能完整性是不同的（SDK 的支持度不同），产生木桶效应。为了避免这个效应要么增加人员投入到不完善的 SDK 开发当中保持其迭代和稳定，要么聚集大量支持度较高的 SDK 开发者去完成业务工作。其实这个都是在浪费人力资源。</p>\n<p><br></p>\n<h3 id=\"网格化\"><a href=\"#网格化\" class=\"headerlink\" title=\"网格化\"></a>网格化</h3><p>网格化增加了服务之间通信的便捷性，解决了微服务不同语言 SDK 的差异问题，每个微服务只要聚焦自身的业务而不再需要关心服务之间的熔断、报警等问题。</p>\n<p>Istio 构建在 K8s 之上，是网格化概念的一个实现，我就以它为例。</p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/arch.jpg\" alt=\"Istio 架构\"></p>\n<p>服务 A 和服务 B 并不直接通信，而是通过代理的方式，这个代理基本上支持 HTTP/1.1、HTTP/2、gRPC 或 TCP 等协议。</p>\n<h4 id=\"Envoy\"><a href=\"#Envoy\" class=\"headerlink\" title=\"Envoy\"></a>Envoy</h4><p>在 Istio 中默认使用<strong>Envoy</strong>作为这个代理的实现，我们称之为 Sidecar，把微服务网络通信的 SDK 抽取出来，统一交给这个 Sidecar 管理控制。</p>\n<p>主要的功能：</p>\n<ul>\n<li>HTTP 7 层路由</li>\n<li>支持多种通信协议</li>\n<li>服务发现和动态配置</li>\n<li>健康检查</li>\n<li>高级负载均衡</li>\n<li>将流量行为和数据提取，转发给 Mixer 组件</li>\n</ul>\n<p>原理，K8s 环境中，同一个 Pod 内的不同容器间共享网络栈，使得 Sidecar 可以接管进出这个容器的网络流量。</p>\n<h4 id=\"Pilot\"><a href=\"#Pilot\" class=\"headerlink\" title=\"Pilot\"></a>Pilot</h4><p>配置和管理 Envoy 代理，比如流量规则、超时、熔断等，将这些信息通过通过 API 转我 Envoy 理解的格式，并广播给它们。</p>\n<h4 id=\"Mixer\"><a href=\"#Mixer\" class=\"headerlink\" title=\"Mixer\"></a>Mixer</h4><p>Envoy 通信时候，都会向 Mixer 发出预检请求，验证行为的有效性、上报数据等，为了提高性能可以使用缓存和异步提交数据。</p>\n<p>主要功能：</p>\n<ul>\n<li>策略：Istio 依仗该功能实现限流、黑白名单等功能</li>\n<li>遥测：Istio 通过它收集所有的流量数据</li>\n</ul>\n<h4 id=\"Citadel\"><a href=\"#Citadel\" class=\"headerlink\" title=\"Citadel\"></a>Citadel</h4><p>身份和证书管理</p>\n<h4 id=\"Galley\"><a href=\"#Galley\" class=\"headerlink\" title=\"Galley\"></a>Galley</h4><p>Galley 是 Istio 的配置验证、提取、处理和分发组件。</p>\n<h3 id=\"实例\"><a href=\"#实例\" class=\"headerlink\" title=\"实例\"></a>实例</h3><p>官方 <a href=\"https://istio.io/latest/zh/docs/examples/bookinfo/\" target=\"_blank\" rel=\"noopener\">Bookinfo 应用</a>，它由 Python、Java、Ruby、Node.js，4 种语言框架组成。实例中实现了多版本切换、金丝雀发布等等。各个模块只要专注在自己的业务领域，不需要关心网络控制。</p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/book-app.png\" alt=\"Bookinfo 应用 架构\"></p>\n<p>网格化逐渐成为未来趋势，很多大厂在对内部系统做大量改造和升级，作为全栈工程师和架构师来说也需要紧跟时代的步伐。</p>\n","site":{"data":{}},"_categories":[{"name":"架构","path":"categories/架构/"}],"_tags":[{"name":"架构","path":"tags/架构/"},{"name":"运维","path":"tags/运维/"}],"excerpt":"<p><em>文章中主要是一些概念，简单记录这段时间对 Istio 的学习。</em></p>\n<p>对于全栈来说，学习 Istio 还是很有必要的，在此过程中还要学习 K8s、Docker 等基本的运维知识，那么在设计 BFF 层时候也会考虑到部署、扩容、金丝雀发布等问题，提升程序的健壮性。</p>\n<h3 id=\"JavaScript-全栈\"><a href=\"#JavaScript-全栈\" class=\"headerlink\" title=\"JavaScript 全栈\"></a>JavaScript 全栈</h3><p>在 JavaScript 流行的今天，各种框架层出不穷，无论是学习前端的 3 架马车（React\\Vue\\Angular）、还是运用后端的 Node.js 框架（Express\\Koa\\Egg.js）等，最后你都会前后端通吃，它们被 JavaScript 这门语言串联在了一起，尤其是当你去翻阅大量前端使用的 CLI 工具源码的时候，几乎都有 Express 的影子，所以在 JavaScript 技术栈里，前后端（这里的后端不是指复杂的后端架构和设计）本身并不分家。<em>当然复杂的后端或前端工作并不适合全栈工程师去做，那也是后话了。</em></p>\n<p><br></p>\n<h3 id=\"BFF-层\"><a href=\"#BFF-层\" class=\"headerlink\" title=\"BFF 层\"></a>BFF 层</h3><p>这些年来提出了 BFF 层的概念，根据业务的不同，不同公司有自己的设计和实现，比如将纯前端从 Nginx 移到了 Node.js Server 运行环境、服务端渲染（SSR）、生成或者拼接业务数据返回给前端使用（Node.js 微服务、GraphQL 等）…</p>\n<p><br></p>\n<h3 id=\"Node-js-微服务\"><a href=\"#Node-js-微服务\" class=\"headerlink\" title=\"Node.js 微服务\"></a>Node.js 微服务</h3><p>自己也做过很长一段时间的全栈，用 Node.js 开发后端业务，把数据吐给前端，不需要等着后端同事返回数据或者来回沟通的烦恼。现在做后端必定会遇到微服务的概念，不同的微服务有自己的 SDK 等工具帮助完成相关的注册发现，大多数情况下它们对 Java 的支持度最好，Node.js 有时候并不友善，要完善你不得不去写一些代码，比如熔断、报警等等，也是带来大量的开发测试成本。如果不幸公司内部 Java 组选择了不支持 Node.js 的架构，那么简直是灾难。</p>\n<p><strong>微服务的 SDK 基本上和网络通讯相关，下文的网络化可以解决这个问题。</strong></p>","more":"<p><br></p>\n<h3 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h3><p>手动拷贝代码到服务器上 》 Docker 化 》 K8s</p>\n<p>如果没有 K8s，只是 Docker 的话，部署过程还是很僵硬的。有了 K8s：</p>\n<ul>\n<li>自动化的容器部署</li>\n<li>按需扩展、收缩和替换</li>\n<li>Docker 之间的负载均衡</li>\n<li>轻松升级版本和一键回滚</li>\n<li>认证</li>\n<li>服务的发现</li>\n<li>基础的服务监控和监控检查</li>\n<li>…</li>\n</ul>\n<p>K8s 可以相对轻松地管理成千上万的微服务，但是正如前面提到，因为微服务的语言不通，导致不通微服务在网络层面的功能完整性是不同的（SDK 的支持度不同），产生木桶效应。为了避免这个效应要么增加人员投入到不完善的 SDK 开发当中保持其迭代和稳定，要么聚集大量支持度较高的 SDK 开发者去完成业务工作。其实这个都是在浪费人力资源。</p>\n<p><br></p>\n<h3 id=\"网格化\"><a href=\"#网格化\" class=\"headerlink\" title=\"网格化\"></a>网格化</h3><p>网格化增加了服务之间通信的便捷性，解决了微服务不同语言 SDK 的差异问题，每个微服务只要聚焦自身的业务而不再需要关心服务之间的熔断、报警等问题。</p>\n<p>Istio 构建在 K8s 之上，是网格化概念的一个实现，我就以它为例。</p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/arch.jpg\" alt=\"Istio 架构\"></p>\n<p>服务 A 和服务 B 并不直接通信，而是通过代理的方式，这个代理基本上支持 HTTP/1.1、HTTP/2、gRPC 或 TCP 等协议。</p>\n<h4 id=\"Envoy\"><a href=\"#Envoy\" class=\"headerlink\" title=\"Envoy\"></a>Envoy</h4><p>在 Istio 中默认使用<strong>Envoy</strong>作为这个代理的实现，我们称之为 Sidecar，把微服务网络通信的 SDK 抽取出来，统一交给这个 Sidecar 管理控制。</p>\n<p>主要的功能：</p>\n<ul>\n<li>HTTP 7 层路由</li>\n<li>支持多种通信协议</li>\n<li>服务发现和动态配置</li>\n<li>健康检查</li>\n<li>高级负载均衡</li>\n<li>将流量行为和数据提取，转发给 Mixer 组件</li>\n</ul>\n<p>原理，K8s 环境中，同一个 Pod 内的不同容器间共享网络栈，使得 Sidecar 可以接管进出这个容器的网络流量。</p>\n<h4 id=\"Pilot\"><a href=\"#Pilot\" class=\"headerlink\" title=\"Pilot\"></a>Pilot</h4><p>配置和管理 Envoy 代理，比如流量规则、超时、熔断等，将这些信息通过通过 API 转我 Envoy 理解的格式，并广播给它们。</p>\n<h4 id=\"Mixer\"><a href=\"#Mixer\" class=\"headerlink\" title=\"Mixer\"></a>Mixer</h4><p>Envoy 通信时候，都会向 Mixer 发出预检请求，验证行为的有效性、上报数据等，为了提高性能可以使用缓存和异步提交数据。</p>\n<p>主要功能：</p>\n<ul>\n<li>策略：Istio 依仗该功能实现限流、黑白名单等功能</li>\n<li>遥测：Istio 通过它收集所有的流量数据</li>\n</ul>\n<h4 id=\"Citadel\"><a href=\"#Citadel\" class=\"headerlink\" title=\"Citadel\"></a>Citadel</h4><p>身份和证书管理</p>\n<h4 id=\"Galley\"><a href=\"#Galley\" class=\"headerlink\" title=\"Galley\"></a>Galley</h4><p>Galley 是 Istio 的配置验证、提取、处理和分发组件。</p>\n<h3 id=\"实例\"><a href=\"#实例\" class=\"headerlink\" title=\"实例\"></a>实例</h3><p>官方 <a href=\"https://istio.io/latest/zh/docs/examples/bookinfo/\" target=\"_blank\" rel=\"noopener\">Bookinfo 应用</a>，它由 Python、Java、Ruby、Node.js，4 种语言框架组成。实例中实现了多版本切换、金丝雀发布等等。各个模块只要专注在自己的业务领域，不需要关心网络控制。</p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/book-app.png\" alt=\"Bookinfo 应用 架构\"></p>\n<p>网格化逐渐成为未来趋势，很多大厂在对内部系统做大量改造和升级，作为全栈工程师和架构师来说也需要紧跟时代的步伐。</p>"},{"layout":"minos","title":"简单梳理Node.js创建子进程的方法（下）—— cluster","date":"2020-05-03T07:24:53.000Z","keywords":"child_process,cluster,fork,Node.js,共同监听TCP端口","description":"在默认的RoundRobinHandle模式下，从上可以看出，cluster子进程之所以可以共同监听同个TCP端口，是在net模块里面做了master和child区分，child并没有真正的监听端口，而是child会去master查询该Server是否已经存在，如果没有会在RoundRobinHandle中创建中创建server，一旦有新的TCP连接进入，会转发给free里的worker（cluster.child）处理","_content":"\n前文简单梳理了Node.js使用**child_process**模块创建子进程的4种方法，`exec`、`execFile`、`fork`和`spawn`。接下来我们看看**cluster**模块如何创建子进程，后续更多内容会介绍cluster.fork启动Net Server时候为何不会因为共同监听同一个端口而不报错。\n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): 衍生出一个新的工作进程，这只能通过主进程调用。\n\n<!-- more -->\n\n<br/>\n\n**翻翻源码看看他们怎么实现的**\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**cluster**源码位置\n\n```markdown\nlib\n  - internal\n    - cluster\n    - child.js\n      - master.js\n      - round_robin_handle.js\n      - shared_handle.js\n      - utils.js\n      - worker.js\n  - cluster.js\n```\n\n<br/>\n\n**官方示例**\n\n```javascript\nconst cluster = require('cluster');\nconst http = require('http');\nconst numCPUs = require('os').cpus().length;\n\nif (cluster.isMaster) {\n  console.log(`主进程 ${process.pid} 正在运行`);\n\n  // 衍生工作进程。\n  for (let i = 0; i < numCPUs; i++) {\n    cluster.fork();\n  }\n\n  cluster.on('exit', (worker, code, signal) => {\n    console.log(`工作进程 ${worker.process.pid} 已退出`);\n  });\n} else {\n  // 工作进程可以共享任何 TCP 连接。\n  // 在本例子中，共享的是 HTTP 服务器。\n  http.createServer((req, res) => {\n    res.writeHead(200);\n    res.end('你好世界\\n');\n  }).listen(8000);\n\n  console.log(`工作进程 ${process.pid} 已启动`);\n}\n```\n\n<br/>\n\n### Q:cluster.isMaster模块如何区分是主进程还是子进程的？\n\n```javascript\n// lib/cluster.js\nconst childOrMaster = 'NODE_UNIQUE_ID' in process.env ? 'child' : 'master';\nmodule.exports = require(`internal/cluster/${childOrMaster}`);\n```\n\n`lib/cluster.js`是整个cluster的入口，根据环境变量中是否有`NODE_UNIQUE_ID`来区分主或子进程。\n\n主进程通过`cluster.fork`创建子进程的时候，会将`NODE_UNIQUE_ID`传入子进程的环境变量中，最后通过**child_process.fork**去创建新的子进程。\n\n```javascript\n// lib/internal/cluster/master.js\n// ...\ncluster.isMaster = true;\n// ...\n// fork的代码下文还会提到\nconst workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\nreturn fork(cluster.settings.exec, cluster.settings.args, {\n  // ...\n  env: workerEnv,\n});\n\n// lib/internal/cluster/child.js\n// ...\ncluster.isMaster = false;\n```\n\n### Q:cluster.fork创建子进程过程中做了些什么？\n\n`cluster.setupMaster`是对整个环境参数的配置；\n\n通过`createWorkerProcess`里的`child_process.fork`去创建子进程；\n\n之后将其和一个`Worker`对象做关联，worker、其子进程和当前cluster(master)都会收到几乎相同的`message`、`exit`和`disconnect`事件，**Worker**这边不多扩展，可以查阅`lib/internal/cluster/worker.js`；\n\n子进程会监听`internalMessage`事件，什么是internalMessage事件呢？看看下面官方的介绍。\n\n> 当发送 **{cmd: 'NODE_foo'}** 消息时有一种特殊情况。 **cmd** 属性中包含 **NODE_** 前缀的消息是预留给 Node.js 内核内部使用的，将不会触发子进程的 **'message'**事件。 相反，这种消息可使用 **'internalMessage'** 事件触发，且会被 Node.js 内部消费。 应用程序应避免使用此类消息或监听**'internalMessage'** 事件，因为它可能会被更改且不会通知。\n\n此处`internalMessage`事件的回调方法是`internal(worker, onmessage)`，**internal**是`lib/internal/cluster/master.js`里的方法，主要作用是判断监听的消息里面是否存在需要执行的回调，如果没有就会执行入参回调，这里指的是**onmessage**；\n\n**onmessage**里面有很多if-else语句，主要是根据cluster.child传送进来的消息类型(`act`)做出不同的处理，这里列出了一个`queryServer`（因为后面会介绍Net Server里多个子进程如何监听同一个端口的）。\n\n```javascript\n// lib/internal/cluster/master.js\ncluster.fork = function (env) {\n  cluster.setupMaster();\n  const id = ++ids;\n  // 创建子进程\n  const workerProcess = createWorkerProcess(id, env);\n  //\n  const worker = new Worker({\n    id: id,\n    process: workerProcess, // 新建的子进程\n  });\n  \n  worker.on(\"message\", function (message, handle) {\n    cluster.emit(\"message\", this, message, handle);\n  });\n  worker.process.once(\"exit\", (exitCode, signalCode) => {\n    // ...\n    worker.state = \"dead\";\n    worker.emit(\"exit\", exitCode, signalCode);\n    cluster.emit(\"exit\", worker, exitCode, signalCode);\n  });\n  worker.process.once(\"disconnect\", () => {\n    // ...\n    worker.state = \"disconnected\";\n    worker.emit(\"disconnect\");\n    cluster.emit(\"disconnect\", worker);\n  });\n\n  worker.process.on(\"internalMessage\", internal(worker, onmessage));\n  // 触发 fork 事件\n  process.nextTick(emitForkNT, worker);\n  cluster.workers[worker.id] = worker; \n  return worker;\n};\n\nfunction createWorkerProcess(id, env) {\n  const workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\n  // ... 对一些参数的组合和设定\n  // 调用child_process的fork方法创建子进程\n  return fork(cluster.settings.exec, cluster.settings.args, {\n    cwd: cluster.settings.cwd,\n    env: workerEnv,\n    silent: cluster.settings.silent,\n    windowsHide: cluster.settings.windowsHide,\n    execArgv: execArgv,\n    stdio: cluster.settings.stdio,\n    gid: cluster.settings.gid,\n    uid: cluster.settings.uid,\n  });\n}\nfunction onmessage(message, handle) {\n  const worker = this;\n  // ... if message.act 类型很多 这里主要讲 queryServer\n  if (message.act === \"queryServer\") queryServer(worker, message);\n}\n```\n\n```javascript\n// lib/internal/cluster/utils.js\n// 在cluster的chilid和master里的send都会调用sendHelper\nlet seq = 0;\nfunction sendHelper(proc, message, handle, cb) {\n  if (!proc.connected) return false;\n  // NODE_* 开头的命令触发 internalMessage \n  message = { cmd: \"NODE_CLUSTER\", ...message, seq };\n\n  if (typeof cb === \"function\") callbacks.set(seq, cb); // 缓存回调\n\n  seq += 1;\n  // cluster/child.js handle => null\n  // cluster/master.js handle => null\n  return proc.send(message, handle);\n}\n```\n\n以上就是cluster.fork的大致过程，引入一个Worker和internalMessage概念，之后会用得到。cluster的child和master之间传输信息，都是通过`sendHelper`方法。\n\n### Q:cluster.fork创建的子进程如何共同监听TCP端口？\n\n解答这个问题，主要是看`net`模块如何创建Server的，还有就是cluster中`child`和`master`如何通信的。\n\n官方示例虽然用的是`http`创建的服务，但它底层是继承的`net`模块，为了方便梳理，我们从`net.createServer`入手一步步查看源码，主要的逻辑从`listen`开始。\n\n#### Child部分:\n\ncluster.child里创建一个TCP服务，参数`port`是8000，`host`没有传参；\n\n调用`listenInCluster`方法，一看这名字就知道和**cluster**有关；\n\n`listen`是在子进程里触发的，它会通过`cluster._getServer`拼出一个`act`为serverQuery的消息发送给cluster.master；\n\n#### Master部分:\n\n前文提到，`master.onmessage`方法会根据消息的act不同而做出不同的处理，此处正是`serverQuery`；\n\n进入`queryServer`方法，默认使用`RoundRobinHandle`循环分配任务；\n\n在`RoundRobinHandle`构造函数中，会调用`net.createServer`创建一个Server，由于是在cluster.master里调用的，所以会在`listenInCluster`里调用`server._listen2`，会new 出 `TCP`（src/tcp_wrap.cc）作为句柄，并将其赋给`server._handle`，至此cluster.master已经拥有了处理TCP请求的能力，不过master有该能力是不行的，还需要让child拥有才行；\n\n`RoundRobinHandle`中一旦server触发了`listening`事件后，它会接管`server._handle`，用`distribute`重置其`onconnection`方法；\n\n`distribute`的作用就是转发新的请求TCP给cluster.child，从`free`列队中取出一个之前`add`进来的worker（这个worker和cluster.child有关联关系），发送一个`act`为**newconn**的消息让其处理这个TCP；\n\n#### 回到Child部分:\n\ncluster.child的`onconnection`收到`act`为**newconn**的请求后，会找到之前的创建的server，然后调用其`onconnection`（child里的该方法没有被重置）方法，然后封装出一个`Socket`对象，触发`onnection`事件；\n\n到此，后面的就是普通业务逻辑代码了。\n\n*下面贴上了部分相关代码，还是比较多的，细节部分我也加上了注释。*\n\n```javascript\n// lib/net.js\nfunction createServer(options, connectionListener) {\n  return new Server(options, connectionListener);\n}\nfunction Server(options, connectionListener) {\n  // ... 大量内置属性和参数的初始化\n}\nServer.prototype.listen = function (...args) {\n  // ...\n  // 传了port参数（8000），没有host\n  var backlog;\n  if (typeof options.port === \"number\" || typeof options.port === \"string\") {\n    backlog = options.backlog || backlogFromArgs;\n    if (options.host) {\n      // ...\n    } else {\n      // \n      listenInCluster(\n        this,\n        null,\n        options.port | 0,\n        4,\n        backlog,\n        undefined,\n        options.exclusive\n      );\n    }\n    return this;\n  }\n\t// ...\n};\n\n\nfunction listenInCluster(\n  server,\n  address,\n  port,\n  addressType,\n  backlog,\n  fd,\n  exclusive,\n  flags\n) {\n  exclusive = !!exclusive;\n\n  if (cluster === undefined) cluster = require(\"cluster\");\n\n  if (cluster.isMaster || exclusive) {\n    server._listen2(address, port, addressType, backlog, fd, flags);\n    return;\n  }\n\n  const serverQuery = {\n    address: address,\n    port: port, \n    addressType: addressType,\n    fd: fd,\n    flags,\n  };\n  cluster._getServer(server, serverQuery, listenOnMasterHandle);\n\n  function listenOnMasterHandle(err, handle) {\n    // ...\n    server._handle = handle;\n    server._listen2(address, port, addressType, backlog, fd, flags);\n  }\n}\n```\n\n```javascript\n// lib/internal/cluster/child.js\ncluster._getServer = function (obj, options, cb) {\n  let address = options.address;\n\t// ...\n  // 当前创建的server信息是否之前已经在cluster.child里查询过\n  // 有的话就累加计数index值\n  const indexesKey = [\n    address, \n    options.port,\n    options.addressType,\n    options.fd,\n  ].join(\":\"); \n\n  let index = indexes.get(indexesKey);\n\n  if (index === undefined) index = 0;\n  else index++;\n\n  indexes.set(indexesKey, index);\n\n  const message = {\n    act: \"queryServer\",\n    index,\n    data: null,\n    ...options,\n  };\n  \n  // ...\n\n  send(message, (reply, handle) => {\n    // ...\n    if (handle) shared(reply, handle, indexesKey, cb);\n    // Shared listen socket.\n    else rr(reply, indexesKey, cb); // Round-robin 返回的 handle 是null\n  });\n  // ...\n};\nfunction rr(message, indexesKey, cb) {\n  if (message.errno) return cb(message.errno, null);\n\n  var key = message.key;\n\n  function listen(backlog) {\n    return 0;\n  }\n\n  function close() {\n    if (key === undefined) return;\n    send({ act: \"close\", key });\n    handles.delete(key);\n    indexes.delete(indexesKey);\n    key = undefined;\n  }\n\n  function getsockname(out) {\n    if (key) Object.assign(out, message.sockname);\n    return 0;\n  }\n\n  const handle = { close, listen, ref: noop, unref: noop };\n\n  if (message.sockname) {\n    handle.getsockname = getsockname; // TCP handles only.\n  }\n\n  assert(handles.has(key) === false);\n  handles.set(key, handle);\n  cb(0, handle); // 将封装好的handle，作为listenInCluster的回调handle，赋给server._handle\n}\n// Round-robin connection.\nfunction onconnection(message, handle) {\n  const key = message.key; // maseter里的key\n  const server = handles.get(key); // 是client创建的server？\n  const accepted = server !== undefined;\n\n  send({ ack: message.seq, accepted }); // 答复 master\n\n  // 虽然cluster.child rr里没有为server绑定，onconnection\n  // 但是在cb回到net.js里，后面的逻辑绑定了onconnection方法\n  if (accepted) server.onconnection(0, handle);\n}\n```\n\n```javascript\n// lib/internal/cluster/master.js\nfunction queryServer(worker, message) {\n  // worker是cluster.child worker\n  const key =\n    `${message.address}:${message.port}:${message.addressType}:` +\n    `${message.fd}:${message.index}`;\n  var handle = handles.get(key);\n\n  if (handle === undefined) {\n  \n    // 默认是RoundRobin，Shared模式暂不讨论有兴趣可以看源码\n    var constructor = RoundRobinHandle;\n    // ...\n    handle = new constructor(\n      key,\n      address,\n      message.port,\n      message.addressType,\n      message.fd,\n      message.flags\n    );\n    handles.set(key, handle);\n  }\n  // ...\n  // 将cluster.child的worker添加到handle中\n  handle.add(worker, (errno, reply, handle) => {\n    const { data } = handles.get(key);\n    send(\n      worker,\n      {\n        errno,\n        key,\n        ack: message.seq,\n        data,\n        ...reply,\n      },\n      handle // round_robin_handle 里返回的是一个null\n    );\n  });\n}\n```\n\n```javascript\n// lib/internal/cluster/round_robin_handle.js\nfunction RoundRobinHandle(key, address, port, addressType, fd, flags) {\n  this.key = key;\n  this.all = new Map();\n  this.free = [];\n  this.handles = [];\n  this.handle = null;\n  this.server = net.createServer(assert.fail);\n\n  if (fd >= 0) this.server.listen({ fd });\n  else if (port >= 0) {\n    this.server.listen({\n      port,\n      host: address,\n      // Currently, net module only supports `ipv6Only` option in `flags`.\n      ipv6Only: Boolean(flags & constants.UV_TCP_IPV6ONLY),\n    });\n  } else this.server.listen(address); // UNIX socket path.\n\n  this.server.once(\"listening\", () => {\n    this.handle = this.server._handle;\n    // 重置onconnection方法\n    // distribute 做任务派发\n    this.handle.onconnection = (err, handle) => this.distribute(err, handle);\n    this.server._handle = null;\n    this.server = null;\n  });\n}\n\nRoundRobinHandle.prototype.add = function (worker, send) {\n  assert(this.all.has(worker.id) === false);\n  this.all.set(worker.id, worker);\n\n  const done = () => {\n    if (this.handle.getsockname) {\n      // tcp\\udp 会有getsockname\n      const out = {};\n      this.handle.getsockname(out);\n      // TODO(bnoordhuis) Check err.\n      send(null, { sockname: out }, null);\n    } else {\n      send(null, null, null); // UNIX socket.\n    }\n\n    this.handoff(worker); // In case there are connections pending.\n  };\n\n  if (this.server === null) return done();\n\n  // Still busy binding.\n  this.server.once(\"listening\", done);\n  this.server.once(\"error\", (err) => {\n    send(err.errno, null);\n  });\n};\n\nRoundRobinHandle.prototype.distribute = function (err, handle) {\n  this.handles.push(handle);\n  const worker = this.free.shift();\n\n  if (worker) this.handoff(worker);\n};\n\nRoundRobinHandle.prototype.handoff = function (worker) {\n  // worker如果不存在那就跳出\n  if (this.all.has(worker.id) === false) {\n    return; // Worker is closing (or has closed) the server.\n  }\n\n  const handle = this.handles.shift(); // 取出第一个待处理任务\n\n  if (handle === undefined) {\n    this.free.push(worker);  // 没有的话就会将worker归还到free里\n    return;\n  }\n\n  const message = { act: \"newconn\", key: this.key };\n\n  sendHelper(worker.process, message, handle, (reply) => {\n    if (reply.accepted) handle.close();\n    else this.distribute(0, handle); // Worker is shutting down. Send to another.\n\n    this.handoff(worker);\n  });\n};\n```\n\n### 总结：\n\n`cluster`利用child_process的fork方法创建子进程，并传入新的环境变量`NODE_UNIQUE_ID`用于区分主子进程从而在require('cluster')时候可以加载到对应的`master.js`和`child.js`文件。另外在默认的`RoundRobinHandle`模式下，`cluster`子进程之所以可以共同监听同个TCP端口，是在`net`模块里面做了master和child区分，child并没有真正的监听端口，而是child会去master查询该Server是否已经存在，如果没有会在`RoundRobinHandle`中创建中创建server，一旦有新的TCP连接进入，会转发给`free`里的worker（cluster.child）处理。","source":"_posts/node-js-net-cluster-fork.md","raw":"---\nlayout: minos\ntitle: 简单梳理Node.js创建子进程的方法（下）—— cluster\ndate: 2020-05-03 15:24:53\ncategory: JavaScript\ntags:\n  - Node.js\n  - JavaScript\nkeywords: child_process,cluster,fork,Node.js,共同监听TCP端口\ndescription: 在默认的RoundRobinHandle模式下，从上可以看出，cluster子进程之所以可以共同监听同个TCP端口，是在net模块里面做了master和child区分，child并没有真正的监听端口，而是child会去master查询该Server是否已经存在，如果没有会在RoundRobinHandle中创建中创建server，一旦有新的TCP连接进入，会转发给free里的worker（cluster.child）处理\n---\n\n前文简单梳理了Node.js使用**child_process**模块创建子进程的4种方法，`exec`、`execFile`、`fork`和`spawn`。接下来我们看看**cluster**模块如何创建子进程，后续更多内容会介绍cluster.fork启动Net Server时候为何不会因为共同监听同一个端口而不报错。\n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): 衍生出一个新的工作进程，这只能通过主进程调用。\n\n<!-- more -->\n\n<br/>\n\n**翻翻源码看看他们怎么实现的**\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**cluster**源码位置\n\n```markdown\nlib\n  - internal\n    - cluster\n    - child.js\n      - master.js\n      - round_robin_handle.js\n      - shared_handle.js\n      - utils.js\n      - worker.js\n  - cluster.js\n```\n\n<br/>\n\n**官方示例**\n\n```javascript\nconst cluster = require('cluster');\nconst http = require('http');\nconst numCPUs = require('os').cpus().length;\n\nif (cluster.isMaster) {\n  console.log(`主进程 ${process.pid} 正在运行`);\n\n  // 衍生工作进程。\n  for (let i = 0; i < numCPUs; i++) {\n    cluster.fork();\n  }\n\n  cluster.on('exit', (worker, code, signal) => {\n    console.log(`工作进程 ${worker.process.pid} 已退出`);\n  });\n} else {\n  // 工作进程可以共享任何 TCP 连接。\n  // 在本例子中，共享的是 HTTP 服务器。\n  http.createServer((req, res) => {\n    res.writeHead(200);\n    res.end('你好世界\\n');\n  }).listen(8000);\n\n  console.log(`工作进程 ${process.pid} 已启动`);\n}\n```\n\n<br/>\n\n### Q:cluster.isMaster模块如何区分是主进程还是子进程的？\n\n```javascript\n// lib/cluster.js\nconst childOrMaster = 'NODE_UNIQUE_ID' in process.env ? 'child' : 'master';\nmodule.exports = require(`internal/cluster/${childOrMaster}`);\n```\n\n`lib/cluster.js`是整个cluster的入口，根据环境变量中是否有`NODE_UNIQUE_ID`来区分主或子进程。\n\n主进程通过`cluster.fork`创建子进程的时候，会将`NODE_UNIQUE_ID`传入子进程的环境变量中，最后通过**child_process.fork**去创建新的子进程。\n\n```javascript\n// lib/internal/cluster/master.js\n// ...\ncluster.isMaster = true;\n// ...\n// fork的代码下文还会提到\nconst workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\nreturn fork(cluster.settings.exec, cluster.settings.args, {\n  // ...\n  env: workerEnv,\n});\n\n// lib/internal/cluster/child.js\n// ...\ncluster.isMaster = false;\n```\n\n### Q:cluster.fork创建子进程过程中做了些什么？\n\n`cluster.setupMaster`是对整个环境参数的配置；\n\n通过`createWorkerProcess`里的`child_process.fork`去创建子进程；\n\n之后将其和一个`Worker`对象做关联，worker、其子进程和当前cluster(master)都会收到几乎相同的`message`、`exit`和`disconnect`事件，**Worker**这边不多扩展，可以查阅`lib/internal/cluster/worker.js`；\n\n子进程会监听`internalMessage`事件，什么是internalMessage事件呢？看看下面官方的介绍。\n\n> 当发送 **{cmd: 'NODE_foo'}** 消息时有一种特殊情况。 **cmd** 属性中包含 **NODE_** 前缀的消息是预留给 Node.js 内核内部使用的，将不会触发子进程的 **'message'**事件。 相反，这种消息可使用 **'internalMessage'** 事件触发，且会被 Node.js 内部消费。 应用程序应避免使用此类消息或监听**'internalMessage'** 事件，因为它可能会被更改且不会通知。\n\n此处`internalMessage`事件的回调方法是`internal(worker, onmessage)`，**internal**是`lib/internal/cluster/master.js`里的方法，主要作用是判断监听的消息里面是否存在需要执行的回调，如果没有就会执行入参回调，这里指的是**onmessage**；\n\n**onmessage**里面有很多if-else语句，主要是根据cluster.child传送进来的消息类型(`act`)做出不同的处理，这里列出了一个`queryServer`（因为后面会介绍Net Server里多个子进程如何监听同一个端口的）。\n\n```javascript\n// lib/internal/cluster/master.js\ncluster.fork = function (env) {\n  cluster.setupMaster();\n  const id = ++ids;\n  // 创建子进程\n  const workerProcess = createWorkerProcess(id, env);\n  //\n  const worker = new Worker({\n    id: id,\n    process: workerProcess, // 新建的子进程\n  });\n  \n  worker.on(\"message\", function (message, handle) {\n    cluster.emit(\"message\", this, message, handle);\n  });\n  worker.process.once(\"exit\", (exitCode, signalCode) => {\n    // ...\n    worker.state = \"dead\";\n    worker.emit(\"exit\", exitCode, signalCode);\n    cluster.emit(\"exit\", worker, exitCode, signalCode);\n  });\n  worker.process.once(\"disconnect\", () => {\n    // ...\n    worker.state = \"disconnected\";\n    worker.emit(\"disconnect\");\n    cluster.emit(\"disconnect\", worker);\n  });\n\n  worker.process.on(\"internalMessage\", internal(worker, onmessage));\n  // 触发 fork 事件\n  process.nextTick(emitForkNT, worker);\n  cluster.workers[worker.id] = worker; \n  return worker;\n};\n\nfunction createWorkerProcess(id, env) {\n  const workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\n  // ... 对一些参数的组合和设定\n  // 调用child_process的fork方法创建子进程\n  return fork(cluster.settings.exec, cluster.settings.args, {\n    cwd: cluster.settings.cwd,\n    env: workerEnv,\n    silent: cluster.settings.silent,\n    windowsHide: cluster.settings.windowsHide,\n    execArgv: execArgv,\n    stdio: cluster.settings.stdio,\n    gid: cluster.settings.gid,\n    uid: cluster.settings.uid,\n  });\n}\nfunction onmessage(message, handle) {\n  const worker = this;\n  // ... if message.act 类型很多 这里主要讲 queryServer\n  if (message.act === \"queryServer\") queryServer(worker, message);\n}\n```\n\n```javascript\n// lib/internal/cluster/utils.js\n// 在cluster的chilid和master里的send都会调用sendHelper\nlet seq = 0;\nfunction sendHelper(proc, message, handle, cb) {\n  if (!proc.connected) return false;\n  // NODE_* 开头的命令触发 internalMessage \n  message = { cmd: \"NODE_CLUSTER\", ...message, seq };\n\n  if (typeof cb === \"function\") callbacks.set(seq, cb); // 缓存回调\n\n  seq += 1;\n  // cluster/child.js handle => null\n  // cluster/master.js handle => null\n  return proc.send(message, handle);\n}\n```\n\n以上就是cluster.fork的大致过程，引入一个Worker和internalMessage概念，之后会用得到。cluster的child和master之间传输信息，都是通过`sendHelper`方法。\n\n### Q:cluster.fork创建的子进程如何共同监听TCP端口？\n\n解答这个问题，主要是看`net`模块如何创建Server的，还有就是cluster中`child`和`master`如何通信的。\n\n官方示例虽然用的是`http`创建的服务，但它底层是继承的`net`模块，为了方便梳理，我们从`net.createServer`入手一步步查看源码，主要的逻辑从`listen`开始。\n\n#### Child部分:\n\ncluster.child里创建一个TCP服务，参数`port`是8000，`host`没有传参；\n\n调用`listenInCluster`方法，一看这名字就知道和**cluster**有关；\n\n`listen`是在子进程里触发的，它会通过`cluster._getServer`拼出一个`act`为serverQuery的消息发送给cluster.master；\n\n#### Master部分:\n\n前文提到，`master.onmessage`方法会根据消息的act不同而做出不同的处理，此处正是`serverQuery`；\n\n进入`queryServer`方法，默认使用`RoundRobinHandle`循环分配任务；\n\n在`RoundRobinHandle`构造函数中，会调用`net.createServer`创建一个Server，由于是在cluster.master里调用的，所以会在`listenInCluster`里调用`server._listen2`，会new 出 `TCP`（src/tcp_wrap.cc）作为句柄，并将其赋给`server._handle`，至此cluster.master已经拥有了处理TCP请求的能力，不过master有该能力是不行的，还需要让child拥有才行；\n\n`RoundRobinHandle`中一旦server触发了`listening`事件后，它会接管`server._handle`，用`distribute`重置其`onconnection`方法；\n\n`distribute`的作用就是转发新的请求TCP给cluster.child，从`free`列队中取出一个之前`add`进来的worker（这个worker和cluster.child有关联关系），发送一个`act`为**newconn**的消息让其处理这个TCP；\n\n#### 回到Child部分:\n\ncluster.child的`onconnection`收到`act`为**newconn**的请求后，会找到之前的创建的server，然后调用其`onconnection`（child里的该方法没有被重置）方法，然后封装出一个`Socket`对象，触发`onnection`事件；\n\n到此，后面的就是普通业务逻辑代码了。\n\n*下面贴上了部分相关代码，还是比较多的，细节部分我也加上了注释。*\n\n```javascript\n// lib/net.js\nfunction createServer(options, connectionListener) {\n  return new Server(options, connectionListener);\n}\nfunction Server(options, connectionListener) {\n  // ... 大量内置属性和参数的初始化\n}\nServer.prototype.listen = function (...args) {\n  // ...\n  // 传了port参数（8000），没有host\n  var backlog;\n  if (typeof options.port === \"number\" || typeof options.port === \"string\") {\n    backlog = options.backlog || backlogFromArgs;\n    if (options.host) {\n      // ...\n    } else {\n      // \n      listenInCluster(\n        this,\n        null,\n        options.port | 0,\n        4,\n        backlog,\n        undefined,\n        options.exclusive\n      );\n    }\n    return this;\n  }\n\t// ...\n};\n\n\nfunction listenInCluster(\n  server,\n  address,\n  port,\n  addressType,\n  backlog,\n  fd,\n  exclusive,\n  flags\n) {\n  exclusive = !!exclusive;\n\n  if (cluster === undefined) cluster = require(\"cluster\");\n\n  if (cluster.isMaster || exclusive) {\n    server._listen2(address, port, addressType, backlog, fd, flags);\n    return;\n  }\n\n  const serverQuery = {\n    address: address,\n    port: port, \n    addressType: addressType,\n    fd: fd,\n    flags,\n  };\n  cluster._getServer(server, serverQuery, listenOnMasterHandle);\n\n  function listenOnMasterHandle(err, handle) {\n    // ...\n    server._handle = handle;\n    server._listen2(address, port, addressType, backlog, fd, flags);\n  }\n}\n```\n\n```javascript\n// lib/internal/cluster/child.js\ncluster._getServer = function (obj, options, cb) {\n  let address = options.address;\n\t// ...\n  // 当前创建的server信息是否之前已经在cluster.child里查询过\n  // 有的话就累加计数index值\n  const indexesKey = [\n    address, \n    options.port,\n    options.addressType,\n    options.fd,\n  ].join(\":\"); \n\n  let index = indexes.get(indexesKey);\n\n  if (index === undefined) index = 0;\n  else index++;\n\n  indexes.set(indexesKey, index);\n\n  const message = {\n    act: \"queryServer\",\n    index,\n    data: null,\n    ...options,\n  };\n  \n  // ...\n\n  send(message, (reply, handle) => {\n    // ...\n    if (handle) shared(reply, handle, indexesKey, cb);\n    // Shared listen socket.\n    else rr(reply, indexesKey, cb); // Round-robin 返回的 handle 是null\n  });\n  // ...\n};\nfunction rr(message, indexesKey, cb) {\n  if (message.errno) return cb(message.errno, null);\n\n  var key = message.key;\n\n  function listen(backlog) {\n    return 0;\n  }\n\n  function close() {\n    if (key === undefined) return;\n    send({ act: \"close\", key });\n    handles.delete(key);\n    indexes.delete(indexesKey);\n    key = undefined;\n  }\n\n  function getsockname(out) {\n    if (key) Object.assign(out, message.sockname);\n    return 0;\n  }\n\n  const handle = { close, listen, ref: noop, unref: noop };\n\n  if (message.sockname) {\n    handle.getsockname = getsockname; // TCP handles only.\n  }\n\n  assert(handles.has(key) === false);\n  handles.set(key, handle);\n  cb(0, handle); // 将封装好的handle，作为listenInCluster的回调handle，赋给server._handle\n}\n// Round-robin connection.\nfunction onconnection(message, handle) {\n  const key = message.key; // maseter里的key\n  const server = handles.get(key); // 是client创建的server？\n  const accepted = server !== undefined;\n\n  send({ ack: message.seq, accepted }); // 答复 master\n\n  // 虽然cluster.child rr里没有为server绑定，onconnection\n  // 但是在cb回到net.js里，后面的逻辑绑定了onconnection方法\n  if (accepted) server.onconnection(0, handle);\n}\n```\n\n```javascript\n// lib/internal/cluster/master.js\nfunction queryServer(worker, message) {\n  // worker是cluster.child worker\n  const key =\n    `${message.address}:${message.port}:${message.addressType}:` +\n    `${message.fd}:${message.index}`;\n  var handle = handles.get(key);\n\n  if (handle === undefined) {\n  \n    // 默认是RoundRobin，Shared模式暂不讨论有兴趣可以看源码\n    var constructor = RoundRobinHandle;\n    // ...\n    handle = new constructor(\n      key,\n      address,\n      message.port,\n      message.addressType,\n      message.fd,\n      message.flags\n    );\n    handles.set(key, handle);\n  }\n  // ...\n  // 将cluster.child的worker添加到handle中\n  handle.add(worker, (errno, reply, handle) => {\n    const { data } = handles.get(key);\n    send(\n      worker,\n      {\n        errno,\n        key,\n        ack: message.seq,\n        data,\n        ...reply,\n      },\n      handle // round_robin_handle 里返回的是一个null\n    );\n  });\n}\n```\n\n```javascript\n// lib/internal/cluster/round_robin_handle.js\nfunction RoundRobinHandle(key, address, port, addressType, fd, flags) {\n  this.key = key;\n  this.all = new Map();\n  this.free = [];\n  this.handles = [];\n  this.handle = null;\n  this.server = net.createServer(assert.fail);\n\n  if (fd >= 0) this.server.listen({ fd });\n  else if (port >= 0) {\n    this.server.listen({\n      port,\n      host: address,\n      // Currently, net module only supports `ipv6Only` option in `flags`.\n      ipv6Only: Boolean(flags & constants.UV_TCP_IPV6ONLY),\n    });\n  } else this.server.listen(address); // UNIX socket path.\n\n  this.server.once(\"listening\", () => {\n    this.handle = this.server._handle;\n    // 重置onconnection方法\n    // distribute 做任务派发\n    this.handle.onconnection = (err, handle) => this.distribute(err, handle);\n    this.server._handle = null;\n    this.server = null;\n  });\n}\n\nRoundRobinHandle.prototype.add = function (worker, send) {\n  assert(this.all.has(worker.id) === false);\n  this.all.set(worker.id, worker);\n\n  const done = () => {\n    if (this.handle.getsockname) {\n      // tcp\\udp 会有getsockname\n      const out = {};\n      this.handle.getsockname(out);\n      // TODO(bnoordhuis) Check err.\n      send(null, { sockname: out }, null);\n    } else {\n      send(null, null, null); // UNIX socket.\n    }\n\n    this.handoff(worker); // In case there are connections pending.\n  };\n\n  if (this.server === null) return done();\n\n  // Still busy binding.\n  this.server.once(\"listening\", done);\n  this.server.once(\"error\", (err) => {\n    send(err.errno, null);\n  });\n};\n\nRoundRobinHandle.prototype.distribute = function (err, handle) {\n  this.handles.push(handle);\n  const worker = this.free.shift();\n\n  if (worker) this.handoff(worker);\n};\n\nRoundRobinHandle.prototype.handoff = function (worker) {\n  // worker如果不存在那就跳出\n  if (this.all.has(worker.id) === false) {\n    return; // Worker is closing (or has closed) the server.\n  }\n\n  const handle = this.handles.shift(); // 取出第一个待处理任务\n\n  if (handle === undefined) {\n    this.free.push(worker);  // 没有的话就会将worker归还到free里\n    return;\n  }\n\n  const message = { act: \"newconn\", key: this.key };\n\n  sendHelper(worker.process, message, handle, (reply) => {\n    if (reply.accepted) handle.close();\n    else this.distribute(0, handle); // Worker is shutting down. Send to another.\n\n    this.handoff(worker);\n  });\n};\n```\n\n### 总结：\n\n`cluster`利用child_process的fork方法创建子进程，并传入新的环境变量`NODE_UNIQUE_ID`用于区分主子进程从而在require('cluster')时候可以加载到对应的`master.js`和`child.js`文件。另外在默认的`RoundRobinHandle`模式下，`cluster`子进程之所以可以共同监听同个TCP端口，是在`net`模块里面做了master和child区分，child并没有真正的监听端口，而是child会去master查询该Server是否已经存在，如果没有会在`RoundRobinHandle`中创建中创建server，一旦有新的TCP连接进入，会转发给`free`里的worker（cluster.child）处理。","slug":"node-js-net-cluster-fork","published":1,"updated":"2020-07-07T10:11:25.588Z","comments":1,"photos":[],"link":"","_id":"ckcc0bs6d000td12ipm80x4aw","content":"<p>前文简单梳理了Node.js使用<strong>child_process</strong>模块创建子进程的4种方法，<code>exec</code>、<code>execFile</code>、<code>fork</code>和<code>spawn</code>。接下来我们看看<strong>cluster</strong>模块如何创建子进程，后续更多内容会介绍cluster.fork启动Net Server时候为何不会因为共同监听同一个端口而不报错。</p>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\" target=\"_blank\" rel=\"noopener\">fork</a>: 衍生出一个新的工作进程，这只能通过主进程调用。</li>\n</ul>\n<a id=\"more\"></a>\n<p><br></p>\n<p><strong>翻翻源码看看他们怎么实现的</strong></p>\n<figure class=\"highlight markdown hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p><strong>cluster</strong>源码位置</p>\n<figure class=\"highlight markdown hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lib</span><br><span class=\"line\">  - internal</span><br><span class=\"line\"><span class=\"hljs-code\">    - cluster</span></span><br><span class=\"line\"><span class=\"hljs-code\">    - child.js</span></span><br><span class=\"line\"><span class=\"hljs-code\">      - master.js</span></span><br><span class=\"line\"><span class=\"hljs-code\">      - round_robin_handle.js</span></span><br><span class=\"line\"><span class=\"hljs-code\">      - shared_handle.js</span></span><br><span class=\"line\"><span class=\"hljs-code\">      - utils.js</span></span><br><span class=\"line\"><span class=\"hljs-code\">      - worker.js</span></span><br><span class=\"line\">  - cluster.js</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong>官方示例</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> cluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'cluster'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> http = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'http'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> numCPUs = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'os'</span>).cpus().length;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">if</span> (cluster.isMaster) &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`主进程 <span class=\"hljs-subst\">$&#123;process.pid&#125;</span> 正在运行`</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 衍生工作进程。</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class=\"line\">    cluster.fork();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  cluster.on(<span class=\"hljs-string\">'exit'</span>, (worker, code, signal) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`工作进程 <span class=\"hljs-subst\">$&#123;worker.process.pid&#125;</span> 已退出`</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// 工作进程可以共享任何 TCP 连接。</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 在本例子中，共享的是 HTTP 服务器。</span></span><br><span class=\"line\">  http.createServer(<span class=\"hljs-function\">(<span class=\"hljs-params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    res.writeHead(<span class=\"hljs-number\">200</span>);</span><br><span class=\"line\">    res.end(<span class=\"hljs-string\">'你好世界\\n'</span>);</span><br><span class=\"line\">  &#125;).listen(<span class=\"hljs-number\">8000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`工作进程 <span class=\"hljs-subst\">$&#123;process.pid&#125;</span> 已启动`</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h3 id=\"Q-cluster-isMaster模块如何区分是主进程还是子进程的？\"><a href=\"#Q-cluster-isMaster模块如何区分是主进程还是子进程的？\" class=\"headerlink\" title=\"Q:cluster.isMaster模块如何区分是主进程还是子进程的？\"></a>Q:cluster.isMaster模块如何区分是主进程还是子进程的？</h3><figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/cluster.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> childOrMaster = <span class=\"hljs-string\">'NODE_UNIQUE_ID'</span> <span class=\"hljs-keyword\">in</span> process.env ? <span class=\"hljs-string\">'child'</span> : <span class=\"hljs-string\">'master'</span>;</span><br><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">`internal/cluster/<span class=\"hljs-subst\">$&#123;childOrMaster&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>\n<p><code>lib/cluster.js</code>是整个cluster的入口，根据环境变量中是否有<code>NODE_UNIQUE_ID</code>来区分主或子进程。</p>\n<p>主进程通过<code>cluster.fork</code>创建子进程的时候，会将<code>NODE_UNIQUE_ID</code>传入子进程的环境变量中，最后通过<strong>child_process.fork</strong>去创建新的子进程。</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">cluster.isMaster = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// fork的代码下文还会提到</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> workerEnv = &#123; ...process.env, ...env, <span class=\"hljs-attr\">NODE_UNIQUE_ID</span>: <span class=\"hljs-string\">`<span class=\"hljs-subst\">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class=\"line\"><span class=\"hljs-keyword\">return</span> fork(cluster.settings.exec, cluster.settings.args, &#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  env: workerEnv,</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">cluster.isMaster = <span class=\"hljs-literal\">false</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Q-cluster-fork创建子进程过程中做了些什么？\"><a href=\"#Q-cluster-fork创建子进程过程中做了些什么？\" class=\"headerlink\" title=\"Q:cluster.fork创建子进程过程中做了些什么？\"></a>Q:cluster.fork创建子进程过程中做了些什么？</h3><p><code>cluster.setupMaster</code>是对整个环境参数的配置；</p>\n<p>通过<code>createWorkerProcess</code>里的<code>child_process.fork</code>去创建子进程；</p>\n<p>之后将其和一个<code>Worker</code>对象做关联，worker、其子进程和当前cluster(master)都会收到几乎相同的<code>message</code>、<code>exit</code>和<code>disconnect</code>事件，<strong>Worker</strong>这边不多扩展，可以查阅<code>lib/internal/cluster/worker.js</code>；</p>\n<p>子进程会监听<code>internalMessage</code>事件，什么是internalMessage事件呢？看看下面官方的介绍。</p>\n<blockquote>\n<p>当发送 <strong>{cmd: ‘NODE_foo’}</strong> 消息时有一种特殊情况。 <strong>cmd</strong> 属性中包含 <strong>NODE_</strong> 前缀的消息是预留给 Node.js 内核内部使用的，将不会触发子进程的 <strong>‘message’</strong>事件。 相反，这种消息可使用 <strong>‘internalMessage’</strong> 事件触发，且会被 Node.js 内部消费。 应用程序应避免使用此类消息或监听<strong>‘internalMessage’</strong> 事件，因为它可能会被更改且不会通知。</p>\n</blockquote>\n<p>此处<code>internalMessage</code>事件的回调方法是<code>internal(worker, onmessage)</code>，<strong>internal</strong>是<code>lib/internal/cluster/master.js</code>里的方法，主要作用是判断监听的消息里面是否存在需要执行的回调，如果没有就会执行入参回调，这里指的是<strong>onmessage</strong>；</p>\n<p><strong>onmessage</strong>里面有很多if-else语句，主要是根据cluster.child传送进来的消息类型(<code>act</code>)做出不同的处理，这里列出了一个<code>queryServer</code>（因为后面会介绍Net Server里多个子进程如何监听同一个端口的）。</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\">cluster.fork = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">env</span>) </span>&#123;</span><br><span class=\"line\">  cluster.setupMaster();</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> id = ++ids;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// 创建子进程</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> workerProcess = createWorkerProcess(id, env);</span><br><span class=\"line\">  <span class=\"hljs-comment\">//</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> worker = <span class=\"hljs-keyword\">new</span> Worker(&#123;</span><br><span class=\"line\">    id: id,</span><br><span class=\"line\">    process: workerProcess, <span class=\"hljs-comment\">// 新建的子进程</span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  </span><br><span class=\"line\">  worker.on(<span class=\"hljs-string\">\"message\"</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">    cluster.emit(<span class=\"hljs-string\">\"message\"</span>, <span class=\"hljs-keyword\">this</span>, message, handle);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  worker.process.once(<span class=\"hljs-string\">\"exit\"</span>, (exitCode, signalCode) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    worker.state = <span class=\"hljs-string\">\"dead\"</span>;</span><br><span class=\"line\">    worker.emit(<span class=\"hljs-string\">\"exit\"</span>, exitCode, signalCode);</span><br><span class=\"line\">    cluster.emit(<span class=\"hljs-string\">\"exit\"</span>, worker, exitCode, signalCode);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  worker.process.once(<span class=\"hljs-string\">\"disconnect\"</span>, () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    worker.state = <span class=\"hljs-string\">\"disconnected\"</span>;</span><br><span class=\"line\">    worker.emit(<span class=\"hljs-string\">\"disconnect\"</span>);</span><br><span class=\"line\">    cluster.emit(<span class=\"hljs-string\">\"disconnect\"</span>, worker);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  worker.process.on(<span class=\"hljs-string\">\"internalMessage\"</span>, internal(worker, onmessage));</span><br><span class=\"line\">  <span class=\"hljs-comment\">// 触发 fork 事件</span></span><br><span class=\"line\">  process.nextTick(emitForkNT, worker);</span><br><span class=\"line\">  cluster.workers[worker.id] = worker; </span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> worker;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">createWorkerProcess</span>(<span class=\"hljs-params\">id, env</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> workerEnv = &#123; ...process.env, ...env, <span class=\"hljs-attr\">NODE_UNIQUE_ID</span>: <span class=\"hljs-string\">`<span class=\"hljs-subst\">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... 对一些参数的组合和设定</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 调用child_process的fork方法创建子进程</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> fork(cluster.settings.exec, cluster.settings.args, &#123;</span><br><span class=\"line\">    cwd: cluster.settings.cwd,</span><br><span class=\"line\">    env: workerEnv,</span><br><span class=\"line\">    silent: cluster.settings.silent,</span><br><span class=\"line\">    windowsHide: cluster.settings.windowsHide,</span><br><span class=\"line\">    execArgv: execArgv,</span><br><span class=\"line\">    stdio: cluster.settings.stdio,</span><br><span class=\"line\">    gid: cluster.settings.gid,</span><br><span class=\"line\">    uid: cluster.settings.uid,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">onmessage</span>(<span class=\"hljs-params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> worker = <span class=\"hljs-keyword\">this</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... if message.act 类型很多 这里主要讲 queryServer</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (message.act === <span class=\"hljs-string\">\"queryServer\"</span>) queryServer(worker, message);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/utils.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// 在cluster的chilid和master里的send都会调用sendHelper</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> seq = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">sendHelper</span>(<span class=\"hljs-params\">proc, message, handle, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!proc.connected) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// NODE_* 开头的命令触发 internalMessage </span></span><br><span class=\"line\">  message = &#123; <span class=\"hljs-attr\">cmd</span>: <span class=\"hljs-string\">\"NODE_CLUSTER\"</span>, ...message, seq &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> cb === <span class=\"hljs-string\">\"function\"</span>) callbacks.set(seq, cb); <span class=\"hljs-comment\">// 缓存回调</span></span><br><span class=\"line\"></span><br><span class=\"line\">  seq += <span class=\"hljs-number\">1</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// cluster/child.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// cluster/master.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> proc.send(message, handle);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>以上就是cluster.fork的大致过程，引入一个Worker和internalMessage概念，之后会用得到。cluster的child和master之间传输信息，都是通过<code>sendHelper</code>方法。</p>\n<h3 id=\"Q-cluster-fork创建的子进程如何共同监听TCP端口？\"><a href=\"#Q-cluster-fork创建的子进程如何共同监听TCP端口？\" class=\"headerlink\" title=\"Q:cluster.fork创建的子进程如何共同监听TCP端口？\"></a>Q:cluster.fork创建的子进程如何共同监听TCP端口？</h3><p>解答这个问题，主要是看<code>net</code>模块如何创建Server的，还有就是cluster中<code>child</code>和<code>master</code>如何通信的。</p>\n<p>官方示例虽然用的是<code>http</code>创建的服务，但它底层是继承的<code>net</code>模块，为了方便梳理，我们从<code>net.createServer</code>入手一步步查看源码，主要的逻辑从<code>listen</code>开始。</p>\n<h4 id=\"Child部分\"><a href=\"#Child部分\" class=\"headerlink\" title=\"Child部分:\"></a>Child部分:</h4><p>cluster.child里创建一个TCP服务，参数<code>port</code>是8000，<code>host</code>没有传参；</p>\n<p>调用<code>listenInCluster</code>方法，一看这名字就知道和<strong>cluster</strong>有关；</p>\n<p><code>listen</code>是在子进程里触发的，它会通过<code>cluster._getServer</code>拼出一个<code>act</code>为serverQuery的消息发送给cluster.master；</p>\n<h4 id=\"Master部分\"><a href=\"#Master部分\" class=\"headerlink\" title=\"Master部分:\"></a>Master部分:</h4><p>前文提到，<code>master.onmessage</code>方法会根据消息的act不同而做出不同的处理，此处正是<code>serverQuery</code>；</p>\n<p>进入<code>queryServer</code>方法，默认使用<code>RoundRobinHandle</code>循环分配任务；</p>\n<p>在<code>RoundRobinHandle</code>构造函数中，会调用<code>net.createServer</code>创建一个Server，由于是在cluster.master里调用的，所以会在<code>listenInCluster</code>里调用<code>server._listen2</code>，会new 出 <code>TCP</code>（src/tcp_wrap.cc）作为句柄，并将其赋给<code>server._handle</code>，至此cluster.master已经拥有了处理TCP请求的能力，不过master有该能力是不行的，还需要让child拥有才行；</p>\n<p><code>RoundRobinHandle</code>中一旦server触发了<code>listening</code>事件后，它会接管<code>server._handle</code>，用<code>distribute</code>重置其<code>onconnection</code>方法；</p>\n<p><code>distribute</code>的作用就是转发新的请求TCP给cluster.child，从<code>free</code>列队中取出一个之前<code>add</code>进来的worker（这个worker和cluster.child有关联关系），发送一个<code>act</code>为<strong>newconn</strong>的消息让其处理这个TCP；</p>\n<h4 id=\"回到Child部分\"><a href=\"#回到Child部分\" class=\"headerlink\" title=\"回到Child部分:\"></a>回到Child部分:</h4><p>cluster.child的<code>onconnection</code>收到<code>act</code>为<strong>newconn</strong>的请求后，会找到之前的创建的server，然后调用其<code>onconnection</code>（child里的该方法没有被重置）方法，然后封装出一个<code>Socket</code>对象，触发<code>onnection</code>事件；</p>\n<p>到此，后面的就是普通业务逻辑代码了。</p>\n<p><em>下面贴上了部分相关代码，还是比较多的，细节部分我也加上了注释。</em></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/net.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">createServer</span>(<span class=\"hljs-params\">options, connectionListener</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Server(options, connectionListener);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">Server</span>(<span class=\"hljs-params\">options, connectionListener</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... 大量内置属性和参数的初始化</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Server.prototype.listen = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">...args</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 传了port参数（8000），没有host</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> backlog;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> options.port === <span class=\"hljs-string\">\"number\"</span> || <span class=\"hljs-keyword\">typeof</span> options.port === <span class=\"hljs-string\">\"string\"</span>) &#123;</span><br><span class=\"line\">    backlog = options.backlog || backlogFromArgs;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (options.host) &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      listenInCluster(</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>,</span><br><span class=\"line\">        <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">        options.port | <span class=\"hljs-number\">0</span>,</span><br><span class=\"line\">        <span class=\"hljs-number\">4</span>,</span><br><span class=\"line\">        backlog,</span><br><span class=\"line\">        <span class=\"hljs-literal\">undefined</span>,</span><br><span class=\"line\">        options.exclusive</span><br><span class=\"line\">      );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">\t<span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">listenInCluster</span>(<span class=\"hljs-params\"></span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  server,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  address,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  port,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  addressType,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  backlog,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  fd,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  exclusive,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  flags</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  exclusive = !!exclusive;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (cluster === <span class=\"hljs-literal\">undefined</span>) cluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">\"cluster\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (cluster.isMaster || exclusive) &#123;</span><br><span class=\"line\">    server._listen2(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> serverQuery = &#123;</span><br><span class=\"line\">    address: address,</span><br><span class=\"line\">    port: port, </span><br><span class=\"line\">    addressType: addressType,</span><br><span class=\"line\">    fd: fd,</span><br><span class=\"line\">    flags,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  cluster._getServer(server, serverQuery, listenOnMasterHandle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">listenOnMasterHandle</span>(<span class=\"hljs-params\">err, handle</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    server._handle = handle;</span><br><span class=\"line\">    server._listen2(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\">cluster._getServer = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">obj, options, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> address = options.address;</span><br><span class=\"line\">\t<span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 当前创建的server信息是否之前已经在cluster.child里查询过</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 有的话就累加计数index值</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> indexesKey = [</span><br><span class=\"line\">    address, </span><br><span class=\"line\">    options.port,</span><br><span class=\"line\">    options.addressType,</span><br><span class=\"line\">    options.fd,</span><br><span class=\"line\">  ].join(<span class=\"hljs-string\">\":\"</span>); </span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> index = indexes.get(indexesKey);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (index === <span class=\"hljs-literal\">undefined</span>) index = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">else</span> index++;</span><br><span class=\"line\"></span><br><span class=\"line\">  indexes.set(indexesKey, index);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> message = &#123;</span><br><span class=\"line\">    act: <span class=\"hljs-string\">\"queryServer\"</span>,</span><br><span class=\"line\">    index,</span><br><span class=\"line\">    data: <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  send(message, (reply, handle) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (handle) shared(reply, handle, indexesKey, cb);</span><br><span class=\"line\">    <span class=\"hljs-comment\">// Shared listen socket.</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">else</span> rr(reply, indexesKey, cb); <span class=\"hljs-comment\">// Round-robin 返回的 handle 是null</span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">rr</span>(<span class=\"hljs-params\">message, indexesKey, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (message.errno) <span class=\"hljs-keyword\">return</span> cb(message.errno, <span class=\"hljs-literal\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> key = message.key;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">listen</span>(<span class=\"hljs-params\">backlog</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">close</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (key === <span class=\"hljs-literal\">undefined</span>) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    send(&#123; <span class=\"hljs-attr\">act</span>: <span class=\"hljs-string\">\"close\"</span>, key &#125;);</span><br><span class=\"line\">    handles.delete(key);</span><br><span class=\"line\">    indexes.delete(indexesKey);</span><br><span class=\"line\">    key = <span class=\"hljs-literal\">undefined</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getsockname</span>(<span class=\"hljs-params\">out</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (key) <span class=\"hljs-built_in\">Object</span>.assign(out, message.sockname);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> handle = &#123; close, listen, <span class=\"hljs-attr\">ref</span>: noop, <span class=\"hljs-attr\">unref</span>: noop &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (message.sockname) &#123;</span><br><span class=\"line\">    handle.getsockname = getsockname; <span class=\"hljs-comment\">// TCP handles only.</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  assert(handles.has(key) === <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">  handles.set(key, handle);</span><br><span class=\"line\">  cb(<span class=\"hljs-number\">0</span>, handle); <span class=\"hljs-comment\">// 将封装好的handle，作为listenInCluster的回调handle，赋给server._handle</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// Round-robin connection.</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">onconnection</span>(<span class=\"hljs-params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> key = message.key; <span class=\"hljs-comment\">// maseter里的key</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> server = handles.get(key); <span class=\"hljs-comment\">// 是client创建的server？</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> accepted = server !== <span class=\"hljs-literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  send(&#123; <span class=\"hljs-attr\">ack</span>: message.seq, accepted &#125;); <span class=\"hljs-comment\">// 答复 master</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 虽然cluster.child rr里没有为server绑定，onconnection</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 但是在cb回到net.js里，后面的逻辑绑定了onconnection方法</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (accepted) server.onconnection(<span class=\"hljs-number\">0</span>, handle);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">queryServer</span>(<span class=\"hljs-params\">worker, message</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// worker是cluster.child worker</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> key =</span><br><span class=\"line\">    <span class=\"hljs-string\">`<span class=\"hljs-subst\">$&#123;message.address&#125;</span>:<span class=\"hljs-subst\">$&#123;message.port&#125;</span>:<span class=\"hljs-subst\">$&#123;message.addressType&#125;</span>:`</span> +</span><br><span class=\"line\">    <span class=\"hljs-string\">`<span class=\"hljs-subst\">$&#123;message.fd&#125;</span>:<span class=\"hljs-subst\">$&#123;message.index&#125;</span>`</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> handle = handles.get(key);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (handle === <span class=\"hljs-literal\">undefined</span>) &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"hljs-comment\">// 默认是RoundRobin，Shared模式暂不讨论有兴趣可以看源码</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> <span class=\"hljs-keyword\">constructor</span> = RoundRobinHandle;</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">    handle = new <span class=\"hljs-keyword\">constructor</span>(</span><br><span class=\"line\">      key,</span><br><span class=\"line\">      address,</span><br><span class=\"line\">      message.port,</span><br><span class=\"line\">      message.addressType,</span><br><span class=\"line\">      message.fd,</span><br><span class=\"line\">      message.flags</span><br><span class=\"line\">    );</span><br><span class=\"line\">    handles.set(key, handle);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">  // 将cluster.child的worker添加到handle中</span><br><span class=\"line\">  handle.add(worker, (errno, reply, handle) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> &#123; data &#125; = handles.get(key);</span><br><span class=\"line\">    send(</span><br><span class=\"line\">      worker,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        errno,</span><br><span class=\"line\">        key,</span><br><span class=\"line\">        ack: message.seq,</span><br><span class=\"line\">        data,</span><br><span class=\"line\">        ...reply,</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      handle <span class=\"hljs-comment\">// round_robin_handle 里返回的是一个null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/round_robin_handle.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">RoundRobinHandle</span>(<span class=\"hljs-params\">key, address, port, addressType, fd, flags</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.key = key;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.all = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Map</span>();</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.free = [];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.handles = [];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.handle = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.server = net.createServer(assert.fail);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (fd &gt;= <span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">this</span>.server.listen(&#123; fd &#125;);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (port &gt;= <span class=\"hljs-number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.server.listen(&#123;</span><br><span class=\"line\">      port,</span><br><span class=\"line\">      host: address,</span><br><span class=\"line\">      <span class=\"hljs-comment\">// Currently, net module only supports `ipv6Only` option in `flags`.</span></span><br><span class=\"line\">      ipv6Only: <span class=\"hljs-built_in\">Boolean</span>(flags &amp; constants.UV_TCP_IPV6ONLY),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">this</span>.server.listen(address); <span class=\"hljs-comment\">// UNIX socket path.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.server.once(<span class=\"hljs-string\">\"listening\"</span>, () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.handle = <span class=\"hljs-keyword\">this</span>.server._handle;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// 重置onconnection方法</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// distribute 做任务派发</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.handle.onconnection = <span class=\"hljs-function\">(<span class=\"hljs-params\">err, handle</span>) =&gt;</span> <span class=\"hljs-keyword\">this</span>.distribute(err, handle);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.server._handle = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.server = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.add = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">worker, send</span>) </span>&#123;</span><br><span class=\"line\">  assert(<span class=\"hljs-keyword\">this</span>.all.has(worker.id) === <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.all.set(worker.id, worker);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> done = <span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.handle.getsockname) &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// tcp\\udp 会有getsockname</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> out = &#123;&#125;;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.handle.getsockname(out);</span><br><span class=\"line\">      <span class=\"hljs-comment\">// TODO(bnoordhuis) Check err.</span></span><br><span class=\"line\">      send(<span class=\"hljs-literal\">null</span>, &#123; <span class=\"hljs-attr\">sockname</span>: out &#125;, <span class=\"hljs-literal\">null</span>);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">      send(<span class=\"hljs-literal\">null</span>, <span class=\"hljs-literal\">null</span>, <span class=\"hljs-literal\">null</span>); <span class=\"hljs-comment\">// UNIX socket.</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.handoff(worker); <span class=\"hljs-comment\">// In case there are connections pending.</span></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.server === <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span> done();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Still busy binding.</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.server.once(<span class=\"hljs-string\">\"listening\"</span>, done);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.server.once(<span class=\"hljs-string\">\"error\"</span>, (err) =&gt; &#123;</span><br><span class=\"line\">    send(err.errno, <span class=\"hljs-literal\">null</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.distribute = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.handles.push(handle);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> worker = <span class=\"hljs-keyword\">this</span>.free.shift();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (worker) <span class=\"hljs-keyword\">this</span>.handoff(worker);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.handoff = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">worker</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// worker如果不存在那就跳出</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.all.has(worker.id) === <span class=\"hljs-literal\">false</span>) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>; <span class=\"hljs-comment\">// Worker is closing (or has closed) the server.</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> handle = <span class=\"hljs-keyword\">this</span>.handles.shift(); <span class=\"hljs-comment\">// 取出第一个待处理任务</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (handle === <span class=\"hljs-literal\">undefined</span>) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.free.push(worker);  <span class=\"hljs-comment\">// 没有的话就会将worker归还到free里</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> message = &#123; <span class=\"hljs-attr\">act</span>: <span class=\"hljs-string\">\"newconn\"</span>, <span class=\"hljs-attr\">key</span>: <span class=\"hljs-keyword\">this</span>.key &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  sendHelper(worker.process, message, handle, (reply) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (reply.accepted) handle.close();</span><br><span class=\"line\">    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">this</span>.distribute(<span class=\"hljs-number\">0</span>, handle); <span class=\"hljs-comment\">// Worker is shutting down. Send to another.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.handoff(worker);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h3 id=\"总结：\"><a href=\"#总结：\" class=\"headerlink\" title=\"总结：\"></a>总结：</h3><p><code>cluster</code>利用child_process的fork方法创建子进程，并传入新的环境变量<code>NODE_UNIQUE_ID</code>用于区分主子进程从而在require(‘cluster’)时候可以加载到对应的<code>master.js</code>和<code>child.js</code>文件。另外在默认的<code>RoundRobinHandle</code>模式下，<code>cluster</code>子进程之所以可以共同监听同个TCP端口，是在<code>net</code>模块里面做了master和child区分，child并没有真正的监听端口，而是child会去master查询该Server是否已经存在，如果没有会在<code>RoundRobinHandle</code>中创建中创建server，一旦有新的TCP连接进入，会转发给<code>free</code>里的worker（cluster.child）处理。</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p>前文简单梳理了Node.js使用<strong>child_process</strong>模块创建子进程的4种方法，<code>exec</code>、<code>execFile</code>、<code>fork</code>和<code>spawn</code>。接下来我们看看<strong>cluster</strong>模块如何创建子进程，后续更多内容会介绍cluster.fork启动Net Server时候为何不会因为共同监听同一个端口而不报错。</p>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\" target=\"_blank\" rel=\"noopener\">fork</a>: 衍生出一个新的工作进程，这只能通过主进程调用。</li>\n</ul>","more":"<p><br></p>\n<p><strong>翻翻源码看看他们怎么实现的</strong></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"section\">#define V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"section\">#define V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"section\">#define V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"section\">#define V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"section\">#define NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"section\">#define NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"section\">#define NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p><strong>cluster</strong>源码位置</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lib</span><br><span class=\"line\">  - internal</span><br><span class=\"line\"><span class=\"code\">    - cluster</span></span><br><span class=\"line\"><span class=\"code\">    - child.js</span></span><br><span class=\"line\"><span class=\"code\">      - master.js</span></span><br><span class=\"line\"><span class=\"code\">      - round_robin_handle.js</span></span><br><span class=\"line\"><span class=\"code\">      - shared_handle.js</span></span><br><span class=\"line\"><span class=\"code\">      - utils.js</span></span><br><span class=\"line\"><span class=\"code\">      - worker.js</span></span><br><span class=\"line\">  - cluster.js</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong>官方示例</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> cluster = <span class=\"built_in\">require</span>(<span class=\"string\">'cluster'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> http = <span class=\"built_in\">require</span>(<span class=\"string\">'http'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> numCPUs = <span class=\"built_in\">require</span>(<span class=\"string\">'os'</span>).cpus().length;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (cluster.isMaster) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">`主进程 <span class=\"subst\">$&#123;process.pid&#125;</span> 正在运行`</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 衍生工作进程。</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class=\"line\">    cluster.fork();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  cluster.on(<span class=\"string\">'exit'</span>, (worker, code, signal) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">`工作进程 <span class=\"subst\">$&#123;worker.process.pid&#125;</span> 已退出`</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 工作进程可以共享任何 TCP 连接。</span></span><br><span class=\"line\">  <span class=\"comment\">// 在本例子中，共享的是 HTTP 服务器。</span></span><br><span class=\"line\">  http.createServer(<span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    res.writeHead(<span class=\"number\">200</span>);</span><br><span class=\"line\">    res.end(<span class=\"string\">'你好世界\\n'</span>);</span><br><span class=\"line\">  &#125;).listen(<span class=\"number\">8000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">`工作进程 <span class=\"subst\">$&#123;process.pid&#125;</span> 已启动`</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h3 id=\"Q-cluster-isMaster模块如何区分是主进程还是子进程的？\"><a href=\"#Q-cluster-isMaster模块如何区分是主进程还是子进程的？\" class=\"headerlink\" title=\"Q:cluster.isMaster模块如何区分是主进程还是子进程的？\"></a>Q:cluster.isMaster模块如何区分是主进程还是子进程的？</h3><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/cluster.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> childOrMaster = <span class=\"string\">'NODE_UNIQUE_ID'</span> <span class=\"keyword\">in</span> process.env ? <span class=\"string\">'child'</span> : <span class=\"string\">'master'</span>;</span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"built_in\">require</span>(<span class=\"string\">`internal/cluster/<span class=\"subst\">$&#123;childOrMaster&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>\n<p><code>lib/cluster.js</code>是整个cluster的入口，根据环境变量中是否有<code>NODE_UNIQUE_ID</code>来区分主或子进程。</p>\n<p>主进程通过<code>cluster.fork</code>创建子进程的时候，会将<code>NODE_UNIQUE_ID</code>传入子进程的环境变量中，最后通过<strong>child_process.fork</strong>去创建新的子进程。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">cluster.isMaster = <span class=\"literal\">true</span>;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"><span class=\"comment\">// fork的代码下文还会提到</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> workerEnv = &#123; ...process.env, ...env, <span class=\"attr\">NODE_UNIQUE_ID</span>: <span class=\"string\">`<span class=\"subst\">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class=\"line\"><span class=\"keyword\">return</span> fork(cluster.settings.exec, cluster.settings.args, &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  env: workerEnv,</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">cluster.isMaster = <span class=\"literal\">false</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Q-cluster-fork创建子进程过程中做了些什么？\"><a href=\"#Q-cluster-fork创建子进程过程中做了些什么？\" class=\"headerlink\" title=\"Q:cluster.fork创建子进程过程中做了些什么？\"></a>Q:cluster.fork创建子进程过程中做了些什么？</h3><p><code>cluster.setupMaster</code>是对整个环境参数的配置；</p>\n<p>通过<code>createWorkerProcess</code>里的<code>child_process.fork</code>去创建子进程；</p>\n<p>之后将其和一个<code>Worker</code>对象做关联，worker、其子进程和当前cluster(master)都会收到几乎相同的<code>message</code>、<code>exit</code>和<code>disconnect</code>事件，<strong>Worker</strong>这边不多扩展，可以查阅<code>lib/internal/cluster/worker.js</code>；</p>\n<p>子进程会监听<code>internalMessage</code>事件，什么是internalMessage事件呢？看看下面官方的介绍。</p>\n<blockquote>\n<p>当发送 <strong>{cmd: ‘NODE_foo’}</strong> 消息时有一种特殊情况。 <strong>cmd</strong> 属性中包含 <strong>NODE_</strong> 前缀的消息是预留给 Node.js 内核内部使用的，将不会触发子进程的 <strong>‘message’</strong>事件。 相反，这种消息可使用 <strong>‘internalMessage’</strong> 事件触发，且会被 Node.js 内部消费。 应用程序应避免使用此类消息或监听<strong>‘internalMessage’</strong> 事件，因为它可能会被更改且不会通知。</p>\n</blockquote>\n<p>此处<code>internalMessage</code>事件的回调方法是<code>internal(worker, onmessage)</code>，<strong>internal</strong>是<code>lib/internal/cluster/master.js</code>里的方法，主要作用是判断监听的消息里面是否存在需要执行的回调，如果没有就会执行入参回调，这里指的是<strong>onmessage</strong>；</p>\n<p><strong>onmessage</strong>里面有很多if-else语句，主要是根据cluster.child传送进来的消息类型(<code>act</code>)做出不同的处理，这里列出了一个<code>queryServer</code>（因为后面会介绍Net Server里多个子进程如何监听同一个端口的）。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\">cluster.fork = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">env</span>) </span>&#123;</span><br><span class=\"line\">  cluster.setupMaster();</span><br><span class=\"line\">  <span class=\"keyword\">const</span> id = ++ids;</span><br><span class=\"line\">  <span class=\"comment\">// 创建子进程</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> workerProcess = createWorkerProcess(id, env);</span><br><span class=\"line\">  <span class=\"comment\">//</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> worker = <span class=\"keyword\">new</span> Worker(&#123;</span><br><span class=\"line\">    id: id,</span><br><span class=\"line\">    process: workerProcess, <span class=\"comment\">// 新建的子进程</span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  </span><br><span class=\"line\">  worker.on(<span class=\"string\">\"message\"</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">    cluster.emit(<span class=\"string\">\"message\"</span>, <span class=\"keyword\">this</span>, message, handle);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  worker.process.once(<span class=\"string\">\"exit\"</span>, (exitCode, signalCode) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    worker.state = <span class=\"string\">\"dead\"</span>;</span><br><span class=\"line\">    worker.emit(<span class=\"string\">\"exit\"</span>, exitCode, signalCode);</span><br><span class=\"line\">    cluster.emit(<span class=\"string\">\"exit\"</span>, worker, exitCode, signalCode);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  worker.process.once(<span class=\"string\">\"disconnect\"</span>, () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    worker.state = <span class=\"string\">\"disconnected\"</span>;</span><br><span class=\"line\">    worker.emit(<span class=\"string\">\"disconnect\"</span>);</span><br><span class=\"line\">    cluster.emit(<span class=\"string\">\"disconnect\"</span>, worker);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  worker.process.on(<span class=\"string\">\"internalMessage\"</span>, internal(worker, onmessage));</span><br><span class=\"line\">  <span class=\"comment\">// 触发 fork 事件</span></span><br><span class=\"line\">  process.nextTick(emitForkNT, worker);</span><br><span class=\"line\">  cluster.workers[worker.id] = worker; </span><br><span class=\"line\">  <span class=\"keyword\">return</span> worker;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createWorkerProcess</span>(<span class=\"params\">id, env</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> workerEnv = &#123; ...process.env, ...env, <span class=\"attr\">NODE_UNIQUE_ID</span>: <span class=\"string\">`<span class=\"subst\">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class=\"line\">  <span class=\"comment\">// ... 对一些参数的组合和设定</span></span><br><span class=\"line\">  <span class=\"comment\">// 调用child_process的fork方法创建子进程</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> fork(cluster.settings.exec, cluster.settings.args, &#123;</span><br><span class=\"line\">    cwd: cluster.settings.cwd,</span><br><span class=\"line\">    env: workerEnv,</span><br><span class=\"line\">    silent: cluster.settings.silent,</span><br><span class=\"line\">    windowsHide: cluster.settings.windowsHide,</span><br><span class=\"line\">    execArgv: execArgv,</span><br><span class=\"line\">    stdio: cluster.settings.stdio,</span><br><span class=\"line\">    gid: cluster.settings.gid,</span><br><span class=\"line\">    uid: cluster.settings.uid,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onmessage</span>(<span class=\"params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> worker = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  <span class=\"comment\">// ... if message.act 类型很多 这里主要讲 queryServer</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (message.act === <span class=\"string\">\"queryServer\"</span>) queryServer(worker, message);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/utils.js</span></span><br><span class=\"line\"><span class=\"comment\">// 在cluster的chilid和master里的send都会调用sendHelper</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> seq = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">sendHelper</span>(<span class=\"params\">proc, message, handle, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!proc.connected) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  <span class=\"comment\">// NODE_* 开头的命令触发 internalMessage </span></span><br><span class=\"line\">  message = &#123; <span class=\"attr\">cmd</span>: <span class=\"string\">\"NODE_CLUSTER\"</span>, ...message, seq &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> cb === <span class=\"string\">\"function\"</span>) callbacks.set(seq, cb); <span class=\"comment\">// 缓存回调</span></span><br><span class=\"line\"></span><br><span class=\"line\">  seq += <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"comment\">// cluster/child.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"comment\">// cluster/master.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> proc.send(message, handle);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>以上就是cluster.fork的大致过程，引入一个Worker和internalMessage概念，之后会用得到。cluster的child和master之间传输信息，都是通过<code>sendHelper</code>方法。</p>\n<h3 id=\"Q-cluster-fork创建的子进程如何共同监听TCP端口？\"><a href=\"#Q-cluster-fork创建的子进程如何共同监听TCP端口？\" class=\"headerlink\" title=\"Q:cluster.fork创建的子进程如何共同监听TCP端口？\"></a>Q:cluster.fork创建的子进程如何共同监听TCP端口？</h3><p>解答这个问题，主要是看<code>net</code>模块如何创建Server的，还有就是cluster中<code>child</code>和<code>master</code>如何通信的。</p>\n<p>官方示例虽然用的是<code>http</code>创建的服务，但它底层是继承的<code>net</code>模块，为了方便梳理，我们从<code>net.createServer</code>入手一步步查看源码，主要的逻辑从<code>listen</code>开始。</p>\n<h4 id=\"Child部分\"><a href=\"#Child部分\" class=\"headerlink\" title=\"Child部分:\"></a>Child部分:</h4><p>cluster.child里创建一个TCP服务，参数<code>port</code>是8000，<code>host</code>没有传参；</p>\n<p>调用<code>listenInCluster</code>方法，一看这名字就知道和<strong>cluster</strong>有关；</p>\n<p><code>listen</code>是在子进程里触发的，它会通过<code>cluster._getServer</code>拼出一个<code>act</code>为serverQuery的消息发送给cluster.master；</p>\n<h4 id=\"Master部分\"><a href=\"#Master部分\" class=\"headerlink\" title=\"Master部分:\"></a>Master部分:</h4><p>前文提到，<code>master.onmessage</code>方法会根据消息的act不同而做出不同的处理，此处正是<code>serverQuery</code>；</p>\n<p>进入<code>queryServer</code>方法，默认使用<code>RoundRobinHandle</code>循环分配任务；</p>\n<p>在<code>RoundRobinHandle</code>构造函数中，会调用<code>net.createServer</code>创建一个Server，由于是在cluster.master里调用的，所以会在<code>listenInCluster</code>里调用<code>server._listen2</code>，会new 出 <code>TCP</code>（src/tcp_wrap.cc）作为句柄，并将其赋给<code>server._handle</code>，至此cluster.master已经拥有了处理TCP请求的能力，不过master有该能力是不行的，还需要让child拥有才行；</p>\n<p><code>RoundRobinHandle</code>中一旦server触发了<code>listening</code>事件后，它会接管<code>server._handle</code>，用<code>distribute</code>重置其<code>onconnection</code>方法；</p>\n<p><code>distribute</code>的作用就是转发新的请求TCP给cluster.child，从<code>free</code>列队中取出一个之前<code>add</code>进来的worker（这个worker和cluster.child有关联关系），发送一个<code>act</code>为<strong>newconn</strong>的消息让其处理这个TCP；</p>\n<h4 id=\"回到Child部分\"><a href=\"#回到Child部分\" class=\"headerlink\" title=\"回到Child部分:\"></a>回到Child部分:</h4><p>cluster.child的<code>onconnection</code>收到<code>act</code>为<strong>newconn</strong>的请求后，会找到之前的创建的server，然后调用其<code>onconnection</code>（child里的该方法没有被重置）方法，然后封装出一个<code>Socket</code>对象，触发<code>onnection</code>事件；</p>\n<p>到此，后面的就是普通业务逻辑代码了。</p>\n<p><em>下面贴上了部分相关代码，还是比较多的，细节部分我也加上了注释。</em></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/net.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createServer</span>(<span class=\"params\">options, connectionListener</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Server(options, connectionListener);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Server</span>(<span class=\"params\">options, connectionListener</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ... 大量内置属性和参数的初始化</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Server.prototype.listen = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"comment\">// 传了port参数（8000），没有host</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> backlog;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options.port === <span class=\"string\">\"number\"</span> || <span class=\"keyword\">typeof</span> options.port === <span class=\"string\">\"string\"</span>) &#123;</span><br><span class=\"line\">    backlog = options.backlog || backlogFromArgs;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (options.host) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// </span></span><br><span class=\"line\">      listenInCluster(</span><br><span class=\"line\">        <span class=\"keyword\">this</span>,</span><br><span class=\"line\">        <span class=\"literal\">null</span>,</span><br><span class=\"line\">        options.port | <span class=\"number\">0</span>,</span><br><span class=\"line\">        <span class=\"number\">4</span>,</span><br><span class=\"line\">        backlog,</span><br><span class=\"line\">        <span class=\"literal\">undefined</span>,</span><br><span class=\"line\">        options.exclusive</span><br><span class=\"line\">      );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">\t<span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">listenInCluster</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  server,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  address,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  port,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  addressType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  backlog,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  fd,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  exclusive,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  flags</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  exclusive = !!exclusive;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (cluster === <span class=\"literal\">undefined</span>) cluster = <span class=\"built_in\">require</span>(<span class=\"string\">\"cluster\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (cluster.isMaster || exclusive) &#123;</span><br><span class=\"line\">    server._listen2(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> serverQuery = &#123;</span><br><span class=\"line\">    address: address,</span><br><span class=\"line\">    port: port, </span><br><span class=\"line\">    addressType: addressType,</span><br><span class=\"line\">    fd: fd,</span><br><span class=\"line\">    flags,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  cluster._getServer(server, serverQuery, listenOnMasterHandle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">listenOnMasterHandle</span>(<span class=\"params\">err, handle</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    server._handle = handle;</span><br><span class=\"line\">    server._listen2(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\">cluster._getServer = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">obj, options, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> address = options.address;</span><br><span class=\"line\">\t<span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"comment\">// 当前创建的server信息是否之前已经在cluster.child里查询过</span></span><br><span class=\"line\">  <span class=\"comment\">// 有的话就累加计数index值</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> indexesKey = [</span><br><span class=\"line\">    address, </span><br><span class=\"line\">    options.port,</span><br><span class=\"line\">    options.addressType,</span><br><span class=\"line\">    options.fd,</span><br><span class=\"line\">  ].join(<span class=\"string\">\":\"</span>); </span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">let</span> index = indexes.get(indexesKey);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (index === <span class=\"literal\">undefined</span>) index = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> index++;</span><br><span class=\"line\"></span><br><span class=\"line\">  indexes.set(indexesKey, index);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> message = &#123;</span><br><span class=\"line\">    act: <span class=\"string\">\"queryServer\"</span>,</span><br><span class=\"line\">    index,</span><br><span class=\"line\">    data: <span class=\"literal\">null</span>,</span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  send(message, (reply, handle) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (handle) shared(reply, handle, indexesKey, cb);</span><br><span class=\"line\">    <span class=\"comment\">// Shared listen socket.</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span> rr(reply, indexesKey, cb); <span class=\"comment\">// Round-robin 返回的 handle 是null</span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">rr</span>(<span class=\"params\">message, indexesKey, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (message.errno) <span class=\"keyword\">return</span> cb(message.errno, <span class=\"literal\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> key = message.key;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">listen</span>(<span class=\"params\">backlog</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">close</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (key === <span class=\"literal\">undefined</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    send(&#123; <span class=\"attr\">act</span>: <span class=\"string\">\"close\"</span>, key &#125;);</span><br><span class=\"line\">    handles.delete(key);</span><br><span class=\"line\">    indexes.delete(indexesKey);</span><br><span class=\"line\">    key = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getsockname</span>(<span class=\"params\">out</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (key) <span class=\"built_in\">Object</span>.assign(out, message.sockname);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> handle = &#123; close, listen, <span class=\"attr\">ref</span>: noop, <span class=\"attr\">unref</span>: noop &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (message.sockname) &#123;</span><br><span class=\"line\">    handle.getsockname = getsockname; <span class=\"comment\">// TCP handles only.</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  assert(handles.has(key) === <span class=\"literal\">false</span>);</span><br><span class=\"line\">  handles.set(key, handle);</span><br><span class=\"line\">  cb(<span class=\"number\">0</span>, handle); <span class=\"comment\">// 将封装好的handle，作为listenInCluster的回调handle，赋给server._handle</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Round-robin connection.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onconnection</span>(<span class=\"params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> key = message.key; <span class=\"comment\">// maseter里的key</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> server = handles.get(key); <span class=\"comment\">// 是client创建的server？</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> accepted = server !== <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  send(&#123; <span class=\"attr\">ack</span>: message.seq, accepted &#125;); <span class=\"comment\">// 答复 master</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 虽然cluster.child rr里没有为server绑定，onconnection</span></span><br><span class=\"line\">  <span class=\"comment\">// 但是在cb回到net.js里，后面的逻辑绑定了onconnection方法</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (accepted) server.onconnection(<span class=\"number\">0</span>, handle);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">queryServer</span>(<span class=\"params\">worker, message</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// worker是cluster.child worker</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> key =</span><br><span class=\"line\">    <span class=\"string\">`<span class=\"subst\">$&#123;message.address&#125;</span>:<span class=\"subst\">$&#123;message.port&#125;</span>:<span class=\"subst\">$&#123;message.addressType&#125;</span>:`</span> +</span><br><span class=\"line\">    <span class=\"string\">`<span class=\"subst\">$&#123;message.fd&#125;</span>:<span class=\"subst\">$&#123;message.index&#125;</span>`</span>;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> handle = handles.get(key);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (handle === <span class=\"literal\">undefined</span>) &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">// 默认是RoundRobin，Shared模式暂不讨论有兴趣可以看源码</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"keyword\">constructor</span> = RoundRobinHandle;</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">    handle = new <span class=\"keyword\">constructor</span>(</span><br><span class=\"line\">      key,</span><br><span class=\"line\">      address,</span><br><span class=\"line\">      message.port,</span><br><span class=\"line\">      message.addressType,</span><br><span class=\"line\">      message.fd,</span><br><span class=\"line\">      message.flags</span><br><span class=\"line\">    );</span><br><span class=\"line\">    handles.set(key, handle);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">  // 将cluster.child的worker添加到handle中</span><br><span class=\"line\">  handle.add(worker, (errno, reply, handle) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; data &#125; = handles.get(key);</span><br><span class=\"line\">    send(</span><br><span class=\"line\">      worker,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        errno,</span><br><span class=\"line\">        key,</span><br><span class=\"line\">        ack: message.seq,</span><br><span class=\"line\">        data,</span><br><span class=\"line\">        ...reply,</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      handle <span class=\"comment\">// round_robin_handle 里返回的是一个null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/round_robin_handle.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">RoundRobinHandle</span>(<span class=\"params\">key, address, port, addressType, fd, flags</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.key = key;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.all = <span class=\"keyword\">new</span> <span class=\"built_in\">Map</span>();</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.free = [];</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.handles = [];</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.handle = <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.server = net.createServer(assert.fail);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fd &gt;= <span class=\"number\">0</span>) <span class=\"keyword\">this</span>.server.listen(&#123; fd &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (port &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.server.listen(&#123;</span><br><span class=\"line\">      port,</span><br><span class=\"line\">      host: address,</span><br><span class=\"line\">      <span class=\"comment\">// Currently, net module only supports `ipv6Only` option in `flags`.</span></span><br><span class=\"line\">      ipv6Only: <span class=\"built_in\">Boolean</span>(flags &amp; constants.UV_TCP_IPV6ONLY),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">this</span>.server.listen(address); <span class=\"comment\">// UNIX socket path.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.server.once(<span class=\"string\">\"listening\"</span>, () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.handle = <span class=\"keyword\">this</span>.server._handle;</span><br><span class=\"line\">    <span class=\"comment\">// 重置onconnection方法</span></span><br><span class=\"line\">    <span class=\"comment\">// distribute 做任务派发</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.handle.onconnection = <span class=\"function\">(<span class=\"params\">err, handle</span>) =&gt;</span> <span class=\"keyword\">this</span>.distribute(err, handle);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.server._handle = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.server = <span class=\"literal\">null</span>;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.add = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">worker, send</span>) </span>&#123;</span><br><span class=\"line\">  assert(<span class=\"keyword\">this</span>.all.has(worker.id) === <span class=\"literal\">false</span>);</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.all.set(worker.id, worker);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> done = <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.handle.getsockname) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// tcp\\udp 会有getsockname</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> out = &#123;&#125;;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.handle.getsockname(out);</span><br><span class=\"line\">      <span class=\"comment\">// TODO(bnoordhuis) Check err.</span></span><br><span class=\"line\">      send(<span class=\"literal\">null</span>, &#123; <span class=\"attr\">sockname</span>: out &#125;, <span class=\"literal\">null</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      send(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>); <span class=\"comment\">// UNIX socket.</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.handoff(worker); <span class=\"comment\">// In case there are connections pending.</span></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.server === <span class=\"literal\">null</span>) <span class=\"keyword\">return</span> done();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Still busy binding.</span></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.server.once(<span class=\"string\">\"listening\"</span>, done);</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.server.once(<span class=\"string\">\"error\"</span>, (err) =&gt; &#123;</span><br><span class=\"line\">    send(err.errno, <span class=\"literal\">null</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.distribute = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.handles.push(handle);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> worker = <span class=\"keyword\">this</span>.free.shift();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (worker) <span class=\"keyword\">this</span>.handoff(worker);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.handoff = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">worker</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// worker如果不存在那就跳出</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.all.has(worker.id) === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>; <span class=\"comment\">// Worker is closing (or has closed) the server.</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> handle = <span class=\"keyword\">this</span>.handles.shift(); <span class=\"comment\">// 取出第一个待处理任务</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (handle === <span class=\"literal\">undefined</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.free.push(worker);  <span class=\"comment\">// 没有的话就会将worker归还到free里</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> message = &#123; <span class=\"attr\">act</span>: <span class=\"string\">\"newconn\"</span>, <span class=\"attr\">key</span>: <span class=\"keyword\">this</span>.key &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  sendHelper(worker.process, message, handle, (reply) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (reply.accepted) handle.close();</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">this</span>.distribute(<span class=\"number\">0</span>, handle); <span class=\"comment\">// Worker is shutting down. Send to another.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.handoff(worker);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h3 id=\"总结：\"><a href=\"#总结：\" class=\"headerlink\" title=\"总结：\"></a>总结：</h3><p><code>cluster</code>利用child_process的fork方法创建子进程，并传入新的环境变量<code>NODE_UNIQUE_ID</code>用于区分主子进程从而在require(‘cluster’)时候可以加载到对应的<code>master.js</code>和<code>child.js</code>文件。另外在默认的<code>RoundRobinHandle</code>模式下，<code>cluster</code>子进程之所以可以共同监听同个TCP端口，是在<code>net</code>模块里面做了master和child区分，child并没有真正的监听端口，而是child会去master查询该Server是否已经存在，如果没有会在<code>RoundRobinHandle</code>中创建中创建server，一旦有新的TCP连接进入，会转发给<code>free</code>里的worker（cluster.child）处理。</p>"},{"title":"2019 工作总结","date":"2019-12-30T15:30:00.000Z","_content":"\n> It was the best of times, it was the worst of times.\n\n如果真要用一句话形容2019年工作的话，上述的**双城记**节选我觉得是极好。大概2018年尾的时候，公司的前端团队开始用Node.js做些后端业务等相关的工作并积累经验，与现有的Java基础架构做融合，微服务[Eureka](https://github.com/Netflix/eureka)、分布式协调服务[ZooKeeper](https://zookeeper.apache.org/)、分布式配置管理平台[Discon](https://disconf.readthedocs.io/zh_CN/latest/)、应用监控[Cat](https://github.com/dianping/cat)、消息列队[RocketMQ](https://rocketmq.apache.org/)、分布式署存储服务[SeaweedFS](https://github.com/chrislusf/seaweedfs)、数据库[MySQL](https://www.mysql.com/cn/)等等，大量的知识扑面而来。幸好之前有.NET C# + Javascript做Web开发经历，加上一些Node.js开发经验，比如[爱眠物](http://aimianwu.com)等等，上手掌握并不难。基本上每天都有很多东西可以学，上半年忙着产出业务，也忙着封装一些基于`Egg.js`适合公司项目的基础代码。不过问题也是频发，上面提到的很多东西并非是Node.js生态圈大量使用的，引用一些冷门的第三个类库暴露出了EventLoop被卡住、Memory Leak的情况，下半年忙着优化和排查。\n\n\n\n<!-- more -->\n\n\n\n<br/>\n\n### EventLoop问题\n\n我们的Node.js程序发布到测试或者生产，经常服务端出现大量TCP `Close Wait`的情况，从TCP的信息反馈把重点都放在了网络层面，因为大量Close Wait导致服务无法响应新的请求，以为是上下游网络的超时时间问题，但是无论如何通过Node.js的Javascript层面做实验都未能出现，后来又查系统级别的配置问题等等，都是没查出一个所以然。\n\n**我之前写的各种Node.js服务都跑的好好的，为什么现在这家公司会出现卡死的问题呢？难道把锅甩给系统环境？**\n\n困惑和压力倍增，毕竟项目已经上生产了，金融服务出一点问题都是头大的事情。后来用`alinode`做监控，可惜我们的节点都在国外，而免费版本对国外节点并不友好，总是会断了监控数据。无奈只能麻烦运维同事帮忙去Docker上生成发生问题时候的`火焰图`，发现是`Cat`导致的，底层的C++代码阻碍了EventLoop的正常运行，把整个Node.js进程给卡死了。\n![catMessageSenderFun方法几乎占据了一整行](/images/summary-2019/1.png)\n\n或许你会问，**为什么不早点搭建有效的监控系统去排查这些问题呢？或许就不会那么被动了！**\n\n主要有3点：\n\n1. Node.js在我们上海技术团队内部算是兴起，我们希望能承接更多的业务等去做，就如同**创业**一样，团队自己的技术栈在公司内部使用的多了，自然有更多资源招兵买马为以后大前端、BFF层搭建做准备。可以理解为创业公司不断的做业务拉投资，我相信在很多大点的公司，很多小团队都会有这种创业的感觉\n2. 每个公司所使用的某个技术栈都有自己的定位，我们也在不同领域做尝试，有倾向业务的、有做基础设施搭建的等，也在寻找Node.js适合当前公司的定位\n3. 经验还是缺乏点，当时运维已经有了相关对Docker的系统监控，加上`Cat`业务监控感觉能抵挡一段时间，但是万万没想到就是缺少CPU的火焰图和内存堆栈图信息导致排查问题困难重重\n\n<br/>\n\n### Memory Leak问题\n\n前后经历了2次较大的内存泄露问题\n\n**陌生类库：** 其实也是知道要谨慎选择类库的使用，但有时候又该怎么说呢...\n\n**Vue SSR：** 这个问题是书写Vue相关代码时候没注意导致的，其作者在Github上也留言指出了相关的[解决方法](https://github.com/vuejs/vue/issues/5089)\n\n![https://github.com/vuejs/vue/issues/5089](/images/summary-2019/2.jpg)\n\n**目前组内对前端或者Node.js的监控体系在逐步搭建和迭代的过程中，一个监控Hub，通过TCP通信将所有的Node.js进程与其进行长连接，实时双向传输数据，按照命令生成火焰图或者内存堆栈信息。**\n\n<br/>\n\n### 优化了静态资源打包和分发流程\n\n打包这个东西自然还是基于`Webpack`的封装，谁让人家NB呢。整体流程之前比较复杂，做了一次重CI的优化，也适合目前的小型团队使用，从中抽取了一套插件式的程序加载流程，整体思想还是抄的`Egg.js`，谁让人家好用好扩展呢！\n\n**为什么不完全基于Egg.js的插件开发方式？**\n\n团队对底层架构级的东西不能完全基于Egg.js，会有更多多元化的框架引入（看具体场景，尽量少，但万一呢），通过适配层就能让底层代码依附到不同框架上。所以我既不能依附Webpack写太多插件，也不能依附其它的Node.js应用框架，毕竟Node.js五花八门、百家争鸣，我们想办法把他们粘合在一起就好，所以需要一套自己的加载器。\n\n<br/>\n\n<br/>\n\n## 从2019迈向2020\n\n2019年对我而言确实又坏又好，坏的是工作上的问题一个个来，万幸的是都一个个解决和迭代中了，确实经历多了，学到的东西和成长也就多了。期望2020能把一直想做的BFF层可以慢慢做起来，另外监控等小项目能有机会开源。\n\n\n\n\n\n\n","source":"_posts/summary-2019.md","raw":"---\ntitle: 2019 工作总结\ncategory: work\ndate: 2019-12-30 23:30:00\n---\n\n> It was the best of times, it was the worst of times.\n\n如果真要用一句话形容2019年工作的话，上述的**双城记**节选我觉得是极好。大概2018年尾的时候，公司的前端团队开始用Node.js做些后端业务等相关的工作并积累经验，与现有的Java基础架构做融合，微服务[Eureka](https://github.com/Netflix/eureka)、分布式协调服务[ZooKeeper](https://zookeeper.apache.org/)、分布式配置管理平台[Discon](https://disconf.readthedocs.io/zh_CN/latest/)、应用监控[Cat](https://github.com/dianping/cat)、消息列队[RocketMQ](https://rocketmq.apache.org/)、分布式署存储服务[SeaweedFS](https://github.com/chrislusf/seaweedfs)、数据库[MySQL](https://www.mysql.com/cn/)等等，大量的知识扑面而来。幸好之前有.NET C# + Javascript做Web开发经历，加上一些Node.js开发经验，比如[爱眠物](http://aimianwu.com)等等，上手掌握并不难。基本上每天都有很多东西可以学，上半年忙着产出业务，也忙着封装一些基于`Egg.js`适合公司项目的基础代码。不过问题也是频发，上面提到的很多东西并非是Node.js生态圈大量使用的，引用一些冷门的第三个类库暴露出了EventLoop被卡住、Memory Leak的情况，下半年忙着优化和排查。\n\n\n\n<!-- more -->\n\n\n\n<br/>\n\n### EventLoop问题\n\n我们的Node.js程序发布到测试或者生产，经常服务端出现大量TCP `Close Wait`的情况，从TCP的信息反馈把重点都放在了网络层面，因为大量Close Wait导致服务无法响应新的请求，以为是上下游网络的超时时间问题，但是无论如何通过Node.js的Javascript层面做实验都未能出现，后来又查系统级别的配置问题等等，都是没查出一个所以然。\n\n**我之前写的各种Node.js服务都跑的好好的，为什么现在这家公司会出现卡死的问题呢？难道把锅甩给系统环境？**\n\n困惑和压力倍增，毕竟项目已经上生产了，金融服务出一点问题都是头大的事情。后来用`alinode`做监控，可惜我们的节点都在国外，而免费版本对国外节点并不友好，总是会断了监控数据。无奈只能麻烦运维同事帮忙去Docker上生成发生问题时候的`火焰图`，发现是`Cat`导致的，底层的C++代码阻碍了EventLoop的正常运行，把整个Node.js进程给卡死了。\n![catMessageSenderFun方法几乎占据了一整行](/images/summary-2019/1.png)\n\n或许你会问，**为什么不早点搭建有效的监控系统去排查这些问题呢？或许就不会那么被动了！**\n\n主要有3点：\n\n1. Node.js在我们上海技术团队内部算是兴起，我们希望能承接更多的业务等去做，就如同**创业**一样，团队自己的技术栈在公司内部使用的多了，自然有更多资源招兵买马为以后大前端、BFF层搭建做准备。可以理解为创业公司不断的做业务拉投资，我相信在很多大点的公司，很多小团队都会有这种创业的感觉\n2. 每个公司所使用的某个技术栈都有自己的定位，我们也在不同领域做尝试，有倾向业务的、有做基础设施搭建的等，也在寻找Node.js适合当前公司的定位\n3. 经验还是缺乏点，当时运维已经有了相关对Docker的系统监控，加上`Cat`业务监控感觉能抵挡一段时间，但是万万没想到就是缺少CPU的火焰图和内存堆栈图信息导致排查问题困难重重\n\n<br/>\n\n### Memory Leak问题\n\n前后经历了2次较大的内存泄露问题\n\n**陌生类库：** 其实也是知道要谨慎选择类库的使用，但有时候又该怎么说呢...\n\n**Vue SSR：** 这个问题是书写Vue相关代码时候没注意导致的，其作者在Github上也留言指出了相关的[解决方法](https://github.com/vuejs/vue/issues/5089)\n\n![https://github.com/vuejs/vue/issues/5089](/images/summary-2019/2.jpg)\n\n**目前组内对前端或者Node.js的监控体系在逐步搭建和迭代的过程中，一个监控Hub，通过TCP通信将所有的Node.js进程与其进行长连接，实时双向传输数据，按照命令生成火焰图或者内存堆栈信息。**\n\n<br/>\n\n### 优化了静态资源打包和分发流程\n\n打包这个东西自然还是基于`Webpack`的封装，谁让人家NB呢。整体流程之前比较复杂，做了一次重CI的优化，也适合目前的小型团队使用，从中抽取了一套插件式的程序加载流程，整体思想还是抄的`Egg.js`，谁让人家好用好扩展呢！\n\n**为什么不完全基于Egg.js的插件开发方式？**\n\n团队对底层架构级的东西不能完全基于Egg.js，会有更多多元化的框架引入（看具体场景，尽量少，但万一呢），通过适配层就能让底层代码依附到不同框架上。所以我既不能依附Webpack写太多插件，也不能依附其它的Node.js应用框架，毕竟Node.js五花八门、百家争鸣，我们想办法把他们粘合在一起就好，所以需要一套自己的加载器。\n\n<br/>\n\n<br/>\n\n## 从2019迈向2020\n\n2019年对我而言确实又坏又好，坏的是工作上的问题一个个来，万幸的是都一个个解决和迭代中了，确实经历多了，学到的东西和成长也就多了。期望2020能把一直想做的BFF层可以慢慢做起来，另外监控等小项目能有机会开源。\n\n\n\n\n\n\n","slug":"summary-2019","published":1,"updated":"2020-07-07T10:11:25.589Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6g000wd12is9oenoib","content":"<blockquote>\n<p>It was the best of times, it was the worst of times.</p>\n</blockquote>\n<p>如果真要用一句话形容2019年工作的话，上述的<strong>双城记</strong>节选我觉得是极好。大概2018年尾的时候，公司的前端团队开始用Node.js做些后端业务等相关的工作并积累经验，与现有的Java基础架构做融合，微服务<a href=\"https://github.com/Netflix/eureka\" target=\"_blank\" rel=\"noopener\">Eureka</a>、分布式协调服务<a href=\"https://zookeeper.apache.org/\" target=\"_blank\" rel=\"noopener\">ZooKeeper</a>、分布式配置管理平台<a href=\"https://disconf.readthedocs.io/zh_CN/latest/\" target=\"_blank\" rel=\"noopener\">Discon</a>、应用监控<a href=\"https://github.com/dianping/cat\" target=\"_blank\" rel=\"noopener\">Cat</a>、消息列队<a href=\"https://rocketmq.apache.org/\" target=\"_blank\" rel=\"noopener\">RocketMQ</a>、分布式署存储服务<a href=\"https://github.com/chrislusf/seaweedfs\" target=\"_blank\" rel=\"noopener\">SeaweedFS</a>、数据库<a href=\"https://www.mysql.com/cn/\" target=\"_blank\" rel=\"noopener\">MySQL</a>等等，大量的知识扑面而来。幸好之前有.NET C# + Javascript做Web开发经历，加上一些Node.js开发经验，比如<a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\">爱眠物</a>等等，上手掌握并不难。基本上每天都有很多东西可以学，上半年忙着产出业务，也忙着封装一些基于<code>Egg.js</code>适合公司项目的基础代码。不过问题也是频发，上面提到的很多东西并非是Node.js生态圈大量使用的，引用一些冷门的第三个类库暴露出了EventLoop被卡住、Memory Leak的情况，下半年忙着优化和排查。</p>\n<a id=\"more\"></a>\n<p><br></p>\n<h3 id=\"EventLoop问题\"><a href=\"#EventLoop问题\" class=\"headerlink\" title=\"EventLoop问题\"></a>EventLoop问题</h3><p>我们的Node.js程序发布到测试或者生产，经常服务端出现大量TCP <code>Close Wait</code>的情况，从TCP的信息反馈把重点都放在了网络层面，因为大量Close Wait导致服务无法响应新的请求，以为是上下游网络的超时时间问题，但是无论如何通过Node.js的Javascript层面做实验都未能出现，后来又查系统级别的配置问题等等，都是没查出一个所以然。</p>\n<p><strong>我之前写的各种Node.js服务都跑的好好的，为什么现在这家公司会出现卡死的问题呢？难道把锅甩给系统环境？</strong></p>\n<p>困惑和压力倍增，毕竟项目已经上生产了，金融服务出一点问题都是头大的事情。后来用<code>alinode</code>做监控，可惜我们的节点都在国外，而免费版本对国外节点并不友好，总是会断了监控数据。无奈只能麻烦运维同事帮忙去Docker上生成发生问题时候的<code>火焰图</code>，发现是<code>Cat</code>导致的，底层的C++代码阻碍了EventLoop的正常运行，把整个Node.js进程给卡死了。<br><img src=\"/images/summary-2019/1.png\" alt=\"catMessageSenderFun方法几乎占据了一整行\"></p>\n<p>或许你会问，<strong>为什么不早点搭建有效的监控系统去排查这些问题呢？或许就不会那么被动了！</strong></p>\n<p>主要有3点：</p>\n<ol>\n<li>Node.js在我们上海技术团队内部算是兴起，我们希望能承接更多的业务等去做，就如同<strong>创业</strong>一样，团队自己的技术栈在公司内部使用的多了，自然有更多资源招兵买马为以后大前端、BFF层搭建做准备。可以理解为创业公司不断的做业务拉投资，我相信在很多大点的公司，很多小团队都会有这种创业的感觉</li>\n<li>每个公司所使用的某个技术栈都有自己的定位，我们也在不同领域做尝试，有倾向业务的、有做基础设施搭建的等，也在寻找Node.js适合当前公司的定位</li>\n<li>经验还是缺乏点，当时运维已经有了相关对Docker的系统监控，加上<code>Cat</code>业务监控感觉能抵挡一段时间，但是万万没想到就是缺少CPU的火焰图和内存堆栈图信息导致排查问题困难重重</li>\n</ol>\n<p><br></p>\n<h3 id=\"Memory-Leak问题\"><a href=\"#Memory-Leak问题\" class=\"headerlink\" title=\"Memory Leak问题\"></a>Memory Leak问题</h3><p>前后经历了2次较大的内存泄露问题</p>\n<p><strong>陌生类库：</strong> 其实也是知道要谨慎选择类库的使用，但有时候又该怎么说呢…</p>\n<p><strong>Vue SSR：</strong> 这个问题是书写Vue相关代码时候没注意导致的，其作者在Github上也留言指出了相关的<a href=\"https://github.com/vuejs/vue/issues/5089\" target=\"_blank\" rel=\"noopener\">解决方法</a></p>\n<p><img src=\"/images/summary-2019/2.jpg\" alt=\"https://github.com/vuejs/vue/issues/5089\"></p>\n<p><strong>目前组内对前端或者Node.js的监控体系在逐步搭建和迭代的过程中，一个监控Hub，通过TCP通信将所有的Node.js进程与其进行长连接，实时双向传输数据，按照命令生成火焰图或者内存堆栈信息。</strong></p>\n<p><br></p>\n<h3 id=\"优化了静态资源打包和分发流程\"><a href=\"#优化了静态资源打包和分发流程\" class=\"headerlink\" title=\"优化了静态资源打包和分发流程\"></a>优化了静态资源打包和分发流程</h3><p>打包这个东西自然还是基于<code>Webpack</code>的封装，谁让人家NB呢。整体流程之前比较复杂，做了一次重CI的优化，也适合目前的小型团队使用，从中抽取了一套插件式的程序加载流程，整体思想还是抄的<code>Egg.js</code>，谁让人家好用好扩展呢！</p>\n<p><strong>为什么不完全基于Egg.js的插件开发方式？</strong></p>\n<p>团队对底层架构级的东西不能完全基于Egg.js，会有更多多元化的框架引入（看具体场景，尽量少，但万一呢），通过适配层就能让底层代码依附到不同框架上。所以我既不能依附Webpack写太多插件，也不能依附其它的Node.js应用框架，毕竟Node.js五花八门、百家争鸣，我们想办法把他们粘合在一起就好，所以需要一套自己的加载器。</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"从2019迈向2020\"><a href=\"#从2019迈向2020\" class=\"headerlink\" title=\"从2019迈向2020\"></a>从2019迈向2020</h2><p>2019年对我而言确实又坏又好，坏的是工作上的问题一个个来，万幸的是都一个个解决和迭代中了，确实经历多了，学到的东西和成长也就多了。期望2020能把一直想做的BFF层可以慢慢做起来，另外监控等小项目能有机会开源。</p>\n","site":{"data":{}},"_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"<blockquote>\n<p>It was the best of times, it was the worst of times.</p>\n</blockquote>\n<p>如果真要用一句话形容2019年工作的话，上述的<strong>双城记</strong>节选我觉得是极好。大概2018年尾的时候，公司的前端团队开始用Node.js做些后端业务等相关的工作并积累经验，与现有的Java基础架构做融合，微服务<a href=\"https://github.com/Netflix/eureka\" target=\"_blank\" rel=\"noopener\">Eureka</a>、分布式协调服务<a href=\"https://zookeeper.apache.org/\" target=\"_blank\" rel=\"noopener\">ZooKeeper</a>、分布式配置管理平台<a href=\"https://disconf.readthedocs.io/zh_CN/latest/\" target=\"_blank\" rel=\"noopener\">Discon</a>、应用监控<a href=\"https://github.com/dianping/cat\" target=\"_blank\" rel=\"noopener\">Cat</a>、消息列队<a href=\"https://rocketmq.apache.org/\" target=\"_blank\" rel=\"noopener\">RocketMQ</a>、分布式署存储服务<a href=\"https://github.com/chrislusf/seaweedfs\" target=\"_blank\" rel=\"noopener\">SeaweedFS</a>、数据库<a href=\"https://www.mysql.com/cn/\" target=\"_blank\" rel=\"noopener\">MySQL</a>等等，大量的知识扑面而来。幸好之前有.NET C# + Javascript做Web开发经历，加上一些Node.js开发经验，比如<a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\">爱眠物</a>等等，上手掌握并不难。基本上每天都有很多东西可以学，上半年忙着产出业务，也忙着封装一些基于<code>Egg.js</code>适合公司项目的基础代码。不过问题也是频发，上面提到的很多东西并非是Node.js生态圈大量使用的，引用一些冷门的第三个类库暴露出了EventLoop被卡住、Memory Leak的情况，下半年忙着优化和排查。</p>","more":"<p><br></p>\n<h3 id=\"EventLoop问题\"><a href=\"#EventLoop问题\" class=\"headerlink\" title=\"EventLoop问题\"></a>EventLoop问题</h3><p>我们的Node.js程序发布到测试或者生产，经常服务端出现大量TCP <code>Close Wait</code>的情况，从TCP的信息反馈把重点都放在了网络层面，因为大量Close Wait导致服务无法响应新的请求，以为是上下游网络的超时时间问题，但是无论如何通过Node.js的Javascript层面做实验都未能出现，后来又查系统级别的配置问题等等，都是没查出一个所以然。</p>\n<p><strong>我之前写的各种Node.js服务都跑的好好的，为什么现在这家公司会出现卡死的问题呢？难道把锅甩给系统环境？</strong></p>\n<p>困惑和压力倍增，毕竟项目已经上生产了，金融服务出一点问题都是头大的事情。后来用<code>alinode</code>做监控，可惜我们的节点都在国外，而免费版本对国外节点并不友好，总是会断了监控数据。无奈只能麻烦运维同事帮忙去Docker上生成发生问题时候的<code>火焰图</code>，发现是<code>Cat</code>导致的，底层的C++代码阻碍了EventLoop的正常运行，把整个Node.js进程给卡死了。<br><img src=\"/images/summary-2019/1.png\" alt=\"catMessageSenderFun方法几乎占据了一整行\"></p>\n<p>或许你会问，<strong>为什么不早点搭建有效的监控系统去排查这些问题呢？或许就不会那么被动了！</strong></p>\n<p>主要有3点：</p>\n<ol>\n<li>Node.js在我们上海技术团队内部算是兴起，我们希望能承接更多的业务等去做，就如同<strong>创业</strong>一样，团队自己的技术栈在公司内部使用的多了，自然有更多资源招兵买马为以后大前端、BFF层搭建做准备。可以理解为创业公司不断的做业务拉投资，我相信在很多大点的公司，很多小团队都会有这种创业的感觉</li>\n<li>每个公司所使用的某个技术栈都有自己的定位，我们也在不同领域做尝试，有倾向业务的、有做基础设施搭建的等，也在寻找Node.js适合当前公司的定位</li>\n<li>经验还是缺乏点，当时运维已经有了相关对Docker的系统监控，加上<code>Cat</code>业务监控感觉能抵挡一段时间，但是万万没想到就是缺少CPU的火焰图和内存堆栈图信息导致排查问题困难重重</li>\n</ol>\n<p><br></p>\n<h3 id=\"Memory-Leak问题\"><a href=\"#Memory-Leak问题\" class=\"headerlink\" title=\"Memory Leak问题\"></a>Memory Leak问题</h3><p>前后经历了2次较大的内存泄露问题</p>\n<p><strong>陌生类库：</strong> 其实也是知道要谨慎选择类库的使用，但有时候又该怎么说呢…</p>\n<p><strong>Vue SSR：</strong> 这个问题是书写Vue相关代码时候没注意导致的，其作者在Github上也留言指出了相关的<a href=\"https://github.com/vuejs/vue/issues/5089\" target=\"_blank\" rel=\"noopener\">解决方法</a></p>\n<p><img src=\"/images/summary-2019/2.jpg\" alt=\"https://github.com/vuejs/vue/issues/5089\"></p>\n<p><strong>目前组内对前端或者Node.js的监控体系在逐步搭建和迭代的过程中，一个监控Hub，通过TCP通信将所有的Node.js进程与其进行长连接，实时双向传输数据，按照命令生成火焰图或者内存堆栈信息。</strong></p>\n<p><br></p>\n<h3 id=\"优化了静态资源打包和分发流程\"><a href=\"#优化了静态资源打包和分发流程\" class=\"headerlink\" title=\"优化了静态资源打包和分发流程\"></a>优化了静态资源打包和分发流程</h3><p>打包这个东西自然还是基于<code>Webpack</code>的封装，谁让人家NB呢。整体流程之前比较复杂，做了一次重CI的优化，也适合目前的小型团队使用，从中抽取了一套插件式的程序加载流程，整体思想还是抄的<code>Egg.js</code>，谁让人家好用好扩展呢！</p>\n<p><strong>为什么不完全基于Egg.js的插件开发方式？</strong></p>\n<p>团队对底层架构级的东西不能完全基于Egg.js，会有更多多元化的框架引入（看具体场景，尽量少，但万一呢），通过适配层就能让底层代码依附到不同框架上。所以我既不能依附Webpack写太多插件，也不能依附其它的Node.js应用框架，毕竟Node.js五花八门、百家争鸣，我们想办法把他们粘合在一起就好，所以需要一套自己的加载器。</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"从2019迈向2020\"><a href=\"#从2019迈向2020\" class=\"headerlink\" title=\"从2019迈向2020\"></a>从2019迈向2020</h2><p>2019年对我而言确实又坏又好，坏的是工作上的问题一个个来，万幸的是都一个个解决和迭代中了，确实经历多了，学到的东西和成长也就多了。期望2020能把一直想做的BFF层可以慢慢做起来，另外监控等小项目能有机会开源。</p>"},{"title":"一家公司的好坏，先看HR部门","date":"2018-07-20T09:01:34.000Z","_content":"**面对茫茫的公司，如何去判断一家公司是否靠谱呢？**\n\n除非你关注一家公司很久了或有内线，不然光从面试过程中你真的很难说这家公司好与坏。我会比较看重HR部门，为什么？\n\n1.我老婆就是资深HR，深知这个部门的重要性，和被忽视性。\n\n2.如果整个面试沟通过程中，HR部门显得很薄弱，说明该公司的组织架构不清晰，处于混沌阶段，有风险。\n\n3.如果HR部门的素质不够，那么入职了，我也觉得后续会有麻烦，比如交金、请假等等的沟通也比较头疼。\n\nHR需要情商智商双在线，如果一家公司拥有这样的HR说明它重视这个部门，为看似不赚钱的部门买了不少单，说明公司盈利或者业务稳定。就如，肚子饿了，只要能填饱肚子基本什么都会吃（精力只有在业务赚钱上），而真的去吃山珍海味说明有钱（会有精力把其它相关部门做好）。好的HR是对公司和员工的双保险！\n<!-- more -->\n**一些小经历**\n\n- 记得很多年前，手上同时拿到了盛大创新院和某社交平台的offer，该平台HR电话问我意向，我说我去创新院，她接着问我地址，我说在浦东软件园（入职的项目组正好从总部搬出来）。这HR就很嘲讽的语气说盛大在张江怎么在什么软件园呢，一顿巴拉巴拉。从此之后该社交平台我就再也不用了，确实这几年这平台不怎么样了。\n- 前几天去某中型公司（两、三百号人左右），技术上方向不太符合，HR都没把我送出门，我从很内部的会议室自己摸索着出门，从中感受出该公司的冷漠。\n- 有时候HR太高冷了，毕竟不是聊技术有话题，又是伤感情的薪酬环节，不知道怎么聊了，之前聊得再愉快到了这戛然而止。\n- 电话通知我拿到offer了，但是电话那头先把我贬下，然后提出薪资结构等等。既然我不好，为什么给我offer呢？此地无银三百两的告诉我你要我去，但要压我价嘛。其实很多时候既然能谈到这部基本双方都有意向了，薪资是一方面，还有其他，避重就轻的说点吸引人的东西，不是更好，增加砝码吗？一个HR在多次和面试者沟通后，还不知道面试者除了薪资还想要什么，那么是失败的。\n\n**面试别不耐烦，多与不同人聊是好事，也是学习**\n\n聊得人越多，你越能知道公司和团队的素质，是否和自己匹配。\n\n有些面试官做技术做产品太久了，不太和陌生人打交道，说的话、问的问题常常情商不在线，给我的感觉就是要花很长时间和团队磨合，一般自己心里会亮起警报。\n\n\n\n**总结**\n\n一场愉快的面试，是双方的尊重。面试者答应了就该准时出席，把自己所知所想告诉对方，自我的梳理和反思；面试官面了就该好好对待，可以从被面试者身上学到新的思维维度，把公司团队的产品介绍下，也算是一种推广。人与人相处，尤其是陌生人相处是需要有礼节的，你永远不知道坐在你对面的人，他背后有什么样的能量。","source":"_posts/the-quality-of-a-company-first-look-at-HR-department.md","raw":"---\ntitle: 一家公司的好坏，先看HR部门\ncategory: work\ndate: 2018-07-20 17:01:34\n---\n**面对茫茫的公司，如何去判断一家公司是否靠谱呢？**\n\n除非你关注一家公司很久了或有内线，不然光从面试过程中你真的很难说这家公司好与坏。我会比较看重HR部门，为什么？\n\n1.我老婆就是资深HR，深知这个部门的重要性，和被忽视性。\n\n2.如果整个面试沟通过程中，HR部门显得很薄弱，说明该公司的组织架构不清晰，处于混沌阶段，有风险。\n\n3.如果HR部门的素质不够，那么入职了，我也觉得后续会有麻烦，比如交金、请假等等的沟通也比较头疼。\n\nHR需要情商智商双在线，如果一家公司拥有这样的HR说明它重视这个部门，为看似不赚钱的部门买了不少单，说明公司盈利或者业务稳定。就如，肚子饿了，只要能填饱肚子基本什么都会吃（精力只有在业务赚钱上），而真的去吃山珍海味说明有钱（会有精力把其它相关部门做好）。好的HR是对公司和员工的双保险！\n<!-- more -->\n**一些小经历**\n\n- 记得很多年前，手上同时拿到了盛大创新院和某社交平台的offer，该平台HR电话问我意向，我说我去创新院，她接着问我地址，我说在浦东软件园（入职的项目组正好从总部搬出来）。这HR就很嘲讽的语气说盛大在张江怎么在什么软件园呢，一顿巴拉巴拉。从此之后该社交平台我就再也不用了，确实这几年这平台不怎么样了。\n- 前几天去某中型公司（两、三百号人左右），技术上方向不太符合，HR都没把我送出门，我从很内部的会议室自己摸索着出门，从中感受出该公司的冷漠。\n- 有时候HR太高冷了，毕竟不是聊技术有话题，又是伤感情的薪酬环节，不知道怎么聊了，之前聊得再愉快到了这戛然而止。\n- 电话通知我拿到offer了，但是电话那头先把我贬下，然后提出薪资结构等等。既然我不好，为什么给我offer呢？此地无银三百两的告诉我你要我去，但要压我价嘛。其实很多时候既然能谈到这部基本双方都有意向了，薪资是一方面，还有其他，避重就轻的说点吸引人的东西，不是更好，增加砝码吗？一个HR在多次和面试者沟通后，还不知道面试者除了薪资还想要什么，那么是失败的。\n\n**面试别不耐烦，多与不同人聊是好事，也是学习**\n\n聊得人越多，你越能知道公司和团队的素质，是否和自己匹配。\n\n有些面试官做技术做产品太久了，不太和陌生人打交道，说的话、问的问题常常情商不在线，给我的感觉就是要花很长时间和团队磨合，一般自己心里会亮起警报。\n\n\n\n**总结**\n\n一场愉快的面试，是双方的尊重。面试者答应了就该准时出席，把自己所知所想告诉对方，自我的梳理和反思；面试官面了就该好好对待，可以从被面试者身上学到新的思维维度，把公司团队的产品介绍下，也算是一种推广。人与人相处，尤其是陌生人相处是需要有礼节的，你永远不知道坐在你对面的人，他背后有什么样的能量。","slug":"the-quality-of-a-company-first-look-at-HR-department","published":1,"updated":"2020-07-07T10:11:25.589Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6k0011d12i9h6fzx8d","content":"<p><strong>面对茫茫的公司，如何去判断一家公司是否靠谱呢？</strong></p>\n<p>除非你关注一家公司很久了或有内线，不然光从面试过程中你真的很难说这家公司好与坏。我会比较看重HR部门，为什么？</p>\n<p>1.我老婆就是资深HR，深知这个部门的重要性，和被忽视性。</p>\n<p>2.如果整个面试沟通过程中，HR部门显得很薄弱，说明该公司的组织架构不清晰，处于混沌阶段，有风险。</p>\n<p>3.如果HR部门的素质不够，那么入职了，我也觉得后续会有麻烦，比如交金、请假等等的沟通也比较头疼。</p>\n<p>HR需要情商智商双在线，如果一家公司拥有这样的HR说明它重视这个部门，为看似不赚钱的部门买了不少单，说明公司盈利或者业务稳定。就如，肚子饿了，只要能填饱肚子基本什么都会吃（精力只有在业务赚钱上），而真的去吃山珍海味说明有钱（会有精力把其它相关部门做好）。好的HR是对公司和员工的双保险！<br><a id=\"more\"></a><br><strong>一些小经历</strong></p>\n<ul>\n<li>记得很多年前，手上同时拿到了盛大创新院和某社交平台的offer，该平台HR电话问我意向，我说我去创新院，她接着问我地址，我说在浦东软件园（入职的项目组正好从总部搬出来）。这HR就很嘲讽的语气说盛大在张江怎么在什么软件园呢，一顿巴拉巴拉。从此之后该社交平台我就再也不用了，确实这几年这平台不怎么样了。</li>\n<li>前几天去某中型公司（两、三百号人左右），技术上方向不太符合，HR都没把我送出门，我从很内部的会议室自己摸索着出门，从中感受出该公司的冷漠。</li>\n<li>有时候HR太高冷了，毕竟不是聊技术有话题，又是伤感情的薪酬环节，不知道怎么聊了，之前聊得再愉快到了这戛然而止。</li>\n<li>电话通知我拿到offer了，但是电话那头先把我贬下，然后提出薪资结构等等。既然我不好，为什么给我offer呢？此地无银三百两的告诉我你要我去，但要压我价嘛。其实很多时候既然能谈到这部基本双方都有意向了，薪资是一方面，还有其他，避重就轻的说点吸引人的东西，不是更好，增加砝码吗？一个HR在多次和面试者沟通后，还不知道面试者除了薪资还想要什么，那么是失败的。</li>\n</ul>\n<p><strong>面试别不耐烦，多与不同人聊是好事，也是学习</strong></p>\n<p>聊得人越多，你越能知道公司和团队的素质，是否和自己匹配。</p>\n<p>有些面试官做技术做产品太久了，不太和陌生人打交道，说的话、问的问题常常情商不在线，给我的感觉就是要花很长时间和团队磨合，一般自己心里会亮起警报。</p>\n<p><strong>总结</strong></p>\n<p>一场愉快的面试，是双方的尊重。面试者答应了就该准时出席，把自己所知所想告诉对方，自我的梳理和反思；面试官面了就该好好对待，可以从被面试者身上学到新的思维维度，把公司团队的产品介绍下，也算是一种推广。人与人相处，尤其是陌生人相处是需要有礼节的，你永远不知道坐在你对面的人，他背后有什么样的能量。</p>\n","site":{"data":{}},"_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"<p><strong>面对茫茫的公司，如何去判断一家公司是否靠谱呢？</strong></p>\n<p>除非你关注一家公司很久了或有内线，不然光从面试过程中你真的很难说这家公司好与坏。我会比较看重HR部门，为什么？</p>\n<p>1.我老婆就是资深HR，深知这个部门的重要性，和被忽视性。</p>\n<p>2.如果整个面试沟通过程中，HR部门显得很薄弱，说明该公司的组织架构不清晰，处于混沌阶段，有风险。</p>\n<p>3.如果HR部门的素质不够，那么入职了，我也觉得后续会有麻烦，比如交金、请假等等的沟通也比较头疼。</p>\n<p>HR需要情商智商双在线，如果一家公司拥有这样的HR说明它重视这个部门，为看似不赚钱的部门买了不少单，说明公司盈利或者业务稳定。就如，肚子饿了，只要能填饱肚子基本什么都会吃（精力只有在业务赚钱上），而真的去吃山珍海味说明有钱（会有精力把其它相关部门做好）。好的HR是对公司和员工的双保险！<br></p>","more":"<br><strong>一些小经历</strong></p>\n<ul>\n<li>记得很多年前，手上同时拿到了盛大创新院和某社交平台的offer，该平台HR电话问我意向，我说我去创新院，她接着问我地址，我说在浦东软件园（入职的项目组正好从总部搬出来）。这HR就很嘲讽的语气说盛大在张江怎么在什么软件园呢，一顿巴拉巴拉。从此之后该社交平台我就再也不用了，确实这几年这平台不怎么样了。</li>\n<li>前几天去某中型公司（两、三百号人左右），技术上方向不太符合，HR都没把我送出门，我从很内部的会议室自己摸索着出门，从中感受出该公司的冷漠。</li>\n<li>有时候HR太高冷了，毕竟不是聊技术有话题，又是伤感情的薪酬环节，不知道怎么聊了，之前聊得再愉快到了这戛然而止。</li>\n<li>电话通知我拿到offer了，但是电话那头先把我贬下，然后提出薪资结构等等。既然我不好，为什么给我offer呢？此地无银三百两的告诉我你要我去，但要压我价嘛。其实很多时候既然能谈到这部基本双方都有意向了，薪资是一方面，还有其他，避重就轻的说点吸引人的东西，不是更好，增加砝码吗？一个HR在多次和面试者沟通后，还不知道面试者除了薪资还想要什么，那么是失败的。</li>\n</ul>\n<p><strong>面试别不耐烦，多与不同人聊是好事，也是学习</strong></p>\n<p>聊得人越多，你越能知道公司和团队的素质，是否和自己匹配。</p>\n<p>有些面试官做技术做产品太久了，不太和陌生人打交道，说的话、问的问题常常情商不在线，给我的感觉就是要花很长时间和团队磨合，一般自己心里会亮起警报。</p>\n<p><strong>总结</strong></p>\n<p>一场愉快的面试，是双方的尊重。面试者答应了就该准时出席，把自己所知所想告诉对方，自我的梳理和反思；面试官面了就该好好对待，可以从被面试者身上学到新的思维维度，把公司团队的产品介绍下，也算是一种推广。人与人相处，尤其是陌生人相处是需要有礼节的，你永远不知道坐在你对面的人，他背后有什么样的能量。</p>"},{"title":"2019国庆一人初游舟山","date":"2019-10-05T22:11:21.849Z","_content":"\n国庆一家三口分开旅行，各有自己的目的地，我选了舟山，离开上海不远，之前从来没有去过。一人的旅行自然应该惬意为主，打着走到哪算哪的政策主张，也给自己埋下不少的坑。\n\n<!-- more -->\n\n<br/>\n\n### **#住宿**\n\n黄金周不光是游客的节日，更是商家的盛日，酒店价格也是水涨船高，本想非拖家带口的，不需要离市区多近，经济实惠就行，然后我就在`Airbnb`上选了一个好评不错的公寓酒店，宽敞、干净、便宜，一个房间可以放下1个主床、1个小床、1个写字台、1个休闲圆桌、3把椅子等，可惜卫生间和淋浴室不怎样，2夜才600不到，地方大约在下图红框内，舟山的汽车城边上。本想在客运中心附近，我自己坐大巴车来回方便，但是它并非是我下车的舟山普陀客运中心（下图右下角那个），打车过来100多:(，出租车司机都不忍心我的旅行泡汤劝我换个酒店（`扎心`）。\n\n![本想着离江海近，可以去逛逛的，最后还是没去](/images/travel-zhoushan/travel-zhoushan-01.png)\n\n从酒店出来，和店员打听哪里有夜排档之类，得到的答案是各种遥远，最后选了相对近一点的`定海海鲜夜排档`，下图位置。一路公交晃晃悠悠，从荒郊野外到市区，感受舟山。\n\n![不是吃货，选海鲜更多是来舟山的仪式感吧](/images/travel-zhoushan/travel-zhoushan-03.png)\n\n![酒店附近的公交车站牌感受下它的荒凉，当时给我一种末世的感觉](/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg)\n\n<br/>\n\n### **#吃海鲜**\n\n到了地方，一条长长的海鲜排档位于2层，看不到底。可以边吃边看江海的风景，对面是若干座小岛，突然心中涌上`江枫渔火对愁眠`的诗句，不对情不对景色，但也是唯一的瞬间感觉了。像我这样的1人“小客户”，自然不受各个小店老板们的待见，毕竟人家做的是大桌子生意，我只能在不耐烦的目光中点了3个小菜坐在了离风景最远的角落里——一个小桌子上吃起了我`海鲜大餐`。\n\n![定海海鲜夜排档](/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg)\n\n![看不到底的店铺，看不完的人群1](/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg )\n\n![吃不完的海鲜1](/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg)\n\n![吃不完的海鲜2](/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg)\n\n![江枫渔火1](/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg)\n\n<video width=\"100%\" muted controls>\n  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\">\n  Your browser does not support the video tag.\n</video>\n\n![从角落的小饭桌望出去](/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg)\n\n![我的盘中餐，蛏子和花甲，基本没沙子，蛏子其实很肥大，我没拍好](/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg)\n\n![我的盘中餐，盐爆虾，还行吧](/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg)\n\n![我的盘中餐，章鱼炒青椒，触须里囤积了很多汁水，一口下去才知道什么叫爆汁](/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg)\n\n![此情此景多少要喝点](/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg)\n\n吃完后，走了小几公里到了定海区的商业中心——`凯虹广场`，买了一包薯片回酒店，7点多就没公交回我住的穷乡僻廊，只能花了30多大洋打车回去，此刻心里就决定第二天要租一天车去`朱家尖`逛一圈。\n\n<br/>\n\n### **#朱家尖**\n\n_大阴天_\n\n有了第一天的经历，自然知道从自己住的地方到舟山另一头的朱家尖的距离有多远，不堵车估计出租车单程200大洋。中午，从定海区一路向东，第一站是南沙海滩景区，去那边的排档吃午饭，景区一个人就没进去，毕竟人山人海。因为交通管制，导致要从大青山盘山绕路，妥妥秋名山的感觉，途中拍到了不错的海滩和被云雾缭绕的大青山，值了油钱。\n\n![舟山的两端](/images/travel-zhoushan/travel-zhoushan-16.png)\n\n![租的老款马6](/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg)\n\n![海滩&大青山1](/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg)\n\n![海滩&大青山2](/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg)\n\n![海滩&大青山 拍照的大概位置](/images/travel-zhoushan/travel-zhoushan-23.png)\n\n![看不到底的店铺，看不完的人群2](/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg)\n\n![吃不完的海鲜3](/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg)\n\n![我的海鲜面 虾、隔离、🦑丝等等](/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg)\n\n吃饱开车，本想继续探索南沙海滩的，毕竟进景点海滩，一路找`野生海滩`过过瘾的，可惜人实在太多，各个主要路口交通管制，一不小心开错，感觉再绕进景区估计很久，就打算去另一个地方`月岙大沙里沙滩`（到了才发现当天没有开放，美景请自行搜索了），途中又开错了路，经过了白山景区，看到了一个画有观音像的石壁。\n\n> 白山景区系观音文化苑所在地，印象普陀剧场为朱家尖最重要的景区之一，其间一座高114.9米的干丈崖上彩绘的一尊观音大立像壁画高69米，面积达2000平方米，被誉为“海上莫高窟”。\n\n![观音像](/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg)\n\n又兜兜转转的乡间小路，来到了游客相对很少的月岙大沙里沙滩旁的一条沿海小路，很宽阔的江海外也没有什么特别的感觉吧，本想当场掉头回去，可惜车技不佳，只能一直往前开到一个相对比较宽阔的道路掉头，然后，就遇到了很有感觉的地方。\n\n![对面就是月岙大沙里沙滩了](/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg)\n\n![江海山1](/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg)\n\n![江海山2](/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg)\n\n从下面的地图你会发现，一个类似U形弯道的末尾，我把车调头，准备驶离的时候，眼前的小路和海景让我有种莫名的触景生情感，扭曲的小路如同自己的过往，很多事情曲折并不顺利，然而外面的世界又那么的壮阔美丽，想去了解想去看看想去感受，忍不住在车里听了几遍邓紫棋的`后会无期`。\n\n![小路和景色1](/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg)\n\n![小路和景色2](/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg)\n\n![小路和景色3](/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg)\n\n![小路和景色4](/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg)\n\n![小路和景色地图位置](/images/travel-zhoushan/travel-zhoushan-32.png)\n\n在夜色慢慢落下前离开了此地回到了舟山市区。第二天还了车，坐上大巴返回了上海。\n\n### **#回首**\n\n玩了3天，有坑，住的远、路不熟悉等等，正是这些才促使我看到了许多没有规划的风景，人生哪有那么多规划，学会接受和享受那些原本不属于你而又是你的风景吧。\n\n","source":"_posts/travel-zhoushan.md","raw":"---\ntitle: 2019国庆一人初游舟山\ncategory: travel\ndate: 2019-10-06T06:11:21.849Z\n---\n\n国庆一家三口分开旅行，各有自己的目的地，我选了舟山，离开上海不远，之前从来没有去过。一人的旅行自然应该惬意为主，打着走到哪算哪的政策主张，也给自己埋下不少的坑。\n\n<!-- more -->\n\n<br/>\n\n### **#住宿**\n\n黄金周不光是游客的节日，更是商家的盛日，酒店价格也是水涨船高，本想非拖家带口的，不需要离市区多近，经济实惠就行，然后我就在`Airbnb`上选了一个好评不错的公寓酒店，宽敞、干净、便宜，一个房间可以放下1个主床、1个小床、1个写字台、1个休闲圆桌、3把椅子等，可惜卫生间和淋浴室不怎样，2夜才600不到，地方大约在下图红框内，舟山的汽车城边上。本想在客运中心附近，我自己坐大巴车来回方便，但是它并非是我下车的舟山普陀客运中心（下图右下角那个），打车过来100多:(，出租车司机都不忍心我的旅行泡汤劝我换个酒店（`扎心`）。\n\n![本想着离江海近，可以去逛逛的，最后还是没去](/images/travel-zhoushan/travel-zhoushan-01.png)\n\n从酒店出来，和店员打听哪里有夜排档之类，得到的答案是各种遥远，最后选了相对近一点的`定海海鲜夜排档`，下图位置。一路公交晃晃悠悠，从荒郊野外到市区，感受舟山。\n\n![不是吃货，选海鲜更多是来舟山的仪式感吧](/images/travel-zhoushan/travel-zhoushan-03.png)\n\n![酒店附近的公交车站牌感受下它的荒凉，当时给我一种末世的感觉](/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg)\n\n<br/>\n\n### **#吃海鲜**\n\n到了地方，一条长长的海鲜排档位于2层，看不到底。可以边吃边看江海的风景，对面是若干座小岛，突然心中涌上`江枫渔火对愁眠`的诗句，不对情不对景色，但也是唯一的瞬间感觉了。像我这样的1人“小客户”，自然不受各个小店老板们的待见，毕竟人家做的是大桌子生意，我只能在不耐烦的目光中点了3个小菜坐在了离风景最远的角落里——一个小桌子上吃起了我`海鲜大餐`。\n\n![定海海鲜夜排档](/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg)\n\n![看不到底的店铺，看不完的人群1](/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg )\n\n![吃不完的海鲜1](/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg)\n\n![吃不完的海鲜2](/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg)\n\n![江枫渔火1](/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg)\n\n<video width=\"100%\" muted controls>\n  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\">\n  Your browser does not support the video tag.\n</video>\n\n![从角落的小饭桌望出去](/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg)\n\n![我的盘中餐，蛏子和花甲，基本没沙子，蛏子其实很肥大，我没拍好](/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg)\n\n![我的盘中餐，盐爆虾，还行吧](/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg)\n\n![我的盘中餐，章鱼炒青椒，触须里囤积了很多汁水，一口下去才知道什么叫爆汁](/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg)\n\n![此情此景多少要喝点](/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg)\n\n吃完后，走了小几公里到了定海区的商业中心——`凯虹广场`，买了一包薯片回酒店，7点多就没公交回我住的穷乡僻廊，只能花了30多大洋打车回去，此刻心里就决定第二天要租一天车去`朱家尖`逛一圈。\n\n<br/>\n\n### **#朱家尖**\n\n_大阴天_\n\n有了第一天的经历，自然知道从自己住的地方到舟山另一头的朱家尖的距离有多远，不堵车估计出租车单程200大洋。中午，从定海区一路向东，第一站是南沙海滩景区，去那边的排档吃午饭，景区一个人就没进去，毕竟人山人海。因为交通管制，导致要从大青山盘山绕路，妥妥秋名山的感觉，途中拍到了不错的海滩和被云雾缭绕的大青山，值了油钱。\n\n![舟山的两端](/images/travel-zhoushan/travel-zhoushan-16.png)\n\n![租的老款马6](/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg)\n\n![海滩&大青山1](/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg)\n\n![海滩&大青山2](/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg)\n\n![海滩&大青山 拍照的大概位置](/images/travel-zhoushan/travel-zhoushan-23.png)\n\n![看不到底的店铺，看不完的人群2](/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg)\n\n![吃不完的海鲜3](/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg)\n\n![我的海鲜面 虾、隔离、🦑丝等等](/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg)\n\n吃饱开车，本想继续探索南沙海滩的，毕竟进景点海滩，一路找`野生海滩`过过瘾的，可惜人实在太多，各个主要路口交通管制，一不小心开错，感觉再绕进景区估计很久，就打算去另一个地方`月岙大沙里沙滩`（到了才发现当天没有开放，美景请自行搜索了），途中又开错了路，经过了白山景区，看到了一个画有观音像的石壁。\n\n> 白山景区系观音文化苑所在地，印象普陀剧场为朱家尖最重要的景区之一，其间一座高114.9米的干丈崖上彩绘的一尊观音大立像壁画高69米，面积达2000平方米，被誉为“海上莫高窟”。\n\n![观音像](/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg)\n\n又兜兜转转的乡间小路，来到了游客相对很少的月岙大沙里沙滩旁的一条沿海小路，很宽阔的江海外也没有什么特别的感觉吧，本想当场掉头回去，可惜车技不佳，只能一直往前开到一个相对比较宽阔的道路掉头，然后，就遇到了很有感觉的地方。\n\n![对面就是月岙大沙里沙滩了](/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg)\n\n![江海山1](/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg)\n\n![江海山2](/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg)\n\n从下面的地图你会发现，一个类似U形弯道的末尾，我把车调头，准备驶离的时候，眼前的小路和海景让我有种莫名的触景生情感，扭曲的小路如同自己的过往，很多事情曲折并不顺利，然而外面的世界又那么的壮阔美丽，想去了解想去看看想去感受，忍不住在车里听了几遍邓紫棋的`后会无期`。\n\n![小路和景色1](/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg)\n\n![小路和景色2](/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg)\n\n![小路和景色3](/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg)\n\n![小路和景色4](/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg)\n\n![小路和景色地图位置](/images/travel-zhoushan/travel-zhoushan-32.png)\n\n在夜色慢慢落下前离开了此地回到了舟山市区。第二天还了车，坐上大巴返回了上海。\n\n### **#回首**\n\n玩了3天，有坑，住的远、路不熟悉等等，正是这些才促使我看到了许多没有规划的风景，人生哪有那么多规划，学会接受和享受那些原本不属于你而又是你的风景吧。\n\n","slug":"travel-zhoushan","published":1,"updated":"2020-07-07T10:11:25.589Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6n0014d12ija0axog3","content":"<p>国庆一家三口分开旅行，各有自己的目的地，我选了舟山，离开上海不远，之前从来没有去过。一人的旅行自然应该惬意为主，打着走到哪算哪的政策主张，也给自己埋下不少的坑。</p>\n<a id=\"more\"></a>\n<p><br></p>\n<h3 id=\"住宿\"><a href=\"#住宿\" class=\"headerlink\" title=\"#住宿\"></a><strong>#住宿</strong></h3><p>黄金周不光是游客的节日，更是商家的盛日，酒店价格也是水涨船高，本想非拖家带口的，不需要离市区多近，经济实惠就行，然后我就在<code>Airbnb</code>上选了一个好评不错的公寓酒店，宽敞、干净、便宜，一个房间可以放下1个主床、1个小床、1个写字台、1个休闲圆桌、3把椅子等，可惜卫生间和淋浴室不怎样，2夜才600不到，地方大约在下图红框内，舟山的汽车城边上。本想在客运中心附近，我自己坐大巴车来回方便，但是它并非是我下车的舟山普陀客运中心（下图右下角那个），打车过来100多:(，出租车司机都不忍心我的旅行泡汤劝我换个酒店（<code>扎心</code>）。</p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-01.png\" alt=\"本想着离江海近，可以去逛逛的，最后还是没去\"></p>\n<p>从酒店出来，和店员打听哪里有夜排档之类，得到的答案是各种遥远，最后选了相对近一点的<code>定海海鲜夜排档</code>，下图位置。一路公交晃晃悠悠，从荒郊野外到市区，感受舟山。</p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-03.png\" alt=\"不是吃货，选海鲜更多是来舟山的仪式感吧\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg\" alt=\"酒店附近的公交车站牌感受下它的荒凉，当时给我一种末世的感觉\"></p>\n<p><br></p>\n<h3 id=\"吃海鲜\"><a href=\"#吃海鲜\" class=\"headerlink\" title=\"#吃海鲜\"></a><strong>#吃海鲜</strong></h3><p>到了地方，一条长长的海鲜排档位于2层，看不到底。可以边吃边看江海的风景，对面是若干座小岛，突然心中涌上<code>江枫渔火对愁眠</code>的诗句，不对情不对景色，但也是唯一的瞬间感觉了。像我这样的1人“小客户”，自然不受各个小店老板们的待见，毕竟人家做的是大桌子生意，我只能在不耐烦的目光中点了3个小菜坐在了离风景最远的角落里——一个小桌子上吃起了我<code>海鲜大餐</code>。</p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg\" alt=\"定海海鲜夜排档\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg\" alt=\"看不到底的店铺，看不完的人群1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg\" alt=\"吃不完的海鲜1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg\" alt=\"吃不完的海鲜2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg\" alt=\"江枫渔火1\"></p>\n<video width=\"100%\" muted controls><br>  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\"><br>  Your browser does not support the video tag.<br></video>\n\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg\" alt=\"从角落的小饭桌望出去\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg\" alt=\"我的盘中餐，蛏子和花甲，基本没沙子，蛏子其实很肥大，我没拍好\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg\" alt=\"我的盘中餐，盐爆虾，还行吧\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg\" alt=\"我的盘中餐，章鱼炒青椒，触须里囤积了很多汁水，一口下去才知道什么叫爆汁\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg\" alt=\"此情此景多少要喝点\"></p>\n<p>吃完后，走了小几公里到了定海区的商业中心——<code>凯虹广场</code>，买了一包薯片回酒店，7点多就没公交回我住的穷乡僻廊，只能花了30多大洋打车回去，此刻心里就决定第二天要租一天车去<code>朱家尖</code>逛一圈。</p>\n<p><br></p>\n<h3 id=\"朱家尖\"><a href=\"#朱家尖\" class=\"headerlink\" title=\"#朱家尖\"></a><strong>#朱家尖</strong></h3><p><em>大阴天</em></p>\n<p>有了第一天的经历，自然知道从自己住的地方到舟山另一头的朱家尖的距离有多远，不堵车估计出租车单程200大洋。中午，从定海区一路向东，第一站是南沙海滩景区，去那边的排档吃午饭，景区一个人就没进去，毕竟人山人海。因为交通管制，导致要从大青山盘山绕路，妥妥秋名山的感觉，途中拍到了不错的海滩和被云雾缭绕的大青山，值了油钱。</p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-16.png\" alt=\"舟山的两端\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg\" alt=\"租的老款马6\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg\" alt=\"海滩&amp;大青山1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg\" alt=\"海滩&amp;大青山2\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-23.png\" alt=\"海滩&amp;大青山 拍照的大概位置\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg\" alt=\"看不到底的店铺，看不完的人群2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg\" alt=\"吃不完的海鲜3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg\" alt=\"我的海鲜面 虾、隔离、🦑丝等等\"></p>\n<p>吃饱开车，本想继续探索南沙海滩的，毕竟进景点海滩，一路找<code>野生海滩</code>过过瘾的，可惜人实在太多，各个主要路口交通管制，一不小心开错，感觉再绕进景区估计很久，就打算去另一个地方<code>月岙大沙里沙滩</code>（到了才发现当天没有开放，美景请自行搜索了），途中又开错了路，经过了白山景区，看到了一个画有观音像的石壁。</p>\n<blockquote>\n<p>白山景区系观音文化苑所在地，印象普陀剧场为朱家尖最重要的景区之一，其间一座高114.9米的干丈崖上彩绘的一尊观音大立像壁画高69米，面积达2000平方米，被誉为“海上莫高窟”。</p>\n</blockquote>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg\" alt=\"观音像\"></p>\n<p>又兜兜转转的乡间小路，来到了游客相对很少的月岙大沙里沙滩旁的一条沿海小路，很宽阔的江海外也没有什么特别的感觉吧，本想当场掉头回去，可惜车技不佳，只能一直往前开到一个相对比较宽阔的道路掉头，然后，就遇到了很有感觉的地方。</p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg\" alt=\"对面就是月岙大沙里沙滩了\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg\" alt=\"江海山1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg\" alt=\"江海山2\"></p>\n<p>从下面的地图你会发现，一个类似U形弯道的末尾，我把车调头，准备驶离的时候，眼前的小路和海景让我有种莫名的触景生情感，扭曲的小路如同自己的过往，很多事情曲折并不顺利，然而外面的世界又那么的壮阔美丽，想去了解想去看看想去感受，忍不住在车里听了几遍邓紫棋的<code>后会无期</code>。</p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg\" alt=\"小路和景色1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg\" alt=\"小路和景色2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg\" alt=\"小路和景色3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg\" alt=\"小路和景色4\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-32.png\" alt=\"小路和景色地图位置\"></p>\n<p>在夜色慢慢落下前离开了此地回到了舟山市区。第二天还了车，坐上大巴返回了上海。</p>\n<h3 id=\"回首\"><a href=\"#回首\" class=\"headerlink\" title=\"#回首\"></a><strong>#回首</strong></h3><p>玩了3天，有坑，住的远、路不熟悉等等，正是这些才促使我看到了许多没有规划的风景，人生哪有那么多规划，学会接受和享受那些原本不属于你而又是你的风景吧。</p>\n","site":{"data":{}},"_categories":[{"name":"travel","path":"categories/travel/"}],"_tags":[],"excerpt":"<p>国庆一家三口分开旅行，各有自己的目的地，我选了舟山，离开上海不远，之前从来没有去过。一人的旅行自然应该惬意为主，打着走到哪算哪的政策主张，也给自己埋下不少的坑。</p>","more":"<p><br></p>\n<h3 id=\"住宿\"><a href=\"#住宿\" class=\"headerlink\" title=\"#住宿\"></a><strong>#住宿</strong></h3><p>黄金周不光是游客的节日，更是商家的盛日，酒店价格也是水涨船高，本想非拖家带口的，不需要离市区多近，经济实惠就行，然后我就在<code>Airbnb</code>上选了一个好评不错的公寓酒店，宽敞、干净、便宜，一个房间可以放下1个主床、1个小床、1个写字台、1个休闲圆桌、3把椅子等，可惜卫生间和淋浴室不怎样，2夜才600不到，地方大约在下图红框内，舟山的汽车城边上。本想在客运中心附近，我自己坐大巴车来回方便，但是它并非是我下车的舟山普陀客运中心（下图右下角那个），打车过来100多:(，出租车司机都不忍心我的旅行泡汤劝我换个酒店（<code>扎心</code>）。</p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-01.png\" alt=\"本想着离江海近，可以去逛逛的，最后还是没去\"></p>\n<p>从酒店出来，和店员打听哪里有夜排档之类，得到的答案是各种遥远，最后选了相对近一点的<code>定海海鲜夜排档</code>，下图位置。一路公交晃晃悠悠，从荒郊野外到市区，感受舟山。</p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-03.png\" alt=\"不是吃货，选海鲜更多是来舟山的仪式感吧\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg\" alt=\"酒店附近的公交车站牌感受下它的荒凉，当时给我一种末世的感觉\"></p>\n<p><br></p>\n<h3 id=\"吃海鲜\"><a href=\"#吃海鲜\" class=\"headerlink\" title=\"#吃海鲜\"></a><strong>#吃海鲜</strong></h3><p>到了地方，一条长长的海鲜排档位于2层，看不到底。可以边吃边看江海的风景，对面是若干座小岛，突然心中涌上<code>江枫渔火对愁眠</code>的诗句，不对情不对景色，但也是唯一的瞬间感觉了。像我这样的1人“小客户”，自然不受各个小店老板们的待见，毕竟人家做的是大桌子生意，我只能在不耐烦的目光中点了3个小菜坐在了离风景最远的角落里——一个小桌子上吃起了我<code>海鲜大餐</code>。</p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg\" alt=\"定海海鲜夜排档\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg\" alt=\"看不到底的店铺，看不完的人群1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg\" alt=\"吃不完的海鲜1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg\" alt=\"吃不完的海鲜2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg\" alt=\"江枫渔火1\"></p>\n<video width=\"100%\" muted controls><br>  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\"><br>  Your browser does not support the video tag.<br></video>\n\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg\" alt=\"从角落的小饭桌望出去\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg\" alt=\"我的盘中餐，蛏子和花甲，基本没沙子，蛏子其实很肥大，我没拍好\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg\" alt=\"我的盘中餐，盐爆虾，还行吧\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg\" alt=\"我的盘中餐，章鱼炒青椒，触须里囤积了很多汁水，一口下去才知道什么叫爆汁\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg\" alt=\"此情此景多少要喝点\"></p>\n<p>吃完后，走了小几公里到了定海区的商业中心——<code>凯虹广场</code>，买了一包薯片回酒店，7点多就没公交回我住的穷乡僻廊，只能花了30多大洋打车回去，此刻心里就决定第二天要租一天车去<code>朱家尖</code>逛一圈。</p>\n<p><br></p>\n<h3 id=\"朱家尖\"><a href=\"#朱家尖\" class=\"headerlink\" title=\"#朱家尖\"></a><strong>#朱家尖</strong></h3><p><em>大阴天</em></p>\n<p>有了第一天的经历，自然知道从自己住的地方到舟山另一头的朱家尖的距离有多远，不堵车估计出租车单程200大洋。中午，从定海区一路向东，第一站是南沙海滩景区，去那边的排档吃午饭，景区一个人就没进去，毕竟人山人海。因为交通管制，导致要从大青山盘山绕路，妥妥秋名山的感觉，途中拍到了不错的海滩和被云雾缭绕的大青山，值了油钱。</p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-16.png\" alt=\"舟山的两端\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg\" alt=\"租的老款马6\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg\" alt=\"海滩&amp;大青山1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg\" alt=\"海滩&amp;大青山2\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-23.png\" alt=\"海滩&amp;大青山 拍照的大概位置\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg\" alt=\"看不到底的店铺，看不完的人群2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg\" alt=\"吃不完的海鲜3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg\" alt=\"我的海鲜面 虾、隔离、🦑丝等等\"></p>\n<p>吃饱开车，本想继续探索南沙海滩的，毕竟进景点海滩，一路找<code>野生海滩</code>过过瘾的，可惜人实在太多，各个主要路口交通管制，一不小心开错，感觉再绕进景区估计很久，就打算去另一个地方<code>月岙大沙里沙滩</code>（到了才发现当天没有开放，美景请自行搜索了），途中又开错了路，经过了白山景区，看到了一个画有观音像的石壁。</p>\n<blockquote>\n<p>白山景区系观音文化苑所在地，印象普陀剧场为朱家尖最重要的景区之一，其间一座高114.9米的干丈崖上彩绘的一尊观音大立像壁画高69米，面积达2000平方米，被誉为“海上莫高窟”。</p>\n</blockquote>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg\" alt=\"观音像\"></p>\n<p>又兜兜转转的乡间小路，来到了游客相对很少的月岙大沙里沙滩旁的一条沿海小路，很宽阔的江海外也没有什么特别的感觉吧，本想当场掉头回去，可惜车技不佳，只能一直往前开到一个相对比较宽阔的道路掉头，然后，就遇到了很有感觉的地方。</p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg\" alt=\"对面就是月岙大沙里沙滩了\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg\" alt=\"江海山1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg\" alt=\"江海山2\"></p>\n<p>从下面的地图你会发现，一个类似U形弯道的末尾，我把车调头，准备驶离的时候，眼前的小路和海景让我有种莫名的触景生情感，扭曲的小路如同自己的过往，很多事情曲折并不顺利，然而外面的世界又那么的壮阔美丽，想去了解想去看看想去感受，忍不住在车里听了几遍邓紫棋的<code>后会无期</code>。</p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg\" alt=\"小路和景色1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg\" alt=\"小路和景色2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg\" alt=\"小路和景色3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg\" alt=\"小路和景色4\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-32.png\" alt=\"小路和景色地图位置\"></p>\n<p>在夜色慢慢落下前离开了此地回到了舟山市区。第二天还了车，坐上大巴返回了上海。</p>\n<h3 id=\"回首\"><a href=\"#回首\" class=\"headerlink\" title=\"#回首\"></a><strong>#回首</strong></h3><p>玩了3天，有坑，住的远、路不熟悉等等，正是这些才促使我看到了许多没有规划的风景，人生哪有那么多规划，学会接受和享受那些原本不属于你而又是你的风景吧。</p>"},{"title":"出差菲律宾","date":"2018-09-24T06:45:00.000Z","_content":"入职没多久，因为菲律宾项目的版本更新，和一后端、一测试，三人组队前往当地打怪升级。\n\n![准备起飞](/images/traveling-to-the-philippines/1.jpg)\n\n<!-- more -->\n\n副本Loading三个半小时。\n\n![到达副本](/images/traveling-to-the-philippines/2.jpg)\n\n### 住和工\n\n到达马尼拉的时候已经快晚上9点了，下飞机弄完电话卡连上网络，急忙打车去坐落在BGC的酒店——步行离公司5MIN，一个大套房3人住，好宽敞。\n\nBGC近年来发展很快，类似上海的陆家嘴，许多大型跨国公司变迁至此（如HSBC,Google等）。\n\n第二天，准时打开上班，新装修的办公室还是给人眼前一亮，大大小小的会议室、工作间、沙发、游戏室、健身房、食品吧台、甚至还有临时休息的房间。\n\n![接下来几天躲在这会议室猥琐写代码别浪](/images/traveling-to-the-philippines/3.jpg)\n\n![蛮喜欢这灯](/images/traveling-to-the-philippines/4.jpg)\n\n![一角A](/images/traveling-to-the-philippines/7.jpg)\n\n![一角B](/images/traveling-to-the-philippines/8.jpg)\n\n![健身房](/images/traveling-to-the-philippines/6.jpg)\n\n![可以临时睡觉的地方](/images/traveling-to-the-philippines/9.jpg)\n\n### 吃\n\n菲律宾的餐饮感觉还是偏西餐的，油炸类的偏多，行程中吃的比较多；中餐的话基本是港式、台湾的为主，第一天晚上夜宵就是著名的鼎泰丰，味道不错。这边的水，大多是生水，国人也许喝不惯，一般在BGC一顿饭花费在1500Php左右，好一点的日料什么的那就更贵了。\n\n![鼎泰丰，中国风](/images/traveling-to-the-philippines/10.jpg)\n\n![厚实的汉堡A](/images/traveling-to-the-philippines/11.jpg)\n\n![厚实的汉堡B](/images/traveling-to-the-philippines/12.jpg)\n\n![厚实的汉堡C](/images/traveling-to-the-philippines/27.jpg)\n\n![油炸食品](/images/traveling-to-the-philippines/13.jpg)\n\n![网络咖啡店 「%」](/images/traveling-to-the-philippines/14.jpg)\n\n![五颜六色的水果](/images/traveling-to-the-philippines/15.jpg)\n\n![712Php 一公斤的三文鱼（人民币100不到）](/images/traveling-to-the-philippines/16.jpg)\n\n![一大袋才花了300不到Php](/images/traveling-to-the-philippines/17.jpg)\n\n因为回国航线有史诗级台风「山竹」经过，所以在菲律宾多待2天，有机会去海边逛逛随便去吃海鲜，我们去的市场感觉主要做国人生意，到处是中国人，东南亚的海鲜品种差不多，买的时候可以讨价还价。\n\n![海鲜市场](/images/traveling-to-the-philippines/19.jpg)\n\n![鱼](/images/traveling-to-the-philippines/21.jpg)\n\n![蟹，不同大小不同的价格](/images/traveling-to-the-philippines/20.jpg)\n\n![三个男的对海鲜欲望不大，最后买了它，7000+ 还价到5500 其实还是贵了 T_T](/images/traveling-to-the-philippines/22.jpg)\n\n![成品A 不好吃](/images/traveling-to-the-philippines/23.jpg)\n\n![成品B 不好吃](/images/traveling-to-the-philippines/24.jpg)\n\n![成品C 不好吃](/images/traveling-to-the-philippines/25.jpg)\n\n![星爸爸 摩卡超大杯折合人民币才23不到，好便宜](/images/traveling-to-the-philippines/26.jpg)\n\n### 行\n\n对于我们这些初来乍到的，还是出租车比较靠谱，机场出来还是黄色（貌似机场特有）的出租车比较靠谱，虽然贵但是没发生坐地起价或者绕路等问题，之前同事来坐白色出租车虽然起步便宜但是最后付钱的时候比我们贵很多。或者用Grab打车（类似滴滴打车），价格合理。\n\n![不知道是巧合还是当地出租车运行要求，灭火器放在左A柱这](/images/traveling-to-the-philippines/28.jpg)\n\n菲律宾特色*“吉普尼”*，五颜六色装饰夸张，是与黑色伦敦出租车和黄色纽约出租车齐名的交通工具，可惜没乘坐。\n\n![吉普尼A](/images/traveling-to-the-philippines/29.jpg)\n\n\n![吉普尼B](/images/traveling-to-the-philippines/30.jpg)\n\n### 周边\n\n在BGC的时候感觉道路很干净，路上没有什么垃圾，甚至找个垃圾桶都很难，常常领着一袋垃圾从A处到B处目的地才有垃圾桶扔，路上没看到有人抽烟等；去之前很担心安全问题，国内常有报道，到那里后感觉很多时候没必要过于担心。\n\n谈不上安保能力多强，平时的安检还是很多的，进大楼、酒店、商场都有安检，类似上海地铁安检吧，机器扫描或者人工打开包看，人工看的话基本都是带手套或者用一个小木棍，避免直接与物品直接接触，避免不必要的麻烦。几天下来没有谁不做检查的，不像地铁安检经常有人不愿意或者争执，其实无论在菲律宾还是国内，安检只是防君子不防小人的（和门一样），但是它也是一道保护大家的屏障，所以我们应该尊重它，而不是敌对它。\n\n![干净的街道](/images/traveling-to-the-philippines/31.jpg)\n\n![安检](/images/traveling-to-the-philippines/34.jpg)\n\n![很多大楼门口的安保都有枪](/images/traveling-to-the-philippines/33.jpeg)\n\n![不像国内ATM机，这的机器都是全露天的，没有小房间](/images/traveling-to-the-philippines/32.jpg)\n\n\n## 总结\n\n原本出差7天，后拜台风“山竹”所赐，多待了2天，得以有机会去海边或者更多地方逛逛。整体给我的感觉很不错，物价和上海总体差不多，若不是语言的不同，很多时候感觉自己是生活在魔都，当然天气也会常常提醒你:)。期待下次再去！\n\n","source":"_posts/traveling-to-the-philippines.md","raw":"---\ntitle: 出差菲律宾\ncategory: work\ndate: 2018-09-24 14:45:00\n---\n入职没多久，因为菲律宾项目的版本更新，和一后端、一测试，三人组队前往当地打怪升级。\n\n![准备起飞](/images/traveling-to-the-philippines/1.jpg)\n\n<!-- more -->\n\n副本Loading三个半小时。\n\n![到达副本](/images/traveling-to-the-philippines/2.jpg)\n\n### 住和工\n\n到达马尼拉的时候已经快晚上9点了，下飞机弄完电话卡连上网络，急忙打车去坐落在BGC的酒店——步行离公司5MIN，一个大套房3人住，好宽敞。\n\nBGC近年来发展很快，类似上海的陆家嘴，许多大型跨国公司变迁至此（如HSBC,Google等）。\n\n第二天，准时打开上班，新装修的办公室还是给人眼前一亮，大大小小的会议室、工作间、沙发、游戏室、健身房、食品吧台、甚至还有临时休息的房间。\n\n![接下来几天躲在这会议室猥琐写代码别浪](/images/traveling-to-the-philippines/3.jpg)\n\n![蛮喜欢这灯](/images/traveling-to-the-philippines/4.jpg)\n\n![一角A](/images/traveling-to-the-philippines/7.jpg)\n\n![一角B](/images/traveling-to-the-philippines/8.jpg)\n\n![健身房](/images/traveling-to-the-philippines/6.jpg)\n\n![可以临时睡觉的地方](/images/traveling-to-the-philippines/9.jpg)\n\n### 吃\n\n菲律宾的餐饮感觉还是偏西餐的，油炸类的偏多，行程中吃的比较多；中餐的话基本是港式、台湾的为主，第一天晚上夜宵就是著名的鼎泰丰，味道不错。这边的水，大多是生水，国人也许喝不惯，一般在BGC一顿饭花费在1500Php左右，好一点的日料什么的那就更贵了。\n\n![鼎泰丰，中国风](/images/traveling-to-the-philippines/10.jpg)\n\n![厚实的汉堡A](/images/traveling-to-the-philippines/11.jpg)\n\n![厚实的汉堡B](/images/traveling-to-the-philippines/12.jpg)\n\n![厚实的汉堡C](/images/traveling-to-the-philippines/27.jpg)\n\n![油炸食品](/images/traveling-to-the-philippines/13.jpg)\n\n![网络咖啡店 「%」](/images/traveling-to-the-philippines/14.jpg)\n\n![五颜六色的水果](/images/traveling-to-the-philippines/15.jpg)\n\n![712Php 一公斤的三文鱼（人民币100不到）](/images/traveling-to-the-philippines/16.jpg)\n\n![一大袋才花了300不到Php](/images/traveling-to-the-philippines/17.jpg)\n\n因为回国航线有史诗级台风「山竹」经过，所以在菲律宾多待2天，有机会去海边逛逛随便去吃海鲜，我们去的市场感觉主要做国人生意，到处是中国人，东南亚的海鲜品种差不多，买的时候可以讨价还价。\n\n![海鲜市场](/images/traveling-to-the-philippines/19.jpg)\n\n![鱼](/images/traveling-to-the-philippines/21.jpg)\n\n![蟹，不同大小不同的价格](/images/traveling-to-the-philippines/20.jpg)\n\n![三个男的对海鲜欲望不大，最后买了它，7000+ 还价到5500 其实还是贵了 T_T](/images/traveling-to-the-philippines/22.jpg)\n\n![成品A 不好吃](/images/traveling-to-the-philippines/23.jpg)\n\n![成品B 不好吃](/images/traveling-to-the-philippines/24.jpg)\n\n![成品C 不好吃](/images/traveling-to-the-philippines/25.jpg)\n\n![星爸爸 摩卡超大杯折合人民币才23不到，好便宜](/images/traveling-to-the-philippines/26.jpg)\n\n### 行\n\n对于我们这些初来乍到的，还是出租车比较靠谱，机场出来还是黄色（貌似机场特有）的出租车比较靠谱，虽然贵但是没发生坐地起价或者绕路等问题，之前同事来坐白色出租车虽然起步便宜但是最后付钱的时候比我们贵很多。或者用Grab打车（类似滴滴打车），价格合理。\n\n![不知道是巧合还是当地出租车运行要求，灭火器放在左A柱这](/images/traveling-to-the-philippines/28.jpg)\n\n菲律宾特色*“吉普尼”*，五颜六色装饰夸张，是与黑色伦敦出租车和黄色纽约出租车齐名的交通工具，可惜没乘坐。\n\n![吉普尼A](/images/traveling-to-the-philippines/29.jpg)\n\n\n![吉普尼B](/images/traveling-to-the-philippines/30.jpg)\n\n### 周边\n\n在BGC的时候感觉道路很干净，路上没有什么垃圾，甚至找个垃圾桶都很难，常常领着一袋垃圾从A处到B处目的地才有垃圾桶扔，路上没看到有人抽烟等；去之前很担心安全问题，国内常有报道，到那里后感觉很多时候没必要过于担心。\n\n谈不上安保能力多强，平时的安检还是很多的，进大楼、酒店、商场都有安检，类似上海地铁安检吧，机器扫描或者人工打开包看，人工看的话基本都是带手套或者用一个小木棍，避免直接与物品直接接触，避免不必要的麻烦。几天下来没有谁不做检查的，不像地铁安检经常有人不愿意或者争执，其实无论在菲律宾还是国内，安检只是防君子不防小人的（和门一样），但是它也是一道保护大家的屏障，所以我们应该尊重它，而不是敌对它。\n\n![干净的街道](/images/traveling-to-the-philippines/31.jpg)\n\n![安检](/images/traveling-to-the-philippines/34.jpg)\n\n![很多大楼门口的安保都有枪](/images/traveling-to-the-philippines/33.jpeg)\n\n![不像国内ATM机，这的机器都是全露天的，没有小房间](/images/traveling-to-the-philippines/32.jpg)\n\n\n## 总结\n\n原本出差7天，后拜台风“山竹”所赐，多待了2天，得以有机会去海边或者更多地方逛逛。整体给我的感觉很不错，物价和上海总体差不多，若不是语言的不同，很多时候感觉自己是生活在魔都，当然天气也会常常提醒你:)。期待下次再去！\n\n","slug":"traveling-to-the-philippines","published":1,"updated":"2020-07-07T10:11:25.590Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6p0018d12ibydk0jqe","content":"<p>入职没多久，因为菲律宾项目的版本更新，和一后端、一测试，三人组队前往当地打怪升级。</p>\n<p><img src=\"/images/traveling-to-the-philippines/1.jpg\" alt=\"准备起飞\"></p>\n<a id=\"more\"></a>\n<p>副本Loading三个半小时。</p>\n<p><img src=\"/images/traveling-to-the-philippines/2.jpg\" alt=\"到达副本\"></p>\n<h3 id=\"住和工\"><a href=\"#住和工\" class=\"headerlink\" title=\"住和工\"></a>住和工</h3><p>到达马尼拉的时候已经快晚上9点了，下飞机弄完电话卡连上网络，急忙打车去坐落在BGC的酒店——步行离公司5MIN，一个大套房3人住，好宽敞。</p>\n<p>BGC近年来发展很快，类似上海的陆家嘴，许多大型跨国公司变迁至此（如HSBC,Google等）。</p>\n<p>第二天，准时打开上班，新装修的办公室还是给人眼前一亮，大大小小的会议室、工作间、沙发、游戏室、健身房、食品吧台、甚至还有临时休息的房间。</p>\n<p><img src=\"/images/traveling-to-the-philippines/3.jpg\" alt=\"接下来几天躲在这会议室猥琐写代码别浪\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/4.jpg\" alt=\"蛮喜欢这灯\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/7.jpg\" alt=\"一角A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/8.jpg\" alt=\"一角B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/6.jpg\" alt=\"健身房\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/9.jpg\" alt=\"可以临时睡觉的地方\"></p>\n<h3 id=\"吃\"><a href=\"#吃\" class=\"headerlink\" title=\"吃\"></a>吃</h3><p>菲律宾的餐饮感觉还是偏西餐的，油炸类的偏多，行程中吃的比较多；中餐的话基本是港式、台湾的为主，第一天晚上夜宵就是著名的鼎泰丰，味道不错。这边的水，大多是生水，国人也许喝不惯，一般在BGC一顿饭花费在1500Php左右，好一点的日料什么的那就更贵了。</p>\n<p><img src=\"/images/traveling-to-the-philippines/10.jpg\" alt=\"鼎泰丰，中国风\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/11.jpg\" alt=\"厚实的汉堡A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/12.jpg\" alt=\"厚实的汉堡B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/27.jpg\" alt=\"厚实的汉堡C\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/13.jpg\" alt=\"油炸食品\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/14.jpg\" alt=\"网络咖啡店 「%」\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/15.jpg\" alt=\"五颜六色的水果\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/16.jpg\" alt=\"712Php 一公斤的三文鱼（人民币100不到）\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/17.jpg\" alt=\"一大袋才花了300不到Php\"></p>\n<p>因为回国航线有史诗级台风「山竹」经过，所以在菲律宾多待2天，有机会去海边逛逛随便去吃海鲜，我们去的市场感觉主要做国人生意，到处是中国人，东南亚的海鲜品种差不多，买的时候可以讨价还价。</p>\n<p><img src=\"/images/traveling-to-the-philippines/19.jpg\" alt=\"海鲜市场\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/21.jpg\" alt=\"鱼\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/20.jpg\" alt=\"蟹，不同大小不同的价格\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/22.jpg\" alt=\"三个男的对海鲜欲望不大，最后买了它，7000+ 还价到5500 其实还是贵了 T_T\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/23.jpg\" alt=\"成品A 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/24.jpg\" alt=\"成品B 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/25.jpg\" alt=\"成品C 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/26.jpg\" alt=\"星爸爸 摩卡超大杯折合人民币才23不到，好便宜\"></p>\n<h3 id=\"行\"><a href=\"#行\" class=\"headerlink\" title=\"行\"></a>行</h3><p>对于我们这些初来乍到的，还是出租车比较靠谱，机场出来还是黄色（貌似机场特有）的出租车比较靠谱，虽然贵但是没发生坐地起价或者绕路等问题，之前同事来坐白色出租车虽然起步便宜但是最后付钱的时候比我们贵很多。或者用Grab打车（类似滴滴打车），价格合理。</p>\n<p><img src=\"/images/traveling-to-the-philippines/28.jpg\" alt=\"不知道是巧合还是当地出租车运行要求，灭火器放在左A柱这\"></p>\n<p>菲律宾特色<em>“吉普尼”</em>，五颜六色装饰夸张，是与黑色伦敦出租车和黄色纽约出租车齐名的交通工具，可惜没乘坐。</p>\n<p><img src=\"/images/traveling-to-the-philippines/29.jpg\" alt=\"吉普尼A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/30.jpg\" alt=\"吉普尼B\"></p>\n<h3 id=\"周边\"><a href=\"#周边\" class=\"headerlink\" title=\"周边\"></a>周边</h3><p>在BGC的时候感觉道路很干净，路上没有什么垃圾，甚至找个垃圾桶都很难，常常领着一袋垃圾从A处到B处目的地才有垃圾桶扔，路上没看到有人抽烟等；去之前很担心安全问题，国内常有报道，到那里后感觉很多时候没必要过于担心。</p>\n<p>谈不上安保能力多强，平时的安检还是很多的，进大楼、酒店、商场都有安检，类似上海地铁安检吧，机器扫描或者人工打开包看，人工看的话基本都是带手套或者用一个小木棍，避免直接与物品直接接触，避免不必要的麻烦。几天下来没有谁不做检查的，不像地铁安检经常有人不愿意或者争执，其实无论在菲律宾还是国内，安检只是防君子不防小人的（和门一样），但是它也是一道保护大家的屏障，所以我们应该尊重它，而不是敌对它。</p>\n<p><img src=\"/images/traveling-to-the-philippines/31.jpg\" alt=\"干净的街道\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/34.jpg\" alt=\"安检\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/33.jpeg\" alt=\"很多大楼门口的安保都有枪\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/32.jpg\" alt=\"不像国内ATM机，这的机器都是全露天的，没有小房间\"></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>原本出差7天，后拜台风“山竹”所赐，多待了2天，得以有机会去海边或者更多地方逛逛。整体给我的感觉很不错，物价和上海总体差不多，若不是语言的不同，很多时候感觉自己是生活在魔都，当然天气也会常常提醒你:)。期待下次再去！</p>\n","site":{"data":{}},"_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"<p>入职没多久，因为菲律宾项目的版本更新，和一后端、一测试，三人组队前往当地打怪升级。</p>\n<p><img src=\"/images/traveling-to-the-philippines/1.jpg\" alt=\"准备起飞\"></p>","more":"<p>副本Loading三个半小时。</p>\n<p><img src=\"/images/traveling-to-the-philippines/2.jpg\" alt=\"到达副本\"></p>\n<h3 id=\"住和工\"><a href=\"#住和工\" class=\"headerlink\" title=\"住和工\"></a>住和工</h3><p>到达马尼拉的时候已经快晚上9点了，下飞机弄完电话卡连上网络，急忙打车去坐落在BGC的酒店——步行离公司5MIN，一个大套房3人住，好宽敞。</p>\n<p>BGC近年来发展很快，类似上海的陆家嘴，许多大型跨国公司变迁至此（如HSBC,Google等）。</p>\n<p>第二天，准时打开上班，新装修的办公室还是给人眼前一亮，大大小小的会议室、工作间、沙发、游戏室、健身房、食品吧台、甚至还有临时休息的房间。</p>\n<p><img src=\"/images/traveling-to-the-philippines/3.jpg\" alt=\"接下来几天躲在这会议室猥琐写代码别浪\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/4.jpg\" alt=\"蛮喜欢这灯\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/7.jpg\" alt=\"一角A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/8.jpg\" alt=\"一角B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/6.jpg\" alt=\"健身房\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/9.jpg\" alt=\"可以临时睡觉的地方\"></p>\n<h3 id=\"吃\"><a href=\"#吃\" class=\"headerlink\" title=\"吃\"></a>吃</h3><p>菲律宾的餐饮感觉还是偏西餐的，油炸类的偏多，行程中吃的比较多；中餐的话基本是港式、台湾的为主，第一天晚上夜宵就是著名的鼎泰丰，味道不错。这边的水，大多是生水，国人也许喝不惯，一般在BGC一顿饭花费在1500Php左右，好一点的日料什么的那就更贵了。</p>\n<p><img src=\"/images/traveling-to-the-philippines/10.jpg\" alt=\"鼎泰丰，中国风\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/11.jpg\" alt=\"厚实的汉堡A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/12.jpg\" alt=\"厚实的汉堡B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/27.jpg\" alt=\"厚实的汉堡C\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/13.jpg\" alt=\"油炸食品\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/14.jpg\" alt=\"网络咖啡店 「%」\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/15.jpg\" alt=\"五颜六色的水果\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/16.jpg\" alt=\"712Php 一公斤的三文鱼（人民币100不到）\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/17.jpg\" alt=\"一大袋才花了300不到Php\"></p>\n<p>因为回国航线有史诗级台风「山竹」经过，所以在菲律宾多待2天，有机会去海边逛逛随便去吃海鲜，我们去的市场感觉主要做国人生意，到处是中国人，东南亚的海鲜品种差不多，买的时候可以讨价还价。</p>\n<p><img src=\"/images/traveling-to-the-philippines/19.jpg\" alt=\"海鲜市场\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/21.jpg\" alt=\"鱼\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/20.jpg\" alt=\"蟹，不同大小不同的价格\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/22.jpg\" alt=\"三个男的对海鲜欲望不大，最后买了它，7000+ 还价到5500 其实还是贵了 T_T\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/23.jpg\" alt=\"成品A 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/24.jpg\" alt=\"成品B 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/25.jpg\" alt=\"成品C 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/26.jpg\" alt=\"星爸爸 摩卡超大杯折合人民币才23不到，好便宜\"></p>\n<h3 id=\"行\"><a href=\"#行\" class=\"headerlink\" title=\"行\"></a>行</h3><p>对于我们这些初来乍到的，还是出租车比较靠谱，机场出来还是黄色（貌似机场特有）的出租车比较靠谱，虽然贵但是没发生坐地起价或者绕路等问题，之前同事来坐白色出租车虽然起步便宜但是最后付钱的时候比我们贵很多。或者用Grab打车（类似滴滴打车），价格合理。</p>\n<p><img src=\"/images/traveling-to-the-philippines/28.jpg\" alt=\"不知道是巧合还是当地出租车运行要求，灭火器放在左A柱这\"></p>\n<p>菲律宾特色<em>“吉普尼”</em>，五颜六色装饰夸张，是与黑色伦敦出租车和黄色纽约出租车齐名的交通工具，可惜没乘坐。</p>\n<p><img src=\"/images/traveling-to-the-philippines/29.jpg\" alt=\"吉普尼A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/30.jpg\" alt=\"吉普尼B\"></p>\n<h3 id=\"周边\"><a href=\"#周边\" class=\"headerlink\" title=\"周边\"></a>周边</h3><p>在BGC的时候感觉道路很干净，路上没有什么垃圾，甚至找个垃圾桶都很难，常常领着一袋垃圾从A处到B处目的地才有垃圾桶扔，路上没看到有人抽烟等；去之前很担心安全问题，国内常有报道，到那里后感觉很多时候没必要过于担心。</p>\n<p>谈不上安保能力多强，平时的安检还是很多的，进大楼、酒店、商场都有安检，类似上海地铁安检吧，机器扫描或者人工打开包看，人工看的话基本都是带手套或者用一个小木棍，避免直接与物品直接接触，避免不必要的麻烦。几天下来没有谁不做检查的，不像地铁安检经常有人不愿意或者争执，其实无论在菲律宾还是国内，安检只是防君子不防小人的（和门一样），但是它也是一道保护大家的屏障，所以我们应该尊重它，而不是敌对它。</p>\n<p><img src=\"/images/traveling-to-the-philippines/31.jpg\" alt=\"干净的街道\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/34.jpg\" alt=\"安检\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/33.jpeg\" alt=\"很多大楼门口的安保都有枪\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/32.jpg\" alt=\"不像国内ATM机，这的机器都是全露天的，没有小房间\"></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>原本出差7天，后拜台风“山竹”所赐，多待了2天，得以有机会去海边或者更多地方逛逛。整体给我的感觉很不错，物价和上海总体差不多，若不是语言的不同，很多时候感觉自己是生活在魔都，当然天气也会常常提醒你:)。期待下次再去！</p>"},{"title":"Egg Cluster 简单介绍","keywords":"进程管理,Eggjs启动,Egg Cluster","description":"Egg.js的进程管理和通信自然不会像文章里说的那么简单，但大体如此。弄清楚它们的工作原理对开发程序、插件、中间件有很大的帮助，个人认为这个才是这个框架的精髓之处。","date":"2019-01-18T05:48:01.464Z","_content":"\n如果不清楚什么是Egg.js，希望能移步到它的[官网](https://eggjs.org)简单看下。另外说它是__约定大于配置__的话，我只能说你真的不了解它，或者说不了解框架，哪个框架没有约定？毕竟没有规矩不成方圆，何况是逻辑性的程序呢？官方列出的特性如下：\n\n> 1.提供基于 Egg [定制上层框架](https://eggjs.org/zh-cn/advanced/framework.html) 的能力\n> 2.高度可扩展的[插件机制](https://eggjs.org/zh-cn/basics/plugin.html)\n> 3.内置[多进程管理](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n> 4.基于 [Koa](http://koajs.com/) 开发，性能优异\n> 5.框架稳定，测试覆盖率高\n> 6.[渐进式开发](https://eggjs.org/zh-cn/tutorials/progressive.html)\n\n第1条，它有那么Koa也有啊。第2条，它有，难道Koa、Express等就没有嘛？第4条，更好的补充了Koa不是更好吗？第5条，难道别的框架就不稳定了？第6条，前端鼓吹渐进式、后端也鼓吹，那究竟什么是渐进式呢？\n\n在我看来最吸引我的是第3条，__内置多进程管理__，这个在其它主流nodejs框架中是稀缺的特性，此文就简单聊聊它。\n\n<!-- more -->\n\n\n\n### __#从源码慢慢了解__\n\n- __egg-core__: 定义了一个__EggCore__类，它继承KoaApplication，也就是特性中提到的第4条 *基于Koa开发，性能优异*\n- __egg__: 定义了一个继承于EggCore的__EggApplication__类，并且Application和Agent分别继承于EggApplication\n- __egg-cluster__: 这个类库主要就是做__多进程管理__的工作\n\n*egg-cluster让Egg.js变得与众不同*，看看它做了什么。\n\n### egg-cluster\n\n```js\n// egg-cluster index.js 唯一对外暴露的接口 startCluster\nexports.startCluster = function (options, callback) {\n    new Master(options).ready(callback)\n}\n```\n\negg-cluster就是靠Master在管理egg里面的angent和workers（application）,另外它也是它们之间通信的中转站，看下官网给出的图解：\n![Master-Agent-Works 模型](/images/egg-cluster/1.jpg)\n\n### Agent-Works怎么启动的？\n```js\nclass Master extends EventEmitter {\n    constructor(options) {\n        this.workerManager = new Manager();\n    \tthis.messenger = new Messenger(this);\n        // ...\n\t\tthis.once('agent-start', this.forkAppWorkers.bind(this));\n        // ...\n        detectPort((err, port) => {\n            // 试着找个可以用的port\n            this.options.clusterPort = port;\n            // 启动 agent\n            this.forkAgentWorker();\n        });\n        // ...\n    }\n    forkAgentWorker() {\n        // ... childprocess.fork egg-cluster/lib/agent_worker.js\n        const agentWorker = childprocess.fork(this.getAgentWorkerFile(), args, opt);\n        // ...\n    }\n    forkAppWorkers() {\n        // 将需要数量的 worker 一个个创建出来\n        // cluster.fork egg-cluster/lib/agent_worker.js 它们将监听同一个服务端口\n        // 创建 http或https服务\n    }\n}\n```\n\nagent_worker.js主要逻辑就是创建egg类库里的Agent类，完成后发\"agent-start\"给父进程，触发Master的订阅创建Workers\n\n```js\n// egg-cluster/lib/agent_worker.js\n// ...\nprocess.send({ action: 'agent-start', to: 'master' }); \n// ...\n```\n\n### Agent-Works怎么通信呢? ([IPC](https://eggjs.org/zh-cn/core/cluster-and-ipc.html))\n\n- 在Master中维护着一个Messenger（egg-cluster/lib/utils/messenger.js）实例\n- EggApplication中维护了另一个Messenger（egg/lib/core/messenger.js）实例\n\n由于Agent和Worker(Application)都继承EggApplication，它们调用Messenger的时候会send到创建它们的Master里，然后Master再根据传过来的参数send给不同的Agent或Worker，Master里的转发逻辑如下。\n\n```js\n// egg-cluster master.js\nclass Master extends EventEmitter {\n    forkAppWorkers() {\n        // ...\n        cluster.on('fork', worker => {\n            // ...\n            worker.on('message', msg => {\n            \tif (typeof msg === 'string') msg = { action: msg, data: msg };\n\t            msg.from = 'app';\n    \t        this.messenger.send(msg);\n            });\n            // ...\n        })\n    }\n    forkAgentWorker() {\n        // ...\n        agentWorker.on('message', msg => {\n          if (typeof msg === 'string') msg = { action: msg, data: msg };\n          msg.from = 'agent';\n          this.messenger.send(msg);\n        });\n        // ...\n    }\n}\n```\n\n```js\n// egg messenger.js\nclass Messenger extends EventEmitter {\n    send(action, data, to) {\n        sendmessage(process, {\n          action,\n          data,\n          to,\n        });\n        return this;\n     }\n}\n```\n\n一条信息必定有__from__...__to__...信息\n\n![Master-Agent-Works 通信模型](/images/egg-cluster/2.jpg)\n\n### 官网里提到的“[多进程研发模式增强](https://eggjs.org/zh-cn/advanced/cluster-client.html)”\n\n![一个程序运行n个worker连m个远程服务](/images/egg-cluster/3.jpg)\n\n- n * m 个连接导致大量连接资源“浪费”\n- 减少Master转发带来的额外性能消耗\n- 另外，egg的作者们担心不当的IPC通信把Master搞挂，从而整个服务异常\n\n所以还有一种socket通信方式（使用了另一个库[cluster-client](https://github.com/node-modules/cluster-client)）：\n\n- 将Agent作为Leader，从服务端获取数据，并做缓存\n- 将Worker作为Follower，订阅Agent获取的数据\n\n典型的场景有，Leader（Agent）获取disconf里的配置、获取euerka里的服务等，Follower（Worker）使用这些配置和服务。\n\n![socket通信](/images/egg-cluster/4.jpg)\n\n### cluster-client 源码一瞥\n\n```js\nclass ClusterClient extends Base {\n    // ...\n    async [init]() {\n        const name = this.options.name;\n        const port = this.options.port;\n        let server;\n        if (this.options.isLeader === true) {\n          server = await ClusterServer.create(name, port);\n          if (!server) {\n            throw new Error(`create \"${name}\" leader failed, the port:${port} is occupied by other`);\n          }\n        } else if (this.options.isLeader === false) {\n          // wait for leader active\n          await ClusterServer.waitFor(port, this.options.maxWaitTime);\n        } else {\n          debug('[ClusterClient:%s] init cluster client, try to seize the leader on port:%d', name, port);\n          server = await ClusterServer.create(name, port);\n        }\n\n        if (server) {\n          this[innerClient] = new Leader(Object.assign({ server }, this.options));\n          debug('[ClusterClient:%s] has seized port %d, and serves as leader client.', name, port);\n        } else {\n          this[innerClient] = new Follower(this.options);\n          debug('[ClusterClient:%s] gives up seizing port %d, and serves as follower client.', name, port);\n        }\n        // ...\n    }\n}\n```\n\n- port数值就是上文开始处通过detectPort获取的clusterPort数值\n- 然后net.create 创建TCP服务，之后所有的Leader和Follower都会走它提供的服务进行socket通信\n- Leader获取数据触发publish，传给订阅的Follower中\n\ncluster-client源码是很复杂的，中间还涉及到专递数据的格式，进行数据包的解析等等，这边就不扩展介绍了，有兴趣可以自己撸源码。\n\n\n\n### __#总结__\n\nEgg.js的进程管理和通信自然不会像文章里说的那么简单，但大体如此。弄清楚它们的工作原理对开发程序、插件、中间件有很大的帮助，个人认为这个才是这个框架的精髓之处。","source":"_posts/egg-cluster.md","raw":"---\ntitle: Egg Cluster 简单介绍\ncategory: JavaScript\nkeywords: 进程管理,Eggjs启动,Egg Cluster\ndescription: Egg.js的进程管理和通信自然不会像文章里说的那么简单，但大体如此。弄清楚它们的工作原理对开发程序、插件、中间件有很大的帮助，个人认为这个才是这个框架的精髓之处。\ntags:\n  - Node.js\n  - JavaScript\ndate: 2019-01-18T13:48:01.464Z\n---\n\n如果不清楚什么是Egg.js，希望能移步到它的[官网](https://eggjs.org)简单看下。另外说它是__约定大于配置__的话，我只能说你真的不了解它，或者说不了解框架，哪个框架没有约定？毕竟没有规矩不成方圆，何况是逻辑性的程序呢？官方列出的特性如下：\n\n> 1.提供基于 Egg [定制上层框架](https://eggjs.org/zh-cn/advanced/framework.html) 的能力\n> 2.高度可扩展的[插件机制](https://eggjs.org/zh-cn/basics/plugin.html)\n> 3.内置[多进程管理](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n> 4.基于 [Koa](http://koajs.com/) 开发，性能优异\n> 5.框架稳定，测试覆盖率高\n> 6.[渐进式开发](https://eggjs.org/zh-cn/tutorials/progressive.html)\n\n第1条，它有那么Koa也有啊。第2条，它有，难道Koa、Express等就没有嘛？第4条，更好的补充了Koa不是更好吗？第5条，难道别的框架就不稳定了？第6条，前端鼓吹渐进式、后端也鼓吹，那究竟什么是渐进式呢？\n\n在我看来最吸引我的是第3条，__内置多进程管理__，这个在其它主流nodejs框架中是稀缺的特性，此文就简单聊聊它。\n\n<!-- more -->\n\n\n\n### __#从源码慢慢了解__\n\n- __egg-core__: 定义了一个__EggCore__类，它继承KoaApplication，也就是特性中提到的第4条 *基于Koa开发，性能优异*\n- __egg__: 定义了一个继承于EggCore的__EggApplication__类，并且Application和Agent分别继承于EggApplication\n- __egg-cluster__: 这个类库主要就是做__多进程管理__的工作\n\n*egg-cluster让Egg.js变得与众不同*，看看它做了什么。\n\n### egg-cluster\n\n```js\n// egg-cluster index.js 唯一对外暴露的接口 startCluster\nexports.startCluster = function (options, callback) {\n    new Master(options).ready(callback)\n}\n```\n\negg-cluster就是靠Master在管理egg里面的angent和workers（application）,另外它也是它们之间通信的中转站，看下官网给出的图解：\n![Master-Agent-Works 模型](/images/egg-cluster/1.jpg)\n\n### Agent-Works怎么启动的？\n```js\nclass Master extends EventEmitter {\n    constructor(options) {\n        this.workerManager = new Manager();\n    \tthis.messenger = new Messenger(this);\n        // ...\n\t\tthis.once('agent-start', this.forkAppWorkers.bind(this));\n        // ...\n        detectPort((err, port) => {\n            // 试着找个可以用的port\n            this.options.clusterPort = port;\n            // 启动 agent\n            this.forkAgentWorker();\n        });\n        // ...\n    }\n    forkAgentWorker() {\n        // ... childprocess.fork egg-cluster/lib/agent_worker.js\n        const agentWorker = childprocess.fork(this.getAgentWorkerFile(), args, opt);\n        // ...\n    }\n    forkAppWorkers() {\n        // 将需要数量的 worker 一个个创建出来\n        // cluster.fork egg-cluster/lib/agent_worker.js 它们将监听同一个服务端口\n        // 创建 http或https服务\n    }\n}\n```\n\nagent_worker.js主要逻辑就是创建egg类库里的Agent类，完成后发\"agent-start\"给父进程，触发Master的订阅创建Workers\n\n```js\n// egg-cluster/lib/agent_worker.js\n// ...\nprocess.send({ action: 'agent-start', to: 'master' }); \n// ...\n```\n\n### Agent-Works怎么通信呢? ([IPC](https://eggjs.org/zh-cn/core/cluster-and-ipc.html))\n\n- 在Master中维护着一个Messenger（egg-cluster/lib/utils/messenger.js）实例\n- EggApplication中维护了另一个Messenger（egg/lib/core/messenger.js）实例\n\n由于Agent和Worker(Application)都继承EggApplication，它们调用Messenger的时候会send到创建它们的Master里，然后Master再根据传过来的参数send给不同的Agent或Worker，Master里的转发逻辑如下。\n\n```js\n// egg-cluster master.js\nclass Master extends EventEmitter {\n    forkAppWorkers() {\n        // ...\n        cluster.on('fork', worker => {\n            // ...\n            worker.on('message', msg => {\n            \tif (typeof msg === 'string') msg = { action: msg, data: msg };\n\t            msg.from = 'app';\n    \t        this.messenger.send(msg);\n            });\n            // ...\n        })\n    }\n    forkAgentWorker() {\n        // ...\n        agentWorker.on('message', msg => {\n          if (typeof msg === 'string') msg = { action: msg, data: msg };\n          msg.from = 'agent';\n          this.messenger.send(msg);\n        });\n        // ...\n    }\n}\n```\n\n```js\n// egg messenger.js\nclass Messenger extends EventEmitter {\n    send(action, data, to) {\n        sendmessage(process, {\n          action,\n          data,\n          to,\n        });\n        return this;\n     }\n}\n```\n\n一条信息必定有__from__...__to__...信息\n\n![Master-Agent-Works 通信模型](/images/egg-cluster/2.jpg)\n\n### 官网里提到的“[多进程研发模式增强](https://eggjs.org/zh-cn/advanced/cluster-client.html)”\n\n![一个程序运行n个worker连m个远程服务](/images/egg-cluster/3.jpg)\n\n- n * m 个连接导致大量连接资源“浪费”\n- 减少Master转发带来的额外性能消耗\n- 另外，egg的作者们担心不当的IPC通信把Master搞挂，从而整个服务异常\n\n所以还有一种socket通信方式（使用了另一个库[cluster-client](https://github.com/node-modules/cluster-client)）：\n\n- 将Agent作为Leader，从服务端获取数据，并做缓存\n- 将Worker作为Follower，订阅Agent获取的数据\n\n典型的场景有，Leader（Agent）获取disconf里的配置、获取euerka里的服务等，Follower（Worker）使用这些配置和服务。\n\n![socket通信](/images/egg-cluster/4.jpg)\n\n### cluster-client 源码一瞥\n\n```js\nclass ClusterClient extends Base {\n    // ...\n    async [init]() {\n        const name = this.options.name;\n        const port = this.options.port;\n        let server;\n        if (this.options.isLeader === true) {\n          server = await ClusterServer.create(name, port);\n          if (!server) {\n            throw new Error(`create \"${name}\" leader failed, the port:${port} is occupied by other`);\n          }\n        } else if (this.options.isLeader === false) {\n          // wait for leader active\n          await ClusterServer.waitFor(port, this.options.maxWaitTime);\n        } else {\n          debug('[ClusterClient:%s] init cluster client, try to seize the leader on port:%d', name, port);\n          server = await ClusterServer.create(name, port);\n        }\n\n        if (server) {\n          this[innerClient] = new Leader(Object.assign({ server }, this.options));\n          debug('[ClusterClient:%s] has seized port %d, and serves as leader client.', name, port);\n        } else {\n          this[innerClient] = new Follower(this.options);\n          debug('[ClusterClient:%s] gives up seizing port %d, and serves as follower client.', name, port);\n        }\n        // ...\n    }\n}\n```\n\n- port数值就是上文开始处通过detectPort获取的clusterPort数值\n- 然后net.create 创建TCP服务，之后所有的Leader和Follower都会走它提供的服务进行socket通信\n- Leader获取数据触发publish，传给订阅的Follower中\n\ncluster-client源码是很复杂的，中间还涉及到专递数据的格式，进行数据包的解析等等，这边就不扩展介绍了，有兴趣可以自己撸源码。\n\n\n\n### __#总结__\n\nEgg.js的进程管理和通信自然不会像文章里说的那么简单，但大体如此。弄清楚它们的工作原理对开发程序、插件、中间件有很大的帮助，个人认为这个才是这个框架的精髓之处。","slug":"egg-cluster","published":1,"updated":"2020-07-07T10:11:25.586Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6s001cd12ifj6rubht","content":"<p>如果不清楚什么是Egg.js，希望能移步到它的<a href=\"https://eggjs.org\" target=\"_blank\" rel=\"noopener\">官网</a>简单看下。另外说它是<strong>约定大于配置</strong>的话，我只能说你真的不了解它，或者说不了解框架，哪个框架没有约定？毕竟没有规矩不成方圆，何况是逻辑性的程序呢？官方列出的特性如下：</p>\n<blockquote>\n<p>1.提供基于 Egg <a href=\"https://eggjs.org/zh-cn/advanced/framework.html\" target=\"_blank\" rel=\"noopener\">定制上层框架</a> 的能力<br>2.高度可扩展的<a href=\"https://eggjs.org/zh-cn/basics/plugin.html\" target=\"_blank\" rel=\"noopener\">插件机制</a><br>3.内置<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\">多进程管理</a><br>4.基于 <a href=\"http://koajs.com/\" target=\"_blank\" rel=\"noopener\">Koa</a> 开发，性能优异<br>5.框架稳定，测试覆盖率高<br>6.<a href=\"https://eggjs.org/zh-cn/tutorials/progressive.html\" target=\"_blank\" rel=\"noopener\">渐进式开发</a></p>\n</blockquote>\n<p>第1条，它有那么Koa也有啊。第2条，它有，难道Koa、Express等就没有嘛？第4条，更好的补充了Koa不是更好吗？第5条，难道别的框架就不稳定了？第6条，前端鼓吹渐进式、后端也鼓吹，那究竟什么是渐进式呢？</p>\n<p>在我看来最吸引我的是第3条，<strong>内置多进程管理</strong>，这个在其它主流nodejs框架中是稀缺的特性，此文就简单聊聊它。</p>\n<a id=\"more\"></a>\n<h3 id=\"从源码慢慢了解\"><a href=\"#从源码慢慢了解\" class=\"headerlink\" title=\"#从源码慢慢了解\"></a><strong>#从源码慢慢了解</strong></h3><ul>\n<li><strong>egg-core</strong>: 定义了一个<strong>EggCore</strong>类，它继承KoaApplication，也就是特性中提到的第4条 <em>基于Koa开发，性能优异</em></li>\n<li><strong>egg</strong>: 定义了一个继承于EggCore的<strong>EggApplication</strong>类，并且Application和Agent分别继承于EggApplication</li>\n<li><strong>egg-cluster</strong>: 这个类库主要就是做<strong>多进程管理</strong>的工作</li>\n</ul>\n<p><em>egg-cluster让Egg.js变得与众不同</em>，看看它做了什么。</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a>egg-cluster</h3><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster index.js 唯一对外暴露的接口 startCluster</span></span><br><span class=\"line\">exports.startCluster = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>egg-cluster就是靠Master在管理egg里面的angent和workers（application）,另外它也是它们之间通信的中转站，看下官网给出的图解：<br><img src=\"/images/egg-cluster/1.jpg\" alt=\"Master-Agent-Works 模型\"></p>\n<h3 id=\"Agent-Works怎么启动的？\"><a href=\"#Agent-Works怎么启动的？\" class=\"headerlink\" title=\"Agent-Works怎么启动的？\"></a>Agent-Works怎么启动的？</h3><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.workerManager = <span class=\"hljs-keyword\">new</span> Manager();</span><br><span class=\"line\">    \t<span class=\"hljs-keyword\">this</span>.messenger = <span class=\"hljs-keyword\">new</span> Messenger(<span class=\"hljs-keyword\">this</span>);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">this</span>.once(<span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-keyword\">this</span>.forkAppWorkers.bind(<span class=\"hljs-keyword\">this</span>));</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        detectPort(<span class=\"hljs-function\">(<span class=\"hljs-params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"hljs-comment\">// 试着找个可以用的port</span></span><br><span class=\"line\">            <span class=\"hljs-keyword\">this</span>.options.clusterPort = port;</span><br><span class=\"line\">            <span class=\"hljs-comment\">// 启动 agent</span></span><br><span class=\"line\">            <span class=\"hljs-keyword\">this</span>.forkAgentWorker();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ... childprocess.fork egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> agentWorker = childprocess.fork(<span class=\"hljs-keyword\">this</span>.getAgentWorkerFile(), args, opt);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// 将需要数量的 worker 一个个创建出来</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// cluster.fork egg-cluster/lib/agent_worker.js 它们将监听同一个服务端口</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// 创建 http或https服务</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>agent_worker.js主要逻辑就是创建egg类库里的Agent类，完成后发”agent-start”给父进程，触发Master的订阅创建Workers</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">process.send(&#123; <span class=\"hljs-attr\">action</span>: <span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'master'</span> &#125;); </span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"Agent-Works怎么通信呢-IPC\"><a href=\"#Agent-Works怎么通信呢-IPC\" class=\"headerlink\" title=\"Agent-Works怎么通信呢? (IPC)\"></a>Agent-Works怎么通信呢? (<a href=\"https://eggjs.org/zh-cn/core/cluster-and-ipc.html\" target=\"_blank\" rel=\"noopener\">IPC</a>)</h3><ul>\n<li>在Master中维护着一个Messenger（egg-cluster/lib/utils/messenger.js）实例</li>\n<li>EggApplication中维护了另一个Messenger（egg/lib/core/messenger.js）实例</li>\n</ul>\n<p>由于Agent和Worker(Application)都继承EggApplication，它们调用Messenger的时候会send到创建它们的Master里，然后Master再根据传过来的参数send给不同的Agent或Worker，Master里的转发逻辑如下。</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster master.js</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        cluster.on(<span class=\"hljs-string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">            <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">            worker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">            \t<span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">\t            msg.from = <span class=\"hljs-string\">'app'</span>;</span><br><span class=\"line\">    \t        <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        agentWorker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">          msg.from = <span class=\"hljs-string\">'agent'</span>;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg messenger.js</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Messenger</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    send(action, data, to) &#123;</span><br><span class=\"line\">        sendmessage(process, &#123;</span><br><span class=\"line\">          action,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          to,</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一条信息必定有<strong>from</strong>…<strong>to</strong>…信息</p>\n<p><img src=\"/images/egg-cluster/2.jpg\" alt=\"Master-Agent-Works 通信模型\"></p>\n<h3 id=\"官网里提到的“多进程研发模式增强”\"><a href=\"#官网里提到的“多进程研发模式增强”\" class=\"headerlink\" title=\"官网里提到的“多进程研发模式增强”\"></a>官网里提到的“<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\">多进程研发模式增强</a>”</h3><p><img src=\"/images/egg-cluster/3.jpg\" alt=\"一个程序运行n个worker连m个远程服务\"></p>\n<ul>\n<li>n * m 个连接导致大量连接资源“浪费”</li>\n<li>减少Master转发带来的额外性能消耗</li>\n<li>另外，egg的作者们担心不当的IPC通信把Master搞挂，从而整个服务异常</li>\n</ul>\n<p>所以还有一种socket通信方式（使用了另一个库<a href=\"https://github.com/node-modules/cluster-client\" target=\"_blank\" rel=\"noopener\">cluster-client</a>）：</p>\n<ul>\n<li>将Agent作为Leader，从服务端获取数据，并做缓存</li>\n<li>将Worker作为Follower，订阅Agent获取的数据</li>\n</ul>\n<p>典型的场景有，Leader（Agent）获取disconf里的配置、获取euerka里的服务等，Follower（Worker）使用这些配置和服务。</p>\n<p><img src=\"/images/egg-cluster/4.jpg\" alt=\"socket通信\"></p>\n<h3 id=\"cluster-client-源码一瞥\"><a href=\"#cluster-client-源码一瞥\" class=\"headerlink\" title=\"cluster-client 源码一瞥\"></a>cluster-client 源码一瞥</h3><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ClusterClient</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Base</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> [init]() &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> name = <span class=\"hljs-keyword\">this</span>.options.name;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> port = <span class=\"hljs-keyword\">this</span>.options.port;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> server;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.options.isLeader === <span class=\"hljs-literal\">true</span>) &#123;</span><br><span class=\"line\">          server = <span class=\"hljs-keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">          <span class=\"hljs-keyword\">if</span> (!server) &#123;</span><br><span class=\"line\">            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Error</span>(<span class=\"hljs-string\">`create \"<span class=\"hljs-subst\">$&#123;name&#125;</span>\" leader failed, the port:<span class=\"hljs-subst\">$&#123;port&#125;</span> is occupied by other`</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.options.isLeader === <span class=\"hljs-literal\">false</span>) &#123;</span><br><span class=\"line\">          <span class=\"hljs-comment\">// wait for leader active</span></span><br><span class=\"line\">          <span class=\"hljs-keyword\">await</span> ClusterServer.waitFor(port, <span class=\"hljs-keyword\">this</span>.options.maxWaitTime);</span><br><span class=\"line\">        &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">          debug(<span class=\"hljs-string\">'[ClusterClient:%s] init cluster client, try to seize the leader on port:%d'</span>, name, port);</span><br><span class=\"line\">          server = <span class=\"hljs-keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (server) &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">this</span>[innerClient] = <span class=\"hljs-keyword\">new</span> Leader(<span class=\"hljs-built_in\">Object</span>.assign(&#123; server &#125;, <span class=\"hljs-keyword\">this</span>.options));</span><br><span class=\"line\">          debug(<span class=\"hljs-string\">'[ClusterClient:%s] has seized port %d, and serves as leader client.'</span>, name, port);</span><br><span class=\"line\">        &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">this</span>[innerClient] = <span class=\"hljs-keyword\">new</span> Follower(<span class=\"hljs-keyword\">this</span>.options);</span><br><span class=\"line\">          debug(<span class=\"hljs-string\">'[ClusterClient:%s] gives up seizing port %d, and serves as follower client.'</span>, name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>port数值就是上文开始处通过detectPort获取的clusterPort数值</li>\n<li>然后net.create 创建TCP服务，之后所有的Leader和Follower都会走它提供的服务进行socket通信</li>\n<li>Leader获取数据触发publish，传给订阅的Follower中</li>\n</ul>\n<p>cluster-client源码是很复杂的，中间还涉及到专递数据的格式，进行数据包的解析等等，这边就不扩展介绍了，有兴趣可以自己撸源码。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"#总结\"></a><strong>#总结</strong></h3><p>Egg.js的进程管理和通信自然不会像文章里说的那么简单，但大体如此。弄清楚它们的工作原理对开发程序、插件、中间件有很大的帮助，个人认为这个才是这个框架的精髓之处。</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p>如果不清楚什么是Egg.js，希望能移步到它的<a href=\"https://eggjs.org\" target=\"_blank\" rel=\"noopener\">官网</a>简单看下。另外说它是<strong>约定大于配置</strong>的话，我只能说你真的不了解它，或者说不了解框架，哪个框架没有约定？毕竟没有规矩不成方圆，何况是逻辑性的程序呢？官方列出的特性如下：</p>\n<blockquote>\n<p>1.提供基于 Egg <a href=\"https://eggjs.org/zh-cn/advanced/framework.html\" target=\"_blank\" rel=\"noopener\">定制上层框架</a> 的能力<br>2.高度可扩展的<a href=\"https://eggjs.org/zh-cn/basics/plugin.html\" target=\"_blank\" rel=\"noopener\">插件机制</a><br>3.内置<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\">多进程管理</a><br>4.基于 <a href=\"http://koajs.com/\" target=\"_blank\" rel=\"noopener\">Koa</a> 开发，性能优异<br>5.框架稳定，测试覆盖率高<br>6.<a href=\"https://eggjs.org/zh-cn/tutorials/progressive.html\" target=\"_blank\" rel=\"noopener\">渐进式开发</a></p>\n</blockquote>\n<p>第1条，它有那么Koa也有啊。第2条，它有，难道Koa、Express等就没有嘛？第4条，更好的补充了Koa不是更好吗？第5条，难道别的框架就不稳定了？第6条，前端鼓吹渐进式、后端也鼓吹，那究竟什么是渐进式呢？</p>\n<p>在我看来最吸引我的是第3条，<strong>内置多进程管理</strong>，这个在其它主流nodejs框架中是稀缺的特性，此文就简单聊聊它。</p>","more":"<h3 id=\"从源码慢慢了解\"><a href=\"#从源码慢慢了解\" class=\"headerlink\" title=\"#从源码慢慢了解\"></a><strong>#从源码慢慢了解</strong></h3><ul>\n<li><strong>egg-core</strong>: 定义了一个<strong>EggCore</strong>类，它继承KoaApplication，也就是特性中提到的第4条 <em>基于Koa开发，性能优异</em></li>\n<li><strong>egg</strong>: 定义了一个继承于EggCore的<strong>EggApplication</strong>类，并且Application和Agent分别继承于EggApplication</li>\n<li><strong>egg-cluster</strong>: 这个类库主要就是做<strong>多进程管理</strong>的工作</li>\n</ul>\n<p><em>egg-cluster让Egg.js变得与众不同</em>，看看它做了什么。</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a>egg-cluster</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster index.js 唯一对外暴露的接口 startCluster</span></span><br><span class=\"line\">exports.startCluster = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>egg-cluster就是靠Master在管理egg里面的angent和workers（application）,另外它也是它们之间通信的中转站，看下官网给出的图解：<br><img src=\"/images/egg-cluster/1.jpg\" alt=\"Master-Agent-Works 模型\"></p>\n<h3 id=\"Agent-Works怎么启动的？\"><a href=\"#Agent-Works怎么启动的？\" class=\"headerlink\" title=\"Agent-Works怎么启动的？\"></a>Agent-Works怎么启动的？</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.workerManager = <span class=\"keyword\">new</span> Manager();</span><br><span class=\"line\">    \t<span class=\"keyword\">this</span>.messenger = <span class=\"keyword\">new</span> Messenger(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.once(<span class=\"string\">'agent-start'</span>, <span class=\"keyword\">this</span>.forkAppWorkers.bind(<span class=\"keyword\">this</span>));</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        detectPort(<span class=\"function\">(<span class=\"params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 试着找个可以用的port</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.options.clusterPort = port;</span><br><span class=\"line\">            <span class=\"comment\">// 启动 agent</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.forkAgentWorker();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ... childprocess.fork egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> agentWorker = childprocess.fork(<span class=\"keyword\">this</span>.getAgentWorkerFile(), args, opt);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 将需要数量的 worker 一个个创建出来</span></span><br><span class=\"line\">        <span class=\"comment\">// cluster.fork egg-cluster/lib/agent_worker.js 它们将监听同一个服务端口</span></span><br><span class=\"line\">        <span class=\"comment\">// 创建 http或https服务</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>agent_worker.js主要逻辑就是创建egg类库里的Agent类，完成后发”agent-start”给父进程，触发Master的订阅创建Workers</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">process.send(&#123; <span class=\"attr\">action</span>: <span class=\"string\">'agent-start'</span>, <span class=\"attr\">to</span>: <span class=\"string\">'master'</span> &#125;); </span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"Agent-Works怎么通信呢-IPC\"><a href=\"#Agent-Works怎么通信呢-IPC\" class=\"headerlink\" title=\"Agent-Works怎么通信呢? (IPC)\"></a>Agent-Works怎么通信呢? (<a href=\"https://eggjs.org/zh-cn/core/cluster-and-ipc.html\" target=\"_blank\" rel=\"noopener\">IPC</a>)</h3><ul>\n<li>在Master中维护着一个Messenger（egg-cluster/lib/utils/messenger.js）实例</li>\n<li>EggApplication中维护了另一个Messenger（egg/lib/core/messenger.js）实例</li>\n</ul>\n<p>由于Agent和Worker(Application)都继承EggApplication，它们调用Messenger的时候会send到创建它们的Master里，然后Master再根据传过来的参数send给不同的Agent或Worker，Master里的转发逻辑如下。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster master.js</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        cluster.on(<span class=\"string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">            <span class=\"comment\">// ...</span></span><br><span class=\"line\">            worker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">\t            msg.from = <span class=\"string\">'app'</span>;</span><br><span class=\"line\">    \t        <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            <span class=\"comment\">// ...</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        agentWorker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">          msg.from = <span class=\"string\">'agent'</span>;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg messenger.js</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Messenger</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    send(action, data, to) &#123;</span><br><span class=\"line\">        sendmessage(process, &#123;</span><br><span class=\"line\">          action,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          to,</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一条信息必定有<strong>from</strong>…<strong>to</strong>…信息</p>\n<p><img src=\"/images/egg-cluster/2.jpg\" alt=\"Master-Agent-Works 通信模型\"></p>\n<h3 id=\"官网里提到的“多进程研发模式增强”\"><a href=\"#官网里提到的“多进程研发模式增强”\" class=\"headerlink\" title=\"官网里提到的“多进程研发模式增强”\"></a>官网里提到的“<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\">多进程研发模式增强</a>”</h3><p><img src=\"/images/egg-cluster/3.jpg\" alt=\"一个程序运行n个worker连m个远程服务\"></p>\n<ul>\n<li>n * m 个连接导致大量连接资源“浪费”</li>\n<li>减少Master转发带来的额外性能消耗</li>\n<li>另外，egg的作者们担心不当的IPC通信把Master搞挂，从而整个服务异常</li>\n</ul>\n<p>所以还有一种socket通信方式（使用了另一个库<a href=\"https://github.com/node-modules/cluster-client\" target=\"_blank\" rel=\"noopener\">cluster-client</a>）：</p>\n<ul>\n<li>将Agent作为Leader，从服务端获取数据，并做缓存</li>\n<li>将Worker作为Follower，订阅Agent获取的数据</li>\n</ul>\n<p>典型的场景有，Leader（Agent）获取disconf里的配置、获取euerka里的服务等，Follower（Worker）使用这些配置和服务。</p>\n<p><img src=\"/images/egg-cluster/4.jpg\" alt=\"socket通信\"></p>\n<h3 id=\"cluster-client-源码一瞥\"><a href=\"#cluster-client-源码一瞥\" class=\"headerlink\" title=\"cluster-client 源码一瞥\"></a>cluster-client 源码一瞥</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ClusterClient</span> <span class=\"keyword\">extends</span> <span class=\"title\">Base</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">async</span> [init]() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> name = <span class=\"keyword\">this</span>.options.name;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> port = <span class=\"keyword\">this</span>.options.port;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> server;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.options.isLeader === <span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">          server = <span class=\"keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (!server) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">`create \"<span class=\"subst\">$&#123;name&#125;</span>\" leader failed, the port:<span class=\"subst\">$&#123;port&#125;</span> is occupied by other`</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.options.isLeader === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// wait for leader active</span></span><br><span class=\"line\">          <span class=\"keyword\">await</span> ClusterServer.waitFor(port, <span class=\"keyword\">this</span>.options.maxWaitTime);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          debug(<span class=\"string\">'[ClusterClient:%s] init cluster client, try to seize the leader on port:%d'</span>, name, port);</span><br><span class=\"line\">          server = <span class=\"keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (server) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>[innerClient] = <span class=\"keyword\">new</span> Leader(<span class=\"built_in\">Object</span>.assign(&#123; server &#125;, <span class=\"keyword\">this</span>.options));</span><br><span class=\"line\">          debug(<span class=\"string\">'[ClusterClient:%s] has seized port %d, and serves as leader client.'</span>, name, port);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>[innerClient] = <span class=\"keyword\">new</span> Follower(<span class=\"keyword\">this</span>.options);</span><br><span class=\"line\">          debug(<span class=\"string\">'[ClusterClient:%s] gives up seizing port %d, and serves as follower client.'</span>, name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>port数值就是上文开始处通过detectPort获取的clusterPort数值</li>\n<li>然后net.create 创建TCP服务，之后所有的Leader和Follower都会走它提供的服务进行socket通信</li>\n<li>Leader获取数据触发publish，传给订阅的Follower中</li>\n</ul>\n<p>cluster-client源码是很复杂的，中间还涉及到专递数据的格式，进行数据包的解析等等，这边就不扩展介绍了，有兴趣可以自己撸源码。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"#总结\"></a><strong>#总结</strong></h3><p>Egg.js的进程管理和通信自然不会像文章里说的那么简单，但大体如此。弄清楚它们的工作原理对开发程序、插件、中间件有很大的帮助，个人认为这个才是这个框架的精髓之处。</p>"},{"title":"libuv & Node.js EventLoop （一）","keywords":"libuv,EventLoop,V8","description":"libuv和Node.js EventLoop关于各个阶段和setTimeout的实现已经做了简单介绍。具体的还是需要看各自版本的代码而定，不能轻易去“相信”网上的介绍，比如最后一个例子就很容易在不同版本出现不同的执行结果。之后，有时间介绍 `nextTick`的回调实现，这个比较复杂。","date":"2020-02-29T21:39:36.647Z","_content":"\n在网络上查询[libuv](https://libuv.org/)和EventLoop相关信息的时候，经常看到不同的文章所表达的意思差距较多，主要原因有二吧：\n\n- 它们的`libuv`和`V8`大版本不同，导致具体的实现略有差异\n- 另外它们的代码错综复杂，又是大多数JavaScript工作者不擅长的C/C++，只是从上而下的看，或许一些细节无法完全理解或是认知的分歧\n\n与其受他人影响，不如自己来好好梳理下。\n\n**版本**\n\n```c++\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n没有列出具体版本号的代码分析都是耍流氓，2010年的代码和2020年的代码可能差距甚远，“上古”分析固然在当时是对的，但是在今日也许是错误的。\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n### libuv & EventLoop文档比较\n\n![_images/loop_iteration.png](/images/v8-libuv-timer-event-loop/loop_iteration.png)\n\n上图出自`libuv`的[The I/O loop](http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop)介绍，具体的信息可以看其文档。\n\n![image-20200301145547994](/images/v8-libuv-timer-event-loop/image-20200301145547994.png)\n\n上图出自[Event Loop Explained](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained)，两者的各个阶段基本是对应的。哪怕是很多其它自行画的图解中，也基本差不多，但唯独`pending callbacks`阶段，我看到很多文章里面把它标为`I/O callbacks`，不知道是不是历史原因，但是就从二者的目前文档解释来看是不妥的。\n\n> Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point. —— libuv\n\n**libuv**里的`pending callbacks`：大多数的I/O callbacks应该在polling阶段完成，有部分会被延迟到下一个pending callbacks阶段执行。\n\n<br/>\n\n> This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives `ECONNREFUSED` when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the **pending callbacks** phase. —— Node.js\n\n**Node.js**里的`pending callbacks`：这个阶段会执行系统上发生的一些错误而导致的callbacks，如TCP错误。\n\n我觉得`pending callbacks`比较合理，一方面如libuv所说，它是一部分延迟的I/O回调，在Node.js里面指的是一些系统上的错误（这些错误也是I/O引起的）。而大多数的I/O操作其实是在 `poll`阶段。\n\n<br/>\n\n<br/>\n\n## libuv的大致流程代码\n\n```c\nint uv_run(uv_loop_t* loop, uv_run_mode mode) { // 默认 mode 是 UV_RUN_DEFAULT\n  int timeout;\n  int r;\n  int ran_pending;\n\n  // 是否还存在alive的事件\n  r = uv__loop_alive(loop);\n  if (!r)\n    uv__update_time(loop); // 存在的话更新当前的时间，可以把这个时间理解为libuv里面统一的时间，方便触发定时任务\n\n  while (r != 0 && loop->stop_flag == 0) {\n    uv__update_time(loop); // 和libuv图里的 Update loop time对应\n    uv__run_timers(loop); // 执行 timers 阶段\n    ran_pending = uv__run_pending(loop); // 执行pending 阶段；返回0表示空，1表示有；\n    uv__run_idle(loop); // idle 阶段； Node.js里面不太关心\n    uv__run_prepare(loop); // prepare 阶段； Node.js里面不太关心\n\n    timeout = 0; // 初始化阻塞 poll 阶段的超时时间\n    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)\n      timeout = uv_backend_timeout(loop); // 算出阻塞 poll 阶段的超时时间\n    // 根据timers里最近的超时时间算出一个差值 diff = loop.time - min.timeout\n    // 如果 diff >= 0 , timeout = 0\n    // 否则 timeout = min(diff, INT_MAX)\n    \n    uv__io_poll(loop, timeout); // 执行 poll 阶段\n    uv__run_check(loop); // 执行 check 阶段\n    uv__run_closing_handles(loop); // 执行 close 阶段\n\n    // mode 默认 UV_RUN_DEFAULT 所以不执行下面\n    if (mode == UV_RUN_ONCE) {\n      uv__update_time(loop);\n      uv__run_timers(loop);\n    }\n\n    // 查看是否还有alive事件\n    r = uv__loop_alive(loop);\n    if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)\n      break;\n  }\n\n  /* The if statement lets gcc compile it to a conditional store. Avoids\n   * dirtying a cache line.\n   */\n  if (loop->stop_flag != 0)\n    loop->stop_flag = 0;\n\n  return r;\n}\n```\n\n上述`uv_run`方法同样表达了之前图的循环流程，接下来我们看看各个阶段的具体执行方法。\n\n<br/>\n\n```c\nvoid uv__run_timers(uv_loop_t* loop) {\n  struct heap_node* heap_node; // timers 里的都是按照最小堆存放的\n  uv_timer_t* handle;\n\n  for (;;) {\n    heap_node = heap_min(timer_heap(loop)); // 从堆顶取出一个\n    if (heap_node == NULL) // 不存在就退出\n      break;\n\n    handle = container_of(heap_node, uv_timer_t, heap_node); \n    if (handle->timeout > loop->time) // 触发时间没达到也退出\n      break;\n\n    uv_timer_stop(handle);\n    uv_timer_again(handle);\n    \n    handle->timer_cb(handle); // 执行回调\n  }\n}\n```\n\ntimers里存放的事件都是最小堆的数据结构排列的，不断的取出根节点比较当前的`loop->time`就能知道是执行还是退出，**那么这里的`handle->timer_cb`是我们平时JavaScript里的setTimeout回调吗？**后续解答\n\n<br/>\n\n```c\nstatic int uv__run_pending(uv_loop_t* loop) {\n  QUEUE* q;\n  QUEUE pq;\n  uv__io_t* w;\n\n  if (QUEUE_EMPTY(&loop->pending_queue))\n    return 0;\n\n  QUEUE_MOVE(&loop->pending_queue, &pq);\n\n  while (!QUEUE_EMPTY(&pq)) { // 双向链表，为空就跳出\n    q = QUEUE_HEAD(&pq);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n    w = QUEUE_DATA(q, uv__io_t, pending_queue);\n    w->cb(loop, w, POLLOUT); // 执行回调\n  }\n\n  return 1;\n}\n```\n\nlibuv里面事件很多是由双向链表构建而成，等着被一个个执行，双向链表的好处就是插入很容易。\n\n<br/>\n\n```c\n#define UV_LOOP_WATCHER_DEFINE(name, type)                                    \\\n\tvoid uv__run_##name(uv_loop_t* loop) {                                      \\\n    uv_##name##_t* h;                                                         \\\n    QUEUE queue;                                                              \\\n    QUEUE* q;                                                                 \\\n    QUEUE_MOVE(&loop->name##_handles, &queue);                                \\\n    while (!QUEUE_EMPTY(&queue)) {                                            \\\n      q = QUEUE_HEAD(&queue);                                                 \\\n      h = QUEUE_DATA(q, uv_##name##_t, queue);                                \\\n      QUEUE_REMOVE(q);                                                        \\\n      QUEUE_INSERT_TAIL(&loop->name##_handles, q);                            \\\n      h->name##_cb(h);                                                        \\\n    }                                                                         \\\n  }     \n\nUV_LOOP_WATCHER_DEFINE(prepare, PREPARE)\nUV_LOOP_WATCHER_DEFINE(check, CHECK)\nUV_LOOP_WATCHER_DEFINE(idle, IDLE)\n```\n\n`UV_LOOP_WATCHER_DEFINE`宏直接初始化了`prepare`、`check`和`idle`3个阶段，都是双向链表。\n\n<br/>\n\n```c\n// uv__io_poll 太长了，不重要的代码已经移除\nvoid uv__io_poll(uv_loop_t* loop, int timeout) {\n  // ...\n  if (loop->nfds == 0) { // 没有需要执行的 直接退出\n    assert(QUEUE_EMPTY(&loop->watcher_queue));\n    return;\n  }\n\n  // 将loop->watcher_queue列队里的待观察的文件描述符绑定到epoll上\n  while (!QUEUE_EMPTY(&loop->watcher_queue)) {\n    q = QUEUE_HEAD(&loop->watcher_queue);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n\n    w = QUEUE_DATA(q, uv__io_t, watcher_queue);\n    // ...\n    if (w->events == 0)\n      op = EPOLL_CTL_ADD; // 添加\n    else\n      op = EPOLL_CTL_MOD; // 修改\n\n    epoll_ctl(loop->backend_fd, op, w->fd, &e) // epoll_ctl 底层的系统函数，将文件描述符关联起来\n\n    w->events = w->pevents;\n  }\n\n  sigmask = 0;\n  if (loop->flags & UV_LOOP_BLOCK_SIGPROF) {\n    sigemptyset(&sigset);\n    sigaddset(&sigset, SIGPROF);\n    sigmask |= 1 << (SIGPROF - 1);\n  }\n\n  base = loop->time;\n  real_timeout = timeout;\n\n  for (;;) {\n    nfds = epoll_wait(loop->backend_fd,\n                        events,\n                        ARRAY_SIZE(events),\n                        timeout);\n    \n    if (nfds == 0) { // 超时，没有新的事件准备好\n      assert(timeout != -1); // -1 表示不会超时，而nfds为0表示超时，存在矛盾所以抛出异常\n      if (timeout == 0) // 退出\n        return;\n      \n      goto update_timeout; // 重新更新时间 准备下次循环 epoll_wait \n    }\n\n    if (nfds == -1) { // 出错\n      if (errno == ENOSYS) {\n        /* epoll_wait() or epoll_pwait() failed, try the other system call. */\n        assert(no_epoll_wait == 0 || no_epoll_pwait == 0);\n        continue;\n      }\n\n      if (errno != EINTR)\n        abort();\n\n      if (timeout == -1)\n        continue;\n\n      if (timeout == 0)\n        return;\n\n      goto update_timeout;\n    }\n\n    have_signals = 0;\n    nevents = 0;\n\n    loop->watchers[loop->nwatchers] = (void*) events;\n    loop->watchers[loop->nwatchers + 1] = (void*) (uintptr_t) nfds;\n    for (i = 0; i < nfds; i++) {\n      pe = events + i;\n      fd = pe->data.fd;\n      w = loop->watchers[fd];\n      w->cb(loop, w, pe->events); // 这个for循环很长，这里我简化了，其实就是准备好的IO就执行回调\n    }\n\n    if (timeout == 0)\n      return;\n\n    if (timeout == -1)\n      continue;\n\nupdate_timeout:\n    assert(timeout > 0);\n\n    real_timeout -= (loop->time - base);\n    if (real_timeout <= 0)\n      return;\n\n    timeout = real_timeout;\n  }\n}\n```\n\n`uv__io_poll`里的timeout参数是根据`timers`里的最近一次定时时间计算出来的。方法内部使用了`epoll`，是IO多路复用的一个概念。一共有三种：`select`、`poll`和`epoll`。\n\n> epoll是[Linux内核](https://baike.baidu.com/item/Linux内核)为处理大批量[文件描述符](https://baike.baidu.com/item/文件描述符/9809582)而作了改进的poll，是Linux下多路复用IO接口select/poll的增强版本，它能显著提高程序在大量[并发连接](https://baike.baidu.com/item/并发连接/3763280)中只有少量活跃的情况下的系统[CPU](https://baike.baidu.com/item/CPU/120556)利用率。另一点原因就是获取事件的时候，它无须遍历整个被侦听的描述符集，只要遍历那些被内核IO事件异步唤醒而加入Ready队列的描述符集合就行了。epoll除了提供select/poll那种IO事件的水平触发（Level Triggered）外，还提供了边缘触发（Edge Triggered），这就使得用户空间程序有可能缓存IO状态，减少epoll_wait/epoll_pwait的调用，提高应用程序效率。 ——百度百科\n\n我觉得libuv使用epoll主要是因为支持其自身的异步特点\n\n- epoll监控的文件描述符远远大于select/poll\n- 在大量并发的时候epoll性能远远高于select/poll，而少量异步select/poll相对好点。Node.js利用了libuv的高并发特点。\n\n<br/>\n\n```c\nstatic void uv__run_closing_handles(uv_loop_t* loop) {\n  uv_handle_t* p;\n  uv_handle_t* q;\n\n  p = loop->closing_handles;\n  loop->closing_handles = NULL;\n\n  while (p) {\n    q = p->next_closing;\n    uv__finish_close(p);\n    p = q;\n  }\n}\n```\n\n一个个触发`close`回调\n\n<br/>\n\n上述就是libuv各个阶段的大体流程，`poll`最为复杂，还有很多东西可以留着细品。\n\n<br/>\n\n<br/>\n\n\n\n## Node.js setTimeout\n\n上文中提到**那么这里的`handle->timer_cb`是我们平时JavaScript里的setTimeout回调吗？回答：不是的**\n\n看看Node.js里面如何具体实现这个`setTimemout`方法的\n\n```javascript\nfunction setTimeout(callback, after, arg1, arg2, arg3) {\n  var args = [arg1, arg2, arg3]; // 简化了代码\n  const timeout = new Timeout(callback, after, args, false);\n  active(timeout);\n\n  return timeout;\n}\nfunction Timeout(callback, after, args, isRepeat) {\n  // 省略了部分代码\n  after *= 1; \n  if (!(after >= 1 && after <= TIMEOUT_MAX)) {\n    after = 1; // 定时验证不过 就为1 \n  }\n  this._idleTimeout = after;\n  this._onTimeout = callback;\n  this._timerArgs = args;\n}\nfunction active(item) {\n  insert(item, true, getLibuvNow());  // getLibuvNow 获取 loop->time时间\n}\nfunction insert(item, refed, start) {\n  let msecs = item._idleTimeout;\n  if (msecs < 0 || msecs === undefined)\n    return;\n\n  // Truncate so that accuracy of sub-millisecond timers is not assumed.\n  msecs = Math.trunc(msecs);\n\n  item._idleStart = start;\n\n  // Use an existing list if there is one, otherwise we need to make a new one.\n  // timerListMap 是一个键值对，key 是定时时间，value 是一个TimersList\n  var list = timerListMap[msecs];\n  if (list === undefined) {\n    const expiry = start + msecs; // 过期时间\n    timerListMap[msecs] = list = new TimersList(expiry, msecs); // 双向链表\n    timerListQueue.insert(list); // timerListQueue 用数组实现的最小堆\n\n    if (nextExpiry > expiry) {\n      scheduleTimer(msecs); // 如果此次定时任务的有效时间小的话，调用 V8 scheduleTimer\n      nextExpiry = expiry;\n    }\n  }\n  // ... 这边简略代码\n  L.append(list, item); // 将setTimeout创建的Timeout对象添加到list尾部\n}\n```\n\n通过上述代码，我们也可以看出JavaScript层面也有一个维护timers的最小堆，并没有吧具体的某个setTimeout注册到V8里面，只是将定时时间告诉了V8`scheduleTimer(msecs);`，下面是V8相关代码。\n\n```c\n// timers.cc\nvoid ScheduleTimer(const FunctionCallbackInfo<Value>& args) {\n  auto env = Environment::GetCurrent(args);\n  env->ScheduleTimer(args[0]->IntegerValue(env->context()).FromJust());\n}\n// env.cc\nvoid Environment::ScheduleTimer(int64_t duration_ms) {\n  if (started_cleanup_) return;\n  uv_timer_start(timer_handle(), RunTimers, duration_ms, 0);\n}\nvoid Environment::RunTimers(uv_timer_t* handle) {\n  Environment* env = Environment::from_timer_handle(handle);\n  \n  // timers_callback_function 从何而来呢？\n  Local<Function> cb = env->timers_callback_function();\n  do {\n    ret = cb->Call(env->context(), process, 1, &arg);\n  } while (ret.IsEmpty() && env->can_call_into_js());\n}\n// uv/timer.c\nint uv_timer_start(uv_timer_t* handle,\n                   uv_timer_cb cb,\n                   uint64_t timeout,\n                   uint64_t repeat) {\n  // 给uv_timer_t对象初始化相关属性\n  // 并没有JavaScript层面的回调方法，具体的回调也只是C++的RunTimers\n  handle->timer_cb = cb;\n  handle->timeout = clamped_timeout;\n  handle->repeat = repeat;\n  handle->start_id = handle->loop->timer_counter++;\n\n  // 将uv_timer_t添加到timer_heap上\n  heap_insert(timer_heap(handle->loop),\n              (struct heap_node*) &handle->heap_node,\n              timer_less_than);\n  uv__handle_start(handle);\n\n  return 0;\n}\n\n```\n\n**V8部分注册在timers阶段的是一个C++的回调方法**，其内部是执行`timers_callback_function`方法，它从何来来？\n\n```c++\n// timers.cc\nvoid SetupTimers(const FunctionCallbackInfo<Value>& args) {\n  CHECK(args[0]->IsFunction());\n  CHECK(args[1]->IsFunction());\n  auto env = Environment::GetCurrent(args);\n\n  env->set_immediate_callback_function(args[0].As<Function>()); // 注册了immediate回调\n  env->set_timers_callback_function(args[1].As<Function>()); // 注册了timers回调\n}\n```\n\n```javascript\n// node.js\nconst {\n  setupTaskQueue,\n  queueMicrotask\n} = require('internal/process/task_queues');\nconst { nextTick, runNextTicks } = setupTaskQueue();\nprocess.nextTick = nextTick;\nprocess._tickCallback = runNextTicks;\n\nconst { getTimerCallbacks } = require('internal/timers');\nconst { setupTimers } = internalBinding('timers'); // c++ SetupTimers 方法传到了JavaScript层\nconst { processImmediate, processTimers } = getTimerCallbacks(runNextTicks);\nsetupTimers(processImmediate, processTimers);\n```\n\n我们通过上述代码看到在`node.js`里面会将`processImmediate`和`processTimers`这两个JavaScript方法注册到对应的C++回调里，之后执行`timers_callback_function`其实就是执行`processTimers`方法。\n\n另外，需要注意`微任务`相关的代码会被带到`getTimerCallbacks`。\n\n```javascript\nfunction getTimerCallbacks(runNextTicks) {\n  function processImmediate() {\n    // 之后文章在做介绍\n  }\n\n\n  function processTimers(now) {\n    nextExpiry = Infinity;\n\n    let list;\n    let ranAtLeastOneList = false;\n    while (list = timerListQueue.peek()) {\n      if (list.expiry > now) { // 当前列表的过期时间大于now(libuv loop->time), 还没有到过期或到触发时间\n        nextExpiry = list.expiry; // nextExpiry 设置为 当前列表的过期时间\n        return refCount > 0 ? nextExpiry : -nextExpiry;\n      }\n      if (ranAtLeastOneList)\n        runNextTicks(); // 微任务会被触发\n      else\n        ranAtLeastOneList = true;\n      listOnTimeout(list, now);\n    }\n    return 0;\n  }\n\n  function listOnTimeout(list, now) {\n    const msecs = list.msecs;\n\n    debug('timeout callback %d', msecs);\n\n    var diff, timer;\n    let ranAtLeastOneTimer = false;\n    while (timer = L.peek(list)) { // 如果不是一个空的list，持续执行\n      // _idleStart 是插入libuv (loop->time)的时间\n      // now 是当前libuv 执行此次callback的时间\n      diff = now - timer._idleStart; \n\n      // Check if this loop iteration is too early for the next timer.\n      // This happens if there are more timers scheduled for later in the list.\n      if (diff < msecs) {\n        list.expiry = Math.max(timer._idleStart + msecs, now + 1);\n        list.id = timerListId++;\n        timerListQueue.percolateDown(1);\n        debug('%d list wait because diff is %d', msecs, diff);\n        return;\n      }\n\n      if (ranAtLeastOneTimer)\n        runNextTicks(); // 微任务会被触发\n      else\n        ranAtLeastOneTimer = true;\n\n      // The actual logic for when a timeout happens.\n      L.remove(timer);\n\n      const asyncId = timer[async_id_symbol];\n      if (!timer._onTimeout) {\n        continue;\n      }\n      try {\n        const args = timer._timerArgs;\n        if (args === undefined)\n          timer._onTimeout(); // _onTimeout setTimeout 回调\n        else\n          timer._onTimeout(...args);\n      } finally {\n        // ...\n      }\n    }\n    if (list === timerListMap[msecs]) {\n      delete timerListMap[msecs];\n      timerListQueue.shift();\n    }\n  }\n\n  return {\n    processImmediate,\n    processTimers\n  };\n}\n```\n\n上述代码很长，但是很容易理解，就是根据`libuv`的时间，将到期的定时任务一一执行了，格外需要注意的是微任务的执行`runNextTicks`，**每次setTimeout的callback之后都会将`微任务`清空，而不是网上很多文章说的timer阶段之后将微任务清空，这个改动在Node.js 11版本**\n\n> Timers\n> Interval timers will be rescheduled even if previous interval threw an error. #20002\n> **nextTick queue will be run after each immediate and timer. [#22842](https://github.com/nodejs/node/pull/22842)**\n\n具体的原因是希望和浏览器里的行为更为一直，下面的代码在11之前和之后的执行结果略有不同。\n\n```javascript\nsetTimeout(() => {\n  console.log('time1');\n  Promise.resolve().then(() => {\n    console.log('promise1');\n  });\n});\n\nsetTimeout(() => {\n  console.log('time2');\n  Promise.resolve().then(() => {\n    console.log('promise2');\n  });\n});\n\n/* 11之后\ntime1\npromise1\ntime2\npromise2\n*/\n\n/* 11之前\ntime1\ntime2\npromise1\npromise2\n*/\n\n```\n\n\n\n<br/>\n\n<br/>\n\n## 总结\n\n至此，libuv和Node.js EventLoop关于`各个阶段`和`setTimeout`的实现已经做了简单介绍。具体的还是需要看各自版本的代码而定，不能轻易去“相信”网上的介绍，比如最后一个例子就很容易在不同版本出现不同的执行结果。之后，有时间介绍 `nextTick`的回调实现，这个比较复杂。","source":"_posts/v8-libuv-timer-event-loop.md","raw":"---\ntitle: libuv & Node.js EventLoop （一）\ncategory: JavaScript\nkeywords: libuv,EventLoop,V8\ndescription: libuv和Node.js EventLoop关于各个阶段和setTimeout的实现已经做了简单介绍。具体的还是需要看各自版本的代码而定，不能轻易去“相信”网上的介绍，比如最后一个例子就很容易在不同版本出现不同的执行结果。之后，有时间介绍 `nextTick`的回调实现，这个比较复杂。\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-03-01T05:39:36.647Z\n---\n\n在网络上查询[libuv](https://libuv.org/)和EventLoop相关信息的时候，经常看到不同的文章所表达的意思差距较多，主要原因有二吧：\n\n- 它们的`libuv`和`V8`大版本不同，导致具体的实现略有差异\n- 另外它们的代码错综复杂，又是大多数JavaScript工作者不擅长的C/C++，只是从上而下的看，或许一些细节无法完全理解或是认知的分歧\n\n与其受他人影响，不如自己来好好梳理下。\n\n**版本**\n\n```c++\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n没有列出具体版本号的代码分析都是耍流氓，2010年的代码和2020年的代码可能差距甚远，“上古”分析固然在当时是对的，但是在今日也许是错误的。\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n### libuv & EventLoop文档比较\n\n![_images/loop_iteration.png](/images/v8-libuv-timer-event-loop/loop_iteration.png)\n\n上图出自`libuv`的[The I/O loop](http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop)介绍，具体的信息可以看其文档。\n\n![image-20200301145547994](/images/v8-libuv-timer-event-loop/image-20200301145547994.png)\n\n上图出自[Event Loop Explained](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained)，两者的各个阶段基本是对应的。哪怕是很多其它自行画的图解中，也基本差不多，但唯独`pending callbacks`阶段，我看到很多文章里面把它标为`I/O callbacks`，不知道是不是历史原因，但是就从二者的目前文档解释来看是不妥的。\n\n> Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point. —— libuv\n\n**libuv**里的`pending callbacks`：大多数的I/O callbacks应该在polling阶段完成，有部分会被延迟到下一个pending callbacks阶段执行。\n\n<br/>\n\n> This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives `ECONNREFUSED` when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the **pending callbacks** phase. —— Node.js\n\n**Node.js**里的`pending callbacks`：这个阶段会执行系统上发生的一些错误而导致的callbacks，如TCP错误。\n\n我觉得`pending callbacks`比较合理，一方面如libuv所说，它是一部分延迟的I/O回调，在Node.js里面指的是一些系统上的错误（这些错误也是I/O引起的）。而大多数的I/O操作其实是在 `poll`阶段。\n\n<br/>\n\n<br/>\n\n## libuv的大致流程代码\n\n```c\nint uv_run(uv_loop_t* loop, uv_run_mode mode) { // 默认 mode 是 UV_RUN_DEFAULT\n  int timeout;\n  int r;\n  int ran_pending;\n\n  // 是否还存在alive的事件\n  r = uv__loop_alive(loop);\n  if (!r)\n    uv__update_time(loop); // 存在的话更新当前的时间，可以把这个时间理解为libuv里面统一的时间，方便触发定时任务\n\n  while (r != 0 && loop->stop_flag == 0) {\n    uv__update_time(loop); // 和libuv图里的 Update loop time对应\n    uv__run_timers(loop); // 执行 timers 阶段\n    ran_pending = uv__run_pending(loop); // 执行pending 阶段；返回0表示空，1表示有；\n    uv__run_idle(loop); // idle 阶段； Node.js里面不太关心\n    uv__run_prepare(loop); // prepare 阶段； Node.js里面不太关心\n\n    timeout = 0; // 初始化阻塞 poll 阶段的超时时间\n    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)\n      timeout = uv_backend_timeout(loop); // 算出阻塞 poll 阶段的超时时间\n    // 根据timers里最近的超时时间算出一个差值 diff = loop.time - min.timeout\n    // 如果 diff >= 0 , timeout = 0\n    // 否则 timeout = min(diff, INT_MAX)\n    \n    uv__io_poll(loop, timeout); // 执行 poll 阶段\n    uv__run_check(loop); // 执行 check 阶段\n    uv__run_closing_handles(loop); // 执行 close 阶段\n\n    // mode 默认 UV_RUN_DEFAULT 所以不执行下面\n    if (mode == UV_RUN_ONCE) {\n      uv__update_time(loop);\n      uv__run_timers(loop);\n    }\n\n    // 查看是否还有alive事件\n    r = uv__loop_alive(loop);\n    if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)\n      break;\n  }\n\n  /* The if statement lets gcc compile it to a conditional store. Avoids\n   * dirtying a cache line.\n   */\n  if (loop->stop_flag != 0)\n    loop->stop_flag = 0;\n\n  return r;\n}\n```\n\n上述`uv_run`方法同样表达了之前图的循环流程，接下来我们看看各个阶段的具体执行方法。\n\n<br/>\n\n```c\nvoid uv__run_timers(uv_loop_t* loop) {\n  struct heap_node* heap_node; // timers 里的都是按照最小堆存放的\n  uv_timer_t* handle;\n\n  for (;;) {\n    heap_node = heap_min(timer_heap(loop)); // 从堆顶取出一个\n    if (heap_node == NULL) // 不存在就退出\n      break;\n\n    handle = container_of(heap_node, uv_timer_t, heap_node); \n    if (handle->timeout > loop->time) // 触发时间没达到也退出\n      break;\n\n    uv_timer_stop(handle);\n    uv_timer_again(handle);\n    \n    handle->timer_cb(handle); // 执行回调\n  }\n}\n```\n\ntimers里存放的事件都是最小堆的数据结构排列的，不断的取出根节点比较当前的`loop->time`就能知道是执行还是退出，**那么这里的`handle->timer_cb`是我们平时JavaScript里的setTimeout回调吗？**后续解答\n\n<br/>\n\n```c\nstatic int uv__run_pending(uv_loop_t* loop) {\n  QUEUE* q;\n  QUEUE pq;\n  uv__io_t* w;\n\n  if (QUEUE_EMPTY(&loop->pending_queue))\n    return 0;\n\n  QUEUE_MOVE(&loop->pending_queue, &pq);\n\n  while (!QUEUE_EMPTY(&pq)) { // 双向链表，为空就跳出\n    q = QUEUE_HEAD(&pq);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n    w = QUEUE_DATA(q, uv__io_t, pending_queue);\n    w->cb(loop, w, POLLOUT); // 执行回调\n  }\n\n  return 1;\n}\n```\n\nlibuv里面事件很多是由双向链表构建而成，等着被一个个执行，双向链表的好处就是插入很容易。\n\n<br/>\n\n```c\n#define UV_LOOP_WATCHER_DEFINE(name, type)                                    \\\n\tvoid uv__run_##name(uv_loop_t* loop) {                                      \\\n    uv_##name##_t* h;                                                         \\\n    QUEUE queue;                                                              \\\n    QUEUE* q;                                                                 \\\n    QUEUE_MOVE(&loop->name##_handles, &queue);                                \\\n    while (!QUEUE_EMPTY(&queue)) {                                            \\\n      q = QUEUE_HEAD(&queue);                                                 \\\n      h = QUEUE_DATA(q, uv_##name##_t, queue);                                \\\n      QUEUE_REMOVE(q);                                                        \\\n      QUEUE_INSERT_TAIL(&loop->name##_handles, q);                            \\\n      h->name##_cb(h);                                                        \\\n    }                                                                         \\\n  }     \n\nUV_LOOP_WATCHER_DEFINE(prepare, PREPARE)\nUV_LOOP_WATCHER_DEFINE(check, CHECK)\nUV_LOOP_WATCHER_DEFINE(idle, IDLE)\n```\n\n`UV_LOOP_WATCHER_DEFINE`宏直接初始化了`prepare`、`check`和`idle`3个阶段，都是双向链表。\n\n<br/>\n\n```c\n// uv__io_poll 太长了，不重要的代码已经移除\nvoid uv__io_poll(uv_loop_t* loop, int timeout) {\n  // ...\n  if (loop->nfds == 0) { // 没有需要执行的 直接退出\n    assert(QUEUE_EMPTY(&loop->watcher_queue));\n    return;\n  }\n\n  // 将loop->watcher_queue列队里的待观察的文件描述符绑定到epoll上\n  while (!QUEUE_EMPTY(&loop->watcher_queue)) {\n    q = QUEUE_HEAD(&loop->watcher_queue);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n\n    w = QUEUE_DATA(q, uv__io_t, watcher_queue);\n    // ...\n    if (w->events == 0)\n      op = EPOLL_CTL_ADD; // 添加\n    else\n      op = EPOLL_CTL_MOD; // 修改\n\n    epoll_ctl(loop->backend_fd, op, w->fd, &e) // epoll_ctl 底层的系统函数，将文件描述符关联起来\n\n    w->events = w->pevents;\n  }\n\n  sigmask = 0;\n  if (loop->flags & UV_LOOP_BLOCK_SIGPROF) {\n    sigemptyset(&sigset);\n    sigaddset(&sigset, SIGPROF);\n    sigmask |= 1 << (SIGPROF - 1);\n  }\n\n  base = loop->time;\n  real_timeout = timeout;\n\n  for (;;) {\n    nfds = epoll_wait(loop->backend_fd,\n                        events,\n                        ARRAY_SIZE(events),\n                        timeout);\n    \n    if (nfds == 0) { // 超时，没有新的事件准备好\n      assert(timeout != -1); // -1 表示不会超时，而nfds为0表示超时，存在矛盾所以抛出异常\n      if (timeout == 0) // 退出\n        return;\n      \n      goto update_timeout; // 重新更新时间 准备下次循环 epoll_wait \n    }\n\n    if (nfds == -1) { // 出错\n      if (errno == ENOSYS) {\n        /* epoll_wait() or epoll_pwait() failed, try the other system call. */\n        assert(no_epoll_wait == 0 || no_epoll_pwait == 0);\n        continue;\n      }\n\n      if (errno != EINTR)\n        abort();\n\n      if (timeout == -1)\n        continue;\n\n      if (timeout == 0)\n        return;\n\n      goto update_timeout;\n    }\n\n    have_signals = 0;\n    nevents = 0;\n\n    loop->watchers[loop->nwatchers] = (void*) events;\n    loop->watchers[loop->nwatchers + 1] = (void*) (uintptr_t) nfds;\n    for (i = 0; i < nfds; i++) {\n      pe = events + i;\n      fd = pe->data.fd;\n      w = loop->watchers[fd];\n      w->cb(loop, w, pe->events); // 这个for循环很长，这里我简化了，其实就是准备好的IO就执行回调\n    }\n\n    if (timeout == 0)\n      return;\n\n    if (timeout == -1)\n      continue;\n\nupdate_timeout:\n    assert(timeout > 0);\n\n    real_timeout -= (loop->time - base);\n    if (real_timeout <= 0)\n      return;\n\n    timeout = real_timeout;\n  }\n}\n```\n\n`uv__io_poll`里的timeout参数是根据`timers`里的最近一次定时时间计算出来的。方法内部使用了`epoll`，是IO多路复用的一个概念。一共有三种：`select`、`poll`和`epoll`。\n\n> epoll是[Linux内核](https://baike.baidu.com/item/Linux内核)为处理大批量[文件描述符](https://baike.baidu.com/item/文件描述符/9809582)而作了改进的poll，是Linux下多路复用IO接口select/poll的增强版本，它能显著提高程序在大量[并发连接](https://baike.baidu.com/item/并发连接/3763280)中只有少量活跃的情况下的系统[CPU](https://baike.baidu.com/item/CPU/120556)利用率。另一点原因就是获取事件的时候，它无须遍历整个被侦听的描述符集，只要遍历那些被内核IO事件异步唤醒而加入Ready队列的描述符集合就行了。epoll除了提供select/poll那种IO事件的水平触发（Level Triggered）外，还提供了边缘触发（Edge Triggered），这就使得用户空间程序有可能缓存IO状态，减少epoll_wait/epoll_pwait的调用，提高应用程序效率。 ——百度百科\n\n我觉得libuv使用epoll主要是因为支持其自身的异步特点\n\n- epoll监控的文件描述符远远大于select/poll\n- 在大量并发的时候epoll性能远远高于select/poll，而少量异步select/poll相对好点。Node.js利用了libuv的高并发特点。\n\n<br/>\n\n```c\nstatic void uv__run_closing_handles(uv_loop_t* loop) {\n  uv_handle_t* p;\n  uv_handle_t* q;\n\n  p = loop->closing_handles;\n  loop->closing_handles = NULL;\n\n  while (p) {\n    q = p->next_closing;\n    uv__finish_close(p);\n    p = q;\n  }\n}\n```\n\n一个个触发`close`回调\n\n<br/>\n\n上述就是libuv各个阶段的大体流程，`poll`最为复杂，还有很多东西可以留着细品。\n\n<br/>\n\n<br/>\n\n\n\n## Node.js setTimeout\n\n上文中提到**那么这里的`handle->timer_cb`是我们平时JavaScript里的setTimeout回调吗？回答：不是的**\n\n看看Node.js里面如何具体实现这个`setTimemout`方法的\n\n```javascript\nfunction setTimeout(callback, after, arg1, arg2, arg3) {\n  var args = [arg1, arg2, arg3]; // 简化了代码\n  const timeout = new Timeout(callback, after, args, false);\n  active(timeout);\n\n  return timeout;\n}\nfunction Timeout(callback, after, args, isRepeat) {\n  // 省略了部分代码\n  after *= 1; \n  if (!(after >= 1 && after <= TIMEOUT_MAX)) {\n    after = 1; // 定时验证不过 就为1 \n  }\n  this._idleTimeout = after;\n  this._onTimeout = callback;\n  this._timerArgs = args;\n}\nfunction active(item) {\n  insert(item, true, getLibuvNow());  // getLibuvNow 获取 loop->time时间\n}\nfunction insert(item, refed, start) {\n  let msecs = item._idleTimeout;\n  if (msecs < 0 || msecs === undefined)\n    return;\n\n  // Truncate so that accuracy of sub-millisecond timers is not assumed.\n  msecs = Math.trunc(msecs);\n\n  item._idleStart = start;\n\n  // Use an existing list if there is one, otherwise we need to make a new one.\n  // timerListMap 是一个键值对，key 是定时时间，value 是一个TimersList\n  var list = timerListMap[msecs];\n  if (list === undefined) {\n    const expiry = start + msecs; // 过期时间\n    timerListMap[msecs] = list = new TimersList(expiry, msecs); // 双向链表\n    timerListQueue.insert(list); // timerListQueue 用数组实现的最小堆\n\n    if (nextExpiry > expiry) {\n      scheduleTimer(msecs); // 如果此次定时任务的有效时间小的话，调用 V8 scheduleTimer\n      nextExpiry = expiry;\n    }\n  }\n  // ... 这边简略代码\n  L.append(list, item); // 将setTimeout创建的Timeout对象添加到list尾部\n}\n```\n\n通过上述代码，我们也可以看出JavaScript层面也有一个维护timers的最小堆，并没有吧具体的某个setTimeout注册到V8里面，只是将定时时间告诉了V8`scheduleTimer(msecs);`，下面是V8相关代码。\n\n```c\n// timers.cc\nvoid ScheduleTimer(const FunctionCallbackInfo<Value>& args) {\n  auto env = Environment::GetCurrent(args);\n  env->ScheduleTimer(args[0]->IntegerValue(env->context()).FromJust());\n}\n// env.cc\nvoid Environment::ScheduleTimer(int64_t duration_ms) {\n  if (started_cleanup_) return;\n  uv_timer_start(timer_handle(), RunTimers, duration_ms, 0);\n}\nvoid Environment::RunTimers(uv_timer_t* handle) {\n  Environment* env = Environment::from_timer_handle(handle);\n  \n  // timers_callback_function 从何而来呢？\n  Local<Function> cb = env->timers_callback_function();\n  do {\n    ret = cb->Call(env->context(), process, 1, &arg);\n  } while (ret.IsEmpty() && env->can_call_into_js());\n}\n// uv/timer.c\nint uv_timer_start(uv_timer_t* handle,\n                   uv_timer_cb cb,\n                   uint64_t timeout,\n                   uint64_t repeat) {\n  // 给uv_timer_t对象初始化相关属性\n  // 并没有JavaScript层面的回调方法，具体的回调也只是C++的RunTimers\n  handle->timer_cb = cb;\n  handle->timeout = clamped_timeout;\n  handle->repeat = repeat;\n  handle->start_id = handle->loop->timer_counter++;\n\n  // 将uv_timer_t添加到timer_heap上\n  heap_insert(timer_heap(handle->loop),\n              (struct heap_node*) &handle->heap_node,\n              timer_less_than);\n  uv__handle_start(handle);\n\n  return 0;\n}\n\n```\n\n**V8部分注册在timers阶段的是一个C++的回调方法**，其内部是执行`timers_callback_function`方法，它从何来来？\n\n```c++\n// timers.cc\nvoid SetupTimers(const FunctionCallbackInfo<Value>& args) {\n  CHECK(args[0]->IsFunction());\n  CHECK(args[1]->IsFunction());\n  auto env = Environment::GetCurrent(args);\n\n  env->set_immediate_callback_function(args[0].As<Function>()); // 注册了immediate回调\n  env->set_timers_callback_function(args[1].As<Function>()); // 注册了timers回调\n}\n```\n\n```javascript\n// node.js\nconst {\n  setupTaskQueue,\n  queueMicrotask\n} = require('internal/process/task_queues');\nconst { nextTick, runNextTicks } = setupTaskQueue();\nprocess.nextTick = nextTick;\nprocess._tickCallback = runNextTicks;\n\nconst { getTimerCallbacks } = require('internal/timers');\nconst { setupTimers } = internalBinding('timers'); // c++ SetupTimers 方法传到了JavaScript层\nconst { processImmediate, processTimers } = getTimerCallbacks(runNextTicks);\nsetupTimers(processImmediate, processTimers);\n```\n\n我们通过上述代码看到在`node.js`里面会将`processImmediate`和`processTimers`这两个JavaScript方法注册到对应的C++回调里，之后执行`timers_callback_function`其实就是执行`processTimers`方法。\n\n另外，需要注意`微任务`相关的代码会被带到`getTimerCallbacks`。\n\n```javascript\nfunction getTimerCallbacks(runNextTicks) {\n  function processImmediate() {\n    // 之后文章在做介绍\n  }\n\n\n  function processTimers(now) {\n    nextExpiry = Infinity;\n\n    let list;\n    let ranAtLeastOneList = false;\n    while (list = timerListQueue.peek()) {\n      if (list.expiry > now) { // 当前列表的过期时间大于now(libuv loop->time), 还没有到过期或到触发时间\n        nextExpiry = list.expiry; // nextExpiry 设置为 当前列表的过期时间\n        return refCount > 0 ? nextExpiry : -nextExpiry;\n      }\n      if (ranAtLeastOneList)\n        runNextTicks(); // 微任务会被触发\n      else\n        ranAtLeastOneList = true;\n      listOnTimeout(list, now);\n    }\n    return 0;\n  }\n\n  function listOnTimeout(list, now) {\n    const msecs = list.msecs;\n\n    debug('timeout callback %d', msecs);\n\n    var diff, timer;\n    let ranAtLeastOneTimer = false;\n    while (timer = L.peek(list)) { // 如果不是一个空的list，持续执行\n      // _idleStart 是插入libuv (loop->time)的时间\n      // now 是当前libuv 执行此次callback的时间\n      diff = now - timer._idleStart; \n\n      // Check if this loop iteration is too early for the next timer.\n      // This happens if there are more timers scheduled for later in the list.\n      if (diff < msecs) {\n        list.expiry = Math.max(timer._idleStart + msecs, now + 1);\n        list.id = timerListId++;\n        timerListQueue.percolateDown(1);\n        debug('%d list wait because diff is %d', msecs, diff);\n        return;\n      }\n\n      if (ranAtLeastOneTimer)\n        runNextTicks(); // 微任务会被触发\n      else\n        ranAtLeastOneTimer = true;\n\n      // The actual logic for when a timeout happens.\n      L.remove(timer);\n\n      const asyncId = timer[async_id_symbol];\n      if (!timer._onTimeout) {\n        continue;\n      }\n      try {\n        const args = timer._timerArgs;\n        if (args === undefined)\n          timer._onTimeout(); // _onTimeout setTimeout 回调\n        else\n          timer._onTimeout(...args);\n      } finally {\n        // ...\n      }\n    }\n    if (list === timerListMap[msecs]) {\n      delete timerListMap[msecs];\n      timerListQueue.shift();\n    }\n  }\n\n  return {\n    processImmediate,\n    processTimers\n  };\n}\n```\n\n上述代码很长，但是很容易理解，就是根据`libuv`的时间，将到期的定时任务一一执行了，格外需要注意的是微任务的执行`runNextTicks`，**每次setTimeout的callback之后都会将`微任务`清空，而不是网上很多文章说的timer阶段之后将微任务清空，这个改动在Node.js 11版本**\n\n> Timers\n> Interval timers will be rescheduled even if previous interval threw an error. #20002\n> **nextTick queue will be run after each immediate and timer. [#22842](https://github.com/nodejs/node/pull/22842)**\n\n具体的原因是希望和浏览器里的行为更为一直，下面的代码在11之前和之后的执行结果略有不同。\n\n```javascript\nsetTimeout(() => {\n  console.log('time1');\n  Promise.resolve().then(() => {\n    console.log('promise1');\n  });\n});\n\nsetTimeout(() => {\n  console.log('time2');\n  Promise.resolve().then(() => {\n    console.log('promise2');\n  });\n});\n\n/* 11之后\ntime1\npromise1\ntime2\npromise2\n*/\n\n/* 11之前\ntime1\ntime2\npromise1\npromise2\n*/\n\n```\n\n\n\n<br/>\n\n<br/>\n\n## 总结\n\n至此，libuv和Node.js EventLoop关于`各个阶段`和`setTimeout`的实现已经做了简单介绍。具体的还是需要看各自版本的代码而定，不能轻易去“相信”网上的介绍，比如最后一个例子就很容易在不同版本出现不同的执行结果。之后，有时间介绍 `nextTick`的回调实现，这个比较复杂。","slug":"v8-libuv-timer-event-loop","published":1,"updated":"2020-07-07T10:11:25.590Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6u001fd12ix22cpydf","content":"<p>在网络上查询<a href=\"https://libuv.org/\" target=\"_blank\" rel=\"noopener\">libuv</a>和EventLoop相关信息的时候，经常看到不同的文章所表达的意思差距较多，主要原因有二吧：</p>\n<ul>\n<li>它们的<code>libuv</code>和<code>V8</code>大版本不同，导致具体的实现略有差异</li>\n<li>另外它们的代码错综复杂，又是大多数JavaScript工作者不擅长的C/C++，只是从上而下的看，或许一些细节无法完全理解或是认知的分歧</li>\n</ul>\n<p>与其受他人影响，不如自己来好好梳理下。</p>\n<p><strong>版本</strong></p>\n<figure class=\"highlight c++ hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// libuv</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// V8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// Node.js</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p>没有列出具体版本号的代码分析都是耍流氓，2010年的代码和2020年的代码可能差距甚远，“上古”分析固然在当时是对的，但是在今日也许是错误的。</p>\n<a id=\"more\"></a>\n<p><br></p>\n<p><br></p>\n<h3 id=\"libuv-amp-EventLoop文档比较\"><a href=\"#libuv-amp-EventLoop文档比较\" class=\"headerlink\" title=\"libuv &amp; EventLoop文档比较\"></a>libuv &amp; EventLoop文档比较</h3><p><img src=\"/images/v8-libuv-timer-event-loop/loop_iteration.png\" alt=\"_images/loop_iteration.png\"></p>\n<p>上图出自<code>libuv</code>的<a href=\"http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop\" target=\"_blank\" rel=\"noopener\">The I/O loop</a>介绍，具体的信息可以看其文档。</p>\n<p><img src=\"/images/v8-libuv-timer-event-loop/image-20200301145547994.png\" alt=\"image-20200301145547994\"></p>\n<p>上图出自<a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained\" target=\"_blank\" rel=\"noopener\">Event Loop Explained</a>，两者的各个阶段基本是对应的。哪怕是很多其它自行画的图解中，也基本差不多，但唯独<code>pending callbacks</code>阶段，我看到很多文章里面把它标为<code>I/O callbacks</code>，不知道是不是历史原因，但是就从二者的目前文档解释来看是不妥的。</p>\n<blockquote>\n<p>Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point. —— libuv</p>\n</blockquote>\n<p><strong>libuv</strong>里的<code>pending callbacks</code>：大多数的I/O callbacks应该在polling阶段完成，有部分会被延迟到下一个pending callbacks阶段执行。</p>\n<p><br></p>\n<blockquote>\n<p>This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives <code>ECONNREFUSED</code> when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the <strong>pending callbacks</strong> phase. —— Node.js</p>\n</blockquote>\n<p><strong>Node.js</strong>里的<code>pending callbacks</code>：这个阶段会执行系统上发生的一些错误而导致的callbacks，如TCP错误。</p>\n<p>我觉得<code>pending callbacks</code>比较合理，一方面如libuv所说，它是一部分延迟的I/O回调，在Node.js里面指的是一些系统上的错误（这些错误也是I/O引起的）。而大多数的I/O操作其实是在 <code>poll</code>阶段。</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"libuv的大致流程代码\"><a href=\"#libuv的大致流程代码\" class=\"headerlink\" title=\"libuv的大致流程代码\"></a>libuv的大致流程代码</h2><figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">uv_run</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop, uv_run_mode mode)</span> </span>&#123; <span class=\"hljs-comment\">// 默认 mode 是 UV_RUN_DEFAULT</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">int</span> timeout;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">int</span> r;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">int</span> ran_pending;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 是否还存在alive的事件</span></span><br><span class=\"line\">  r = uv__loop_alive(loop);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!r)</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"hljs-comment\">// 存在的话更新当前的时间，可以把这个时间理解为libuv里面统一的时间，方便触发定时任务</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (r != <span class=\"hljs-number\">0</span> &amp;&amp; loop-&gt;stop_flag == <span class=\"hljs-number\">0</span>) &#123;</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"hljs-comment\">// 和libuv图里的 Update loop time对应</span></span><br><span class=\"line\">    uv__run_timers(loop); <span class=\"hljs-comment\">// 执行 timers 阶段</span></span><br><span class=\"line\">    ran_pending = uv__run_pending(loop); <span class=\"hljs-comment\">// 执行pending 阶段；返回0表示空，1表示有；</span></span><br><span class=\"line\">    uv__run_idle(loop); <span class=\"hljs-comment\">// idle 阶段； Node.js里面不太关心</span></span><br><span class=\"line\">    uv__run_prepare(loop); <span class=\"hljs-comment\">// prepare 阶段； Node.js里面不太关心</span></span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// 初始化阻塞 poll 阶段的超时时间</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> ((mode == UV_RUN_ONCE &amp;&amp; !ran_pending) || mode == UV_RUN_DEFAULT)</span><br><span class=\"line\">      timeout = uv_backend_timeout(loop); <span class=\"hljs-comment\">// 算出阻塞 poll 阶段的超时时间</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// 根据timers里最近的超时时间算出一个差值 diff = loop.time - min.timeout</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// 如果 diff &gt;= 0 , timeout = 0</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// 否则 timeout = min(diff, INT_MAX)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    uv__io_poll(loop, timeout); <span class=\"hljs-comment\">// 执行 poll 阶段</span></span><br><span class=\"line\">    uv__run_check(loop); <span class=\"hljs-comment\">// 执行 check 阶段</span></span><br><span class=\"line\">    uv__run_closing_handles(loop); <span class=\"hljs-comment\">// 执行 close 阶段</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// mode 默认 UV_RUN_DEFAULT 所以不执行下面</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (mode == UV_RUN_ONCE) &#123;</span><br><span class=\"line\">      uv__update_time(loop);</span><br><span class=\"line\">      uv__run_timers(loop);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// 查看是否还有alive事件</span></span><br><span class=\"line\">    r = uv__loop_alive(loop);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* The if statement lets gcc compile it to a conditional store. Avoids</span></span><br><span class=\"line\"><span class=\"hljs-comment\">   * dirtying a cache line.</span></span><br><span class=\"line\"><span class=\"hljs-comment\">   */</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (loop-&gt;stop_flag != <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">    loop-&gt;stop_flag = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> r;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述<code>uv_run</code>方法同样表达了之前图的循环流程，接下来我们看看各个阶段的具体执行方法。</p>\n<p><br></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">uv__run_timers</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">heap_node</span>* <span class=\"hljs-title\">heap_node</span>;</span> <span class=\"hljs-comment\">// timers 里的都是按照最小堆存放的</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">uv_timer_t</span>* handle;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    heap_node = heap_min(timer_heap(loop)); <span class=\"hljs-comment\">// 从堆顶取出一个</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (heap_node == <span class=\"hljs-literal\">NULL</span>) <span class=\"hljs-comment\">// 不存在就退出</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    handle = container_of(heap_node, <span class=\"hljs-keyword\">uv_timer_t</span>, heap_node); </span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (handle-&gt;timeout &gt; loop-&gt;time) <span class=\"hljs-comment\">// 触发时间没达到也退出</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    uv_timer_stop(handle);</span><br><span class=\"line\">    uv_timer_again(handle);</span><br><span class=\"line\">    </span><br><span class=\"line\">    handle-&gt;timer_cb(handle); <span class=\"hljs-comment\">// 执行回调</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>timers里存放的事件都是最小堆的数据结构排列的，不断的取出根节点比较当前的<code>loop-&gt;time</code>就能知道是执行还是退出，<strong>那么这里的<code>handle-&gt;timer_cb</code>是我们平时JavaScript里的setTimeout回调吗？</strong>后续解答</p>\n<p><br></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">uv__run_pending</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  QUEUE* q;</span><br><span class=\"line\">  QUEUE pq;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">uv__io_t</span>* w;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (QUEUE_EMPTY(&amp;loop-&gt;pending_queue))</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  QUEUE_MOVE(&amp;loop-&gt;pending_queue, &amp;pq);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (!QUEUE_EMPTY(&amp;pq)) &#123; <span class=\"hljs-comment\">// 双向链表，为空就跳出</span></span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;pq);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"hljs-keyword\">uv__io_t</span>, pending_queue);</span><br><span class=\"line\">    w-&gt;cb(loop, w, POLLOUT); <span class=\"hljs-comment\">// 执行回调</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>libuv里面事件很多是由双向链表构建而成，等着被一个个执行，双向链表的好处就是插入很容易。</p>\n<p><br></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_LOOP_WATCHER_DEFINE(name, type)                                    \\</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">void</span> uv__run_#<span class=\"hljs-meta\">#name(uv_loop_t* loop) &#123;                                      \\</span></span><br><span class=\"line\">    uv_#<span class=\"hljs-meta\">#name##_t* h;                                                         \\</span></span><br><span class=\"line\">    QUEUE <span class=\"hljs-built_in\">queue</span>;                                                              \\</span><br><span class=\"line\">    QUEUE* q;                                                                 \\</span><br><span class=\"line\">    QUEUE_MOVE(&amp;loop-&gt;name##_handles, &amp;<span class=\"hljs-built_in\">queue</span>);                                \\</span><br><span class=\"line\">    <span class=\"hljs-keyword\">while</span> (!QUEUE_EMPTY(&amp;<span class=\"hljs-built_in\">queue</span>)) &#123;                                            \\</span><br><span class=\"line\">      q = QUEUE_HEAD(&amp;<span class=\"hljs-built_in\">queue</span>);                                                 \\</span><br><span class=\"line\">      h = QUEUE_DATA(q, uv_##name##<span class=\"hljs-keyword\">_t</span>, <span class=\"hljs-built_in\">queue</span>);                                \\</span><br><span class=\"line\">      QUEUE_REMOVE(q);                                                        \\</span><br><span class=\"line\">      QUEUE_INSERT_TAIL(&amp;loop-&gt;name##_handles, q);                            \\</span><br><span class=\"line\">      h-&gt;name##_cb(h);                                                        \\</span><br><span class=\"line\">    &#125;                                                                         \\</span><br><span class=\"line\">  &#125;     </span><br><span class=\"line\"></span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(prepare, PREPARE)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(check, CHECK)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(idle, IDLE)</span><br></pre></td></tr></table></figure>\n<p><code>UV_LOOP_WATCHER_DEFINE</code>宏直接初始化了<code>prepare</code>、<code>check</code>和<code>idle</code>3个阶段，都是双向链表。</p>\n<p><br></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// uv__io_poll 太长了，不重要的代码已经移除</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">uv__io_poll</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop, <span class=\"hljs-keyword\">int</span> timeout)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (loop-&gt;nfds == <span class=\"hljs-number\">0</span>) &#123; <span class=\"hljs-comment\">// 没有需要执行的 直接退出</span></span><br><span class=\"line\">    assert(QUEUE_EMPTY(&amp;loop-&gt;watcher_queue));</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 将loop-&gt;watcher_queue列队里的待观察的文件描述符绑定到epoll上</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (!QUEUE_EMPTY(&amp;loop-&gt;watcher_queue)) &#123;</span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;loop-&gt;watcher_queue);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\"></span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"hljs-keyword\">uv__io_t</span>, watcher_queue);</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (w-&gt;events == <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      op = EPOLL_CTL_ADD; <span class=\"hljs-comment\">// 添加</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">      op = EPOLL_CTL_MOD; <span class=\"hljs-comment\">// 修改</span></span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_ctl(loop-&gt;backend_fd, op, w-&gt;fd, &amp;e) <span class=\"hljs-comment\">// epoll_ctl 底层的系统函数，将文件描述符关联起来</span></span><br><span class=\"line\"></span><br><span class=\"line\">    w-&gt;events = w-&gt;pevents;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  sigmask = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (loop-&gt;flags &amp; UV_LOOP_BLOCK_SIGPROF) &#123;</span><br><span class=\"line\">    sigemptyset(&amp;sigset);</span><br><span class=\"line\">    sigaddset(&amp;sigset, SIGPROF);</span><br><span class=\"line\">    sigmask |= <span class=\"hljs-number\">1</span> &lt;&lt; (SIGPROF - <span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  base = loop-&gt;time;</span><br><span class=\"line\">  real_timeout = timeout;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    nfds = epoll_wait(loop-&gt;backend_fd,</span><br><span class=\"line\">                        events,</span><br><span class=\"line\">                        ARRAY_SIZE(events),</span><br><span class=\"line\">                        timeout);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (nfds == <span class=\"hljs-number\">0</span>) &#123; <span class=\"hljs-comment\">// 超时，没有新的事件准备好</span></span><br><span class=\"line\">      assert(timeout != <span class=\"hljs-number\">-1</span>); <span class=\"hljs-comment\">// -1 表示不会超时，而nfds为0表示超时，存在矛盾所以抛出异常</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">0</span>) <span class=\"hljs-comment\">// 退出</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"hljs-keyword\">goto</span> update_timeout; <span class=\"hljs-comment\">// 重新更新时间 准备下次循环 epoll_wait </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (nfds == <span class=\"hljs-number\">-1</span>) &#123; <span class=\"hljs-comment\">// 出错</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (errno == ENOSYS) &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">/* epoll_wait() or epoll_pwait() failed, try the other system call. */</span></span><br><span class=\"line\">        assert(no_epoll_wait == <span class=\"hljs-number\">0</span> || no_epoll_pwait == <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (errno != EINTR)</span><br><span class=\"line\">        <span class=\"hljs-built_in\">abort</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">-1</span>)</span><br><span class=\"line\">        <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">goto</span> update_timeout;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    have_signals = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">    nevents = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers] = (<span class=\"hljs-keyword\">void</span>*) events;</span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers + <span class=\"hljs-number\">1</span>] = (<span class=\"hljs-keyword\">void</span>*) (<span class=\"hljs-keyword\">uintptr_t</span>) nfds;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; nfds; i++) &#123;</span><br><span class=\"line\">      pe = events + i;</span><br><span class=\"line\">      fd = pe-&gt;data.fd;</span><br><span class=\"line\">      w = loop-&gt;watchers[fd];</span><br><span class=\"line\">      w-&gt;cb(loop, w, pe-&gt;events); <span class=\"hljs-comment\">// 这个for循环很长，这里我简化了，其实就是准备好的IO就执行回调</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">-1</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">update_timeout:</span><br><span class=\"line\">    assert(timeout &gt; <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    real_timeout -= (loop-&gt;time - base);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (real_timeout &lt;= <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = real_timeout;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>uv__io_poll</code>里的timeout参数是根据<code>timers</code>里的最近一次定时时间计算出来的。方法内部使用了<code>epoll</code>，是IO多路复用的一个概念。一共有三种：<code>select</code>、<code>poll</code>和<code>epoll</code>。</p>\n<blockquote>\n<p>epoll是<a href=\"https://baike.baidu.com/item/Linux内核\" target=\"_blank\" rel=\"noopener\">Linux内核</a>为处理大批量<a href=\"https://baike.baidu.com/item/文件描述符/9809582\" target=\"_blank\" rel=\"noopener\">文件描述符</a>而作了改进的poll，是Linux下多路复用IO接口select/poll的增强版本，它能显著提高程序在大量<a href=\"https://baike.baidu.com/item/并发连接/3763280\" target=\"_blank\" rel=\"noopener\">并发连接</a>中只有少量活跃的情况下的系统<a href=\"https://baike.baidu.com/item/CPU/120556\" target=\"_blank\" rel=\"noopener\">CPU</a>利用率。另一点原因就是获取事件的时候，它无须遍历整个被侦听的描述符集，只要遍历那些被内核IO事件异步唤醒而加入Ready队列的描述符集合就行了。epoll除了提供select/poll那种IO事件的水平触发（Level Triggered）外，还提供了边缘触发（Edge Triggered），这就使得用户空间程序有可能缓存IO状态，减少epoll_wait/epoll_pwait的调用，提高应用程序效率。 ——百度百科</p>\n</blockquote>\n<p>我觉得libuv使用epoll主要是因为支持其自身的异步特点</p>\n<ul>\n<li>epoll监控的文件描述符远远大于select/poll</li>\n<li>在大量并发的时候epoll性能远远高于select/poll，而少量异步select/poll相对好点。Node.js利用了libuv的高并发特点。</li>\n</ul>\n<p><br></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">uv__run_closing_handles</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">uv_handle_t</span>* p;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">uv_handle_t</span>* q;</span><br><span class=\"line\"></span><br><span class=\"line\">  p = loop-&gt;closing_handles;</span><br><span class=\"line\">  loop-&gt;closing_handles = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (p) &#123;</span><br><span class=\"line\">    q = p-&gt;next_closing;</span><br><span class=\"line\">    uv__finish_close(p);</span><br><span class=\"line\">    p = q;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一个个触发<code>close</code>回调</p>\n<p><br></p>\n<p>上述就是libuv各个阶段的大体流程，<code>poll</code>最为复杂，还有很多东西可以留着细品。</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"Node-js-setTimeout\"><a href=\"#Node-js-setTimeout\" class=\"headerlink\" title=\"Node.js setTimeout\"></a>Node.js setTimeout</h2><p>上文中提到<strong>那么这里的<code>handle-&gt;timer_cb</code>是我们平时JavaScript里的setTimeout回调吗？回答：不是的</strong></p>\n<p>看看Node.js里面如何具体实现这个<code>setTimemout</code>方法的</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">setTimeout</span>(<span class=\"hljs-params\">callback, after, arg1, arg2, arg3</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> args = [arg1, arg2, arg3]; <span class=\"hljs-comment\">// 简化了代码</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> timeout = <span class=\"hljs-keyword\">new</span> Timeout(callback, after, args, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">  active(timeout);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> timeout;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">Timeout</span>(<span class=\"hljs-params\">callback, after, args, isRepeat</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// 省略了部分代码</span></span><br><span class=\"line\">  after *= <span class=\"hljs-number\">1</span>; </span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!(after &gt;= <span class=\"hljs-number\">1</span> &amp;&amp; after &lt;= TIMEOUT_MAX)) &#123;</span><br><span class=\"line\">    after = <span class=\"hljs-number\">1</span>; <span class=\"hljs-comment\">// 定时验证不过 就为1 </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>._idleTimeout = after;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>._onTimeout = callback;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>._timerArgs = args;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">active</span>(<span class=\"hljs-params\">item</span>) </span>&#123;</span><br><span class=\"line\">  insert(item, <span class=\"hljs-literal\">true</span>, getLibuvNow());  <span class=\"hljs-comment\">// getLibuvNow 获取 loop-&gt;time时间</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">insert</span>(<span class=\"hljs-params\">item, refed, start</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> msecs = item._idleTimeout;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (msecs &lt; <span class=\"hljs-number\">0</span> || msecs === <span class=\"hljs-literal\">undefined</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Truncate so that accuracy of sub-millisecond timers is not assumed.</span></span><br><span class=\"line\">  msecs = <span class=\"hljs-built_in\">Math</span>.trunc(msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">  item._idleStart = start;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Use an existing list if there is one, otherwise we need to make a new one.</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// timerListMap 是一个键值对，key 是定时时间，value 是一个TimersList</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> list = timerListMap[msecs];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (list === <span class=\"hljs-literal\">undefined</span>) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> expiry = start + msecs; <span class=\"hljs-comment\">// 过期时间</span></span><br><span class=\"line\">    timerListMap[msecs] = list = <span class=\"hljs-keyword\">new</span> TimersList(expiry, msecs); <span class=\"hljs-comment\">// 双向链表</span></span><br><span class=\"line\">    timerListQueue.insert(list); <span class=\"hljs-comment\">// timerListQueue 用数组实现的最小堆</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (nextExpiry &gt; expiry) &#123;</span><br><span class=\"line\">      scheduleTimer(msecs); <span class=\"hljs-comment\">// 如果此次定时任务的有效时间小的话，调用 V8 scheduleTimer</span></span><br><span class=\"line\">      nextExpiry = expiry;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... 这边简略代码</span></span><br><span class=\"line\">  L.append(list, item); <span class=\"hljs-comment\">// 将setTimeout创建的Timeout对象添加到list尾部</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过上述代码，我们也可以看出JavaScript层面也有一个维护timers的最小堆，并没有吧具体的某个setTimeout注册到V8里面，只是将定时时间告诉了V8<code>scheduleTimer(msecs);</code>，下面是V8相关代码。</p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">ScheduleTimer</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">auto</span> env = Environment::GetCurrent(args);</span><br><span class=\"line\">  env-&gt;ScheduleTimer(args[<span class=\"hljs-number\">0</span>]-&gt;IntegerValue(env-&gt;context()).FromJust());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// env.cc</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">void</span> Environment::ScheduleTimer(<span class=\"hljs-keyword\">int64_t</span> duration_ms) &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (started_cleanup_) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  uv_timer_start(timer_handle(), RunTimers, duration_ms, <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-keyword\">void</span> Environment::RunTimers(<span class=\"hljs-keyword\">uv_timer_t</span>* handle) &#123;</span><br><span class=\"line\">  Environment* env = Environment::from_timer_handle(handle);</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"hljs-comment\">// timers_callback_function 从何而来呢？</span></span><br><span class=\"line\">  Local&lt;Function&gt; cb = env-&gt;timers_callback_function();</span><br><span class=\"line\">  <span class=\"hljs-keyword\">do</span> &#123;</span><br><span class=\"line\">    ret = cb-&gt;Call(env-&gt;context(), process, <span class=\"hljs-number\">1</span>, &amp;arg);</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">while</span> (ret.IsEmpty() &amp;&amp; env-&gt;can_call_into_js());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// uv/timer.c</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">uv_timer_start</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_timer_t</span>* handle,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                   uv_timer_cb cb,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                   <span class=\"hljs-keyword\">uint64_t</span> timeout,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                   <span class=\"hljs-keyword\">uint64_t</span> repeat)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// 给uv_timer_t对象初始化相关属性</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 并没有JavaScript层面的回调方法，具体的回调也只是C++的RunTimers</span></span><br><span class=\"line\">  handle-&gt;timer_cb = cb;</span><br><span class=\"line\">  handle-&gt;timeout = clamped_timeout;</span><br><span class=\"line\">  handle-&gt;repeat = repeat;</span><br><span class=\"line\">  handle-&gt;start_id = handle-&gt;loop-&gt;timer_counter++;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 将uv_timer_t添加到timer_heap上</span></span><br><span class=\"line\">  heap_insert(timer_heap(handle-&gt;loop),</span><br><span class=\"line\">              (struct heap_node*) &amp;handle-&gt;heap_node,</span><br><span class=\"line\">              timer_less_than);</span><br><span class=\"line\">  uv__handle_start(handle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>V8部分注册在timers阶段的是一个C++的回调方法</strong>，其内部是执行<code>timers_callback_function</code>方法，它从何来来？</p>\n<figure class=\"highlight c++ hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">SetupTimers</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class=\"line\">  CHECK(args[<span class=\"hljs-number\">0</span>]-&gt;IsFunction());</span><br><span class=\"line\">  CHECK(args[<span class=\"hljs-number\">1</span>]-&gt;IsFunction());</span><br><span class=\"line\">  <span class=\"hljs-keyword\">auto</span> env = Environment::GetCurrent(args);</span><br><span class=\"line\"></span><br><span class=\"line\">  env-&gt;set_immediate_callback_function(args[<span class=\"hljs-number\">0</span>].As&lt;Function&gt;()); <span class=\"hljs-comment\">// 注册了immediate回调</span></span><br><span class=\"line\">  env-&gt;set_timers_callback_function(args[<span class=\"hljs-number\">1</span>].As&lt;Function&gt;()); <span class=\"hljs-comment\">// 注册了timers回调</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// node.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123;</span><br><span class=\"line\">  setupTaskQueue,</span><br><span class=\"line\">  queueMicrotask</span><br><span class=\"line\">&#125; = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'internal/process/task_queues'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123; nextTick, runNextTicks &#125; = setupTaskQueue();</span><br><span class=\"line\">process.nextTick = nextTick;</span><br><span class=\"line\">process._tickCallback = runNextTicks;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123; getTimerCallbacks &#125; = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'internal/timers'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123; setupTimers &#125; = internalBinding(<span class=\"hljs-string\">'timers'</span>); <span class=\"hljs-comment\">// c++ SetupTimers 方法传到了JavaScript层</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123; processImmediate, processTimers &#125; = getTimerCallbacks(runNextTicks);</span><br><span class=\"line\">setupTimers(processImmediate, processTimers);</span><br></pre></td></tr></table></figure>\n<p>我们通过上述代码看到在<code>node.js</code>里面会将<code>processImmediate</code>和<code>processTimers</code>这两个JavaScript方法注册到对应的C++回调里，之后执行<code>timers_callback_function</code>其实就是执行<code>processTimers</code>方法。</p>\n<p>另外，需要注意<code>微任务</code>相关的代码会被带到<code>getTimerCallbacks</code>。</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getTimerCallbacks</span>(<span class=\"hljs-params\">runNextTicks</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">processImmediate</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// 之后文章在做介绍</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">processTimers</span>(<span class=\"hljs-params\">now</span>) </span>&#123;</span><br><span class=\"line\">    nextExpiry = <span class=\"hljs-literal\">Infinity</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> list;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> ranAtLeastOneList = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">while</span> (list = timerListQueue.peek()) &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (list.expiry &gt; now) &#123; <span class=\"hljs-comment\">// 当前列表的过期时间大于now(libuv loop-&gt;time), 还没有到过期或到触发时间</span></span><br><span class=\"line\">        nextExpiry = list.expiry; <span class=\"hljs-comment\">// nextExpiry 设置为 当前列表的过期时间</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> refCount &gt; <span class=\"hljs-number\">0</span> ? nextExpiry : -nextExpiry;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (ranAtLeastOneList)</span><br><span class=\"line\">        runNextTicks(); <span class=\"hljs-comment\">// 微任务会被触发</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneList = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">      listOnTimeout(list, now);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">listOnTimeout</span>(<span class=\"hljs-params\">list, now</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> msecs = list.msecs;</span><br><span class=\"line\"></span><br><span class=\"line\">    debug(<span class=\"hljs-string\">'timeout callback %d'</span>, msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> diff, timer;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> ranAtLeastOneTimer = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">while</span> (timer = L.peek(list)) &#123; <span class=\"hljs-comment\">// 如果不是一个空的list，持续执行</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// _idleStart 是插入libuv (loop-&gt;time)的时间</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// now 是当前libuv 执行此次callback的时间</span></span><br><span class=\"line\">      diff = now - timer._idleStart; </span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// Check if this loop iteration is too early for the next timer.</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// This happens if there are more timers scheduled for later in the list.</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (diff &lt; msecs) &#123;</span><br><span class=\"line\">        list.expiry = <span class=\"hljs-built_in\">Math</span>.max(timer._idleStart + msecs, now + <span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">        list.id = timerListId++;</span><br><span class=\"line\">        timerListQueue.percolateDown(<span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">        debug(<span class=\"hljs-string\">'%d list wait because diff is %d'</span>, msecs, diff);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (ranAtLeastOneTimer)</span><br><span class=\"line\">        runNextTicks(); <span class=\"hljs-comment\">// 微任务会被触发</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneTimer = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// The actual logic for when a timeout happens.</span></span><br><span class=\"line\">      L.remove(timer);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> asyncId = timer[async_id_symbol];</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (!timer._onTimeout) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> args = timer._timerArgs;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (args === <span class=\"hljs-literal\">undefined</span>)</span><br><span class=\"line\">          timer._onTimeout(); <span class=\"hljs-comment\">// _onTimeout setTimeout 回调</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">          timer._onTimeout(...args);</span><br><span class=\"line\">      &#125; <span class=\"hljs-keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (list === timerListMap[msecs]) &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">delete</span> timerListMap[msecs];</span><br><span class=\"line\">      timerListQueue.shift();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> &#123;</span><br><span class=\"line\">    processImmediate,</span><br><span class=\"line\">    processTimers</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码很长，但是很容易理解，就是根据<code>libuv</code>的时间，将到期的定时任务一一执行了，格外需要注意的是微任务的执行<code>runNextTicks</code>，<strong>每次setTimeout的callback之后都会将<code>微任务</code>清空，而不是网上很多文章说的timer阶段之后将微任务清空，这个改动在Node.js 11版本</strong></p>\n<blockquote>\n<p>Timers<br>Interval timers will be rescheduled even if previous interval threw an error. #20002<br><strong>nextTick queue will be run after each immediate and timer. <a href=\"https://github.com/nodejs/node/pull/22842\" target=\"_blank\" rel=\"noopener\">#22842</a></strong></p>\n</blockquote>\n<p>具体的原因是希望和浏览器里的行为更为一直，下面的代码在11之前和之后的执行结果略有不同。</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'time1'</span>);</span><br><span class=\"line\">  <span class=\"hljs-built_in\">Promise</span>.resolve().then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'promise1'</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'time2'</span>);</span><br><span class=\"line\">  <span class=\"hljs-built_in\">Promise</span>.resolve().then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'promise2'</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* 11之后</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* 11之前</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><br></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>至此，libuv和Node.js EventLoop关于<code>各个阶段</code>和<code>setTimeout</code>的实现已经做了简单介绍。具体的还是需要看各自版本的代码而定，不能轻易去“相信”网上的介绍，比如最后一个例子就很容易在不同版本出现不同的执行结果。之后，有时间介绍 <code>nextTick</code>的回调实现，这个比较复杂。</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p>在网络上查询<a href=\"https://libuv.org/\" target=\"_blank\" rel=\"noopener\">libuv</a>和EventLoop相关信息的时候，经常看到不同的文章所表达的意思差距较多，主要原因有二吧：</p>\n<ul>\n<li>它们的<code>libuv</code>和<code>V8</code>大版本不同，导致具体的实现略有差异</li>\n<li>另外它们的代码错综复杂，又是大多数JavaScript工作者不擅长的C/C++，只是从上而下的看，或许一些细节无法完全理解或是认知的分歧</li>\n</ul>\n<p>与其受他人影响，不如自己来好好梳理下。</p>\n<p><strong>版本</strong></p>\n<figure class=\"highlight c++ hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// libuv</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// V8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// Node.js</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p>没有列出具体版本号的代码分析都是耍流氓，2010年的代码和2020年的代码可能差距甚远，“上古”分析固然在当时是对的，但是在今日也许是错误的。</p>","more":"<p><br></p>\n<p><br></p>\n<h3 id=\"libuv-amp-EventLoop文档比较\"><a href=\"#libuv-amp-EventLoop文档比较\" class=\"headerlink\" title=\"libuv &amp; EventLoop文档比较\"></a>libuv &amp; EventLoop文档比较</h3><p><img src=\"/images/v8-libuv-timer-event-loop/loop_iteration.png\" alt=\"_images/loop_iteration.png\"></p>\n<p>上图出自<code>libuv</code>的<a href=\"http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop\" target=\"_blank\" rel=\"noopener\">The I/O loop</a>介绍，具体的信息可以看其文档。</p>\n<p><img src=\"/images/v8-libuv-timer-event-loop/image-20200301145547994.png\" alt=\"image-20200301145547994\"></p>\n<p>上图出自<a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained\" target=\"_blank\" rel=\"noopener\">Event Loop Explained</a>，两者的各个阶段基本是对应的。哪怕是很多其它自行画的图解中，也基本差不多，但唯独<code>pending callbacks</code>阶段，我看到很多文章里面把它标为<code>I/O callbacks</code>，不知道是不是历史原因，但是就从二者的目前文档解释来看是不妥的。</p>\n<blockquote>\n<p>Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point. —— libuv</p>\n</blockquote>\n<p><strong>libuv</strong>里的<code>pending callbacks</code>：大多数的I/O callbacks应该在polling阶段完成，有部分会被延迟到下一个pending callbacks阶段执行。</p>\n<p><br></p>\n<blockquote>\n<p>This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives <code>ECONNREFUSED</code> when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the <strong>pending callbacks</strong> phase. —— Node.js</p>\n</blockquote>\n<p><strong>Node.js</strong>里的<code>pending callbacks</code>：这个阶段会执行系统上发生的一些错误而导致的callbacks，如TCP错误。</p>\n<p>我觉得<code>pending callbacks</code>比较合理，一方面如libuv所说，它是一部分延迟的I/O回调，在Node.js里面指的是一些系统上的错误（这些错误也是I/O引起的）。而大多数的I/O操作其实是在 <code>poll</code>阶段。</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"libuv的大致流程代码\"><a href=\"#libuv的大致流程代码\" class=\"headerlink\" title=\"libuv的大致流程代码\"></a>libuv的大致流程代码</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">uv_run</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop, uv_run_mode mode)</span> </span>&#123; <span class=\"comment\">// 默认 mode 是 UV_RUN_DEFAULT</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> timeout;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> r;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> ran_pending;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 是否还存在alive的事件</span></span><br><span class=\"line\">  r = uv__loop_alive(loop);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!r)</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"comment\">// 存在的话更新当前的时间，可以把这个时间理解为libuv里面统一的时间，方便触发定时任务</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (r != <span class=\"number\">0</span> &amp;&amp; loop-&gt;stop_flag == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"comment\">// 和libuv图里的 Update loop time对应</span></span><br><span class=\"line\">    uv__run_timers(loop); <span class=\"comment\">// 执行 timers 阶段</span></span><br><span class=\"line\">    ran_pending = uv__run_pending(loop); <span class=\"comment\">// 执行pending 阶段；返回0表示空，1表示有；</span></span><br><span class=\"line\">    uv__run_idle(loop); <span class=\"comment\">// idle 阶段； Node.js里面不太关心</span></span><br><span class=\"line\">    uv__run_prepare(loop); <span class=\"comment\">// prepare 阶段； Node.js里面不太关心</span></span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = <span class=\"number\">0</span>; <span class=\"comment\">// 初始化阻塞 poll 阶段的超时时间</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((mode == UV_RUN_ONCE &amp;&amp; !ran_pending) || mode == UV_RUN_DEFAULT)</span><br><span class=\"line\">      timeout = uv_backend_timeout(loop); <span class=\"comment\">// 算出阻塞 poll 阶段的超时时间</span></span><br><span class=\"line\">    <span class=\"comment\">// 根据timers里最近的超时时间算出一个差值 diff = loop.time - min.timeout</span></span><br><span class=\"line\">    <span class=\"comment\">// 如果 diff &gt;= 0 , timeout = 0</span></span><br><span class=\"line\">    <span class=\"comment\">// 否则 timeout = min(diff, INT_MAX)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    uv__io_poll(loop, timeout); <span class=\"comment\">// 执行 poll 阶段</span></span><br><span class=\"line\">    uv__run_check(loop); <span class=\"comment\">// 执行 check 阶段</span></span><br><span class=\"line\">    uv__run_closing_handles(loop); <span class=\"comment\">// 执行 close 阶段</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// mode 默认 UV_RUN_DEFAULT 所以不执行下面</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mode == UV_RUN_ONCE) &#123;</span><br><span class=\"line\">      uv__update_time(loop);</span><br><span class=\"line\">      uv__run_timers(loop);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 查看是否还有alive事件</span></span><br><span class=\"line\">    r = uv__loop_alive(loop);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* The if statement lets gcc compile it to a conditional store. Avoids</span></span><br><span class=\"line\"><span class=\"comment\">   * dirtying a cache line.</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loop-&gt;stop_flag != <span class=\"number\">0</span>)</span><br><span class=\"line\">    loop-&gt;stop_flag = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述<code>uv_run</code>方法同样表达了之前图的循环流程，接下来我们看看各个阶段的具体执行方法。</p>\n<p><br></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">uv__run_timers</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">heap_node</span>* <span class=\"title\">heap_node</span>;</span> <span class=\"comment\">// timers 里的都是按照最小堆存放的</span></span><br><span class=\"line\">  <span class=\"keyword\">uv_timer_t</span>* handle;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    heap_node = heap_min(timer_heap(loop)); <span class=\"comment\">// 从堆顶取出一个</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (heap_node == <span class=\"literal\">NULL</span>) <span class=\"comment\">// 不存在就退出</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    handle = container_of(heap_node, <span class=\"keyword\">uv_timer_t</span>, heap_node); </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (handle-&gt;timeout &gt; loop-&gt;time) <span class=\"comment\">// 触发时间没达到也退出</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    uv_timer_stop(handle);</span><br><span class=\"line\">    uv_timer_again(handle);</span><br><span class=\"line\">    </span><br><span class=\"line\">    handle-&gt;timer_cb(handle); <span class=\"comment\">// 执行回调</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>timers里存放的事件都是最小堆的数据结构排列的，不断的取出根节点比较当前的<code>loop-&gt;time</code>就能知道是执行还是退出，<strong>那么这里的<code>handle-&gt;timer_cb</code>是我们平时JavaScript里的setTimeout回调吗？</strong>后续解答</p>\n<p><br></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">uv__run_pending</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  QUEUE* q;</span><br><span class=\"line\">  QUEUE pq;</span><br><span class=\"line\">  <span class=\"keyword\">uv__io_t</span>* w;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (QUEUE_EMPTY(&amp;loop-&gt;pending_queue))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  QUEUE_MOVE(&amp;loop-&gt;pending_queue, &amp;pq);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (!QUEUE_EMPTY(&amp;pq)) &#123; <span class=\"comment\">// 双向链表，为空就跳出</span></span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;pq);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"keyword\">uv__io_t</span>, pending_queue);</span><br><span class=\"line\">    w-&gt;cb(loop, w, POLLOUT); <span class=\"comment\">// 执行回调</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>libuv里面事件很多是由双向链表构建而成，等着被一个个执行，双向链表的好处就是插入很容易。</p>\n<p><br></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> UV_LOOP_WATCHER_DEFINE(name, type)                                    \\</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span> uv__run_#<span class=\"meta\">#name(uv_loop_t* loop) &#123;                                      \\</span></span><br><span class=\"line\">    uv_#<span class=\"meta\">#name##_t* h;                                                         \\</span></span><br><span class=\"line\">    QUEUE <span class=\"built_in\">queue</span>;                                                              \\</span><br><span class=\"line\">    QUEUE* q;                                                                 \\</span><br><span class=\"line\">    QUEUE_MOVE(&amp;loop-&gt;name##_handles, &amp;<span class=\"built_in\">queue</span>);                                \\</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (!QUEUE_EMPTY(&amp;<span class=\"built_in\">queue</span>)) &#123;                                            \\</span><br><span class=\"line\">      q = QUEUE_HEAD(&amp;<span class=\"built_in\">queue</span>);                                                 \\</span><br><span class=\"line\">      h = QUEUE_DATA(q, uv_##name##<span class=\"keyword\">_t</span>, <span class=\"built_in\">queue</span>);                                \\</span><br><span class=\"line\">      QUEUE_REMOVE(q);                                                        \\</span><br><span class=\"line\">      QUEUE_INSERT_TAIL(&amp;loop-&gt;name##_handles, q);                            \\</span><br><span class=\"line\">      h-&gt;name##_cb(h);                                                        \\</span><br><span class=\"line\">    &#125;                                                                         \\</span><br><span class=\"line\">  &#125;     </span><br><span class=\"line\"></span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(prepare, PREPARE)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(check, CHECK)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(idle, IDLE)</span><br></pre></td></tr></table></figure>\n<p><code>UV_LOOP_WATCHER_DEFINE</code>宏直接初始化了<code>prepare</code>、<code>check</code>和<code>idle</code>3个阶段，都是双向链表。</p>\n<p><br></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// uv__io_poll 太长了，不重要的代码已经移除</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">uv__io_poll</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop, <span class=\"keyword\">int</span> timeout)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loop-&gt;nfds == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// 没有需要执行的 直接退出</span></span><br><span class=\"line\">    assert(QUEUE_EMPTY(&amp;loop-&gt;watcher_queue));</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 将loop-&gt;watcher_queue列队里的待观察的文件描述符绑定到epoll上</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (!QUEUE_EMPTY(&amp;loop-&gt;watcher_queue)) &#123;</span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;loop-&gt;watcher_queue);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\"></span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"keyword\">uv__io_t</span>, watcher_queue);</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (w-&gt;events == <span class=\"number\">0</span>)</span><br><span class=\"line\">      op = EPOLL_CTL_ADD; <span class=\"comment\">// 添加</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      op = EPOLL_CTL_MOD; <span class=\"comment\">// 修改</span></span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_ctl(loop-&gt;backend_fd, op, w-&gt;fd, &amp;e) <span class=\"comment\">// epoll_ctl 底层的系统函数，将文件描述符关联起来</span></span><br><span class=\"line\"></span><br><span class=\"line\">    w-&gt;events = w-&gt;pevents;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  sigmask = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loop-&gt;flags &amp; UV_LOOP_BLOCK_SIGPROF) &#123;</span><br><span class=\"line\">    sigemptyset(&amp;sigset);</span><br><span class=\"line\">    sigaddset(&amp;sigset, SIGPROF);</span><br><span class=\"line\">    sigmask |= <span class=\"number\">1</span> &lt;&lt; (SIGPROF - <span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  base = loop-&gt;time;</span><br><span class=\"line\">  real_timeout = timeout;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    nfds = epoll_wait(loop-&gt;backend_fd,</span><br><span class=\"line\">                        events,</span><br><span class=\"line\">                        ARRAY_SIZE(events),</span><br><span class=\"line\">                        timeout);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nfds == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// 超时，没有新的事件准备好</span></span><br><span class=\"line\">      assert(timeout != <span class=\"number\">-1</span>); <span class=\"comment\">// -1 表示不会超时，而nfds为0表示超时，存在矛盾所以抛出异常</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (timeout == <span class=\"number\">0</span>) <span class=\"comment\">// 退出</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"keyword\">goto</span> update_timeout; <span class=\"comment\">// 重新更新时间 准备下次循环 epoll_wait </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nfds == <span class=\"number\">-1</span>) &#123; <span class=\"comment\">// 出错</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (errno == ENOSYS) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/* epoll_wait() or epoll_pwait() failed, try the other system call. */</span></span><br><span class=\"line\">        assert(no_epoll_wait == <span class=\"number\">0</span> || no_epoll_pwait == <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (errno != EINTR)</span><br><span class=\"line\">        <span class=\"built_in\">abort</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (timeout == <span class=\"number\">-1</span>)</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (timeout == <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> update_timeout;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    have_signals = <span class=\"number\">0</span>;</span><br><span class=\"line\">    nevents = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers] = (<span class=\"keyword\">void</span>*) events;</span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers + <span class=\"number\">1</span>] = (<span class=\"keyword\">void</span>*) (<span class=\"keyword\">uintptr_t</span>) nfds;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; nfds; i++) &#123;</span><br><span class=\"line\">      pe = events + i;</span><br><span class=\"line\">      fd = pe-&gt;data.fd;</span><br><span class=\"line\">      w = loop-&gt;watchers[fd];</span><br><span class=\"line\">      w-&gt;cb(loop, w, pe-&gt;events); <span class=\"comment\">// 这个for循环很长，这里我简化了，其实就是准备好的IO就执行回调</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout == <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout == <span class=\"number\">-1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">update_timeout:</span><br><span class=\"line\">    assert(timeout &gt; <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    real_timeout -= (loop-&gt;time - base);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (real_timeout &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = real_timeout;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>uv__io_poll</code>里的timeout参数是根据<code>timers</code>里的最近一次定时时间计算出来的。方法内部使用了<code>epoll</code>，是IO多路复用的一个概念。一共有三种：<code>select</code>、<code>poll</code>和<code>epoll</code>。</p>\n<blockquote>\n<p>epoll是<a href=\"https://baike.baidu.com/item/Linux内核\" target=\"_blank\" rel=\"noopener\">Linux内核</a>为处理大批量<a href=\"https://baike.baidu.com/item/文件描述符/9809582\" target=\"_blank\" rel=\"noopener\">文件描述符</a>而作了改进的poll，是Linux下多路复用IO接口select/poll的增强版本，它能显著提高程序在大量<a href=\"https://baike.baidu.com/item/并发连接/3763280\" target=\"_blank\" rel=\"noopener\">并发连接</a>中只有少量活跃的情况下的系统<a href=\"https://baike.baidu.com/item/CPU/120556\" target=\"_blank\" rel=\"noopener\">CPU</a>利用率。另一点原因就是获取事件的时候，它无须遍历整个被侦听的描述符集，只要遍历那些被内核IO事件异步唤醒而加入Ready队列的描述符集合就行了。epoll除了提供select/poll那种IO事件的水平触发（Level Triggered）外，还提供了边缘触发（Edge Triggered），这就使得用户空间程序有可能缓存IO状态，减少epoll_wait/epoll_pwait的调用，提高应用程序效率。 ——百度百科</p>\n</blockquote>\n<p>我觉得libuv使用epoll主要是因为支持其自身的异步特点</p>\n<ul>\n<li>epoll监控的文件描述符远远大于select/poll</li>\n<li>在大量并发的时候epoll性能远远高于select/poll，而少量异步select/poll相对好点。Node.js利用了libuv的高并发特点。</li>\n</ul>\n<p><br></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">uv__run_closing_handles</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">uv_handle_t</span>* p;</span><br><span class=\"line\">  <span class=\"keyword\">uv_handle_t</span>* q;</span><br><span class=\"line\"></span><br><span class=\"line\">  p = loop-&gt;closing_handles;</span><br><span class=\"line\">  loop-&gt;closing_handles = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (p) &#123;</span><br><span class=\"line\">    q = p-&gt;next_closing;</span><br><span class=\"line\">    uv__finish_close(p);</span><br><span class=\"line\">    p = q;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一个个触发<code>close</code>回调</p>\n<p><br></p>\n<p>上述就是libuv各个阶段的大体流程，<code>poll</code>最为复杂，还有很多东西可以留着细品。</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"Node-js-setTimeout\"><a href=\"#Node-js-setTimeout\" class=\"headerlink\" title=\"Node.js setTimeout\"></a>Node.js setTimeout</h2><p>上文中提到<strong>那么这里的<code>handle-&gt;timer_cb</code>是我们平时JavaScript里的setTimeout回调吗？回答：不是的</strong></p>\n<p>看看Node.js里面如何具体实现这个<code>setTimemout</code>方法的</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setTimeout</span>(<span class=\"params\">callback, after, arg1, arg2, arg3</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> args = [arg1, arg2, arg3]; <span class=\"comment\">// 简化了代码</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> timeout = <span class=\"keyword\">new</span> Timeout(callback, after, args, <span class=\"literal\">false</span>);</span><br><span class=\"line\">  active(timeout);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> timeout;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Timeout</span>(<span class=\"params\">callback, after, args, isRepeat</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 省略了部分代码</span></span><br><span class=\"line\">  after *= <span class=\"number\">1</span>; </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!(after &gt;= <span class=\"number\">1</span> &amp;&amp; after &lt;= TIMEOUT_MAX)) &#123;</span><br><span class=\"line\">    after = <span class=\"number\">1</span>; <span class=\"comment\">// 定时验证不过 就为1 </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._idleTimeout = after;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._onTimeout = callback;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._timerArgs = args;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">active</span>(<span class=\"params\">item</span>) </span>&#123;</span><br><span class=\"line\">  insert(item, <span class=\"literal\">true</span>, getLibuvNow());  <span class=\"comment\">// getLibuvNow 获取 loop-&gt;time时间</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">insert</span>(<span class=\"params\">item, refed, start</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> msecs = item._idleTimeout;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (msecs &lt; <span class=\"number\">0</span> || msecs === <span class=\"literal\">undefined</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Truncate so that accuracy of sub-millisecond timers is not assumed.</span></span><br><span class=\"line\">  msecs = <span class=\"built_in\">Math</span>.trunc(msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">  item._idleStart = start;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Use an existing list if there is one, otherwise we need to make a new one.</span></span><br><span class=\"line\">  <span class=\"comment\">// timerListMap 是一个键值对，key 是定时时间，value 是一个TimersList</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> list = timerListMap[msecs];</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (list === <span class=\"literal\">undefined</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> expiry = start + msecs; <span class=\"comment\">// 过期时间</span></span><br><span class=\"line\">    timerListMap[msecs] = list = <span class=\"keyword\">new</span> TimersList(expiry, msecs); <span class=\"comment\">// 双向链表</span></span><br><span class=\"line\">    timerListQueue.insert(list); <span class=\"comment\">// timerListQueue 用数组实现的最小堆</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nextExpiry &gt; expiry) &#123;</span><br><span class=\"line\">      scheduleTimer(msecs); <span class=\"comment\">// 如果此次定时任务的有效时间小的话，调用 V8 scheduleTimer</span></span><br><span class=\"line\">      nextExpiry = expiry;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ... 这边简略代码</span></span><br><span class=\"line\">  L.append(list, item); <span class=\"comment\">// 将setTimeout创建的Timeout对象添加到list尾部</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过上述代码，我们也可以看出JavaScript层面也有一个维护timers的最小堆，并没有吧具体的某个setTimeout注册到V8里面，只是将定时时间告诉了V8<code>scheduleTimer(msecs);</code>，下面是V8相关代码。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">ScheduleTimer</span><span class=\"params\">(<span class=\"keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">auto</span> env = Environment::GetCurrent(args);</span><br><span class=\"line\">  env-&gt;ScheduleTimer(args[<span class=\"number\">0</span>]-&gt;IntegerValue(env-&gt;context()).FromJust());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// env.cc</span></span><br><span class=\"line\"><span class=\"keyword\">void</span> Environment::ScheduleTimer(<span class=\"keyword\">int64_t</span> duration_ms) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (started_cleanup_) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  uv_timer_start(timer_handle(), RunTimers, duration_ms, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">void</span> Environment::RunTimers(<span class=\"keyword\">uv_timer_t</span>* handle) &#123;</span><br><span class=\"line\">  Environment* env = Environment::from_timer_handle(handle);</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// timers_callback_function 从何而来呢？</span></span><br><span class=\"line\">  Local&lt;Function&gt; cb = env-&gt;timers_callback_function();</span><br><span class=\"line\">  <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">    ret = cb-&gt;Call(env-&gt;context(), process, <span class=\"number\">1</span>, &amp;arg);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">while</span> (ret.IsEmpty() &amp;&amp; env-&gt;can_call_into_js());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// uv/timer.c</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">uv_timer_start</span><span class=\"params\">(<span class=\"keyword\">uv_timer_t</span>* handle,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                   uv_timer_cb cb,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                   <span class=\"keyword\">uint64_t</span> timeout,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                   <span class=\"keyword\">uint64_t</span> repeat)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 给uv_timer_t对象初始化相关属性</span></span><br><span class=\"line\">  <span class=\"comment\">// 并没有JavaScript层面的回调方法，具体的回调也只是C++的RunTimers</span></span><br><span class=\"line\">  handle-&gt;timer_cb = cb;</span><br><span class=\"line\">  handle-&gt;timeout = clamped_timeout;</span><br><span class=\"line\">  handle-&gt;repeat = repeat;</span><br><span class=\"line\">  handle-&gt;start_id = handle-&gt;loop-&gt;timer_counter++;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 将uv_timer_t添加到timer_heap上</span></span><br><span class=\"line\">  heap_insert(timer_heap(handle-&gt;loop),</span><br><span class=\"line\">              (struct heap_node*) &amp;handle-&gt;heap_node,</span><br><span class=\"line\">              timer_less_than);</span><br><span class=\"line\">  uv__handle_start(handle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>V8部分注册在timers阶段的是一个C++的回调方法</strong>，其内部是执行<code>timers_callback_function</code>方法，它从何来来？</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">SetupTimers</span><span class=\"params\">(<span class=\"keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class=\"line\">  CHECK(args[<span class=\"number\">0</span>]-&gt;IsFunction());</span><br><span class=\"line\">  CHECK(args[<span class=\"number\">1</span>]-&gt;IsFunction());</span><br><span class=\"line\">  <span class=\"keyword\">auto</span> env = Environment::GetCurrent(args);</span><br><span class=\"line\"></span><br><span class=\"line\">  env-&gt;set_immediate_callback_function(args[<span class=\"number\">0</span>].As&lt;Function&gt;()); <span class=\"comment\">// 注册了immediate回调</span></span><br><span class=\"line\">  env-&gt;set_timers_callback_function(args[<span class=\"number\">1</span>].As&lt;Function&gt;()); <span class=\"comment\">// 注册了timers回调</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// node.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123;</span><br><span class=\"line\">  setupTaskQueue,</span><br><span class=\"line\">  queueMicrotask</span><br><span class=\"line\">&#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'internal/process/task_queues'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; nextTick, runNextTicks &#125; = setupTaskQueue();</span><br><span class=\"line\">process.nextTick = nextTick;</span><br><span class=\"line\">process._tickCallback = runNextTicks;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; getTimerCallbacks &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'internal/timers'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; setupTimers &#125; = internalBinding(<span class=\"string\">'timers'</span>); <span class=\"comment\">// c++ SetupTimers 方法传到了JavaScript层</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; processImmediate, processTimers &#125; = getTimerCallbacks(runNextTicks);</span><br><span class=\"line\">setupTimers(processImmediate, processTimers);</span><br></pre></td></tr></table></figure>\n<p>我们通过上述代码看到在<code>node.js</code>里面会将<code>processImmediate</code>和<code>processTimers</code>这两个JavaScript方法注册到对应的C++回调里，之后执行<code>timers_callback_function</code>其实就是执行<code>processTimers</code>方法。</p>\n<p>另外，需要注意<code>微任务</code>相关的代码会被带到<code>getTimerCallbacks</code>。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getTimerCallbacks</span>(<span class=\"params\">runNextTicks</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">processImmediate</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 之后文章在做介绍</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">processTimers</span>(<span class=\"params\">now</span>) </span>&#123;</span><br><span class=\"line\">    nextExpiry = <span class=\"literal\">Infinity</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">let</span> list;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> ranAtLeastOneList = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (list = timerListQueue.peek()) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (list.expiry &gt; now) &#123; <span class=\"comment\">// 当前列表的过期时间大于now(libuv loop-&gt;time), 还没有到过期或到触发时间</span></span><br><span class=\"line\">        nextExpiry = list.expiry; <span class=\"comment\">// nextExpiry 设置为 当前列表的过期时间</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> refCount &gt; <span class=\"number\">0</span> ? nextExpiry : -nextExpiry;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (ranAtLeastOneList)</span><br><span class=\"line\">        runNextTicks(); <span class=\"comment\">// 微任务会被触发</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneList = <span class=\"literal\">true</span>;</span><br><span class=\"line\">      listOnTimeout(list, now);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">listOnTimeout</span>(<span class=\"params\">list, now</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> msecs = list.msecs;</span><br><span class=\"line\"></span><br><span class=\"line\">    debug(<span class=\"string\">'timeout callback %d'</span>, msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> diff, timer;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> ranAtLeastOneTimer = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (timer = L.peek(list)) &#123; <span class=\"comment\">// 如果不是一个空的list，持续执行</span></span><br><span class=\"line\">      <span class=\"comment\">// _idleStart 是插入libuv (loop-&gt;time)的时间</span></span><br><span class=\"line\">      <span class=\"comment\">// now 是当前libuv 执行此次callback的时间</span></span><br><span class=\"line\">      diff = now - timer._idleStart; </span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Check if this loop iteration is too early for the next timer.</span></span><br><span class=\"line\">      <span class=\"comment\">// This happens if there are more timers scheduled for later in the list.</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (diff &lt; msecs) &#123;</span><br><span class=\"line\">        list.expiry = <span class=\"built_in\">Math</span>.max(timer._idleStart + msecs, now + <span class=\"number\">1</span>);</span><br><span class=\"line\">        list.id = timerListId++;</span><br><span class=\"line\">        timerListQueue.percolateDown(<span class=\"number\">1</span>);</span><br><span class=\"line\">        debug(<span class=\"string\">'%d list wait because diff is %d'</span>, msecs, diff);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (ranAtLeastOneTimer)</span><br><span class=\"line\">        runNextTicks(); <span class=\"comment\">// 微任务会被触发</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneTimer = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// The actual logic for when a timeout happens.</span></span><br><span class=\"line\">      L.remove(timer);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> asyncId = timer[async_id_symbol];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!timer._onTimeout) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> args = timer._timerArgs;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (args === <span class=\"literal\">undefined</span>)</span><br><span class=\"line\">          timer._onTimeout(); <span class=\"comment\">// _onTimeout setTimeout 回调</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          timer._onTimeout(...args);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (list === timerListMap[msecs]) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">delete</span> timerListMap[msecs];</span><br><span class=\"line\">      timerListQueue.shift();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">    processImmediate,</span><br><span class=\"line\">    processTimers</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码很长，但是很容易理解，就是根据<code>libuv</code>的时间，将到期的定时任务一一执行了，格外需要注意的是微任务的执行<code>runNextTicks</code>，<strong>每次setTimeout的callback之后都会将<code>微任务</code>清空，而不是网上很多文章说的timer阶段之后将微任务清空，这个改动在Node.js 11版本</strong></p>\n<blockquote>\n<p>Timers<br>Interval timers will be rescheduled even if previous interval threw an error. #20002<br><strong>nextTick queue will be run after each immediate and timer. <a href=\"https://github.com/nodejs/node/pull/22842\" target=\"_blank\" rel=\"noopener\">#22842</a></strong></p>\n</blockquote>\n<p>具体的原因是希望和浏览器里的行为更为一直，下面的代码在11之前和之后的执行结果略有不同。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'time1'</span>);</span><br><span class=\"line\">  <span class=\"built_in\">Promise</span>.resolve().then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'promise1'</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'time2'</span>);</span><br><span class=\"line\">  <span class=\"built_in\">Promise</span>.resolve().then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'promise2'</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* 11之后</span></span><br><span class=\"line\"><span class=\"comment\">time1</span></span><br><span class=\"line\"><span class=\"comment\">promise1</span></span><br><span class=\"line\"><span class=\"comment\">time2</span></span><br><span class=\"line\"><span class=\"comment\">promise2</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* 11之前</span></span><br><span class=\"line\"><span class=\"comment\">time1</span></span><br><span class=\"line\"><span class=\"comment\">time2</span></span><br><span class=\"line\"><span class=\"comment\">promise1</span></span><br><span class=\"line\"><span class=\"comment\">promise2</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><br></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>至此，libuv和Node.js EventLoop关于<code>各个阶段</code>和<code>setTimeout</code>的实现已经做了简单介绍。具体的还是需要看各自版本的代码而定，不能轻易去“相信”网上的介绍，比如最后一个例子就很容易在不同版本出现不同的执行结果。之后，有时间介绍 <code>nextTick</code>的回调实现，这个比较复杂。</p>"},{"title":"V8是如何怎么处理JavaScript的","keywords":"V8,Node.js,解析编译","description":"Parer和Compiler是2个重要的过程和概念，理解它们可以帮助开发者根据业务需求写出对V8或其它JavaScript引擎更为“友善”的代码，毕竟花在这两个过程中的成本是巨大的。","date":"2020-02-08T01:18:53.485Z","_content":"\n> 此文介绍的内容已经算是`旧闻`了，17年的时候就有大量的文章介绍过了，只是2020年伊始的疫情把人困在家里实在无聊，重新翻来几个视频打发下时间，以下文字算是简单梳理，更多的瑰宝需要我们自己翻阅资料研究，**文章中的很多数据应该都过时了吧，仅用来参考吧。**\n\n\n\n**Parer**和**Compiler**是2个重要的过程和概念，理解它们可以帮助开发者根据业务需求写出对V8或其它JavaScript引擎更为“友善”的代码，毕竟花在这两个过程中的成本是巨大的。\n\n![国外几大网站花在Parser上的时间大约在15-20%](/images/v8-parser-compiler/v8-pare-compile-cost.png)\n\n<!-- more -->\n\n\n\n# **Parser**\n\n![红色部分就是接下来讨论的Parser部分](/images/v8-parser-compiler/parser-phase.png)\n\n**解析速率大约为 `1 MB / s`**\n\n<br/>\n\n#### **V8的Parser分2次解析：**\n\n`Layze（Pre-Parsing）：`\n\n- 跳过还未被使用的代码\n- 不会生成`AST`，会产生不带有变量引用和声明的`Scopes`信息\n- 解析速度是Eage的2倍\n- 根据JavaScript规范抛出一些特定的错误\n\n`Eage（Full-Parsing）：`\n\n- 解析那些被使用的代码\n- 生成`AST`\n- 构建具体的`Scopes`信息，变量的引用、声明等\n- 抛出所有的语法错误\n\n<br/>\n\n#### Q:为什么会有2次解析？\n\n如果都是用Full-Parsing的话，那么整个解析会非常漫长浪费时间。我们通过DevTools的`coverage`工具可以发现页面上大量的代码并没有被使用\n\n<br/>\n\n#### Q:2次解析会有什么负面影响？\n\n如果代码已经被Pre-Parsing解析过了，当被执行的时候还是会被Full-Parser解析一次那么开销是: `0.5 * parse + 1 * parse = 1.5 parse` 从某个角度来说更复杂了、开销更大了。鱼和熊掌不可兼得！\n\n<br/>\n\n#### Q:什么样的代码会被 `Pre-Parsing` 处理，什么样的会被 `Full-Parsing` 处理？\n\n```javascript\nlet a = 0; // Top-Level 顶层的代码都是 Full-Parsing\n\n// 立即执行函数表达式 IIFE = Immediately Invoked Function Expression\n(function eager() {...})(); // 函数体是 Full-Parsing\n                   \n// 顶层的函数非IIFE\nfunction lazy() {...} // 函数体是 Pre-Parsing\n\nlazy(); // -> Full-Parsing 开始解析和编译！\n                 \n// 强制触发Full-Parsing解析\n!function eager2() {...}, function eager3() {...} // All eager\n \nlet f1 = function lazy() { ... }; // 函数体是 Pre-Parsing\n              \nlet f2 = function lazy() {...}(); // 先触发了lazy 解析, 然后又eager解析\n```\n\n<br/>\n\n#### Q:如何强制Full-Parsing （eager ）？\n\n- lazy 预编译由前2位首字母决定；所以如果我们想跳过 lazy 触发 eager 编译，我们应该在前面加位操作符，例如'!|~'。\n- 使用 [optimize-js](https://github.com/nolanlawson/optimize-js) 重新编译代码，具体的性改变可以参考它Github里的测试数据\n\n<br/>\n\n#### Q:什么是连续重新解析\n\n```javascript\nfunction lazy_outer() { // lazy parse this\n  function inner() {\n    function inner2() {\n      // ...\n    }\n  }\n}\n\nlazy_outer(); // lazy parsing inner & inner2\ninner(); // lazy parsing inner & inner2 (3rd time!)\n```\n\n从上可知，大量的深度内嵌的代码对解析有着性能影响，每一层的深度调用都会引发新一轮的`Pre-Parsing`。\n\n<br/>\n\n#### Q:既然Parser阶段会性能消耗很大，我们该怎么优化代码？\n\n1. **尽量减少代码**，可以通过DevTools的`coverage`工具查看当前页面代码的使用率。\n2. V8会缓存Parser阶段的结果并保存72小时，如果bundle中间有部分代码被修改了，那么整个bundle的Parser缓存都会失效，所以把经常变动的打包在一起，非经常变动的在一起，比如公共类库和业务代码分离。\n\n<br/>\n\n#### Q:如何评估当前网站代码的Parser时间呢？（包括后面将的Compiler时间）\n\n1.使用 `chrome://tracing/`工具，我们以[爱眠物](http://aimianwu.com)为例\n\n2.打开tracing界面，点击左上角的`Record`按钮\n\n3.在弹出的界面中选择`Web developer`和在Edit categories里面选择`v8.runtime_stats`\n\n4.在新的Tab中输入 http://aimianwu.com ，回到tracing Tab\n\n5.等待数据采集完成，然后\"停止\"记录\n\n6.选择对应的Process和数据\n\n![](/images/v8-parser-compiler/parse-time.png)\n\n![](/images/v8-parser-compiler/parse-time-1.png)\n\n7.查看V8里的Parse和Compile数据\n\n![](/images/v8-parser-compiler/parse-time-2.png)\n\n<br/>\n\n<br/>\n\n# **Compiler Pipeline**\n\n随着V8的迭代，整个Compiler Pipeline也在发生翻天覆地的变化。最近的一次大更新是在V8 5.9版本，用 Ignition + TurboFan 代替了从2010一直服务的Full-codegen + Crankshaft组合，当然整个过程也不是一蹴而就的，中间夹杂着特殊的版本， Ignition + TurboFan 、Full-codegen + Crankshaft它们以特殊的方式共存了一段时间，因为一开始TurboFan的性能无法满足需求，可以看[这个PPT](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389)。\n\n<br/>\n\n#### Q:为什么做了替换？[官方介绍](https://v8.dev/blog/launching-ignition-and-turbofan)\n因为老的版本比较激进，直接将JavaScript翻译成了机器码，在执行性能上确实很快，但是带来了几个大问题\n\n* 直接将JavaScript编译成机器码既费时间又费内存，几乎占用了V8约1/3的堆内存，导致实际可被使用的内存减少；另外由于复杂的设计导致Crankshaft重复编译代码，拖累性能。\n* Crankshaft没有友善处理 try、catch、finally 等关键词 ；维护成本高，需要为多个芯片架构提供优化代码，但性能提升不够明显；对ES新的语法特性支持不够好、也无法支持WebAssembly；\n在PC端老的组合感受还好，但是在移动端随着网页的不断复杂化，该组合的启动时间和性能慢慢有些力不从心了。\n\n<br/>\n\n#### Q:什么样的代码对 V8 Compiler 友好？\n\n虽然JavaScript是动态语言，如橡皮泥一样随意被开发者“随意”塑造、快速开发出一个又一个应用，但是没有规矩就会带来混乱，增加编译器的优化负担，目前在V8中优化工作由TurboFan完成。Ignition会收集大量信息交给TurboFan去优化，多方面条件都满足的情况下会被优化成机器码，这个过程成为`Optimize`，当判断无法优化时就触发去优化——Deoptimize，这些代码逻辑又重新回到Ignition中成为字节码。\n\n主要有以下2点[视频](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n* 自然是经常被调用的代码部分\n* 不要总是在改变对象类型（虽然JavaScript是动态的）\n\n![](/images/v8-parser-compiler/not-change-types-1.png)\n\n![](/images/v8-parser-compiler/not-change-types-2.png)\n\n![](/images/v8-parser-compiler/not-change-types-3.png)\n\n> 如果你总是在改变Objects，V8无法对它做优化。即使做了优化也会被De-optimisation，这意味着会有性能损失。\n\n```javascript\nfunction load(obj) {\n  return obj.x\n}\n\nvar obj = {\n  x: 1,\n  y: 4\n} \n```\n\n\n\n对编译器而言 `obj = {}` 是一种类型， `obj = { x: \"Number\" }` 是另一种类型，`obj = { y: \"Number\" }` 又是一种类型等等，也就说数据类型和字段名必须一致，如果用过静态语言比如C++、Java就很容易理解。\n\n像下面这样的代码\n\n```javascript\nload({ x: 4, a: 7 });\nload({ x: 4, b: 9 });\nload({ x: 4, c: 3 });\nload({ x: 4, d: 1 });\n```\n\n没办法被优化，只有将参数的入参格式一致才行，比如\n\n```javascript\nload({ x: 4, a: 7, b: undefined, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: 9, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: 3, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: undefined, d: 1 });\n\n```\n\n是不是觉得学习TypeScript很重要了呢？\n\n\n\n# 总结\n\n`V8`在不断的迭代和进步，还有[Script Streaming](https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html)等等技术没有介绍。随便翻阅 https://v8.dev/ 就会发现数不尽的干货在里面躺着，等我们动手发掘和尝试。作为一个JavaScript工程师而言，无论是学习V8还是其它的编译引擎都能使得我们更好的写出高性能代码、优化代码、甚至在做架构的时候提供帮助。\n\n另外，随着WebAssembly进入浏览器和Node.js，越来越多的C++等技术会被更方便的加入到JavaScript阵营当中。最近买了树莓派和Arduino，在它们身上使用JavaScript做一些功能多多少少离不开C/C++，感觉到了需要系统化学习C/C++的时候了。\n\n\n\n\n\n### 主要参考：\n\n[Parsing JavaScript - better lazy than eager](https://www.youtube.com/watch?v=Fg7niTmNNLg)\n\n[JavaScript engines - how do they even? ](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n[JavaScript Start-up Performance](https://medium.com/reloading/javascript-start-up-performance-69200f43b201)\n\n[V8: Hooking up the Ignition to the Turbofan](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103)","source":"_posts/v8-parser-compiler-javascript.md","raw":"---\ntitle: V8是如何怎么处理JavaScript的\ncategory: JavaScript\nkeywords: V8,Node.js,解析编译\ndescription: Parer和Compiler是2个重要的过程和概念，理解它们可以帮助开发者根据业务需求写出对V8或其它JavaScript引擎更为“友善”的代码，毕竟花在这两个过程中的成本是巨大的。\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-02-08T09:18:53.485Z\n---\n\n> 此文介绍的内容已经算是`旧闻`了，17年的时候就有大量的文章介绍过了，只是2020年伊始的疫情把人困在家里实在无聊，重新翻来几个视频打发下时间，以下文字算是简单梳理，更多的瑰宝需要我们自己翻阅资料研究，**文章中的很多数据应该都过时了吧，仅用来参考吧。**\n\n\n\n**Parer**和**Compiler**是2个重要的过程和概念，理解它们可以帮助开发者根据业务需求写出对V8或其它JavaScript引擎更为“友善”的代码，毕竟花在这两个过程中的成本是巨大的。\n\n![国外几大网站花在Parser上的时间大约在15-20%](/images/v8-parser-compiler/v8-pare-compile-cost.png)\n\n<!-- more -->\n\n\n\n# **Parser**\n\n![红色部分就是接下来讨论的Parser部分](/images/v8-parser-compiler/parser-phase.png)\n\n**解析速率大约为 `1 MB / s`**\n\n<br/>\n\n#### **V8的Parser分2次解析：**\n\n`Layze（Pre-Parsing）：`\n\n- 跳过还未被使用的代码\n- 不会生成`AST`，会产生不带有变量引用和声明的`Scopes`信息\n- 解析速度是Eage的2倍\n- 根据JavaScript规范抛出一些特定的错误\n\n`Eage（Full-Parsing）：`\n\n- 解析那些被使用的代码\n- 生成`AST`\n- 构建具体的`Scopes`信息，变量的引用、声明等\n- 抛出所有的语法错误\n\n<br/>\n\n#### Q:为什么会有2次解析？\n\n如果都是用Full-Parsing的话，那么整个解析会非常漫长浪费时间。我们通过DevTools的`coverage`工具可以发现页面上大量的代码并没有被使用\n\n<br/>\n\n#### Q:2次解析会有什么负面影响？\n\n如果代码已经被Pre-Parsing解析过了，当被执行的时候还是会被Full-Parser解析一次那么开销是: `0.5 * parse + 1 * parse = 1.5 parse` 从某个角度来说更复杂了、开销更大了。鱼和熊掌不可兼得！\n\n<br/>\n\n#### Q:什么样的代码会被 `Pre-Parsing` 处理，什么样的会被 `Full-Parsing` 处理？\n\n```javascript\nlet a = 0; // Top-Level 顶层的代码都是 Full-Parsing\n\n// 立即执行函数表达式 IIFE = Immediately Invoked Function Expression\n(function eager() {...})(); // 函数体是 Full-Parsing\n                   \n// 顶层的函数非IIFE\nfunction lazy() {...} // 函数体是 Pre-Parsing\n\nlazy(); // -> Full-Parsing 开始解析和编译！\n                 \n// 强制触发Full-Parsing解析\n!function eager2() {...}, function eager3() {...} // All eager\n \nlet f1 = function lazy() { ... }; // 函数体是 Pre-Parsing\n              \nlet f2 = function lazy() {...}(); // 先触发了lazy 解析, 然后又eager解析\n```\n\n<br/>\n\n#### Q:如何强制Full-Parsing （eager ）？\n\n- lazy 预编译由前2位首字母决定；所以如果我们想跳过 lazy 触发 eager 编译，我们应该在前面加位操作符，例如'!|~'。\n- 使用 [optimize-js](https://github.com/nolanlawson/optimize-js) 重新编译代码，具体的性改变可以参考它Github里的测试数据\n\n<br/>\n\n#### Q:什么是连续重新解析\n\n```javascript\nfunction lazy_outer() { // lazy parse this\n  function inner() {\n    function inner2() {\n      // ...\n    }\n  }\n}\n\nlazy_outer(); // lazy parsing inner & inner2\ninner(); // lazy parsing inner & inner2 (3rd time!)\n```\n\n从上可知，大量的深度内嵌的代码对解析有着性能影响，每一层的深度调用都会引发新一轮的`Pre-Parsing`。\n\n<br/>\n\n#### Q:既然Parser阶段会性能消耗很大，我们该怎么优化代码？\n\n1. **尽量减少代码**，可以通过DevTools的`coverage`工具查看当前页面代码的使用率。\n2. V8会缓存Parser阶段的结果并保存72小时，如果bundle中间有部分代码被修改了，那么整个bundle的Parser缓存都会失效，所以把经常变动的打包在一起，非经常变动的在一起，比如公共类库和业务代码分离。\n\n<br/>\n\n#### Q:如何评估当前网站代码的Parser时间呢？（包括后面将的Compiler时间）\n\n1.使用 `chrome://tracing/`工具，我们以[爱眠物](http://aimianwu.com)为例\n\n2.打开tracing界面，点击左上角的`Record`按钮\n\n3.在弹出的界面中选择`Web developer`和在Edit categories里面选择`v8.runtime_stats`\n\n4.在新的Tab中输入 http://aimianwu.com ，回到tracing Tab\n\n5.等待数据采集完成，然后\"停止\"记录\n\n6.选择对应的Process和数据\n\n![](/images/v8-parser-compiler/parse-time.png)\n\n![](/images/v8-parser-compiler/parse-time-1.png)\n\n7.查看V8里的Parse和Compile数据\n\n![](/images/v8-parser-compiler/parse-time-2.png)\n\n<br/>\n\n<br/>\n\n# **Compiler Pipeline**\n\n随着V8的迭代，整个Compiler Pipeline也在发生翻天覆地的变化。最近的一次大更新是在V8 5.9版本，用 Ignition + TurboFan 代替了从2010一直服务的Full-codegen + Crankshaft组合，当然整个过程也不是一蹴而就的，中间夹杂着特殊的版本， Ignition + TurboFan 、Full-codegen + Crankshaft它们以特殊的方式共存了一段时间，因为一开始TurboFan的性能无法满足需求，可以看[这个PPT](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389)。\n\n<br/>\n\n#### Q:为什么做了替换？[官方介绍](https://v8.dev/blog/launching-ignition-and-turbofan)\n因为老的版本比较激进，直接将JavaScript翻译成了机器码，在执行性能上确实很快，但是带来了几个大问题\n\n* 直接将JavaScript编译成机器码既费时间又费内存，几乎占用了V8约1/3的堆内存，导致实际可被使用的内存减少；另外由于复杂的设计导致Crankshaft重复编译代码，拖累性能。\n* Crankshaft没有友善处理 try、catch、finally 等关键词 ；维护成本高，需要为多个芯片架构提供优化代码，但性能提升不够明显；对ES新的语法特性支持不够好、也无法支持WebAssembly；\n在PC端老的组合感受还好，但是在移动端随着网页的不断复杂化，该组合的启动时间和性能慢慢有些力不从心了。\n\n<br/>\n\n#### Q:什么样的代码对 V8 Compiler 友好？\n\n虽然JavaScript是动态语言，如橡皮泥一样随意被开发者“随意”塑造、快速开发出一个又一个应用，但是没有规矩就会带来混乱，增加编译器的优化负担，目前在V8中优化工作由TurboFan完成。Ignition会收集大量信息交给TurboFan去优化，多方面条件都满足的情况下会被优化成机器码，这个过程成为`Optimize`，当判断无法优化时就触发去优化——Deoptimize，这些代码逻辑又重新回到Ignition中成为字节码。\n\n主要有以下2点[视频](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n* 自然是经常被调用的代码部分\n* 不要总是在改变对象类型（虽然JavaScript是动态的）\n\n![](/images/v8-parser-compiler/not-change-types-1.png)\n\n![](/images/v8-parser-compiler/not-change-types-2.png)\n\n![](/images/v8-parser-compiler/not-change-types-3.png)\n\n> 如果你总是在改变Objects，V8无法对它做优化。即使做了优化也会被De-optimisation，这意味着会有性能损失。\n\n```javascript\nfunction load(obj) {\n  return obj.x\n}\n\nvar obj = {\n  x: 1,\n  y: 4\n} \n```\n\n\n\n对编译器而言 `obj = {}` 是一种类型， `obj = { x: \"Number\" }` 是另一种类型，`obj = { y: \"Number\" }` 又是一种类型等等，也就说数据类型和字段名必须一致，如果用过静态语言比如C++、Java就很容易理解。\n\n像下面这样的代码\n\n```javascript\nload({ x: 4, a: 7 });\nload({ x: 4, b: 9 });\nload({ x: 4, c: 3 });\nload({ x: 4, d: 1 });\n```\n\n没办法被优化，只有将参数的入参格式一致才行，比如\n\n```javascript\nload({ x: 4, a: 7, b: undefined, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: 9, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: 3, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: undefined, d: 1 });\n\n```\n\n是不是觉得学习TypeScript很重要了呢？\n\n\n\n# 总结\n\n`V8`在不断的迭代和进步，还有[Script Streaming](https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html)等等技术没有介绍。随便翻阅 https://v8.dev/ 就会发现数不尽的干货在里面躺着，等我们动手发掘和尝试。作为一个JavaScript工程师而言，无论是学习V8还是其它的编译引擎都能使得我们更好的写出高性能代码、优化代码、甚至在做架构的时候提供帮助。\n\n另外，随着WebAssembly进入浏览器和Node.js，越来越多的C++等技术会被更方便的加入到JavaScript阵营当中。最近买了树莓派和Arduino，在它们身上使用JavaScript做一些功能多多少少离不开C/C++，感觉到了需要系统化学习C/C++的时候了。\n\n\n\n\n\n### 主要参考：\n\n[Parsing JavaScript - better lazy than eager](https://www.youtube.com/watch?v=Fg7niTmNNLg)\n\n[JavaScript engines - how do they even? ](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n[JavaScript Start-up Performance](https://medium.com/reloading/javascript-start-up-performance-69200f43b201)\n\n[V8: Hooking up the Ignition to the Turbofan](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103)","slug":"v8-parser-compiler-javascript","published":1,"updated":"2020-07-07T10:11:25.591Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6y001id12ibykhggc2","content":"<blockquote>\n<p>此文介绍的内容已经算是<code>旧闻</code>了，17年的时候就有大量的文章介绍过了，只是2020年伊始的疫情把人困在家里实在无聊，重新翻来几个视频打发下时间，以下文字算是简单梳理，更多的瑰宝需要我们自己翻阅资料研究，<strong>文章中的很多数据应该都过时了吧，仅用来参考吧。</strong></p>\n</blockquote>\n<p><strong>Parer</strong>和<strong>Compiler</strong>是2个重要的过程和概念，理解它们可以帮助开发者根据业务需求写出对V8或其它JavaScript引擎更为“友善”的代码，毕竟花在这两个过程中的成本是巨大的。</p>\n<p><img src=\"/images/v8-parser-compiler/v8-pare-compile-cost.png\" alt=\"国外几大网站花在Parser上的时间大约在15-20%\"></p>\n<a id=\"more\"></a>\n<h1 id=\"Parser\"><a href=\"#Parser\" class=\"headerlink\" title=\"Parser\"></a><strong>Parser</strong></h1><p><img src=\"/images/v8-parser-compiler/parser-phase.png\" alt=\"红色部分就是接下来讨论的Parser部分\"></p>\n<p><strong>解析速率大约为 <code>1 MB / s</code></strong></p>\n<p><br></p>\n<h4 id=\"V8的Parser分2次解析：\"><a href=\"#V8的Parser分2次解析：\" class=\"headerlink\" title=\"V8的Parser分2次解析：\"></a><strong>V8的Parser分2次解析：</strong></h4><p><code>Layze（Pre-Parsing）：</code></p>\n<ul>\n<li>跳过还未被使用的代码</li>\n<li>不会生成<code>AST</code>，会产生不带有变量引用和声明的<code>Scopes</code>信息</li>\n<li>解析速度是Eage的2倍</li>\n<li>根据JavaScript规范抛出一些特定的错误</li>\n</ul>\n<p><code>Eage（Full-Parsing）：</code></p>\n<ul>\n<li>解析那些被使用的代码</li>\n<li>生成<code>AST</code></li>\n<li>构建具体的<code>Scopes</code>信息，变量的引用、声明等</li>\n<li>抛出所有的语法错误</li>\n</ul>\n<p><br></p>\n<h4 id=\"Q-为什么会有2次解析？\"><a href=\"#Q-为什么会有2次解析？\" class=\"headerlink\" title=\"Q:为什么会有2次解析？\"></a>Q:为什么会有2次解析？</h4><p>如果都是用Full-Parsing的话，那么整个解析会非常漫长浪费时间。我们通过DevTools的<code>coverage</code>工具可以发现页面上大量的代码并没有被使用</p>\n<p><br></p>\n<h4 id=\"Q-2次解析会有什么负面影响？\"><a href=\"#Q-2次解析会有什么负面影响？\" class=\"headerlink\" title=\"Q:2次解析会有什么负面影响？\"></a>Q:2次解析会有什么负面影响？</h4><p>如果代码已经被Pre-Parsing解析过了，当被执行的时候还是会被Full-Parser解析一次那么开销是: <code>0.5 * parse + 1 * parse = 1.5 parse</code> 从某个角度来说更复杂了、开销更大了。鱼和熊掌不可兼得！</p>\n<p><br></p>\n<h4 id=\"Q-什么样的代码会被-Pre-Parsing-处理，什么样的会被-Full-Parsing-处理？\"><a href=\"#Q-什么样的代码会被-Pre-Parsing-处理，什么样的会被-Full-Parsing-处理？\" class=\"headerlink\" title=\"Q:什么样的代码会被 Pre-Parsing 处理，什么样的会被 Full-Parsing 处理？\"></a>Q:什么样的代码会被 <code>Pre-Parsing</code> 处理，什么样的会被 <code>Full-Parsing</code> 处理？</h4><figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">let</span> a = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// Top-Level 顶层的代码都是 Full-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// 立即执行函数表达式 IIFE = Immediately Invoked Function Expression</span></span><br><span class=\"line\">(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">eager</span>(<span class=\"hljs-params\"></span>) </span>&#123;...&#125;)(); <span class=\"hljs-comment\">// 函数体是 Full-Parsing</span></span><br><span class=\"line\">                   </span><br><span class=\"line\"><span class=\"hljs-comment\">// 顶层的函数非IIFE</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">lazy</span>(<span class=\"hljs-params\"></span>) </span>&#123;...&#125; <span class=\"hljs-comment\">// 函数体是 Pre-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\">lazy(); <span class=\"hljs-comment\">// -&gt; Full-Parsing 开始解析和编译！</span></span><br><span class=\"line\">                 </span><br><span class=\"line\"><span class=\"hljs-comment\">// 强制触发Full-Parsing解析</span></span><br><span class=\"line\">!<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">eager2</span>(<span class=\"hljs-params\"></span>) </span>&#123;...&#125;, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">eager3</span>(<span class=\"hljs-params\"></span>) </span>&#123;...&#125; <span class=\"hljs-comment\">// All eager</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> f1 = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">lazy</span>(<span class=\"hljs-params\"></span>) </span>&#123; ... &#125;; <span class=\"hljs-comment\">// 函数体是 Pre-Parsing</span></span><br><span class=\"line\">              </span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> f2 = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">lazy</span>(<span class=\"hljs-params\"></span>) </span>&#123;...&#125;(); <span class=\"hljs-comment\">// 先触发了lazy 解析, 然后又eager解析</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h4 id=\"Q-如何强制Full-Parsing-（eager-）？\"><a href=\"#Q-如何强制Full-Parsing-（eager-）？\" class=\"headerlink\" title=\"Q:如何强制Full-Parsing （eager ）？\"></a>Q:如何强制Full-Parsing （eager ）？</h4><ul>\n<li>lazy 预编译由前2位首字母决定；所以如果我们想跳过 lazy 触发 eager 编译，我们应该在前面加位操作符，例如’!|~’。</li>\n<li>使用 <a href=\"https://github.com/nolanlawson/optimize-js\" target=\"_blank\" rel=\"noopener\">optimize-js</a> 重新编译代码，具体的性改变可以参考它Github里的测试数据</li>\n</ul>\n<p><br></p>\n<h4 id=\"Q-什么是连续重新解析\"><a href=\"#Q-什么是连续重新解析\" class=\"headerlink\" title=\"Q:什么是连续重新解析\"></a>Q:什么是连续重新解析</h4><figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">lazy_outer</span>(<span class=\"hljs-params\"></span>) </span>&#123; <span class=\"hljs-comment\">// lazy parse this</span></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">inner</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">inner2</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">lazy_outer(); <span class=\"hljs-comment\">// lazy parsing inner &amp; inner2</span></span><br><span class=\"line\">inner(); <span class=\"hljs-comment\">// lazy parsing inner &amp; inner2 (3rd time!)</span></span><br></pre></td></tr></table></figure>\n<p>从上可知，大量的深度内嵌的代码对解析有着性能影响，每一层的深度调用都会引发新一轮的<code>Pre-Parsing</code>。</p>\n<p><br></p>\n<h4 id=\"Q-既然Parser阶段会性能消耗很大，我们该怎么优化代码？\"><a href=\"#Q-既然Parser阶段会性能消耗很大，我们该怎么优化代码？\" class=\"headerlink\" title=\"Q:既然Parser阶段会性能消耗很大，我们该怎么优化代码？\"></a>Q:既然Parser阶段会性能消耗很大，我们该怎么优化代码？</h4><ol>\n<li><strong>尽量减少代码</strong>，可以通过DevTools的<code>coverage</code>工具查看当前页面代码的使用率。</li>\n<li>V8会缓存Parser阶段的结果并保存72小时，如果bundle中间有部分代码被修改了，那么整个bundle的Parser缓存都会失效，所以把经常变动的打包在一起，非经常变动的在一起，比如公共类库和业务代码分离。</li>\n</ol>\n<p><br></p>\n<h4 id=\"Q-如何评估当前网站代码的Parser时间呢？（包括后面将的Compiler时间）\"><a href=\"#Q-如何评估当前网站代码的Parser时间呢？（包括后面将的Compiler时间）\" class=\"headerlink\" title=\"Q:如何评估当前网站代码的Parser时间呢？（包括后面将的Compiler时间）\"></a>Q:如何评估当前网站代码的Parser时间呢？（包括后面将的Compiler时间）</h4><p>1.使用 <code>chrome://tracing/</code>工具，我们以<a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\">爱眠物</a>为例</p>\n<p>2.打开tracing界面，点击左上角的<code>Record</code>按钮</p>\n<p>3.在弹出的界面中选择<code>Web developer</code>和在Edit categories里面选择<code>v8.runtime_stats</code></p>\n<p>4.在新的Tab中输入 <a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\">http://aimianwu.com</a> ，回到tracing Tab</p>\n<p>5.等待数据采集完成，然后”停止”记录</p>\n<p>6.选择对应的Process和数据</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-1.png\" alt=\"\"></p>\n<p>7.查看V8里的Parse和Compile数据</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-2.png\" alt=\"\"></p>\n<p><br></p>\n<p><br></p>\n<h1 id=\"Compiler-Pipeline\"><a href=\"#Compiler-Pipeline\" class=\"headerlink\" title=\"Compiler Pipeline\"></a><strong>Compiler Pipeline</strong></h1><p>随着V8的迭代，整个Compiler Pipeline也在发生翻天覆地的变化。最近的一次大更新是在V8 5.9版本，用 Ignition + TurboFan 代替了从2010一直服务的Full-codegen + Crankshaft组合，当然整个过程也不是一蹴而就的，中间夹杂着特殊的版本， Ignition + TurboFan 、Full-codegen + Crankshaft它们以特殊的方式共存了一段时间，因为一开始TurboFan的性能无法满足需求，可以看<a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389\" target=\"_blank\" rel=\"noopener\">这个PPT</a>。</p>\n<p><br></p>\n<h4 id=\"Q-为什么做了替换？官方介绍\"><a href=\"#Q-为什么做了替换？官方介绍\" class=\"headerlink\" title=\"Q:为什么做了替换？官方介绍\"></a>Q:为什么做了替换？<a href=\"https://v8.dev/blog/launching-ignition-and-turbofan\" target=\"_blank\" rel=\"noopener\">官方介绍</a></h4><p>因为老的版本比较激进，直接将JavaScript翻译成了机器码，在执行性能上确实很快，但是带来了几个大问题</p>\n<ul>\n<li>直接将JavaScript编译成机器码既费时间又费内存，几乎占用了V8约1/3的堆内存，导致实际可被使用的内存减少；另外由于复杂的设计导致Crankshaft重复编译代码，拖累性能。</li>\n<li>Crankshaft没有友善处理 try、catch、finally 等关键词 ；维护成本高，需要为多个芯片架构提供优化代码，但性能提升不够明显；对ES新的语法特性支持不够好、也无法支持WebAssembly；<br>在PC端老的组合感受还好，但是在移动端随着网页的不断复杂化，该组合的启动时间和性能慢慢有些力不从心了。</li>\n</ul>\n<p><br></p>\n<h4 id=\"Q-什么样的代码对-V8-Compiler-友好？\"><a href=\"#Q-什么样的代码对-V8-Compiler-友好？\" class=\"headerlink\" title=\"Q:什么样的代码对 V8 Compiler 友好？\"></a>Q:什么样的代码对 V8 Compiler 友好？</h4><p>虽然JavaScript是动态语言，如橡皮泥一样随意被开发者“随意”塑造、快速开发出一个又一个应用，但是没有规矩就会带来混乱，增加编译器的优化负担，目前在V8中优化工作由TurboFan完成。Ignition会收集大量信息交给TurboFan去优化，多方面条件都满足的情况下会被优化成机器码，这个过程成为<code>Optimize</code>，当判断无法优化时就触发去优化——Deoptimize，这些代码逻辑又重新回到Ignition中成为字节码。</p>\n<p>主要有以下2点<a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\" target=\"_blank\" rel=\"noopener\">视频</a></p>\n<ul>\n<li>自然是经常被调用的代码部分</li>\n<li>不要总是在改变对象类型（虽然JavaScript是动态的）</li>\n</ul>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-1.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-2.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-3.png\" alt=\"\"></p>\n<blockquote>\n<p>如果你总是在改变Objects，V8无法对它做优化。即使做了优化也会被De-optimisation，这意味着会有性能损失。</p>\n</blockquote>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">load</span>(<span class=\"hljs-params\">obj</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> obj.x</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">var</span> obj = &#123;</span><br><span class=\"line\">  x: <span class=\"hljs-number\">1</span>,</span><br><span class=\"line\">  y: <span class=\"hljs-number\">4</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对编译器而言 <code>obj = {}</code> 是一种类型， <code>obj = { x: &quot;Number&quot; }</code> 是另一种类型，<code>obj = { y: &quot;Number&quot; }</code> 又是一种类型等等，也就说数据类型和字段名必须一致，如果用过静态语言比如C++、Java就很容易理解。</p>\n<p>像下面这样的代码</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-number\">7</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-number\">9</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-number\">3</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-number\">1</span> &#125;);</span><br></pre></td></tr></table></figure>\n<p>没办法被优化，只有将参数的入参格式一致才行，比如</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-number\">7</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-number\">9</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-number\">1</span> &#125;);</span><br></pre></td></tr></table></figure>\n<p>是不是觉得学习TypeScript很重要了呢？</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p><code>V8</code>在不断的迭代和进步，还有<a href=\"https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html\" target=\"_blank\" rel=\"noopener\">Script Streaming</a>等等技术没有介绍。随便翻阅 <a href=\"https://v8.dev/\" target=\"_blank\" rel=\"noopener\">https://v8.dev/</a> 就会发现数不尽的干货在里面躺着，等我们动手发掘和尝试。作为一个JavaScript工程师而言，无论是学习V8还是其它的编译引擎都能使得我们更好的写出高性能代码、优化代码、甚至在做架构的时候提供帮助。</p>\n<p>另外，随着WebAssembly进入浏览器和Node.js，越来越多的C++等技术会被更方便的加入到JavaScript阵营当中。最近买了树莓派和Arduino，在它们身上使用JavaScript做一些功能多多少少离不开C/C++，感觉到了需要系统化学习C/C++的时候了。</p>\n<h3 id=\"主要参考：\"><a href=\"#主要参考：\" class=\"headerlink\" title=\"主要参考：\"></a>主要参考：</h3><p><a href=\"https://www.youtube.com/watch?v=Fg7niTmNNLg\" target=\"_blank\" rel=\"noopener\">Parsing JavaScript - better lazy than eager</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\" target=\"_blank\" rel=\"noopener\">JavaScript engines - how do they even? </a></p>\n<p><a href=\"https://medium.com/reloading/javascript-start-up-performance-69200f43b201\" target=\"_blank\" rel=\"noopener\">JavaScript Start-up Performance</a></p>\n<p><a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103\" target=\"_blank\" rel=\"noopener\">V8: Hooking up the Ignition to the Turbofan</a></p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<blockquote>\n<p>此文介绍的内容已经算是<code>旧闻</code>了，17年的时候就有大量的文章介绍过了，只是2020年伊始的疫情把人困在家里实在无聊，重新翻来几个视频打发下时间，以下文字算是简单梳理，更多的瑰宝需要我们自己翻阅资料研究，<strong>文章中的很多数据应该都过时了吧，仅用来参考吧。</strong></p>\n</blockquote>\n<p><strong>Parer</strong>和<strong>Compiler</strong>是2个重要的过程和概念，理解它们可以帮助开发者根据业务需求写出对V8或其它JavaScript引擎更为“友善”的代码，毕竟花在这两个过程中的成本是巨大的。</p>\n<p><img src=\"/images/v8-parser-compiler/v8-pare-compile-cost.png\" alt=\"国外几大网站花在Parser上的时间大约在15-20%\"></p>","more":"<h1 id=\"Parser\"><a href=\"#Parser\" class=\"headerlink\" title=\"Parser\"></a><strong>Parser</strong></h1><p><img src=\"/images/v8-parser-compiler/parser-phase.png\" alt=\"红色部分就是接下来讨论的Parser部分\"></p>\n<p><strong>解析速率大约为 <code>1 MB / s</code></strong></p>\n<p><br></p>\n<h4 id=\"V8的Parser分2次解析：\"><a href=\"#V8的Parser分2次解析：\" class=\"headerlink\" title=\"V8的Parser分2次解析：\"></a><strong>V8的Parser分2次解析：</strong></h4><p><code>Layze（Pre-Parsing）：</code></p>\n<ul>\n<li>跳过还未被使用的代码</li>\n<li>不会生成<code>AST</code>，会产生不带有变量引用和声明的<code>Scopes</code>信息</li>\n<li>解析速度是Eage的2倍</li>\n<li>根据JavaScript规范抛出一些特定的错误</li>\n</ul>\n<p><code>Eage（Full-Parsing）：</code></p>\n<ul>\n<li>解析那些被使用的代码</li>\n<li>生成<code>AST</code></li>\n<li>构建具体的<code>Scopes</code>信息，变量的引用、声明等</li>\n<li>抛出所有的语法错误</li>\n</ul>\n<p><br></p>\n<h4 id=\"Q-为什么会有2次解析？\"><a href=\"#Q-为什么会有2次解析？\" class=\"headerlink\" title=\"Q:为什么会有2次解析？\"></a>Q:为什么会有2次解析？</h4><p>如果都是用Full-Parsing的话，那么整个解析会非常漫长浪费时间。我们通过DevTools的<code>coverage</code>工具可以发现页面上大量的代码并没有被使用</p>\n<p><br></p>\n<h4 id=\"Q-2次解析会有什么负面影响？\"><a href=\"#Q-2次解析会有什么负面影响？\" class=\"headerlink\" title=\"Q:2次解析会有什么负面影响？\"></a>Q:2次解析会有什么负面影响？</h4><p>如果代码已经被Pre-Parsing解析过了，当被执行的时候还是会被Full-Parser解析一次那么开销是: <code>0.5 * parse + 1 * parse = 1.5 parse</code> 从某个角度来说更复杂了、开销更大了。鱼和熊掌不可兼得！</p>\n<p><br></p>\n<h4 id=\"Q-什么样的代码会被-Pre-Parsing-处理，什么样的会被-Full-Parsing-处理？\"><a href=\"#Q-什么样的代码会被-Pre-Parsing-处理，什么样的会被-Full-Parsing-处理？\" class=\"headerlink\" title=\"Q:什么样的代码会被 Pre-Parsing 处理，什么样的会被 Full-Parsing 处理？\"></a>Q:什么样的代码会被 <code>Pre-Parsing</code> 处理，什么样的会被 <code>Full-Parsing</code> 处理？</h4><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> a = <span class=\"number\">0</span>; <span class=\"comment\">// Top-Level 顶层的代码都是 Full-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 立即执行函数表达式 IIFE = Immediately Invoked Function Expression</span></span><br><span class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">eager</span>(<span class=\"params\"></span>) </span>&#123;...&#125;)(); <span class=\"comment\">// 函数体是 Full-Parsing</span></span><br><span class=\"line\">                   </span><br><span class=\"line\"><span class=\"comment\">// 顶层的函数非IIFE</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lazy</span>(<span class=\"params\"></span>) </span>&#123;...&#125; <span class=\"comment\">// 函数体是 Pre-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\">lazy(); <span class=\"comment\">// -&gt; Full-Parsing 开始解析和编译！</span></span><br><span class=\"line\">                 </span><br><span class=\"line\"><span class=\"comment\">// 强制触发Full-Parsing解析</span></span><br><span class=\"line\">!<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">eager2</span>(<span class=\"params\"></span>) </span>&#123;...&#125;, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">eager3</span>(<span class=\"params\"></span>) </span>&#123;...&#125; <span class=\"comment\">// All eager</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">let</span> f1 = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lazy</span>(<span class=\"params\"></span>) </span>&#123; ... &#125;; <span class=\"comment\">// 函数体是 Pre-Parsing</span></span><br><span class=\"line\">              </span><br><span class=\"line\"><span class=\"keyword\">let</span> f2 = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lazy</span>(<span class=\"params\"></span>) </span>&#123;...&#125;(); <span class=\"comment\">// 先触发了lazy 解析, 然后又eager解析</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h4 id=\"Q-如何强制Full-Parsing-（eager-）？\"><a href=\"#Q-如何强制Full-Parsing-（eager-）？\" class=\"headerlink\" title=\"Q:如何强制Full-Parsing （eager ）？\"></a>Q:如何强制Full-Parsing （eager ）？</h4><ul>\n<li>lazy 预编译由前2位首字母决定；所以如果我们想跳过 lazy 触发 eager 编译，我们应该在前面加位操作符，例如’!|~’。</li>\n<li>使用 <a href=\"https://github.com/nolanlawson/optimize-js\" target=\"_blank\" rel=\"noopener\">optimize-js</a> 重新编译代码，具体的性改变可以参考它Github里的测试数据</li>\n</ul>\n<p><br></p>\n<h4 id=\"Q-什么是连续重新解析\"><a href=\"#Q-什么是连续重新解析\" class=\"headerlink\" title=\"Q:什么是连续重新解析\"></a>Q:什么是连续重新解析</h4><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lazy_outer</span>(<span class=\"params\"></span>) </span>&#123; <span class=\"comment\">// lazy parse this</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">inner</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">inner2</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">lazy_outer(); <span class=\"comment\">// lazy parsing inner &amp; inner2</span></span><br><span class=\"line\">inner(); <span class=\"comment\">// lazy parsing inner &amp; inner2 (3rd time!)</span></span><br></pre></td></tr></table></figure>\n<p>从上可知，大量的深度内嵌的代码对解析有着性能影响，每一层的深度调用都会引发新一轮的<code>Pre-Parsing</code>。</p>\n<p><br></p>\n<h4 id=\"Q-既然Parser阶段会性能消耗很大，我们该怎么优化代码？\"><a href=\"#Q-既然Parser阶段会性能消耗很大，我们该怎么优化代码？\" class=\"headerlink\" title=\"Q:既然Parser阶段会性能消耗很大，我们该怎么优化代码？\"></a>Q:既然Parser阶段会性能消耗很大，我们该怎么优化代码？</h4><ol>\n<li><strong>尽量减少代码</strong>，可以通过DevTools的<code>coverage</code>工具查看当前页面代码的使用率。</li>\n<li>V8会缓存Parser阶段的结果并保存72小时，如果bundle中间有部分代码被修改了，那么整个bundle的Parser缓存都会失效，所以把经常变动的打包在一起，非经常变动的在一起，比如公共类库和业务代码分离。</li>\n</ol>\n<p><br></p>\n<h4 id=\"Q-如何评估当前网站代码的Parser时间呢？（包括后面将的Compiler时间）\"><a href=\"#Q-如何评估当前网站代码的Parser时间呢？（包括后面将的Compiler时间）\" class=\"headerlink\" title=\"Q:如何评估当前网站代码的Parser时间呢？（包括后面将的Compiler时间）\"></a>Q:如何评估当前网站代码的Parser时间呢？（包括后面将的Compiler时间）</h4><p>1.使用 <code>chrome://tracing/</code>工具，我们以<a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\">爱眠物</a>为例</p>\n<p>2.打开tracing界面，点击左上角的<code>Record</code>按钮</p>\n<p>3.在弹出的界面中选择<code>Web developer</code>和在Edit categories里面选择<code>v8.runtime_stats</code></p>\n<p>4.在新的Tab中输入 <a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\">http://aimianwu.com</a> ，回到tracing Tab</p>\n<p>5.等待数据采集完成，然后”停止”记录</p>\n<p>6.选择对应的Process和数据</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-1.png\" alt=\"\"></p>\n<p>7.查看V8里的Parse和Compile数据</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-2.png\" alt=\"\"></p>\n<p><br></p>\n<p><br></p>\n<h1 id=\"Compiler-Pipeline\"><a href=\"#Compiler-Pipeline\" class=\"headerlink\" title=\"Compiler Pipeline\"></a><strong>Compiler Pipeline</strong></h1><p>随着V8的迭代，整个Compiler Pipeline也在发生翻天覆地的变化。最近的一次大更新是在V8 5.9版本，用 Ignition + TurboFan 代替了从2010一直服务的Full-codegen + Crankshaft组合，当然整个过程也不是一蹴而就的，中间夹杂着特殊的版本， Ignition + TurboFan 、Full-codegen + Crankshaft它们以特殊的方式共存了一段时间，因为一开始TurboFan的性能无法满足需求，可以看<a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389\" target=\"_blank\" rel=\"noopener\">这个PPT</a>。</p>\n<p><br></p>\n<h4 id=\"Q-为什么做了替换？官方介绍\"><a href=\"#Q-为什么做了替换？官方介绍\" class=\"headerlink\" title=\"Q:为什么做了替换？官方介绍\"></a>Q:为什么做了替换？<a href=\"https://v8.dev/blog/launching-ignition-and-turbofan\" target=\"_blank\" rel=\"noopener\">官方介绍</a></h4><p>因为老的版本比较激进，直接将JavaScript翻译成了机器码，在执行性能上确实很快，但是带来了几个大问题</p>\n<ul>\n<li>直接将JavaScript编译成机器码既费时间又费内存，几乎占用了V8约1/3的堆内存，导致实际可被使用的内存减少；另外由于复杂的设计导致Crankshaft重复编译代码，拖累性能。</li>\n<li>Crankshaft没有友善处理 try、catch、finally 等关键词 ；维护成本高，需要为多个芯片架构提供优化代码，但性能提升不够明显；对ES新的语法特性支持不够好、也无法支持WebAssembly；<br>在PC端老的组合感受还好，但是在移动端随着网页的不断复杂化，该组合的启动时间和性能慢慢有些力不从心了。</li>\n</ul>\n<p><br></p>\n<h4 id=\"Q-什么样的代码对-V8-Compiler-友好？\"><a href=\"#Q-什么样的代码对-V8-Compiler-友好？\" class=\"headerlink\" title=\"Q:什么样的代码对 V8 Compiler 友好？\"></a>Q:什么样的代码对 V8 Compiler 友好？</h4><p>虽然JavaScript是动态语言，如橡皮泥一样随意被开发者“随意”塑造、快速开发出一个又一个应用，但是没有规矩就会带来混乱，增加编译器的优化负担，目前在V8中优化工作由TurboFan完成。Ignition会收集大量信息交给TurboFan去优化，多方面条件都满足的情况下会被优化成机器码，这个过程成为<code>Optimize</code>，当判断无法优化时就触发去优化——Deoptimize，这些代码逻辑又重新回到Ignition中成为字节码。</p>\n<p>主要有以下2点<a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\" target=\"_blank\" rel=\"noopener\">视频</a></p>\n<ul>\n<li>自然是经常被调用的代码部分</li>\n<li>不要总是在改变对象类型（虽然JavaScript是动态的）</li>\n</ul>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-1.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-2.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-3.png\" alt=\"\"></p>\n<blockquote>\n<p>如果你总是在改变Objects，V8无法对它做优化。即使做了优化也会被De-optimisation，这意味着会有性能损失。</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">load</span>(<span class=\"params\">obj</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> obj.x</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> obj = &#123;</span><br><span class=\"line\">  x: <span class=\"number\">1</span>,</span><br><span class=\"line\">  y: <span class=\"number\">4</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对编译器而言 <code>obj = {}</code> 是一种类型， <code>obj = { x: &quot;Number&quot; }</code> 是另一种类型，<code>obj = { y: &quot;Number&quot; }</code> 又是一种类型等等，也就说数据类型和字段名必须一致，如果用过静态语言比如C++、Java就很容易理解。</p>\n<p>像下面这样的代码</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"number\">7</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">9</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">c</span>: <span class=\"number\">3</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">d</span>: <span class=\"number\">1</span> &#125;);</span><br></pre></td></tr></table></figure>\n<p>没办法被优化，只有将参数的入参格式一致才行，比如</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"number\">7</span>, <span class=\"attr\">b</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">c</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">d</span>: <span class=\"literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">b</span>: <span class=\"number\">9</span>, <span class=\"attr\">c</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">d</span>: <span class=\"literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">b</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">c</span>: <span class=\"number\">3</span>, <span class=\"attr\">d</span>: <span class=\"literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">b</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">c</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">d</span>: <span class=\"number\">1</span> &#125;);</span><br></pre></td></tr></table></figure>\n<p>是不是觉得学习TypeScript很重要了呢？</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p><code>V8</code>在不断的迭代和进步，还有<a href=\"https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html\" target=\"_blank\" rel=\"noopener\">Script Streaming</a>等等技术没有介绍。随便翻阅 <a href=\"https://v8.dev/\" target=\"_blank\" rel=\"noopener\">https://v8.dev/</a> 就会发现数不尽的干货在里面躺着，等我们动手发掘和尝试。作为一个JavaScript工程师而言，无论是学习V8还是其它的编译引擎都能使得我们更好的写出高性能代码、优化代码、甚至在做架构的时候提供帮助。</p>\n<p>另外，随着WebAssembly进入浏览器和Node.js，越来越多的C++等技术会被更方便的加入到JavaScript阵营当中。最近买了树莓派和Arduino，在它们身上使用JavaScript做一些功能多多少少离不开C/C++，感觉到了需要系统化学习C/C++的时候了。</p>\n<h3 id=\"主要参考：\"><a href=\"#主要参考：\" class=\"headerlink\" title=\"主要参考：\"></a>主要参考：</h3><p><a href=\"https://www.youtube.com/watch?v=Fg7niTmNNLg\" target=\"_blank\" rel=\"noopener\">Parsing JavaScript - better lazy than eager</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\" target=\"_blank\" rel=\"noopener\">JavaScript engines - how do they even? </a></p>\n<p><a href=\"https://medium.com/reloading/javascript-start-up-performance-69200f43b201\" target=\"_blank\" rel=\"noopener\">JavaScript Start-up Performance</a></p>\n<p><a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103\" target=\"_blank\" rel=\"noopener\">V8: Hooking up the Ignition to the Turbofan</a></p>"},{"title":"Vue Component 继承与复用","date":"2018-11-17T06:45:00.000Z","_content":"在做Web前端开发的时候会有大量的页面复用的地方，从UI布局到JS的逻辑。早年做后端开发的时候，我们通常可以通过面向对象的编程法式，使用抽象类、接口等等，那么现在前端是否也可以如此呢？\n\n答案自然是肯定的，所以我们找工作面试的时候常被问及关于JS继承的问题，随之ES6出现了期盼已久的Class，一切都在往更为成熟的方向发展。接下我们以[Vue](https://vuejs.org/)为例，看看怎么去做继承这件事情。\n\n<!-- more -->\n\n### 需求描述\n\n简单实现2个列表页面，一个是管理员列表、一个用户列表\n\n![图一 管理员列表页面，筛选有用户名、状态，列表有用户名、手机号码、状态、\"修改\"操作按钮](/images/vue-component-extends/1.jpg)\n\n![图二 用户页列表面有，筛选有用户名、手机号、状态，列表有用户名、手机号码、创建时间、状态、\"删除\"操作按钮](/images/vue-component-extends/2.jpg)\n\n从上可以看出2个页面整体页面结构相同，在具体细节上会有些少于不同，第一反应就是使用前文提到的继承之类的东西去实现它。\n![图三 简单的继承图](/images/vue-component-extends/3.jpg)\n\n### 环境\n\n- Vue 版本 2.5\n\n- [Element-UI](http://element.eleme.io/) （仅仅使得Demo看上去不那么丑）\n\n- [测试代码](https://github.com/miser/vue-compoent-extends-experiment)\n\n\n### 步骤\n\n通过vue cli工具创建项目\n```js\nvue create vue-component-extedns\n```\n\n此刻我们可以拥有一个Vue的默认开发目录结构和代码，我开始对其进行修改\n\n\n__引入Element-UI__\n\n```js\n// main.js \nimport Vue from 'vue'\nimport ElementUI from 'element-ui'\nimport 'element-ui/lib/theme-chalk/index.css'\nimport App from './App.vue'\n\nVue.config.productionTip = false\nVue.use(ElementUI)\n\nnew Vue({\n  render: h => h(App)\n}).$mount('#app')\n\n```\n\n在components目录下分别创建ListPageAbstract.vue、AdminPageAbstract.vue、ButtonClick.vue和Title.vue\n\n*下面代码很多可以先跳过，看后续的介绍*\n\n```html\n// ButtonClick.vue\n<template>\n<div>\n  <el-button size=\"small\" plain type=\"primary\" @click.stop=\"click\">\n    {{ label }}\n  </el-button>\n</div>\n</template>\n<script type=\"text/javascript\">\n  export default {\n    props: ['click', 'label', 'opt'],\n    mounted () {\n      console.log('ButtonClick mounted')\n    }\n  }\n</script>\n\n// Title.vue\n<template>\n  <div class=\"title\">{{ title }}</div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['title']\n}\n</script>\n\n// ListPageAbstract.vue\n<template>\n  <div>\n    <Title :title=\"title\" />\n    <div>\n      <el-form v-if=\"config && config.filter\" ref='form' :inline=\"true\" :model=\"filterForm\">\n        <el-form-item v-if=\"config.filter.conditions.indexOf('name') >= 0\" label=\"名字\" prop=\"name\">\n          <el-input v-model=\"filterForm.name\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('phone') >= 0\" label=\"手机\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('date') >= 0\" label=\"时间\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('status') >= 0\" label=\"状态\" prop=\"status\">\n          <el-select v-model=\"filterForm.status\" placeholder=\"请选择\">\n            <el-option v-for=\"option in statusOptions\" :label=\"option.text\" :value=\"option.value\" :key=\"option.value\"></el-option>\n          </el-select>\n        </el-form-item>\n        <!-- <div>\n        <slot name=\"filter-slot\"></slot>\n        </div> -->\n        <el-form-item>\n          <el-button type=\"primary\" @click.stop=\"config.filter.action\">提交</el-button>\n        </el-form-item>\n      </el-form>\n    </div>\n    <el-table v-if=\"config\" :data=\"list\" >\n      <el-table-column v-for=\"(item, index) in config.table.column\" :key=\"index\"\n      :prop=\"item.key\" :label=\"item.label\">\n      </el-table-column>\n      <el-table-column v-if=\"config.table.action\" :label=\"config.table.action.headerLabel\">\n      <template slot-scope=\"scope\">\n      <Button :click=\"config.table.action.click.bind(null, scope.row)\" :label=\"config.table.action.label\" :opt=\"config.table.action\" />\n      </template>\n      </el-table-column>\n    </el-table>\n  </div>\n</template>\n<script type=\"text/javascript\">\nimport Button from './ButtonClick.vue'\nimport Title from './Title.vue'\n\nexport default {\n  components: { Button, Title },\n  data: function () {\n    return {\n      filterForm: { },\n      statusOptions: [],\n      list: [],\n      title: null,\n      config: null\n    }\n  },\n  mounted: function () {\n    this.config = this.createConfig()\n    this.fetchOptions()\n    this.fetchData()\n  },\n  methods: {\n    createConfig () {\n      let config = {}\n      config.filter = {\n        conditions: [ 'name', 'status' ],\n        action: () => {\n          this.fetchData(this.filterForm)\n        }\n      }\n      config.table = {\n        column: [\n          { key: 'name', label: '用户名' },\n          { key: 'phone', label: '手机号码' },\n          { key: 'status', label: '状态' }\n        ],\n        action: {\n          headerLabel: '操作',\n          label: '修改',\n          click: this.editRow\n        }\n      }\n      return config\n    },\n    fetchOptions () {\n      this.statusOptions = [\n        { value: 1, text: 'status1' },\n        { value: 2, text: 'status2' }\n      ]\n    },\n    async fetchData () { },\n    editRow (item) {\n      console.log(`update data => ${item.name}`)\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  color: red;\n  margin-bottom: 20px;\n}\n</style>\n\n// AdminListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract'\n// 模拟ajax请求\n// 仅做了名字的模糊查询，其他参数忽略\nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'Admin Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'Admin Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'Admin Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'Admin Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  data () {\n    return {\n      title: '管理员列表'\n    }\n  },\n  methods: {\n    fetchOptions () {\n      ListPageAbstract.methods.fetchOptions.call(this)\n      console.log('to do other thing')\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    }\n  }\n}\n</script>\n```\n\n刷新页面就能呈现上述图一展示的样子和功能了。那么洋洋洒洒这么多代码做了些什么呢？\n\n- Title.vue 用于显示页面的标题（之后我们用它测试下继承于ListPageAbstract.vue的组件如何重写css的问题）\n- ButtonClick.vue 展示操作按钮和执行操作事件\n- ListPageAbstract.vue 抽象的列表组件，这里是作为例子，具体方法定义的粗细程度根据具体情况调节\n- AdminListPage.vue 管理员列表的具体组件\n\nAdminListPage通过[extends](https://cn.vuejs.org/v2/api/#extends)继承了ListPageAbstract的模板、样式和其JS代码，通过部分的重写或完善，很容易的实现了一个页面，看上去很美好。那么新的问题来了，我们也发现ListPageAbstract定义筛选的内容是有限的，目前仅仅有name、phone、date和status，如果想扩展该怎么办呢？用过Vue的朋友或许此刻会想到[Slot](https://cn.vuejs.org/v2/api/#slot)，接下来我们注释掉ListPageAbstract.vue里关于__filter-slot__的注释，并为AdminListPage.vue添加相关slot代码。\n\n```html\n// AdminListPage.vue add template \n<template slot=\"filter-slot\">\n  <div slot=\"filter-slot\">\n    other input filter\n  </div>\n</template>\n<script type=\"text/javascript\">\n```\n\n刷新页面，页面仅仅留下了“other input filter”一串字符串，并没有实现我们的需求；也有人提出其它修改意见\n\n![图四 除了“other input filter”其它都没了](/images/vue-component-extends/4.jpg)\n\n```html\n// AdminListPage.vue \n<template slot=\"filter-slot\">\n  <Page>\n    <div slot=\"filter-slot\">\n      other input filter\n    </div>\n  </Page>\n</template>\nexport default {\n  extends: ListPageAbstract,\n  components: {\n    Page: ListPageAbstract,\n  }\n  // ...\n}\n```\n\n虽然页面UI层是预期显示了，但是如果对ListPageAbstract的mounted方法打断点会发现，它被执行了2次，因为被实例化了2次，并且页面上的元素事件使用的是ListPageAbstract里的，而不是我们在Admin里面重写的，显然方法并不可行。关于Vue模板级别的继承扩展问题在github上有很多的吐槽，但并没有列为未来的新feature [#6811](https://github.com/vuejs/vue/issues/6811)\n\n既然我们讨论这个问题，自然也是可以解决的，在这我们不以filter查询条件的多少为例子，我们以更为简单的按钮为例，在列表里每一行的最后有一个“修改”按钮，而然我们在UserListPage里面，我们希望它变成一个“删除”按钮，并弹出确实删除的提示。新增ButtonPop.vue和UserListPage.vue\n\n*又是很多代码，没兴趣可跳过*\n\n```html\n// ButtonPop.vue\n<template>\n  <div>\n    <el-button size=\"small\" plain type=\"primary\"\n      @click.stop=\"dialogVisible = true\">{{ label }}</el-button>\n    <el-dialog\n      title=\"提示\"\n      :visible.sync=\"dialogVisible\"\n      width=\"30%\">\n      <span>确认删除数据吗？</span>\n      <span slot=\"footer\" class=\"dialog-footer\">\n      <el-button @click=\"dialogVisible = false\">取 消</el-button>\n      <el-button type=\"primary\" @click=\"deleteInfo\">确 定</el-button>\n      </span>\n    </el-dialog>\n  </div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['click', 'label', 'opt'],\n  data () {\n    return {\n      dialogVisible: false\n    }\n  },\n  mounted () {\n    console.log('ButtonPop mounted')\n  },\n  methods: {\n    async deleteInfo () {\n      await this.click()\n      this.dialogVisible = false\n    }\n  }\n}\n</script>\n\n// UserListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract.vue'\nimport Button from './ButtonPop.vue'\n// 模拟ajax请求\n// 仅做了名字的模糊查询，其他参数忽略\nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'User Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'User Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'User Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'User Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  components: { Button },\n  data: function () { return {} },\n  mounted: function () {\n    this.title = '用户列表'\n  },\n  methods: {\n    createConfig () {\n      // 用户名、创建时间、手机号、状态\n      let config = ListPageAbstract.methods.createConfig.call(this)\n      config.filter.conditions.splice(1, 0, 'phone')\n\n      let table = config.table\n      table.column.push({ key: 'date', label: '时间' })\n      table.action = {\n        headerLabel: '操作',\n        label: '删除',\n        click: this.deleteRow\n      }\n      return config\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    },\n    deleteRow (item) {\n      return new Promise((resolve, reject) => {\n        console.log(`delete date: ${item.name}`)\n        setTimeout(() => {\n          this.list.splice(this.list.indexOf(item), 1)\n          resolve()\n        }, 1000)\n      })\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  margin-bottom: 50px;\n  color: blue;\n}\n</style>\n```\n\n然后在修改下App.vue里面的Page引用，从AdminListPage改为UserListPage\n\n刷新页面，就和图二的样子一样了。整个代码并不复杂，核心就是\n\n```js\n  components: { Button }\n```\n\n它将父类的Button（ButtonClick）替换成了User页面需要的ButtonPop，实现了扩展。其实Filter查询条件也可以，只要我们做好组件的抽取等就行。\n\n__阅读Vue的源码时候，在Vue组件实例化的过程中，会有很多对options的深层次merge，使得我们可以通过上诉方法实现对父组件的扩展。__\n\n另外，细心的朋友观察代码或页面也发现“用户列表”4个字的颜色从红色变成了蓝色，与下面列表的间距也增大了不少，在User页面的style标签里就能很容易修改父组件的css样式。\n\n在Vue中，mixin、slot都是非常好用的工具，或许我们有时候也能改变思路，通过组件的替换构建出一个更为容易扩展的框架。\n","source":"_posts/vue-component-extends.md","raw":"---\ntitle: Vue Component 继承与复用\ncategory: JavaScript\ndate: 2018-11-17 14:45:00\n---\n在做Web前端开发的时候会有大量的页面复用的地方，从UI布局到JS的逻辑。早年做后端开发的时候，我们通常可以通过面向对象的编程法式，使用抽象类、接口等等，那么现在前端是否也可以如此呢？\n\n答案自然是肯定的，所以我们找工作面试的时候常被问及关于JS继承的问题，随之ES6出现了期盼已久的Class，一切都在往更为成熟的方向发展。接下我们以[Vue](https://vuejs.org/)为例，看看怎么去做继承这件事情。\n\n<!-- more -->\n\n### 需求描述\n\n简单实现2个列表页面，一个是管理员列表、一个用户列表\n\n![图一 管理员列表页面，筛选有用户名、状态，列表有用户名、手机号码、状态、\"修改\"操作按钮](/images/vue-component-extends/1.jpg)\n\n![图二 用户页列表面有，筛选有用户名、手机号、状态，列表有用户名、手机号码、创建时间、状态、\"删除\"操作按钮](/images/vue-component-extends/2.jpg)\n\n从上可以看出2个页面整体页面结构相同，在具体细节上会有些少于不同，第一反应就是使用前文提到的继承之类的东西去实现它。\n![图三 简单的继承图](/images/vue-component-extends/3.jpg)\n\n### 环境\n\n- Vue 版本 2.5\n\n- [Element-UI](http://element.eleme.io/) （仅仅使得Demo看上去不那么丑）\n\n- [测试代码](https://github.com/miser/vue-compoent-extends-experiment)\n\n\n### 步骤\n\n通过vue cli工具创建项目\n```js\nvue create vue-component-extedns\n```\n\n此刻我们可以拥有一个Vue的默认开发目录结构和代码，我开始对其进行修改\n\n\n__引入Element-UI__\n\n```js\n// main.js \nimport Vue from 'vue'\nimport ElementUI from 'element-ui'\nimport 'element-ui/lib/theme-chalk/index.css'\nimport App from './App.vue'\n\nVue.config.productionTip = false\nVue.use(ElementUI)\n\nnew Vue({\n  render: h => h(App)\n}).$mount('#app')\n\n```\n\n在components目录下分别创建ListPageAbstract.vue、AdminPageAbstract.vue、ButtonClick.vue和Title.vue\n\n*下面代码很多可以先跳过，看后续的介绍*\n\n```html\n// ButtonClick.vue\n<template>\n<div>\n  <el-button size=\"small\" plain type=\"primary\" @click.stop=\"click\">\n    {{ label }}\n  </el-button>\n</div>\n</template>\n<script type=\"text/javascript\">\n  export default {\n    props: ['click', 'label', 'opt'],\n    mounted () {\n      console.log('ButtonClick mounted')\n    }\n  }\n</script>\n\n// Title.vue\n<template>\n  <div class=\"title\">{{ title }}</div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['title']\n}\n</script>\n\n// ListPageAbstract.vue\n<template>\n  <div>\n    <Title :title=\"title\" />\n    <div>\n      <el-form v-if=\"config && config.filter\" ref='form' :inline=\"true\" :model=\"filterForm\">\n        <el-form-item v-if=\"config.filter.conditions.indexOf('name') >= 0\" label=\"名字\" prop=\"name\">\n          <el-input v-model=\"filterForm.name\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('phone') >= 0\" label=\"手机\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('date') >= 0\" label=\"时间\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('status') >= 0\" label=\"状态\" prop=\"status\">\n          <el-select v-model=\"filterForm.status\" placeholder=\"请选择\">\n            <el-option v-for=\"option in statusOptions\" :label=\"option.text\" :value=\"option.value\" :key=\"option.value\"></el-option>\n          </el-select>\n        </el-form-item>\n        <!-- <div>\n        <slot name=\"filter-slot\"></slot>\n        </div> -->\n        <el-form-item>\n          <el-button type=\"primary\" @click.stop=\"config.filter.action\">提交</el-button>\n        </el-form-item>\n      </el-form>\n    </div>\n    <el-table v-if=\"config\" :data=\"list\" >\n      <el-table-column v-for=\"(item, index) in config.table.column\" :key=\"index\"\n      :prop=\"item.key\" :label=\"item.label\">\n      </el-table-column>\n      <el-table-column v-if=\"config.table.action\" :label=\"config.table.action.headerLabel\">\n      <template slot-scope=\"scope\">\n      <Button :click=\"config.table.action.click.bind(null, scope.row)\" :label=\"config.table.action.label\" :opt=\"config.table.action\" />\n      </template>\n      </el-table-column>\n    </el-table>\n  </div>\n</template>\n<script type=\"text/javascript\">\nimport Button from './ButtonClick.vue'\nimport Title from './Title.vue'\n\nexport default {\n  components: { Button, Title },\n  data: function () {\n    return {\n      filterForm: { },\n      statusOptions: [],\n      list: [],\n      title: null,\n      config: null\n    }\n  },\n  mounted: function () {\n    this.config = this.createConfig()\n    this.fetchOptions()\n    this.fetchData()\n  },\n  methods: {\n    createConfig () {\n      let config = {}\n      config.filter = {\n        conditions: [ 'name', 'status' ],\n        action: () => {\n          this.fetchData(this.filterForm)\n        }\n      }\n      config.table = {\n        column: [\n          { key: 'name', label: '用户名' },\n          { key: 'phone', label: '手机号码' },\n          { key: 'status', label: '状态' }\n        ],\n        action: {\n          headerLabel: '操作',\n          label: '修改',\n          click: this.editRow\n        }\n      }\n      return config\n    },\n    fetchOptions () {\n      this.statusOptions = [\n        { value: 1, text: 'status1' },\n        { value: 2, text: 'status2' }\n      ]\n    },\n    async fetchData () { },\n    editRow (item) {\n      console.log(`update data => ${item.name}`)\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  color: red;\n  margin-bottom: 20px;\n}\n</style>\n\n// AdminListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract'\n// 模拟ajax请求\n// 仅做了名字的模糊查询，其他参数忽略\nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'Admin Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'Admin Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'Admin Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'Admin Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  data () {\n    return {\n      title: '管理员列表'\n    }\n  },\n  methods: {\n    fetchOptions () {\n      ListPageAbstract.methods.fetchOptions.call(this)\n      console.log('to do other thing')\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    }\n  }\n}\n</script>\n```\n\n刷新页面就能呈现上述图一展示的样子和功能了。那么洋洋洒洒这么多代码做了些什么呢？\n\n- Title.vue 用于显示页面的标题（之后我们用它测试下继承于ListPageAbstract.vue的组件如何重写css的问题）\n- ButtonClick.vue 展示操作按钮和执行操作事件\n- ListPageAbstract.vue 抽象的列表组件，这里是作为例子，具体方法定义的粗细程度根据具体情况调节\n- AdminListPage.vue 管理员列表的具体组件\n\nAdminListPage通过[extends](https://cn.vuejs.org/v2/api/#extends)继承了ListPageAbstract的模板、样式和其JS代码，通过部分的重写或完善，很容易的实现了一个页面，看上去很美好。那么新的问题来了，我们也发现ListPageAbstract定义筛选的内容是有限的，目前仅仅有name、phone、date和status，如果想扩展该怎么办呢？用过Vue的朋友或许此刻会想到[Slot](https://cn.vuejs.org/v2/api/#slot)，接下来我们注释掉ListPageAbstract.vue里关于__filter-slot__的注释，并为AdminListPage.vue添加相关slot代码。\n\n```html\n// AdminListPage.vue add template \n<template slot=\"filter-slot\">\n  <div slot=\"filter-slot\">\n    other input filter\n  </div>\n</template>\n<script type=\"text/javascript\">\n```\n\n刷新页面，页面仅仅留下了“other input filter”一串字符串，并没有实现我们的需求；也有人提出其它修改意见\n\n![图四 除了“other input filter”其它都没了](/images/vue-component-extends/4.jpg)\n\n```html\n// AdminListPage.vue \n<template slot=\"filter-slot\">\n  <Page>\n    <div slot=\"filter-slot\">\n      other input filter\n    </div>\n  </Page>\n</template>\nexport default {\n  extends: ListPageAbstract,\n  components: {\n    Page: ListPageAbstract,\n  }\n  // ...\n}\n```\n\n虽然页面UI层是预期显示了，但是如果对ListPageAbstract的mounted方法打断点会发现，它被执行了2次，因为被实例化了2次，并且页面上的元素事件使用的是ListPageAbstract里的，而不是我们在Admin里面重写的，显然方法并不可行。关于Vue模板级别的继承扩展问题在github上有很多的吐槽，但并没有列为未来的新feature [#6811](https://github.com/vuejs/vue/issues/6811)\n\n既然我们讨论这个问题，自然也是可以解决的，在这我们不以filter查询条件的多少为例子，我们以更为简单的按钮为例，在列表里每一行的最后有一个“修改”按钮，而然我们在UserListPage里面，我们希望它变成一个“删除”按钮，并弹出确实删除的提示。新增ButtonPop.vue和UserListPage.vue\n\n*又是很多代码，没兴趣可跳过*\n\n```html\n// ButtonPop.vue\n<template>\n  <div>\n    <el-button size=\"small\" plain type=\"primary\"\n      @click.stop=\"dialogVisible = true\">{{ label }}</el-button>\n    <el-dialog\n      title=\"提示\"\n      :visible.sync=\"dialogVisible\"\n      width=\"30%\">\n      <span>确认删除数据吗？</span>\n      <span slot=\"footer\" class=\"dialog-footer\">\n      <el-button @click=\"dialogVisible = false\">取 消</el-button>\n      <el-button type=\"primary\" @click=\"deleteInfo\">确 定</el-button>\n      </span>\n    </el-dialog>\n  </div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['click', 'label', 'opt'],\n  data () {\n    return {\n      dialogVisible: false\n    }\n  },\n  mounted () {\n    console.log('ButtonPop mounted')\n  },\n  methods: {\n    async deleteInfo () {\n      await this.click()\n      this.dialogVisible = false\n    }\n  }\n}\n</script>\n\n// UserListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract.vue'\nimport Button from './ButtonPop.vue'\n// 模拟ajax请求\n// 仅做了名字的模糊查询，其他参数忽略\nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'User Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'User Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'User Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'User Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  components: { Button },\n  data: function () { return {} },\n  mounted: function () {\n    this.title = '用户列表'\n  },\n  methods: {\n    createConfig () {\n      // 用户名、创建时间、手机号、状态\n      let config = ListPageAbstract.methods.createConfig.call(this)\n      config.filter.conditions.splice(1, 0, 'phone')\n\n      let table = config.table\n      table.column.push({ key: 'date', label: '时间' })\n      table.action = {\n        headerLabel: '操作',\n        label: '删除',\n        click: this.deleteRow\n      }\n      return config\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    },\n    deleteRow (item) {\n      return new Promise((resolve, reject) => {\n        console.log(`delete date: ${item.name}`)\n        setTimeout(() => {\n          this.list.splice(this.list.indexOf(item), 1)\n          resolve()\n        }, 1000)\n      })\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  margin-bottom: 50px;\n  color: blue;\n}\n</style>\n```\n\n然后在修改下App.vue里面的Page引用，从AdminListPage改为UserListPage\n\n刷新页面，就和图二的样子一样了。整个代码并不复杂，核心就是\n\n```js\n  components: { Button }\n```\n\n它将父类的Button（ButtonClick）替换成了User页面需要的ButtonPop，实现了扩展。其实Filter查询条件也可以，只要我们做好组件的抽取等就行。\n\n__阅读Vue的源码时候，在Vue组件实例化的过程中，会有很多对options的深层次merge，使得我们可以通过上诉方法实现对父组件的扩展。__\n\n另外，细心的朋友观察代码或页面也发现“用户列表”4个字的颜色从红色变成了蓝色，与下面列表的间距也增大了不少，在User页面的style标签里就能很容易修改父组件的css样式。\n\n在Vue中，mixin、slot都是非常好用的工具，或许我们有时候也能改变思路，通过组件的替换构建出一个更为容易扩展的框架。\n","slug":"vue-component-extends","published":1,"updated":"2020-07-07T10:11:25.591Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs70001ld12itkordewq","content":"<p>在做Web前端开发的时候会有大量的页面复用的地方，从UI布局到JS的逻辑。早年做后端开发的时候，我们通常可以通过面向对象的编程法式，使用抽象类、接口等等，那么现在前端是否也可以如此呢？</p>\n<p>答案自然是肯定的，所以我们找工作面试的时候常被问及关于JS继承的问题，随之ES6出现了期盼已久的Class，一切都在往更为成熟的方向发展。接下我们以<a href=\"https://vuejs.org/\" target=\"_blank\" rel=\"noopener\">Vue</a>为例，看看怎么去做继承这件事情。</p>\n<a id=\"more\"></a>\n<h3 id=\"需求描述\"><a href=\"#需求描述\" class=\"headerlink\" title=\"需求描述\"></a>需求描述</h3><p>简单实现2个列表页面，一个是管理员列表、一个用户列表</p>\n<p><img src=\"/images/vue-component-extends/1.jpg\" alt=\"图一 管理员列表页面，筛选有用户名、状态，列表有用户名、手机号码、状态、&quot;修改&quot;操作按钮\"></p>\n<p><img src=\"/images/vue-component-extends/2.jpg\" alt=\"图二 用户页列表面有，筛选有用户名、手机号、状态，列表有用户名、手机号码、创建时间、状态、&quot;删除&quot;操作按钮\"></p>\n<p>从上可以看出2个页面整体页面结构相同，在具体细节上会有些少于不同，第一反应就是使用前文提到的继承之类的东西去实现它。<br><img src=\"/images/vue-component-extends/3.jpg\" alt=\"图三 简单的继承图\"></p>\n<h3 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h3><ul>\n<li><p>Vue 版本 2.5</p>\n</li>\n<li><p><a href=\"http://element.eleme.io/\" target=\"_blank\" rel=\"noopener\">Element-UI</a> （仅仅使得Demo看上去不那么丑）</p>\n</li>\n<li><p><a href=\"https://github.com/miser/vue-compoent-extends-experiment\" target=\"_blank\" rel=\"noopener\">测试代码</a></p>\n</li>\n</ul>\n<h3 id=\"步骤\"><a href=\"#步骤\" class=\"headerlink\" title=\"步骤\"></a>步骤</h3><p>通过vue cli工具创建项目<br><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vue create vue-component-extedns</span><br></pre></td></tr></table></figure></p>\n<p>此刻我们可以拥有一个Vue的默认开发目录结构和代码，我开始对其进行修改</p>\n<p><strong>引入Element-UI</strong></p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// main.js </span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> Vue <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'vue'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> ElementUI <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'element-ui'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> <span class=\"hljs-string\">'element-ui/lib/theme-chalk/index.css'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> App <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./App.vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.productionTip = <span class=\"hljs-literal\">false</span></span><br><span class=\"line\">Vue.use(ElementUI)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">new</span> Vue(&#123;</span><br><span class=\"line\">  render: <span class=\"hljs-function\"><span class=\"hljs-params\">h</span> =&gt;</span> h(App)</span><br><span class=\"line\">&#125;).$mount(<span class=\"hljs-string\">'#app'</span>)</span><br></pre></td></tr></table></figure>\n<p>在components目录下分别创建ListPageAbstract.vue、AdminPageAbstract.vue、ButtonClick.vue和Title.vue</p>\n<p><em>下面代码很多可以先跳过，看后续的介绍</em></p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonClick.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">\"small\"</span> <span class=\"hljs-attr\">plain</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"click\"</span>&gt;</span></span><br><span class=\"line\">    &#123;&#123; label &#125;&#125;</span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    props: [<span class=\"hljs-string\">'click'</span>, <span class=\"hljs-string\">'label'</span>, <span class=\"hljs-string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    mounted () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'ButtonClick mounted'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Title.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"title\"</span>&gt;</span>&#123;&#123; title &#125;&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  props: [<span class=\"hljs-string\">'title'</span>]</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// ListPageAbstract.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Title</span> <span class=\"hljs-attr\">:title</span>=<span class=\"hljs-string\">\"title\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config &amp;&amp; config.filter\"</span> <span class=\"hljs-attr\">ref</span>=<span class=\"hljs-string\">'form'</span> <span class=\"hljs-attr\">:inline</span>=<span class=\"hljs-string\">\"true\"</span> <span class=\"hljs-attr\">:model</span>=<span class=\"hljs-string\">\"filterForm\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('name') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"名字\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"name\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.name\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('phone') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"手机\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.date\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('date') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"时间\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.date\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('status') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"状态\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"status\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-select</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.status\"</span> <span class=\"hljs-attr\">placeholder</span>=<span class=\"hljs-string\">\"请选择\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-option</span> <span class=\"hljs-attr\">v-for</span>=<span class=\"hljs-string\">\"option in statusOptions\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"option.text\"</span> <span class=\"hljs-attr\">:value</span>=<span class=\"hljs-string\">\"option.value\"</span> <span class=\"hljs-attr\">:key</span>=<span class=\"hljs-string\">\"option.value\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-option</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-select</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">&lt;!-- &lt;div&gt;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">        &lt;slot name=\"filter-slot\"&gt;&lt;/slot&gt;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">        &lt;/div&gt; --&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"config.filter.action\"</span>&gt;</span>提交<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config\"</span> <span class=\"hljs-attr\">:data</span>=<span class=\"hljs-string\">\"list\"</span> &gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table-column</span> <span class=\"hljs-attr\">v-for</span>=<span class=\"hljs-string\">\"(item, index) in config.table.column\"</span> <span class=\"hljs-attr\">:key</span>=<span class=\"hljs-string\">\"index\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">:prop</span>=<span class=\"hljs-string\">\"item.key\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"item.label\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table-column</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.table.action\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"config.table.action.headerLabel\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot-scope</span>=<span class=\"hljs-string\">\"scope\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Button</span> <span class=\"hljs-attr\">:click</span>=<span class=\"hljs-string\">\"config.table.action.click.bind(null, scope.row)\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"config.table.action.label\"</span> <span class=\"hljs-attr\">:opt</span>=<span class=\"hljs-string\">\"config.table.action\"</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> Button <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ButtonClick.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> Title <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./Title.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  components: &#123; Button, Title &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  data: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      filterForm: &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      statusOptions: [],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      list: [],</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      title: <span class=\"hljs-literal\">null</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      config: <span class=\"hljs-literal\">null</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  mounted: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.config = <span class=\"hljs-keyword\">this</span>.createConfig()</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.fetchOptions()</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.fetchData()</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> config = &#123;&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      config.filter = &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        conditions: [ <span class=\"hljs-string\">'name'</span>, <span class=\"hljs-string\">'status'</span> ],</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        action: <span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          <span class=\"hljs-keyword\">this</span>.fetchData(<span class=\"hljs-keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      config.table = &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        column: [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          &#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'name'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">'用户名'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          &#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'phone'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">'手机号码'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          &#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'status'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">'状态'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        ],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        action: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          headerLabel: <span class=\"hljs-string\">'操作'</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          label: <span class=\"hljs-string\">'修改'</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          click: <span class=\"hljs-keyword\">this</span>.editRow</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.statusOptions = [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        &#123; <span class=\"hljs-attr\">value</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">text</span>: <span class=\"hljs-string\">'status1'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        &#123; <span class=\"hljs-attr\">value</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-attr\">text</span>: <span class=\"hljs-string\">'status2'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      ]</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    editRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`update data =&gt; <span class=\"hljs-subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">style</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  color: red;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  margin-bottom: 20px;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">style</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// AdminListPage.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> ListPageAbstract <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ListPageAbstract'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// 模拟ajax请求</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// 仅做了名字的模糊查询，其他参数忽略</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">search</span> (<span class=\"hljs-params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Peter'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'313141414'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Marry'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'123931873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status2'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Sue'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'342391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Join'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'143391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    ]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      list = list.filter(<span class=\"hljs-function\"><span class=\"hljs-params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      title: <span class=\"hljs-string\">'管理员列表'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      ListPageAbstract.methods.fetchOptions.call(<span class=\"hljs-keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'to do other thing'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> list = <span class=\"hljs-keyword\">await</span> search(<span class=\"hljs-keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>刷新页面就能呈现上述图一展示的样子和功能了。那么洋洋洒洒这么多代码做了些什么呢？</p>\n<ul>\n<li>Title.vue 用于显示页面的标题（之后我们用它测试下继承于ListPageAbstract.vue的组件如何重写css的问题）</li>\n<li>ButtonClick.vue 展示操作按钮和执行操作事件</li>\n<li>ListPageAbstract.vue 抽象的列表组件，这里是作为例子，具体方法定义的粗细程度根据具体情况调节</li>\n<li>AdminListPage.vue 管理员列表的具体组件</li>\n</ul>\n<p>AdminListPage通过<a href=\"https://cn.vuejs.org/v2/api/#extends\" target=\"_blank\" rel=\"noopener\">extends</a>继承了ListPageAbstract的模板、样式和其JS代码，通过部分的重写或完善，很容易的实现了一个页面，看上去很美好。那么新的问题来了，我们也发现ListPageAbstract定义筛选的内容是有限的，目前仅仅有name、phone、date和status，如果想扩展该怎么办呢？用过Vue的朋友或许此刻会想到<a href=\"https://cn.vuejs.org/v2/api/#slot\" target=\"_blank\" rel=\"noopener\">Slot</a>，接下来我们注释掉ListPageAbstract.vue里关于<strong>filter-slot</strong>的注释，并为AdminListPage.vue添加相关slot代码。</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue add template </span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">    other input filter</span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br></pre></td></tr></table></figure>\n<p>刷新页面，页面仅仅留下了“other input filter”一串字符串，并没有实现我们的需求；也有人提出其它修改意见</p>\n<p><img src=\"/images/vue-component-extends/4.jpg\" alt=\"图四 除了“other input filter”其它都没了\"></p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue </span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">      other input filter</span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Page</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">export default &#123;</span><br><span class=\"line\">  extends: ListPageAbstract,</span><br><span class=\"line\">  components: &#123;</span><br><span class=\"line\">    Page: ListPageAbstract,</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>虽然页面UI层是预期显示了，但是如果对ListPageAbstract的mounted方法打断点会发现，它被执行了2次，因为被实例化了2次，并且页面上的元素事件使用的是ListPageAbstract里的，而不是我们在Admin里面重写的，显然方法并不可行。关于Vue模板级别的继承扩展问题在github上有很多的吐槽，但并没有列为未来的新feature <a href=\"https://github.com/vuejs/vue/issues/6811\" target=\"_blank\" rel=\"noopener\">#6811</a></p>\n<p>既然我们讨论这个问题，自然也是可以解决的，在这我们不以filter查询条件的多少为例子，我们以更为简单的按钮为例，在列表里每一行的最后有一个“修改”按钮，而然我们在UserListPage里面，我们希望它变成一个“删除”按钮，并弹出确实删除的提示。新增ButtonPop.vue和UserListPage.vue</p>\n<p><em>又是很多代码，没兴趣可跳过</em></p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonPop.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">\"small\"</span> <span class=\"hljs-attr\">plain</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"dialogVisible = true\"</span>&gt;</span>&#123;&#123; label &#125;&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-dialog</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">title</span>=<span class=\"hljs-string\">\"提示\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">:visible.sync</span>=<span class=\"hljs-string\">\"dialogVisible\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">width</span>=<span class=\"hljs-string\">\"30%\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span>&gt;</span>确认删除数据吗？<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"footer\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"dialog-footer\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> @<span class=\"hljs-attr\">click</span>=<span class=\"hljs-string\">\"dialogVisible = false\"</span>&gt;</span>取 消<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click</span>=<span class=\"hljs-string\">\"deleteInfo\"</span>&gt;</span>确 定<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-dialog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  props: [<span class=\"hljs-string\">'click'</span>, <span class=\"hljs-string\">'label'</span>, <span class=\"hljs-string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      dialogVisible: <span class=\"hljs-literal\">false</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  mounted () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'ButtonPop mounted'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> deleteInfo () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">await</span> <span class=\"hljs-keyword\">this</span>.click()</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.dialogVisible = <span class=\"hljs-literal\">false</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// UserListPage.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> ListPageAbstract <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ListPageAbstract.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> Button <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ButtonPop.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// 模拟ajax请求</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// 仅做了名字的模糊查询，其他参数忽略</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">search</span> (<span class=\"hljs-params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Peter'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'313141414'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Marry'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'123931873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status2'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Sue'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'342391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Join'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'143391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    ]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      list = list.filter(<span class=\"hljs-function\"><span class=\"hljs-params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  components: &#123; Button &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  data: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123; <span class=\"hljs-keyword\">return</span> &#123;&#125; &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  mounted: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.title = <span class=\"hljs-string\">'用户列表'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-comment\">// 用户名、创建时间、手机号、状态</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> config = ListPageAbstract.methods.createConfig.call(<span class=\"hljs-keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      config.filter.conditions.splice(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-string\">'phone'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> table = config.table</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      table.column.push(&#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'date'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">'时间'</span> &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      table.action = &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        headerLabel: <span class=\"hljs-string\">'操作'</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        label: <span class=\"hljs-string\">'删除'</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        click: <span class=\"hljs-keyword\">this</span>.deleteRow</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> list = <span class=\"hljs-keyword\">await</span> search(<span class=\"hljs-keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    deleteRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`delete date: <span class=\"hljs-subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          <span class=\"hljs-keyword\">this</span>.list.splice(<span class=\"hljs-keyword\">this</span>.list.indexOf(item), <span class=\"hljs-number\">1</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">          resolve()</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">style</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  margin-bottom: 50px;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  color: blue;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">style</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>然后在修改下App.vue里面的Page引用，从AdminListPage改为UserListPage</p>\n<p>刷新页面，就和图二的样子一样了。整个代码并不复杂，核心就是</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">components: &#123; Button &#125;</span><br></pre></td></tr></table></figure>\n<p>它将父类的Button（ButtonClick）替换成了User页面需要的ButtonPop，实现了扩展。其实Filter查询条件也可以，只要我们做好组件的抽取等就行。</p>\n<p><strong>阅读Vue的源码时候，在Vue组件实例化的过程中，会有很多对options的深层次merge，使得我们可以通过上诉方法实现对父组件的扩展。</strong></p>\n<p>另外，细心的朋友观察代码或页面也发现“用户列表”4个字的颜色从红色变成了蓝色，与下面列表的间距也增大了不少，在User页面的style标签里就能很容易修改父组件的css样式。</p>\n<p>在Vue中，mixin、slot都是非常好用的工具，或许我们有时候也能改变思路，通过组件的替换构建出一个更为容易扩展的框架。</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[],"excerpt":"<p>在做Web前端开发的时候会有大量的页面复用的地方，从UI布局到JS的逻辑。早年做后端开发的时候，我们通常可以通过面向对象的编程法式，使用抽象类、接口等等，那么现在前端是否也可以如此呢？</p>\n<p>答案自然是肯定的，所以我们找工作面试的时候常被问及关于JS继承的问题，随之ES6出现了期盼已久的Class，一切都在往更为成熟的方向发展。接下我们以<a href=\"https://vuejs.org/\" target=\"_blank\" rel=\"noopener\">Vue</a>为例，看看怎么去做继承这件事情。</p>","more":"<h3 id=\"需求描述\"><a href=\"#需求描述\" class=\"headerlink\" title=\"需求描述\"></a>需求描述</h3><p>简单实现2个列表页面，一个是管理员列表、一个用户列表</p>\n<p><img src=\"/images/vue-component-extends/1.jpg\" alt=\"图一 管理员列表页面，筛选有用户名、状态，列表有用户名、手机号码、状态、&quot;修改&quot;操作按钮\"></p>\n<p><img src=\"/images/vue-component-extends/2.jpg\" alt=\"图二 用户页列表面有，筛选有用户名、手机号、状态，列表有用户名、手机号码、创建时间、状态、&quot;删除&quot;操作按钮\"></p>\n<p>从上可以看出2个页面整体页面结构相同，在具体细节上会有些少于不同，第一反应就是使用前文提到的继承之类的东西去实现它。<br><img src=\"/images/vue-component-extends/3.jpg\" alt=\"图三 简单的继承图\"></p>\n<h3 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h3><ul>\n<li><p>Vue 版本 2.5</p>\n</li>\n<li><p><a href=\"http://element.eleme.io/\" target=\"_blank\" rel=\"noopener\">Element-UI</a> （仅仅使得Demo看上去不那么丑）</p>\n</li>\n<li><p><a href=\"https://github.com/miser/vue-compoent-extends-experiment\" target=\"_blank\" rel=\"noopener\">测试代码</a></p>\n</li>\n</ul>\n<h3 id=\"步骤\"><a href=\"#步骤\" class=\"headerlink\" title=\"步骤\"></a>步骤</h3><p>通过vue cli工具创建项目<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vue create vue-component-extedns</span><br></pre></td></tr></table></figure></p>\n<p>此刻我们可以拥有一个Vue的默认开发目录结构和代码，我开始对其进行修改</p>\n<p><strong>引入Element-UI</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// main.js </span></span><br><span class=\"line\"><span class=\"keyword\">import</span> Vue <span class=\"keyword\">from</span> <span class=\"string\">'vue'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> ElementUI <span class=\"keyword\">from</span> <span class=\"string\">'element-ui'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">'element-ui/lib/theme-chalk/index.css'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> App <span class=\"keyword\">from</span> <span class=\"string\">'./App.vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.productionTip = <span class=\"literal\">false</span></span><br><span class=\"line\">Vue.use(ElementUI)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">new</span> Vue(&#123;</span><br><span class=\"line\">  render: <span class=\"function\"><span class=\"params\">h</span> =&gt;</span> h(App)</span><br><span class=\"line\">&#125;).$mount(<span class=\"string\">'#app'</span>)</span><br></pre></td></tr></table></figure>\n<p>在components目录下分别创建ListPageAbstract.vue、AdminPageAbstract.vue、ButtonClick.vue和Title.vue</p>\n<p><em>下面代码很多可以先跳过，看后续的介绍</em></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonClick.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">size</span>=<span class=\"string\">\"small\"</span> <span class=\"attr\">plain</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span> @<span class=\"attr\">click.stop</span>=<span class=\"string\">\"click\"</span>&gt;</span></span><br><span class=\"line\">    &#123;&#123; label &#125;&#125;</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    props: [<span class=\"string\">'click'</span>, <span class=\"string\">'label'</span>, <span class=\"string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"undefined\">    mounted () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">'ButtonClick mounted'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Title.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"title\"</span>&gt;</span>&#123;&#123; title &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  props: [<span class=\"string\">'title'</span>]</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// ListPageAbstract.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Title</span> <span class=\"attr\">:title</span>=<span class=\"string\">\"title\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-form</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config &amp;&amp; config.filter\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">'form'</span> <span class=\"attr\">:inline</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">:model</span>=<span class=\"string\">\"filterForm\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('name') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"名字\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"name\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.name\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('phone') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"手机\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.date\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('date') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"时间\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.date\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('status') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"状态\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"status\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-select</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.status\"</span> <span class=\"attr\">placeholder</span>=<span class=\"string\">\"请选择\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">el-option</span> <span class=\"attr\">v-for</span>=<span class=\"string\">\"option in statusOptions\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"option.text\"</span> <span class=\"attr\">:value</span>=<span class=\"string\">\"option.value\"</span> <span class=\"attr\">:key</span>=<span class=\"string\">\"option.value\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-option</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">el-select</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- &lt;div&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;slot name=\"filter-slot\"&gt;&lt;/slot&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;/div&gt; --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span> @<span class=\"attr\">click.stop</span>=<span class=\"string\">\"config.filter.action\"</span>&gt;</span>提交<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-form</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-table</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config\"</span> <span class=\"attr\">:data</span>=<span class=\"string\">\"list\"</span> &gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-table-column</span> <span class=\"attr\">v-for</span>=<span class=\"string\">\"(item, index) in config.table.column\"</span> <span class=\"attr\">:key</span>=<span class=\"string\">\"index\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">:prop</span>=<span class=\"string\">\"item.key\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"item.label\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-table-column</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.table.action\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"config.table.action.headerLabel\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot-scope</span>=<span class=\"string\">\"scope\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Button</span> <span class=\"attr\">:click</span>=<span class=\"string\">\"config.table.action.click.bind(null, scope.row)\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"config.table.action.label\"</span> <span class=\"attr\">:opt</span>=<span class=\"string\">\"config.table.action\"</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">el-table</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> Button <span class=\"keyword\">from</span> <span class=\"string\">'./ButtonClick.vue'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> Title <span class=\"keyword\">from</span> <span class=\"string\">'./Title.vue'</span></span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  components: &#123; Button, Title &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  data: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      filterForm: &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">      statusOptions: [],</span></span><br><span class=\"line\"><span class=\"undefined\">      list: [],</span></span><br><span class=\"line\"><span class=\"javascript\">      title: <span class=\"literal\">null</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">      config: <span class=\"literal\">null</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  mounted: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.config = <span class=\"keyword\">this</span>.createConfig()</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.fetchOptions()</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.fetchData()</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> config = &#123;&#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      config.filter = &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        conditions: [ <span class=\"string\">'name'</span>, <span class=\"string\">'status'</span> ],</span></span><br><span class=\"line\"><span class=\"javascript\">        action: <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">this</span>.fetchData(<span class=\"keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      config.table = &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">        column: [</span></span><br><span class=\"line\"><span class=\"javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">'name'</span>, <span class=\"attr\">label</span>: <span class=\"string\">'用户名'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">'phone'</span>, <span class=\"attr\">label</span>: <span class=\"string\">'手机号码'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">'status'</span>, <span class=\"attr\">label</span>: <span class=\"string\">'状态'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">        ],</span></span><br><span class=\"line\"><span class=\"undefined\">        action: &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          headerLabel: <span class=\"string\">'操作'</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">          label: <span class=\"string\">'修改'</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">          click: <span class=\"keyword\">this</span>.editRow</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.statusOptions = [</span></span><br><span class=\"line\"><span class=\"javascript\">        &#123; <span class=\"attr\">value</span>: <span class=\"number\">1</span>, <span class=\"attr\">text</span>: <span class=\"string\">'status1'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">        &#123; <span class=\"attr\">value</span>: <span class=\"number\">2</span>, <span class=\"attr\">text</span>: <span class=\"string\">'status2'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      ]</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> fetchData () &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">    editRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">`update data =&gt; <span class=\"subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">style</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  color: red;</span></span><br><span class=\"line\"><span class=\"undefined\">  margin-bottom: 20px;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// AdminListPage.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> ListPageAbstract <span class=\"keyword\">from</span> <span class=\"string\">'./ListPageAbstract'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// 模拟ajax请求</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// 仅做了名字的模糊查询，其他参数忽略</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span> (<span class=\"params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Peter'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'313141414'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Marry'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'123931873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status2'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Sue'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'342391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Join'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'143391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">    ]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      list = list.filter(<span class=\"function\"><span class=\"params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      title: <span class=\"string\">'管理员列表'</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      ListPageAbstract.methods.fetchOptions.call(<span class=\"keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">'to do other thing'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> list = <span class=\"keyword\">await</span> search(<span class=\"keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>刷新页面就能呈现上述图一展示的样子和功能了。那么洋洋洒洒这么多代码做了些什么呢？</p>\n<ul>\n<li>Title.vue 用于显示页面的标题（之后我们用它测试下继承于ListPageAbstract.vue的组件如何重写css的问题）</li>\n<li>ButtonClick.vue 展示操作按钮和执行操作事件</li>\n<li>ListPageAbstract.vue 抽象的列表组件，这里是作为例子，具体方法定义的粗细程度根据具体情况调节</li>\n<li>AdminListPage.vue 管理员列表的具体组件</li>\n</ul>\n<p>AdminListPage通过<a href=\"https://cn.vuejs.org/v2/api/#extends\" target=\"_blank\" rel=\"noopener\">extends</a>继承了ListPageAbstract的模板、样式和其JS代码，通过部分的重写或完善，很容易的实现了一个页面，看上去很美好。那么新的问题来了，我们也发现ListPageAbstract定义筛选的内容是有限的，目前仅仅有name、phone、date和status，如果想扩展该怎么办呢？用过Vue的朋友或许此刻会想到<a href=\"https://cn.vuejs.org/v2/api/#slot\" target=\"_blank\" rel=\"noopener\">Slot</a>，接下来我们注释掉ListPageAbstract.vue里关于<strong>filter-slot</strong>的注释，并为AdminListPage.vue添加相关slot代码。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue add template </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">    other input filter</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br></pre></td></tr></table></figure>\n<p>刷新页面，页面仅仅留下了“other input filter”一串字符串，并没有实现我们的需求；也有人提出其它修改意见</p>\n<p><img src=\"/images/vue-component-extends/4.jpg\" alt=\"图四 除了“other input filter”其它都没了\"></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">      other input filter</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">Page</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">export default &#123;</span><br><span class=\"line\">  extends: ListPageAbstract,</span><br><span class=\"line\">  components: &#123;</span><br><span class=\"line\">    Page: ListPageAbstract,</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>虽然页面UI层是预期显示了，但是如果对ListPageAbstract的mounted方法打断点会发现，它被执行了2次，因为被实例化了2次，并且页面上的元素事件使用的是ListPageAbstract里的，而不是我们在Admin里面重写的，显然方法并不可行。关于Vue模板级别的继承扩展问题在github上有很多的吐槽，但并没有列为未来的新feature <a href=\"https://github.com/vuejs/vue/issues/6811\" target=\"_blank\" rel=\"noopener\">#6811</a></p>\n<p>既然我们讨论这个问题，自然也是可以解决的，在这我们不以filter查询条件的多少为例子，我们以更为简单的按钮为例，在列表里每一行的最后有一个“修改”按钮，而然我们在UserListPage里面，我们希望它变成一个“删除”按钮，并弹出确实删除的提示。新增ButtonPop.vue和UserListPage.vue</p>\n<p><em>又是很多代码，没兴趣可跳过</em></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonPop.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">size</span>=<span class=\"string\">\"small\"</span> <span class=\"attr\">plain</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      @<span class=\"attr\">click.stop</span>=<span class=\"string\">\"dialogVisible = true\"</span>&gt;</span>&#123;&#123; label &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-dialog</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">title</span>=<span class=\"string\">\"提示\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">:visible.sync</span>=<span class=\"string\">\"dialogVisible\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">width</span>=<span class=\"string\">\"30%\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span>确认删除数据吗？<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"footer\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"dialog-footer\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-button</span> @<span class=\"attr\">click</span>=<span class=\"string\">\"dialogVisible = false\"</span>&gt;</span>取 消<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span> @<span class=\"attr\">click</span>=<span class=\"string\">\"deleteInfo\"</span>&gt;</span>确 定<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">el-dialog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  props: [<span class=\"string\">'click'</span>, <span class=\"string\">'label'</span>, <span class=\"string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      dialogVisible: <span class=\"literal\">false</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  mounted () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'ButtonPop mounted'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> deleteInfo () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">await</span> <span class=\"keyword\">this</span>.click()</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.dialogVisible = <span class=\"literal\">false</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// UserListPage.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> ListPageAbstract <span class=\"keyword\">from</span> <span class=\"string\">'./ListPageAbstract.vue'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> Button <span class=\"keyword\">from</span> <span class=\"string\">'./ButtonPop.vue'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// 模拟ajax请求</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// 仅做了名字的模糊查询，其他参数忽略</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span> (<span class=\"params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Peter'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'313141414'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Marry'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'123931873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status2'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Sue'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'342391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Join'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'143391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">    ]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      list = list.filter(<span class=\"function\"><span class=\"params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"undefined\">  components: &#123; Button &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  data: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123; <span class=\"keyword\">return</span> &#123;&#125; &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  mounted: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.title = <span class=\"string\">'用户列表'</span></span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"comment\">// 用户名、创建时间、手机号、状态</span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> config = ListPageAbstract.methods.createConfig.call(<span class=\"keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      config.filter.conditions.splice(<span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"string\">'phone'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> table = config.table</span></span><br><span class=\"line\"><span class=\"javascript\">      table.column.push(&#123; <span class=\"attr\">key</span>: <span class=\"string\">'date'</span>, <span class=\"attr\">label</span>: <span class=\"string\">'时间'</span> &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">      table.action = &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        headerLabel: <span class=\"string\">'操作'</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">        label: <span class=\"string\">'删除'</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">        click: <span class=\"keyword\">this</span>.deleteRow</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> list = <span class=\"keyword\">await</span> search(<span class=\"keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">    deleteRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">`delete date: <span class=\"subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">        setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">this</span>.list.splice(<span class=\"keyword\">this</span>.list.indexOf(item), <span class=\"number\">1</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">          resolve()</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">style</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  margin-bottom: 50px;</span></span><br><span class=\"line\"><span class=\"undefined\">  color: blue;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>然后在修改下App.vue里面的Page引用，从AdminListPage改为UserListPage</p>\n<p>刷新页面，就和图二的样子一样了。整个代码并不复杂，核心就是</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">components: &#123; Button &#125;</span><br></pre></td></tr></table></figure>\n<p>它将父类的Button（ButtonClick）替换成了User页面需要的ButtonPop，实现了扩展。其实Filter查询条件也可以，只要我们做好组件的抽取等就行。</p>\n<p><strong>阅读Vue的源码时候，在Vue组件实例化的过程中，会有很多对options的深层次merge，使得我们可以通过上诉方法实现对父组件的扩展。</strong></p>\n<p>另外，细心的朋友观察代码或页面也发现“用户列表”4个字的颜色从红色变成了蓝色，与下面列表的间距也增大了不少，在User页面的style标签里就能很容易修改父组件的css样式。</p>\n<p>在Vue中，mixin、slot都是非常好用的工具，或许我们有时候也能改变思路，通过组件的替换构建出一个更为容易扩展的框架。</p>"},{"title":"Lighthouse性能分析","date":"2020-07-07T13:56:46.000Z","_content":"\n## 背景\n\n随着公司业务的不断扩展 ，系统也变得越来越臃肿，需要被不断的拆分，引进诸如微前端这样的框架，开发人员也不断的扩充，甚至有不同办公地点的同事协作开发。除了基本的开发规范外，也需要有一套完善的监控来测试和记录每次代码提交是否比之前版本存在性能不足等问题，在CI阶段发现问题，提早解决避免上线后带来性能损失而流失用户。团队成员也能在工作中不断的成长、驱动、交付出优质的应用。\n\n### 前端经常要关注的几个指标：\n\n**First Contentful Paint：**浏览器首次绘制文本、图片（包含背景图）、非白色的canvas或SVG的时间节点。*反映了网络的可用性和页面资源是否庞大导致传输时间过长。*\n\n**First Meaningful Paint：**页面的“主要内容”开始出现在屏幕上的时间点，测量用户加载体验的主要指标。*反映了是否太多非重要资源加载或执行的优先级高于主要的呈现资源。*\n\n**First CPU Idle：**页面主线程首次可以触发input操作，通常叫做最小可交互时间。\n\n**Time to Interactive：**页面完全达到可交互状态的时间点。\n\n<br/>\n\n## Lighthouse 介绍\n\n> 是一个开源的自动化工具，用于改进网络应用的质量。 您可以将其作为一个 Chrome 扩展程序运行，或从命令行运行。 您为 Lighthouse 提供一个您要审查的网址，它将针对此页面运行一连串的测试，然后生成一个有关页面性能的报告。\n\n![Lighthouse 报告](/images/lighthouse/report.png)\n\n## 原理分析\n\n架构图\n\nlghi 启动\n\n创建express服务\n\nLighthouse CI\n\n```yaml\nname: CI\non: [push]\njobs:\n  lighthouseci:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n      - uses: actions/setup-node@v1\n      - run: npm install && npm install -g @lhci/cli@0.4.x\n      - run: npm run build\n      - run: lhci autorun --upload.target=temporary-public-storage\n```\n\n","source":"_posts/lighthouse.md","raw":"---\ntitle: Lighthouse性能分析\ndate: 2020-07-07 21:56:46\ntags:\n---\n\n## 背景\n\n随着公司业务的不断扩展 ，系统也变得越来越臃肿，需要被不断的拆分，引进诸如微前端这样的框架，开发人员也不断的扩充，甚至有不同办公地点的同事协作开发。除了基本的开发规范外，也需要有一套完善的监控来测试和记录每次代码提交是否比之前版本存在性能不足等问题，在CI阶段发现问题，提早解决避免上线后带来性能损失而流失用户。团队成员也能在工作中不断的成长、驱动、交付出优质的应用。\n\n### 前端经常要关注的几个指标：\n\n**First Contentful Paint：**浏览器首次绘制文本、图片（包含背景图）、非白色的canvas或SVG的时间节点。*反映了网络的可用性和页面资源是否庞大导致传输时间过长。*\n\n**First Meaningful Paint：**页面的“主要内容”开始出现在屏幕上的时间点，测量用户加载体验的主要指标。*反映了是否太多非重要资源加载或执行的优先级高于主要的呈现资源。*\n\n**First CPU Idle：**页面主线程首次可以触发input操作，通常叫做最小可交互时间。\n\n**Time to Interactive：**页面完全达到可交互状态的时间点。\n\n<br/>\n\n## Lighthouse 介绍\n\n> 是一个开源的自动化工具，用于改进网络应用的质量。 您可以将其作为一个 Chrome 扩展程序运行，或从命令行运行。 您为 Lighthouse 提供一个您要审查的网址，它将针对此页面运行一连串的测试，然后生成一个有关页面性能的报告。\n\n![Lighthouse 报告](/images/lighthouse/report.png)\n\n## 原理分析\n\n架构图\n\nlghi 启动\n\n创建express服务\n\nLighthouse CI\n\n```yaml\nname: CI\non: [push]\njobs:\n  lighthouseci:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n      - uses: actions/setup-node@v1\n      - run: npm install && npm install -g @lhci/cli@0.4.x\n      - run: npm run build\n      - run: lhci autorun --upload.target=temporary-public-storage\n```\n\n","slug":"lighthouse","published":1,"updated":"2020-07-08T16:48:06.442Z","_id":"ckcc5y7bu0022d12iu04q7e5g","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>随着公司业务的不断扩展 ，系统也变得越来越臃肿，需要被不断的拆分，引进诸如微前端这样的框架，开发人员也不断的扩充，甚至有不同办公地点的同事协作开发。除了基本的开发规范外，也需要有一套完善的监控来测试和记录每次代码提交是否比之前版本存在性能不足等问题，在CI阶段发现问题，提早解决避免上线后带来性能损失而流失用户。团队成员也能在工作中不断的成长、驱动、交付出优质的应用。</p>\n<h3 id=\"前端经常要关注的几个指标：\"><a href=\"#前端经常要关注的几个指标：\" class=\"headerlink\" title=\"前端经常要关注的几个指标：\"></a>前端经常要关注的几个指标：</h3><p><strong>First Contentful Paint：</strong>浏览器首次绘制文本、图片（包含背景图）、非白色的canvas或SVG的时间节点。<em>反映了网络的可用性和页面资源是否庞大导致传输时间过长。</em></p>\n<p><strong>First Meaningful Paint：</strong>页面的“主要内容”开始出现在屏幕上的时间点，测量用户加载体验的主要指标。<em>反映了是否太多非重要资源加载或执行的优先级高于主要的呈现资源。</em></p>\n<p><strong>First CPU Idle：</strong>页面主线程首次可以触发input操作，通常叫做最小可交互时间。</p>\n<p><strong>Time to Interactive：</strong>页面完全达到可交互状态的时间点。</p>\n<p><br></p>\n<h2 id=\"Lighthouse-介绍\"><a href=\"#Lighthouse-介绍\" class=\"headerlink\" title=\"Lighthouse 介绍\"></a>Lighthouse 介绍</h2><blockquote>\n<p>是一个开源的自动化工具，用于改进网络应用的质量。 您可以将其作为一个 Chrome 扩展程序运行，或从命令行运行。 您为 Lighthouse 提供一个您要审查的网址，它将针对此页面运行一连串的测试，然后生成一个有关页面性能的报告。</p>\n</blockquote>\n<p><img src=\"/images/lighthouse/report.png\" alt=\"Lighthouse 报告\"></p>\n<h2 id=\"原理分析\"><a href=\"#原理分析\" class=\"headerlink\" title=\"原理分析\"></a>原理分析</h2><p>架构图</p>\n<p>lghi 启动</p>\n<p>创建express服务</p>\n<p>Lighthouse CI</p>\n<figure class=\"highlight yaml hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">CI</span></span><br><span class=\"line\"><span class=\"hljs-attr\">on:</span> <span class=\"hljs-string\">[push]</span></span><br><span class=\"line\"><span class=\"hljs-attr\">jobs:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  lighthouseci:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    steps:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - uses:</span> <span class=\"hljs-string\">actions/checkout@v2</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - uses:</span> <span class=\"hljs-string\">actions/setup-node@v1</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - run:</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-string\">&amp;&amp;</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-bullet\">-g</span> <span class=\"hljs-string\">@lhci/cli@0.4.x</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - run:</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">build</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - run:</span> <span class=\"hljs-string\">lhci</span> <span class=\"hljs-string\">autorun</span> <span class=\"hljs-bullet\">--upload.target=temporary-public-storage</span></span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"_categories":[],"_tags":[],"excerpt":"","more":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>随着公司业务的不断扩展 ，系统也变得越来越臃肿，需要被不断的拆分，引进诸如微前端这样的框架，开发人员也不断的扩充，甚至有不同办公地点的同事协作开发。除了基本的开发规范外，也需要有一套完善的监控来测试和记录每次代码提交是否比之前版本存在性能不足等问题，在CI阶段发现问题，提早解决避免上线后带来性能损失而流失用户。团队成员也能在工作中不断的成长、驱动、交付出优质的应用。</p>\n<h3 id=\"前端经常要关注的几个指标：\"><a href=\"#前端经常要关注的几个指标：\" class=\"headerlink\" title=\"前端经常要关注的几个指标：\"></a>前端经常要关注的几个指标：</h3><p><strong>First Contentful Paint：</strong>浏览器首次绘制文本、图片（包含背景图）、非白色的canvas或SVG的时间节点。<em>反映了网络的可用性和页面资源是否庞大导致传输时间过长。</em></p>\n<p><strong>First Meaningful Paint：</strong>页面的“主要内容”开始出现在屏幕上的时间点，测量用户加载体验的主要指标。<em>反映了是否太多非重要资源加载或执行的优先级高于主要的呈现资源。</em></p>\n<p><strong>First CPU Idle：</strong>页面主线程首次可以触发input操作，通常叫做最小可交互时间。</p>\n<p><strong>Time to Interactive：</strong>页面完全达到可交互状态的时间点。</p>\n<p><br></p>\n<h2 id=\"Lighthouse-介绍\"><a href=\"#Lighthouse-介绍\" class=\"headerlink\" title=\"Lighthouse 介绍\"></a>Lighthouse 介绍</h2><blockquote>\n<p>是一个开源的自动化工具，用于改进网络应用的质量。 您可以将其作为一个 Chrome 扩展程序运行，或从命令行运行。 您为 Lighthouse 提供一个您要审查的网址，它将针对此页面运行一连串的测试，然后生成一个有关页面性能的报告。</p>\n</blockquote>\n<p><img src=\"/images/lighthouse/report.png\" alt=\"Lighthouse 报告\"></p>\n<h2 id=\"原理分析\"><a href=\"#原理分析\" class=\"headerlink\" title=\"原理分析\"></a>原理分析</h2><p>架构图</p>\n<p>lghi 启动</p>\n<p>创建express服务</p>\n<p>Lighthouse CI</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">CI</span></span><br><span class=\"line\"><span class=\"attr\">on:</span> <span class=\"string\">[push]</span></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\"><span class=\"attr\">  lighthouseci:</span></span><br><span class=\"line\"><span class=\"attr\">    runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\"><span class=\"attr\">    steps:</span></span><br><span class=\"line\"><span class=\"attr\">      - uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\"><span class=\"attr\">      - uses:</span> <span class=\"string\">actions/setup-node@v1</span></span><br><span class=\"line\"><span class=\"attr\">      - run:</span> <span class=\"string\">npm</span> <span class=\"string\">install</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">npm</span> <span class=\"string\">install</span> <span class=\"bullet\">-g</span> <span class=\"string\">@lhci/cli@0.4.x</span></span><br><span class=\"line\"><span class=\"attr\">      - run:</span> <span class=\"string\">npm</span> <span class=\"string\">run</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">      - run:</span> <span class=\"string\">lhci</span> <span class=\"string\">autorun</span> <span class=\"bullet\">--upload.target=temporary-public-storage</span></span><br></pre></td></tr></table></figure>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"ckcc0bs570000d12iwhc9qpyq","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs5x000bd12itk5q9163"},{"post_id":"ckcc0bs5q0006d12ims95wvqz","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs62000fd12iviyzr0a4"},{"post_id":"ckcc0bs5t0009d12idrzu6e7l","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs65000id12ip94yfp65"},{"post_id":"ckcc0bs5d0001d12i4s9mkjdx","category_id":"ckcc0bs5s0007d12i55rhv16a","_id":"ckcc0bs69000md12i8arrq5hv"},{"post_id":"ckcc0bs5w000ad12irl0yaj38","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs6c000qd12i72hm0fy0"},{"post_id":"ckcc0bs60000ed12iio0rfwo6","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs6g000ud12ibxcw1lz7"},{"post_id":"ckcc0bs5k0004d12ir6oazsoe","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs6i000yd12i469b1oev"},{"post_id":"ckcc0bs67000ld12i883r2soz","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs6m0012d12ifbjatlzw"},{"post_id":"ckcc0bs6d000td12ipm80x4aw","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs6o0015d12i41zjfyas"},{"post_id":"ckcc0bs63000hd12ihv1bmsa1","category_id":"ckcc0bs6a000od12ihlgzwobt","_id":"ckcc0bs6q0019d12ie6vz5u52"},{"post_id":"ckcc0bs6g000wd12is9oenoib","category_id":"ckcc0bs5s0007d12i55rhv16a","_id":"ckcc0bs6t001dd12iny29myrm"},{"post_id":"ckcc0bs6k0011d12i9h6fzx8d","category_id":"ckcc0bs5s0007d12i55rhv16a","_id":"ckcc0bs6w001gd12iun4fkqwk"},{"post_id":"ckcc0bs6a000pd12iw204eeos","category_id":"ckcc0bs6a000od12ihlgzwobt","_id":"ckcc0bs6z001jd12iibqowzt2"},{"post_id":"ckcc0bs6p0018d12ibydk0jqe","category_id":"ckcc0bs5s0007d12i55rhv16a","_id":"ckcc0bs71001md12iqsgal2kb"},{"post_id":"ckcc0bs6s001cd12ifj6rubht","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs72001od12i0bjkc5l9"},{"post_id":"ckcc0bs6u001fd12ix22cpydf","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs73001qd12ic36ewd4d"},{"post_id":"ckcc0bs6n0014d12ija0axog3","category_id":"ckcc0bs6r001bd12i099h5srq","_id":"ckcc0bs73001sd12i9s98j76x"},{"post_id":"ckcc0bs6y001id12ibykhggc2","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs73001ud12iz2sw33ot"},{"post_id":"ckcc0bs70001ld12itkordewq","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs73001wd12i820kv0r6"}],"PostTag":[{"post_id":"ckcc0bs570000d12iwhc9qpyq","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs62000gd12it9tg7env"},{"post_id":"ckcc0bs570000d12iwhc9qpyq","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs66000jd12ih36ktm1j"},{"post_id":"ckcc0bs5w000ad12irl0yaj38","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs69000nd12ido0ehpr8"},{"post_id":"ckcc0bs5w000ad12irl0yaj38","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs6c000rd12ifeiw5n4w"},{"post_id":"ckcc0bs60000ed12iio0rfwo6","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs6g000vd12ib5l477nl"},{"post_id":"ckcc0bs60000ed12iio0rfwo6","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs6i000zd12iswa12gfo"},{"post_id":"ckcc0bs67000ld12i883r2soz","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs6m0013d12i8lony6ps"},{"post_id":"ckcc0bs67000ld12i883r2soz","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs6o0016d12it2yefa58"},{"post_id":"ckcc0bs5k0004d12ir6oazsoe","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs6q001ad12izqqlc33b"},{"post_id":"ckcc0bs5k0004d12ir6oazsoe","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs6t001ed12ig6j3aokn"},{"post_id":"ckcc0bs6d000td12ipm80x4aw","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs6x001hd12i732cesqh"},{"post_id":"ckcc0bs6d000td12ipm80x4aw","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs6z001kd12ia3vy8p2p"},{"post_id":"ckcc0bs63000hd12ihv1bmsa1","tag_id":"ckcc0bs6c000sd12i46mcfevt","_id":"ckcc0bs71001nd12iqgvyhjuu"},{"post_id":"ckcc0bs6a000pd12iw204eeos","tag_id":"ckcc0bs6c000sd12i46mcfevt","_id":"ckcc0bs72001pd12ig4276628"},{"post_id":"ckcc0bs6a000pd12iw204eeos","tag_id":"ckcc0bs6o0017d12iea00bfqs","_id":"ckcc0bs73001rd12igmjtht8t"},{"post_id":"ckcc0bs6s001cd12ifj6rubht","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs73001td12io5exnjnk"},{"post_id":"ckcc0bs6s001cd12ifj6rubht","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs73001vd12i09rmpbji"},{"post_id":"ckcc0bs6u001fd12ix22cpydf","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs74001xd12i0jzimpha"},{"post_id":"ckcc0bs6u001fd12ix22cpydf","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs74001yd12ia4rl2lgo"},{"post_id":"ckcc0bs6y001id12ibykhggc2","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs74001zd12ip97rxn90"},{"post_id":"ckcc0bs6y001id12ibykhggc2","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs740020d12i2bbtg91g"}],"Tag":[{"name":"Node.js","_id":"ckcc0bs5k0003d12ikwo92vqf"},{"name":"JavaScript","_id":"ckcc0bs5s0008d12iu04lzb7n"},{"name":"架构","_id":"ckcc0bs6c000sd12i46mcfevt"},{"name":"运维","_id":"ckcc0bs6o0017d12iea00bfqs"}]}}