{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/minos/source/CNAME","path":"CNAME","modified":0,"renderable":1},{"_id":"themes/minos/source/baidu_verify_yIFJ6q4kkQ.html","path":"baidu_verify_yIFJ6q4kkQ.html","modified":0,"renderable":1},{"_id":"themes/minos/source/baidu_verify_CXKjj3fklD.html","path":"baidu_verify_CXKjj3fklD.html","modified":0,"renderable":1},{"_id":"source/images/egg-cluster/3.jpg","path":"images/egg-cluster/3.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-cluster/1.jpg","path":"images/egg-cluster/1.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/3.jpg","path":"images/js-capture-error/3.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/8.jpg","path":"images/js-capture-error/8.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/6.jpg","path":"images/js-capture-error/6.jpg","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/monitor.pptx","path":"images/node-perf-heapdump-flame-graph/monitor.pptx","modified":0,"renderable":0},{"_id":"source/images/summary-2019/2.jpg","path":"images/summary-2019/2.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-libuv-timer-event-loop/image-20200301145547994.png","path":"images/v8-libuv-timer-event-loop/image-20200301145547994.png","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/1.jpg","path":"images/vue-component-extends/1.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/2.jpg","path":"images/vue-component-extends/2.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/4.jpg","path":"images/vue-component-extends/4.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/3.jpg","path":"images/vue-component-extends/3.jpg","modified":0,"renderable":0},{"_id":"themes/minos/source/css/insight.scss","path":"css/insight.scss","modified":0,"renderable":1},{"_id":"themes/minos/source/images/check.svg","path":"images/check.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/css/style.scss","path":"css/style.scss","modified":0,"renderable":1},{"_id":"themes/minos/source/images/question.svg","path":"images/question.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/logo.png","path":"images/logo.png","modified":0,"renderable":1},{"_id":"themes/minos/source/images/exclamation.svg","path":"images/exclamation.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/info.svg","path":"images/info.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/quote-left.svg","path":"images/quote-left.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/js/script.js","path":"js/script.js","modified":0,"renderable":1},{"_id":"themes/minos/source/js/insight.js","path":"js/insight.js","modified":0,"renderable":1},{"_id":"source/images/egg-cluster/4.jpg","path":"images/egg-cluster/4.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-cluster/2.jpg","path":"images/egg-cluster/2.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/9.jpg","path":"images/js-capture-error/9.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/7.jpg","path":"images/js-capture-error/7.jpg","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.svg","path":"images/node-perf-heapdump-flame-graph/node-flamegraph.svg","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version/arch.png","path":"images/node-gateway-ssr-multi-version/arch.png","modified":0,"renderable":0},{"_id":"source/images/v8-libuv-timer-event-loop/loop_iteration.png","path":"images/v8-libuv-timer-event-loop/loop_iteration.png","modified":0,"renderable":0},{"_id":"source/images/bec/2.jpeg","path":"images/bec/2.jpeg","modified":0,"renderable":0},{"_id":"source/images/egg-boot/egg-boot.jpg","path":"images/egg-boot/egg-boot.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/10.jpg","path":"images/js-capture-error/10.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/4.jpg","path":"images/js-capture-error/4.jpg","modified":0,"renderable":0},{"_id":"source/images/js-css-image-loading/1.png","path":"images/js-css-image-loading/1.png","modified":0,"renderable":0},{"_id":"source/images/nodejs-istio-k8s-docker/book-app.png","path":"images/nodejs-istio-k8s-docker/book-app.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-29.jpg","modified":0,"renderable":0},{"_id":"source/images/summary-2019/1.png","path":"images/summary-2019/1.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-26.jpg","modified":0,"renderable":0},{"_id":"source/images/bec/1.jpeg","path":"images/bec/1.jpeg","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_01.png","path":"images/node-perf-heapdump-flame-graph/connection_01.png","modified":0,"renderable":0},{"_id":"source/images/monitor-hub/image-20200403185942130.png","path":"images/monitor-hub/image-20200403185942130.png","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/heapdump_01.png","path":"images/node-perf-heapdump-flame-graph/heapdump_01.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-04.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-19.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-18.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-20.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-27.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-31.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-30.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-28.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/not-change-types-1.png","path":"images/v8-parser-compiler/not-change-types-1.png","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/not-change-types-2.png","path":"images/v8-parser-compiler/not-change-types-2.png","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/not-change-types-3.png","path":"images/v8-parser-compiler/not-change-types-3.png","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_02.png","path":"images/node-perf-heapdump-flame-graph/connection_02.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-06.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-07.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-09.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-17.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parse-time.png","path":"images/v8-parser-compiler/parse-time.png","modified":0,"renderable":0},{"_id":"source/images/monitor-hub/image-20200403210837664.png","path":"images/monitor-hub/image-20200403210837664.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-05.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-08.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-10.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-11.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-13.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-25.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-24.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-12.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parse-time-2.png","path":"images/v8-parser-compiler/parse-time-2.png","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/1.png","path":"images/js-capture-error/1.png","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/5.jpg","path":"images/js-capture-error/5.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parser-phase.png","path":"images/v8-parser-compiler/parser-phase.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-21.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-02.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-23.png","path":"images/travel-zhoushan/travel-zhoushan-23.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-32.png","path":"images/travel-zhoushan/travel-zhoushan-32.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-22.jpg","modified":0,"renderable":0},{"_id":"source/images/nodejs-istio-k8s-docker/arch.jpg","path":"images/nodejs-istio-k8s-docker/arch.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parse-time-1.png","path":"images/v8-parser-compiler/parse-time-1.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-16.png","path":"images/travel-zhoushan/travel-zhoushan-16.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-03.png","path":"images/travel-zhoushan/travel-zhoushan-03.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-12.jpg","path":"images/travel-zhoushan/travel-zhoushan-12.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-01.png","path":"images/travel-zhoushan/travel-zhoushan-01.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-13.jpg","path":"images/travel-zhoushan/travel-zhoushan-13.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/2.jpg","path":"images/js-capture-error/2.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/v8-pare-compile-cost.png","path":"images/v8-parser-compiler/v8-pare-compile-cost.png","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.png","path":"images/node-perf-heapdump-flame-graph/node-flamegraph.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-29.jpg","path":"images/travel-zhoushan/travel-zhoushan-29.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/27.jpg","path":"images/traveling-to-the-philippines/27.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/26.jpg","path":"images/traveling-to-the-philippines/26.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-15.mp4","path":"images/travel-zhoushan/travel-zhoushan-15.mp4","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/2.jpg","path":"images/traveling-to-the-philippines/2.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/13.jpg","path":"images/traveling-to-the-philippines/13.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/25.jpg","path":"images/traveling-to-the-philippines/25.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-04.jpg","path":"images/travel-zhoushan/travel-zhoushan-04.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-26.jpg","path":"images/travel-zhoushan/travel-zhoushan-26.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/6.jpg","path":"images/traveling-to-the-philippines/6.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/11.jpg","path":"images/traveling-to-the-philippines/11.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/9.jpg","path":"images/traveling-to-the-philippines/9.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/12.jpg","path":"images/traveling-to-the-philippines/12.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/34.jpg","path":"images/traveling-to-the-philippines/34.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-24.jpg","path":"images/travel-zhoushan/travel-zhoushan-24.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-28.jpg","path":"images/travel-zhoushan/travel-zhoushan-28.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/17.jpg","path":"images/traveling-to-the-philippines/17.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/3.jpg","path":"images/traveling-to-the-philippines/3.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/4.jpg","path":"images/traveling-to-the-philippines/4.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/23.jpg","path":"images/traveling-to-the-philippines/23.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-17.jpg","path":"images/travel-zhoushan/travel-zhoushan-17.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/20.jpg","path":"images/traveling-to-the-philippines/20.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-05.jpg","path":"images/travel-zhoushan/travel-zhoushan-05.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/31.jpg","path":"images/traveling-to-the-philippines/31.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-09.jpg","path":"images/travel-zhoushan/travel-zhoushan-09.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-30.jpg","path":"images/travel-zhoushan/travel-zhoushan-30.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/14.jpg","path":"images/traveling-to-the-philippines/14.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-27.jpg","path":"images/travel-zhoushan/travel-zhoushan-27.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/30.jpg","path":"images/traveling-to-the-philippines/30.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-19.jpg","path":"images/travel-zhoushan/travel-zhoushan-19.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/1.jpg","path":"images/traveling-to-the-philippines/1.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-31.jpg","path":"images/travel-zhoushan/travel-zhoushan-31.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/32.jpg","path":"images/traveling-to-the-philippines/32.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-20.jpg","path":"images/travel-zhoushan/travel-zhoushan-20.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-08.jpg","path":"images/travel-zhoushan/travel-zhoushan-08.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-18.jpg","path":"images/travel-zhoushan/travel-zhoushan-18.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-25.jpg","path":"images/travel-zhoushan/travel-zhoushan-25.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/10.jpg","path":"images/traveling-to-the-philippines/10.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/29.jpg","path":"images/traveling-to-the-philippines/29.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/8.jpg","path":"images/traveling-to-the-philippines/8.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/28.jpg","path":"images/traveling-to-the-philippines/28.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-10.jpg","path":"images/travel-zhoushan/travel-zhoushan-10.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-21.jpg","path":"images/travel-zhoushan/travel-zhoushan-21.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/24.jpg","path":"images/traveling-to-the-philippines/24.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/16.jpg","path":"images/traveling-to-the-philippines/16.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-06.jpg","path":"images/travel-zhoushan/travel-zhoushan-06.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-11.jpg","path":"images/travel-zhoushan/travel-zhoushan-11.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/7.jpg","path":"images/traveling-to-the-philippines/7.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-02.jpg","path":"images/travel-zhoushan/travel-zhoushan-02.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/15.jpg","path":"images/traveling-to-the-philippines/15.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/33.jpeg","path":"images/traveling-to-the-philippines/33.jpeg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-07.jpg","path":"images/travel-zhoushan/travel-zhoushan-07.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/22.jpg","path":"images/traveling-to-the-philippines/22.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-22.jpg","path":"images/travel-zhoushan/travel-zhoushan-22.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/21.jpg","path":"images/traveling-to-the-philippines/21.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/19.jpg","path":"images/traveling-to-the-philippines/19.jpg","modified":0,"renderable":0},{"_id":"source/images/lighthouse/report.png","path":"images/lighthouse/report.png","modified":0,"renderable":0},{"_id":"source/images/lighthouse/architecture.png","path":"images/lighthouse/architecture.png","modified":0,"renderable":0}],"Cache":[{"_id":"themes/minos/.gitignore","hash":"8b02e7219e2dd9b50d198819fd7d8f74ebc9db2a","modified":1594119839725},{"_id":"themes/minos/README.md","hash":"ba6b4e134d718704cfd030e106bf24d6ef8b496d","modified":1594119839726},{"_id":"themes/minos/LICENSE","hash":"ca01a2d52b59346e82f079c593df6cb26dd9a7a5","modified":1594119839725},{"_id":"themes/minos/_config.yml.example","hash":"28c6c5604380fb6cc5a99639fa445c40205764ba","modified":1594119839726},{"_id":"themes/minos/package.json","hash":"f9d450db80149dea6c372990cdf51dfde901e5cc","modified":1594119839745},{"_id":"source/_posts/egg-boot.md","hash":"f6096e8d4e2886307ba0d4c7667a5484ea010be7","modified":1594116685586},{"_id":"source/_posts/child_process-exec-fork-spawn.md","hash":"a384d8ce73e31c9248ab04667df9b3129391aa3b","modified":1594116685586},{"_id":"source/_posts/bec.md","hash":"87b9350ffd9ac0a4b83fb6001161c55be96ead5d","modified":1594116685585},{"_id":"source/_posts/egg-cluster.md","hash":"908503ecfe15cbc6e366bf032b4055a1ea1b37a6","modified":1594116685586},{"_id":"source/_posts/lighthouse-ci-1.md","hash":"a62700abc5fc954ac1c307a83aef0ce9bced3561","modified":1594130430607},{"_id":"source/_posts/express-gateway.md","hash":"5ce9bf574dbcc036c5ff9b9bc5051b8dd0127aeb","modified":1594116685587},{"_id":"source/_posts/js-capture-error.md","hash":"c204a4727649e9faa26dcf5647c2b28b2d44b4d4","modified":1594116685587},{"_id":"source/_posts/js-css-image-loading.md","hash":"4886ed93878da0dcf0daa86eb004b06509dd97b5","modified":1594116685587},{"_id":"source/_posts/monitor-hub.md","hash":"7ce2a737deb11834817a9b1899e91d48686c5aca","modified":1594116685587},{"_id":"source/_posts/node-gateway-ssr-multi-version.md","hash":"dff2e134ddb0c9c687c00361853f99e58af048da","modified":1594116685587},{"_id":"source/_posts/node-perf-heapdump-flame-graph.md","hash":"bf426a3a8b92d628c808d0a3d289eadcbb81eb49","modified":1594116685588},{"_id":"source/_posts/nodejs-istio-k8s-docker.md","hash":"c3ec267a1bd71b85ba3637860ae99eed780dcdbb","modified":1594116685589},{"_id":"source/_posts/node-js-net-cluster-fork.md","hash":"62ae91d7cd88e33d1bd6ef6baa3e933e5b9c0aa1","modified":1594116685588},{"_id":"source/_posts/summary-2019.md","hash":"0f60f3a3216df42f40f5cc5cc4eab97f37b5b536","modified":1594116685589},{"_id":"source/_posts/the-quality-of-a-company-first-look-at-HR-department.md","hash":"6ec330223a159cd72eb0c698228a2fc59586e0c8","modified":1594116685589},{"_id":"source/_posts/travel-zhoushan.md","hash":"16b4f3f9b64a3acc68c304b34a0550f4f171f3bc","modified":1594116685589},{"_id":"source/_posts/traveling-to-the-philippines.md","hash":"1f1c0d1bdc5ead8ae92793b136a77f5b9491f099","modified":1594116685590},{"_id":"source/_posts/v8-libuv-timer-event-loop.md","hash":"4061a6f647fb2105ecf586ea7f69fa227c6930c2","modified":1594116685590},{"_id":"source/_posts/v8-parser-compiler-javascript.md","hash":"c28522efcd24306d26459f8615d97eab9b1b55fd","modified":1594116685591},{"_id":"source/_posts/vue-component-extends.md","hash":"37a4738d36d3621ab86e407e036a621be79baeec","modified":1594116685591},{"_id":"themes/minos/languages/es.yml","hash":"5c35950221411e34e7a9821d0b0671da9a458d8c","modified":1594119839727},{"_id":"themes/minos/languages/en.yml","hash":"ef98c8674fed78f2350598ee8b15fcd53fbd2ae5","modified":1594119839727},{"_id":"themes/minos/languages/ko.yml","hash":"1acf3f959f1d2b4f7a77e7e82851821aa8635362","modified":1594119839728},{"_id":"themes/minos/scripts/01_check.js","hash":"b26b19011a6eb61e61419331a7f9c5fdf553d830","modified":1594119839745},{"_id":"themes/minos/scripts/10_i18n.js","hash":"346a09259e15913871e12c7418a639b8d65df570","modified":1594119839746},{"_id":"themes/minos/scripts/99_config.js","hash":"d41a5df0a442728fbc66514476fe043e416d7438","modified":1594119839746},{"_id":"themes/minos/languages/ru.yml","hash":"8e5a58176bf943432ba6e4f1981d9b98fdea36a4","modified":1594119839728},{"_id":"themes/minos/scripts/99_tags.js","hash":"91369a4d8376bc981a9bad9c5dde4b3e775e5cb5","modified":1594119839747},{"_id":"themes/minos/scripts/rfc5646.js","hash":"8ecf38d0ec7145720ea8e888da314131712770e8","modified":1594119839748},{"_id":"themes/minos/languages/zh-cn.yml","hash":"9c5a489b11a056d1ea7b9d4a0e127aef9e192ee4","modified":1594119839729},{"_id":"themes/minos/scripts/99_content.js","hash":"5d19de210e9172a9acb61667a26810899fce917d","modified":1594119839747},{"_id":"themes/minos/layout/archive.ejs","hash":"e3eefe819d61b4d0ee069bb705a9f5707a8bf3da","modified":1594119839729},{"_id":"themes/minos/layout/category.ejs","hash":"403c646878834964883ac41e63952f7b1595c0ba","modified":1594119839730},{"_id":"themes/minos/layout/layout.ejs","hash":"0d0dc44ac98ad02f877a7fdc47108379bda36518","modified":1594119839741},{"_id":"themes/minos/layout/post.ejs","hash":"68b84a717efc5ca59ee9eb6202ccf05c5a8abda5","modified":1594119839742},{"_id":"themes/minos/layout/categories.ejs","hash":"fff6f911d0f548ee749292bc1942f8fbbb1fbfe7","modified":1594119839730},{"_id":"themes/minos/layout/index.ejs","hash":"dff9e199d394f82c5416b814f9e644edbe4090f0","modified":1594119839741},{"_id":"themes/minos/layout/tag.ejs","hash":"5593c7cf9618ef5650c779ed9d75424f057aa210","modified":1594119839744},{"_id":"themes/minos/source/CNAME","hash":"a0004ff224f009d980f11ebe05076d886e4a62b0","modified":1594119839748},{"_id":"themes/minos/source/baidu_verify_yIFJ6q4kkQ.html","hash":"ea49a0fba4306b904b14c9257b691b51814ed4f7","modified":1594119839749},{"_id":"themes/minos/layout/tags.ejs","hash":"e4a9909119294f131a45f10b2cb1058af5fb9be1","modified":1594119839744},{"_id":"themes/minos/source/baidu_verify_CXKjj3fklD.html","hash":"7d4c19a87c3c2c0291ca044329a4eecb199a5cfe","modified":1594119839748},{"_id":"source/images/egg-cluster/3.jpg","hash":"2e999d8632a8a784f778c48b4c26238ce61dfad5","modified":1594116685598},{"_id":"source/images/egg-cluster/1.jpg","hash":"862150374047d825dc6cf409a86c4ca75e132c86","modified":1594116685596},{"_id":"source/images/js-capture-error/3.jpg","hash":"8ab14ad4b43d54cd690218c0a9205ae8d5f102de","modified":1594116685612},{"_id":"source/images/js-capture-error/8.jpg","hash":"d16542cad83c53000902969dca6604833675dd5b","modified":1594116685616},{"_id":"source/images/js-capture-error/6.jpg","hash":"4df941e78df71a066d31a4e4d9f7a2acf6663c8a","modified":1594116685615},{"_id":"source/images/node-perf-heapdump-flame-graph/monitor.pptx","hash":"5bc6ab601976c87a5a8a749d383732b7e5f1a4e3","modified":1594116685634},{"_id":"source/images/summary-2019/2.jpg","hash":"70d8c75bfc4dca70ce90c96b712ca0032ac1ee25","modified":1594116685649},{"_id":"source/images/v8-libuv-timer-event-loop/image-20200301145547994.png","hash":"ee45995af24bc027413f4e3d277ff17a7adebcbd","modified":1594116687218},{"_id":"source/images/vue-component-extends/1.jpg","hash":"f8ed085d61eac35e39a75469cec2fb53184c8f99","modified":1594116687256},{"_id":"source/images/vue-component-extends/2.jpg","hash":"849929e4e6cb963667a09efe4ffb6b1dc1c30052","modified":1594116687256},{"_id":"source/images/vue-component-extends/4.jpg","hash":"9b02fc2442e9c12e70a3f2099e080a8abbfce0f8","modified":1594116687257},{"_id":"source/images/vue-component-extends/3.jpg","hash":"34366ce9fa8f6d101918ee510b87d50a980f1898","modified":1594116687257},{"_id":"themes/minos/layout/comment/changyan.ejs","hash":"9ccc7ec354b968e60bdcfcd1dba451d38de61f12","modified":1594119839731},{"_id":"themes/minos/layout/comment/disqus.ejs","hash":"a2becdc02214a673c804af93488489807fa2c99c","modified":1594119839731},{"_id":"themes/minos/layout/comment/gitment.ejs","hash":"430416210933b7edcbfcc67ede4aa55539da2750","modified":1594119839732},{"_id":"themes/minos/layout/comment/isso.ejs","hash":"cc6a43bd24be764086f88ad7c5c97ff04df87e0b","modified":1594119839733},{"_id":"themes/minos/layout/comment/facebook.ejs","hash":"e73b6f93d98b27ba9068c1685874ecccfbac737b","modified":1594119839732},{"_id":"themes/minos/layout/comment/youyan.ejs","hash":"3d6cf9c523a7a5510ec2864bb29f861f9bb78af3","modified":1594119839735},{"_id":"themes/minos/layout/comment/valine.ejs","hash":"350f28986dd610ebdfdeb16dc618d1d034312af1","modified":1594119839734},{"_id":"themes/minos/layout/comment/livere.ejs","hash":"12ff9a345f6bba2f732f592e39508c2afde89b00","modified":1594119839733},{"_id":"themes/minos/layout/common/article.ejs","hash":"5b45c9ee074d0d92cf9f227971968fadafef5d2e","modified":1594119839737},{"_id":"themes/minos/layout/common/navbar.ejs","hash":"88e14ed41b4ed23bb4516c4db882a52b3cad5586","modified":1594119839739},{"_id":"themes/minos/layout/common/head.ejs","hash":"5242cd321d6c9c0245948c0ba2b55e777f5492a0","modified":1594119839738},{"_id":"themes/minos/layout/common/footer.ejs","hash":"367c5f2e69c66d4d6fbd8beeade0b60024ce9e6e","modified":1594119839737},{"_id":"themes/minos/layout/common/languages.ejs","hash":"89665c656a1ffebc9c97f03e7f9c12dd1d90702a","modified":1594119839738},{"_id":"themes/minos/layout/common/paginator.ejs","hash":"8f5060e4c8a86a3f4e58455c41c98e831e23e4a4","modified":1594119839740},{"_id":"themes/minos/layout/common/scripts.ejs","hash":"7a5a5271930423b95046836597e30e31fa708f66","modified":1594119839740},{"_id":"themes/minos/layout/plugins/gallery.ejs","hash":"7c2becafdf6b60e677cdd5756b9d55eba2af4944","modified":1594119839742},{"_id":"themes/minos/layout/plugins/google-analytics.ejs","hash":"2a9d944a60aff7df27def5215bdc071e605c3c42","modified":1594119839742},{"_id":"themes/minos/layout/plugins/mathjax.ejs","hash":"b460310078d3506dce8dccc67310e3b9b3c124a9","modified":1594119839742},{"_id":"themes/minos/layout/search/google-cse.ejs","hash":"a6bf5c30339735126efa7efa684f9eb14dd6136a","modified":1594119839743},{"_id":"themes/minos/layout/share/sharethis.ejs","hash":"4f2c40f790f3be0a4e79db04f02ea41ba2f4d4c0","modified":1594119839744},{"_id":"themes/minos/layout/common/adv.ejs","hash":"01516deef98a21f349812351476d44d2e4c245c4","modified":1594119839736},{"_id":"themes/minos/layout/search/insight.ejs","hash":"6fb7d27ef40145d8587b46b44a43516135b5a81a","modified":1594119839743},{"_id":"themes/minos/layout/share/addthis.ejs","hash":"f1c5f337333009d5f00dfbac4864a16ef8f9cb8d","modified":1594119839743},{"_id":"themes/minos/source/css/insight.scss","hash":"f785fc6574d2853c660be39b2e3149d4846b577f","modified":1594119839749},{"_id":"themes/minos/source/images/check.svg","hash":"029b8b3523b7daa4005983b4463cd93408308aab","modified":1594119839751},{"_id":"themes/minos/source/css/style.scss","hash":"48d8b2bc475a26b4354c1717cdd131952aef5718","modified":1594119839751},{"_id":"themes/minos/source/images/question.svg","hash":"7153fa2a0c21e32da6a1f96a333d8b66a178569d","modified":1594119839753},{"_id":"themes/minos/source/images/logo.png","hash":"4e012d9ba58cb8f87ee775262ef871c158ac5948","modified":1594119839752},{"_id":"themes/minos/source/images/exclamation.svg","hash":"b2db56f2cc13fce73dbea46c7b446d9bcb3bf0fd","modified":1594119839751},{"_id":"themes/minos/source/images/info.svg","hash":"c8aa387e935ba9a7fa72c5dd000b7d46f2e030c4","modified":1594119839752},{"_id":"themes/minos/source/images/quote-left.svg","hash":"d2561fa8d13e63ff196b71232a5968415ec6e372","modified":1594119839753},{"_id":"themes/minos/source/js/script.js","hash":"6b670ec4f90fb43b21a0bbd750a217af5d8aab6b","modified":1594119839754},{"_id":"themes/minos/source/js/insight.js","hash":"eb23c31141784eef7300f1d1c548950e77883f56","modified":1594119839753},{"_id":"source/images/egg-cluster/4.jpg","hash":"31f6945a8694b2cbbb7bc8906ca166b96cc0803e","modified":1594116685599},{"_id":"source/images/egg-cluster/2.jpg","hash":"3f3006fab2f9e349a3cd43708c8f5fce54c1083e","modified":1594116685597},{"_id":"source/images/js-capture-error/9.jpg","hash":"0d70c8c909842dc05faf690ee1496d98093e8e87","modified":1594116685616},{"_id":"source/images/js-capture-error/7.jpg","hash":"2048e9e10834e569f9ac9d13befbbeab25e0db98","modified":1594116685615},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.svg","hash":"103ef757e41c3246d893f06e482e8682ab5ef1df","modified":1594116685643},{"_id":"source/images/node-gateway-ssr-multi-version/arch.png","hash":"2e3b70aae25d01ec24cdb3dea9461cb2f8ccf6d5","modified":1594116685626},{"_id":"source/images/v8-libuv-timer-event-loop/loop_iteration.png","hash":"b1d06a5e6d9965267cbddc95219a325e85b3ad2b","modified":1594116687218},{"_id":"source/images/bec/2.jpeg","hash":"42aa67b3eaa413a0d98e32bc1be92e9b81044e67","modified":1594116685594},{"_id":"source/images/egg-boot/egg-boot.jpg","hash":"1929f0597221ba9d865bf88c8ebe18ab3b6a83a6","modified":1594116685595},{"_id":"source/images/js-capture-error/10.jpg","hash":"990afee0f1c758900bbe01a93cb2713ce18f825b","modified":1594116685603},{"_id":"source/images/js-capture-error/4.jpg","hash":"c2a26768421ef97bbfd6cf6e13484c93f622202b","modified":1594116685613},{"_id":"source/images/js-css-image-loading/1.png","hash":"199fffb885dde4ce13b60b4f1394be4206fc562e","modified":1594116685618},{"_id":"source/images/nodejs-istio-k8s-docker/book-app.png","hash":"648f6fc10d7e088f30efb0ad0bb08e143737a3c1","modified":1594116685648},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg","hash":"029f1682134caee2658d729e22cbcc258cd39654","modified":1594116685670},{"_id":"source/images/summary-2019/1.png","hash":"655187e02155f10971fe9f163a66074550f29155","modified":1594116685649},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg","hash":"5082c1e85542f1e6e84f40ed90eeaa6a8d1dbe7a","modified":1594116685669},{"_id":"source/images/bec/1.jpeg","hash":"3d518ead7f234d224ad987089dc9abbfc44914a7","modified":1594116685592},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_01.png","hash":"aa9e23b48cfc40528b142c19e019904fd84d2023","modified":1594116685629},{"_id":"source/images/monitor-hub/image-20200403185942130.png","hash":"1cd2b816b28379319621c6d5b64f226ff6854ed1","modified":1594116685620},{"_id":"source/images/node-perf-heapdump-flame-graph/heapdump_01.png","hash":"c30667247e0244f0d0a6cf529da72a6449afe651","modified":1594116685633},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg","hash":"2982f2cd7c06f1b14ca41db91c7092e9cc5206b4","modified":1594116685651},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg","hash":"c830ac739f78b03a03377239257cebb87febd6d4","modified":1594116685660},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg","hash":"2d29c5722ddaaa7cafa4bdee76c489a78fec439c","modified":1594116685660},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg","hash":"0e1b7775a6f0516481a363969e9ab4d37def3f54","modified":1594116685661},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg","hash":"e7f56cab7af9c047abc4272ad8c3409ead3ad663","modified":1594116685669},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg","hash":"a3b2ef5a334b629fa4e18263b5b132abd5d16541","modified":1594116685671},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg","hash":"d0e9ea419aaf7ea366bd1a4d9eb9689935f2305e","modified":1594116685671},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg","hash":"750783ca8fea2c0f2bf16b77d68ffb9fb8a0fa08","modified":1594116685670},{"_id":"source/images/v8-parser-compiler/not-change-types-1.png","hash":"fe446fdd1f610c3f19e6230e81b6c226ccc6de3f","modified":1594116687220},{"_id":"source/images/v8-parser-compiler/not-change-types-2.png","hash":"ab851928246605eb0bd616d6054a86174bec094c","modified":1594116687221},{"_id":"source/images/v8-parser-compiler/not-change-types-3.png","hash":"67f392afae56f849a98469156955c988019dd164","modified":1594116687227},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_02.png","hash":"46096c60b811ac5f923bbc177369c54765b3f018","modified":1594116685632},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg","hash":"7ff38eb37caee04ee91091a2e6ea0084510d505f","modified":1594116685652},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg","hash":"031da43506b73b3ff0029d9929c47021544e3a0d","modified":1594116685653},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg","hash":"a68ab75a84afaf83421a2559f3a84c819b47aee4","modified":1594116685654},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg","hash":"f4aaa1e3fb2b886a0583785a8543d891c8f7a3ae","modified":1594116685659},{"_id":"source/images/v8-parser-compiler/parse-time.png","hash":"fb656e7b12618b464a89f55457ca4e10e74d0b61","modified":1594116687240},{"_id":"source/images/monitor-hub/image-20200403210837664.png","hash":"2310aeb85168982b8e83b167bebd97e25198a046","modified":1594116685622},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg","hash":"4b152e2db8fcb10aba35c92f36aca475825f284a","modified":1594116685652},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg","hash":"c692bb49352bd50a4b37804626f7bebcc0d481b9","modified":1594116685653},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg","hash":"52c555ae72305fb8b3d918ade392bc562324edbc","modified":1594116685655},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg","hash":"a7b3909cff8c02bbec4a0e574e571f144c3af3ff","modified":1594116685656},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg","hash":"7a56c40ea9699e56311d4dd521dc727e9389cb1d","modified":1594116685657},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg","hash":"c057b812fe43486a785b397beea307be4bfab119","modified":1594116685668},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg","hash":"9b5ba7108e28db706c6df61d044fb38c2e099fb0","modified":1594116685665},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg","hash":"3114758346437c5fb21de28f43defa51c8e8eb1e","modified":1594116685657},{"_id":"source/images/v8-parser-compiler/parse-time-2.png","hash":"02e8ee4c9774696248b101f0b161163209ec5cfa","modified":1594116687236},{"_id":"source/images/js-capture-error/1.png","hash":"dacb219805eddb286537551536ee485f06f2ee89","modified":1594116685602},{"_id":"source/images/js-capture-error/5.jpg","hash":"0582a343ea918d89bf3927a061e6f9fd34008755","modified":1594116685614},{"_id":"source/images/v8-parser-compiler/parser-phase.png","hash":"e7a3a59548e4e12625198ccbc703aa43af26fe84","modified":1594116687244},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg","hash":"89e1ce7b5ff9583c9c5c00bc333cc96b3621adc4","modified":1594116685662},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg","hash":"afe1491a544cebfb9f5a50d93b8ee9de7720d07c","modified":1594116685650},{"_id":"source/images/travel-zhoushan/travel-zhoushan-23.png","hash":"0b220b29e01c603619cc0e43ecf8188e2f1bbc5b","modified":1594116686096},{"_id":"source/images/travel-zhoushan/travel-zhoushan-32.png","hash":"7bc5f30bc360006afd5c9a9b5db45e64dcffc90d","modified":1594116686296},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg","hash":"ceaefc338091cf00f390566f1bee28a85307d22b","modified":1594116685662},{"_id":"source/images/nodejs-istio-k8s-docker/arch.jpg","hash":"b75734a1049f76fa33c9e26f4864da33d3876df9","modified":1594116685646},{"_id":"source/images/v8-parser-compiler/parse-time-1.png","hash":"47aa703918420af77205acd2dad7f60749266a16","modified":1594116687233},{"_id":"source/images/travel-zhoushan/travel-zhoushan-16.png","hash":"5104979e08693d7777c21afc3bd90aaeae487acd","modified":1594116685944},{"_id":"source/images/travel-zhoushan/travel-zhoushan-03.png","hash":"a5353d5d6952bfbc9ab32ff08cace44deef3c9f7","modified":1594116685712},{"_id":"source/images/travel-zhoushan/travel-zhoushan-12.jpg","hash":"f379cdb4ac2109ffe2d1d016950620c7d1c17b47","modified":1594116685908},{"_id":"source/images/travel-zhoushan/travel-zhoushan-01.png","hash":"c82df63b6f3873c4495430971ecad76fa44afd62","modified":1594116685680},{"_id":"source/images/travel-zhoushan/travel-zhoushan-13.jpg","hash":"16ad58171a226cfb0e00f26ec53bb62ba3f684c7","modified":1594116685924},{"_id":"source/images/js-capture-error/2.jpg","hash":"75a01876e36c3470e2589b8f3c30bb55b20e1a9e","modified":1594116685612},{"_id":"source/images/v8-parser-compiler/v8-pare-compile-cost.png","hash":"ec6e1f86d094fae4a15102a24ceae28e1a76b71d","modified":1594116687247},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.png","hash":"444d87431a45f3e4c6ca2d2511de8e0cd12e7d1b","modified":1594116685642},{"_id":"source/images/travel-zhoushan/travel-zhoushan-29.jpg","hash":"348566a2036e2cc505f1a1bb5913e159f2e485dd","modified":1594116686241},{"_id":"source/images/traveling-to-the-philippines/27.jpg","hash":"4e15125876b160a47f66fe0835fb26efcc37e456","modified":1594116686798},{"_id":"source/images/traveling-to-the-philippines/26.jpg","hash":"17d6879785c31dc08c8625d2b54672c277e880ae","modified":1594116686781},{"_id":"source/images/travel-zhoushan/travel-zhoushan-15.mp4","hash":"43cd9598df59af319fe3e010b53965c700cf16c8","modified":1594116685931},{"_id":"source/images/traveling-to-the-philippines/2.jpg","hash":"3d1b5fe7a18c3b157d7a76931a24134516f1df2b","modified":1594116686574},{"_id":"source/images/traveling-to-the-philippines/13.jpg","hash":"86666ad42e2c18f8df3b3bb438e383e7aab19b26","modified":1594116686415},{"_id":"source/images/traveling-to-the-philippines/25.jpg","hash":"fb8326a57bddda0a8ff03966041b78d335019441","modified":1594116686754},{"_id":"source/images/travel-zhoushan/travel-zhoushan-04.jpg","hash":"cf166199ee1d541d0456d7061aeb3100dbb7c7ff","modified":1594116685723},{"_id":"source/images/travel-zhoushan/travel-zhoushan-26.jpg","hash":"0dd35c9e96125c3ab6e40157b3f8070b288d7e3b","modified":1594116686163},{"_id":"source/images/traveling-to-the-philippines/6.jpg","hash":"afb158c4f30418d27c35298e833bc4c5aecbbe14","modified":1594116687123},{"_id":"source/images/traveling-to-the-philippines/11.jpg","hash":"f2f6843fb714053053631e0d60f4a84e93b130f1","modified":1594116686363},{"_id":"source/images/traveling-to-the-philippines/9.jpg","hash":"c1425a41b66d74ab1608a45f63f486640a4c2072","modified":1594116687204},{"_id":"source/images/traveling-to-the-philippines/12.jpg","hash":"dcb70fbb7bf5e0b9419d74e3cdfdc45052eb19a1","modified":1594116686392},{"_id":"source/images/traveling-to-the-philippines/34.jpg","hash":"5dc39ae840f701145ec5f0fbbcb56615781f5233","modified":1594116687078},{"_id":"source/images/travel-zhoushan/travel-zhoushan-24.jpg","hash":"264c7a63264ee5332738b3a99817989b38a61819","modified":1594116686110},{"_id":"source/images/travel-zhoushan/travel-zhoushan-28.jpg","hash":"587f64edad989dcfeaff693ff755916335b54c94","modified":1594116686219},{"_id":"source/images/traveling-to-the-philippines/17.jpg","hash":"3eefa5a106856f685427d3a7322841b7ebcd36cb","modified":1594116686519},{"_id":"source/images/traveling-to-the-philippines/3.jpg","hash":"a505e8b86786f108e626d482c08774e46920139d","modified":1594116686876},{"_id":"source/images/traveling-to-the-philippines/4.jpg","hash":"e0631786797fea0feb1e84ff174270f792eb4255","modified":1594116687101},{"_id":"source/images/traveling-to-the-philippines/23.jpg","hash":"eb7a3d220d5870d49a34d54a8dd53f2774eeffc2","modified":1594116686692},{"_id":"source/images/travel-zhoushan/travel-zhoushan-17.jpg","hash":"8fe28b82a34569ceb18913b5dc795dd8d56deabb","modified":1594116685954},{"_id":"source/images/traveling-to-the-philippines/20.jpg","hash":"68f8036efb53cae3adf8bc445a6f30897b5ed234","modified":1594116686596},{"_id":"source/images/travel-zhoushan/travel-zhoushan-05.jpg","hash":"d7fe5055a1f180956e681e38beb49898238b3963","modified":1594116685744},{"_id":"source/images/traveling-to-the-philippines/31.jpg","hash":"69d4edc45e6f4e40d31b51351555b91013a44510","modified":1594116686918},{"_id":"source/images/travel-zhoushan/travel-zhoushan-09.jpg","hash":"cc60d174362ec7d60e0c11d9dc45d0dc7ba96e4c","modified":1594116685843},{"_id":"source/images/travel-zhoushan/travel-zhoushan-30.jpg","hash":"5168ee4903f6891ecc6dee81c9071ea5cd4d9f11","modified":1594116686257},{"_id":"source/images/traveling-to-the-philippines/14.jpg","hash":"d4fb952d4f8ce6df905c4e3304308807722ded7d","modified":1594116686437},{"_id":"source/images/travel-zhoushan/travel-zhoushan-27.jpg","hash":"675b38ad451c65f8df5b8aaa7b47a1448a4f0a5d","modified":1594116686191},{"_id":"source/images/traveling-to-the-philippines/30.jpg","hash":"83c2db4773744d39f66c1d52e51f53971c5afcaf","modified":1594116686894},{"_id":"source/images/travel-zhoushan/travel-zhoushan-19.jpg","hash":"b55c1563ed9bc5306277b6d41f009524849d246a","modified":1594116686000},{"_id":"source/images/traveling-to-the-philippines/1.jpg","hash":"b1fa05a24083c98a28b934344f1bdf5a67df06f0","modified":1594116686306},{"_id":"source/images/travel-zhoushan/travel-zhoushan-31.jpg","hash":"c6ccb78e1da3bcd0279af135a504bbbb11ea646a","modified":1594116686283},{"_id":"source/images/traveling-to-the-philippines/32.jpg","hash":"42a513f3038d178f52ec6601da1ce74d93cee165","modified":1594116687026},{"_id":"source/images/travel-zhoushan/travel-zhoushan-20.jpg","hash":"7c43901d421c36aa2ccd048867db904ff86e5f91","modified":1594116686027},{"_id":"source/images/travel-zhoushan/travel-zhoushan-08.jpg","hash":"7a667808d1aa7684164259cdda466bb62ca1f617","modified":1594116685820},{"_id":"source/images/travel-zhoushan/travel-zhoushan-18.jpg","hash":"b0891f3a3b64bb64155cc7d417b9679660ebb589","modified":1594116685975},{"_id":"source/images/travel-zhoushan/travel-zhoushan-25.jpg","hash":"770bab21f8890fb3951f97efcd2d3147e19d6b87","modified":1594116686136},{"_id":"source/images/traveling-to-the-philippines/10.jpg","hash":"0b2f9ef30a378d3af94492a9f5472bb365a4f61a","modified":1594116686335},{"_id":"source/images/traveling-to-the-philippines/29.jpg","hash":"416513cc33a1ee5c5290fca1dcc6bf1dde2f837b","modified":1594116686838},{"_id":"source/images/traveling-to-the-philippines/8.jpg","hash":"472272b727cb7da43edde1d504f983e6fc34ad8c","modified":1594116687178},{"_id":"source/images/traveling-to-the-philippines/28.jpg","hash":"0c26af42740f5c1579efb1afecfff73cf0a6fee6","modified":1594116686817},{"_id":"source/images/travel-zhoushan/travel-zhoushan-10.jpg","hash":"f07e56dbb331068eb3330448f53fa1e79774a553","modified":1594116685869},{"_id":"source/images/travel-zhoushan/travel-zhoushan-21.jpg","hash":"52ecd7fb0a5f963a8127590591d4a3850b1dec75","modified":1594116686049},{"_id":"source/images/traveling-to-the-philippines/24.jpg","hash":"e487c3820c05646939bf32c0ee75c8d297230442","modified":1594116686714},{"_id":"source/images/traveling-to-the-philippines/16.jpg","hash":"d8049cceba3e0e37b60227071c6e832d330c6ce8","modified":1594116686491},{"_id":"source/images/travel-zhoushan/travel-zhoushan-06.jpg","hash":"4b52d8525264fa7c2b0b115fedb60f3e58ae7332","modified":1594116685770},{"_id":"source/images/travel-zhoushan/travel-zhoushan-11.jpg","hash":"92cc948f3787754e4787ad08370236a40bde67bb","modified":1594116685893},{"_id":"source/images/traveling-to-the-philippines/7.jpg","hash":"1a58dcad2808f5d5973c6b9095bc7e70b10a77eb","modified":1594116687150},{"_id":"source/images/travel-zhoushan/travel-zhoushan-02.jpg","hash":"a09fa91e40653b84356bf9ef283e3e712518e4c4","modified":1594116685693},{"_id":"source/images/traveling-to-the-philippines/15.jpg","hash":"1236ad3788f5f58a9a2bf0e739e72aeecf78a7a4","modified":1594116686466},{"_id":"source/images/traveling-to-the-philippines/33.jpeg","hash":"0c442a5b7cd93eec6e56c59e814d97361121c238","modified":1594116687045},{"_id":"source/images/travel-zhoushan/travel-zhoushan-07.jpg","hash":"5ab19fbe4f011e2a77a4932912d0edcdfb577ae3","modified":1594116685791},{"_id":"source/images/traveling-to-the-philippines/22.jpg","hash":"2e0e76e19e6b3224f5aef6666853fc76bec5e040","modified":1594116686656},{"_id":"source/images/travel-zhoushan/travel-zhoushan-22.jpg","hash":"84c28148493d37d9dbaa050866af2498b64a54e3","modified":1594116686074},{"_id":"source/images/traveling-to-the-philippines/21.jpg","hash":"4c6034c62b008a531593252d4a0dacfd6afe7a5b","modified":1594116686621},{"_id":"source/images/traveling-to-the-philippines/19.jpg","hash":"1d7e6d3b9652d43eb331c2a65201339c0d6c6544","modified":1594116686537},{"_id":"source/images/lighthouse/report.png","hash":"12d66e89769f29802519f68f399255e931247b36","modified":1594140247497},{"_id":"source/.DS_Store","hash":"9b96373c219b70dafc0183c098b52d4e47a92b1b","modified":1577788131924},{"_id":"source/_posts/lighthouse.md","hash":"a17a7f11110d96ea577a271b3115088c92e84102","modified":1594362022780},{"_id":"source/images/lighthouse/architecture.png","hash":"67429cd13974c7d16138a5d5d2c4167e84e0596d","modified":1594301642737},{"_id":"themes/minos/package-lock.json","hash":"e1fbecec56fb65379bf651f21fb485376e692b38","modified":1539929989634},{"_id":"source/images/.DS_Store","hash":"c8cc470eb3f4388561bdceaec34f98a2086da020","modified":1593484886406},{"_id":"source/images/egg-boot/.DS_Store","hash":"0c82b857514722a0dd3e68af11725189c37f138d","modified":1559396761929},{"_id":"source/images/js-css-image-loading/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1538981158873},{"_id":"source/images/monitor-hub/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1585920072573},{"_id":"source/images/node-perf-heapdump-flame-graph/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1582355694656},{"_id":"source/images/travel-zhoushan/.DS_Store","hash":"2fea8594a2841bfcb1d1895785c1c2b40c074d7e","modified":1570498846332},{"_id":"source/images/traveling-to-the-philippines/.DS_Store","hash":"09847c782bbd99879ee77fd46a2f4dec199098e7","modified":1537774825570},{"_id":"source/images/vue-component-extends/.DS_Store","hash":"00a462683ca4b1bac0c231a447a8b4898cb88c06","modified":1542703462901},{"_id":"source/images/travel-zhoushan/optimize/.DS_Store","hash":"e05e4876d1927be7614e27b317c44ea6e0f581b1","modified":1570460647191}],"Category":[{"name":"JavaScript","_id":"ckcc0bs5h0002d12iguz5x1er"},{"name":"work","_id":"ckcc0bs5s0007d12i55rhv16a"},{"name":"","_id":"ckcc0bs6a000od12ihlgzwobt"},{"name":"travel","_id":"ckcc0bs6r001bd12i099h5srq"}],"Data":[],"Page":[],"Post":[{"title":"Eggjs Boot","keywords":"Eggjs Boot,Eggjs,Eggjs","description":"This article will introduce the boot of Eggjs that is a Node.js web framework.It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.","date":"2019-05-09T07:01:08.568Z","_content":"\n### **#Preface**\n\nThis article will introduce the boot of [Eggjs](<https://eggjs.org/>) that is a Node.js web framework.\n\nIt is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.\n\nEggjs has a few major libs, egg-coreeggegg-clusteregg-binegg-scripts and so on.\n\n**egg-core**: it extends Koa and is as a parent object of every agent and worker.\n\n**egg**: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.\n\n**egg-cluster**: it creates a cluster and manages them.\n\n**egg-scripts and Egg-bin**: their job is run the whole app in a different environment.\n\n<br/>\n\n_**Tips: We will discuss Eggjs with basing 2.x.x version.**_\n\n<br/>\n\n<!-- more -->\n\n## **#Scan Libs Code**\n\n_* The directory and the code segment are not whole content after this post, these major are only for a better explanation._\n\n### **egg-core**\n\n```\n lib\n   / loader (dir)\n   mixin (dir)\n   utils (dir)\n  egg.js\n  lifecycle.js\n```\n\nThe above is the directory structure of egg-core.The _**egg.js**_ and folder of the _**loader**_ are important to point for this lib.\n\nSee egg.js\n\n```javascript\nconst KoaApplication = require('koa')\nconst Lifecycle = require('./lifecycle')\n\nclass EggCore extends KoaApplication {\n  constructor(options = {}) {\n    // ...\n    this.lifecycle = new Lifecycle({\n      baseDir: options.baseDir,\n      app: this,\n      logger: this.console\n    })\n\n    const Loader = this[EGG_LOADER]\n    assert(Loader, \"Symbol.for('egg#loader') is required\")\n    this.loader = new Loader({\n      baseDir: options.baseDir,\n      app: this,\n      plugins: options.plugins,\n      logger: this.console,\n      serverScope: options.serverScope,\n      env: options.env\n    })\n    // ...\n  }\n  beforeStart(scope) {\n    this.lifecycle.registerBeforeStart(scope)\n  }\n  ready(flagOrFunction) {\n    return this.lifecycle.ready(flagOrFunction)\n  }\n  get [EGG_LOADER]() {\n    return require('./loader/egg_loader')\n  }\n}\n```\n\nFirst, we can know why it is called that bases on Koa because EggCore extends KoaApplication.\n\nSecond, it defines a few new fields in the construction function, such as _lifecycle_ and _loader_. The _loader_ field helps app for creating important feature include configplugincontrollerextendroutermiddlewareservice and so on, it will load some js file in the special directory when the app is starting.\n\nAnother side, both _beforeStart_ and _ready_ often are called when we need to write some plugins.\n\n### **egg**\n\n```\n / app\n / config\n / lib\n  - / core\n    - / messenger\n  - / jsdoc\n  - / loader\n  - agent.js\n  - application.js\n  - egg.js\n  - start.js\n- index.js\n```\n\nThere is an egg.js file that is the same name in the egg-core, but it bases on _EggCore Class_ and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.\n\nSee egg.js\n\n```javascript\nconst EggCore = require('egg-core').EggCore\nconst cluster = require('cluster-client')\nconst Messenger = require('./core/messenger')\n\nclass EggApplication extends EggCore {\n  constructor(options = {}) {\n    this.loader.loadConfig()\n    this.messenger = Messenger.create(this)\n\n    // trigger serverDidReady hook when all app workers\n    // and agent worker is ready\n    this.messenger.once('egg-ready', () => {\n      this.lifecycle.triggerServerDidReady()\n    })\n\n    this.ready(() =>\n      process.nextTick(() => {\n        const dumpStartTime = Date.now()\n        this.dumpConfig()\n        this.dumpTiming()\n        this.coreLogger.info(\n          '[egg:core] dump config after ready, %s',\n          ms(Date.now() - dumpStartTime)\n        )\n      })\n    )\n\n    this.cluster = (clientClass, options) => {\n      options = Object.assign({}, this.config.clusterClient, options, {\n        singleMode: this.options.mode === 'single',\n        // cluster need a port that can't conflict on the environment\n        port: this.options.clusterPort,\n        // agent worker is leader, app workers are follower\n        isLeader: this.type === 'agent',\n        logger: this.coreLogger\n      })\n      const client = cluster(clientClass, options)\n      this._patchClusterClient(client)\n      return client\n    }\n  }\n}\n```\n\nSee agent.js and application.js\n\n```javascript\n// agent.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AgentWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Agent extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'agent'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AgentWorkerLoader\n  }\n}\n\n// application.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AppWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Application extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'application'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AppWorkerLoader\n  }\n}\n```\n\nWe can see that they override the _EGG_LOADER_ property, which uses to create a new _loader_ field in the construction of EggCore that is their parent class. Finally, they call the _load_ function.\n\nWe have the base application code. rNext, look a few of libs for starting web app.\n\n### **egg-scripts and egg-bin**\n\nBoth these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don't know them at most of time.\n\n```javascript\n// package.json\n{\n  \"scripts\": {\n    \"start\": \"env egg-scripts start\",\n    \"dev\": \"env egg-bin dev\",\n    \"stop\": \"egg-scripts stop\",\n    \"debug\": \"egg-bin debug\",\n    \"test\": \"npm run lint -- --fix && npm run test-local\",\n    \"test-local\": \"env egg-bin test\",\n    \"cov\": \"egg-bin cov\"\n}\n```\n\nThe _scripts_ command of this eggjs app conforms to the above description.\n\n### **egg-cluster**\n\nThe cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.\n\n```\n- / lib\n  - / utils\n  - agent_worker.js\n  - app_worker.js\n  - master.js\n- index.js\n```\n\nI had written an [article](/2019/01/18/egg-cluster) about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.\n\n## **#From start to getting the first request**\n\n**What happens when we input `npm run dev` or `npm start` in the terminal?**\n\n- **egg-scripts(prod):** it can require _framework_ by `child_process.spawn` and calls _startCluster_ function.\n- **egg-bin(dev):** it can require _framework_ by `child_process.fork` and calls _startCluster_ function.\n- `[parent process]`: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the `framework` is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as `--framework { your path }`\n\n**Pseudo Code**\n\n```javascript\n// egg-scripts\n// parent process\nconst spawn = require('child_process').spawn // create new process\nspawn('node', 'require({{ framework path }}).startCluster(...)', options))\n\n// egg-bin\n// parent process\nconst cp = require('child_process')\ncp.fork('require({{ framework path }}).startCluster(...)', args, options) // create new process\n```\n\nEgg-scripts uses `spawn` function to require framework while egg-scripts calls `fork` function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.\n\nWe have two processes. In general, this newly created process is called the master process.\n\n**Why is the master process called birdge?**\n\n```javascript\n// egg index.js\nexports.startCluster = require('egg-cluster').startCluster\n```\n\nActually, we exec `egg-cluster`'s startCluster function when we require the framework. We open `index.js` file in the egg-cluster lib. \n\n__First, it is real enter point for whole web app.__\n\n```javascript\n// index.js\nconst Master = require('./lib/master')\nexports.startCluster = function(options, callback) {\n  new Master(options).ready(callback)\n}\n\n// ./lib/master.js\nconst ready = require('get-ready')\nconst detectPort = require('detect-port')\nconst Manager = require('./utils/manager')\nconst Messenger = require('./utils/messenger')\n\nclass Master extends EventEmitter {\n  constructor(options) {\n    super()\n    this.options = parseOptions(options)\n    this.workerManager = new Manager()\n    this.messenger = new Messenger(this)\n\n    ready.mixin(this)\n\n    this.ready(() => {\n      this.isStarted = true\n      const action = 'egg-ready'\n      this.messenger.send({\n        action,\n        to: 'parent',\n        data: { port: this[REALPORT], address: this[APP_ADDRESS] }\n      })\n      this.messenger.send({ action, to: 'app', data: this.options })\n      this.messenger.send({ action, to: 'agent', data: this.options })\n\n      // start check agent and worker status\n      if (this.isProduction) {\n        this.workerManager.startCheck()\n      }\n    })\n\n    // fork app workers after agent started\n    this.once('agent-start', this.forkAppWorkers.bind(this))\n\n    detectPort((err, port) => {\n      /* istanbul ignore if */\n      if (err) {\n        err.name = 'ClusterPortConflictError'\n        err.message = '[master] try get free port error, ' + err.message\n        this.logger.error(err)\n        process.exit(1)\n      }\n      this.options.clusterPort = port\n      this.forkAgentWorker()\n    })\n  }\n  forkAppWorkers() {\n    // ...\n    cluster.on('fork', worker => {\n      // ...\n      worker.on('message', msg => {\n        if (typeof msg === 'string') msg = { action: msg, data: msg };\n        msg.from = 'app';\n        this.messenger.send(msg);\n      });\n      // ...\n    })\n  }\n  forkAgentWorker() {\n    // ...\n    agentWorker.on('message', msg => {\n      if (typeof msg === 'string') msg = { action: msg, data: msg };\n      msg.from = 'agent';\n      this.messenger.send(msg);\n    });\n    // ...\n  }\n}\n\n\n// the callback of ready function will be trigger after all major boots had been loaded\n\n// forkAgentWorker\nconst agent = new Agent(options)\nagent.ready(err => {\n  if (err) return\n  process.send({ action: 'agent-start', to: 'master' })\n})\n\n// fork a single worker\nconst app = new Application(options);\nfunction startServer(err) {  \n  let server;\n  if (options.https) {\n    const httpsOptions = Object.assign({}, options.https, {\n      key: fs.readFileSync(options.https.key),\n      cert: fs.readFileSync(options.https.cert),\n    });\n    server = require('https').createServer(httpsOptions, app.callback());\n  } else {\n    server = require('http').createServer(app.callback());\n  }\n\n  // emit `server` event in app\n  app.emit('server', server);\n  \n  server.listen(...args);\n}\napp.ready(startServer);\n```\n\nOn the other hand, this web will be constructed during creating a `Master` object.\n\n- workerManager: it will hold on all worker porcesses.\n- messenger: we make `master` a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an [article(Chinese)]([http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works-IPC)) about it.\n\n> - The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)\n> - EggApplication maintain the other Messenge instance egg/lib/core/messenger.js\n> - Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master\n\n- ready.mixin & this.ready: 'get-ready' often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.\n\n- detectPort: apply for an available port, default is 7001.If Successly, it will `fork` an agent process and register a callback message for new created an agent object.\n\n- `[agent process]`: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.\n\n  - loadPlugin: find all plugin, record their dir paths => this.dirs\n\n  - loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.\n  - loadAgentExtend: load and merge all of the extending of agent object  (*app > plugin > core*)\n  - loadContextExtend: load and merge all of the extending of context object  (*app > plugin > core*)\n  - loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.[Application Startup Configuration(official)](https://eggjs.org/en/basics/app-start.html). It help you for better writing a few plugins.\n  - Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending `'agent-start'` to the master process.\n\n![egg boot process](/images/egg-boot/egg-boot.jpg)\n\n- `[master process]`: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get `'agent-start'` message from the agent process. It will open a new relatable load, we take a single worker process example.\n\n- `[a single worker process]`: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.\n\n  - loadPlugin: same as the agent\n\n  - loadConfig: same as the agent\n\n  - loadApplicationExtend: same as the agent  (*app > plugin > core*)\n\n  - loadRequestExtend: load and merge all of the extending of request object (*app > plugin > core*)\n\n  - loadResponseExtend: load and merge all of the extending of response object (*app > plugin > core*)\n\n  - loadContextExtend: same as the agent\n\n  - loadHelperExtend: load and merge all of the extending of helper object (*app > plugin > core*)\n\n  - loadCustomApp: same as the agent *app > plugin*\n\n  - loadService: load and merge all of the extending of helper object *app > plugin*\n\n  - loadMiddleware: load middlewares and iterate them => mw, if it conforms the middleware standard, it will be used with app.use(mw) *app > plugin > core*\n\n  - loadController: iterate all controllers' functions => key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only *app*). This middleware will be triggered when getting a new request, the Controller is defined in the `app/controller ` directory and the key is it's function.\n\n    ```javascript\n    function methodToMiddleware(Controller, key) {\n      return function classControllerMiddleware(...args) {\n        const controller = new Controller(this);\n        if (!this.app.config.controller || !this.app.config.controller.supportParams) {\n          args = [ this ];\n        }\n        return utils.callFn(controller[key], args, controller);\n      };\n    }\n    ```\n\n    \n\n  - loadRouter: it makes requests path associated with the controllers' function that has been become to middleware (only *app*)\n\n  - loadCustomLoader: load ourselves function to create some built-in objects for app object or other.[Customloader](https://eggjs.org/en/advanced/loader.html#customloader)\n\n- `[master process]`: it listens to all worker processes and triggers the master's ready once they have finished booting.\n- send `egg-ready` to the parent process, the agent process, the app worker processes\n- Last, traverse BOOTS and run serverDidReady function of each item.\n\nIt is the whole boot for Eggjs framework but doesn't include, such as restarting a worker process when it exits or disconnects,  shuting down...\n\n__Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.__\n\n\n\n**What happens when web app get an Http request?**\n\n*We only discuss Eggjs code in the applaction layer. :)*\n\nThe `agent` can't deal with any request because it doesn't listen port. All request always hand over to `workers`. We look at creating worker code, it will run a app.callback function and listen port when it has booted.\n\nThis callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller's function.\n\n```javascript\n// koa/lib/application\nclass Application extends Emitter {\n  callback() {\n    const fn = compose(this.middleware);\n\n    if (!this.listenerCount('error')) this.on('error', this.onerror);\n\n    const handleRequest = (req, res) => {\n      const ctx = this.createContext(req, res);\n      return this.handleRequest(ctx, fn);\n    };\n\n    return handleRequest;\n  }\n  handleRequest(ctx, fnMiddleware) {\n    const res = ctx.res;\n    res.statusCode = 404;\n    const onerror = err => ctx.onerror(err);\n    const handleResponse = () => respond(ctx);\n    onFinished(res, onerror);\n    return fnMiddleware(ctx).then(handleResponse).catch(onerror);\n  }\n}\n\n// egg/lib/application\nclass Application extends EggApplication {\n\thandleRequest(ctx, fnMiddleware) {\n    this.emit('request', ctx)\n    super.handleRequest(ctx, fnMiddleware)\n    onFinished(ctx.res, () => this.emit('response', ctx))\n  }\n}\n```\n\n\n\n__In summary, we have know how to boot web app and deal with request in Eggjs.__ When we know it, we can easily write some plugins and middlewares to finish the business requirements.\n\n","source":"_posts/egg-boot.md","raw":"---\ntitle: Eggjs Boot\ncategory: JavaScript\nkeywords: Eggjs Boot,Eggjs,Eggjs\ndescription: This article will introduce the boot of Eggjs that is a Node.js web framework.It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.\ntags:\n  - Node.js\n  - JavaScript\ndate: 2019-05-09T15:01:08.568Z\n---\n\n### **#Preface**\n\nThis article will introduce the boot of [Eggjs](<https://eggjs.org/>) that is a Node.js web framework.\n\nIt is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.\n\nEggjs has a few major libs, egg-coreeggegg-clusteregg-binegg-scripts and so on.\n\n**egg-core**: it extends Koa and is as a parent object of every agent and worker.\n\n**egg**: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.\n\n**egg-cluster**: it creates a cluster and manages them.\n\n**egg-scripts and Egg-bin**: their job is run the whole app in a different environment.\n\n<br/>\n\n_**Tips: We will discuss Eggjs with basing 2.x.x version.**_\n\n<br/>\n\n<!-- more -->\n\n## **#Scan Libs Code**\n\n_* The directory and the code segment are not whole content after this post, these major are only for a better explanation._\n\n### **egg-core**\n\n```\n lib\n   / loader (dir)\n   mixin (dir)\n   utils (dir)\n  egg.js\n  lifecycle.js\n```\n\nThe above is the directory structure of egg-core.The _**egg.js**_ and folder of the _**loader**_ are important to point for this lib.\n\nSee egg.js\n\n```javascript\nconst KoaApplication = require('koa')\nconst Lifecycle = require('./lifecycle')\n\nclass EggCore extends KoaApplication {\n  constructor(options = {}) {\n    // ...\n    this.lifecycle = new Lifecycle({\n      baseDir: options.baseDir,\n      app: this,\n      logger: this.console\n    })\n\n    const Loader = this[EGG_LOADER]\n    assert(Loader, \"Symbol.for('egg#loader') is required\")\n    this.loader = new Loader({\n      baseDir: options.baseDir,\n      app: this,\n      plugins: options.plugins,\n      logger: this.console,\n      serverScope: options.serverScope,\n      env: options.env\n    })\n    // ...\n  }\n  beforeStart(scope) {\n    this.lifecycle.registerBeforeStart(scope)\n  }\n  ready(flagOrFunction) {\n    return this.lifecycle.ready(flagOrFunction)\n  }\n  get [EGG_LOADER]() {\n    return require('./loader/egg_loader')\n  }\n}\n```\n\nFirst, we can know why it is called that bases on Koa because EggCore extends KoaApplication.\n\nSecond, it defines a few new fields in the construction function, such as _lifecycle_ and _loader_. The _loader_ field helps app for creating important feature include configplugincontrollerextendroutermiddlewareservice and so on, it will load some js file in the special directory when the app is starting.\n\nAnother side, both _beforeStart_ and _ready_ often are called when we need to write some plugins.\n\n### **egg**\n\n```\n / app\n / config\n / lib\n  - / core\n    - / messenger\n  - / jsdoc\n  - / loader\n  - agent.js\n  - application.js\n  - egg.js\n  - start.js\n- index.js\n```\n\nThere is an egg.js file that is the same name in the egg-core, but it bases on _EggCore Class_ and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.\n\nSee egg.js\n\n```javascript\nconst EggCore = require('egg-core').EggCore\nconst cluster = require('cluster-client')\nconst Messenger = require('./core/messenger')\n\nclass EggApplication extends EggCore {\n  constructor(options = {}) {\n    this.loader.loadConfig()\n    this.messenger = Messenger.create(this)\n\n    // trigger serverDidReady hook when all app workers\n    // and agent worker is ready\n    this.messenger.once('egg-ready', () => {\n      this.lifecycle.triggerServerDidReady()\n    })\n\n    this.ready(() =>\n      process.nextTick(() => {\n        const dumpStartTime = Date.now()\n        this.dumpConfig()\n        this.dumpTiming()\n        this.coreLogger.info(\n          '[egg:core] dump config after ready, %s',\n          ms(Date.now() - dumpStartTime)\n        )\n      })\n    )\n\n    this.cluster = (clientClass, options) => {\n      options = Object.assign({}, this.config.clusterClient, options, {\n        singleMode: this.options.mode === 'single',\n        // cluster need a port that can't conflict on the environment\n        port: this.options.clusterPort,\n        // agent worker is leader, app workers are follower\n        isLeader: this.type === 'agent',\n        logger: this.coreLogger\n      })\n      const client = cluster(clientClass, options)\n      this._patchClusterClient(client)\n      return client\n    }\n  }\n}\n```\n\nSee agent.js and application.js\n\n```javascript\n// agent.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AgentWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Agent extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'agent'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AgentWorkerLoader\n  }\n}\n\n// application.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AppWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Application extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'application'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AppWorkerLoader\n  }\n}\n```\n\nWe can see that they override the _EGG_LOADER_ property, which uses to create a new _loader_ field in the construction of EggCore that is their parent class. Finally, they call the _load_ function.\n\nWe have the base application code. rNext, look a few of libs for starting web app.\n\n### **egg-scripts and egg-bin**\n\nBoth these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don't know them at most of time.\n\n```javascript\n// package.json\n{\n  \"scripts\": {\n    \"start\": \"env egg-scripts start\",\n    \"dev\": \"env egg-bin dev\",\n    \"stop\": \"egg-scripts stop\",\n    \"debug\": \"egg-bin debug\",\n    \"test\": \"npm run lint -- --fix && npm run test-local\",\n    \"test-local\": \"env egg-bin test\",\n    \"cov\": \"egg-bin cov\"\n}\n```\n\nThe _scripts_ command of this eggjs app conforms to the above description.\n\n### **egg-cluster**\n\nThe cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.\n\n```\n- / lib\n  - / utils\n  - agent_worker.js\n  - app_worker.js\n  - master.js\n- index.js\n```\n\nI had written an [article](/2019/01/18/egg-cluster) about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.\n\n## **#From start to getting the first request**\n\n**What happens when we input `npm run dev` or `npm start` in the terminal?**\n\n- **egg-scripts(prod):** it can require _framework_ by `child_process.spawn` and calls _startCluster_ function.\n- **egg-bin(dev):** it can require _framework_ by `child_process.fork` and calls _startCluster_ function.\n- `[parent process]`: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the `framework` is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as `--framework { your path }`\n\n**Pseudo Code**\n\n```javascript\n// egg-scripts\n// parent process\nconst spawn = require('child_process').spawn // create new process\nspawn('node', 'require({{ framework path }}).startCluster(...)', options))\n\n// egg-bin\n// parent process\nconst cp = require('child_process')\ncp.fork('require({{ framework path }}).startCluster(...)', args, options) // create new process\n```\n\nEgg-scripts uses `spawn` function to require framework while egg-scripts calls `fork` function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.\n\nWe have two processes. In general, this newly created process is called the master process.\n\n**Why is the master process called birdge?**\n\n```javascript\n// egg index.js\nexports.startCluster = require('egg-cluster').startCluster\n```\n\nActually, we exec `egg-cluster`'s startCluster function when we require the framework. We open `index.js` file in the egg-cluster lib. \n\n__First, it is real enter point for whole web app.__\n\n```javascript\n// index.js\nconst Master = require('./lib/master')\nexports.startCluster = function(options, callback) {\n  new Master(options).ready(callback)\n}\n\n// ./lib/master.js\nconst ready = require('get-ready')\nconst detectPort = require('detect-port')\nconst Manager = require('./utils/manager')\nconst Messenger = require('./utils/messenger')\n\nclass Master extends EventEmitter {\n  constructor(options) {\n    super()\n    this.options = parseOptions(options)\n    this.workerManager = new Manager()\n    this.messenger = new Messenger(this)\n\n    ready.mixin(this)\n\n    this.ready(() => {\n      this.isStarted = true\n      const action = 'egg-ready'\n      this.messenger.send({\n        action,\n        to: 'parent',\n        data: { port: this[REALPORT], address: this[APP_ADDRESS] }\n      })\n      this.messenger.send({ action, to: 'app', data: this.options })\n      this.messenger.send({ action, to: 'agent', data: this.options })\n\n      // start check agent and worker status\n      if (this.isProduction) {\n        this.workerManager.startCheck()\n      }\n    })\n\n    // fork app workers after agent started\n    this.once('agent-start', this.forkAppWorkers.bind(this))\n\n    detectPort((err, port) => {\n      /* istanbul ignore if */\n      if (err) {\n        err.name = 'ClusterPortConflictError'\n        err.message = '[master] try get free port error, ' + err.message\n        this.logger.error(err)\n        process.exit(1)\n      }\n      this.options.clusterPort = port\n      this.forkAgentWorker()\n    })\n  }\n  forkAppWorkers() {\n    // ...\n    cluster.on('fork', worker => {\n      // ...\n      worker.on('message', msg => {\n        if (typeof msg === 'string') msg = { action: msg, data: msg };\n        msg.from = 'app';\n        this.messenger.send(msg);\n      });\n      // ...\n    })\n  }\n  forkAgentWorker() {\n    // ...\n    agentWorker.on('message', msg => {\n      if (typeof msg === 'string') msg = { action: msg, data: msg };\n      msg.from = 'agent';\n      this.messenger.send(msg);\n    });\n    // ...\n  }\n}\n\n\n// the callback of ready function will be trigger after all major boots had been loaded\n\n// forkAgentWorker\nconst agent = new Agent(options)\nagent.ready(err => {\n  if (err) return\n  process.send({ action: 'agent-start', to: 'master' })\n})\n\n// fork a single worker\nconst app = new Application(options);\nfunction startServer(err) {  \n  let server;\n  if (options.https) {\n    const httpsOptions = Object.assign({}, options.https, {\n      key: fs.readFileSync(options.https.key),\n      cert: fs.readFileSync(options.https.cert),\n    });\n    server = require('https').createServer(httpsOptions, app.callback());\n  } else {\n    server = require('http').createServer(app.callback());\n  }\n\n  // emit `server` event in app\n  app.emit('server', server);\n  \n  server.listen(...args);\n}\napp.ready(startServer);\n```\n\nOn the other hand, this web will be constructed during creating a `Master` object.\n\n- workerManager: it will hold on all worker porcesses.\n- messenger: we make `master` a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an [article(Chinese)]([http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works-IPC)) about it.\n\n> - The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)\n> - EggApplication maintain the other Messenge instance egg/lib/core/messenger.js\n> - Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master\n\n- ready.mixin & this.ready: 'get-ready' often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.\n\n- detectPort: apply for an available port, default is 7001.If Successly, it will `fork` an agent process and register a callback message for new created an agent object.\n\n- `[agent process]`: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.\n\n  - loadPlugin: find all plugin, record their dir paths => this.dirs\n\n  - loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.\n  - loadAgentExtend: load and merge all of the extending of agent object  (*app > plugin > core*)\n  - loadContextExtend: load and merge all of the extending of context object  (*app > plugin > core*)\n  - loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.[Application Startup Configuration(official)](https://eggjs.org/en/basics/app-start.html). It help you for better writing a few plugins.\n  - Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending `'agent-start'` to the master process.\n\n![egg boot process](/images/egg-boot/egg-boot.jpg)\n\n- `[master process]`: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get `'agent-start'` message from the agent process. It will open a new relatable load, we take a single worker process example.\n\n- `[a single worker process]`: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.\n\n  - loadPlugin: same as the agent\n\n  - loadConfig: same as the agent\n\n  - loadApplicationExtend: same as the agent  (*app > plugin > core*)\n\n  - loadRequestExtend: load and merge all of the extending of request object (*app > plugin > core*)\n\n  - loadResponseExtend: load and merge all of the extending of response object (*app > plugin > core*)\n\n  - loadContextExtend: same as the agent\n\n  - loadHelperExtend: load and merge all of the extending of helper object (*app > plugin > core*)\n\n  - loadCustomApp: same as the agent *app > plugin*\n\n  - loadService: load and merge all of the extending of helper object *app > plugin*\n\n  - loadMiddleware: load middlewares and iterate them => mw, if it conforms the middleware standard, it will be used with app.use(mw) *app > plugin > core*\n\n  - loadController: iterate all controllers' functions => key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only *app*). This middleware will be triggered when getting a new request, the Controller is defined in the `app/controller ` directory and the key is it's function.\n\n    ```javascript\n    function methodToMiddleware(Controller, key) {\n      return function classControllerMiddleware(...args) {\n        const controller = new Controller(this);\n        if (!this.app.config.controller || !this.app.config.controller.supportParams) {\n          args = [ this ];\n        }\n        return utils.callFn(controller[key], args, controller);\n      };\n    }\n    ```\n\n    \n\n  - loadRouter: it makes requests path associated with the controllers' function that has been become to middleware (only *app*)\n\n  - loadCustomLoader: load ourselves function to create some built-in objects for app object or other.[Customloader](https://eggjs.org/en/advanced/loader.html#customloader)\n\n- `[master process]`: it listens to all worker processes and triggers the master's ready once they have finished booting.\n- send `egg-ready` to the parent process, the agent process, the app worker processes\n- Last, traverse BOOTS and run serverDidReady function of each item.\n\nIt is the whole boot for Eggjs framework but doesn't include, such as restarting a worker process when it exits or disconnects,  shuting down...\n\n__Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.__\n\n\n\n**What happens when web app get an Http request?**\n\n*We only discuss Eggjs code in the applaction layer. :)*\n\nThe `agent` can't deal with any request because it doesn't listen port. All request always hand over to `workers`. We look at creating worker code, it will run a app.callback function and listen port when it has booted.\n\nThis callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller's function.\n\n```javascript\n// koa/lib/application\nclass Application extends Emitter {\n  callback() {\n    const fn = compose(this.middleware);\n\n    if (!this.listenerCount('error')) this.on('error', this.onerror);\n\n    const handleRequest = (req, res) => {\n      const ctx = this.createContext(req, res);\n      return this.handleRequest(ctx, fn);\n    };\n\n    return handleRequest;\n  }\n  handleRequest(ctx, fnMiddleware) {\n    const res = ctx.res;\n    res.statusCode = 404;\n    const onerror = err => ctx.onerror(err);\n    const handleResponse = () => respond(ctx);\n    onFinished(res, onerror);\n    return fnMiddleware(ctx).then(handleResponse).catch(onerror);\n  }\n}\n\n// egg/lib/application\nclass Application extends EggApplication {\n\thandleRequest(ctx, fnMiddleware) {\n    this.emit('request', ctx)\n    super.handleRequest(ctx, fnMiddleware)\n    onFinished(ctx.res, () => this.emit('response', ctx))\n  }\n}\n```\n\n\n\n__In summary, we have know how to boot web app and deal with request in Eggjs.__ When we know it, we can easily write some plugins and middlewares to finish the business requirements.\n\n","slug":"egg-boot","published":1,"updated":"2020-07-07T10:11:25.586Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs570000d12iwhc9qpyq","content":"<h3 id=\"Preface\"><a href=\"#Preface\" class=\"headerlink\" title=\"#Preface\"></a><strong>#Preface</strong></h3><p>This article will introduce the boot of <a href=\"https://eggjs.org/\" target=\"_blank\" rel=\"noopener\">Eggjs</a> that is a Node.js web framework.</p>\n<p>It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.</p>\n<p>Eggjs has a few major libs, egg-coreeggegg-clusteregg-binegg-scripts and so on.</p>\n<p><strong>egg-core</strong>: it extends Koa and is as a parent object of every agent and worker.</p>\n<p><strong>egg</strong>: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.</p>\n<p><strong>egg-cluster</strong>: it creates a cluster and manages them.</p>\n<p><strong>egg-scripts and Egg-bin</strong>: their job is run the whole app in a different environment.</p>\n<p><br></p>\n<p><em><strong>Tips: We will discuss Eggjs with basing 2.x.x version.</strong></em></p>\n<p><br></p>\n<a id=\"more\"></a>\n<h2 id=\"Scan-Libs-Code\"><a href=\"#Scan-Libs-Code\" class=\"headerlink\" title=\"#Scan Libs Code\"></a><strong>#Scan Libs Code</strong></h2><p><em>* The directory and the code segment are not whole content after this post, these major are only for a better explanation.</em></p>\n<h3 id=\"egg-core\"><a href=\"#egg-core\" class=\"headerlink\" title=\"egg-core\"></a><strong>egg-core</strong></h3><figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> lib</span><br><span class=\"line\">   / loader (dir)</span><br><span class=\"line\">   mixin (dir)</span><br><span class=\"line\">   utils (dir)</span><br><span class=\"line\">  egg.js</span><br><span class=\"line\">  lifecycle.js</span><br></pre></td></tr></table></figure>\n<p>The above is the directory structure of egg-core.The <em><strong>egg.js</strong></em> and folder of the <em><strong>loader</strong></em> are important to point for this lib.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> KoaApplication = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Lifecycle = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./lifecycle'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">EggCore</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">KoaApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.lifecycle = <span class=\"hljs-keyword\">new</span> Lifecycle(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"hljs-keyword\">this</span>,</span><br><span class=\"line\">      logger: <span class=\"hljs-keyword\">this</span>.console</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> Loader = <span class=\"hljs-keyword\">this</span>[EGG_LOADER]</span><br><span class=\"line\">    assert(Loader, <span class=\"hljs-string\">\"Symbol.for('egg#loader') is required\"</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader = <span class=\"hljs-keyword\">new</span> Loader(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"hljs-keyword\">this</span>,</span><br><span class=\"line\">      plugins: options.plugins,</span><br><span class=\"line\">      logger: <span class=\"hljs-keyword\">this</span>.console,</span><br><span class=\"line\">      serverScope: options.serverScope,</span><br><span class=\"line\">      env: options.env</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  beforeStart(scope) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.lifecycle.registerBeforeStart(scope)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ready(flagOrFunction) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.lifecycle.ready(flagOrFunction)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader/egg_loader'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>First, we can know why it is called that bases on Koa because EggCore extends KoaApplication.</p>\n<p>Second, it defines a few new fields in the construction function, such as <em>lifecycle</em> and <em>loader</em>. The <em>loader</em> field helps app for creating important feature include configplugincontrollerextendroutermiddlewareservice and so on, it will load some js file in the special directory when the app is starting.</p>\n<p>Another side, both <em>beforeStart</em> and <em>ready</em> often are called when we need to write some plugins.</p>\n<h3 id=\"egg\"><a href=\"#egg\" class=\"headerlink\" title=\"egg\"></a><strong>egg</strong></h3><figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> / app</span><br><span class=\"line\"> / config</span><br><span class=\"line\"> / lib</span><br><span class=\"line\">  - / core</span><br><span class=\"line\">    - / messenger</span><br><span class=\"line\">  - / jsdoc</span><br><span class=\"line\">  - / loader</span><br><span class=\"line\">  - agent.js</span><br><span class=\"line\">  - application.js</span><br><span class=\"line\">  - egg.js</span><br><span class=\"line\">  - start.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>There is an egg.js file that is the same name in the egg-core, but it bases on <em>EggCore Class</em> and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> EggCore = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'egg-core'</span>).EggCore</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> cluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'cluster-client'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Messenger = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./core/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">EggApplication</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggCore</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader.loadConfig()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.messenger = Messenger.create(<span class=\"hljs-keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// trigger serverDidReady hook when all app workers</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// and agent worker is ready</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.messenger.once(<span class=\"hljs-string\">'egg-ready'</span>, () =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.lifecycle.triggerServerDidReady()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.ready(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span></span><br><span class=\"line\">      process.nextTick(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> dumpStartTime = <span class=\"hljs-built_in\">Date</span>.now()</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.dumpConfig()</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.dumpTiming()</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.coreLogger.info(</span><br><span class=\"line\">          <span class=\"hljs-string\">'[egg:core] dump config after ready, %s'</span>,</span><br><span class=\"line\">          ms(<span class=\"hljs-built_in\">Date</span>.now() - dumpStartTime)</span><br><span class=\"line\">        )</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.cluster = <span class=\"hljs-function\">(<span class=\"hljs-params\">clientClass, options</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      options = <span class=\"hljs-built_in\">Object</span>.assign(&#123;&#125;, <span class=\"hljs-keyword\">this</span>.config.clusterClient, options, &#123;</span><br><span class=\"line\">        singleMode: <span class=\"hljs-keyword\">this</span>.options.mode === <span class=\"hljs-string\">'single'</span>,</span><br><span class=\"line\">        <span class=\"hljs-comment\">// cluster need a port that can't conflict on the environment</span></span><br><span class=\"line\">        port: <span class=\"hljs-keyword\">this</span>.options.clusterPort,</span><br><span class=\"line\">        <span class=\"hljs-comment\">// agent worker is leader, app workers are follower</span></span><br><span class=\"line\">        isLeader: <span class=\"hljs-keyword\">this</span>.type === <span class=\"hljs-string\">'agent'</span>,</span><br><span class=\"line\">        logger: <span class=\"hljs-keyword\">this</span>.coreLogger</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> client = cluster(clientClass, options)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>._patchClusterClient(client)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> client</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>See agent.js and application.js</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// agent.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EggApplication = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> AgentWorkerLoader = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader'</span>).AgentWorkerLoader</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EGG_LOADER = <span class=\"hljs-built_in\">Symbol</span>.for(<span class=\"hljs-string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Agent</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"hljs-string\">'agent'</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> AgentWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// application.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EggApplication = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> AgentWorkerLoader = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader'</span>).AppWorkerLoader</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EGG_LOADER = <span class=\"hljs-built_in\">Symbol</span>.for(<span class=\"hljs-string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"hljs-string\">'application'</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> AppWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>We can see that they override the _EGG_LOADER_ property, which uses to create a new <em>loader</em> field in the construction of EggCore that is their parent class. Finally, they call the <em>load</em> function.</p>\n<p>We have the base application code. rNext, look a few of libs for starting web app.</p>\n<h3 id=\"egg-scripts-and-egg-bin\"><a href=\"#egg-scripts-and-egg-bin\" class=\"headerlink\" title=\"egg-scripts and egg-bin\"></a><strong>egg-scripts and egg-bin</strong></h3><p>Both these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost dont know them at most of time.</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// package.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-string\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"hljs-string\">\"start\"</span>: <span class=\"hljs-string\">\"env egg-scripts start\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"dev\"</span>: <span class=\"hljs-string\">\"env egg-bin dev\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"stop\"</span>: <span class=\"hljs-string\">\"egg-scripts stop\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"debug\"</span>: <span class=\"hljs-string\">\"egg-bin debug\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"test\"</span>: <span class=\"hljs-string\">\"npm run lint -- --fix &amp;&amp; npm run test-local\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"test-local\"</span>: <span class=\"hljs-string\">\"env egg-bin test\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"cov\"</span>: <span class=\"hljs-string\">\"egg-bin cov\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The <em>scripts</em> command of this eggjs app conforms to the above description.</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a><strong>egg-cluster</strong></h3><p>The cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.</p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- / lib</span><br><span class=\"line\">  - / utils</span><br><span class=\"line\">  - agent_worker.js</span><br><span class=\"line\">  - app_worker.js</span><br><span class=\"line\">  - master.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>I had written an <a href=\"/2019/01/18/egg-cluster\">article</a> about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.</p>\n<h2 id=\"From-start-to-getting-the-first-request\"><a href=\"#From-start-to-getting-the-first-request\" class=\"headerlink\" title=\"#From start to getting the first request\"></a><strong>#From start to getting the first request</strong></h2><p><strong>What happens when we input <code>npm run dev</code> or <code>npm start</code> in the terminal?</strong></p>\n<ul>\n<li><strong>egg-scripts(prod):</strong> it can require <em>framework</em> by <code>child_process.spawn</code> and calls <em>startCluster</em> function.</li>\n<li><strong>egg-bin(dev):</strong> it can require <em>framework</em> by <code>child_process.fork</code> and calls <em>startCluster</em> function.</li>\n<li><code>[parent process]</code>: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the <code>framework</code> is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as <code>--framework { your path }</code></li>\n</ul>\n<p><strong>Pseudo Code</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-scripts</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// parent process</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> spawn = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>).spawn <span class=\"hljs-comment\">// create new process</span></span><br><span class=\"line\">spawn(<span class=\"hljs-string\">'node'</span>, <span class=\"hljs-string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, options))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// egg-bin</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// parent process</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> cp = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>)</span><br><span class=\"line\">cp.fork(<span class=\"hljs-string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, args, options) <span class=\"hljs-comment\">// create new process</span></span><br></pre></td></tr></table></figure>\n<p>Egg-scripts uses <code>spawn</code> function to require framework while egg-scripts calls <code>fork</code> function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.</p>\n<p>We have two processes. In general, this newly created process is called the master process.</p>\n<p><strong>Why is the master process called birdge?</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg index.js</span></span><br><span class=\"line\">exports.startCluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'egg-cluster'</span>).startCluster</span><br></pre></td></tr></table></figure>\n<p>Actually, we exec <code>egg-cluster</code>s startCluster function when we require the framework. We open <code>index.js</code> file in the egg-cluster lib. </p>\n<p><strong>First, it is real enter point for whole web app.</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// index.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Master = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./lib/master'</span>)</span><br><span class=\"line\">exports.startCluster = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// ./lib/master.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> ready = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'get-ready'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> detectPort = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'detect-port'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Manager = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./utils/manager'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Messenger = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./utils/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.options = parseOptions(options)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.workerManager = <span class=\"hljs-keyword\">new</span> Manager()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.messenger = <span class=\"hljs-keyword\">new</span> Messenger(<span class=\"hljs-keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    ready.mixin(<span class=\"hljs-keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.ready(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.isStarted = <span class=\"hljs-literal\">true</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> action = <span class=\"hljs-string\">'egg-ready'</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(&#123;</span><br><span class=\"line\">        action,</span><br><span class=\"line\">        to: <span class=\"hljs-string\">'parent'</span>,</span><br><span class=\"line\">        data: &#123; <span class=\"hljs-attr\">port</span>: <span class=\"hljs-keyword\">this</span>[REALPORT], <span class=\"hljs-attr\">address</span>: <span class=\"hljs-keyword\">this</span>[APP_ADDRESS] &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(&#123; action, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'app'</span>, <span class=\"hljs-attr\">data</span>: <span class=\"hljs-keyword\">this</span>.options &#125;)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(&#123; action, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'agent'</span>, <span class=\"hljs-attr\">data</span>: <span class=\"hljs-keyword\">this</span>.options &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// start check agent and worker status</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.isProduction) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.workerManager.startCheck()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// fork app workers after agent started</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.once(<span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-keyword\">this</span>.forkAppWorkers.bind(<span class=\"hljs-keyword\">this</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    detectPort(<span class=\"hljs-function\">(<span class=\"hljs-params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">/* istanbul ignore if */</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (err) &#123;</span><br><span class=\"line\">        err.name = <span class=\"hljs-string\">'ClusterPortConflictError'</span></span><br><span class=\"line\">        err.message = <span class=\"hljs-string\">'[master] try get free port error, '</span> + err.message</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.logger.error(err)</span><br><span class=\"line\">        process.exit(<span class=\"hljs-number\">1</span>)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.options.clusterPort = port</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.forkAgentWorker()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAppWorkers() &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    cluster.on(<span class=\"hljs-string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">      worker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">        msg.from = <span class=\"hljs-string\">'app'</span>;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAgentWorker() &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    agentWorker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">      msg.from = <span class=\"hljs-string\">'agent'</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// the callback of ready function will be trigger after all major boots had been loaded</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// forkAgentWorker</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> agent = <span class=\"hljs-keyword\">new</span> Agent(options)</span><br><span class=\"line\">agent.ready(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (err) <span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">  process.send(&#123; <span class=\"hljs-attr\">action</span>: <span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'master'</span> &#125;)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// fork a single worker</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-keyword\">new</span> Application(options);</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">startServer</span>(<span class=\"hljs-params\">err</span>) </span>&#123;  </span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> server;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (options.https) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> httpsOptions = <span class=\"hljs-built_in\">Object</span>.assign(&#123;&#125;, options.https, &#123;</span><br><span class=\"line\">      key: fs.readFileSync(options.https.key),</span><br><span class=\"line\">      cert: fs.readFileSync(options.https.cert),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    server = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'https'</span>).createServer(httpsOptions, app.callback());</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">    server = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'http'</span>).createServer(app.callback());</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// emit `server` event in app</span></span><br><span class=\"line\">  app.emit(<span class=\"hljs-string\">'server'</span>, server);</span><br><span class=\"line\">  </span><br><span class=\"line\">  server.listen(...args);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">app.ready(startServer);</span><br></pre></td></tr></table></figure>\n<p>On the other hand, this web will be constructed during creating a <code>Master</code> object.</p>\n<ul>\n<li>workerManager: it will hold on all worker porcesses.</li>\n<li>messenger: we make <code>master</code> a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an <a href=\"[http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works-IPC\">article(Chinese)</a>) about it.</li>\n</ul>\n<blockquote>\n<ul>\n<li>The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)</li>\n<li>EggApplication maintain the other Messenge instance egg/lib/core/messenger.js</li>\n<li>Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master</li>\n</ul>\n</blockquote>\n<ul>\n<li><p>ready.mixin &amp; this.ready: get-ready often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.</p>\n</li>\n<li><p>detectPort: apply for an available port, default is 7001.If Successly, it will <code>fork</code> an agent process and register a callback message for new created an agent object.</p>\n</li>\n<li><p><code>[agent process]</code>: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.</p>\n<ul>\n<li><p>loadPlugin: find all plugin, record their dir paths =&gt; this.dirs</p>\n</li>\n<li><p>loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.</p>\n</li>\n<li>loadAgentExtend: load and merge all of the extending of agent object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadContextExtend: load and merge all of the extending of context object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.<a href=\"https://eggjs.org/en/basics/app-start.html\" target=\"_blank\" rel=\"noopener\">Application Startup Configuration(official)</a>. It help you for better writing a few plugins.</li>\n<li>Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending <code>&#39;agent-start&#39;</code> to the master process.</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"/images/egg-boot/egg-boot.jpg\" alt=\"egg boot process\"></p>\n<ul>\n<li><p><code>[master process]</code>: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get <code>&#39;agent-start&#39;</code> message from the agent process. It will open a new relatable load, we take a single worker process example.</p>\n</li>\n<li><p><code>[a single worker process]</code>: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.</p>\n<ul>\n<li><p>loadPlugin: same as the agent</p>\n</li>\n<li><p>loadConfig: same as the agent</p>\n</li>\n<li><p>loadApplicationExtend: same as the agent  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadRequestExtend: load and merge all of the extending of request object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadResponseExtend: load and merge all of the extending of response object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadContextExtend: same as the agent</p>\n</li>\n<li><p>loadHelperExtend: load and merge all of the extending of helper object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadCustomApp: same as the agent <em>app &gt; plugin</em></p>\n</li>\n<li><p>loadService: load and merge all of the extending of helper object <em>app &gt; plugin</em></p>\n</li>\n<li><p>loadMiddleware: load middlewares and iterate them =&gt; mw, if it conforms the middleware standard, it will be used with app.use(mw) <em>app &gt; plugin &gt; core</em></p>\n</li>\n<li><p>loadController: iterate all controllers functions =&gt; key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only <em>app</em>). This middleware will be triggered when getting a new request, the Controller is defined in the <code>app/controller</code> directory and the key is its function.</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">methodToMiddleware</span>(<span class=\"hljs-params\">Controller, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">classControllerMiddleware</span>(<span class=\"hljs-params\">...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> controller = <span class=\"hljs-keyword\">new</span> Controller(<span class=\"hljs-keyword\">this</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-keyword\">this</span>.app.config.controller || !<span class=\"hljs-keyword\">this</span>.app.config.controller.supportParams) &#123;</span><br><span class=\"line\">      args = [ <span class=\"hljs-keyword\">this</span> ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> utils.callFn(controller[key], args, controller);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>loadRouter: it makes requests path associated with the controllers function that has been become to middleware (only <em>app</em>)</p>\n</li>\n<li><p>loadCustomLoader: load ourselves function to create some built-in objects for app object or other.<a href=\"https://eggjs.org/en/advanced/loader.html#customloader\" target=\"_blank\" rel=\"noopener\">Customloader</a></p>\n</li>\n</ul>\n<ul>\n<li><code>[master process]</code>: it listens to all worker processes and triggers the masters ready once they have finished booting.</li>\n<li>send <code>egg-ready</code> to the parent process, the agent process, the app worker processes</li>\n<li>Last, traverse BOOTS and run serverDidReady function of each item.</li>\n</ul>\n<p>It is the whole boot for Eggjs framework but doesnt include, such as restarting a worker process when it exits or disconnects,  shuting down</p>\n<p><strong>Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.</strong></p>\n<p><strong>What happens when web app get an Http request?</strong></p>\n<p><em>We only discuss Eggjs code in the applaction layer. :)</em></p>\n<p>The <code>agent</code> cant deal with any request because it doesnt listen port. All request always hand over to <code>workers</code>. We look at creating worker code, it will run a app.callback function and listen port when it has booted.</p>\n<p>This callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controllers function.</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// koa/lib/application</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Emitter</span> </span>&#123;</span><br><span class=\"line\">  callback() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> fn = compose(<span class=\"hljs-keyword\">this</span>.middleware);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-keyword\">this</span>.listenerCount(<span class=\"hljs-string\">'error'</span>)) <span class=\"hljs-keyword\">this</span>.on(<span class=\"hljs-string\">'error'</span>, <span class=\"hljs-keyword\">this</span>.onerror);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> handleRequest = <span class=\"hljs-function\">(<span class=\"hljs-params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> ctx = <span class=\"hljs-keyword\">this</span>.createContext(req, res);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.handleRequest(ctx, fn);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> handleRequest;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  handleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> res = ctx.res;</span><br><span class=\"line\">    res.statusCode = <span class=\"hljs-number\">404</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> onerror = <span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> ctx.onerror(err);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> handleResponse = <span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> respond(ctx);</span><br><span class=\"line\">    onFinished(res, onerror);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> fnMiddleware(ctx).then(handleResponse).catch(onerror);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// egg/lib/application</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">\thandleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.emit(<span class=\"hljs-string\">'request'</span>, ctx)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>.handleRequest(ctx, fnMiddleware)</span><br><span class=\"line\">    onFinished(ctx.res, () =&gt; <span class=\"hljs-keyword\">this</span>.emit(<span class=\"hljs-string\">'response'</span>, ctx))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>In summary, we have know how to boot web app and deal with request in Eggjs.</strong> When we know it, we can easily write some plugins and middlewares to finish the business requirements.</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<h3 id=\"Preface\"><a href=\"#Preface\" class=\"headerlink\" title=\"#Preface\"></a><strong>#Preface</strong></h3><p>This article will introduce the boot of <a href=\"https://eggjs.org/\" target=\"_blank\" rel=\"noopener\">Eggjs</a> that is a Node.js web framework.</p>\n<p>It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.</p>\n<p>Eggjs has a few major libs, egg-coreeggegg-clusteregg-binegg-scripts and so on.</p>\n<p><strong>egg-core</strong>: it extends Koa and is as a parent object of every agent and worker.</p>\n<p><strong>egg</strong>: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.</p>\n<p><strong>egg-cluster</strong>: it creates a cluster and manages them.</p>\n<p><strong>egg-scripts and Egg-bin</strong>: their job is run the whole app in a different environment.</p>\n<p><br></p>\n<p><em><strong>Tips: We will discuss Eggjs with basing 2.x.x version.</strong></em></p>\n<p><br></p>","more":"<h2 id=\"Scan-Libs-Code\"><a href=\"#Scan-Libs-Code\" class=\"headerlink\" title=\"#Scan Libs Code\"></a><strong>#Scan Libs Code</strong></h2><p><em>* The directory and the code segment are not whole content after this post, these major are only for a better explanation.</em></p>\n<h3 id=\"egg-core\"><a href=\"#egg-core\" class=\"headerlink\" title=\"egg-core\"></a><strong>egg-core</strong></h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> lib</span><br><span class=\"line\">   / loader (dir)</span><br><span class=\"line\">   mixin (dir)</span><br><span class=\"line\">   utils (dir)</span><br><span class=\"line\">  egg.js</span><br><span class=\"line\">  lifecycle.js</span><br></pre></td></tr></table></figure>\n<p>The above is the directory structure of egg-core.The <em><strong>egg.js</strong></em> and folder of the <em><strong>loader</strong></em> are important to point for this lib.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> KoaApplication = <span class=\"built_in\">require</span>(<span class=\"string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Lifecycle = <span class=\"built_in\">require</span>(<span class=\"string\">'./lifecycle'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EggCore</span> <span class=\"keyword\">extends</span> <span class=\"title\">KoaApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.lifecycle = <span class=\"keyword\">new</span> Lifecycle(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"keyword\">this</span>,</span><br><span class=\"line\">      logger: <span class=\"keyword\">this</span>.console</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> Loader = <span class=\"keyword\">this</span>[EGG_LOADER]</span><br><span class=\"line\">    assert(Loader, <span class=\"string\">\"Symbol.for('egg#loader') is required\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader = <span class=\"keyword\">new</span> Loader(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"keyword\">this</span>,</span><br><span class=\"line\">      plugins: options.plugins,</span><br><span class=\"line\">      logger: <span class=\"keyword\">this</span>.console,</span><br><span class=\"line\">      serverScope: options.serverScope,</span><br><span class=\"line\">      env: options.env</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  beforeStart(scope) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.lifecycle.registerBeforeStart(scope)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ready(flagOrFunction) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.lifecycle.ready(flagOrFunction)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">require</span>(<span class=\"string\">'./loader/egg_loader'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>First, we can know why it is called that bases on Koa because EggCore extends KoaApplication.</p>\n<p>Second, it defines a few new fields in the construction function, such as <em>lifecycle</em> and <em>loader</em>. The <em>loader</em> field helps app for creating important feature include configplugincontrollerextendroutermiddlewareservice and so on, it will load some js file in the special directory when the app is starting.</p>\n<p>Another side, both <em>beforeStart</em> and <em>ready</em> often are called when we need to write some plugins.</p>\n<h3 id=\"egg\"><a href=\"#egg\" class=\"headerlink\" title=\"egg\"></a><strong>egg</strong></h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> / app</span><br><span class=\"line\"> / config</span><br><span class=\"line\"> / lib</span><br><span class=\"line\">  - / core</span><br><span class=\"line\">    - / messenger</span><br><span class=\"line\">  - / jsdoc</span><br><span class=\"line\">  - / loader</span><br><span class=\"line\">  - agent.js</span><br><span class=\"line\">  - application.js</span><br><span class=\"line\">  - egg.js</span><br><span class=\"line\">  - start.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>There is an egg.js file that is the same name in the egg-core, but it bases on <em>EggCore Class</em> and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> EggCore = <span class=\"built_in\">require</span>(<span class=\"string\">'egg-core'</span>).EggCore</span><br><span class=\"line\"><span class=\"keyword\">const</span> cluster = <span class=\"built_in\">require</span>(<span class=\"string\">'cluster-client'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Messenger = <span class=\"built_in\">require</span>(<span class=\"string\">'./core/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EggApplication</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggCore</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader.loadConfig()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messenger = Messenger.create(<span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// trigger serverDidReady hook when all app workers</span></span><br><span class=\"line\">    <span class=\"comment\">// and agent worker is ready</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messenger.once(<span class=\"string\">'egg-ready'</span>, () =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.lifecycle.triggerServerDidReady()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.ready(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span></span><br><span class=\"line\">      process.nextTick(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> dumpStartTime = <span class=\"built_in\">Date</span>.now()</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.dumpConfig()</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.dumpTiming()</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.coreLogger.info(</span><br><span class=\"line\">          <span class=\"string\">'[egg:core] dump config after ready, %s'</span>,</span><br><span class=\"line\">          ms(<span class=\"built_in\">Date</span>.now() - dumpStartTime)</span><br><span class=\"line\">        )</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.cluster = <span class=\"function\">(<span class=\"params\">clientClass, options</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      options = <span class=\"built_in\">Object</span>.assign(&#123;&#125;, <span class=\"keyword\">this</span>.config.clusterClient, options, &#123;</span><br><span class=\"line\">        singleMode: <span class=\"keyword\">this</span>.options.mode === <span class=\"string\">'single'</span>,</span><br><span class=\"line\">        <span class=\"comment\">// cluster need a port that can't conflict on the environment</span></span><br><span class=\"line\">        port: <span class=\"keyword\">this</span>.options.clusterPort,</span><br><span class=\"line\">        <span class=\"comment\">// agent worker is leader, app workers are follower</span></span><br><span class=\"line\">        isLeader: <span class=\"keyword\">this</span>.type === <span class=\"string\">'agent'</span>,</span><br><span class=\"line\">        logger: <span class=\"keyword\">this</span>.coreLogger</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"keyword\">const</span> client = cluster(clientClass, options)</span><br><span class=\"line\">      <span class=\"keyword\">this</span>._patchClusterClient(client)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> client</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>See agent.js and application.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// agent.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> EggApplication = <span class=\"built_in\">require</span>(<span class=\"string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> AgentWorkerLoader = <span class=\"built_in\">require</span>(<span class=\"string\">'./loader'</span>).AgentWorkerLoader</span><br><span class=\"line\"><span class=\"keyword\">const</span> EGG_LOADER = <span class=\"built_in\">Symbol</span>.for(<span class=\"string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Agent</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"string\">'agent'</span></span><br><span class=\"line\">    <span class=\"keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> AgentWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// application.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> EggApplication = <span class=\"built_in\">require</span>(<span class=\"string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> AgentWorkerLoader = <span class=\"built_in\">require</span>(<span class=\"string\">'./loader'</span>).AppWorkerLoader</span><br><span class=\"line\"><span class=\"keyword\">const</span> EGG_LOADER = <span class=\"built_in\">Symbol</span>.for(<span class=\"string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"string\">'application'</span></span><br><span class=\"line\">    <span class=\"keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> AppWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>We can see that they override the _EGG_LOADER_ property, which uses to create a new <em>loader</em> field in the construction of EggCore that is their parent class. Finally, they call the <em>load</em> function.</p>\n<p>We have the base application code. rNext, look a few of libs for starting web app.</p>\n<h3 id=\"egg-scripts-and-egg-bin\"><a href=\"#egg-scripts-and-egg-bin\" class=\"headerlink\" title=\"egg-scripts and egg-bin\"></a><strong>egg-scripts and egg-bin</strong></h3><p>Both these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost dont know them at most of time.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// package.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"start\"</span>: <span class=\"string\">\"env egg-scripts start\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"dev\"</span>: <span class=\"string\">\"env egg-bin dev\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"stop\"</span>: <span class=\"string\">\"egg-scripts stop\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"debug\"</span>: <span class=\"string\">\"egg-bin debug\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"test\"</span>: <span class=\"string\">\"npm run lint -- --fix &amp;&amp; npm run test-local\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"test-local\"</span>: <span class=\"string\">\"env egg-bin test\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"cov\"</span>: <span class=\"string\">\"egg-bin cov\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The <em>scripts</em> command of this eggjs app conforms to the above description.</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a><strong>egg-cluster</strong></h3><p>The cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- / lib</span><br><span class=\"line\">  - / utils</span><br><span class=\"line\">  - agent_worker.js</span><br><span class=\"line\">  - app_worker.js</span><br><span class=\"line\">  - master.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>I had written an <a href=\"/2019/01/18/egg-cluster\">article</a> about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.</p>\n<h2 id=\"From-start-to-getting-the-first-request\"><a href=\"#From-start-to-getting-the-first-request\" class=\"headerlink\" title=\"#From start to getting the first request\"></a><strong>#From start to getting the first request</strong></h2><p><strong>What happens when we input <code>npm run dev</code> or <code>npm start</code> in the terminal?</strong></p>\n<ul>\n<li><strong>egg-scripts(prod):</strong> it can require <em>framework</em> by <code>child_process.spawn</code> and calls <em>startCluster</em> function.</li>\n<li><strong>egg-bin(dev):</strong> it can require <em>framework</em> by <code>child_process.fork</code> and calls <em>startCluster</em> function.</li>\n<li><code>[parent process]</code>: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the <code>framework</code> is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as <code>--framework { your path }</code></li>\n</ul>\n<p><strong>Pseudo Code</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-scripts</span></span><br><span class=\"line\"><span class=\"comment\">// parent process</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> spawn = <span class=\"built_in\">require</span>(<span class=\"string\">'child_process'</span>).spawn <span class=\"comment\">// create new process</span></span><br><span class=\"line\">spawn(<span class=\"string\">'node'</span>, <span class=\"string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, options))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// egg-bin</span></span><br><span class=\"line\"><span class=\"comment\">// parent process</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> cp = <span class=\"built_in\">require</span>(<span class=\"string\">'child_process'</span>)</span><br><span class=\"line\">cp.fork(<span class=\"string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, args, options) <span class=\"comment\">// create new process</span></span><br></pre></td></tr></table></figure>\n<p>Egg-scripts uses <code>spawn</code> function to require framework while egg-scripts calls <code>fork</code> function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.</p>\n<p>We have two processes. In general, this newly created process is called the master process.</p>\n<p><strong>Why is the master process called birdge?</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg index.js</span></span><br><span class=\"line\">exports.startCluster = <span class=\"built_in\">require</span>(<span class=\"string\">'egg-cluster'</span>).startCluster</span><br></pre></td></tr></table></figure>\n<p>Actually, we exec <code>egg-cluster</code>s startCluster function when we require the framework. We open <code>index.js</code> file in the egg-cluster lib. </p>\n<p><strong>First, it is real enter point for whole web app.</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// index.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> Master = <span class=\"built_in\">require</span>(<span class=\"string\">'./lib/master'</span>)</span><br><span class=\"line\">exports.startCluster = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ./lib/master.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> ready = <span class=\"built_in\">require</span>(<span class=\"string\">'get-ready'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> detectPort = <span class=\"built_in\">require</span>(<span class=\"string\">'detect-port'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Manager = <span class=\"built_in\">require</span>(<span class=\"string\">'./utils/manager'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Messenger = <span class=\"built_in\">require</span>(<span class=\"string\">'./utils/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">super</span>()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.options = parseOptions(options)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.workerManager = <span class=\"keyword\">new</span> Manager()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messenger = <span class=\"keyword\">new</span> Messenger(<span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    ready.mixin(<span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.ready(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.isStarted = <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> action = <span class=\"string\">'egg-ready'</span></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(&#123;</span><br><span class=\"line\">        action,</span><br><span class=\"line\">        to: <span class=\"string\">'parent'</span>,</span><br><span class=\"line\">        data: &#123; <span class=\"attr\">port</span>: <span class=\"keyword\">this</span>[REALPORT], <span class=\"attr\">address</span>: <span class=\"keyword\">this</span>[APP_ADDRESS] &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(&#123; action, <span class=\"attr\">to</span>: <span class=\"string\">'app'</span>, <span class=\"attr\">data</span>: <span class=\"keyword\">this</span>.options &#125;)</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(&#123; action, <span class=\"attr\">to</span>: <span class=\"string\">'agent'</span>, <span class=\"attr\">data</span>: <span class=\"keyword\">this</span>.options &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// start check agent and worker status</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isProduction) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.workerManager.startCheck()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// fork app workers after agent started</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.once(<span class=\"string\">'agent-start'</span>, <span class=\"keyword\">this</span>.forkAppWorkers.bind(<span class=\"keyword\">this</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    detectPort(<span class=\"function\">(<span class=\"params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* istanbul ignore if */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">        err.name = <span class=\"string\">'ClusterPortConflictError'</span></span><br><span class=\"line\">        err.message = <span class=\"string\">'[master] try get free port error, '</span> + err.message</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.logger.error(err)</span><br><span class=\"line\">        process.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.options.clusterPort = port</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.forkAgentWorker()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAppWorkers() &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    cluster.on(<span class=\"string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">      worker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">        msg.from = <span class=\"string\">'app'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAgentWorker() &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    agentWorker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">      msg.from = <span class=\"string\">'agent'</span>;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// the callback of ready function will be trigger after all major boots had been loaded</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// forkAgentWorker</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> agent = <span class=\"keyword\">new</span> Agent(options)</span><br><span class=\"line\">agent.ready(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (err) <span class=\"keyword\">return</span></span><br><span class=\"line\">  process.send(&#123; <span class=\"attr\">action</span>: <span class=\"string\">'agent-start'</span>, <span class=\"attr\">to</span>: <span class=\"string\">'master'</span> &#125;)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// fork a single worker</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> Application(options);</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">startServer</span>(<span class=\"params\">err</span>) </span>&#123;  </span><br><span class=\"line\">  <span class=\"keyword\">let</span> server;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (options.https) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> httpsOptions = <span class=\"built_in\">Object</span>.assign(&#123;&#125;, options.https, &#123;</span><br><span class=\"line\">      key: fs.readFileSync(options.https.key),</span><br><span class=\"line\">      cert: fs.readFileSync(options.https.cert),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    server = <span class=\"built_in\">require</span>(<span class=\"string\">'https'</span>).createServer(httpsOptions, app.callback());</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    server = <span class=\"built_in\">require</span>(<span class=\"string\">'http'</span>).createServer(app.callback());</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// emit `server` event in app</span></span><br><span class=\"line\">  app.emit(<span class=\"string\">'server'</span>, server);</span><br><span class=\"line\">  </span><br><span class=\"line\">  server.listen(...args);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">app.ready(startServer);</span><br></pre></td></tr></table></figure>\n<p>On the other hand, this web will be constructed during creating a <code>Master</code> object.</p>\n<ul>\n<li>workerManager: it will hold on all worker porcesses.</li>\n<li>messenger: we make <code>master</code> a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an <a href=\"[http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works-IPC\">article(Chinese)</a>) about it.</li>\n</ul>\n<blockquote>\n<ul>\n<li>The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)</li>\n<li>EggApplication maintain the other Messenge instance egg/lib/core/messenger.js</li>\n<li>Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master</li>\n</ul>\n</blockquote>\n<ul>\n<li><p>ready.mixin &amp; this.ready: get-ready often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.</p>\n</li>\n<li><p>detectPort: apply for an available port, default is 7001.If Successly, it will <code>fork</code> an agent process and register a callback message for new created an agent object.</p>\n</li>\n<li><p><code>[agent process]</code>: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.</p>\n<ul>\n<li><p>loadPlugin: find all plugin, record their dir paths =&gt; this.dirs</p>\n</li>\n<li><p>loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.</p>\n</li>\n<li>loadAgentExtend: load and merge all of the extending of agent object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadContextExtend: load and merge all of the extending of context object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.<a href=\"https://eggjs.org/en/basics/app-start.html\" target=\"_blank\" rel=\"noopener\">Application Startup Configuration(official)</a>. It help you for better writing a few plugins.</li>\n<li>Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending <code>&#39;agent-start&#39;</code> to the master process.</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"/images/egg-boot/egg-boot.jpg\" alt=\"egg boot process\"></p>\n<ul>\n<li><p><code>[master process]</code>: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get <code>&#39;agent-start&#39;</code> message from the agent process. It will open a new relatable load, we take a single worker process example.</p>\n</li>\n<li><p><code>[a single worker process]</code>: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.</p>\n<ul>\n<li><p>loadPlugin: same as the agent</p>\n</li>\n<li><p>loadConfig: same as the agent</p>\n</li>\n<li><p>loadApplicationExtend: same as the agent  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadRequestExtend: load and merge all of the extending of request object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadResponseExtend: load and merge all of the extending of response object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadContextExtend: same as the agent</p>\n</li>\n<li><p>loadHelperExtend: load and merge all of the extending of helper object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadCustomApp: same as the agent <em>app &gt; plugin</em></p>\n</li>\n<li><p>loadService: load and merge all of the extending of helper object <em>app &gt; plugin</em></p>\n</li>\n<li><p>loadMiddleware: load middlewares and iterate them =&gt; mw, if it conforms the middleware standard, it will be used with app.use(mw) <em>app &gt; plugin &gt; core</em></p>\n</li>\n<li><p>loadController: iterate all controllers functions =&gt; key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only <em>app</em>). This middleware will be triggered when getting a new request, the Controller is defined in the <code>app/controller</code> directory and the key is its function.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">methodToMiddleware</span>(<span class=\"params\">Controller, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">classControllerMiddleware</span>(<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> controller = <span class=\"keyword\">new</span> Controller(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.app.config.controller || !<span class=\"keyword\">this</span>.app.config.controller.supportParams) &#123;</span><br><span class=\"line\">      args = [ <span class=\"keyword\">this</span> ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> utils.callFn(controller[key], args, controller);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>loadRouter: it makes requests path associated with the controllers function that has been become to middleware (only <em>app</em>)</p>\n</li>\n<li><p>loadCustomLoader: load ourselves function to create some built-in objects for app object or other.<a href=\"https://eggjs.org/en/advanced/loader.html#customloader\" target=\"_blank\" rel=\"noopener\">Customloader</a></p>\n</li>\n</ul>\n<ul>\n<li><code>[master process]</code>: it listens to all worker processes and triggers the masters ready once they have finished booting.</li>\n<li>send <code>egg-ready</code> to the parent process, the agent process, the app worker processes</li>\n<li>Last, traverse BOOTS and run serverDidReady function of each item.</li>\n</ul>\n<p>It is the whole boot for Eggjs framework but doesnt include, such as restarting a worker process when it exits or disconnects,  shuting down</p>\n<p><strong>Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.</strong></p>\n<p><strong>What happens when web app get an Http request?</strong></p>\n<p><em>We only discuss Eggjs code in the applaction layer. :)</em></p>\n<p>The <code>agent</code> cant deal with any request because it doesnt listen port. All request always hand over to <code>workers</code>. We look at creating worker code, it will run a app.callback function and listen port when it has booted.</p>\n<p>This callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controllers function.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// koa/lib/application</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title\">Emitter</span> </span>&#123;</span><br><span class=\"line\">  callback() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> fn = compose(<span class=\"keyword\">this</span>.middleware);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.listenerCount(<span class=\"string\">'error'</span>)) <span class=\"keyword\">this</span>.on(<span class=\"string\">'error'</span>, <span class=\"keyword\">this</span>.onerror);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> handleRequest = <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> ctx = <span class=\"keyword\">this</span>.createContext(req, res);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.handleRequest(ctx, fn);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> handleRequest;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  handleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> res = ctx.res;</span><br><span class=\"line\">    res.statusCode = <span class=\"number\">404</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> onerror = <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> ctx.onerror(err);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> handleResponse = <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> respond(ctx);</span><br><span class=\"line\">    onFinished(res, onerror);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> fnMiddleware(ctx).then(handleResponse).catch(onerror);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// egg/lib/application</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">\thandleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.emit(<span class=\"string\">'request'</span>, ctx)</span><br><span class=\"line\">    <span class=\"keyword\">super</span>.handleRequest(ctx, fnMiddleware)</span><br><span class=\"line\">    onFinished(ctx.res, () =&gt; <span class=\"keyword\">this</span>.emit(<span class=\"string\">'response'</span>, ctx))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>In summary, we have know how to boot web app and deal with request in Eggjs.</strong> When we know it, we can easily write some plugins and middlewares to finish the business requirements.</p>"},{"title":"Set A Flag","date":"2019-06-19T05:30:00.000Z","_content":"##### Practice speaking and listening, pass the BEC exam.\n\n\n![book1](/images/bec/1.jpeg)\n![book2](/images/bec/2.jpeg)\n","source":"_posts/bec.md","raw":"---\ntitle: Set A Flag\ncategory: work\ndate: 2019-06-19T13:30:00.000Z\n---\n##### Practice speaking and listening, pass the BEC exam.\n\n\n![book1](/images/bec/1.jpeg)\n![book2](/images/bec/2.jpeg)\n","slug":"bec","published":1,"updated":"2020-07-07T10:11:25.585Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs5d0001d12i4s9mkjdx","content":"<h5 id=\"Practice-speaking-and-listening-pass-the-BEC-exam\"><a href=\"#Practice-speaking-and-listening-pass-the-BEC-exam\" class=\"headerlink\" title=\"Practice speaking and listening, pass the BEC exam.\"></a>Practice speaking and listening, pass the BEC exam.</h5><p><img src=\"/images/bec/1.jpeg\" alt=\"book1\"><br><img src=\"/images/bec/2.jpeg\" alt=\"book2\"></p>\n","site":{"data":{}},"_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"","more":"<h5 id=\"Practice-speaking-and-listening-pass-the-BEC-exam\"><a href=\"#Practice-speaking-and-listening-pass-the-BEC-exam\" class=\"headerlink\" title=\"Practice speaking and listening, pass the BEC exam.\"></a>Practice speaking and listening, pass the BEC exam.</h5><p><img src=\"/images/bec/1.jpeg\" alt=\"book1\"><br><img src=\"/images/bec/2.jpeg\" alt=\"book2\"></p>\n"},{"title":"Express Gateway","keywords":"Express,Gateway,Node.js ","description":"BFFNode.jsExpress GatewayExpress","date":"2020-01-22T07:32:03.586Z","_content":"\nBFFNode.js2\n\n- [Express Gateway](https://www.express-gateway.io/)\n- [Moleculer](https://moleculer.services/)\n\nLua [Kong](https://konghq.com/)Java Zuul2JavascriptNode.js\n\n**Express Gateway**Express\n\n<!-- more -->\n\n<br/>\n\n## \n\n### **Endpoints**\n\nURL2\n\n- API endpoints\n- Service endpoints\n\nAPI endpointsService endpoints\n\n\n\n### **Policies**\n\npolicyExpress MiddlewareAPI\n\n\n\n### **Pipelines**\n\npipelineAPI endpointspoliciesAPIAPI endpointservice endpoint\n\n\n\n<br/>\n\n\n\n## \n\n[Installation](https://www.express-gateway.io/getting-started/)CLI\n\n```javascript\nnpm install -g express-gateway\n\neg gateway create\n\ncd `Dir Path` && npm start\n```\n\n**2**\n\n- system.config.ymlsession\n- gateway.config.yml\n\n http://localhost:8080/ip  https://httpbin.org/ip JSON\n\n```json\n{\n  \"origin\": \"180.167.xxx.xxx\"\n}\n```\n\nproxy`round-robin``static`IPURLIP\n\n\n\n## \n\n[express-gateway-example](https://github.com/miser/express-gateway-example)\n\n- JWT\n- 2`account``banner`\n  - account: ID\n  - banner: 2banner\n\nexpress-gateway-exampleeg(express-gateway)expressgateway2accountbannerJWT`secret-files`\n\n```c\nopenssl genrsa -out private.pem 512\nopenssl rsa -in private.pem -outform PEM -pubout -out public.pem\n\n```\n\n****\n\n```yaml\n// gateway.config.yml\nhttp:\n  port: 8080\n# admin:\n#   port: 9876\n#   host: localhost\napiEndpoints:\n  login:\n    host: localhost\n    paths: '/account/login'\n  account:\n    host: localhost\n    paths: '/account/*'\n  banner:\n    host: localhost\n    paths: '/banner/*'\nserviceEndpoints:\n  accountSrv:\n    url: 'http://localhost:3001'\n  bannerSrv:\n    url: 'http://localhost:3002'\npolicies:\n  - jwt\n  - proxy\npipelines:\n  login:\n    apiEndpoints:\n      - login\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv \n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n\n```\n\n**3apiEndpoints**\n\n- loginpath _/account/login_\n- accountpath _/account/*_\n- bannerpath _/banner/*_\n\n**2serviceEndpoints**\n\n- accountSrv`account`3001\n- bannerSrv`banner`3002\n\n**pipelines**\n\n- loginbanner2apiEndpoints\n- accountapiEndpointsJWTactionURL querytoken\n\n****\n\n`npm start`Postman GEThttp://localhost:8080/account/profile 401token401pipelinesaccountGET http://localhost:8080/banner/ JWT\n\n```\n{\"code\":200,\"message\":\"success\",\"data\":[\"/images/1.png\",\"/images/2.png\"]}\n```\n\n**token**\n\nPOST http://localhost:8080/account/login ,JWT\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"token\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"\n}\n```\n\ntokenURL queryprofileID\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": {\n        \"id\": \"2020\"\n    }\n}\n```\n\nGateway**``**\n\n<br/>\n\n## \n\n\n\n- [Conditions](https://www.express-gateway.io/docs/policies/customization/conditions/)\n\n- [Policies](https://www.express-gateway.io/docs/policies/)\n\ngateway`plugins``policies``conditions` `manifest.js``policies/index.js``conditions/index.js`\n\n```javascript\n// manifest.js\nmodule.exports = {\n  version: '0.0.1',\n  init: function (pluginContext) {\n    const policy = require('./policies/index.js');\n    pluginContext.registerPolicy(policy);\n\n    const condition = require('./conditions/index.js');\n    pluginContext.registerCondition(condition);\n  }\n}\n```\n\nregisterPolicyregisterCondition`system.config.yml`\n\n```yaml\n// system.config.yml\nplugins:\n  example:\n    package: './plugins/manifest.js'\n```\n\n\n\n**Conditions **\n\n\n\n> ##### `function (req, conditionConfig) => true/false` Handler\n>\n> - Executes on each request in current pipeline. If not matched will prevent policy from being fired\n\napiEndpointspipelinesloginaccountSrvloginurlJWTConditiongateway.config.yml\n\n```yaml\n// gateway.config.yml\napiEndpoints:\n  # login:\n  #   host: localhost\n  #   paths: '/account/login'\n  \n# ...\n\npipelines:\n  # login:\n  #   apiEndpoints:\n  #     - login\n  #   policies:\n  #     - proxy:\n  #         - action:\n  #             serviceEndpoint: accountSrv \n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - \n            condition:\n              name: 'white-list'\n              list: ['/account/login']\n            action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n```\n\njwtcondition`conditions/index.js`URL Path \n\n```javascript\nmodule.exports = {\n  name: 'white-list',\n  schema: {\n    $id: 'white-list',\n  },\n  handler: conditionConfig => req => {\n    return conditionConfig.list.indexOf(req.url) < 0;\n  }\n};\n```\n\nCondition\n\n\n\n**Policies **\n\n\n\nbannerv2banner`/banner/v2/list``/banner`v2URL\n\n```yaml\npipelines:\n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - rewrite:\n          - action:\n              search: '/banner'\n              replace: '/banner/v1/list'\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n```\n\n`policies/index.js`\n\n```javascript\nmodule.exports = {\n  name: 'rewrite',\n  schema: {\n    $id: 'rewrite',\n  },\n  policy: (actionParams) => {\n    return (req, res, next) => {\n      req.url = req.url.replace(actionParams.search, actionParams.replace);\n      next()\n    };\n  }\n};\n```\n\nGET http://localhost:8080/banner/ v2\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": [\n        \"/images/v2_1.png\"\n    ]\n}\n```\n\nURL\n\n\n\n<br/>\n\n<br/>\n\n\n\n## \n\nExpress-GatewayBFFGraphQLJavaScript","source":"_posts/express-gateway.md","raw":"---\ntitle: Express Gateway\ncategory: JavaScript\nkeywords: Express,Gateway,Node.js \ndescription: BFFNode.jsExpress GatewayExpress\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-01-22T15:32:03.586Z\n---\n\nBFFNode.js2\n\n- [Express Gateway](https://www.express-gateway.io/)\n- [Moleculer](https://moleculer.services/)\n\nLua [Kong](https://konghq.com/)Java Zuul2JavascriptNode.js\n\n**Express Gateway**Express\n\n<!-- more -->\n\n<br/>\n\n## \n\n### **Endpoints**\n\nURL2\n\n- API endpoints\n- Service endpoints\n\nAPI endpointsService endpoints\n\n\n\n### **Policies**\n\npolicyExpress MiddlewareAPI\n\n\n\n### **Pipelines**\n\npipelineAPI endpointspoliciesAPIAPI endpointservice endpoint\n\n\n\n<br/>\n\n\n\n## \n\n[Installation](https://www.express-gateway.io/getting-started/)CLI\n\n```javascript\nnpm install -g express-gateway\n\neg gateway create\n\ncd `Dir Path` && npm start\n```\n\n**2**\n\n- system.config.ymlsession\n- gateway.config.yml\n\n http://localhost:8080/ip  https://httpbin.org/ip JSON\n\n```json\n{\n  \"origin\": \"180.167.xxx.xxx\"\n}\n```\n\nproxy`round-robin``static`IPURLIP\n\n\n\n## \n\n[express-gateway-example](https://github.com/miser/express-gateway-example)\n\n- JWT\n- 2`account``banner`\n  - account: ID\n  - banner: 2banner\n\nexpress-gateway-exampleeg(express-gateway)expressgateway2accountbannerJWT`secret-files`\n\n```c\nopenssl genrsa -out private.pem 512\nopenssl rsa -in private.pem -outform PEM -pubout -out public.pem\n\n```\n\n****\n\n```yaml\n// gateway.config.yml\nhttp:\n  port: 8080\n# admin:\n#   port: 9876\n#   host: localhost\napiEndpoints:\n  login:\n    host: localhost\n    paths: '/account/login'\n  account:\n    host: localhost\n    paths: '/account/*'\n  banner:\n    host: localhost\n    paths: '/banner/*'\nserviceEndpoints:\n  accountSrv:\n    url: 'http://localhost:3001'\n  bannerSrv:\n    url: 'http://localhost:3002'\npolicies:\n  - jwt\n  - proxy\npipelines:\n  login:\n    apiEndpoints:\n      - login\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv \n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n\n```\n\n**3apiEndpoints**\n\n- loginpath _/account/login_\n- accountpath _/account/*_\n- bannerpath _/banner/*_\n\n**2serviceEndpoints**\n\n- accountSrv`account`3001\n- bannerSrv`banner`3002\n\n**pipelines**\n\n- loginbanner2apiEndpoints\n- accountapiEndpointsJWTactionURL querytoken\n\n****\n\n`npm start`Postman GEThttp://localhost:8080/account/profile 401token401pipelinesaccountGET http://localhost:8080/banner/ JWT\n\n```\n{\"code\":200,\"message\":\"success\",\"data\":[\"/images/1.png\",\"/images/2.png\"]}\n```\n\n**token**\n\nPOST http://localhost:8080/account/login ,JWT\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"token\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"\n}\n```\n\ntokenURL queryprofileID\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": {\n        \"id\": \"2020\"\n    }\n}\n```\n\nGateway**``**\n\n<br/>\n\n## \n\n\n\n- [Conditions](https://www.express-gateway.io/docs/policies/customization/conditions/)\n\n- [Policies](https://www.express-gateway.io/docs/policies/)\n\ngateway`plugins``policies``conditions` `manifest.js``policies/index.js``conditions/index.js`\n\n```javascript\n// manifest.js\nmodule.exports = {\n  version: '0.0.1',\n  init: function (pluginContext) {\n    const policy = require('./policies/index.js');\n    pluginContext.registerPolicy(policy);\n\n    const condition = require('./conditions/index.js');\n    pluginContext.registerCondition(condition);\n  }\n}\n```\n\nregisterPolicyregisterCondition`system.config.yml`\n\n```yaml\n// system.config.yml\nplugins:\n  example:\n    package: './plugins/manifest.js'\n```\n\n\n\n**Conditions **\n\n\n\n> ##### `function (req, conditionConfig) => true/false` Handler\n>\n> - Executes on each request in current pipeline. If not matched will prevent policy from being fired\n\napiEndpointspipelinesloginaccountSrvloginurlJWTConditiongateway.config.yml\n\n```yaml\n// gateway.config.yml\napiEndpoints:\n  # login:\n  #   host: localhost\n  #   paths: '/account/login'\n  \n# ...\n\npipelines:\n  # login:\n  #   apiEndpoints:\n  #     - login\n  #   policies:\n  #     - proxy:\n  #         - action:\n  #             serviceEndpoint: accountSrv \n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - \n            condition:\n              name: 'white-list'\n              list: ['/account/login']\n            action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n```\n\njwtcondition`conditions/index.js`URL Path \n\n```javascript\nmodule.exports = {\n  name: 'white-list',\n  schema: {\n    $id: 'white-list',\n  },\n  handler: conditionConfig => req => {\n    return conditionConfig.list.indexOf(req.url) < 0;\n  }\n};\n```\n\nCondition\n\n\n\n**Policies **\n\n\n\nbannerv2banner`/banner/v2/list``/banner`v2URL\n\n```yaml\npipelines:\n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - rewrite:\n          - action:\n              search: '/banner'\n              replace: '/banner/v1/list'\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n```\n\n`policies/index.js`\n\n```javascript\nmodule.exports = {\n  name: 'rewrite',\n  schema: {\n    $id: 'rewrite',\n  },\n  policy: (actionParams) => {\n    return (req, res, next) => {\n      req.url = req.url.replace(actionParams.search, actionParams.replace);\n      next()\n    };\n  }\n};\n```\n\nGET http://localhost:8080/banner/ v2\n\n```json\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": [\n        \"/images/v2_1.png\"\n    ]\n}\n```\n\nURL\n\n\n\n<br/>\n\n<br/>\n\n\n\n## \n\nExpress-GatewayBFFGraphQLJavaScript","slug":"express-gateway","published":1,"updated":"2020-07-07T10:11:25.587Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs5k0004d12ir6oazsoe","content":"<p>BFFNode.js2</p>\n<ul>\n<li><a href=\"https://www.express-gateway.io/\" target=\"_blank\" rel=\"noopener\">Express Gateway</a></li>\n<li><a href=\"https://moleculer.services/\" target=\"_blank\" rel=\"noopener\">Moleculer</a></li>\n</ul>\n<p>Lua <a href=\"https://konghq.com/\" target=\"_blank\" rel=\"noopener\">Kong</a>Java Zuul2JavascriptNode.js</p>\n<p><strong>Express Gateway</strong>Express</p>\n<a id=\"more\"></a>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"Endpoints\"><a href=\"#Endpoints\" class=\"headerlink\" title=\"Endpoints\"></a><strong>Endpoints</strong></h3><p>URL2</p>\n<ul>\n<li>API endpoints</li>\n<li>Service endpoints</li>\n</ul>\n<p>API endpointsService endpoints</p>\n<h3 id=\"Policies\"><a href=\"#Policies\" class=\"headerlink\" title=\"Policies\"></a><strong>Policies</strong></h3><p>policyExpress MiddlewareAPI</p>\n<h3 id=\"Pipelines\"><a href=\"#Pipelines\" class=\"headerlink\" title=\"Pipelines\"></a><strong>Pipelines</strong></h3><p>pipelineAPI endpointspoliciesAPIAPI endpointservice endpoint</p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://www.express-gateway.io/getting-started/\" target=\"_blank\" rel=\"noopener\">Installation</a>CLI</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g express-gateway</span><br><span class=\"line\"></span><br><span class=\"line\">eg gateway create</span><br><span class=\"line\"></span><br><span class=\"line\">cd <span class=\"hljs-string\">`Dir Path`</span> &amp;&amp; npm start</span><br></pre></td></tr></table></figure>\n<p><strong>2</strong></p>\n<ul>\n<li>system.config.ymlsession</li>\n<li>gateway.config.yml</li>\n</ul>\n<p> <a href=\"http://localhost:8080/ip\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/ip</a>  <a href=\"https://httpbin.org/ip\" target=\"_blank\" rel=\"noopener\">https://httpbin.org/ip</a> JSON</p>\n<figure class=\"highlight json hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"origin\"</span>: <span class=\"hljs-string\">\"180.167.xxx.xxx\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>proxy<code>round-robin</code><code>static</code>IPURLIP</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://github.com/miser/express-gateway-example\" target=\"_blank\" rel=\"noopener\">express-gateway-example</a></p>\n<ul>\n<li>JWT</li>\n<li>2<code>account</code><code>banner</code><ul>\n<li>account: ID</li>\n<li>banner: 2banner</li>\n</ul>\n</li>\n</ul>\n<p>express-gateway-exampleeg(express-gateway)expressgateway2accountbannerJWT<code>secret-files</code></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl genrsa -out <span class=\"hljs-keyword\">private</span>.pem <span class=\"hljs-number\">512</span></span><br><span class=\"line\">openssl rsa -in <span class=\"hljs-keyword\">private</span>.pem -outform PEM -pubout -out <span class=\"hljs-keyword\">public</span>.pem</span><br></pre></td></tr></table></figure>\n<p><strong></strong></p>\n<figure class=\"highlight yaml hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"hljs-attr\">http:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  port:</span> <span class=\"hljs-number\">8080</span></span><br><span class=\"line\"><span class=\"hljs-comment\"># admin:</span></span><br><span class=\"line\"><span class=\"hljs-comment\">#   port: 9876</span></span><br><span class=\"line\"><span class=\"hljs-comment\">#   host: localhost</span></span><br><span class=\"line\"><span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  login:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    host:</span> <span class=\"hljs-string\">localhost</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    paths:</span> <span class=\"hljs-string\">'/account/login'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  account:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    host:</span> <span class=\"hljs-string\">localhost</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    paths:</span> <span class=\"hljs-string\">'/account/*'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  banner:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    host:</span> <span class=\"hljs-string\">localhost</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    paths:</span> <span class=\"hljs-string\">'/banner/*'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">serviceEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  accountSrv:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    url:</span> <span class=\"hljs-string\">'http://localhost:3001'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  bannerSrv:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    url:</span> <span class=\"hljs-string\">'http://localhost:3002'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">policies:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">  -</span> <span class=\"hljs-string\">jwt</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">  -</span> <span class=\"hljs-string\">proxy</span></span><br><span class=\"line\"><span class=\"hljs-attr\">pipelines:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  login:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> <span class=\"hljs-string\">login</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    policies:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              serviceEndpoint:</span> <span class=\"hljs-string\">accountSrv</span> </span><br><span class=\"line\"><span class=\"hljs-attr\">  banner:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> <span class=\"hljs-string\">banner</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    policies:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              serviceEndpoint:</span> <span class=\"hljs-string\">bannerSrv</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  account:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> <span class=\"hljs-string\">account</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    policies:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - jwt:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              jwtExtractor:</span> <span class=\"hljs-string\">'query'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              jwtExtractorField:</span> <span class=\"hljs-string\">'token'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              checkCredentialExistence:</span> <span class=\"hljs-literal\">false</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              secretOrPublicKeyFile:</span> <span class=\"hljs-string\">'../secret-files/public.pem'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              serviceEndpoint:</span> <span class=\"hljs-string\">accountSrv</span></span><br></pre></td></tr></table></figure>\n<p><strong>3apiEndpoints</strong></p>\n<ul>\n<li>loginpath <em>/account/login</em></li>\n<li>accountpath <em>/account/*</em></li>\n<li>bannerpath <em>/banner/*</em></li>\n</ul>\n<p><strong>2serviceEndpoints</strong></p>\n<ul>\n<li>accountSrv<code>account</code>3001</li>\n<li>bannerSrv<code>banner</code>3002</li>\n</ul>\n<p><strong>pipelines</strong></p>\n<ul>\n<li>loginbanner2apiEndpoints</li>\n<li>accountapiEndpointsJWTactionURL querytoken</li>\n</ul>\n<p><strong></strong></p>\n<p><code>npm start</code>Postman GET<a href=\"http://localhost:8080/account/profile\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/account/profile</a> 401token401pipelinesaccountGET <a href=\"http://localhost:8080/banner/\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/banner/</a> JWT</p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;code&quot;:200,&quot;message&quot;:&quot;success&quot;,&quot;data&quot;:[&quot;/images/1.png&quot;,&quot;/images/2.png&quot;]&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>token</strong></p>\n<p>POST <a href=\"http://localhost:8080/account/login\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/account/login</a> ,JWT</p>\n<figure class=\"highlight json hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"code\"</span>: <span class=\"hljs-number\">200</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"message\"</span>: <span class=\"hljs-string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"token\"</span>: <span class=\"hljs-string\">\"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>tokenURL queryprofileID</p>\n<figure class=\"highlight json hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"code\"</span>: <span class=\"hljs-number\">200</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"message\"</span>: <span class=\"hljs-string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"data\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"hljs-attr\">\"id\"</span>: <span class=\"hljs-string\">\"2020\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Gateway<strong><code></code></strong></p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<ul>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/customization/conditions/\" target=\"_blank\" rel=\"noopener\">Conditions</a></p>\n</li>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/\" target=\"_blank\" rel=\"noopener\">Policies</a></p>\n</li>\n</ul>\n<p>gateway<code>plugins</code><code>policies</code><code>conditions</code> <code>manifest.js</code><code>policies/index.js</code><code>conditions/index.js</code></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// manifest.js</span></span><br><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  version: <span class=\"hljs-string\">'0.0.1'</span>,</span><br><span class=\"line\">  init: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">pluginContext</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> policy = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./policies/index.js'</span>);</span><br><span class=\"line\">    pluginContext.registerPolicy(policy);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> condition = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./conditions/index.js'</span>);</span><br><span class=\"line\">    pluginContext.registerCondition(condition);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>registerPolicyregisterCondition<code>system.config.yml</code></p>\n<figure class=\"highlight yaml hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">system.config.yml</span></span><br><span class=\"line\"><span class=\"hljs-attr\">plugins:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  example:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    package:</span> <span class=\"hljs-string\">'./plugins/manifest.js'</span></span><br></pre></td></tr></table></figure>\n<p><strong>Conditions </strong></p>\n<p></p>\n<blockquote>\n<h5 id=\"function-req-conditionConfig-gt-true-false-Handler\"><a href=\"#function-req-conditionConfig-gt-true-false-Handler\" class=\"headerlink\" title=\"function (req, conditionConfig) =&gt; true/false Handler\"></a><code>function (req, conditionConfig) =&gt; true/false</code> Handler</h5><ul>\n<li>Executes on each request in current pipeline. If not matched will prevent policy from being fired</li>\n</ul>\n</blockquote>\n<p>apiEndpointspipelinesloginaccountSrvloginurlJWTConditiongateway.config.yml</p>\n<figure class=\"highlight yaml hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\"># login:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   host: localhost</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   paths: '/account/login'</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"hljs-comment\"># ...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-attr\">pipelines:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\"># login:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#     - login</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   policies:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#     - proxy:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#         - action:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#             serviceEndpoint: accountSrv </span></span><br><span class=\"line\"><span class=\"hljs-attr\">  account:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> <span class=\"hljs-string\">account</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    policies:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - jwt:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">          -</span> </span><br><span class=\"line\"><span class=\"hljs-attr\">            condition:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              name:</span> <span class=\"hljs-string\">'white-list'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              list:</span> <span class=\"hljs-string\">['/account/login']</span></span><br><span class=\"line\"><span class=\"hljs-attr\">            action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              jwtExtractor:</span> <span class=\"hljs-string\">'query'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              jwtExtractorField:</span> <span class=\"hljs-string\">'token'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              checkCredentialExistence:</span> <span class=\"hljs-literal\">false</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              secretOrPublicKeyFile:</span> <span class=\"hljs-string\">'../secret-files/public.pem'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              serviceEndpoint:</span> <span class=\"hljs-string\">accountSrv</span></span><br></pre></td></tr></table></figure>\n<p>jwtcondition<code>conditions/index.js</code>URL Path </p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  name: <span class=\"hljs-string\">'white-list'</span>,</span><br><span class=\"line\">  schema: &#123;</span><br><span class=\"line\">    $id: <span class=\"hljs-string\">'white-list'</span>,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  handler: <span class=\"hljs-function\"><span class=\"hljs-params\">conditionConfig</span> =&gt;</span> req =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> conditionConfig.list.indexOf(req.url) &lt; <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>Condition</p>\n<p><strong>Policies </strong></p>\n<p></p>\n<p>bannerv2banner<code>/banner/v2/list</code><code>/banner</code>v2URL</p>\n<figure class=\"highlight yaml hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-attr\">pipelines:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  banner:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> <span class=\"hljs-string\">banner</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    policies:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - rewrite:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              search:</span> <span class=\"hljs-string\">'/banner'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              replace:</span> <span class=\"hljs-string\">'/banner/v1/list'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">          - action:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">              serviceEndpoint:</span> <span class=\"hljs-string\">bannerSrv</span></span><br></pre></td></tr></table></figure>\n<p><code>policies/index.js</code></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  name: <span class=\"hljs-string\">'rewrite'</span>,</span><br><span class=\"line\">  schema: &#123;</span><br><span class=\"line\">    $id: <span class=\"hljs-string\">'rewrite'</span>,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  policy: <span class=\"hljs-function\">(<span class=\"hljs-params\">actionParams</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-function\">(<span class=\"hljs-params\">req, res, next</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      req.url = req.url.replace(actionParams.search, actionParams.replace);</span><br><span class=\"line\">      next()</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>GET <a href=\"http://localhost:8080/banner/\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/banner/</a> v2</p>\n<figure class=\"highlight json hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"code\"</span>: <span class=\"hljs-number\">200</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"message\"</span>: <span class=\"hljs-string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"data\"</span>: [</span><br><span class=\"line\">        <span class=\"hljs-string\">\"/images/v2_1.png\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>URL</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Express-GatewayBFFGraphQLJavaScript</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p>BFFNode.js2</p>\n<ul>\n<li><a href=\"https://www.express-gateway.io/\" target=\"_blank\" rel=\"noopener\">Express Gateway</a></li>\n<li><a href=\"https://moleculer.services/\" target=\"_blank\" rel=\"noopener\">Moleculer</a></li>\n</ul>\n<p>Lua <a href=\"https://konghq.com/\" target=\"_blank\" rel=\"noopener\">Kong</a>Java Zuul2JavascriptNode.js</p>\n<p><strong>Express Gateway</strong>Express</p>","more":"<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"Endpoints\"><a href=\"#Endpoints\" class=\"headerlink\" title=\"Endpoints\"></a><strong>Endpoints</strong></h3><p>URL2</p>\n<ul>\n<li>API endpoints</li>\n<li>Service endpoints</li>\n</ul>\n<p>API endpointsService endpoints</p>\n<h3 id=\"Policies\"><a href=\"#Policies\" class=\"headerlink\" title=\"Policies\"></a><strong>Policies</strong></h3><p>policyExpress MiddlewareAPI</p>\n<h3 id=\"Pipelines\"><a href=\"#Pipelines\" class=\"headerlink\" title=\"Pipelines\"></a><strong>Pipelines</strong></h3><p>pipelineAPI endpointspoliciesAPIAPI endpointservice endpoint</p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://www.express-gateway.io/getting-started/\" target=\"_blank\" rel=\"noopener\">Installation</a>CLI</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g express-gateway</span><br><span class=\"line\"></span><br><span class=\"line\">eg gateway create</span><br><span class=\"line\"></span><br><span class=\"line\">cd <span class=\"string\">`Dir Path`</span> &amp;&amp; npm start</span><br></pre></td></tr></table></figure>\n<p><strong>2</strong></p>\n<ul>\n<li>system.config.ymlsession</li>\n<li>gateway.config.yml</li>\n</ul>\n<p> <a href=\"http://localhost:8080/ip\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/ip</a>  <a href=\"https://httpbin.org/ip\" target=\"_blank\" rel=\"noopener\">https://httpbin.org/ip</a> JSON</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"origin\"</span>: <span class=\"string\">\"180.167.xxx.xxx\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>proxy<code>round-robin</code><code>static</code>IPURLIP</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://github.com/miser/express-gateway-example\" target=\"_blank\" rel=\"noopener\">express-gateway-example</a></p>\n<ul>\n<li>JWT</li>\n<li>2<code>account</code><code>banner</code><ul>\n<li>account: ID</li>\n<li>banner: 2banner</li>\n</ul>\n</li>\n</ul>\n<p>express-gateway-exampleeg(express-gateway)expressgateway2accountbannerJWT<code>secret-files</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl genrsa -out <span class=\"keyword\">private</span>.pem <span class=\"number\">512</span></span><br><span class=\"line\">openssl rsa -in <span class=\"keyword\">private</span>.pem -outform PEM -pubout -out <span class=\"keyword\">public</span>.pem</span><br></pre></td></tr></table></figure>\n<p><strong></strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"attr\">http:</span></span><br><span class=\"line\"><span class=\"attr\">  port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"comment\"># admin:</span></span><br><span class=\"line\"><span class=\"comment\">#   port: 9876</span></span><br><span class=\"line\"><span class=\"comment\">#   host: localhost</span></span><br><span class=\"line\"><span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\"><span class=\"attr\">  login:</span></span><br><span class=\"line\"><span class=\"attr\">    host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\"><span class=\"attr\">    paths:</span> <span class=\"string\">'/account/login'</span></span><br><span class=\"line\"><span class=\"attr\">  account:</span></span><br><span class=\"line\"><span class=\"attr\">    host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\"><span class=\"attr\">    paths:</span> <span class=\"string\">'/account/*'</span></span><br><span class=\"line\"><span class=\"attr\">  banner:</span></span><br><span class=\"line\"><span class=\"attr\">    host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\"><span class=\"attr\">    paths:</span> <span class=\"string\">'/banner/*'</span></span><br><span class=\"line\"><span class=\"attr\">serviceEndpoints:</span></span><br><span class=\"line\"><span class=\"attr\">  accountSrv:</span></span><br><span class=\"line\"><span class=\"attr\">    url:</span> <span class=\"string\">'http://localhost:3001'</span></span><br><span class=\"line\"><span class=\"attr\">  bannerSrv:</span></span><br><span class=\"line\"><span class=\"attr\">    url:</span> <span class=\"string\">'http://localhost:3002'</span></span><br><span class=\"line\"><span class=\"attr\">policies:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">jwt</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">proxy</span></span><br><span class=\"line\"><span class=\"attr\">pipelines:</span></span><br><span class=\"line\"><span class=\"attr\">  login:</span></span><br><span class=\"line\"><span class=\"attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">login</span></span><br><span class=\"line\"><span class=\"attr\">    policies:</span></span><br><span class=\"line\"><span class=\"attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceEndpoint:</span> <span class=\"string\">accountSrv</span> </span><br><span class=\"line\"><span class=\"attr\">  banner:</span></span><br><span class=\"line\"><span class=\"attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">banner</span></span><br><span class=\"line\"><span class=\"attr\">    policies:</span></span><br><span class=\"line\"><span class=\"attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceEndpoint:</span> <span class=\"string\">bannerSrv</span></span><br><span class=\"line\"><span class=\"attr\">  account:</span></span><br><span class=\"line\"><span class=\"attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">account</span></span><br><span class=\"line\"><span class=\"attr\">    policies:</span></span><br><span class=\"line\"><span class=\"attr\">      - jwt:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              jwtExtractor:</span> <span class=\"string\">'query'</span></span><br><span class=\"line\"><span class=\"attr\">              jwtExtractorField:</span> <span class=\"string\">'token'</span></span><br><span class=\"line\"><span class=\"attr\">              checkCredentialExistence:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">              secretOrPublicKeyFile:</span> <span class=\"string\">'../secret-files/public.pem'</span></span><br><span class=\"line\"><span class=\"attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceEndpoint:</span> <span class=\"string\">accountSrv</span></span><br></pre></td></tr></table></figure>\n<p><strong>3apiEndpoints</strong></p>\n<ul>\n<li>loginpath <em>/account/login</em></li>\n<li>accountpath <em>/account/*</em></li>\n<li>bannerpath <em>/banner/*</em></li>\n</ul>\n<p><strong>2serviceEndpoints</strong></p>\n<ul>\n<li>accountSrv<code>account</code>3001</li>\n<li>bannerSrv<code>banner</code>3002</li>\n</ul>\n<p><strong>pipelines</strong></p>\n<ul>\n<li>loginbanner2apiEndpoints</li>\n<li>accountapiEndpointsJWTactionURL querytoken</li>\n</ul>\n<p><strong></strong></p>\n<p><code>npm start</code>Postman GET<a href=\"http://localhost:8080/account/profile\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/account/profile</a> 401token401pipelinesaccountGET <a href=\"http://localhost:8080/banner/\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/banner/</a> JWT</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;code&quot;:200,&quot;message&quot;:&quot;success&quot;,&quot;data&quot;:[&quot;/images/1.png&quot;,&quot;/images/2.png&quot;]&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>token</strong></p>\n<p>POST <a href=\"http://localhost:8080/account/login\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/account/login</a> ,JWT</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"code\"</span>: <span class=\"number\">200</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"message\"</span>: <span class=\"string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"token\"</span>: <span class=\"string\">\"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>tokenURL queryprofileID</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"code\"</span>: <span class=\"number\">200</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"message\"</span>: <span class=\"string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"data\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"2020\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Gateway<strong><code></code></strong></p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<ul>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/customization/conditions/\" target=\"_blank\" rel=\"noopener\">Conditions</a></p>\n</li>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/\" target=\"_blank\" rel=\"noopener\">Policies</a></p>\n</li>\n</ul>\n<p>gateway<code>plugins</code><code>policies</code><code>conditions</code> <code>manifest.js</code><code>policies/index.js</code><code>conditions/index.js</code></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// manifest.js</span></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  version: <span class=\"string\">'0.0.1'</span>,</span><br><span class=\"line\">  init: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">pluginContext</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> policy = <span class=\"built_in\">require</span>(<span class=\"string\">'./policies/index.js'</span>);</span><br><span class=\"line\">    pluginContext.registerPolicy(policy);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> condition = <span class=\"built_in\">require</span>(<span class=\"string\">'./conditions/index.js'</span>);</span><br><span class=\"line\">    pluginContext.registerCondition(condition);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>registerPolicyregisterCondition<code>system.config.yml</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">system.config.yml</span></span><br><span class=\"line\"><span class=\"attr\">plugins:</span></span><br><span class=\"line\"><span class=\"attr\">  example:</span></span><br><span class=\"line\"><span class=\"attr\">    package:</span> <span class=\"string\">'./plugins/manifest.js'</span></span><br></pre></td></tr></table></figure>\n<p><strong>Conditions </strong></p>\n<p></p>\n<blockquote>\n<h5 id=\"function-req-conditionConfig-gt-true-false-Handler\"><a href=\"#function-req-conditionConfig-gt-true-false-Handler\" class=\"headerlink\" title=\"function (req, conditionConfig) =&gt; true/false Handler\"></a><code>function (req, conditionConfig) =&gt; true/false</code> Handler</h5><ul>\n<li>Executes on each request in current pipeline. If not matched will prevent policy from being fired</li>\n</ul>\n</blockquote>\n<p>apiEndpointspipelinesloginaccountSrvloginurlJWTConditiongateway.config.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"comment\"># login:</span></span><br><span class=\"line\">  <span class=\"comment\">#   host: localhost</span></span><br><span class=\"line\">  <span class=\"comment\">#   paths: '/account/login'</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># ...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">pipelines:</span></span><br><span class=\"line\">  <span class=\"comment\"># login:</span></span><br><span class=\"line\">  <span class=\"comment\">#   apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"comment\">#     - login</span></span><br><span class=\"line\">  <span class=\"comment\">#   policies:</span></span><br><span class=\"line\">  <span class=\"comment\">#     - proxy:</span></span><br><span class=\"line\">  <span class=\"comment\">#         - action:</span></span><br><span class=\"line\">  <span class=\"comment\">#             serviceEndpoint: accountSrv </span></span><br><span class=\"line\"><span class=\"attr\">  account:</span></span><br><span class=\"line\"><span class=\"attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">account</span></span><br><span class=\"line\"><span class=\"attr\">    policies:</span></span><br><span class=\"line\"><span class=\"attr\">      - jwt:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> </span><br><span class=\"line\"><span class=\"attr\">            condition:</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">'white-list'</span></span><br><span class=\"line\"><span class=\"attr\">              list:</span> <span class=\"string\">['/account/login']</span></span><br><span class=\"line\"><span class=\"attr\">            action:</span></span><br><span class=\"line\"><span class=\"attr\">              jwtExtractor:</span> <span class=\"string\">'query'</span></span><br><span class=\"line\"><span class=\"attr\">              jwtExtractorField:</span> <span class=\"string\">'token'</span></span><br><span class=\"line\"><span class=\"attr\">              checkCredentialExistence:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">              secretOrPublicKeyFile:</span> <span class=\"string\">'../secret-files/public.pem'</span></span><br><span class=\"line\"><span class=\"attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceEndpoint:</span> <span class=\"string\">accountSrv</span></span><br></pre></td></tr></table></figure>\n<p>jwtcondition<code>conditions/index.js</code>URL Path </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  name: <span class=\"string\">'white-list'</span>,</span><br><span class=\"line\">  schema: &#123;</span><br><span class=\"line\">    $id: <span class=\"string\">'white-list'</span>,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  handler: <span class=\"function\"><span class=\"params\">conditionConfig</span> =&gt;</span> req =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> conditionConfig.list.indexOf(req.url) &lt; <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>Condition</p>\n<p><strong>Policies </strong></p>\n<p></p>\n<p>bannerv2banner<code>/banner/v2/list</code><code>/banner</code>v2URL</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">pipelines:</span></span><br><span class=\"line\"><span class=\"attr\">  banner:</span></span><br><span class=\"line\"><span class=\"attr\">    apiEndpoints:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">banner</span></span><br><span class=\"line\"><span class=\"attr\">    policies:</span></span><br><span class=\"line\"><span class=\"attr\">      - rewrite:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              search:</span> <span class=\"string\">'/banner'</span></span><br><span class=\"line\"><span class=\"attr\">              replace:</span> <span class=\"string\">'/banner/v1/list'</span></span><br><span class=\"line\"><span class=\"attr\">      - proxy:</span></span><br><span class=\"line\"><span class=\"attr\">          - action:</span></span><br><span class=\"line\"><span class=\"attr\">              serviceEndpoint:</span> <span class=\"string\">bannerSrv</span></span><br></pre></td></tr></table></figure>\n<p><code>policies/index.js</code></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  name: <span class=\"string\">'rewrite'</span>,</span><br><span class=\"line\">  schema: &#123;</span><br><span class=\"line\">    $id: <span class=\"string\">'rewrite'</span>,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  policy: <span class=\"function\">(<span class=\"params\">actionParams</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\">(<span class=\"params\">req, res, next</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      req.url = req.url.replace(actionParams.search, actionParams.replace);</span><br><span class=\"line\">      next()</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>GET <a href=\"http://localhost:8080/banner/\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/banner/</a> v2</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"code\"</span>: <span class=\"number\">200</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"message\"</span>: <span class=\"string\">\"success\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"data\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"/images/v2_1.png\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>URL</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Express-GatewayBFFGraphQLJavaScript</p>"},{"title":"","date":"2018-10-23T02:29:29.089Z","_content":"\n#### \n\n\n\n#### \n\n1.window.onerrorjsPromiseasync/await \n\n2.Promise __catch__\n\n3.async/await  __try - catch__\n\n4.VueVue.config.errorHandlerPromiseasync/awaitVuewindow.onerror\n\n<!-- more -->\n\n####  chrome & https://jsbin.com\n\n##### [window.onerror](https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror)\n\n```js\nwindow.onerror = function(message, source, lineno, colno, error) {\n    /*\n    messageHTML onerror=\"\"event\n    sourceURL\n    lineno\n    colno\n    errorError\n    */\n}\n```\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nlet data\nlet info = data.info\n\n/* console \n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 6,\n  3: 17,\n  4: [object Error] { ... }\n}\n*/\n```\n\n__onerror__PromisePromisesetTimeoutjs\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction timer () {\n  setTimeout(function () {\n     let data\n     let info = data.info\n  }, 100)\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n     timer()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n  })\n}\n\np().then(function() {\n  console.log('running then')\n})\n.catch(function(error){\n  console.log(error)\n  console.log('outer error')\n})\n\n/* console \n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 8,\n  3: 22,\n  4: [object Error] { ... }\n}\n*/\n```\n\n\n\n##### [Promise catch](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)\n\n##### QcatchPromise\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n  console.log('onerror')\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log('running then')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console \n*/\n```\n\nPromise__try - catch____onerror__\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log(res)\n    console.log('running then')\n  }).catch(function(error){\n    console.log(error)\n    console.log('outer error')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console \n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n\"running then\"\n*/\n```\n\nthenPromise__catch__\n\n##### [async/await](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function)  __try - catch__\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  let res = await p()\n  console.log(res)\n})()\n\n/* console \n*/\n```\n\nPromise__onerror__\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    resolve('resolve')\n  })\n}\n(async function () {\n  let res = await p()\n  console.log('get res')\n  errorFn()\n})()\n\n/* console \nget res\n*/\n```\n\nPromise__onerror__\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console \n[object Error] { ... }\n\"try - catch\"\n*/\n```\n\n__try - catch__\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console \n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n*/\n```\n\nPromisecatch async/await  __try - catch__\n\n##### [Vue.config.errorHandler](https://cn.vuejs.org/v2/api/index.html#errorHandler)\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  // handle error\n  // `info`  Vue \n  //  2.2.0+ \n}\n```\n\n>  Vue \n\nerrorHandler vue-clivue\n\nhttps://github.com/miser/vue-capture-error\n\nmain.js\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  console.log(arguments)\n  console.log('vue errorHandler')\n}\n```\n\nApp.vue\n\n```js\n{\n  // ...\n  created () {\n    this.normal()\n  },\n  methods: {\n    normal () {\n      let data\n      let info = data.info\n    }\n  }\n  // ...  \n}\n\n/*  console \n0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal \n1: VueComponent {_uid: 1, _isVue: true, $options: {}, _renderProxy: Proxy, _self: VueComponent, }\n2: \"created hook\n*/\n```\n\nerrorHandlererrorHandlerwindow.onerrorPromseasync/await\n\njs [axios](https://github.com/axios/axios) ajaxPromise\n\nmain.js\n\n```js\nconst request = axios.create()\nrequest.interceptors.response.use(response => {\n  return response\n})\n\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      reject(err)\n    })\n  })\n}\n```\n\nApp.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch1()\n  },\n  methods: {\n    fetch1 () {\n        Vue.request('https://api1.github.com/')\n\t      .then(response => {\n            console.log(response)\n          })\n    }\n  }\n  // ...  \n}\n```\n\napi.github.com  githubapiapi1.github.comerrorHandlerVue.requestcatchPromise.then\n\nApp.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n      .then(response => {\n        let data = response.data\n        let info = data.api.info\n      })\n    }\n  }\n  // ...  \n}\n```\n\nerrorHandlervueissuePromiseasync/await:\n\n> https://github.com/vuejs/vue/issues/6551\n>\n> Vue cannot capture errors that are thrown asynchronously, similar to how try... catch won't catch async errors. It's your responsibility to handle async errors properly, e.g. using Promise.catch   @yyx990803\n\nPromise.catch\n\n> https://github.com/vuejs/vue/issues/7653\n>\n> @Doeke mixinPromisePromisePromisecatchPromise\n\nmain.js@Doeke\n\n```js\nVue.mixin({\n  beforeCreate: function () {\n    const methods = this.$options.methods || {}\n    Object.entries(methods).forEach(([key, method]) => {\n      if (method._asyncWrapped) return\n      const wrappedMethod = function (...args) {\n        const result = method.apply(this, args)\n        const resultIsPromise = result && typeof result.then === 'function'\n        if (!resultIsPromise) return result\n\n        return new Promise(async (resolve, reject) => {\n          try {\n            resolve(await result)\n          } catch (error) {\n            if (!error._handled) {\n              const errorHandler = Vue.config.errorHandler\n              errorHandler(error)\n              error._handled = true\n            }\n            reject(error)\n          }\n        })\n      }\n      wrappedMethod._asyncWrapped = true\n      methods[key] = wrappedMethod\n    })\n  }\n})\n```\n\nApp.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n    this.fetch3()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch2\n        })\n    },\n    fetch3 () {\n      return Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch3\n        })\n    }\n  }\n  // ...  \n}\n```\n\nconsolefetch3errorHandlerfetch2\n\nPromiseasync/await\n\nApp.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch4()\n    this.fetch5()\n  },\n  methods: {\n    async fetch4 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch4\n    },\n    async fetch5 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch5\n      return response\n    }\n  }\n  // ...  \n}\n```\n\nfetch4Promisefetch5Promisefetch4fetch5async/awaitPromise [babeljs](https://babeljs.io)  Try it out\"  async/awaitPromise\n\n#### \n\n____axios.create\n\n____PromiseerrorHandlerPromisemixinPromisecatcherrorHandler__*!*__\n\n#### \n\n__#  __\n\n\n\n__#  [Sentry](https://sentry.io/)  __\n\nJS SDK\n\n```\nnpm install raven-js --save\n```\n\nmain.js\n\n```js\n// ...\nimport Raven from 'raven-js'\nimport RavenVue from 'raven-js/plugins/vue'\n\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044') // sentry token\n  .addPlugin(RavenVue, Vue)\n  .install()\n\nVue.config.errorHandler = function (err, vm, info) {\n  Raven.captureException(err)\n}\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      Raven.captureException(err)\n      reject(err)\n    })\n  })\n}\n// ...\n```\n\nApp.vue js\n```js\n// ...\ncreated () {\n    this.normal()\n    // this.fetch1()\n    // this.fetch2()\n    // this.fetch3()\n    // this.fetch4()\n    // this.fetch5()\n}\n// ...\n```\n\nsentry\n![](/images/js-capture-error/1.png)\n![IP](/images/js-capture-error/2.jpg)\n2sentryissue\n\nfetch1ajax\n![api1.github.com](/images/js-capture-error/3.jpg)\n\nfetch2PromisePromiseasync/awaitPromise.then2\n\n![Promise.then](/images/js-capture-error/4.jpg)\n![async/await](/images/js-capture-error/5.jpg)\n\n\n\n```js\nRaven.setUser({\n    name: 'miser name',\n    id: 'miser id'\n  })\n```\n![](/images/js-capture-error/6.jpg)\n\n____\n\n![npm run build ](/images/js-capture-error/7.jpg)\n\nsentry[SourceMaps](https://github.com/google/closure-compiler/wiki/Source-Maps)debug\n\n[webpack-sentry-plugin](https://www.npmjs.com/package/webpack-sentry-plugin)webpackvue3vue.config.js\n\n```js\nconst SentryPlugin = require('webpack-sentry-plugin')\n\nmodule.exports = {\n  configureWebpack: {\n    plugins: [\n      new SentryPlugin({\n        organization: 'fe-org', //  \n        project: 'popcorn-vue', //  \n        apiKey: '17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150',\n        release: '1.2.4-beta' // sourcemaps\n      })\n    ]\n  }\n}\n\n```\nmain.js\n```js\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044', {\n    release: '1.2.4-beta' // \n  })\n  .addPlugin(RavenVue, Vue)\n  .install()\n```\n\n```\nnpm run build\n```\n\nsentrypopcorn-vue____\n\n![1.2.4-beta1.2.3-beta](/images/js-capture-error/8.jpg)\n![ 1.2.4-beta jsjs.map](/images/js-capture-error/9.jpg)\n\n\nbuildindex.htmlSourceMapsjsjs.map\n\nissue https://github.com/getsentry/sentry-electron/issues/54 2\n\n-- js.mapjs\n-- jsjs.map\n\n2\n\nindex.htmlfile:///******/vue-capture-error/dist/index.htmlnginx\n```\nbrew install nginx\nnginx\n```\n\nbuilddistnginx /usr/local/var/www/http://localhost:8080\n\nsentry\n\n![](/images/js-capture-error/10.jpg)\n\n","source":"_posts/js-capture-error.md","raw":"---\ntitle: \ncategory: JavaScript\ndate: 2018-10-23T10:29:29.089Z\n---\n\n#### \n\n\n\n#### \n\n1.window.onerrorjsPromiseasync/await \n\n2.Promise __catch__\n\n3.async/await  __try - catch__\n\n4.VueVue.config.errorHandlerPromiseasync/awaitVuewindow.onerror\n\n<!-- more -->\n\n####  chrome & https://jsbin.com\n\n##### [window.onerror](https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror)\n\n```js\nwindow.onerror = function(message, source, lineno, colno, error) {\n    /*\n    messageHTML onerror=\"\"event\n    sourceURL\n    lineno\n    colno\n    errorError\n    */\n}\n```\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nlet data\nlet info = data.info\n\n/* console \n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 6,\n  3: 17,\n  4: [object Error] { ... }\n}\n*/\n```\n\n__onerror__PromisePromisesetTimeoutjs\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction timer () {\n  setTimeout(function () {\n     let data\n     let info = data.info\n  }, 100)\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n     timer()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n  })\n}\n\np().then(function() {\n  console.log('running then')\n})\n.catch(function(error){\n  console.log(error)\n  console.log('outer error')\n})\n\n/* console \n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 8,\n  3: 22,\n  4: [object Error] { ... }\n}\n*/\n```\n\n\n\n##### [Promise catch](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)\n\n##### QcatchPromise\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n  console.log('onerror')\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log('running then')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console \n*/\n```\n\nPromise__try - catch____onerror__\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log(res)\n    console.log('running then')\n  }).catch(function(error){\n    console.log(error)\n    console.log('outer error')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console \n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n\"running then\"\n*/\n```\n\nthenPromise__catch__\n\n##### [async/await](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function)  __try - catch__\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  let res = await p()\n  console.log(res)\n})()\n\n/* console \n*/\n```\n\nPromise__onerror__\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    resolve('resolve')\n  })\n}\n(async function () {\n  let res = await p()\n  console.log('get res')\n  errorFn()\n})()\n\n/* console \nget res\n*/\n```\n\nPromise__onerror__\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console \n[object Error] { ... }\n\"try - catch\"\n*/\n```\n\n__try - catch__\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console \n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n*/\n```\n\nPromisecatch async/await  __try - catch__\n\n##### [Vue.config.errorHandler](https://cn.vuejs.org/v2/api/index.html#errorHandler)\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  // handle error\n  // `info`  Vue \n  //  2.2.0+ \n}\n```\n\n>  Vue \n\nerrorHandler vue-clivue\n\nhttps://github.com/miser/vue-capture-error\n\nmain.js\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  console.log(arguments)\n  console.log('vue errorHandler')\n}\n```\n\nApp.vue\n\n```js\n{\n  // ...\n  created () {\n    this.normal()\n  },\n  methods: {\n    normal () {\n      let data\n      let info = data.info\n    }\n  }\n  // ...  \n}\n\n/*  console \n0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal \n1: VueComponent {_uid: 1, _isVue: true, $options: {}, _renderProxy: Proxy, _self: VueComponent, }\n2: \"created hook\n*/\n```\n\nerrorHandlererrorHandlerwindow.onerrorPromseasync/await\n\njs [axios](https://github.com/axios/axios) ajaxPromise\n\nmain.js\n\n```js\nconst request = axios.create()\nrequest.interceptors.response.use(response => {\n  return response\n})\n\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      reject(err)\n    })\n  })\n}\n```\n\nApp.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch1()\n  },\n  methods: {\n    fetch1 () {\n        Vue.request('https://api1.github.com/')\n\t      .then(response => {\n            console.log(response)\n          })\n    }\n  }\n  // ...  \n}\n```\n\napi.github.com  githubapiapi1.github.comerrorHandlerVue.requestcatchPromise.then\n\nApp.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n      .then(response => {\n        let data = response.data\n        let info = data.api.info\n      })\n    }\n  }\n  // ...  \n}\n```\n\nerrorHandlervueissuePromiseasync/await:\n\n> https://github.com/vuejs/vue/issues/6551\n>\n> Vue cannot capture errors that are thrown asynchronously, similar to how try... catch won't catch async errors. It's your responsibility to handle async errors properly, e.g. using Promise.catch   @yyx990803\n\nPromise.catch\n\n> https://github.com/vuejs/vue/issues/7653\n>\n> @Doeke mixinPromisePromisePromisecatchPromise\n\nmain.js@Doeke\n\n```js\nVue.mixin({\n  beforeCreate: function () {\n    const methods = this.$options.methods || {}\n    Object.entries(methods).forEach(([key, method]) => {\n      if (method._asyncWrapped) return\n      const wrappedMethod = function (...args) {\n        const result = method.apply(this, args)\n        const resultIsPromise = result && typeof result.then === 'function'\n        if (!resultIsPromise) return result\n\n        return new Promise(async (resolve, reject) => {\n          try {\n            resolve(await result)\n          } catch (error) {\n            if (!error._handled) {\n              const errorHandler = Vue.config.errorHandler\n              errorHandler(error)\n              error._handled = true\n            }\n            reject(error)\n          }\n        })\n      }\n      wrappedMethod._asyncWrapped = true\n      methods[key] = wrappedMethod\n    })\n  }\n})\n```\n\nApp.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n    this.fetch3()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch2\n        })\n    },\n    fetch3 () {\n      return Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch3\n        })\n    }\n  }\n  // ...  \n}\n```\n\nconsolefetch3errorHandlerfetch2\n\nPromiseasync/await\n\nApp.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch4()\n    this.fetch5()\n  },\n  methods: {\n    async fetch4 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch4\n    },\n    async fetch5 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch5\n      return response\n    }\n  }\n  // ...  \n}\n```\n\nfetch4Promisefetch5Promisefetch4fetch5async/awaitPromise [babeljs](https://babeljs.io)  Try it out\"  async/awaitPromise\n\n#### \n\n____axios.create\n\n____PromiseerrorHandlerPromisemixinPromisecatcherrorHandler__*!*__\n\n#### \n\n__#  __\n\n\n\n__#  [Sentry](https://sentry.io/)  __\n\nJS SDK\n\n```\nnpm install raven-js --save\n```\n\nmain.js\n\n```js\n// ...\nimport Raven from 'raven-js'\nimport RavenVue from 'raven-js/plugins/vue'\n\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044') // sentry token\n  .addPlugin(RavenVue, Vue)\n  .install()\n\nVue.config.errorHandler = function (err, vm, info) {\n  Raven.captureException(err)\n}\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      Raven.captureException(err)\n      reject(err)\n    })\n  })\n}\n// ...\n```\n\nApp.vue js\n```js\n// ...\ncreated () {\n    this.normal()\n    // this.fetch1()\n    // this.fetch2()\n    // this.fetch3()\n    // this.fetch4()\n    // this.fetch5()\n}\n// ...\n```\n\nsentry\n![](/images/js-capture-error/1.png)\n![IP](/images/js-capture-error/2.jpg)\n2sentryissue\n\nfetch1ajax\n![api1.github.com](/images/js-capture-error/3.jpg)\n\nfetch2PromisePromiseasync/awaitPromise.then2\n\n![Promise.then](/images/js-capture-error/4.jpg)\n![async/await](/images/js-capture-error/5.jpg)\n\n\n\n```js\nRaven.setUser({\n    name: 'miser name',\n    id: 'miser id'\n  })\n```\n![](/images/js-capture-error/6.jpg)\n\n____\n\n![npm run build ](/images/js-capture-error/7.jpg)\n\nsentry[SourceMaps](https://github.com/google/closure-compiler/wiki/Source-Maps)debug\n\n[webpack-sentry-plugin](https://www.npmjs.com/package/webpack-sentry-plugin)webpackvue3vue.config.js\n\n```js\nconst SentryPlugin = require('webpack-sentry-plugin')\n\nmodule.exports = {\n  configureWebpack: {\n    plugins: [\n      new SentryPlugin({\n        organization: 'fe-org', //  \n        project: 'popcorn-vue', //  \n        apiKey: '17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150',\n        release: '1.2.4-beta' // sourcemaps\n      })\n    ]\n  }\n}\n\n```\nmain.js\n```js\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044', {\n    release: '1.2.4-beta' // \n  })\n  .addPlugin(RavenVue, Vue)\n  .install()\n```\n\n```\nnpm run build\n```\n\nsentrypopcorn-vue____\n\n![1.2.4-beta1.2.3-beta](/images/js-capture-error/8.jpg)\n![ 1.2.4-beta jsjs.map](/images/js-capture-error/9.jpg)\n\n\nbuildindex.htmlSourceMapsjsjs.map\n\nissue https://github.com/getsentry/sentry-electron/issues/54 2\n\n-- js.mapjs\n-- jsjs.map\n\n2\n\nindex.htmlfile:///******/vue-capture-error/dist/index.htmlnginx\n```\nbrew install nginx\nnginx\n```\n\nbuilddistnginx /usr/local/var/www/http://localhost:8080\n\nsentry\n\n![](/images/js-capture-error/10.jpg)\n\n","slug":"js-capture-error","published":1,"updated":"2020-07-07T10:11:25.587Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs5q0006d12ims95wvqz","content":"<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>1.window.onerrorjsPromiseasync/await </p>\n<p>2.Promise <strong>catch</strong></p>\n<p>3.async/await  <strong>try - catch</strong></p>\n<p>4.VueVue.config.errorHandlerPromiseasync/awaitVuewindow.onerror</p>\n<a id=\"more\"></a>\n<h4 id=\"-chrome-amp-https-jsbin-com\"><a href=\"#-chrome-amp-https-jsbin-com\" class=\"headerlink\" title=\" chrome &amp; https://jsbin.com\"></a> chrome &amp; <a href=\"https://jsbin.com\" target=\"_blank\" rel=\"noopener\">https://jsbin.com</a></h4><h5 id=\"window-onerror\"><a href=\"#window-onerror\" class=\"headerlink\" title=\"window.onerror\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror\" target=\"_blank\" rel=\"noopener\">window.onerror</a></h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">message, source, lineno, colno, error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">/*</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    messageHTML onerror=\"\"event</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    sourceURL</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    lineno</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    colno</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    errorError</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    */</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  2: 6,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  3: 17,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><strong>onerror</strong>PromisePromisesetTimeoutjs</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">timer</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">     <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">     <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">100</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">     timer()</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'inner error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">p().then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'running then'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">.catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">error</span>)</span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'outer error'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  2: 8,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  3: 22,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"Promise-catch\"><a href=\"#Promise-catch\" class=\"headerlink\" title=\"Promise catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch\" target=\"_blank\" rel=\"noopener\">Promise catch</a></h5><h5 id=\"QcatchPromise\"><a href=\"#QcatchPromise\" class=\"headerlink\" title=\"QcatchPromise\"></a>QcatchPromise</h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'onerror'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'running then'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>Promise<strong>try - catch</strong><strong>onerror</strong></p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'running then'</span>)</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">error</span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'outer error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"running then\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>thenPromise<strong>catch</strong></p>\n<h5 id=\"async-await--try-catch\"><a href=\"#async-await--try-catch\" class=\"headerlink\" title=\"async/await  try - catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function\" target=\"_blank\" rel=\"noopener\">async/await</a>  <strong>try - catch</strong></h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>Promise<strong>onerror</strong></p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    resolve(<span class=\"hljs-string\">'resolve'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'get res'</span>)</span><br><span class=\"line\">  errorFn()</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">get res</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>Promise<strong>onerror</strong></p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"try - catch\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><strong>try - catch</strong></p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>Promisecatch async/await  <strong>try - catch</strong></p>\n<h5 id=\"Vue-config-errorHandler\"><a href=\"#Vue-config-errorHandler\" class=\"headerlink\" title=\"Vue.config.errorHandler\"></a><a href=\"https://cn.vuejs.org/v2/api/index.html#errorHandler\" target=\"_blank\" rel=\"noopener\">Vue.config.errorHandler</a></h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// handle error</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// `info`  Vue </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  2.2.0+ </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p> Vue </p>\n</blockquote>\n<p>errorHandler vue-clivue</p>\n<p><a href=\"https://github.com/miser/vue-capture-error\" target=\"_blank\" rel=\"noopener\">https://github.com/miser/vue-capture-error</a></p>\n<p>main.js</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'vue errorHandler'</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.normal()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    normal () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/*  console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal </span></span><br><span class=\"line\"><span class=\"hljs-comment\">1: VueComponent &#123;_uid: 1, _isVue: true, $options: &#123;&#125;, _renderProxy: Proxy, _self: VueComponent, &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">2: \"created hook</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>errorHandlererrorHandlerwindow.onerrorPromseasync/await</p>\n<p>js <a href=\"https://github.com/axios/axios\" target=\"_blank\" rel=\"noopener\">axios</a> ajaxPromise</p>\n<p>main.js</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> request = axios.create()</span><br><span class=\"line\">request.interceptors.response.use(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> response</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.request = <span class=\"hljs-function\">(<span class=\"hljs-params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"hljs-function\"><span class=\"hljs-params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch1()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch1 () &#123;</span><br><span class=\"line\">        Vue.request(<span class=\"hljs-string\">'https://api1.github.com/'</span>)</span><br><span class=\"line\">\t      .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"hljs-built_in\">console</span>.log(response)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>api.github.com  githubapiapi1.github.comerrorHandlerVue.requestcatchPromise.then</p>\n<p>App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch2()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> info = data.api.info</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>errorHandlervueissuePromiseasync/await:</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/6551\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/6551</a></p>\n<p>Vue cannot capture errors that are thrown asynchronously, similar to how try catch wont catch async errors. Its your responsibility to handle async errors properly, e.g. using Promise.catch   @yyx990803</p>\n</blockquote>\n<p>Promise.catch</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/7653\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/7653</a></p>\n<p>@Doeke mixinPromisePromisePromisecatchPromise</p>\n</blockquote>\n<p>main.js@Doeke</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.mixin(&#123;</span><br><span class=\"line\">  beforeCreate: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> methods = <span class=\"hljs-keyword\">this</span>.$options.methods || &#123;&#125;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">Object</span>.entries(methods).forEach(<span class=\"hljs-function\">(<span class=\"hljs-params\">[key, method]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (method._asyncWrapped) <span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> wrappedMethod = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">...args</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> result = method.apply(<span class=\"hljs-keyword\">this</span>, args)</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> resultIsPromise = result &amp;&amp; <span class=\"hljs-keyword\">typeof</span> result.then === <span class=\"hljs-string\">'function'</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (!resultIsPromise) <span class=\"hljs-keyword\">return</span> result</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-keyword\">async</span> (resolve, reject) =&gt; &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">            resolve(<span class=\"hljs-keyword\">await</span> result)</span><br><span class=\"line\">          &#125; <span class=\"hljs-keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span> (!error._handled) &#123;</span><br><span class=\"line\">              <span class=\"hljs-keyword\">const</span> errorHandler = Vue.config.errorHandler</span><br><span class=\"line\">              errorHandler(error)</span><br><span class=\"line\">              error._handled = <span class=\"hljs-literal\">true</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            reject(error)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      wrappedMethod._asyncWrapped = <span class=\"hljs-literal\">true</span></span><br><span class=\"line\">      methods[key] = wrappedMethod</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch2()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch3()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> info = data.api.fetch2</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    fetch3 () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> info = data.api.fetch3</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>consolefetch3errorHandlerfetch2</p>\n<p>Promiseasync/await</p>\n<p>App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch4()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch5()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> fetch4 () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> response = <span class=\"hljs-keyword\">await</span> Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.api.fetch4</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> fetch5 () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> response = <span class=\"hljs-keyword\">await</span> Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.api.fetch5</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> response</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>fetch4Promisefetch5Promisefetch4fetch5async/awaitPromise <a href=\"https://babeljs.io\" target=\"_blank\" rel=\"noopener\">babeljs</a>  Try it out  async/awaitPromise</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong>axios.create</p>\n<p><strong></strong>PromiseerrorHandlerPromisemixinPromisecatcherrorHandler<strong><em>!</em></strong></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong>#  </strong></p>\n<p></p>\n<p><strong>#  <a href=\"https://sentry.io/\" target=\"_blank\" rel=\"noopener\">Sentry</a>  </strong></p>\n<p>JS SDK</p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install raven-js --save</span><br></pre></td></tr></table></figure>\n<p>main.js</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> Raven <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'raven-js'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> RavenVue <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'raven-js/plugins/vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"hljs-string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>) <span class=\"hljs-comment\">// sentry token</span></span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.errorHandler = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  Raven.captureException(err)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Vue.request = <span class=\"hljs-function\">(<span class=\"hljs-params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"hljs-function\"><span class=\"hljs-params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      Raven.captureException(err)</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<p>App.vue js<br><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.normal()</span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch1()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch2()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch3()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch4()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch5()</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></table></figure></p>\n<p>sentry<br><img src=\"/images/js-capture-error/1.png\" alt=\"\"><br><img src=\"/images/js-capture-error/2.jpg\" alt=\"IP\"><br>2sentryissue</p>\n<p>fetch1ajax<br><img src=\"/images/js-capture-error/3.jpg\" alt=\"api1.github.com\"></p>\n<p>fetch2PromisePromiseasync/awaitPromise.then2</p>\n<p><img src=\"/images/js-capture-error/4.jpg\" alt=\"Promise.then\"><br><img src=\"/images/js-capture-error/5.jpg\" alt=\"async/await\"></p>\n<p></p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven.setUser(&#123;</span><br><span class=\"line\">    name: <span class=\"hljs-string\">'miser name'</span>,</span><br><span class=\"line\">    id: <span class=\"hljs-string\">'miser id'</span></span><br><span class=\"line\">  &#125;)</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/js-capture-error/6.jpg\" alt=\"\"></p>\n<p><strong></strong></p>\n<p><img src=\"/images/js-capture-error/7.jpg\" alt=\"npm run build \"></p>\n<p>sentry<a href=\"https://github.com/google/closure-compiler/wiki/Source-Maps\" target=\"_blank\" rel=\"noopener\">SourceMaps</a>debug</p>\n<p><a href=\"https://www.npmjs.com/package/webpack-sentry-plugin\" target=\"_blank\" rel=\"noopener\">webpack-sentry-plugin</a>webpackvue3vue.config.js</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> SentryPlugin = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'webpack-sentry-plugin'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  configureWebpack: &#123;</span><br><span class=\"line\">    plugins: [</span><br><span class=\"line\">      <span class=\"hljs-keyword\">new</span> SentryPlugin(&#123;</span><br><span class=\"line\">        organization: <span class=\"hljs-string\">'fe-org'</span>, <span class=\"hljs-comment\">//  </span></span><br><span class=\"line\">        project: <span class=\"hljs-string\">'popcorn-vue'</span>, <span class=\"hljs-comment\">//  </span></span><br><span class=\"line\">        apiKey: <span class=\"hljs-string\">'17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150'</span>,</span><br><span class=\"line\">        release: <span class=\"hljs-string\">'1.2.4-beta'</span> <span class=\"hljs-comment\">// sourcemaps</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>main.js<br><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"hljs-string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>, &#123;</span><br><span class=\"line\">    release: <span class=\"hljs-string\">'1.2.4-beta'</span> <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run build</span><br></pre></td></tr></table></figure>\n<p>sentrypopcorn-vue<strong></strong></p>\n<p><img src=\"/images/js-capture-error/8.jpg\" alt=\"1.2.4-beta1.2.3-beta\"><br><img src=\"/images/js-capture-error/9.jpg\" alt=\" 1.2.4-beta jsjs.map\"></p>\n<p>buildindex.htmlSourceMapsjsjs.map</p>\n<p>issue <a href=\"https://github.com/getsentry/sentry-electron/issues/54\" target=\"_blank\" rel=\"noopener\">https://github.com/getsentry/sentry-electron/issues/54</a> 2</p>\n<p> js.mapjs<br> jsjs.map</p>\n<p>2</p>\n<p>index.htmlfile:///<strong>**</strong>/vue-capture-error/dist/index.htmlnginx<br><figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install nginx</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure></p>\n<p>builddistnginx /usr/local/var/www/<a href=\"http://localhost:8080\" target=\"_blank\" rel=\"noopener\">http://localhost:8080</a></p>\n<p>sentry</p>\n<p><img src=\"/images/js-capture-error/10.jpg\" alt=\"\"></p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[],"excerpt":"<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>1.window.onerrorjsPromiseasync/await </p>\n<p>2.Promise <strong>catch</strong></p>\n<p>3.async/await  <strong>try - catch</strong></p>\n<p>4.VueVue.config.errorHandlerPromiseasync/awaitVuewindow.onerror</p>","more":"<h4 id=\"-chrome-amp-https-jsbin-com\"><a href=\"#-chrome-amp-https-jsbin-com\" class=\"headerlink\" title=\" chrome &amp; https://jsbin.com\"></a> chrome &amp; <a href=\"https://jsbin.com\" target=\"_blank\" rel=\"noopener\">https://jsbin.com</a></h4><h5 id=\"window-onerror\"><a href=\"#window-onerror\" class=\"headerlink\" title=\"window.onerror\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror\" target=\"_blank\" rel=\"noopener\">window.onerror</a></h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">message, source, lineno, colno, error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    messageHTML onerror=\"\"event</span></span><br><span class=\"line\"><span class=\"comment\">    sourceURL</span></span><br><span class=\"line\"><span class=\"comment\">    lineno</span></span><br><span class=\"line\"><span class=\"comment\">    colno</span></span><br><span class=\"line\"><span class=\"comment\">    errorError</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> data</span><br><span class=\"line\"><span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"comment\">  2: 6,</span></span><br><span class=\"line\"><span class=\"comment\">  3: 17,</span></span><br><span class=\"line\"><span class=\"comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><strong>onerror</strong>PromisePromisesetTimeoutjs</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">timer</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">     <span class=\"keyword\">let</span> data</span><br><span class=\"line\">     <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">  &#125;, <span class=\"number\">100</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">     timer()</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'inner error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">p().then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'running then'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">.catch(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">error</span>)</span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'outer error'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"comment\">  2: 8,</span></span><br><span class=\"line\"><span class=\"comment\">  3: 22,</span></span><br><span class=\"line\"><span class=\"comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"Promise-catch\"><a href=\"#Promise-catch\" class=\"headerlink\" title=\"Promise catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch\" target=\"_blank\" rel=\"noopener\">Promise catch</a></h5><h5 id=\"QcatchPromise\"><a href=\"#QcatchPromise\" class=\"headerlink\" title=\"QcatchPromise\"></a>QcatchPromise</h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'onerror'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'running then'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>Promise<strong>try - catch</strong><strong>onerror</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'running then'</span>)</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">error</span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'outer error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">\"running then\"</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>thenPromise<strong>catch</strong></p>\n<h5 id=\"async-await--try-catch\"><a href=\"#async-await--try-catch\" class=\"headerlink\" title=\"async/await  try - catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function\" target=\"_blank\" rel=\"noopener\">async/await</a>  <strong>try - catch</strong></h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>Promise<strong>onerror</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    resolve(<span class=\"string\">'resolve'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'get res'</span>)</span><br><span class=\"line\">  errorFn()</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">get res</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>Promise<strong>onerror</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">\"try - catch\"</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><strong>try - catch</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>Promisecatch async/await  <strong>try - catch</strong></p>\n<h5 id=\"Vue-config-errorHandler\"><a href=\"#Vue-config-errorHandler\" class=\"headerlink\" title=\"Vue.config.errorHandler\"></a><a href=\"https://cn.vuejs.org/v2/api/index.html#errorHandler\" target=\"_blank\" rel=\"noopener\">Vue.config.errorHandler</a></h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// handle error</span></span><br><span class=\"line\">  <span class=\"comment\">// `info`  Vue </span></span><br><span class=\"line\">  <span class=\"comment\">//  2.2.0+ </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p> Vue </p>\n</blockquote>\n<p>errorHandler vue-clivue</p>\n<p><a href=\"https://github.com/miser/vue-capture-error\" target=\"_blank\" rel=\"noopener\">https://github.com/miser/vue-capture-error</a></p>\n<p>main.js</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'vue errorHandler'</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.normal()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    normal () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*  console </span></span><br><span class=\"line\"><span class=\"comment\">0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal </span></span><br><span class=\"line\"><span class=\"comment\">1: VueComponent &#123;_uid: 1, _isVue: true, $options: &#123;&#125;, _renderProxy: Proxy, _self: VueComponent, &#125;</span></span><br><span class=\"line\"><span class=\"comment\">2: \"created hook</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>errorHandlererrorHandlerwindow.onerrorPromseasync/await</p>\n<p>js <a href=\"https://github.com/axios/axios\" target=\"_blank\" rel=\"noopener\">axios</a> ajaxPromise</p>\n<p>main.js</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> request = axios.create()</span><br><span class=\"line\">request.interceptors.response.use(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> response</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.request = <span class=\"function\">(<span class=\"params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch1()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch1 () &#123;</span><br><span class=\"line\">        Vue.request(<span class=\"string\">'https://api1.github.com/'</span>)</span><br><span class=\"line\">\t      .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(response)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>api.github.com  githubapiapi1.github.comerrorHandlerVue.requestcatchPromise.then</p>\n<p>App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch2()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">        <span class=\"keyword\">let</span> info = data.api.info</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>errorHandlervueissuePromiseasync/await:</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/6551\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/6551</a></p>\n<p>Vue cannot capture errors that are thrown asynchronously, similar to how try catch wont catch async errors. Its your responsibility to handle async errors properly, e.g. using Promise.catch   @yyx990803</p>\n</blockquote>\n<p>Promise.catch</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/7653\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/7653</a></p>\n<p>@Doeke mixinPromisePromisePromisecatchPromise</p>\n</blockquote>\n<p>main.js@Doeke</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.mixin(&#123;</span><br><span class=\"line\">  beforeCreate: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> methods = <span class=\"keyword\">this</span>.$options.methods || &#123;&#125;</span><br><span class=\"line\">    <span class=\"built_in\">Object</span>.entries(methods).forEach(<span class=\"function\">(<span class=\"params\">[key, method]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (method._asyncWrapped) <span class=\"keyword\">return</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> wrappedMethod = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> result = method.apply(<span class=\"keyword\">this</span>, args)</span><br><span class=\"line\">        <span class=\"keyword\">const</span> resultIsPromise = result &amp;&amp; <span class=\"keyword\">typeof</span> result.then === <span class=\"string\">'function'</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!resultIsPromise) <span class=\"keyword\">return</span> result</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"keyword\">async</span> (resolve, reject) =&gt; &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            resolve(<span class=\"keyword\">await</span> result)</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!error._handled) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">const</span> errorHandler = Vue.config.errorHandler</span><br><span class=\"line\">              errorHandler(error)</span><br><span class=\"line\">              error._handled = <span class=\"literal\">true</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            reject(error)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      wrappedMethod._asyncWrapped = <span class=\"literal\">true</span></span><br><span class=\"line\">      methods[key] = wrappedMethod</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch2()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch3()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"keyword\">let</span> info = data.api.fetch2</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    fetch3 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"keyword\">let</span> info = data.api.fetch3</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>consolefetch3errorHandlerfetch2</p>\n<p>Promiseasync/await</p>\n<p>App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch4()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch5()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    <span class=\"keyword\">async</span> fetch4 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> response = <span class=\"keyword\">await</span> Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.api.fetch4</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"keyword\">async</span> fetch5 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> response = <span class=\"keyword\">await</span> Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.api.fetch5</span><br><span class=\"line\">      <span class=\"keyword\">return</span> response</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>fetch4Promisefetch5Promisefetch4fetch5async/awaitPromise <a href=\"https://babeljs.io\" target=\"_blank\" rel=\"noopener\">babeljs</a>  Try it out  async/awaitPromise</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong>axios.create</p>\n<p><strong></strong>PromiseerrorHandlerPromisemixinPromisecatcherrorHandler<strong><em>!</em></strong></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong>#  </strong></p>\n<p></p>\n<p><strong>#  <a href=\"https://sentry.io/\" target=\"_blank\" rel=\"noopener\">Sentry</a>  </strong></p>\n<p>JS SDK</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install raven-js --save</span><br></pre></td></tr></table></figure>\n<p>main.js</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> Raven <span class=\"keyword\">from</span> <span class=\"string\">'raven-js'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> RavenVue <span class=\"keyword\">from</span> <span class=\"string\">'raven-js/plugins/vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>) <span class=\"comment\">// sentry token</span></span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.errorHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  Raven.captureException(err)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Vue.request = <span class=\"function\">(<span class=\"params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      Raven.captureException(err)</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<p>App.vue js<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.normal()</span><br><span class=\"line\">    <span class=\"comment\">// this.fetch1()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch2()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch3()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch4()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch5()</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure></p>\n<p>sentry<br><img src=\"/images/js-capture-error/1.png\" alt=\"\"><br><img src=\"/images/js-capture-error/2.jpg\" alt=\"IP\"><br>2sentryissue</p>\n<p>fetch1ajax<br><img src=\"/images/js-capture-error/3.jpg\" alt=\"api1.github.com\"></p>\n<p>fetch2PromisePromiseasync/awaitPromise.then2</p>\n<p><img src=\"/images/js-capture-error/4.jpg\" alt=\"Promise.then\"><br><img src=\"/images/js-capture-error/5.jpg\" alt=\"async/await\"></p>\n<p></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven.setUser(&#123;</span><br><span class=\"line\">    name: <span class=\"string\">'miser name'</span>,</span><br><span class=\"line\">    id: <span class=\"string\">'miser id'</span></span><br><span class=\"line\">  &#125;)</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/js-capture-error/6.jpg\" alt=\"\"></p>\n<p><strong></strong></p>\n<p><img src=\"/images/js-capture-error/7.jpg\" alt=\"npm run build \"></p>\n<p>sentry<a href=\"https://github.com/google/closure-compiler/wiki/Source-Maps\" target=\"_blank\" rel=\"noopener\">SourceMaps</a>debug</p>\n<p><a href=\"https://www.npmjs.com/package/webpack-sentry-plugin\" target=\"_blank\" rel=\"noopener\">webpack-sentry-plugin</a>webpackvue3vue.config.js</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> SentryPlugin = <span class=\"built_in\">require</span>(<span class=\"string\">'webpack-sentry-plugin'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  configureWebpack: &#123;</span><br><span class=\"line\">    plugins: [</span><br><span class=\"line\">      <span class=\"keyword\">new</span> SentryPlugin(&#123;</span><br><span class=\"line\">        organization: <span class=\"string\">'fe-org'</span>, <span class=\"comment\">//  </span></span><br><span class=\"line\">        project: <span class=\"string\">'popcorn-vue'</span>, <span class=\"comment\">//  </span></span><br><span class=\"line\">        apiKey: <span class=\"string\">'17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150'</span>,</span><br><span class=\"line\">        release: <span class=\"string\">'1.2.4-beta'</span> <span class=\"comment\">// sourcemaps</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>main.js<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>, &#123;</span><br><span class=\"line\">    release: <span class=\"string\">'1.2.4-beta'</span> <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run build</span><br></pre></td></tr></table></figure>\n<p>sentrypopcorn-vue<strong></strong></p>\n<p><img src=\"/images/js-capture-error/8.jpg\" alt=\"1.2.4-beta1.2.3-beta\"><br><img src=\"/images/js-capture-error/9.jpg\" alt=\" 1.2.4-beta jsjs.map\"></p>\n<p>buildindex.htmlSourceMapsjsjs.map</p>\n<p>issue <a href=\"https://github.com/getsentry/sentry-electron/issues/54\" target=\"_blank\" rel=\"noopener\">https://github.com/getsentry/sentry-electron/issues/54</a> 2</p>\n<p> js.mapjs<br> jsjs.map</p>\n<p>2</p>\n<p>index.htmlfile:///<strong>**</strong>/vue-capture-error/dist/index.htmlnginx<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install nginx</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure></p>\n<p>builddistnginx /usr/local/var/www/<a href=\"http://localhost:8080\" target=\"_blank\" rel=\"noopener\">http://localhost:8080</a></p>\n<p>sentry</p>\n<p><img src=\"/images/js-capture-error/10.jpg\" alt=\"\"></p>"},{"title":"CSSJS","date":"2018-09-23T22:45:00.000Z","_content":"\n\n\n<!-- more -->\n\n## \n\n*localhostchrome 69*\n\n-- css\n  - css1.css 2 body { background-color: #444 }\n  - css2.css  body { font-size: 50px;font-weight: bold; }\n\n-- js\n  - js1.js 1 console.log(\"js1.js loaded\") \n  - js2.js  console.log(\"js2.js loaded\")\n  - js3.js 3 console.log(\"js2.js loaded\")\n\n-- image\n  - img1.png 3 js\n  - img2.png  nodejs\n\n\n\n\n```js\nconst Koa = require('koa')\nconst Router = require('koa-router')\nconst views = require('koa-views')\nconst fs = require('fs')\n\nconst app = new Koa()\nconst router = new Router()\n\napp.use(views(__dirname + '/views'))\n\nrouter.get('/', async (ctx, next) => {\n  await ctx.render('index.html')\n})\n\nrouter.get('/css1.css', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'text/css')\n    ctx.body = 'body { background-color: #444 }'\n    resolve()\n  }, 1000 * 2)\n}))\n\nrouter.get('/css2.css', async ctx => {\n  ctx.set('Content-Type', 'text/css')\n  ctx.body = 'body { font-size: 50px;font-weight: bold; }'\n})\n\nrouter.get('/js1.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js1.js loaded\")'\n    resolve()\n  }, 1000)\n}))\n\nrouter.get('/js2.js', async ctx => {\n  ctx.body = 'console.log(\"js2.js loaded\")'\n})\n\nrouter.get('/js3.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js3.js loaded\")'\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img1.png', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'image/png; charset=UTF-8')\n    ctx.body = fs.createReadStream('1.png')\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img2.png', async ctx => {\n  ctx.set('Content-Type', 'image/png; charset=UTF-8')\n  ctx.body = fs.createReadStream('2.png')\n})\n\napp\n  .use(router.routes())\n  .use(router.allowedMethods())\n\napp.listen(3000)\n```\n\n##  CSSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \napp\ntest: 1947.620849609375ms\n-->\n```\n\n app 2 test __CSSDOM__\n\n##  CSSJSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \njs1.js loaded\njs2.js loaded\n(index):17 test: 1921.02099609375ms\n-->\n```\n\nindex.htmlDOM2img1.png\n\njscss1cssjs2.jsjs1.jscss1.cssimg1.png1__CSSJSDOM__\n\n##  JSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \nnull\njs3.js loaded\ntest: 2943.9951171875ms\n-->\n```\n\njs3.js3 app null3 test __JSDOM__\n\n##  DOMDOMContentLoadedonLoad\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n    console.time('testDOMContentLoaded')\n    console.time('testonload')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n    window.onload = function () {\n      console.timeEnd('testonload')\n    }\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n\t<script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \njs1.js loaded\njs2.js loaded\ntest: 1955.489990234375ms\ntestDOMContentLoaded: 1956.044189453125ms\ntestonload: 2964.078857421875ms\n-->\n```\n\n testDOMContentLoaded 2testonload3__DOMContentLoadedjscssonload__\n\n##  script async \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script async type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3js\"async\",\n- testDOMContentLoaded \n- app\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\njs1.js\"async\"\n\n- el  null\n- js1.js loaded\n- testDOMContentLoaded 1\n- js2.js loaded\n- js3.js loaded\n\njs3.js\"async\"\n\n- el  null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\n__asyncjsasyncjsDOMContentLoadedasync__\n\n##  script defer \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n\n```\n\n3js\"defer\",\n\n- app\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\ndeferasync\n\njs1.js\"defer\"\n\n- el  null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\ndeferasync\n\njs3.js\"defer\"\n- js1.js loaded\n- js3.js loaded\n- js2.js loaded\n- testDOMContentLoaded 3\n\n__deferjsdeferjsdeferDOMContentLoadeddefer__\n\n##  script defer & async  \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script async defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3js\"async\",\n- testDOMContentLoaded \n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\nasyncdefer\n\n##  script\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\">\n    varhead = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 3; i++) {\n      varscript = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- testDOMContentLoaded \n- appEl \n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\njs1.jsjs2.jsjs3.js\n\nindex.html\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"js3.js\"></script>\n  <script type=\"text/javascript\">\n    varhead = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 2; i++) {\n      varscript = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- appEl  null \n- js3.js loaded \n- testDOMContentLoaded 3\n- js2.js loaded\n- js1.js loaded\n\n__scriptDOMContentLoaded__\n\n\n## \nCSSDOMJSDOMJSDOMscriptdefer & asyncDOMasync deferdeferscript","source":"_posts/js-css-image-loading.md","raw":"---\ntitle: CSSJS\ncategory: JavaScript\ndate: 2018-09-24T06:45:00.000Z\n---\n\n\n\n<!-- more -->\n\n## \n\n*localhostchrome 69*\n\n-- css\n  - css1.css 2 body { background-color: #444 }\n  - css2.css  body { font-size: 50px;font-weight: bold; }\n\n-- js\n  - js1.js 1 console.log(\"js1.js loaded\") \n  - js2.js  console.log(\"js2.js loaded\")\n  - js3.js 3 console.log(\"js2.js loaded\")\n\n-- image\n  - img1.png 3 js\n  - img2.png  nodejs\n\n\n\n\n```js\nconst Koa = require('koa')\nconst Router = require('koa-router')\nconst views = require('koa-views')\nconst fs = require('fs')\n\nconst app = new Koa()\nconst router = new Router()\n\napp.use(views(__dirname + '/views'))\n\nrouter.get('/', async (ctx, next) => {\n  await ctx.render('index.html')\n})\n\nrouter.get('/css1.css', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'text/css')\n    ctx.body = 'body { background-color: #444 }'\n    resolve()\n  }, 1000 * 2)\n}))\n\nrouter.get('/css2.css', async ctx => {\n  ctx.set('Content-Type', 'text/css')\n  ctx.body = 'body { font-size: 50px;font-weight: bold; }'\n})\n\nrouter.get('/js1.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js1.js loaded\")'\n    resolve()\n  }, 1000)\n}))\n\nrouter.get('/js2.js', async ctx => {\n  ctx.body = 'console.log(\"js2.js loaded\")'\n})\n\nrouter.get('/js3.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js3.js loaded\")'\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img1.png', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'image/png; charset=UTF-8')\n    ctx.body = fs.createReadStream('1.png')\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img2.png', async ctx => {\n  ctx.set('Content-Type', 'image/png; charset=UTF-8')\n  ctx.body = fs.createReadStream('2.png')\n})\n\napp\n  .use(router.routes())\n  .use(router.allowedMethods())\n\napp.listen(3000)\n```\n\n##  CSSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \napp\ntest: 1947.620849609375ms\n-->\n```\n\n app 2 test __CSSDOM__\n\n##  CSSJSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \njs1.js loaded\njs2.js loaded\n(index):17 test: 1921.02099609375ms\n-->\n```\n\nindex.htmlDOM2img1.png\n\njscss1cssjs2.jsjs1.jscss1.cssimg1.png1__CSSJSDOM__\n\n##  JSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \nnull\njs3.js loaded\ntest: 2943.9951171875ms\n-->\n```\n\njs3.js3 app null3 test __JSDOM__\n\n##  DOMDOMContentLoadedonLoad\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n    console.time('testDOMContentLoaded')\n    console.time('testonload')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n    window.onload = function () {\n      console.timeEnd('testonload')\n    }\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n\t<script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \njs1.js loaded\njs2.js loaded\ntest: 1955.489990234375ms\ntestDOMContentLoaded: 1956.044189453125ms\ntestonload: 2964.078857421875ms\n-->\n```\n\n testDOMContentLoaded 2testonload3__DOMContentLoadedjscssonload__\n\n##  script async \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script async type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3js\"async\",\n- testDOMContentLoaded \n- app\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\njs1.js\"async\"\n\n- el  null\n- js1.js loaded\n- testDOMContentLoaded 1\n- js2.js loaded\n- js3.js loaded\n\njs3.js\"async\"\n\n- el  null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\n__asyncjsasyncjsDOMContentLoadedasync__\n\n##  script defer \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n\n```\n\n3js\"defer\",\n\n- app\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\ndeferasync\n\njs1.js\"defer\"\n\n- el  null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\ndeferasync\n\njs3.js\"defer\"\n- js1.js loaded\n- js3.js loaded\n- js2.js loaded\n- testDOMContentLoaded 3\n\n__deferjsdeferjsdeferDOMContentLoadeddefer__\n\n##  script defer & async  \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script async defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3js\"async\",\n- testDOMContentLoaded \n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\nasyncdefer\n\n##  script\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\">\n    varhead = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 3; i++) {\n      varscript = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- testDOMContentLoaded \n- appEl \n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\njs1.jsjs2.jsjs3.js\n\nindex.html\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"js3.js\"></script>\n  <script type=\"text/javascript\">\n    varhead = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 2; i++) {\n      varscript = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- appEl  null \n- js3.js loaded \n- testDOMContentLoaded 3\n- js2.js loaded\n- js1.js loaded\n\n__scriptDOMContentLoaded__\n\n\n## \nCSSDOMJSDOMJSDOMscriptdefer & asyncDOMasync deferdeferscript","slug":"js-css-image-loading","published":1,"updated":"2020-07-07T10:11:25.587Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs5t0009d12idrzu6e7l","content":"<p></p>\n<a id=\"more\"></a>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><em>localhostchrome 69</em></p>\n<p> css</p>\n<ul>\n<li>css1.css 2 body { background-color: #444 }</li>\n<li>css2.css  body { font-size: 50px;font-weight: bold; }</li>\n</ul>\n<p> js</p>\n<ul>\n<li>js1.js 1 console.log(js1.js loaded) </li>\n<li>js2.js  console.log(js2.js loaded)</li>\n<li>js3.js 3 console.log(js2.js loaded)</li>\n</ul>\n<p> image</p>\n<ul>\n<li>img1.png 3 js</li>\n<li>img2.png  nodejs</li>\n</ul>\n<p></p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> Koa = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Router = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa-router'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> views = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa-views'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> fs = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'fs'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-keyword\">new</span> Koa()</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> router = <span class=\"hljs-keyword\">new</span> Router()</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(views(__dirname + <span class=\"hljs-string\">'/views'</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/'</span>, <span class=\"hljs-keyword\">async</span> (ctx, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">await</span> ctx.render(<span class=\"hljs-string\">'index.html'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/css1.css'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'text/css'</span>)</span><br><span class=\"line\">    ctx.body = <span class=\"hljs-string\">'body &#123; background-color: #444 &#125;'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">2</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/css2.css'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'text/css'</span>)</span><br><span class=\"line\">  ctx.body = <span class=\"hljs-string\">'body &#123; font-size: 50px;font-weight: bold; &#125;'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/js1.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"hljs-string\">'console.log(\"js1.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/js2.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.body = <span class=\"hljs-string\">'console.log(\"js2.js loaded\")'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/js3.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"hljs-string\">'console.log(\"js3.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/img1.png'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">    ctx.body = fs.createReadStream(<span class=\"hljs-string\">'1.png'</span>)</span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/img2.png'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">  ctx.body = fs.createReadStream(<span class=\"hljs-string\">'2.png'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app</span><br><span class=\"line\">  .use(router.routes())</span><br><span class=\"line\">  .use(router.allowedMethods())</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(<span class=\"hljs-number\">3000</span>)</span><br></pre></td></tr></table></figure>\n<h2 id=\"-CSSDOM\"><a href=\"#-CSSDOM\" class=\"headerlink\" title=\" CSSDOM\"></a> CSSDOM</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">app</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 1947.620849609375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p> app 2 test <strong>CSSDOM</strong></p>\n<h2 id=\"-CSSJSDOM\"><a href=\"#-CSSJSDOM\" class=\"headerlink\" title=\" CSSJSDOM\"></a> CSSJSDOM</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">(index):17 test: 1921.02099609375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>index.htmlDOM2img1.png</p>\n<p>jscss1cssjs2.jsjs1.jscss1.cssimg1.png1<strong>CSSJSDOM</strong></p>\n<h2 id=\"-JSDOM\"><a href=\"#-JSDOM\" class=\"headerlink\" title=\" JSDOM\"></a> JSDOM</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">null</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js3.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 2943.9951171875ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>js3.js3 app null3 test <strong>JSDOM</strong></p>\n<h2 id=\"-DOMDOMContentLoadedonLoad\"><a href=\"#-DOMDOMContentLoadedonLoad\" class=\"headerlink\" title=\" DOMDOMContentLoadedonLoad\"></a> DOMDOMContentLoadedonLoad</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">window</span>.onload = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 1955.489990234375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">testDOMContentLoaded: 1956.044189453125ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">testonload: 2964.078857421875ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p> testDOMContentLoaded 2testonload3<strong>DOMContentLoadedjscssonload</strong></p>\n<h2 id=\"-script-async-\"><a href=\"#-script-async-\" class=\"headerlink\" title=\" script async \"></a> script async </h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3jsasync,</p>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>app</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js1.jsasync</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>testDOMContentLoaded 1</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js3.jsasync</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p><strong>asyncjsasyncjsDOMContentLoadedasync</strong></p>\n<h2 id=\"-script-defer-\"><a href=\"#-script-defer-\" class=\"headerlink\" title=\" script defer \"></a> script defer </h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3jsdefer,</p>\n<ul>\n<li>app</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>deferasync</p>\n<p>js1.jsdefer</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>deferasync</p>\n<p>js3.jsdefer</p>\n<ul>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n<li>js2.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p><strong>deferjsdeferjsdeferDOMContentLoadeddefer</strong></p>\n<h2 id=\"-script-defer-amp-async--\"><a href=\"#-script-defer-amp-async--\" class=\"headerlink\" title=\" script defer &amp; async  \"></a> script defer &amp; async  </h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3jsasync,</p>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>asyncdefer</p>\n<h2 id=\"-script\"><a href=\"#-script\" class=\"headerlink\" title=\" script\"></a> script</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-keyword\">var</span> appEl = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">var</span>head = <span class=\"hljs-built_in\">document</span>.getElementsByTagName(<span class=\"hljs-string\">'head'</span>)[<span class=\"hljs-number\">0</span>]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">3</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">var</span>script = <span class=\"hljs-built_in\">document</span>.createElement(<span class=\"hljs-string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.type = <span class=\"hljs-string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.src = <span class=\"hljs-string\">'js'</span> + (i + <span class=\"hljs-number\">1</span>) + <span class=\"hljs-string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>appEl </li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js1.jsjs2.jsjs3.js</p>\n<p>index.html<br><figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-keyword\">var</span> appEl = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">var</span>head = <span class=\"hljs-built_in\">document</span>.getElementsByTagName(<span class=\"hljs-string\">'head'</span>)[<span class=\"hljs-number\">0</span>]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">2</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">var</span>script = <span class=\"hljs-built_in\">document</span>.createElement(<span class=\"hljs-string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.type = <span class=\"hljs-string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.src = <span class=\"hljs-string\">'js'</span> + (i + <span class=\"hljs-number\">1</span>) + <span class=\"hljs-string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>appEl  null </li>\n<li>js3.js loaded </li>\n<li>testDOMContentLoaded 3</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n</ul>\n<p><strong>scriptDOMContentLoaded</strong></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>CSSDOMJSDOMJSDOMscriptdefer &amp; asyncDOMasync deferdeferscript</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[],"excerpt":"<p></p>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><em>localhostchrome 69</em></p>\n<p> css</p>\n<ul>\n<li>css1.css 2 body { background-color: #444 }</li>\n<li>css2.css  body { font-size: 50px;font-weight: bold; }</li>\n</ul>\n<p> js</p>\n<ul>\n<li>js1.js 1 console.log(js1.js loaded) </li>\n<li>js2.js  console.log(js2.js loaded)</li>\n<li>js3.js 3 console.log(js2.js loaded)</li>\n</ul>\n<p> image</p>\n<ul>\n<li>img1.png 3 js</li>\n<li>img2.png  nodejs</li>\n</ul>\n<p></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> Koa = <span class=\"built_in\">require</span>(<span class=\"string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Router = <span class=\"built_in\">require</span>(<span class=\"string\">'koa-router'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> views = <span class=\"built_in\">require</span>(<span class=\"string\">'koa-views'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">'fs'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> Koa()</span><br><span class=\"line\"><span class=\"keyword\">const</span> router = <span class=\"keyword\">new</span> Router()</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(views(__dirname + <span class=\"string\">'/views'</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/'</span>, <span class=\"keyword\">async</span> (ctx, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">await</span> ctx.render(<span class=\"string\">'index.html'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/css1.css'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'text/css'</span>)</span><br><span class=\"line\">    ctx.body = <span class=\"string\">'body &#123; background-color: #444 &#125;'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">2</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/css2.css'</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'text/css'</span>)</span><br><span class=\"line\">  ctx.body = <span class=\"string\">'body &#123; font-size: 50px;font-weight: bold; &#125;'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/js1.js'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"string\">'console.log(\"js1.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/js2.js'</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.body = <span class=\"string\">'console.log(\"js2.js loaded\")'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/js3.js'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"string\">'console.log(\"js3.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/img1.png'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">    ctx.body = fs.createReadStream(<span class=\"string\">'1.png'</span>)</span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/img2.png'</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">  ctx.body = fs.createReadStream(<span class=\"string\">'2.png'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app</span><br><span class=\"line\">  .use(router.routes())</span><br><span class=\"line\">  .use(router.allowedMethods())</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(<span class=\"number\">3000</span>)</span><br></pre></td></tr></table></figure>\n<h2 id=\"-CSSDOM\"><a href=\"#-CSSDOM\" class=\"headerlink\" title=\" CSSDOM\"></a> CSSDOM</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"comment\">app</span></span><br><span class=\"line\"><span class=\"comment\">test: 1947.620849609375ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p> app 2 test <strong>CSSDOM</strong></p>\n<h2 id=\"-CSSJSDOM\"><a href=\"#-CSSJSDOM\" class=\"headerlink\" title=\" CSSJSDOM\"></a> CSSJSDOM</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">(index):17 test: 1921.02099609375ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>index.htmlDOM2img1.png</p>\n<p>jscss1cssjs2.jsjs1.jscss1.cssimg1.png1<strong>CSSJSDOM</strong></p>\n<h2 id=\"-JSDOM\"><a href=\"#-JSDOM\" class=\"headerlink\" title=\" JSDOM\"></a> JSDOM</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"comment\">null</span></span><br><span class=\"line\"><span class=\"comment\">js3.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">test: 2943.9951171875ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>js3.js3 app null3 test <strong>JSDOM</strong></p>\n<h2 id=\"-DOMDOMContentLoadedonLoad\"><a href=\"#-DOMDOMContentLoadedonLoad\" class=\"headerlink\" title=\" DOMDOMContentLoadedonLoad\"></a> DOMDOMContentLoadedonLoad</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">test: 1955.489990234375ms</span></span><br><span class=\"line\"><span class=\"comment\">testDOMContentLoaded: 1956.044189453125ms</span></span><br><span class=\"line\"><span class=\"comment\">testonload: 2964.078857421875ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p> testDOMContentLoaded 2testonload3<strong>DOMContentLoadedjscssonload</strong></p>\n<h2 id=\"-script-async-\"><a href=\"#-script-async-\" class=\"headerlink\" title=\" script async \"></a> script async </h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3jsasync,</p>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>app</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js1.jsasync</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>testDOMContentLoaded 1</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js3.jsasync</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p><strong>asyncjsasyncjsDOMContentLoadedasync</strong></p>\n<h2 id=\"-script-defer-\"><a href=\"#-script-defer-\" class=\"headerlink\" title=\" script defer \"></a> script defer </h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3jsdefer,</p>\n<ul>\n<li>app</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>deferasync</p>\n<p>js1.jsdefer</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>deferasync</p>\n<p>js3.jsdefer</p>\n<ul>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n<li>js2.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p><strong>deferjsdeferjsdeferDOMContentLoadeddefer</strong></p>\n<h2 id=\"-script-defer-amp-async--\"><a href=\"#-script-defer-amp-async--\" class=\"headerlink\" title=\" script defer &amp; async  \"></a> script defer &amp; async  </h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3jsasync,</p>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>asyncdefer</p>\n<h2 id=\"-script\"><a href=\"#-script\" class=\"headerlink\" title=\" script\"></a> script</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"keyword\">var</span> appEl = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span>head = <span class=\"built_in\">document</span>.getElementsByTagName(<span class=\"string\">'head'</span>)[<span class=\"number\">0</span>]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">3</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span>script = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      script.type = <span class=\"string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"javascript\">      script.src = <span class=\"string\">'js'</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>appEl </li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js1.jsjs2.jsjs3.js</p>\n<p>index.html<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"keyword\">var</span> appEl = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span>head = <span class=\"built_in\">document</span>.getElementsByTagName(<span class=\"string\">'head'</span>)[<span class=\"number\">0</span>]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">2</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span>script = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      script.type = <span class=\"string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"javascript\">      script.src = <span class=\"string\">'js'</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>appEl  null </li>\n<li>js3.js loaded </li>\n<li>testDOMContentLoaded 3</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n</ul>\n<p><strong>scriptDOMContentLoaded</strong></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>CSSDOMJSDOMJSDOMscriptdefer &amp; asyncDOMasync deferdeferscript</p>"},{"title":"Node.js","keywords":"Node.js,,Node.js","description":"Node.js child_process, execexecFileforkspawncluster, fork","date":"2020-04-06T00:09:36.472Z","_content":"\n**Node.js **\n\n**child_process**\n\n- [exec](http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback):  shell  shell  `command` 1024\\*1024 \n- [execFile](http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback): `exec` shell `file` `exec` `exec` 1024\\*1204 \n- [fork](http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options):  `spawn` Node.js  `spawn``ChildProcess` `ChildProcess`\n- [spawn](http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options):  spawn \n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): \n\n<!-- more -->\n\n<br/>\n\n### ****\n\n[libuv & Node.js EventLoop ](https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/)\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**child_process**\n\n```javascript\nNode \n  - lib \n  \t- internal \n  \t\t- child_process.js \n  \t- child_process.js;\n```\n\n`lib/child_process.js``exec``execFile``fork``spawn``lib/internal/child_process.js``spawn`\n\n<br/>\n\n**exec**\n\n```javascript\n// lib/child_process.js\nfunction exec(command, options, callback) {\n  const opts = normalizeExecArgs(command, options, callback);\n  return module.exports.execFile(opts.file, opts.options, opts.callback);\n}\nfunction normalizeExecArgs(command, options, callback) {\n  if (typeof options === \"function\") {\n    callback = options;\n    options = undefined;\n  }\n\n  // Make a shallow copy so we don't clobber the user's options object.\n  options = { ...options };\n  options.shell = typeof options.shell === \"string\" ? options.shell : true;\n\n  return {\n    file: command,\n    options: options,\n    callback: callback,\n  };\n}\n```\n\n exec `shell` execFile \n\n<br/>\n\n**execFile**\n\n```javascript\n// lib/child_process.js\nfunction execFile(file /* , args, options, callback */) {\n  let args = [];\n  let callback;\n  let options;\n\n  // ...\n\n  options = {\n    encoding: \"utf8\",\n    timeout: 0,\n    maxBuffer: MAX_BUFFER,\n    killSignal: \"SIGTERM\",\n    cwd: null,\n    env: null,\n    shell: false, // execFile shell\n    ...options,\n  };\n\n  // spawn\n  const child = spawn(file, args, {\n    cwd: options.cwd,\n    env: options.env,\n    gid: options.gid,\n    uid: options.uid,\n    shell: options.shell,\n    windowsHide: !!options.windowsHide,\n    windowsVerbatimArguments: !!options.windowsVerbatimArguments,\n  });\n\n  var encoding;\n  const _stdout = []; // \n  const _stderr = []; // \n  // ...\n  var stdoutLen = 0; // \n  var stderrLen = 0; // \n  var killed = false; // \n  var exited = false; // \n  var timeoutId; // \n\n  var ex = null; // \n\n  var cmd = file; // \n\n  // \n  function exithandler(code, signal) {\n    if (exited) return;\n    exited = true;\n\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      timeoutId = null;\n    }\n\n    if (!callback) return;\n\n    // merge chunks\n    var stdout;\n    var stderr;\n    if (encoding || (child.stdout && child.stdout.readableEncoding)) {\n      stdout = _stdout.join(\"\");\n    } else {\n      stdout = Buffer.concat(_stdout); //  encoding Buffer\n    }\n    if (encoding || (child.stderr && child.stderr.readableEncoding)) {\n      stderr = _stderr.join(\"\");\n    } else {\n      stderr = Buffer.concat(_stderr); //  encoding Buffer\n    }\n\n    if (!ex && code === 0 && signal === null) {\n      callback(null, stdout, stderr); // \n      return;\n    }\n\n    if (args.length !== 0) cmd += ` ${args.join(\" \")}`;\n\n    if (!ex) {\n      // eslint-disable-next-line no-restricted-syntax\n      ex = new Error(\"Command failed: \" + cmd + \"\\n\" + stderr);\n      ex.killed = child.killed || killed;\n      ex.code = code < 0 ? getSystemErrorName(code) : code;\n      ex.signal = signal;\n    }\n\n    ex.cmd = cmd;\n    callback(ex, stdout, stderr); // \n  }\n\n  function errorhandler(e) {\n    ex = e;\n\n    // child.stdout  child.stderr \n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    exithandler();\n  }\n\n  function kill() {\n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    killed = true;\n    try {\n      child.kill(options.killSignal);\n    } catch (e) {\n      ex = e;\n      exithandler();\n    }\n  }\n\n  // \n  if (options.timeout > 0) {\n    timeoutId = setTimeout(function delayedKill() {\n      kill();\n      timeoutId = null;\n    }, options.timeout);\n  }\n\n  if (child.stdout) {\n    if (encoding) child.stdout.setEncoding(encoding);\n\n    child.stdout.on(\"data\", function onChildStdout(chunk) {\n      const encoding = child.stdout.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stdoutLen += length; // \n\n      if (stdoutLen > options.maxBuffer) {\n        // \n        const truncatedLen = options.maxBuffer - (stdoutLen - length);\n        _stdout.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stdout\");\n        kill();\n      } else {\n        _stdout.push(chunk); // chunk\n      }\n    });\n  }\n\n  // child.stdout\n  if (child.stderr) {\n    if (encoding) child.stderr.setEncoding(encoding);\n\n    child.stderr.on(\"data\", function onChildStderr(chunk) {\n      const encoding = child.stderr.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stderrLen += length;\n\n      if (stderrLen > options.maxBuffer) {\n        const truncatedLen = options.maxBuffer - (stderrLen - length);\n        _stderr.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stderr\");\n        kill();\n      } else {\n        _stderr.push(chunk);\n      }\n    });\n  }\n\n  child.addListener(\"close\", exithandler);\n  child.addListener(\"error\", errorhandler);\n\n  return child;\n}\n```\n\n`exec``execFile``shell``child.stderr.on('data')``child.stdout.on('data')`\n\n`_stderr``_stdout`\n\n**`spawn`**\n\n<br/>\n\n**fork**\n\n```javascript\n// lib/child_process.js\nfunction fork(modulePath /* , args, options */) {\n  // Get options and args arguments.\n  var execArgv;\n  var options = {};\n  var args = [];\n\n  // ...\n\n  // forkstdioipc\n  if (typeof options.stdio === \"string\") {\n    options.stdio = stdioStringToArray(options.stdio, \"ipc\");\n  } else if (!Array.isArray(options.stdio)) {\n    // Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,\n    // and stderr from the parent if silent isn't set.\n    options.stdio = stdioStringToArray(\n      options.silent ? \"pipe\" : \"inherit\",\n      \"ipc\"\n    );\n  } else if (!options.stdio.includes(\"ipc\")) {\n    throw new ERR_CHILD_PROCESS_IPC_REQUIRED(\"options.stdio\");\n  }\n\n  options.execPath = options.execPath || process.execPath; // Node\n  options.shell = false; //  shell\n\n  return spawn(options.execPath, args, options);\n}\n```\n\n 12~22 fork  stdio  ipc `ipc``spawn`\n\n<br/>\n\n**spawn**\n\n```javascript\n// lib/child_process.js\nfunction spawn(file, args, options) {\n  const child = new ChildProcess();\n\n  options = normalizeSpawnArguments(file, args, options);\n  debug(\"spawn\", options);\n  child.spawn(options);\n\n  return child;\n}\n```\n\n`lib/child_process.js` spawn  ChildProcess  spawn\n\n<br/>\n\n**ChildProcess**\n\n```javascript\n// `lib/internal/child_process.js`\nfunction ChildProcess() {\n  EventEmitter.call(this);\n\n  // ...\n\n  this._handle = new Process(); // new  ProcessWrap   process_wrap.cc\n}\n\nChildProcess.prototype.spawn = function (options) {\n  let i = 0;\n\n  //  pipe\n  let stdio = options.stdio || \"pipe\";\n\n  // stdio\n  stdio = getValidStdio(stdio, false);\n\n  const ipc = stdio.ipc;\n  const ipcFd = stdio.ipcFd;\n  stdio = options.stdio = stdio.stdio;\n\n  // ...\n\n  // ProcessWrapspawn\n  const err = this._handle.spawn(options);\n\n  // err\n  // ...\n\n  this.pid = this._handle.pid;\n\n  for (i = 0; i < stdio.length; i++) {\n    const stream = stdio[i];\n    // ...\n    if (stream.handle) {\n      // When i === 0 - we're dealing with stdin\n      // (which is the only one writable pipe).\n      //  socket\n      stream.socket = createSocket(\n        this.pid !== 0 ? stream.handle : null,\n        i > 0\n      );\n\n      if (i > 0 && this.pid !== 0) {\n        this._closesNeeded++;\n        stream.socket.on(\"close\", () => {\n          maybeClose(this);\n        });\n      }\n    }\n  }\n  this.stdin =\n    stdio.length >= 1 && stdio[0].socket !== undefined ? stdio[0].socket : null;\n  this.stdout =\n    stdio.length >= 2 && stdio[1].socket !== undefined ? stdio[1].socket : null;\n  this.stderr =\n    stdio.length >= 3 && stdio[2].socket !== undefined ? stdio[2].socket : null;\n\n  this.stdio = [];\n\n  for (i = 0; i < stdio.length; i++)\n    this.stdio.push(stdio[i].socket === undefined ? null : stdio[i].socket);\n\n  // Add .send() method and start listening for IPC data\n  // setupChannel \n  if (ipc !== undefined) setupChannel(this, ipc);\n\n  return err;\n};\n\nfunction stdioStringToArray(stdio, channel) {\n  // stdio[xxx,xxx,xxx]\n  // channel[xxx,xxx,xxx,channel]\n}\n\nfunction getValidStdio(stdio, sync) {\n  var ipc;\n  var ipcFd;\n\n  stdio = stdio.reduce((acc, stdio, i) => {\n    function cleanup() {\n      for (var i = 0; i < acc.length; i++) {\n        if ((acc[i].type === \"pipe\" || acc[i].type === \"ipc\") && acc[i].handle)\n          acc[i].handle.close();\n      }\n    }\n\n    if (stdio === \"ignore\") {\n      acc.push({ type: \"ignore\" }); // \n    } else if (stdio === \"pipe\" || (typeof stdio === \"number\" && stdio < 0)) {\n      var a = {\n        type: \"pipe\",\n        readable: i === 0, // 0stdin\n        writable: i !== 0, // 1stdout2stderr \n      };\n      // spawn syncfalsestdinstdoutstderrSOCKETPipe\n      if (!sync) a.handle = new Pipe(PipeConstants.SOCKET);\n\n      acc.push(a);\n    } else if (stdio === \"ipc\") {\n      // IPCPipe\n      ipc = new Pipe(PipeConstants.IPC);\n      ipcFd = i; // ipc\n\n      acc.push({\n        type: \"pipe\",\n        handle: ipc,\n        ipc: true,\n      });\n    } else if (stdio === \"inherit\") {\n      acc.push({\n        type: \"inherit\",\n        fd: i,\n      });\n    }\n    // ...\n    return acc;\n  }, []);\n\n  return { stdio, ipc, ipcFd };\n}\n```\n\n`ChildProcess` V8  new ProcessWrap  this.\\_handle\n\n`ChildProcess.prototype.spawn`[`stdio`](http://nodejs.cn/api/child_process.html#child_process_options_stdio)`pipe``ipc` Pipe \n\n```c\n// pipe_wrap.cc\nvoid PipeWrap::New(const FunctionCallbackInfo<Value>& args) {\n  switch (type) {\n    case SOCKET:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = false;\n      break;\n    case IPC:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = true;\n      break;\n  }\n  new PipeWrap(env, args.This(), provider, ipc);\n}\nPipeWrap::PipeWrap(Environment* env,\n                   Local<Object> object,\n                   ProviderType provider,\n                   bool ipc)\n    : ConnectionWrap(env, object, provider) {\n  int r = uv_pipe_init(env->event_loop(), &handle_, ipc);\n}\n// deps/uv/src/unix/pipe.c\nint uv_pipe_init(uv_loop_t* loop, uv_pipe_t* handle, int ipc) {\n  uv__stream_init(loop, (uv_stream_t*)handle, UV_NAMED_PIPE);\n  handle->shutdown_req = NULL;\n  handle->connect_req = NULL;\n  handle->pipe_fname = NULL;\n  handle->ipc = ipc;\n  return 0;\n}\n```\n\n`uv_pipe_t` ipc  true  false** libuv **\n\n`ChildProcess.prototype.spawn` stdio `this._handle.spawn(options);``process_wrap.cc` ProcessWrap.Spawn `uv_spawn`\n\n```c\n// deps/uv/src/unix/process.c\nint uv_spawn(uv_loop_t* loop,\n             uv_process_t* process,\n             const uv_process_options_t* options) {\n#if defined(__APPLE__) && (TARGET_OS_TV || TARGET_OS_WATCH)\n  /* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */\n  return UV_ENOSYS;\n#else\n  // ...\n\n  uv_signal_start(&loop->child_watcher, uv__chld, SIGCHLD);\n\n  /* Acquire write lock to prevent opening new fds in worker threads */\n  uv_rwlock_wrlock(&loop->cloexec_lock);\n  pid = fork();\n\n  if (pid == -1) {\n    err = UV__ERR(errno);\n    uv_rwlock_wrunlock(&loop->cloexec_lock);\n    uv__close(signal_pipe[0]);\n    uv__close(signal_pipe[1]);\n    goto error;\n  }\n\n  if (pid == 0) {\n    uv__process_child_init(options, stdio_count, pipes, signal_pipe[1]);\n    abort();\n  }\n\n  /* Release lock in parent process */\n  uv_rwlock_wrunlock(&loop->cloexec_lock);\n  uv__close(signal_pipe[1]);\n\n  // ...\n}\n```\n\n`fork` fork  0 `uv__process_child_init`\n\n`ChildProcess.prototype.spawn``stdio` handle `createSocket` socket \n\n```javascript\nfunction createSocket(pipe, readable) {\n  return net.Socket({ handle: pipe, readable, writable: !readable });\n}\n```\n\n`stdio` pipe  ipc  socket stdinstdout  stderr `exec``execFile``fork` ipc  stdio  fork  send `setupChannel`\n\n<br/>\n\n<br/>\n\n****Node.js `child_process` JavaScript  libuv  cluster.fork  child_process.fork \n","source":"_posts/child_process-exec-fork-spawn.md","raw":"---\ntitle: Node.js\ncategory: JavaScript\nkeywords: Node.js,,Node.js\ndescription: Node.js child_process, execexecFileforkspawncluster, fork\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-04-06T08:09:36.472Z\n---\n\n**Node.js **\n\n**child_process**\n\n- [exec](http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback):  shell  shell  `command` 1024\\*1024 \n- [execFile](http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback): `exec` shell `file` `exec` `exec` 1024\\*1204 \n- [fork](http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options):  `spawn` Node.js  `spawn``ChildProcess` `ChildProcess`\n- [spawn](http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options):  spawn \n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): \n\n<!-- more -->\n\n<br/>\n\n### ****\n\n[libuv & Node.js EventLoop ](https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/)\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**child_process**\n\n```javascript\nNode \n  - lib \n  \t- internal \n  \t\t- child_process.js \n  \t- child_process.js;\n```\n\n`lib/child_process.js``exec``execFile``fork``spawn``lib/internal/child_process.js``spawn`\n\n<br/>\n\n**exec**\n\n```javascript\n// lib/child_process.js\nfunction exec(command, options, callback) {\n  const opts = normalizeExecArgs(command, options, callback);\n  return module.exports.execFile(opts.file, opts.options, opts.callback);\n}\nfunction normalizeExecArgs(command, options, callback) {\n  if (typeof options === \"function\") {\n    callback = options;\n    options = undefined;\n  }\n\n  // Make a shallow copy so we don't clobber the user's options object.\n  options = { ...options };\n  options.shell = typeof options.shell === \"string\" ? options.shell : true;\n\n  return {\n    file: command,\n    options: options,\n    callback: callback,\n  };\n}\n```\n\n exec `shell` execFile \n\n<br/>\n\n**execFile**\n\n```javascript\n// lib/child_process.js\nfunction execFile(file /* , args, options, callback */) {\n  let args = [];\n  let callback;\n  let options;\n\n  // ...\n\n  options = {\n    encoding: \"utf8\",\n    timeout: 0,\n    maxBuffer: MAX_BUFFER,\n    killSignal: \"SIGTERM\",\n    cwd: null,\n    env: null,\n    shell: false, // execFile shell\n    ...options,\n  };\n\n  // spawn\n  const child = spawn(file, args, {\n    cwd: options.cwd,\n    env: options.env,\n    gid: options.gid,\n    uid: options.uid,\n    shell: options.shell,\n    windowsHide: !!options.windowsHide,\n    windowsVerbatimArguments: !!options.windowsVerbatimArguments,\n  });\n\n  var encoding;\n  const _stdout = []; // \n  const _stderr = []; // \n  // ...\n  var stdoutLen = 0; // \n  var stderrLen = 0; // \n  var killed = false; // \n  var exited = false; // \n  var timeoutId; // \n\n  var ex = null; // \n\n  var cmd = file; // \n\n  // \n  function exithandler(code, signal) {\n    if (exited) return;\n    exited = true;\n\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      timeoutId = null;\n    }\n\n    if (!callback) return;\n\n    // merge chunks\n    var stdout;\n    var stderr;\n    if (encoding || (child.stdout && child.stdout.readableEncoding)) {\n      stdout = _stdout.join(\"\");\n    } else {\n      stdout = Buffer.concat(_stdout); //  encoding Buffer\n    }\n    if (encoding || (child.stderr && child.stderr.readableEncoding)) {\n      stderr = _stderr.join(\"\");\n    } else {\n      stderr = Buffer.concat(_stderr); //  encoding Buffer\n    }\n\n    if (!ex && code === 0 && signal === null) {\n      callback(null, stdout, stderr); // \n      return;\n    }\n\n    if (args.length !== 0) cmd += ` ${args.join(\" \")}`;\n\n    if (!ex) {\n      // eslint-disable-next-line no-restricted-syntax\n      ex = new Error(\"Command failed: \" + cmd + \"\\n\" + stderr);\n      ex.killed = child.killed || killed;\n      ex.code = code < 0 ? getSystemErrorName(code) : code;\n      ex.signal = signal;\n    }\n\n    ex.cmd = cmd;\n    callback(ex, stdout, stderr); // \n  }\n\n  function errorhandler(e) {\n    ex = e;\n\n    // child.stdout  child.stderr \n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    exithandler();\n  }\n\n  function kill() {\n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    killed = true;\n    try {\n      child.kill(options.killSignal);\n    } catch (e) {\n      ex = e;\n      exithandler();\n    }\n  }\n\n  // \n  if (options.timeout > 0) {\n    timeoutId = setTimeout(function delayedKill() {\n      kill();\n      timeoutId = null;\n    }, options.timeout);\n  }\n\n  if (child.stdout) {\n    if (encoding) child.stdout.setEncoding(encoding);\n\n    child.stdout.on(\"data\", function onChildStdout(chunk) {\n      const encoding = child.stdout.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stdoutLen += length; // \n\n      if (stdoutLen > options.maxBuffer) {\n        // \n        const truncatedLen = options.maxBuffer - (stdoutLen - length);\n        _stdout.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stdout\");\n        kill();\n      } else {\n        _stdout.push(chunk); // chunk\n      }\n    });\n  }\n\n  // child.stdout\n  if (child.stderr) {\n    if (encoding) child.stderr.setEncoding(encoding);\n\n    child.stderr.on(\"data\", function onChildStderr(chunk) {\n      const encoding = child.stderr.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stderrLen += length;\n\n      if (stderrLen > options.maxBuffer) {\n        const truncatedLen = options.maxBuffer - (stderrLen - length);\n        _stderr.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stderr\");\n        kill();\n      } else {\n        _stderr.push(chunk);\n      }\n    });\n  }\n\n  child.addListener(\"close\", exithandler);\n  child.addListener(\"error\", errorhandler);\n\n  return child;\n}\n```\n\n`exec``execFile``shell``child.stderr.on('data')``child.stdout.on('data')`\n\n`_stderr``_stdout`\n\n**`spawn`**\n\n<br/>\n\n**fork**\n\n```javascript\n// lib/child_process.js\nfunction fork(modulePath /* , args, options */) {\n  // Get options and args arguments.\n  var execArgv;\n  var options = {};\n  var args = [];\n\n  // ...\n\n  // forkstdioipc\n  if (typeof options.stdio === \"string\") {\n    options.stdio = stdioStringToArray(options.stdio, \"ipc\");\n  } else if (!Array.isArray(options.stdio)) {\n    // Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,\n    // and stderr from the parent if silent isn't set.\n    options.stdio = stdioStringToArray(\n      options.silent ? \"pipe\" : \"inherit\",\n      \"ipc\"\n    );\n  } else if (!options.stdio.includes(\"ipc\")) {\n    throw new ERR_CHILD_PROCESS_IPC_REQUIRED(\"options.stdio\");\n  }\n\n  options.execPath = options.execPath || process.execPath; // Node\n  options.shell = false; //  shell\n\n  return spawn(options.execPath, args, options);\n}\n```\n\n 12~22 fork  stdio  ipc `ipc``spawn`\n\n<br/>\n\n**spawn**\n\n```javascript\n// lib/child_process.js\nfunction spawn(file, args, options) {\n  const child = new ChildProcess();\n\n  options = normalizeSpawnArguments(file, args, options);\n  debug(\"spawn\", options);\n  child.spawn(options);\n\n  return child;\n}\n```\n\n`lib/child_process.js` spawn  ChildProcess  spawn\n\n<br/>\n\n**ChildProcess**\n\n```javascript\n// `lib/internal/child_process.js`\nfunction ChildProcess() {\n  EventEmitter.call(this);\n\n  // ...\n\n  this._handle = new Process(); // new  ProcessWrap   process_wrap.cc\n}\n\nChildProcess.prototype.spawn = function (options) {\n  let i = 0;\n\n  //  pipe\n  let stdio = options.stdio || \"pipe\";\n\n  // stdio\n  stdio = getValidStdio(stdio, false);\n\n  const ipc = stdio.ipc;\n  const ipcFd = stdio.ipcFd;\n  stdio = options.stdio = stdio.stdio;\n\n  // ...\n\n  // ProcessWrapspawn\n  const err = this._handle.spawn(options);\n\n  // err\n  // ...\n\n  this.pid = this._handle.pid;\n\n  for (i = 0; i < stdio.length; i++) {\n    const stream = stdio[i];\n    // ...\n    if (stream.handle) {\n      // When i === 0 - we're dealing with stdin\n      // (which is the only one writable pipe).\n      //  socket\n      stream.socket = createSocket(\n        this.pid !== 0 ? stream.handle : null,\n        i > 0\n      );\n\n      if (i > 0 && this.pid !== 0) {\n        this._closesNeeded++;\n        stream.socket.on(\"close\", () => {\n          maybeClose(this);\n        });\n      }\n    }\n  }\n  this.stdin =\n    stdio.length >= 1 && stdio[0].socket !== undefined ? stdio[0].socket : null;\n  this.stdout =\n    stdio.length >= 2 && stdio[1].socket !== undefined ? stdio[1].socket : null;\n  this.stderr =\n    stdio.length >= 3 && stdio[2].socket !== undefined ? stdio[2].socket : null;\n\n  this.stdio = [];\n\n  for (i = 0; i < stdio.length; i++)\n    this.stdio.push(stdio[i].socket === undefined ? null : stdio[i].socket);\n\n  // Add .send() method and start listening for IPC data\n  // setupChannel \n  if (ipc !== undefined) setupChannel(this, ipc);\n\n  return err;\n};\n\nfunction stdioStringToArray(stdio, channel) {\n  // stdio[xxx,xxx,xxx]\n  // channel[xxx,xxx,xxx,channel]\n}\n\nfunction getValidStdio(stdio, sync) {\n  var ipc;\n  var ipcFd;\n\n  stdio = stdio.reduce((acc, stdio, i) => {\n    function cleanup() {\n      for (var i = 0; i < acc.length; i++) {\n        if ((acc[i].type === \"pipe\" || acc[i].type === \"ipc\") && acc[i].handle)\n          acc[i].handle.close();\n      }\n    }\n\n    if (stdio === \"ignore\") {\n      acc.push({ type: \"ignore\" }); // \n    } else if (stdio === \"pipe\" || (typeof stdio === \"number\" && stdio < 0)) {\n      var a = {\n        type: \"pipe\",\n        readable: i === 0, // 0stdin\n        writable: i !== 0, // 1stdout2stderr \n      };\n      // spawn syncfalsestdinstdoutstderrSOCKETPipe\n      if (!sync) a.handle = new Pipe(PipeConstants.SOCKET);\n\n      acc.push(a);\n    } else if (stdio === \"ipc\") {\n      // IPCPipe\n      ipc = new Pipe(PipeConstants.IPC);\n      ipcFd = i; // ipc\n\n      acc.push({\n        type: \"pipe\",\n        handle: ipc,\n        ipc: true,\n      });\n    } else if (stdio === \"inherit\") {\n      acc.push({\n        type: \"inherit\",\n        fd: i,\n      });\n    }\n    // ...\n    return acc;\n  }, []);\n\n  return { stdio, ipc, ipcFd };\n}\n```\n\n`ChildProcess` V8  new ProcessWrap  this.\\_handle\n\n`ChildProcess.prototype.spawn`[`stdio`](http://nodejs.cn/api/child_process.html#child_process_options_stdio)`pipe``ipc` Pipe \n\n```c\n// pipe_wrap.cc\nvoid PipeWrap::New(const FunctionCallbackInfo<Value>& args) {\n  switch (type) {\n    case SOCKET:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = false;\n      break;\n    case IPC:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = true;\n      break;\n  }\n  new PipeWrap(env, args.This(), provider, ipc);\n}\nPipeWrap::PipeWrap(Environment* env,\n                   Local<Object> object,\n                   ProviderType provider,\n                   bool ipc)\n    : ConnectionWrap(env, object, provider) {\n  int r = uv_pipe_init(env->event_loop(), &handle_, ipc);\n}\n// deps/uv/src/unix/pipe.c\nint uv_pipe_init(uv_loop_t* loop, uv_pipe_t* handle, int ipc) {\n  uv__stream_init(loop, (uv_stream_t*)handle, UV_NAMED_PIPE);\n  handle->shutdown_req = NULL;\n  handle->connect_req = NULL;\n  handle->pipe_fname = NULL;\n  handle->ipc = ipc;\n  return 0;\n}\n```\n\n`uv_pipe_t` ipc  true  false** libuv **\n\n`ChildProcess.prototype.spawn` stdio `this._handle.spawn(options);``process_wrap.cc` ProcessWrap.Spawn `uv_spawn`\n\n```c\n// deps/uv/src/unix/process.c\nint uv_spawn(uv_loop_t* loop,\n             uv_process_t* process,\n             const uv_process_options_t* options) {\n#if defined(__APPLE__) && (TARGET_OS_TV || TARGET_OS_WATCH)\n  /* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */\n  return UV_ENOSYS;\n#else\n  // ...\n\n  uv_signal_start(&loop->child_watcher, uv__chld, SIGCHLD);\n\n  /* Acquire write lock to prevent opening new fds in worker threads */\n  uv_rwlock_wrlock(&loop->cloexec_lock);\n  pid = fork();\n\n  if (pid == -1) {\n    err = UV__ERR(errno);\n    uv_rwlock_wrunlock(&loop->cloexec_lock);\n    uv__close(signal_pipe[0]);\n    uv__close(signal_pipe[1]);\n    goto error;\n  }\n\n  if (pid == 0) {\n    uv__process_child_init(options, stdio_count, pipes, signal_pipe[1]);\n    abort();\n  }\n\n  /* Release lock in parent process */\n  uv_rwlock_wrunlock(&loop->cloexec_lock);\n  uv__close(signal_pipe[1]);\n\n  // ...\n}\n```\n\n`fork` fork  0 `uv__process_child_init`\n\n`ChildProcess.prototype.spawn``stdio` handle `createSocket` socket \n\n```javascript\nfunction createSocket(pipe, readable) {\n  return net.Socket({ handle: pipe, readable, writable: !readable });\n}\n```\n\n`stdio` pipe  ipc  socket stdinstdout  stderr `exec``execFile``fork` ipc  stdio  fork  send `setupChannel`\n\n<br/>\n\n<br/>\n\n****Node.js `child_process` JavaScript  libuv  cluster.fork  child_process.fork \n","slug":"child_process-exec-fork-spawn","published":1,"updated":"2020-07-07T10:11:25.586Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs5w000ad12irl0yaj38","content":"<p><strong>Node.js </strong></p>\n<p><strong>child_process</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback\" target=\"_blank\" rel=\"noopener\">exec</a>:  shell  shell  <code>command</code> 1024*1024 </li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback\" target=\"_blank\" rel=\"noopener\">execFile</a>: <code>exec</code> shell <code>file</code> <code>exec</code> <code>exec</code> 1024*1204 </li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options\" target=\"_blank\" rel=\"noopener\">fork</a>:  <code>spawn</code> Node.js  <code>spawn</code><code>ChildProcess</code> <code>ChildProcess</code></li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options\" target=\"_blank\" rel=\"noopener\">spawn</a>:  spawn </li>\n</ul>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\" target=\"_blank\" rel=\"noopener\">fork</a>: </li>\n</ul>\n<a id=\"more\"></a>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h3><p><a href=\"https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/\" target=\"_blank\" rel=\"noopener\">libuv &amp; Node.js EventLoop </a></p>\n<figure class=\"highlight markdown hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p><strong>child_process</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Node </span><br><span class=\"line\">  - lib </span><br><span class=\"line\">  \t- internal </span><br><span class=\"line\">  \t\t- child_process.js </span><br><span class=\"line\">  \t- child_process.js;</span><br></pre></td></tr></table></figure>\n<p><code>lib/child_process.js</code><code>exec</code><code>execFile</code><code>fork</code><code>spawn</code><code>lib/internal/child_process.js</code><code>spawn</code></p>\n<p><br></p>\n<p><strong>exec</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">exec</span>(<span class=\"hljs-params\">command, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> opts = normalizeExecArgs(command, options, callback);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">module</span>.exports.execFile(opts.file, opts.options, opts.callback);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">normalizeExecArgs</span>(<span class=\"hljs-params\">command, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> options === <span class=\"hljs-string\">\"function\"</span>) &#123;</span><br><span class=\"line\">    callback = options;</span><br><span class=\"line\">    options = <span class=\"hljs-literal\">undefined</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Make a shallow copy so we don't clobber the user's options object.</span></span><br><span class=\"line\">  options = &#123; ...options &#125;;</span><br><span class=\"line\">  options.shell = <span class=\"hljs-keyword\">typeof</span> options.shell === <span class=\"hljs-string\">\"string\"</span> ? options.shell : <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> &#123;</span><br><span class=\"line\">    file: command,</span><br><span class=\"line\">    options: options,</span><br><span class=\"line\">    callback: callback,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> exec <code>shell</code> execFile </p>\n<p><br></p>\n<p><strong>execFile</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">execFile</span>(<span class=\"hljs-params\">file <span class=\"hljs-regexp\">/* , args, options, callback */</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> args = [];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> callback;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> options;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  options = &#123;</span><br><span class=\"line\">    encoding: <span class=\"hljs-string\">\"utf8\"</span>,</span><br><span class=\"line\">    timeout: <span class=\"hljs-number\">0</span>,</span><br><span class=\"line\">    maxBuffer: MAX_BUFFER,</span><br><span class=\"line\">    killSignal: <span class=\"hljs-string\">\"SIGTERM\"</span>,</span><br><span class=\"line\">    cwd: <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">    env: <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">    shell: <span class=\"hljs-literal\">false</span>, <span class=\"hljs-comment\">// execFile shell</span></span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// spawn</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> child = spawn(file, args, &#123;</span><br><span class=\"line\">    cwd: options.cwd,</span><br><span class=\"line\">    env: options.env,</span><br><span class=\"line\">    gid: options.gid,</span><br><span class=\"line\">    uid: options.uid,</span><br><span class=\"line\">    shell: options.shell,</span><br><span class=\"line\">    windowsHide: !!options.windowsHide,</span><br><span class=\"line\">    windowsVerbatimArguments: !!options.windowsVerbatimArguments,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> encoding;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> _stdout = []; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> _stderr = []; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> stdoutLen = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> stderrLen = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> killed = <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> exited = <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> timeoutId; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> ex = <span class=\"hljs-literal\">null</span>; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> cmd = file; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">exithandler</span>(<span class=\"hljs-params\">code, signal</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (exited) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    exited = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (timeoutId) &#123;</span><br><span class=\"line\">      clearTimeout(timeoutId);</span><br><span class=\"line\">      timeoutId = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!callback) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// merge chunks</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> stdout;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> stderr;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding || (child.stdout &amp;&amp; child.stdout.readableEncoding)) &#123;</span><br><span class=\"line\">      stdout = _stdout.join(<span class=\"hljs-string\">\"\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">      stdout = Buffer.concat(_stdout); <span class=\"hljs-comment\">//  encoding Buffer</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding || (child.stderr &amp;&amp; child.stderr.readableEncoding)) &#123;</span><br><span class=\"line\">      stderr = _stderr.join(<span class=\"hljs-string\">\"\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">      stderr = Buffer.concat(_stderr); <span class=\"hljs-comment\">//  encoding Buffer</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!ex &amp;&amp; code === <span class=\"hljs-number\">0</span> &amp;&amp; signal === <span class=\"hljs-literal\">null</span>) &#123;</span><br><span class=\"line\">      callback(<span class=\"hljs-literal\">null</span>, stdout, stderr); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (args.length !== <span class=\"hljs-number\">0</span>) cmd += <span class=\"hljs-string\">` <span class=\"hljs-subst\">$&#123;args.join(<span class=\"hljs-string\">\" \"</span>)&#125;</span>`</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!ex) &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// eslint-disable-next-line no-restricted-syntax</span></span><br><span class=\"line\">      ex = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Error</span>(<span class=\"hljs-string\">\"Command failed: \"</span> + cmd + <span class=\"hljs-string\">\"\\n\"</span> + stderr);</span><br><span class=\"line\">      ex.killed = child.killed || killed;</span><br><span class=\"line\">      ex.code = code &lt; <span class=\"hljs-number\">0</span> ? getSystemErrorName(code) : code;</span><br><span class=\"line\">      ex.signal = signal;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ex.cmd = cmd;</span><br><span class=\"line\">    callback(ex, stdout, stderr); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorhandler</span>(<span class=\"hljs-params\">e</span>) </span>&#123;</span><br><span class=\"line\">    ex = e;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// child.stdout  child.stderr </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.stdout) child.stdout.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.stderr) child.stderr.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    exithandler();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">kill</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.stdout) child.stdout.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.stderr) child.stderr.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    killed = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">      child.kill(options.killSignal);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">      ex = e;</span><br><span class=\"line\">      exithandler();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (options.timeout &gt; <span class=\"hljs-number\">0</span>) &#123;</span><br><span class=\"line\">    timeoutId = setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">delayedKill</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">      kill();</span><br><span class=\"line\">      timeoutId = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">    &#125;, options.timeout);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (child.stdout) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding) child.stdout.setEncoding(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.stdout.on(<span class=\"hljs-string\">\"data\"</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">onChildStdout</span>(<span class=\"hljs-params\">chunk</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> encoding = child.stdout.readableEncoding;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? Buffer.byteLength(chunk, encoding)</span><br><span class=\"line\">        : chunk.length;</span><br><span class=\"line\">      stdoutLen += length; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (stdoutLen &gt; options.maxBuffer) &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> truncatedLen = options.maxBuffer - (stdoutLen - length);</span><br><span class=\"line\">        _stdout.push(chunk.slice(<span class=\"hljs-number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"hljs-keyword\">new</span> ERR_CHILD_PROCESS_STDIO_MAXBUFFER(<span class=\"hljs-string\">\"stdout\"</span>);</span><br><span class=\"line\">        kill();</span><br><span class=\"line\">      &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">        _stdout.push(chunk); <span class=\"hljs-comment\">// chunk</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// child.stdout</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (child.stderr) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding) child.stderr.setEncoding(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.stderr.on(<span class=\"hljs-string\">\"data\"</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">onChildStderr</span>(<span class=\"hljs-params\">chunk</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> encoding = child.stderr.readableEncoding;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? Buffer.byteLength(chunk, encoding)</span><br><span class=\"line\">        : chunk.length;</span><br><span class=\"line\">      stderrLen += length;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (stderrLen &gt; options.maxBuffer) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> truncatedLen = options.maxBuffer - (stderrLen - length);</span><br><span class=\"line\">        _stderr.push(chunk.slice(<span class=\"hljs-number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"hljs-keyword\">new</span> ERR_CHILD_PROCESS_STDIO_MAXBUFFER(<span class=\"hljs-string\">\"stderr\"</span>);</span><br><span class=\"line\">        kill();</span><br><span class=\"line\">      &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">        _stderr.push(chunk);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  child.addListener(<span class=\"hljs-string\">\"close\"</span>, exithandler);</span><br><span class=\"line\">  child.addListener(<span class=\"hljs-string\">\"error\"</span>, errorhandler);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> child;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>exec</code><code>execFile</code><code>shell</code><code>child.stderr.on(&#39;data&#39;)</code><code>child.stdout.on(&#39;data&#39;)</code></p>\n<p><code>_stderr</code><code>_stdout</code></p>\n<p><strong><code>spawn</code></strong></p>\n<p><br></p>\n<p><strong>fork</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">fork</span>(<span class=\"hljs-params\">modulePath <span class=\"hljs-regexp\">/* , args, options */</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// Get options and args arguments.</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> execArgv;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> options = &#123;&#125;;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> args = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// forkstdioipc</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> options.stdio === <span class=\"hljs-string\">\"string\"</span>) &#123;</span><br><span class=\"line\">    options.stdio = stdioStringToArray(options.stdio, <span class=\"hljs-string\">\"ipc\"</span>);</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-built_in\">Array</span>.isArray(options.stdio)) &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// and stderr from the parent if silent isn't set.</span></span><br><span class=\"line\">    options.stdio = stdioStringToArray(</span><br><span class=\"line\">      options.silent ? <span class=\"hljs-string\">\"pipe\"</span> : <span class=\"hljs-string\">\"inherit\"</span>,</span><br><span class=\"line\">      <span class=\"hljs-string\">\"ipc\"</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!options.stdio.includes(<span class=\"hljs-string\">\"ipc\"</span>)) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> ERR_CHILD_PROCESS_IPC_REQUIRED(<span class=\"hljs-string\">\"options.stdio\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  options.execPath = options.execPath || process.execPath; <span class=\"hljs-comment\">// Node</span></span><br><span class=\"line\">  options.shell = <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">//  shell</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> spawn(options.execPath, args, options);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> 12~22 fork  stdio  ipc <code>ipc</code><code>spawn</code></p>\n<p><br></p>\n<p><strong>spawn</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">spawn</span>(<span class=\"hljs-params\">file, args, options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> child = <span class=\"hljs-keyword\">new</span> ChildProcess();</span><br><span class=\"line\"></span><br><span class=\"line\">  options = normalizeSpawnArguments(file, args, options);</span><br><span class=\"line\">  debug(<span class=\"hljs-string\">\"spawn\"</span>, options);</span><br><span class=\"line\">  child.spawn(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> child;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>lib/child_process.js</code> spawn  ChildProcess  spawn</p>\n<p><br></p>\n<p><strong>ChildProcess</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// `lib/internal/child_process.js`</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">ChildProcess</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  EventEmitter.call(<span class=\"hljs-keyword\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>._handle = <span class=\"hljs-keyword\">new</span> Process(); <span class=\"hljs-comment\">// new  ProcessWrap   process_wrap.cc</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">ChildProcess.prototype.spawn = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  pipe</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> stdio = options.stdio || <span class=\"hljs-string\">\"pipe\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// stdio</span></span><br><span class=\"line\">  stdio = getValidStdio(stdio, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> ipc = stdio.ipc;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> ipcFd = stdio.ipcFd;</span><br><span class=\"line\">  stdio = options.stdio = stdio.stdio;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ProcessWrapspawn</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> err = <span class=\"hljs-keyword\">this</span>._handle.spawn(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// err</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.pid = <span class=\"hljs-keyword\">this</span>._handle.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; stdio.length; i++) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> stream = stdio[i];</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (stream.handle) &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// When i === 0 - we're dealing with stdin</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// (which is the only one writable pipe).</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">//  socket</span></span><br><span class=\"line\">      stream.socket = createSocket(</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.pid !== <span class=\"hljs-number\">0</span> ? stream.handle : <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">        i &gt; <span class=\"hljs-number\">0</span></span><br><span class=\"line\">      );</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (i &gt; <span class=\"hljs-number\">0</span> &amp;&amp; <span class=\"hljs-keyword\">this</span>.pid !== <span class=\"hljs-number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>._closesNeeded++;</span><br><span class=\"line\">        stream.socket.on(<span class=\"hljs-string\">\"close\"</span>, () =&gt; &#123;</span><br><span class=\"line\">          maybeClose(<span class=\"hljs-keyword\">this</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.stdin =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"hljs-number\">1</span> &amp;&amp; stdio[<span class=\"hljs-number\">0</span>].socket !== <span class=\"hljs-literal\">undefined</span> ? stdio[<span class=\"hljs-number\">0</span>].socket : <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.stdout =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"hljs-number\">2</span> &amp;&amp; stdio[<span class=\"hljs-number\">1</span>].socket !== <span class=\"hljs-literal\">undefined</span> ? stdio[<span class=\"hljs-number\">1</span>].socket : <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.stderr =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"hljs-number\">3</span> &amp;&amp; stdio[<span class=\"hljs-number\">2</span>].socket !== <span class=\"hljs-literal\">undefined</span> ? stdio[<span class=\"hljs-number\">2</span>].socket : <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.stdio = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; stdio.length; i++)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.stdio.push(stdio[i].socket === <span class=\"hljs-literal\">undefined</span> ? <span class=\"hljs-literal\">null</span> : stdio[i].socket);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Add .send() method and start listening for IPC data</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// setupChannel </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (ipc !== <span class=\"hljs-literal\">undefined</span>) setupChannel(<span class=\"hljs-keyword\">this</span>, ipc);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> err;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">stdioStringToArray</span>(<span class=\"hljs-params\">stdio, channel</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// stdio[xxx,xxx,xxx]</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// channel[xxx,xxx,xxx,channel]</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getValidStdio</span>(<span class=\"hljs-params\">stdio, sync</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> ipc;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> ipcFd;</span><br><span class=\"line\"></span><br><span class=\"line\">  stdio = stdio.reduce(<span class=\"hljs-function\">(<span class=\"hljs-params\">acc, stdio, i</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">cleanup</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; acc.length; i++) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> ((acc[i].type === <span class=\"hljs-string\">\"pipe\"</span> || acc[i].type === <span class=\"hljs-string\">\"ipc\"</span>) &amp;&amp; acc[i].handle)</span><br><span class=\"line\">          acc[i].handle.close();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"ignore\"</span>) &#123;</span><br><span class=\"line\">      acc.push(&#123; <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">\"ignore\"</span> &#125;); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"pipe\"</span> || (<span class=\"hljs-keyword\">typeof</span> stdio === <span class=\"hljs-string\">\"number\"</span> &amp;&amp; stdio &lt; <span class=\"hljs-number\">0</span>)) &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">var</span> a = &#123;</span><br><span class=\"line\">        type: <span class=\"hljs-string\">\"pipe\"</span>,</span><br><span class=\"line\">        readable: i === <span class=\"hljs-number\">0</span>, <span class=\"hljs-comment\">// 0stdin</span></span><br><span class=\"line\">        writable: i !== <span class=\"hljs-number\">0</span>, <span class=\"hljs-comment\">// 1stdout2stderr </span></span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// spawn syncfalsestdinstdoutstderrSOCKETPipe</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (!sync) a.handle = <span class=\"hljs-keyword\">new</span> Pipe(PipeConstants.SOCKET);</span><br><span class=\"line\"></span><br><span class=\"line\">      acc.push(a);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"ipc\"</span>) &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// IPCPipe</span></span><br><span class=\"line\">      ipc = <span class=\"hljs-keyword\">new</span> Pipe(PipeConstants.IPC);</span><br><span class=\"line\">      ipcFd = i; <span class=\"hljs-comment\">// ipc</span></span><br><span class=\"line\"></span><br><span class=\"line\">      acc.push(&#123;</span><br><span class=\"line\">        type: <span class=\"hljs-string\">\"pipe\"</span>,</span><br><span class=\"line\">        handle: ipc,</span><br><span class=\"line\">        ipc: <span class=\"hljs-literal\">true</span>,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"inherit\"</span>) &#123;</span><br><span class=\"line\">      acc.push(&#123;</span><br><span class=\"line\">        type: <span class=\"hljs-string\">\"inherit\"</span>,</span><br><span class=\"line\">        fd: i,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> acc;</span><br><span class=\"line\">  &#125;, []);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> &#123; stdio, ipc, ipcFd &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>ChildProcess</code> V8  new ProcessWrap  this._handle</p>\n<p><code>ChildProcess.prototype.spawn</code><a href=\"http://nodejs.cn/api/child_process.html#child_process_options_stdio\" target=\"_blank\" rel=\"noopener\"><code>stdio</code></a><code>pipe</code><code>ipc</code> Pipe </p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// pipe_wrap.cc</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">void</span> PipeWrap::New(<span class=\"hljs-keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args) &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">switch</span> (type) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">case</span> SOCKET:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">case</span> IPC:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">new</span> PipeWrap(env, args.This(), provider, ipc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">PipeWrap::PipeWrap(Environment* env,</span><br><span class=\"line\">                   Local&lt;Object&gt; object,</span><br><span class=\"line\">                   ProviderType provider,</span><br><span class=\"line\">                   <span class=\"hljs-keyword\">bool</span> ipc)</span><br><span class=\"line\">    : ConnectionWrap(env, object, provider) &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">int</span> r = uv_pipe_init(env-&gt;event_loop(), &amp;handle_, ipc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// deps/uv/src/unix/pipe.c</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">uv_pipe_init</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop, <span class=\"hljs-keyword\">uv_pipe_t</span>* handle, <span class=\"hljs-keyword\">int</span> ipc)</span> </span>&#123;</span><br><span class=\"line\">  uv__stream_init(loop, (<span class=\"hljs-keyword\">uv_stream_t</span>*)handle, UV_NAMED_PIPE);</span><br><span class=\"line\">  handle-&gt;shutdown_req = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;connect_req = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;pipe_fname = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;ipc = ipc;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>uv_pipe_t</code> ipc  true  false<strong> libuv </strong></p>\n<p><code>ChildProcess.prototype.spawn</code> stdio <code>this._handle.spawn(options);</code><code>process_wrap.cc</code> ProcessWrap.Spawn <code>uv_spawn</code></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// deps/uv/src/unix/process.c</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">uv_spawn</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">             <span class=\"hljs-keyword\">uv_process_t</span>* process,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">             <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">uv_process_options_t</span>* options)</span> </span>&#123;</span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">if</span> defined(__APPLE__) &amp;&amp; (TARGET_OS_TV || TARGET_OS_WATCH)</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> UV_ENOSYS;</span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">else</span></span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  uv_signal_start(&amp;loop-&gt;child_watcher, uv__chld, SIGCHLD);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* Acquire write lock to prevent opening new fds in worker threads */</span></span><br><span class=\"line\">  uv_rwlock_wrlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  pid = fork();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (pid == <span class=\"hljs-number\">-1</span>) &#123;</span><br><span class=\"line\">    err = UV__ERR(errno);</span><br><span class=\"line\">    uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"hljs-number\">0</span>]);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"hljs-number\">1</span>]);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">goto</span> error;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (pid == <span class=\"hljs-number\">0</span>) &#123;</span><br><span class=\"line\">    uv__process_child_init(options, stdio_count, pipes, signal_pipe[<span class=\"hljs-number\">1</span>]);</span><br><span class=\"line\">    <span class=\"hljs-built_in\">abort</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* Release lock in parent process */</span></span><br><span class=\"line\">  uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  uv__close(signal_pipe[<span class=\"hljs-number\">1</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>fork</code> fork  0 <code>uv__process_child_init</code></p>\n<p><code>ChildProcess.prototype.spawn</code><code>stdio</code> handle <code>createSocket</code> socket </p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">createSocket</span>(<span class=\"hljs-params\">pipe, readable</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> net.Socket(&#123; <span class=\"hljs-attr\">handle</span>: pipe, readable, <span class=\"hljs-attr\">writable</span>: !readable &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>stdio</code> pipe  ipc  socket stdinstdout  stderr <code>exec</code><code>execFile</code><code>fork</code> ipc  stdio  fork  send <code>setupChannel</code></p>\n<p><br></p>\n<p><br></p>\n<p><strong></strong>Node.js <code>child_process</code> JavaScript  libuv  cluster.fork  child_process.fork </p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p><strong>Node.js </strong></p>\n<p><strong>child_process</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback\" target=\"_blank\" rel=\"noopener\">exec</a>:  shell  shell  <code>command</code> 1024*1024 </li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback\" target=\"_blank\" rel=\"noopener\">execFile</a>: <code>exec</code> shell <code>file</code> <code>exec</code> <code>exec</code> 1024*1204 </li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options\" target=\"_blank\" rel=\"noopener\">fork</a>:  <code>spawn</code> Node.js  <code>spawn</code><code>ChildProcess</code> <code>ChildProcess</code></li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options\" target=\"_blank\" rel=\"noopener\">spawn</a>:  spawn </li>\n</ul>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\" target=\"_blank\" rel=\"noopener\">fork</a>: </li>\n</ul>","more":"<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h3><p><a href=\"https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/\" target=\"_blank\" rel=\"noopener\">libuv &amp; Node.js EventLoop </a></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"section\">#define V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"section\">#define V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"section\">#define V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"section\">#define V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"section\">#define NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"section\">#define NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"section\">#define NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p><strong>child_process</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Node </span><br><span class=\"line\">  - lib </span><br><span class=\"line\">  \t- internal </span><br><span class=\"line\">  \t\t- child_process.js </span><br><span class=\"line\">  \t- child_process.js;</span><br></pre></td></tr></table></figure>\n<p><code>lib/child_process.js</code><code>exec</code><code>execFile</code><code>fork</code><code>spawn</code><code>lib/internal/child_process.js</code><code>spawn</code></p>\n<p><br></p>\n<p><strong>exec</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">exec</span>(<span class=\"params\">command, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> opts = normalizeExecArgs(command, options, callback);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">module</span>.exports.execFile(opts.file, opts.options, opts.callback);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">normalizeExecArgs</span>(<span class=\"params\">command, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options === <span class=\"string\">\"function\"</span>) &#123;</span><br><span class=\"line\">    callback = options;</span><br><span class=\"line\">    options = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Make a shallow copy so we don't clobber the user's options object.</span></span><br><span class=\"line\">  options = &#123; ...options &#125;;</span><br><span class=\"line\">  options.shell = <span class=\"keyword\">typeof</span> options.shell === <span class=\"string\">\"string\"</span> ? options.shell : <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">    file: command,</span><br><span class=\"line\">    options: options,</span><br><span class=\"line\">    callback: callback,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> exec <code>shell</code> execFile </p>\n<p><br></p>\n<p><strong>execFile</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">execFile</span>(<span class=\"params\">file <span class=\"regexp\">/* , args, options, callback */</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> args = [];</span><br><span class=\"line\">  <span class=\"keyword\">let</span> callback;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> options;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  options = &#123;</span><br><span class=\"line\">    encoding: <span class=\"string\">\"utf8\"</span>,</span><br><span class=\"line\">    timeout: <span class=\"number\">0</span>,</span><br><span class=\"line\">    maxBuffer: MAX_BUFFER,</span><br><span class=\"line\">    killSignal: <span class=\"string\">\"SIGTERM\"</span>,</span><br><span class=\"line\">    cwd: <span class=\"literal\">null</span>,</span><br><span class=\"line\">    env: <span class=\"literal\">null</span>,</span><br><span class=\"line\">    shell: <span class=\"literal\">false</span>, <span class=\"comment\">// execFile shell</span></span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// spawn</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> child = spawn(file, args, &#123;</span><br><span class=\"line\">    cwd: options.cwd,</span><br><span class=\"line\">    env: options.env,</span><br><span class=\"line\">    gid: options.gid,</span><br><span class=\"line\">    uid: options.uid,</span><br><span class=\"line\">    shell: options.shell,</span><br><span class=\"line\">    windowsHide: !!options.windowsHide,</span><br><span class=\"line\">    windowsVerbatimArguments: !!options.windowsVerbatimArguments,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> encoding;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> _stdout = []; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> _stderr = []; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> stdoutLen = <span class=\"number\">0</span>; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> stderrLen = <span class=\"number\">0</span>; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> killed = <span class=\"literal\">false</span>; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> exited = <span class=\"literal\">false</span>; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> timeoutId; <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> ex = <span class=\"literal\">null</span>; <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> cmd = file; <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">exithandler</span>(<span class=\"params\">code, signal</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (exited) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    exited = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeoutId) &#123;</span><br><span class=\"line\">      clearTimeout(timeoutId);</span><br><span class=\"line\">      timeoutId = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!callback) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// merge chunks</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> stdout;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> stderr;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding || (child.stdout &amp;&amp; child.stdout.readableEncoding)) &#123;</span><br><span class=\"line\">      stdout = _stdout.join(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      stdout = Buffer.concat(_stdout); <span class=\"comment\">//  encoding Buffer</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding || (child.stderr &amp;&amp; child.stderr.readableEncoding)) &#123;</span><br><span class=\"line\">      stderr = _stderr.join(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      stderr = Buffer.concat(_stderr); <span class=\"comment\">//  encoding Buffer</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ex &amp;&amp; code === <span class=\"number\">0</span> &amp;&amp; signal === <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">      callback(<span class=\"literal\">null</span>, stdout, stderr); <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (args.length !== <span class=\"number\">0</span>) cmd += <span class=\"string\">` <span class=\"subst\">$&#123;args.join(<span class=\"string\">\" \"</span>)&#125;</span>`</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ex) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// eslint-disable-next-line no-restricted-syntax</span></span><br><span class=\"line\">      ex = <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">\"Command failed: \"</span> + cmd + <span class=\"string\">\"\\n\"</span> + stderr);</span><br><span class=\"line\">      ex.killed = child.killed || killed;</span><br><span class=\"line\">      ex.code = code &lt; <span class=\"number\">0</span> ? getSystemErrorName(code) : code;</span><br><span class=\"line\">      ex.signal = signal;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ex.cmd = cmd;</span><br><span class=\"line\">    callback(ex, stdout, stderr); <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorhandler</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">    ex = e;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// child.stdout  child.stderr </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.stdout) child.stdout.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.stderr) child.stderr.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    exithandler();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">kill</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.stdout) child.stdout.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.stderr) child.stderr.destroy();</span><br><span class=\"line\"></span><br><span class=\"line\">    killed = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      child.kill(options.killSignal);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">      ex = e;</span><br><span class=\"line\">      exithandler();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (options.timeout &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    timeoutId = setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">delayedKill</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      kill();</span><br><span class=\"line\">      timeoutId = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;, options.timeout);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (child.stdout) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding) child.stdout.setEncoding(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.stdout.on(<span class=\"string\">\"data\"</span>, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onChildStdout</span>(<span class=\"params\">chunk</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> encoding = child.stdout.readableEncoding;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? Buffer.byteLength(chunk, encoding)</span><br><span class=\"line\">        : chunk.length;</span><br><span class=\"line\">      stdoutLen += length; <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (stdoutLen &gt; options.maxBuffer) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> truncatedLen = options.maxBuffer - (stdoutLen - length);</span><br><span class=\"line\">        _stdout.push(chunk.slice(<span class=\"number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"keyword\">new</span> ERR_CHILD_PROCESS_STDIO_MAXBUFFER(<span class=\"string\">\"stdout\"</span>);</span><br><span class=\"line\">        kill();</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        _stdout.push(chunk); <span class=\"comment\">// chunk</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// child.stdout</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (child.stderr) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding) child.stderr.setEncoding(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.stderr.on(<span class=\"string\">\"data\"</span>, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onChildStderr</span>(<span class=\"params\">chunk</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> encoding = child.stderr.readableEncoding;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? Buffer.byteLength(chunk, encoding)</span><br><span class=\"line\">        : chunk.length;</span><br><span class=\"line\">      stderrLen += length;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (stderrLen &gt; options.maxBuffer) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> truncatedLen = options.maxBuffer - (stderrLen - length);</span><br><span class=\"line\">        _stderr.push(chunk.slice(<span class=\"number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"keyword\">new</span> ERR_CHILD_PROCESS_STDIO_MAXBUFFER(<span class=\"string\">\"stderr\"</span>);</span><br><span class=\"line\">        kill();</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        _stderr.push(chunk);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  child.addListener(<span class=\"string\">\"close\"</span>, exithandler);</span><br><span class=\"line\">  child.addListener(<span class=\"string\">\"error\"</span>, errorhandler);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> child;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>exec</code><code>execFile</code><code>shell</code><code>child.stderr.on(&#39;data&#39;)</code><code>child.stdout.on(&#39;data&#39;)</code></p>\n<p><code>_stderr</code><code>_stdout</code></p>\n<p><strong><code>spawn</code></strong></p>\n<p><br></p>\n<p><strong>fork</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">fork</span>(<span class=\"params\">modulePath <span class=\"regexp\">/* , args, options */</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// Get options and args arguments.</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> execArgv;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> options = &#123;&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> args = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// forkstdioipc</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options.stdio === <span class=\"string\">\"string\"</span>) &#123;</span><br><span class=\"line\">    options.stdio = stdioStringToArray(options.stdio, <span class=\"string\">\"ipc\"</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!<span class=\"built_in\">Array</span>.isArray(options.stdio)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,</span></span><br><span class=\"line\">    <span class=\"comment\">// and stderr from the parent if silent isn't set.</span></span><br><span class=\"line\">    options.stdio = stdioStringToArray(</span><br><span class=\"line\">      options.silent ? <span class=\"string\">\"pipe\"</span> : <span class=\"string\">\"inherit\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"ipc\"</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!options.stdio.includes(<span class=\"string\">\"ipc\"</span>)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ERR_CHILD_PROCESS_IPC_REQUIRED(<span class=\"string\">\"options.stdio\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  options.execPath = options.execPath || process.execPath; <span class=\"comment\">// Node</span></span><br><span class=\"line\">  options.shell = <span class=\"literal\">false</span>; <span class=\"comment\">//  shell</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> spawn(options.execPath, args, options);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> 12~22 fork  stdio  ipc <code>ipc</code><code>spawn</code></p>\n<p><br></p>\n<p><strong>spawn</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">spawn</span>(<span class=\"params\">file, args, options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> child = <span class=\"keyword\">new</span> ChildProcess();</span><br><span class=\"line\"></span><br><span class=\"line\">  options = normalizeSpawnArguments(file, args, options);</span><br><span class=\"line\">  debug(<span class=\"string\">\"spawn\"</span>, options);</span><br><span class=\"line\">  child.spawn(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> child;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>lib/child_process.js</code> spawn  ChildProcess  spawn</p>\n<p><br></p>\n<p><strong>ChildProcess</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// `lib/internal/child_process.js`</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ChildProcess</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  EventEmitter.call(<span class=\"keyword\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>._handle = <span class=\"keyword\">new</span> Process(); <span class=\"comment\">// new  ProcessWrap   process_wrap.cc</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">ChildProcess.prototype.spawn = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  pipe</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> stdio = options.stdio || <span class=\"string\">\"pipe\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// stdio</span></span><br><span class=\"line\">  stdio = getValidStdio(stdio, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> ipc = stdio.ipc;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> ipcFd = stdio.ipcFd;</span><br><span class=\"line\">  stdio = options.stdio = stdio.stdio;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ProcessWrapspawn</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> err = <span class=\"keyword\">this</span>._handle.spawn(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// err</span></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.pid = <span class=\"keyword\">this</span>._handle.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; stdio.length; i++) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> stream = stdio[i];</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (stream.handle) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// When i === 0 - we're dealing with stdin</span></span><br><span class=\"line\">      <span class=\"comment\">// (which is the only one writable pipe).</span></span><br><span class=\"line\">      <span class=\"comment\">//  socket</span></span><br><span class=\"line\">      stream.socket = createSocket(</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.pid !== <span class=\"number\">0</span> ? stream.handle : <span class=\"literal\">null</span>,</span><br><span class=\"line\">        i &gt; <span class=\"number\">0</span></span><br><span class=\"line\">      );</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (i &gt; <span class=\"number\">0</span> &amp;&amp; <span class=\"keyword\">this</span>.pid !== <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>._closesNeeded++;</span><br><span class=\"line\">        stream.socket.on(<span class=\"string\">\"close\"</span>, () =&gt; &#123;</span><br><span class=\"line\">          maybeClose(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.stdin =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"number\">1</span> &amp;&amp; stdio[<span class=\"number\">0</span>].socket !== <span class=\"literal\">undefined</span> ? stdio[<span class=\"number\">0</span>].socket : <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.stdout =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"number\">2</span> &amp;&amp; stdio[<span class=\"number\">1</span>].socket !== <span class=\"literal\">undefined</span> ? stdio[<span class=\"number\">1</span>].socket : <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.stderr =</span><br><span class=\"line\">    stdio.length &gt;= <span class=\"number\">3</span> &amp;&amp; stdio[<span class=\"number\">2</span>].socket !== <span class=\"literal\">undefined</span> ? stdio[<span class=\"number\">2</span>].socket : <span class=\"literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.stdio = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; stdio.length; i++)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.stdio.push(stdio[i].socket === <span class=\"literal\">undefined</span> ? <span class=\"literal\">null</span> : stdio[i].socket);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Add .send() method and start listening for IPC data</span></span><br><span class=\"line\">  <span class=\"comment\">// setupChannel </span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ipc !== <span class=\"literal\">undefined</span>) setupChannel(<span class=\"keyword\">this</span>, ipc);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> err;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">stdioStringToArray</span>(<span class=\"params\">stdio, channel</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// stdio[xxx,xxx,xxx]</span></span><br><span class=\"line\">  <span class=\"comment\">// channel[xxx,xxx,xxx,channel]</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getValidStdio</span>(<span class=\"params\">stdio, sync</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ipc;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ipcFd;</span><br><span class=\"line\"></span><br><span class=\"line\">  stdio = stdio.reduce(<span class=\"function\">(<span class=\"params\">acc, stdio, i</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cleanup</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; acc.length; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((acc[i].type === <span class=\"string\">\"pipe\"</span> || acc[i].type === <span class=\"string\">\"ipc\"</span>) &amp;&amp; acc[i].handle)</span><br><span class=\"line\">          acc[i].handle.close();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (stdio === <span class=\"string\">\"ignore\"</span>) &#123;</span><br><span class=\"line\">      acc.push(&#123; <span class=\"attr\">type</span>: <span class=\"string\">\"ignore\"</span> &#125;); <span class=\"comment\">// </span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (stdio === <span class=\"string\">\"pipe\"</span> || (<span class=\"keyword\">typeof</span> stdio === <span class=\"string\">\"number\"</span> &amp;&amp; stdio &lt; <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> a = &#123;</span><br><span class=\"line\">        type: <span class=\"string\">\"pipe\"</span>,</span><br><span class=\"line\">        readable: i === <span class=\"number\">0</span>, <span class=\"comment\">// 0stdin</span></span><br><span class=\"line\">        writable: i !== <span class=\"number\">0</span>, <span class=\"comment\">// 1stdout2stderr </span></span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">      <span class=\"comment\">// spawn syncfalsestdinstdoutstderrSOCKETPipe</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!sync) a.handle = <span class=\"keyword\">new</span> Pipe(PipeConstants.SOCKET);</span><br><span class=\"line\"></span><br><span class=\"line\">      acc.push(a);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (stdio === <span class=\"string\">\"ipc\"</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// IPCPipe</span></span><br><span class=\"line\">      ipc = <span class=\"keyword\">new</span> Pipe(PipeConstants.IPC);</span><br><span class=\"line\">      ipcFd = i; <span class=\"comment\">// ipc</span></span><br><span class=\"line\"></span><br><span class=\"line\">      acc.push(&#123;</span><br><span class=\"line\">        type: <span class=\"string\">\"pipe\"</span>,</span><br><span class=\"line\">        handle: ipc,</span><br><span class=\"line\">        ipc: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (stdio === <span class=\"string\">\"inherit\"</span>) &#123;</span><br><span class=\"line\">      acc.push(&#123;</span><br><span class=\"line\">        type: <span class=\"string\">\"inherit\"</span>,</span><br><span class=\"line\">        fd: i,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> acc;</span><br><span class=\"line\">  &#125;, []);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123; stdio, ipc, ipcFd &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>ChildProcess</code> V8  new ProcessWrap  this._handle</p>\n<p><code>ChildProcess.prototype.spawn</code><a href=\"http://nodejs.cn/api/child_process.html#child_process_options_stdio\" target=\"_blank\" rel=\"noopener\"><code>stdio</code></a><code>pipe</code><code>ipc</code> Pipe </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// pipe_wrap.cc</span></span><br><span class=\"line\"><span class=\"keyword\">void</span> PipeWrap::New(<span class=\"keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">switch</span> (type) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> SOCKET:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"literal\">false</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> IPC:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"literal\">true</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">new</span> PipeWrap(env, args.This(), provider, ipc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">PipeWrap::PipeWrap(Environment* env,</span><br><span class=\"line\">                   Local&lt;Object&gt; object,</span><br><span class=\"line\">                   ProviderType provider,</span><br><span class=\"line\">                   <span class=\"keyword\">bool</span> ipc)</span><br><span class=\"line\">    : ConnectionWrap(env, object, provider) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> r = uv_pipe_init(env-&gt;event_loop(), &amp;handle_, ipc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// deps/uv/src/unix/pipe.c</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">uv_pipe_init</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop, <span class=\"keyword\">uv_pipe_t</span>* handle, <span class=\"keyword\">int</span> ipc)</span> </span>&#123;</span><br><span class=\"line\">  uv__stream_init(loop, (<span class=\"keyword\">uv_stream_t</span>*)handle, UV_NAMED_PIPE);</span><br><span class=\"line\">  handle-&gt;shutdown_req = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;connect_req = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;pipe_fname = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;ipc = ipc;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>uv_pipe_t</code> ipc  true  false<strong> libuv </strong></p>\n<p><code>ChildProcess.prototype.spawn</code> stdio <code>this._handle.spawn(options);</code><code>process_wrap.cc</code> ProcessWrap.Spawn <code>uv_spawn</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// deps/uv/src/unix/process.c</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">uv_spawn</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">             <span class=\"keyword\">uv_process_t</span>* process,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">             <span class=\"keyword\">const</span> <span class=\"keyword\">uv_process_options_t</span>* options)</span> </span>&#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> defined(__APPLE__) &amp;&amp; (TARGET_OS_TV || TARGET_OS_WATCH)</span></span><br><span class=\"line\">  <span class=\"comment\">/* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> UV_ENOSYS;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">else</span></span></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  uv_signal_start(&amp;loop-&gt;child_watcher, uv__chld, SIGCHLD);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Acquire write lock to prevent opening new fds in worker threads */</span></span><br><span class=\"line\">  uv_rwlock_wrlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  pid = fork();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pid == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">    err = UV__ERR(errno);</span><br><span class=\"line\">    uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> error;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    uv__process_child_init(options, stdio_count, pipes, signal_pipe[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"built_in\">abort</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Release lock in parent process */</span></span><br><span class=\"line\">  uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  uv__close(signal_pipe[<span class=\"number\">1</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>fork</code> fork  0 <code>uv__process_child_init</code></p>\n<p><code>ChildProcess.prototype.spawn</code><code>stdio</code> handle <code>createSocket</code> socket </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createSocket</span>(<span class=\"params\">pipe, readable</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> net.Socket(&#123; <span class=\"attr\">handle</span>: pipe, readable, <span class=\"attr\">writable</span>: !readable &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>stdio</code> pipe  ipc  socket stdinstdout  stderr <code>exec</code><code>execFile</code><code>fork</code> ipc  stdio  fork  send <code>setupChannel</code></p>\n<p><br></p>\n<p><br></p>\n<p><strong></strong>Node.js <code>child_process</code> JavaScript  libuv  cluster.fork  child_process.fork </p>"},{"title":"Node.js ","keywords":"Express,Gateway,Node.js ","description":"BFFNode.jsExpress GatewayExpress","date":"2020-04-02T23:17:29.367Z","_content":"\n[ Node.js  CPU ](https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/)**TCP Server**\n\n<!-- more -->\n\n![1.0](/images/monitor-hub/image-20200403185942130.png)\n\n****\n\n Docker  Node.js  Egg.js `Helper Process`\n\n Node.js `Client` TCP `Server`Client CPUEventLoopGC  Server Server  ES \n\n`Admin Web` CPU  ClientClient `FS` Admin Web  FS \n\n**Q:**\n\n- `ES``FS`\n\n**Q:**\n\n- \n-  Server\n- \n\n**Q:**\n\n-  Server \n-  Server  Client `` EurekaConsul  ClientServer  Admin Web \n-  EurekaConsul  Admin Web  Client Server \n-  Helper Process `Worker Process` Client Client  Egg.js  Master  Worker  Helper Process Egg.js  Agent \n-  Client  Helper Process  Master  Helper Process  Client  Server Master  Client  Helper Process  Docker \n-  Admin WebXXXX Client  XXXX  FS  RMQ \n-  Admin Web  Client  Redis  Redis\n\n![2.0](/images/monitor-hub/image-20200403210837664.png)\n\n****Server Admin Web  Client  Egg.js \n","source":"_posts/monitor-hub.md","raw":"---\ntitle: Node.js \ncategory: JavaScript\nkeywords: Express,Gateway,Node.js \ndescription: BFFNode.jsExpress GatewayExpress\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-04-03T07:17:29.367Z\n---\n\n[ Node.js  CPU ](https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/)**TCP Server**\n\n<!-- more -->\n\n![1.0](/images/monitor-hub/image-20200403185942130.png)\n\n****\n\n Docker  Node.js  Egg.js `Helper Process`\n\n Node.js `Client` TCP `Server`Client CPUEventLoopGC  Server Server  ES \n\n`Admin Web` CPU  ClientClient `FS` Admin Web  FS \n\n**Q:**\n\n- `ES``FS`\n\n**Q:**\n\n- \n-  Server\n- \n\n**Q:**\n\n-  Server \n-  Server  Client `` EurekaConsul  ClientServer  Admin Web \n-  EurekaConsul  Admin Web  Client Server \n-  Helper Process `Worker Process` Client Client  Egg.js  Master  Worker  Helper Process Egg.js  Agent \n-  Client  Helper Process  Master  Helper Process  Client  Server Master  Client  Helper Process  Docker \n-  Admin WebXXXX Client  XXXX  FS  RMQ \n-  Admin Web  Client  Redis  Redis\n\n![2.0](/images/monitor-hub/image-20200403210837664.png)\n\n****Server Admin Web  Client  Egg.js \n","slug":"monitor-hub","published":1,"updated":"2020-07-07T10:11:25.587Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs60000ed12iio0rfwo6","content":"<p><a href=\"https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/\" target=\"_blank\" rel=\"noopener\"> Node.js  CPU </a><strong>TCP Server</strong></p>\n<a id=\"more\"></a>\n<p><img src=\"/images/monitor-hub/image-20200403185942130.png\" alt=\"1.0\"></p>\n<p><strong></strong></p>\n<p> Docker  Node.js  Egg.js <code>Helper Process</code></p>\n<p> Node.js <code>Client</code> TCP <code>Server</code>Client CPUEventLoopGC  Server Server  ES </p>\n<p><code>Admin Web</code> CPU  ClientClient <code>FS</code> Admin Web  FS </p>\n<p><strong>Q:</strong></p>\n<ul>\n<li><code>ES</code><code>FS</code></li>\n</ul>\n<p><strong>Q:</strong></p>\n<ul>\n<li></li>\n<li> Server</li>\n<li></li>\n</ul>\n<p><strong>Q:</strong></p>\n<ul>\n<li> Server </li>\n<li> Server  Client <code></code> EurekaConsul  ClientServer  Admin Web </li>\n<li> EurekaConsul  Admin Web  Client Server </li>\n<li> Helper Process <code>Worker Process</code> Client Client  Egg.js  Master  Worker  Helper Process Egg.js  Agent </li>\n<li> Client  Helper Process  Master  Helper Process  Client  Server Master  Client  Helper Process  Docker </li>\n<li> Admin WebXXXX Client  XXXX  FS  RMQ </li>\n<li> Admin Web  Client  Redis  Redis</li>\n</ul>\n<p><img src=\"/images/monitor-hub/image-20200403210837664.png\" alt=\"2.0\"></p>\n<p><strong></strong>Server Admin Web  Client  Egg.js </p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p><a href=\"https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/\" target=\"_blank\" rel=\"noopener\"> Node.js  CPU </a><strong>TCP Server</strong></p>","more":"<p><img src=\"/images/monitor-hub/image-20200403185942130.png\" alt=\"1.0\"></p>\n<p><strong></strong></p>\n<p> Docker  Node.js  Egg.js <code>Helper Process</code></p>\n<p> Node.js <code>Client</code> TCP <code>Server</code>Client CPUEventLoopGC  Server Server  ES </p>\n<p><code>Admin Web</code> CPU  ClientClient <code>FS</code> Admin Web  FS </p>\n<p><strong>Q:</strong></p>\n<ul>\n<li><code>ES</code><code>FS</code></li>\n</ul>\n<p><strong>Q:</strong></p>\n<ul>\n<li></li>\n<li> Server</li>\n<li></li>\n</ul>\n<p><strong>Q:</strong></p>\n<ul>\n<li> Server </li>\n<li> Server  Client <code></code> EurekaConsul  ClientServer  Admin Web </li>\n<li> EurekaConsul  Admin Web  Client Server </li>\n<li> Helper Process <code>Worker Process</code> Client Client  Egg.js  Master  Worker  Helper Process Egg.js  Agent </li>\n<li> Client  Helper Process  Master  Helper Process  Client  Server Master  Client  Helper Process  Docker </li>\n<li> Admin WebXXXX Client  XXXX  FS  RMQ </li>\n<li> Admin Web  Client  Redis  Redis</li>\n</ul>\n<p><img src=\"/images/monitor-hub/image-20200403210837664.png\" alt=\"2.0\"></p>\n<p><strong></strong>Server Admin Web  Client  Egg.js </p>"},{"title":"Node.jsSSR","date":"2020-06-29T06:59:30.000Z","keys":",gateway,SSR,,","_content":"\n### \n\nBUG  N  \n\n HTTP Header \n\nServer A V1 -> Server B V1\n\nServer A V2 -> Server B \n\n<!-- more -->\n<br/>\n\n### \n\n** SSR  hybrid  Native  HTTP Header  PC  URL Query  Cookie **\n\n1.  SSR \n\n\n\n-  SSR \n\n\n\n-  SSR \n-  SSR  2 \n-  Docker  SSR \n\n2.  SSR  HTTP Header \n\n\n\n-  SSR  Docker\n- SSR\n\n\n\n-  SSR  SSR \n\n****\n\n<br/>\n\n###  SSR \n\n#### CI\\CD \n\n client-manifest.json  server-manifest.jsonclient-manifest.json server-manifest.json  Node.js  SSR \n\n#### \n\n-  ['v1,'v2']\n-  diff \n-  SSR \n-  SSR @babel/parser  @babel/traverse  AST\n-  SSR \n- \n- \n\n Egg.js Agent  Worker [PlugBoard](https://mlib.wang/plugboard/?s=blog)\n\n![](/images/node-gateway-ssr-multi-version/arch.png)\n\n SSR  client-manifest.json\n\n K8S \n","source":"_posts/node-gateway-ssr-multi-version.md","raw":"---\ntitle: Node.jsSSR\ndate: 2020-06-29 14:59:30\ncategory: \ntags:\n  - \nkeys: ,gateway,SSR,,\n---\n\n### \n\nBUG  N  \n\n HTTP Header \n\nServer A V1 -> Server B V1\n\nServer A V2 -> Server B \n\n<!-- more -->\n<br/>\n\n### \n\n** SSR  hybrid  Native  HTTP Header  PC  URL Query  Cookie **\n\n1.  SSR \n\n\n\n-  SSR \n\n\n\n-  SSR \n-  SSR  2 \n-  Docker  SSR \n\n2.  SSR  HTTP Header \n\n\n\n-  SSR  Docker\n- SSR\n\n\n\n-  SSR  SSR \n\n****\n\n<br/>\n\n###  SSR \n\n#### CI\\CD \n\n client-manifest.json  server-manifest.jsonclient-manifest.json server-manifest.json  Node.js  SSR \n\n#### \n\n-  ['v1,'v2']\n-  diff \n-  SSR \n-  SSR @babel/parser  @babel/traverse  AST\n-  SSR \n- \n- \n\n Egg.js Agent  Worker [PlugBoard](https://mlib.wang/plugboard/?s=blog)\n\n![](/images/node-gateway-ssr-multi-version/arch.png)\n\n SSR  client-manifest.json\n\n K8S \n","slug":"node-gateway-ssr-multi-version","published":1,"updated":"2020-07-07T10:11:25.587Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs63000hd12ihv1bmsa1","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BUG  N  </p>\n<p> HTTP Header </p>\n<p>Server A V1 -&gt; Server B V1</p>\n<p>Server A V2 -&gt; Server B </p>\n<a id=\"more\"></a>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong> SSR  hybrid  Native  HTTP Header  PC  URL Query  Cookie </strong></p>\n<ol>\n<li> SSR </li>\n</ol>\n<p></p>\n<ul>\n<li> SSR </li>\n</ul>\n<p></p>\n<ul>\n<li> SSR </li>\n<li> SSR  2 </li>\n<li> Docker  SSR </li>\n</ul>\n<ol start=\"2\">\n<li> SSR  HTTP Header </li>\n</ol>\n<p></p>\n<ul>\n<li> SSR  Docker</li>\n<li>SSR</li>\n</ul>\n<p></p>\n<ul>\n<li> SSR  SSR </li>\n</ul>\n<p><strong></strong></p>\n<p><br></p>\n<h3 id=\"-SSR-\"><a href=\"#-SSR-\" class=\"headerlink\" title=\" SSR \"></a> SSR </h3><h4 id=\"CI-CD-\"><a href=\"#CI-CD-\" class=\"headerlink\" title=\"CI\\CD \"></a>CI\\CD </h4><p> client-manifest.json  server-manifest.jsonclient-manifest.json server-manifest.json  Node.js  SSR </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li> [v1,v2]</li>\n<li> diff </li>\n<li> SSR </li>\n<li> SSR @babel/parser  @babel/traverse  AST</li>\n<li> SSR </li>\n<li></li>\n<li></li>\n</ul>\n<p> Egg.js Agent  Worker <a href=\"https://mlib.wang/plugboard/?s=blog\">PlugBoard</a></p>\n<p><img src=\"/images/node-gateway-ssr-multi-version/arch.png\" alt=\"\"></p>\n<p> SSR  client-manifest.json</p>\n<p> K8S </p>\n","site":{"data":{}},"_categories":[{"name":"","path":"categories//"}],"_tags":[{"name":"","path":"tags//"}],"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BUG  N  </p>\n<p> HTTP Header </p>\n<p>Server A V1 -&gt; Server B V1</p>\n<p>Server A V2 -&gt; Server B </p>","more":"<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong> SSR  hybrid  Native  HTTP Header  PC  URL Query  Cookie </strong></p>\n<ol>\n<li> SSR </li>\n</ol>\n<p></p>\n<ul>\n<li> SSR </li>\n</ul>\n<p></p>\n<ul>\n<li> SSR </li>\n<li> SSR  2 </li>\n<li> Docker  SSR </li>\n</ul>\n<ol start=\"2\">\n<li> SSR  HTTP Header </li>\n</ol>\n<p></p>\n<ul>\n<li> SSR  Docker</li>\n<li>SSR</li>\n</ul>\n<p></p>\n<ul>\n<li> SSR  SSR </li>\n</ul>\n<p><strong></strong></p>\n<p><br></p>\n<h3 id=\"-SSR-\"><a href=\"#-SSR-\" class=\"headerlink\" title=\" SSR \"></a> SSR </h3><h4 id=\"CI-CD-\"><a href=\"#CI-CD-\" class=\"headerlink\" title=\"CI\\CD \"></a>CI\\CD </h4><p> client-manifest.json  server-manifest.jsonclient-manifest.json server-manifest.json  Node.js  SSR </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li> [v1,v2]</li>\n<li> diff </li>\n<li> SSR </li>\n<li> SSR @babel/parser  @babel/traverse  AST</li>\n<li> SSR </li>\n<li></li>\n<li></li>\n</ul>\n<p> Egg.js Agent  Worker <a href=\"https://mlib.wang/plugboard/?s=blog\">PlugBoard</a></p>\n<p><img src=\"/images/node-gateway-ssr-multi-version/arch.png\" alt=\"\"></p>\n<p> SSR  client-manifest.json</p>\n<p> K8S </p>"},{"title":"Node.jsCPU","keywords":",CPU","description":"CPUAlinode","date":"2020-02-20T23:31:54.489Z","_content":"\nCPU[Alinode](https://cn.aliyun.com/product/nodejs)\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n## \n\n*Node.jsEgg.jsAgentWorker*\n\n#### \n\n- CPUEventLoopGC\n-  `os.loadavg()`\n\nNode.js APIC++V8 API[IBM appmetrics](https://github.com/RuntimeTools/appmetrics)``ElasticsearchGrafana\n\n<br/>\n\n#### \n\n- \n\n#### [CPU](http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html)\n\n- CPU\n\n2``DB``Node.js````\n\n<br/>\n\n<br/>\n\n## &\n\nNode.jsCPU``Node.jsNode.jsTCPHTTP\n\nTCP**HTTPTCP**\n\n![](/images/node-perf-heapdump-flame-graph/connection_01.png)\n\n- ****Web\n- **Hub**TCPNode.js\n- **Node.js Process:** DockerNode.jsExpressEgg.jsNode.js\n- **DFS**Docker\n\n<br/>\n\n<br/>\n\n## \n\nNode.js Process``[heapdump](https://www.npmjs.com/package/heapdump)DFS`Alinode`[devtools-frontend](https://github.com/ChromeDevTools/devtools-frontend)\n\n![devtools ](/images/node-perf-heapdump-flame-graph/heapdump_01.png)\n\n<br/>\n\n<br/>\n\n## CPU\n\n[](https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/)[perf](http://www.brendangregg.com/perf.html)[FlameGraph](https://github.com/brendangregg/FlameGraph)Google\n\nNode.js`socket.on(\"readable\",callback)`  `socket.on(\"data\",callback)`callback`perf`shell\n\nNode.jsJavaScript``IOJavaScript`callback`shell``callbackCPUJavaScriptperfCPU`perf`\n\nJavaScriptshell\n\n### \n\nperfLinuxDockerNode.jsNode.js 12\n\nNode.js Docker`--privileged`perf\n\n```shell\ndocker run --privileged -itd node:12-buster /bin/bash // \n\ndocker attach xxxx  // \n```\n\nDocker`perf`\n\n```shell\napt-get update\n\napt-get install linux-perf\n\nperf_4.19 // linuxperf\n```\n\n[](https://github.com/miser/test-perf)\n\n```javascript\n// index.js\nconst {fork } = require('child_process')\nfork('./helper')\n\nfibonacci(50)\n\nfunction fibonacci(n) {\n  if(n==0 || n == 1) return n;\n  return fibonacci(n-1) + fibonacci(n-2);\n}\n\n// helper.js\nconst fs = require('fs');\nconst path = require('path');\nconst { spawn, exec } = require('child_process');\nconst unzipper = require(\"unzipper\");\n\nconst perfCMD = 'perf_4.19'\nconst perfTime = 60;\n\n\nfunction execCMD(cmd, callback) {\n  return new Promise((resolve, reject) => {\n    exec(cmd, (error, stdout, stderr) => {\n      console.log('shell: ',cmd)\n      if (error) {\n        console.error(`: ${error}`);\n        reject(error)\n      }\n      if(callback) {\n        callback(stdout, stderr, resolve, reject);\n      } else {\n        resolve()\n      }\n    });\n  })\n}\n\nclass Flame {\n  constructor() {\n\n    this.nodes = [];\n\n    this._init().catch(function(e){\n      console.log(e)\n    })\n  }\n\n  _init () {\n    return new Promise((resolve, reject) => {\n      const zipFilePath = path.join('.', 'FlameGraph.zip')\n      const saveDir = process.cwd();\n      fs.createReadStream(zipFilePath)\n        .pipe(unzipper.Extract({ path: saveDir }))\n        .on(\"error\", reject)\n        .on(\"finish\", () => {\n          console.log(\"zip finish\");\n          resolve();\n        });\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/stackcollapse-perf.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/flamegraph.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '{print $2}'`;\n      return execCMD(cmd, (stdout, stderr, resolve, reject) => {\n        this.nodes = stdout.split('\\n').filter( pid => pid && pid != process.pid)\n        resolve();\n      });\n    });\n  }\n\n  _chownMapFile(){\n    const cmd = `chown root /tmp/perf-${this.nodes[0]}.map && ${perfCMD} script > nodestacks`;\n    execCMD(cmd).then(() => {\n      this._genFlameGraph();\n    })\n  }\n\n  _genFlameGraph(){\n    const cmd = `./FlameGraph/stackcollapse-perf.pl < nodestacks | ./FlameGraph/flamegraph.pl --colors js > node-flamegraph-${process.pid}.svg`\n    execCMD(cmd).then(() => {\n      console.log('had completed');\n    })\n  }\n\n  record() {\n    const cmd = `${perfCMD} record -F 99 -p ${this.nodes[0]} -g -- sleep ${perfTime}`;\n    execCMD(cmd).then(() => {\n      const t = 1000 * (perfTime + 5);\n      setTimeout(() => {\n        this._chownMapFile()\n      }, 1000 * (perfTime + 5))\n    })\n  }\n}\n\nconst flame = new Flame();\nsetTimeout(() => {\n  // tcp\n  flame.record();\n}, 1000 * 5)\n\n```\n\n```json\n// package.json\n{\n  \"name\": \"test-perf\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"dev\": \"node --perf-basic-prof index.js\",\n    \"clear\": \"rm isolate-* & rm node-flamegraph-*.svg & rm -rf FlameGraph\"\n  },\n  \"keywords\": [],\n  \"author\": \"\",\n  \"license\": \"ISC\",\n  \"dependencies\": {\n    \"unzipper\": \"^0.10.8\"\n  }\n}\n\n```\n\n\n\n- index.js: \n- hepler.js: FlameGraph.zip =>  => Node.js=>  =>  perf record => 5\n- package.json:  index.js `--perf-basic-prof``unzipper`\n\ndocker cp dockernpm i\n\n```shell\nnpm run dev // \n```\n\nCPU\n\n![CPU](/images/node-perf-heapdump-flame-graph/node-flamegraph.png)\n\nHelper.js\n\n![](/images/node-perf-heapdump-flame-graph/connection_02.png)\n\n\n\n\n\n#### \n\n","source":"_posts/node-perf-heapdump-flame-graph.md","raw":"---\ntitle: Node.jsCPU\ncategory: JavaScript\nkeywords: ,CPU\ndescription: CPUAlinode\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-02-21T07:31:54.489Z\n---\n\nCPU[Alinode](https://cn.aliyun.com/product/nodejs)\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n## \n\n*Node.jsEgg.jsAgentWorker*\n\n#### \n\n- CPUEventLoopGC\n-  `os.loadavg()`\n\nNode.js APIC++V8 API[IBM appmetrics](https://github.com/RuntimeTools/appmetrics)``ElasticsearchGrafana\n\n<br/>\n\n#### \n\n- \n\n#### [CPU](http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html)\n\n- CPU\n\n2``DB``Node.js````\n\n<br/>\n\n<br/>\n\n## &\n\nNode.jsCPU``Node.jsNode.jsTCPHTTP\n\nTCP**HTTPTCP**\n\n![](/images/node-perf-heapdump-flame-graph/connection_01.png)\n\n- ****Web\n- **Hub**TCPNode.js\n- **Node.js Process:** DockerNode.jsExpressEgg.jsNode.js\n- **DFS**Docker\n\n<br/>\n\n<br/>\n\n## \n\nNode.js Process``[heapdump](https://www.npmjs.com/package/heapdump)DFS`Alinode`[devtools-frontend](https://github.com/ChromeDevTools/devtools-frontend)\n\n![devtools ](/images/node-perf-heapdump-flame-graph/heapdump_01.png)\n\n<br/>\n\n<br/>\n\n## CPU\n\n[](https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/)[perf](http://www.brendangregg.com/perf.html)[FlameGraph](https://github.com/brendangregg/FlameGraph)Google\n\nNode.js`socket.on(\"readable\",callback)`  `socket.on(\"data\",callback)`callback`perf`shell\n\nNode.jsJavaScript``IOJavaScript`callback`shell``callbackCPUJavaScriptperfCPU`perf`\n\nJavaScriptshell\n\n### \n\nperfLinuxDockerNode.jsNode.js 12\n\nNode.js Docker`--privileged`perf\n\n```shell\ndocker run --privileged -itd node:12-buster /bin/bash // \n\ndocker attach xxxx  // \n```\n\nDocker`perf`\n\n```shell\napt-get update\n\napt-get install linux-perf\n\nperf_4.19 // linuxperf\n```\n\n[](https://github.com/miser/test-perf)\n\n```javascript\n// index.js\nconst {fork } = require('child_process')\nfork('./helper')\n\nfibonacci(50)\n\nfunction fibonacci(n) {\n  if(n==0 || n == 1) return n;\n  return fibonacci(n-1) + fibonacci(n-2);\n}\n\n// helper.js\nconst fs = require('fs');\nconst path = require('path');\nconst { spawn, exec } = require('child_process');\nconst unzipper = require(\"unzipper\");\n\nconst perfCMD = 'perf_4.19'\nconst perfTime = 60;\n\n\nfunction execCMD(cmd, callback) {\n  return new Promise((resolve, reject) => {\n    exec(cmd, (error, stdout, stderr) => {\n      console.log('shell: ',cmd)\n      if (error) {\n        console.error(`: ${error}`);\n        reject(error)\n      }\n      if(callback) {\n        callback(stdout, stderr, resolve, reject);\n      } else {\n        resolve()\n      }\n    });\n  })\n}\n\nclass Flame {\n  constructor() {\n\n    this.nodes = [];\n\n    this._init().catch(function(e){\n      console.log(e)\n    })\n  }\n\n  _init () {\n    return new Promise((resolve, reject) => {\n      const zipFilePath = path.join('.', 'FlameGraph.zip')\n      const saveDir = process.cwd();\n      fs.createReadStream(zipFilePath)\n        .pipe(unzipper.Extract({ path: saveDir }))\n        .on(\"error\", reject)\n        .on(\"finish\", () => {\n          console.log(\"zip finish\");\n          resolve();\n        });\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/stackcollapse-perf.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/flamegraph.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '{print $2}'`;\n      return execCMD(cmd, (stdout, stderr, resolve, reject) => {\n        this.nodes = stdout.split('\\n').filter( pid => pid && pid != process.pid)\n        resolve();\n      });\n    });\n  }\n\n  _chownMapFile(){\n    const cmd = `chown root /tmp/perf-${this.nodes[0]}.map && ${perfCMD} script > nodestacks`;\n    execCMD(cmd).then(() => {\n      this._genFlameGraph();\n    })\n  }\n\n  _genFlameGraph(){\n    const cmd = `./FlameGraph/stackcollapse-perf.pl < nodestacks | ./FlameGraph/flamegraph.pl --colors js > node-flamegraph-${process.pid}.svg`\n    execCMD(cmd).then(() => {\n      console.log('had completed');\n    })\n  }\n\n  record() {\n    const cmd = `${perfCMD} record -F 99 -p ${this.nodes[0]} -g -- sleep ${perfTime}`;\n    execCMD(cmd).then(() => {\n      const t = 1000 * (perfTime + 5);\n      setTimeout(() => {\n        this._chownMapFile()\n      }, 1000 * (perfTime + 5))\n    })\n  }\n}\n\nconst flame = new Flame();\nsetTimeout(() => {\n  // tcp\n  flame.record();\n}, 1000 * 5)\n\n```\n\n```json\n// package.json\n{\n  \"name\": \"test-perf\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"dev\": \"node --perf-basic-prof index.js\",\n    \"clear\": \"rm isolate-* & rm node-flamegraph-*.svg & rm -rf FlameGraph\"\n  },\n  \"keywords\": [],\n  \"author\": \"\",\n  \"license\": \"ISC\",\n  \"dependencies\": {\n    \"unzipper\": \"^0.10.8\"\n  }\n}\n\n```\n\n\n\n- index.js: \n- hepler.js: FlameGraph.zip =>  => Node.js=>  =>  perf record => 5\n- package.json:  index.js `--perf-basic-prof``unzipper`\n\ndocker cp dockernpm i\n\n```shell\nnpm run dev // \n```\n\nCPU\n\n![CPU](/images/node-perf-heapdump-flame-graph/node-flamegraph.png)\n\nHelper.js\n\n![](/images/node-perf-heapdump-flame-graph/connection_02.png)\n\n\n\n\n\n#### \n\n","slug":"node-perf-heapdump-flame-graph","published":1,"updated":"2020-07-07T10:11:25.588Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs67000ld12i883r2soz","content":"<p>CPU<a href=\"https://cn.aliyun.com/product/nodejs\" target=\"_blank\" rel=\"noopener\">Alinode</a></p>\n<a id=\"more\"></a>\n<p><br></p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><em>Node.jsEgg.jsAgentWorker</em></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>CPUEventLoopGC</li>\n<li> <code>os.loadavg()</code></li>\n</ul>\n<p>Node.js APIC++V8 API<a href=\"https://github.com/RuntimeTools/appmetrics\" target=\"_blank\" rel=\"noopener\">IBM appmetrics</a><code></code>ElasticsearchGrafana</p>\n<p><br></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li></li>\n</ul>\n<h4 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a><a href=\"http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html\" target=\"_blank\" rel=\"noopener\">CPU</a></h4><ul>\n<li>CPU</li>\n</ul>\n<p>2<code></code>DB<code></code>Node.js<code></code><code></code></p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"-amp-\"><a href=\"#-amp-\" class=\"headerlink\" title=\"&amp;\"></a>&amp;</h2><p>Node.jsCPU<code></code>Node.jsNode.jsTCPHTTP</p>\n<p>TCP<strong>HTTPTCP</strong></p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_01.png\" alt=\"\"></p>\n<ul>\n<li><strong></strong>Web</li>\n<li><strong>Hub</strong>TCPNode.js</li>\n<li><strong>Node.js Process:</strong> DockerNode.jsExpressEgg.jsNode.js</li>\n<li><strong>DFS</strong>Docker</li>\n</ul>\n<p><br></p>\n<p><br></p>\n<h2 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h2><p>Node.js Process<code></code><a href=\"https://www.npmjs.com/package/heapdump\" target=\"_blank\" rel=\"noopener\">heapdump</a>DFS<code>Alinode</code><a href=\"https://github.com/ChromeDevTools/devtools-frontend\" target=\"_blank\" rel=\"noopener\">devtools-frontend</a></p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/heapdump_01.png\" alt=\"devtools \"></p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"CPU-1\"><a href=\"#CPU-1\" class=\"headerlink\" title=\"CPU\"></a>CPU</h2><p><a href=\"https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/\" target=\"_blank\" rel=\"noopener\"></a><a href=\"http://www.brendangregg.com/perf.html\" target=\"_blank\" rel=\"noopener\">perf</a><a href=\"https://github.com/brendangregg/FlameGraph\" target=\"_blank\" rel=\"noopener\">FlameGraph</a>Google</p>\n<p>Node.js<code>socket.on(&quot;readable&quot;,callback)</code>  <code>socket.on(&quot;data&quot;,callback)</code>callback<code>perf</code>shell</p>\n<p>Node.jsJavaScript<code></code>IOJavaScript<code>callback</code>shell<code></code>callbackCPUJavaScriptperfCPU<code>perf</code></p>\n<p>JavaScriptshell</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>perfLinuxDockerNode.jsNode.js 12</p>\n<p>Node.js Docker<code>--privileged</code>perf</p>\n<figure class=\"highlight shell hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --privileged -itd node:12-buster /bin/bash // </span><br><span class=\"line\"></span><br><span class=\"line\">docker attach xxxx  // </span><br></pre></td></tr></table></figure>\n<p>Docker<code>perf</code></p>\n<figure class=\"highlight shell hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\">apt-get install linux-perf</span><br><span class=\"line\"></span><br><span class=\"line\">perf_4.19 // linuxperf</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://github.com/miser/test-perf\" target=\"_blank\" rel=\"noopener\"></a></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// index.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123;fork &#125; = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>)</span><br><span class=\"line\">fork(<span class=\"hljs-string\">'./helper'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">fibonacci(<span class=\"hljs-number\">50</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">fibonacci</span>(<span class=\"hljs-params\">n</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span>(n==<span class=\"hljs-number\">0</span> || n == <span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">return</span> n;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> fibonacci(n<span class=\"hljs-number\">-1</span>) + fibonacci(n<span class=\"hljs-number\">-2</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// helper.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> fs = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'fs'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> path = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'path'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123; spawn, exec &#125; = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> unzipper = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">\"unzipper\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> perfCMD = <span class=\"hljs-string\">'perf_4.19'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> perfTime = <span class=\"hljs-number\">60</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">execCMD</span>(<span class=\"hljs-params\">cmd, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    exec(cmd, (error, stdout, stderr) =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'shell: '</span>,cmd)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (error) &#123;</span><br><span class=\"line\">        <span class=\"hljs-built_in\">console</span>.error(<span class=\"hljs-string\">`: <span class=\"hljs-subst\">$&#123;error&#125;</span>`</span>);</span><br><span class=\"line\">        reject(error)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span>(callback) &#123;</span><br><span class=\"line\">        callback(stdout, stderr, resolve, reject);</span><br><span class=\"line\">      &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">        resolve()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Flame</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.nodes = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>._init().catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>)</span>&#123;</span><br><span class=\"line\">      <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _init () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> zipFilePath = path.join(<span class=\"hljs-string\">'.'</span>, <span class=\"hljs-string\">'FlameGraph.zip'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> saveDir = process.cwd();</span><br><span class=\"line\">      fs.createReadStream(zipFilePath)</span><br><span class=\"line\">        .pipe(unzipper.Extract(&#123; <span class=\"hljs-attr\">path</span>: saveDir &#125;))</span><br><span class=\"line\">        .on(<span class=\"hljs-string\">\"error\"</span>, reject)</span><br><span class=\"line\">        .on(<span class=\"hljs-string\">\"finish\"</span>, () =&gt; &#123;</span><br><span class=\"line\">          <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">\"zip finish\"</span>);</span><br><span class=\"line\">          resolve();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`chmod 700 ./FlameGraph/stackcollapse-perf.pl`</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> execCMD(cmd);</span><br><span class=\"line\">    &#125;).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`chmod 700 ./FlameGraph/flamegraph.pl`</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> execCMD(cmd);</span><br><span class=\"line\">    &#125;).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '&#123;print $2&#125;'`</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> execCMD(cmd, (stdout, stderr, resolve, reject) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.nodes = stdout.split(<span class=\"hljs-string\">'\\n'</span>).filter( <span class=\"hljs-function\"><span class=\"hljs-params\">pid</span> =&gt;</span> pid &amp;&amp; pid != process.pid)</span><br><span class=\"line\">        resolve();</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _chownMapFile()&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`chown root /tmp/perf-<span class=\"hljs-subst\">$&#123;<span class=\"hljs-keyword\">this</span>.nodes[<span class=\"hljs-number\">0</span>]&#125;</span>.map &amp;&amp; <span class=\"hljs-subst\">$&#123;perfCMD&#125;</span> script &gt; nodestacks`</span>;</span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>._genFlameGraph();</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _genFlameGraph()&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`./FlameGraph/stackcollapse-perf.pl &lt; nodestacks | ./FlameGraph/flamegraph.pl --colors js &gt; node-flamegraph-<span class=\"hljs-subst\">$&#123;process.pid&#125;</span>.svg`</span></span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'had completed'</span>);</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  record() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`<span class=\"hljs-subst\">$&#123;perfCMD&#125;</span> record -F 99 -p <span class=\"hljs-subst\">$&#123;<span class=\"hljs-keyword\">this</span>.nodes[<span class=\"hljs-number\">0</span>]&#125;</span> -g -- sleep <span class=\"hljs-subst\">$&#123;perfTime&#125;</span>`</span>;</span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> t = <span class=\"hljs-number\">1000</span> * (perfTime + <span class=\"hljs-number\">5</span>);</span><br><span class=\"line\">      setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>._chownMapFile()</span><br><span class=\"line\">      &#125;, <span class=\"hljs-number\">1000</span> * (perfTime + <span class=\"hljs-number\">5</span>))</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> flame = <span class=\"hljs-keyword\">new</span> Flame();</span><br><span class=\"line\">setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// tcp</span></span><br><span class=\"line\">  flame.record();</span><br><span class=\"line\">&#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">5</span>)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight json hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// package.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"name\"</span>: <span class=\"hljs-string\">\"test-perf\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"version\"</span>: <span class=\"hljs-string\">\"1.0.0\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"description\"</span>: <span class=\"hljs-string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"main\"</span>: <span class=\"hljs-string\">\"index.js\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"dev\"</span>: <span class=\"hljs-string\">\"node --perf-basic-prof index.js\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"clear\"</span>: <span class=\"hljs-string\">\"rm isolate-* &amp; rm node-flamegraph-*.svg &amp; rm -rf FlameGraph\"</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"keywords\"</span>: [],</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"author\"</span>: <span class=\"hljs-string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"license\"</span>: <span class=\"hljs-string\">\"ISC\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">\"dependencies\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"hljs-attr\">\"unzipper\"</span>: <span class=\"hljs-string\">\"^0.10.8\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>index.js: </li>\n<li>hepler.js: FlameGraph.zip =&gt;  =&gt; Node.js=&gt;  =&gt;  perf record =&gt; 5</li>\n<li>package.json:  index.js <code>--perf-basic-prof</code><code>unzipper</code></li>\n</ul>\n<p>docker cp dockernpm i</p>\n<figure class=\"highlight shell hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run dev // </span><br></pre></td></tr></table></figure>\n<p>CPU</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/node-flamegraph.png\" alt=\"CPU\"></p>\n<p>Helper.js</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_02.png\" alt=\"\"></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p>CPU<a href=\"https://cn.aliyun.com/product/nodejs\" target=\"_blank\" rel=\"noopener\">Alinode</a></p>","more":"<p><br></p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><em>Node.jsEgg.jsAgentWorker</em></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>CPUEventLoopGC</li>\n<li> <code>os.loadavg()</code></li>\n</ul>\n<p>Node.js APIC++V8 API<a href=\"https://github.com/RuntimeTools/appmetrics\" target=\"_blank\" rel=\"noopener\">IBM appmetrics</a><code></code>ElasticsearchGrafana</p>\n<p><br></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li></li>\n</ul>\n<h4 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a><a href=\"http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html\" target=\"_blank\" rel=\"noopener\">CPU</a></h4><ul>\n<li>CPU</li>\n</ul>\n<p>2<code></code>DB<code></code>Node.js<code></code><code></code></p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"-amp-\"><a href=\"#-amp-\" class=\"headerlink\" title=\"&amp;\"></a>&amp;</h2><p>Node.jsCPU<code></code>Node.jsNode.jsTCPHTTP</p>\n<p>TCP<strong>HTTPTCP</strong></p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_01.png\" alt=\"\"></p>\n<ul>\n<li><strong></strong>Web</li>\n<li><strong>Hub</strong>TCPNode.js</li>\n<li><strong>Node.js Process:</strong> DockerNode.jsExpressEgg.jsNode.js</li>\n<li><strong>DFS</strong>Docker</li>\n</ul>\n<p><br></p>\n<p><br></p>\n<h2 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h2><p>Node.js Process<code></code><a href=\"https://www.npmjs.com/package/heapdump\" target=\"_blank\" rel=\"noopener\">heapdump</a>DFS<code>Alinode</code><a href=\"https://github.com/ChromeDevTools/devtools-frontend\" target=\"_blank\" rel=\"noopener\">devtools-frontend</a></p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/heapdump_01.png\" alt=\"devtools \"></p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"CPU-1\"><a href=\"#CPU-1\" class=\"headerlink\" title=\"CPU\"></a>CPU</h2><p><a href=\"https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/\" target=\"_blank\" rel=\"noopener\"></a><a href=\"http://www.brendangregg.com/perf.html\" target=\"_blank\" rel=\"noopener\">perf</a><a href=\"https://github.com/brendangregg/FlameGraph\" target=\"_blank\" rel=\"noopener\">FlameGraph</a>Google</p>\n<p>Node.js<code>socket.on(&quot;readable&quot;,callback)</code>  <code>socket.on(&quot;data&quot;,callback)</code>callback<code>perf</code>shell</p>\n<p>Node.jsJavaScript<code></code>IOJavaScript<code>callback</code>shell<code></code>callbackCPUJavaScriptperfCPU<code>perf</code></p>\n<p>JavaScriptshell</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>perfLinuxDockerNode.jsNode.js 12</p>\n<p>Node.js Docker<code>--privileged</code>perf</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --privileged -itd node:12-buster /bin/bash // </span><br><span class=\"line\"></span><br><span class=\"line\">docker attach xxxx  // </span><br></pre></td></tr></table></figure>\n<p>Docker<code>perf</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\">apt-get install linux-perf</span><br><span class=\"line\"></span><br><span class=\"line\">perf_4.19 // linuxperf</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://github.com/miser/test-perf\" target=\"_blank\" rel=\"noopener\"></a></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// index.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123;fork &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'child_process'</span>)</span><br><span class=\"line\">fork(<span class=\"string\">'./helper'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">fibonacci(<span class=\"number\">50</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">fibonacci</span>(<span class=\"params\">n</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(n==<span class=\"number\">0</span> || n == <span class=\"number\">1</span>) <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> fibonacci(n<span class=\"number\">-1</span>) + fibonacci(n<span class=\"number\">-2</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// helper.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">'fs'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; spawn, exec &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'child_process'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> unzipper = <span class=\"built_in\">require</span>(<span class=\"string\">\"unzipper\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> perfCMD = <span class=\"string\">'perf_4.19'</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> perfTime = <span class=\"number\">60</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">execCMD</span>(<span class=\"params\">cmd, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    exec(cmd, (error, stdout, stderr) =&gt; &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">'shell: '</span>,cmd)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (error) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.error(<span class=\"string\">`: <span class=\"subst\">$&#123;error&#125;</span>`</span>);</span><br><span class=\"line\">        reject(error)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(callback) &#123;</span><br><span class=\"line\">        callback(stdout, stderr, resolve, reject);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        resolve()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Flame</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.nodes = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>._init().catch(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>)</span>&#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _init () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> zipFilePath = path.join(<span class=\"string\">'.'</span>, <span class=\"string\">'FlameGraph.zip'</span>)</span><br><span class=\"line\">      <span class=\"keyword\">const</span> saveDir = process.cwd();</span><br><span class=\"line\">      fs.createReadStream(zipFilePath)</span><br><span class=\"line\">        .pipe(unzipper.Extract(&#123; <span class=\"attr\">path</span>: saveDir &#125;))</span><br><span class=\"line\">        .on(<span class=\"string\">\"error\"</span>, reject)</span><br><span class=\"line\">        .on(<span class=\"string\">\"finish\"</span>, () =&gt; &#123;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.log(<span class=\"string\">\"zip finish\"</span>);</span><br><span class=\"line\">          resolve();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> cmd = <span class=\"string\">`chmod 700 ./FlameGraph/stackcollapse-perf.pl`</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> execCMD(cmd);</span><br><span class=\"line\">    &#125;).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> cmd = <span class=\"string\">`chmod 700 ./FlameGraph/flamegraph.pl`</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> execCMD(cmd);</span><br><span class=\"line\">    &#125;).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> cmd = <span class=\"string\">`ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '&#123;print $2&#125;'`</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> execCMD(cmd, (stdout, stderr, resolve, reject) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.nodes = stdout.split(<span class=\"string\">'\\n'</span>).filter( <span class=\"function\"><span class=\"params\">pid</span> =&gt;</span> pid &amp;&amp; pid != process.pid)</span><br><span class=\"line\">        resolve();</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _chownMapFile()&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cmd = <span class=\"string\">`chown root /tmp/perf-<span class=\"subst\">$&#123;<span class=\"keyword\">this</span>.nodes[<span class=\"number\">0</span>]&#125;</span>.map &amp;&amp; <span class=\"subst\">$&#123;perfCMD&#125;</span> script &gt; nodestacks`</span>;</span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>._genFlameGraph();</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _genFlameGraph()&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cmd = <span class=\"string\">`./FlameGraph/stackcollapse-perf.pl &lt; nodestacks | ./FlameGraph/flamegraph.pl --colors js &gt; node-flamegraph-<span class=\"subst\">$&#123;process.pid&#125;</span>.svg`</span></span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">'had completed'</span>);</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  record() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cmd = <span class=\"string\">`<span class=\"subst\">$&#123;perfCMD&#125;</span> record -F 99 -p <span class=\"subst\">$&#123;<span class=\"keyword\">this</span>.nodes[<span class=\"number\">0</span>]&#125;</span> -g -- sleep <span class=\"subst\">$&#123;perfTime&#125;</span>`</span>;</span><br><span class=\"line\">    execCMD(cmd).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> t = <span class=\"number\">1000</span> * (perfTime + <span class=\"number\">5</span>);</span><br><span class=\"line\">      setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>._chownMapFile()</span><br><span class=\"line\">      &#125;, <span class=\"number\">1000</span> * (perfTime + <span class=\"number\">5</span>))</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> flame = <span class=\"keyword\">new</span> Flame();</span><br><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// tcp</span></span><br><span class=\"line\">  flame.record();</span><br><span class=\"line\">&#125;, <span class=\"number\">1000</span> * <span class=\"number\">5</span>)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// package.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"name\"</span>: <span class=\"string\">\"test-perf\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"version\"</span>: <span class=\"string\">\"1.0.0\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"description\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"main\"</span>: <span class=\"string\">\"index.js\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"dev\"</span>: <span class=\"string\">\"node --perf-basic-prof index.js\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"clear\"</span>: <span class=\"string\">\"rm isolate-* &amp; rm node-flamegraph-*.svg &amp; rm -rf FlameGraph\"</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">\"keywords\"</span>: [],</span><br><span class=\"line\">  <span class=\"attr\">\"author\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"license\"</span>: <span class=\"string\">\"ISC\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"dependencies\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"unzipper\"</span>: <span class=\"string\">\"^0.10.8\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>index.js: </li>\n<li>hepler.js: FlameGraph.zip =&gt;  =&gt; Node.js=&gt;  =&gt;  perf record =&gt; 5</li>\n<li>package.json:  index.js <code>--perf-basic-prof</code><code>unzipper</code></li>\n</ul>\n<p>docker cp dockernpm i</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run dev // </span><br></pre></td></tr></table></figure>\n<p>CPU</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/node-flamegraph.png\" alt=\"CPU\"></p>\n<p>Helper.js</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_02.png\" alt=\"\"></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>"},{"layout":"minos","title":"Istio","date":"2020-06-28T02:00:00.000Z","keywords":"Istio,Node.js,JavaScript,","description":"IstioK8s DockerBFF  ","_content":"\n_ Istio _\n\n Istio  K8sDocker  BFF \n\n### JavaScript \n\n JavaScript  3 React\\Vue\\Angular Node.js Express\\Koa\\Egg.js JavaScript  CLI  Express  JavaScript __\n\n<br/>\n\n### BFF \n\n BFF  Nginx  Node.js Server SSRNode.js GraphQL ...\n\n<br/>\n\n### Node.js \n\n Node.js  SDK  Java Node.js  Java  Node.js \n\n** SDK **\n\n<!-- more -->\n\n<br/>\n\n### \n\n  Docker   K8s\n\n K8s Docker  K8s\n\n- \n- \n- Docker \n- \n- \n- \n- \n- ...\n\nK8s SDK  SDK  SDK \n\n<br/>\n\n### \n\n SDK \n\nIstio  K8s \n\n![Istio ](/images/nodejs-istio-k8s-docker/arch.jpg)\n\n A  B  HTTP/1.1HTTP/2gRPC  TCP \n\n#### Envoy\n\n Istio **Envoy** Sidecar SDK  Sidecar \n\n\n\n- HTTP 7 \n- \n- \n- \n- \n-  Mixer \n\nK8s  Pod  Sidecar \n\n#### Pilot\n\n Envoy  API  Envoy \n\n#### Mixer\n\nEnvoy  Mixer \n\n\n\n- Istio \n- Istio \n\n#### Citadel\n\n\n\n#### Galley\n\nGalley  Istio \n\n### \n\n [Bookinfo ](https://istio.io/latest/zh/docs/examples/bookinfo/) PythonJavaRubyNode.js4 \n\n![Bookinfo  ](/images/nodejs-istio-k8s-docker/book-app.png)\n\n\n","source":"_posts/nodejs-istio-k8s-docker.md","raw":"---\nlayout: minos\ntitle: Istio\ndate: 2020-06-28 10:00:00\ncategory: \ntags:\n  - \n  - \nkeywords: Istio,Node.js,JavaScript,\ndescription: IstioK8s DockerBFF  \n---\n\n_ Istio _\n\n Istio  K8sDocker  BFF \n\n### JavaScript \n\n JavaScript  3 React\\Vue\\Angular Node.js Express\\Koa\\Egg.js JavaScript  CLI  Express  JavaScript __\n\n<br/>\n\n### BFF \n\n BFF  Nginx  Node.js Server SSRNode.js GraphQL ...\n\n<br/>\n\n### Node.js \n\n Node.js  SDK  Java Node.js  Java  Node.js \n\n** SDK **\n\n<!-- more -->\n\n<br/>\n\n### \n\n  Docker   K8s\n\n K8s Docker  K8s\n\n- \n- \n- Docker \n- \n- \n- \n- \n- ...\n\nK8s SDK  SDK  SDK \n\n<br/>\n\n### \n\n SDK \n\nIstio  K8s \n\n![Istio ](/images/nodejs-istio-k8s-docker/arch.jpg)\n\n A  B  HTTP/1.1HTTP/2gRPC  TCP \n\n#### Envoy\n\n Istio **Envoy** Sidecar SDK  Sidecar \n\n\n\n- HTTP 7 \n- \n- \n- \n- \n-  Mixer \n\nK8s  Pod  Sidecar \n\n#### Pilot\n\n Envoy  API  Envoy \n\n#### Mixer\n\nEnvoy  Mixer \n\n\n\n- Istio \n- Istio \n\n#### Citadel\n\n\n\n#### Galley\n\nGalley  Istio \n\n### \n\n [Bookinfo ](https://istio.io/latest/zh/docs/examples/bookinfo/) PythonJavaRubyNode.js4 \n\n![Bookinfo  ](/images/nodejs-istio-k8s-docker/book-app.png)\n\n\n","slug":"nodejs-istio-k8s-docker","published":1,"updated":"2020-07-07T10:11:25.589Z","comments":1,"photos":[],"link":"","_id":"ckcc0bs6a000pd12iw204eeos","content":"<p><em> Istio </em></p>\n<p> Istio  K8sDocker  BFF </p>\n<h3 id=\"JavaScript-\"><a href=\"#JavaScript-\" class=\"headerlink\" title=\"JavaScript \"></a>JavaScript </h3><p> JavaScript  3 React\\Vue\\Angular Node.js Express\\Koa\\Egg.js JavaScript  CLI  Express  JavaScript <em></em></p>\n<p><br></p>\n<h3 id=\"BFF-\"><a href=\"#BFF-\" class=\"headerlink\" title=\"BFF \"></a>BFF </h3><p> BFF  Nginx  Node.js Server SSRNode.js GraphQL </p>\n<p><br></p>\n<h3 id=\"Node-js-\"><a href=\"#Node-js-\" class=\"headerlink\" title=\"Node.js \"></a>Node.js </h3><p> Node.js  SDK  Java Node.js  Java  Node.js </p>\n<p><strong> SDK </strong></p>\n<a id=\"more\"></a>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>  Docker   K8s</p>\n<p> K8s Docker  K8s</p>\n<ul>\n<li></li>\n<li></li>\n<li>Docker </li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p>K8s SDK  SDK  SDK </p>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> SDK </p>\n<p>Istio  K8s </p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/arch.jpg\" alt=\"Istio \"></p>\n<p> A  B  HTTP/1.1HTTP/2gRPC  TCP </p>\n<h4 id=\"Envoy\"><a href=\"#Envoy\" class=\"headerlink\" title=\"Envoy\"></a>Envoy</h4><p> Istio <strong>Envoy</strong> Sidecar SDK  Sidecar </p>\n<p></p>\n<ul>\n<li>HTTP 7 </li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li> Mixer </li>\n</ul>\n<p>K8s  Pod  Sidecar </p>\n<h4 id=\"Pilot\"><a href=\"#Pilot\" class=\"headerlink\" title=\"Pilot\"></a>Pilot</h4><p> Envoy  API  Envoy </p>\n<h4 id=\"Mixer\"><a href=\"#Mixer\" class=\"headerlink\" title=\"Mixer\"></a>Mixer</h4><p>Envoy  Mixer </p>\n<p></p>\n<ul>\n<li>Istio </li>\n<li>Istio </li>\n</ul>\n<h4 id=\"Citadel\"><a href=\"#Citadel\" class=\"headerlink\" title=\"Citadel\"></a>Citadel</h4><p></p>\n<h4 id=\"Galley\"><a href=\"#Galley\" class=\"headerlink\" title=\"Galley\"></a>Galley</h4><p>Galley  Istio </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> <a href=\"https://istio.io/latest/zh/docs/examples/bookinfo/\" target=\"_blank\" rel=\"noopener\">Bookinfo </a> PythonJavaRubyNode.js4 </p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/book-app.png\" alt=\"Bookinfo  \"></p>\n<p></p>\n","site":{"data":{}},"_categories":[{"name":"","path":"categories//"}],"_tags":[{"name":"","path":"tags//"},{"name":"","path":"tags//"}],"excerpt":"<p><em> Istio </em></p>\n<p> Istio  K8sDocker  BFF </p>\n<h3 id=\"JavaScript-\"><a href=\"#JavaScript-\" class=\"headerlink\" title=\"JavaScript \"></a>JavaScript </h3><p> JavaScript  3 React\\Vue\\Angular Node.js Express\\Koa\\Egg.js JavaScript  CLI  Express  JavaScript <em></em></p>\n<p><br></p>\n<h3 id=\"BFF-\"><a href=\"#BFF-\" class=\"headerlink\" title=\"BFF \"></a>BFF </h3><p> BFF  Nginx  Node.js Server SSRNode.js GraphQL </p>\n<p><br></p>\n<h3 id=\"Node-js-\"><a href=\"#Node-js-\" class=\"headerlink\" title=\"Node.js \"></a>Node.js </h3><p> Node.js  SDK  Java Node.js  Java  Node.js </p>\n<p><strong> SDK </strong></p>","more":"<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>  Docker   K8s</p>\n<p> K8s Docker  K8s</p>\n<ul>\n<li></li>\n<li></li>\n<li>Docker </li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p>K8s SDK  SDK  SDK </p>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> SDK </p>\n<p>Istio  K8s </p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/arch.jpg\" alt=\"Istio \"></p>\n<p> A  B  HTTP/1.1HTTP/2gRPC  TCP </p>\n<h4 id=\"Envoy\"><a href=\"#Envoy\" class=\"headerlink\" title=\"Envoy\"></a>Envoy</h4><p> Istio <strong>Envoy</strong> Sidecar SDK  Sidecar </p>\n<p></p>\n<ul>\n<li>HTTP 7 </li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li> Mixer </li>\n</ul>\n<p>K8s  Pod  Sidecar </p>\n<h4 id=\"Pilot\"><a href=\"#Pilot\" class=\"headerlink\" title=\"Pilot\"></a>Pilot</h4><p> Envoy  API  Envoy </p>\n<h4 id=\"Mixer\"><a href=\"#Mixer\" class=\"headerlink\" title=\"Mixer\"></a>Mixer</h4><p>Envoy  Mixer </p>\n<p></p>\n<ul>\n<li>Istio </li>\n<li>Istio </li>\n</ul>\n<h4 id=\"Citadel\"><a href=\"#Citadel\" class=\"headerlink\" title=\"Citadel\"></a>Citadel</h4><p></p>\n<h4 id=\"Galley\"><a href=\"#Galley\" class=\"headerlink\" title=\"Galley\"></a>Galley</h4><p>Galley  Istio </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> <a href=\"https://istio.io/latest/zh/docs/examples/bookinfo/\" target=\"_blank\" rel=\"noopener\">Bookinfo </a> PythonJavaRubyNode.js4 </p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/book-app.png\" alt=\"Bookinfo  \"></p>\n<p></p>"},{"layout":"minos","title":"Node.js cluster","date":"2020-05-03T07:24:53.000Z","keywords":"child_process,cluster,fork,Node.js,TCP","description":"RoundRobinHandleclusterTCPnetmasterchildchildchildmasterServerRoundRobinHandleserverTCPfreeworkercluster.child","_content":"\nNode.js**child_process**4`exec``execFile``fork``spawn`**cluster**cluster.forkNet Server\n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): \n\n<!-- more -->\n\n<br/>\n\n****\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**cluster**\n\n```markdown\nlib\n  - internal\n    - cluster\n    - child.js\n      - master.js\n      - round_robin_handle.js\n      - shared_handle.js\n      - utils.js\n      - worker.js\n  - cluster.js\n```\n\n<br/>\n\n****\n\n```javascript\nconst cluster = require('cluster');\nconst http = require('http');\nconst numCPUs = require('os').cpus().length;\n\nif (cluster.isMaster) {\n  console.log(` ${process.pid} `);\n\n  // \n  for (let i = 0; i < numCPUs; i++) {\n    cluster.fork();\n  }\n\n  cluster.on('exit', (worker, code, signal) => {\n    console.log(` ${worker.process.pid} `);\n  });\n} else {\n  //  TCP \n  //  HTTP \n  http.createServer((req, res) => {\n    res.writeHead(200);\n    res.end('\\n');\n  }).listen(8000);\n\n  console.log(` ${process.pid} `);\n}\n```\n\n<br/>\n\n### Q:cluster.isMaster\n\n```javascript\n// lib/cluster.js\nconst childOrMaster = 'NODE_UNIQUE_ID' in process.env ? 'child' : 'master';\nmodule.exports = require(`internal/cluster/${childOrMaster}`);\n```\n\n`lib/cluster.js`cluster`NODE_UNIQUE_ID`\n\n`cluster.fork``NODE_UNIQUE_ID`**child_process.fork**\n\n```javascript\n// lib/internal/cluster/master.js\n// ...\ncluster.isMaster = true;\n// ...\n// fork\nconst workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\nreturn fork(cluster.settings.exec, cluster.settings.args, {\n  // ...\n  env: workerEnv,\n});\n\n// lib/internal/cluster/child.js\n// ...\ncluster.isMaster = false;\n```\n\n### Q:cluster.fork\n\n`cluster.setupMaster`\n\n`createWorkerProcess``child_process.fork`\n\n`Worker`workercluster(master)`message``exit``disconnect`**Worker**`lib/internal/cluster/worker.js`\n\n`internalMessage`internalMessage\n\n>  **{cmd: 'NODE_foo'}**  **cmd**  **NODE_**  Node.js  **'message'**  **'internalMessage'**  Node.js  **'internalMessage'** \n\n`internalMessage``internal(worker, onmessage)`**internal**`lib/internal/cluster/master.js`**onmessage**\n\n**onmessage**if-elsecluster.child(`act`)`queryServer`Net Server\n\n```javascript\n// lib/internal/cluster/master.js\ncluster.fork = function (env) {\n  cluster.setupMaster();\n  const id = ++ids;\n  // \n  const workerProcess = createWorkerProcess(id, env);\n  //\n  const worker = new Worker({\n    id: id,\n    process: workerProcess, // \n  });\n  \n  worker.on(\"message\", function (message, handle) {\n    cluster.emit(\"message\", this, message, handle);\n  });\n  worker.process.once(\"exit\", (exitCode, signalCode) => {\n    // ...\n    worker.state = \"dead\";\n    worker.emit(\"exit\", exitCode, signalCode);\n    cluster.emit(\"exit\", worker, exitCode, signalCode);\n  });\n  worker.process.once(\"disconnect\", () => {\n    // ...\n    worker.state = \"disconnected\";\n    worker.emit(\"disconnect\");\n    cluster.emit(\"disconnect\", worker);\n  });\n\n  worker.process.on(\"internalMessage\", internal(worker, onmessage));\n  //  fork \n  process.nextTick(emitForkNT, worker);\n  cluster.workers[worker.id] = worker; \n  return worker;\n};\n\nfunction createWorkerProcess(id, env) {\n  const workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\n  // ... \n  // child_processfork\n  return fork(cluster.settings.exec, cluster.settings.args, {\n    cwd: cluster.settings.cwd,\n    env: workerEnv,\n    silent: cluster.settings.silent,\n    windowsHide: cluster.settings.windowsHide,\n    execArgv: execArgv,\n    stdio: cluster.settings.stdio,\n    gid: cluster.settings.gid,\n    uid: cluster.settings.uid,\n  });\n}\nfunction onmessage(message, handle) {\n  const worker = this;\n  // ... if message.act   queryServer\n  if (message.act === \"queryServer\") queryServer(worker, message);\n}\n```\n\n```javascript\n// lib/internal/cluster/utils.js\n// clusterchilidmastersendsendHelper\nlet seq = 0;\nfunction sendHelper(proc, message, handle, cb) {\n  if (!proc.connected) return false;\n  // NODE_*  internalMessage \n  message = { cmd: \"NODE_CLUSTER\", ...message, seq };\n\n  if (typeof cb === \"function\") callbacks.set(seq, cb); // \n\n  seq += 1;\n  // cluster/child.js handle => null\n  // cluster/master.js handle => null\n  return proc.send(message, handle);\n}\n```\n\ncluster.forkWorkerinternalMessageclusterchildmaster`sendHelper`\n\n### Q:cluster.forkTCP\n\n`net`Servercluster`child``master`\n\n`http``net``net.createServer``listen`\n\n#### Child:\n\ncluster.childTCP`port`8000`host`\n\n`listenInCluster`**cluster**\n\n`listen``cluster._getServer``act`serverQuerycluster.master\n\n#### Master:\n\n`master.onmessage`act`serverQuery`\n\n`queryServer``RoundRobinHandle`\n\n`RoundRobinHandle``net.createServer`Servercluster.master`listenInCluster``server._listen2`new  `TCP`src/tcp_wrap.cc`server._handle`cluster.masterTCPmasterchild\n\n`RoundRobinHandle`server`listening``server._handle``distribute``onconnection`\n\n`distribute`TCPcluster.child`free``add`workerworkercluster.child`act`**newconn**TCP\n\n#### Child:\n\ncluster.child`onconnection``act`**newconn**server`onconnection`child`Socket``onnection`\n\n\n\n**\n\n```javascript\n// lib/net.js\nfunction createServer(options, connectionListener) {\n  return new Server(options, connectionListener);\n}\nfunction Server(options, connectionListener) {\n  // ... \n}\nServer.prototype.listen = function (...args) {\n  // ...\n  // port8000host\n  var backlog;\n  if (typeof options.port === \"number\" || typeof options.port === \"string\") {\n    backlog = options.backlog || backlogFromArgs;\n    if (options.host) {\n      // ...\n    } else {\n      // \n      listenInCluster(\n        this,\n        null,\n        options.port | 0,\n        4,\n        backlog,\n        undefined,\n        options.exclusive\n      );\n    }\n    return this;\n  }\n\t// ...\n};\n\n\nfunction listenInCluster(\n  server,\n  address,\n  port,\n  addressType,\n  backlog,\n  fd,\n  exclusive,\n  flags\n) {\n  exclusive = !!exclusive;\n\n  if (cluster === undefined) cluster = require(\"cluster\");\n\n  if (cluster.isMaster || exclusive) {\n    server._listen2(address, port, addressType, backlog, fd, flags);\n    return;\n  }\n\n  const serverQuery = {\n    address: address,\n    port: port, \n    addressType: addressType,\n    fd: fd,\n    flags,\n  };\n  cluster._getServer(server, serverQuery, listenOnMasterHandle);\n\n  function listenOnMasterHandle(err, handle) {\n    // ...\n    server._handle = handle;\n    server._listen2(address, port, addressType, backlog, fd, flags);\n  }\n}\n```\n\n```javascript\n// lib/internal/cluster/child.js\ncluster._getServer = function (obj, options, cb) {\n  let address = options.address;\n\t// ...\n  // servercluster.child\n  // index\n  const indexesKey = [\n    address, \n    options.port,\n    options.addressType,\n    options.fd,\n  ].join(\":\"); \n\n  let index = indexes.get(indexesKey);\n\n  if (index === undefined) index = 0;\n  else index++;\n\n  indexes.set(indexesKey, index);\n\n  const message = {\n    act: \"queryServer\",\n    index,\n    data: null,\n    ...options,\n  };\n  \n  // ...\n\n  send(message, (reply, handle) => {\n    // ...\n    if (handle) shared(reply, handle, indexesKey, cb);\n    // Shared listen socket.\n    else rr(reply, indexesKey, cb); // Round-robin  handle null\n  });\n  // ...\n};\nfunction rr(message, indexesKey, cb) {\n  if (message.errno) return cb(message.errno, null);\n\n  var key = message.key;\n\n  function listen(backlog) {\n    return 0;\n  }\n\n  function close() {\n    if (key === undefined) return;\n    send({ act: \"close\", key });\n    handles.delete(key);\n    indexes.delete(indexesKey);\n    key = undefined;\n  }\n\n  function getsockname(out) {\n    if (key) Object.assign(out, message.sockname);\n    return 0;\n  }\n\n  const handle = { close, listen, ref: noop, unref: noop };\n\n  if (message.sockname) {\n    handle.getsockname = getsockname; // TCP handles only.\n  }\n\n  assert(handles.has(key) === false);\n  handles.set(key, handle);\n  cb(0, handle); // handlelistenInClusterhandleserver._handle\n}\n// Round-robin connection.\nfunction onconnection(message, handle) {\n  const key = message.key; // maseterkey\n  const server = handles.get(key); // clientserver\n  const accepted = server !== undefined;\n\n  send({ ack: message.seq, accepted }); //  master\n\n  // cluster.child rrserveronconnection\n  // cbnet.jsonconnection\n  if (accepted) server.onconnection(0, handle);\n}\n```\n\n```javascript\n// lib/internal/cluster/master.js\nfunction queryServer(worker, message) {\n  // workercluster.child worker\n  const key =\n    `${message.address}:${message.port}:${message.addressType}:` +\n    `${message.fd}:${message.index}`;\n  var handle = handles.get(key);\n\n  if (handle === undefined) {\n  \n    // RoundRobinShared\n    var constructor = RoundRobinHandle;\n    // ...\n    handle = new constructor(\n      key,\n      address,\n      message.port,\n      message.addressType,\n      message.fd,\n      message.flags\n    );\n    handles.set(key, handle);\n  }\n  // ...\n  // cluster.childworkerhandle\n  handle.add(worker, (errno, reply, handle) => {\n    const { data } = handles.get(key);\n    send(\n      worker,\n      {\n        errno,\n        key,\n        ack: message.seq,\n        data,\n        ...reply,\n      },\n      handle // round_robin_handle null\n    );\n  });\n}\n```\n\n```javascript\n// lib/internal/cluster/round_robin_handle.js\nfunction RoundRobinHandle(key, address, port, addressType, fd, flags) {\n  this.key = key;\n  this.all = new Map();\n  this.free = [];\n  this.handles = [];\n  this.handle = null;\n  this.server = net.createServer(assert.fail);\n\n  if (fd >= 0) this.server.listen({ fd });\n  else if (port >= 0) {\n    this.server.listen({\n      port,\n      host: address,\n      // Currently, net module only supports `ipv6Only` option in `flags`.\n      ipv6Only: Boolean(flags & constants.UV_TCP_IPV6ONLY),\n    });\n  } else this.server.listen(address); // UNIX socket path.\n\n  this.server.once(\"listening\", () => {\n    this.handle = this.server._handle;\n    // onconnection\n    // distribute \n    this.handle.onconnection = (err, handle) => this.distribute(err, handle);\n    this.server._handle = null;\n    this.server = null;\n  });\n}\n\nRoundRobinHandle.prototype.add = function (worker, send) {\n  assert(this.all.has(worker.id) === false);\n  this.all.set(worker.id, worker);\n\n  const done = () => {\n    if (this.handle.getsockname) {\n      // tcp\\udp getsockname\n      const out = {};\n      this.handle.getsockname(out);\n      // TODO(bnoordhuis) Check err.\n      send(null, { sockname: out }, null);\n    } else {\n      send(null, null, null); // UNIX socket.\n    }\n\n    this.handoff(worker); // In case there are connections pending.\n  };\n\n  if (this.server === null) return done();\n\n  // Still busy binding.\n  this.server.once(\"listening\", done);\n  this.server.once(\"error\", (err) => {\n    send(err.errno, null);\n  });\n};\n\nRoundRobinHandle.prototype.distribute = function (err, handle) {\n  this.handles.push(handle);\n  const worker = this.free.shift();\n\n  if (worker) this.handoff(worker);\n};\n\nRoundRobinHandle.prototype.handoff = function (worker) {\n  // worker\n  if (this.all.has(worker.id) === false) {\n    return; // Worker is closing (or has closed) the server.\n  }\n\n  const handle = this.handles.shift(); // \n\n  if (handle === undefined) {\n    this.free.push(worker);  // workerfree\n    return;\n  }\n\n  const message = { act: \"newconn\", key: this.key };\n\n  sendHelper(worker.process, message, handle, (reply) => {\n    if (reply.accepted) handle.close();\n    else this.distribute(0, handle); // Worker is shutting down. Send to another.\n\n    this.handoff(worker);\n  });\n};\n```\n\n### \n\n`cluster`child_processfork`NODE_UNIQUE_ID`require('cluster')`master.js``child.js``RoundRobinHandle``cluster`TCP`net`masterchildchildchildmasterServer`RoundRobinHandle`serverTCP`free`workercluster.child","source":"_posts/node-js-net-cluster-fork.md","raw":"---\nlayout: minos\ntitle: Node.js cluster\ndate: 2020-05-03 15:24:53\ncategory: JavaScript\ntags:\n  - Node.js\n  - JavaScript\nkeywords: child_process,cluster,fork,Node.js,TCP\ndescription: RoundRobinHandleclusterTCPnetmasterchildchildchildmasterServerRoundRobinHandleserverTCPfreeworkercluster.child\n---\n\nNode.js**child_process**4`exec``execFile``fork``spawn`**cluster**cluster.forkNet Server\n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): \n\n<!-- more -->\n\n<br/>\n\n****\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**cluster**\n\n```markdown\nlib\n  - internal\n    - cluster\n    - child.js\n      - master.js\n      - round_robin_handle.js\n      - shared_handle.js\n      - utils.js\n      - worker.js\n  - cluster.js\n```\n\n<br/>\n\n****\n\n```javascript\nconst cluster = require('cluster');\nconst http = require('http');\nconst numCPUs = require('os').cpus().length;\n\nif (cluster.isMaster) {\n  console.log(` ${process.pid} `);\n\n  // \n  for (let i = 0; i < numCPUs; i++) {\n    cluster.fork();\n  }\n\n  cluster.on('exit', (worker, code, signal) => {\n    console.log(` ${worker.process.pid} `);\n  });\n} else {\n  //  TCP \n  //  HTTP \n  http.createServer((req, res) => {\n    res.writeHead(200);\n    res.end('\\n');\n  }).listen(8000);\n\n  console.log(` ${process.pid} `);\n}\n```\n\n<br/>\n\n### Q:cluster.isMaster\n\n```javascript\n// lib/cluster.js\nconst childOrMaster = 'NODE_UNIQUE_ID' in process.env ? 'child' : 'master';\nmodule.exports = require(`internal/cluster/${childOrMaster}`);\n```\n\n`lib/cluster.js`cluster`NODE_UNIQUE_ID`\n\n`cluster.fork``NODE_UNIQUE_ID`**child_process.fork**\n\n```javascript\n// lib/internal/cluster/master.js\n// ...\ncluster.isMaster = true;\n// ...\n// fork\nconst workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\nreturn fork(cluster.settings.exec, cluster.settings.args, {\n  // ...\n  env: workerEnv,\n});\n\n// lib/internal/cluster/child.js\n// ...\ncluster.isMaster = false;\n```\n\n### Q:cluster.fork\n\n`cluster.setupMaster`\n\n`createWorkerProcess``child_process.fork`\n\n`Worker`workercluster(master)`message``exit``disconnect`**Worker**`lib/internal/cluster/worker.js`\n\n`internalMessage`internalMessage\n\n>  **{cmd: 'NODE_foo'}**  **cmd**  **NODE_**  Node.js  **'message'**  **'internalMessage'**  Node.js  **'internalMessage'** \n\n`internalMessage``internal(worker, onmessage)`**internal**`lib/internal/cluster/master.js`**onmessage**\n\n**onmessage**if-elsecluster.child(`act`)`queryServer`Net Server\n\n```javascript\n// lib/internal/cluster/master.js\ncluster.fork = function (env) {\n  cluster.setupMaster();\n  const id = ++ids;\n  // \n  const workerProcess = createWorkerProcess(id, env);\n  //\n  const worker = new Worker({\n    id: id,\n    process: workerProcess, // \n  });\n  \n  worker.on(\"message\", function (message, handle) {\n    cluster.emit(\"message\", this, message, handle);\n  });\n  worker.process.once(\"exit\", (exitCode, signalCode) => {\n    // ...\n    worker.state = \"dead\";\n    worker.emit(\"exit\", exitCode, signalCode);\n    cluster.emit(\"exit\", worker, exitCode, signalCode);\n  });\n  worker.process.once(\"disconnect\", () => {\n    // ...\n    worker.state = \"disconnected\";\n    worker.emit(\"disconnect\");\n    cluster.emit(\"disconnect\", worker);\n  });\n\n  worker.process.on(\"internalMessage\", internal(worker, onmessage));\n  //  fork \n  process.nextTick(emitForkNT, worker);\n  cluster.workers[worker.id] = worker; \n  return worker;\n};\n\nfunction createWorkerProcess(id, env) {\n  const workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\n  // ... \n  // child_processfork\n  return fork(cluster.settings.exec, cluster.settings.args, {\n    cwd: cluster.settings.cwd,\n    env: workerEnv,\n    silent: cluster.settings.silent,\n    windowsHide: cluster.settings.windowsHide,\n    execArgv: execArgv,\n    stdio: cluster.settings.stdio,\n    gid: cluster.settings.gid,\n    uid: cluster.settings.uid,\n  });\n}\nfunction onmessage(message, handle) {\n  const worker = this;\n  // ... if message.act   queryServer\n  if (message.act === \"queryServer\") queryServer(worker, message);\n}\n```\n\n```javascript\n// lib/internal/cluster/utils.js\n// clusterchilidmastersendsendHelper\nlet seq = 0;\nfunction sendHelper(proc, message, handle, cb) {\n  if (!proc.connected) return false;\n  // NODE_*  internalMessage \n  message = { cmd: \"NODE_CLUSTER\", ...message, seq };\n\n  if (typeof cb === \"function\") callbacks.set(seq, cb); // \n\n  seq += 1;\n  // cluster/child.js handle => null\n  // cluster/master.js handle => null\n  return proc.send(message, handle);\n}\n```\n\ncluster.forkWorkerinternalMessageclusterchildmaster`sendHelper`\n\n### Q:cluster.forkTCP\n\n`net`Servercluster`child``master`\n\n`http``net``net.createServer``listen`\n\n#### Child:\n\ncluster.childTCP`port`8000`host`\n\n`listenInCluster`**cluster**\n\n`listen``cluster._getServer``act`serverQuerycluster.master\n\n#### Master:\n\n`master.onmessage`act`serverQuery`\n\n`queryServer``RoundRobinHandle`\n\n`RoundRobinHandle``net.createServer`Servercluster.master`listenInCluster``server._listen2`new  `TCP`src/tcp_wrap.cc`server._handle`cluster.masterTCPmasterchild\n\n`RoundRobinHandle`server`listening``server._handle``distribute``onconnection`\n\n`distribute`TCPcluster.child`free``add`workerworkercluster.child`act`**newconn**TCP\n\n#### Child:\n\ncluster.child`onconnection``act`**newconn**server`onconnection`child`Socket``onnection`\n\n\n\n**\n\n```javascript\n// lib/net.js\nfunction createServer(options, connectionListener) {\n  return new Server(options, connectionListener);\n}\nfunction Server(options, connectionListener) {\n  // ... \n}\nServer.prototype.listen = function (...args) {\n  // ...\n  // port8000host\n  var backlog;\n  if (typeof options.port === \"number\" || typeof options.port === \"string\") {\n    backlog = options.backlog || backlogFromArgs;\n    if (options.host) {\n      // ...\n    } else {\n      // \n      listenInCluster(\n        this,\n        null,\n        options.port | 0,\n        4,\n        backlog,\n        undefined,\n        options.exclusive\n      );\n    }\n    return this;\n  }\n\t// ...\n};\n\n\nfunction listenInCluster(\n  server,\n  address,\n  port,\n  addressType,\n  backlog,\n  fd,\n  exclusive,\n  flags\n) {\n  exclusive = !!exclusive;\n\n  if (cluster === undefined) cluster = require(\"cluster\");\n\n  if (cluster.isMaster || exclusive) {\n    server._listen2(address, port, addressType, backlog, fd, flags);\n    return;\n  }\n\n  const serverQuery = {\n    address: address,\n    port: port, \n    addressType: addressType,\n    fd: fd,\n    flags,\n  };\n  cluster._getServer(server, serverQuery, listenOnMasterHandle);\n\n  function listenOnMasterHandle(err, handle) {\n    // ...\n    server._handle = handle;\n    server._listen2(address, port, addressType, backlog, fd, flags);\n  }\n}\n```\n\n```javascript\n// lib/internal/cluster/child.js\ncluster._getServer = function (obj, options, cb) {\n  let address = options.address;\n\t// ...\n  // servercluster.child\n  // index\n  const indexesKey = [\n    address, \n    options.port,\n    options.addressType,\n    options.fd,\n  ].join(\":\"); \n\n  let index = indexes.get(indexesKey);\n\n  if (index === undefined) index = 0;\n  else index++;\n\n  indexes.set(indexesKey, index);\n\n  const message = {\n    act: \"queryServer\",\n    index,\n    data: null,\n    ...options,\n  };\n  \n  // ...\n\n  send(message, (reply, handle) => {\n    // ...\n    if (handle) shared(reply, handle, indexesKey, cb);\n    // Shared listen socket.\n    else rr(reply, indexesKey, cb); // Round-robin  handle null\n  });\n  // ...\n};\nfunction rr(message, indexesKey, cb) {\n  if (message.errno) return cb(message.errno, null);\n\n  var key = message.key;\n\n  function listen(backlog) {\n    return 0;\n  }\n\n  function close() {\n    if (key === undefined) return;\n    send({ act: \"close\", key });\n    handles.delete(key);\n    indexes.delete(indexesKey);\n    key = undefined;\n  }\n\n  function getsockname(out) {\n    if (key) Object.assign(out, message.sockname);\n    return 0;\n  }\n\n  const handle = { close, listen, ref: noop, unref: noop };\n\n  if (message.sockname) {\n    handle.getsockname = getsockname; // TCP handles only.\n  }\n\n  assert(handles.has(key) === false);\n  handles.set(key, handle);\n  cb(0, handle); // handlelistenInClusterhandleserver._handle\n}\n// Round-robin connection.\nfunction onconnection(message, handle) {\n  const key = message.key; // maseterkey\n  const server = handles.get(key); // clientserver\n  const accepted = server !== undefined;\n\n  send({ ack: message.seq, accepted }); //  master\n\n  // cluster.child rrserveronconnection\n  // cbnet.jsonconnection\n  if (accepted) server.onconnection(0, handle);\n}\n```\n\n```javascript\n// lib/internal/cluster/master.js\nfunction queryServer(worker, message) {\n  // workercluster.child worker\n  const key =\n    `${message.address}:${message.port}:${message.addressType}:` +\n    `${message.fd}:${message.index}`;\n  var handle = handles.get(key);\n\n  if (handle === undefined) {\n  \n    // RoundRobinShared\n    var constructor = RoundRobinHandle;\n    // ...\n    handle = new constructor(\n      key,\n      address,\n      message.port,\n      message.addressType,\n      message.fd,\n      message.flags\n    );\n    handles.set(key, handle);\n  }\n  // ...\n  // cluster.childworkerhandle\n  handle.add(worker, (errno, reply, handle) => {\n    const { data } = handles.get(key);\n    send(\n      worker,\n      {\n        errno,\n        key,\n        ack: message.seq,\n        data,\n        ...reply,\n      },\n      handle // round_robin_handle null\n    );\n  });\n}\n```\n\n```javascript\n// lib/internal/cluster/round_robin_handle.js\nfunction RoundRobinHandle(key, address, port, addressType, fd, flags) {\n  this.key = key;\n  this.all = new Map();\n  this.free = [];\n  this.handles = [];\n  this.handle = null;\n  this.server = net.createServer(assert.fail);\n\n  if (fd >= 0) this.server.listen({ fd });\n  else if (port >= 0) {\n    this.server.listen({\n      port,\n      host: address,\n      // Currently, net module only supports `ipv6Only` option in `flags`.\n      ipv6Only: Boolean(flags & constants.UV_TCP_IPV6ONLY),\n    });\n  } else this.server.listen(address); // UNIX socket path.\n\n  this.server.once(\"listening\", () => {\n    this.handle = this.server._handle;\n    // onconnection\n    // distribute \n    this.handle.onconnection = (err, handle) => this.distribute(err, handle);\n    this.server._handle = null;\n    this.server = null;\n  });\n}\n\nRoundRobinHandle.prototype.add = function (worker, send) {\n  assert(this.all.has(worker.id) === false);\n  this.all.set(worker.id, worker);\n\n  const done = () => {\n    if (this.handle.getsockname) {\n      // tcp\\udp getsockname\n      const out = {};\n      this.handle.getsockname(out);\n      // TODO(bnoordhuis) Check err.\n      send(null, { sockname: out }, null);\n    } else {\n      send(null, null, null); // UNIX socket.\n    }\n\n    this.handoff(worker); // In case there are connections pending.\n  };\n\n  if (this.server === null) return done();\n\n  // Still busy binding.\n  this.server.once(\"listening\", done);\n  this.server.once(\"error\", (err) => {\n    send(err.errno, null);\n  });\n};\n\nRoundRobinHandle.prototype.distribute = function (err, handle) {\n  this.handles.push(handle);\n  const worker = this.free.shift();\n\n  if (worker) this.handoff(worker);\n};\n\nRoundRobinHandle.prototype.handoff = function (worker) {\n  // worker\n  if (this.all.has(worker.id) === false) {\n    return; // Worker is closing (or has closed) the server.\n  }\n\n  const handle = this.handles.shift(); // \n\n  if (handle === undefined) {\n    this.free.push(worker);  // workerfree\n    return;\n  }\n\n  const message = { act: \"newconn\", key: this.key };\n\n  sendHelper(worker.process, message, handle, (reply) => {\n    if (reply.accepted) handle.close();\n    else this.distribute(0, handle); // Worker is shutting down. Send to another.\n\n    this.handoff(worker);\n  });\n};\n```\n\n### \n\n`cluster`child_processfork`NODE_UNIQUE_ID`require('cluster')`master.js``child.js``RoundRobinHandle``cluster`TCP`net`masterchildchildchildmasterServer`RoundRobinHandle`serverTCP`free`workercluster.child","slug":"node-js-net-cluster-fork","published":1,"updated":"2020-07-07T10:11:25.588Z","comments":1,"photos":[],"link":"","_id":"ckcc0bs6d000td12ipm80x4aw","content":"<p>Node.js<strong>child_process</strong>4<code>exec</code><code>execFile</code><code>fork</code><code>spawn</code><strong>cluster</strong>cluster.forkNet Server</p>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\" target=\"_blank\" rel=\"noopener\">fork</a>: </li>\n</ul>\n<a id=\"more\"></a>\n<p><br></p>\n<p><strong></strong></p>\n<figure class=\"highlight markdown hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p><strong>cluster</strong></p>\n<figure class=\"highlight markdown hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lib</span><br><span class=\"line\">  - internal</span><br><span class=\"line\"><span class=\"hljs-code\">    - cluster</span></span><br><span class=\"line\"><span class=\"hljs-code\">    - child.js</span></span><br><span class=\"line\"><span class=\"hljs-code\">      - master.js</span></span><br><span class=\"line\"><span class=\"hljs-code\">      - round_robin_handle.js</span></span><br><span class=\"line\"><span class=\"hljs-code\">      - shared_handle.js</span></span><br><span class=\"line\"><span class=\"hljs-code\">      - utils.js</span></span><br><span class=\"line\"><span class=\"hljs-code\">      - worker.js</span></span><br><span class=\"line\">  - cluster.js</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong></strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> cluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'cluster'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> http = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'http'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> numCPUs = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'os'</span>).cpus().length;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">if</span> (cluster.isMaster) &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">` <span class=\"hljs-subst\">$&#123;process.pid&#125;</span> `</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class=\"line\">    cluster.fork();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  cluster.on(<span class=\"hljs-string\">'exit'</span>, (worker, code, signal) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">` <span class=\"hljs-subst\">$&#123;worker.process.pid&#125;</span> `</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  TCP </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  HTTP </span></span><br><span class=\"line\">  http.createServer(<span class=\"hljs-function\">(<span class=\"hljs-params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    res.writeHead(<span class=\"hljs-number\">200</span>);</span><br><span class=\"line\">    res.end(<span class=\"hljs-string\">'\\n'</span>);</span><br><span class=\"line\">  &#125;).listen(<span class=\"hljs-number\">8000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">` <span class=\"hljs-subst\">$&#123;process.pid&#125;</span> `</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h3 id=\"Q-cluster-isMaster\"><a href=\"#Q-cluster-isMaster\" class=\"headerlink\" title=\"Q:cluster.isMaster\"></a>Q:cluster.isMaster</h3><figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/cluster.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> childOrMaster = <span class=\"hljs-string\">'NODE_UNIQUE_ID'</span> <span class=\"hljs-keyword\">in</span> process.env ? <span class=\"hljs-string\">'child'</span> : <span class=\"hljs-string\">'master'</span>;</span><br><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">`internal/cluster/<span class=\"hljs-subst\">$&#123;childOrMaster&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>\n<p><code>lib/cluster.js</code>cluster<code>NODE_UNIQUE_ID</code></p>\n<p><code>cluster.fork</code><code>NODE_UNIQUE_ID</code><strong>child_process.fork</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">cluster.isMaster = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// fork</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> workerEnv = &#123; ...process.env, ...env, <span class=\"hljs-attr\">NODE_UNIQUE_ID</span>: <span class=\"hljs-string\">`<span class=\"hljs-subst\">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class=\"line\"><span class=\"hljs-keyword\">return</span> fork(cluster.settings.exec, cluster.settings.args, &#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  env: workerEnv,</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">cluster.isMaster = <span class=\"hljs-literal\">false</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Q-cluster-fork\"><a href=\"#Q-cluster-fork\" class=\"headerlink\" title=\"Q:cluster.fork\"></a>Q:cluster.fork</h3><p><code>cluster.setupMaster</code></p>\n<p><code>createWorkerProcess</code><code>child_process.fork</code></p>\n<p><code>Worker</code>workercluster(master)<code>message</code><code>exit</code><code>disconnect</code><strong>Worker</strong><code>lib/internal/cluster/worker.js</code></p>\n<p><code>internalMessage</code>internalMessage</p>\n<blockquote>\n<p> <strong>{cmd: NODE_foo}</strong>  <strong>cmd</strong>  <strong>NODE_</strong>  Node.js  <strong>message</strong>  <strong>internalMessage</strong>  Node.js  <strong>internalMessage</strong> </p>\n</blockquote>\n<p><code>internalMessage</code><code>internal(worker, onmessage)</code><strong>internal</strong><code>lib/internal/cluster/master.js</code><strong>onmessage</strong></p>\n<p><strong>onmessage</strong>if-elsecluster.child(<code>act</code>)<code>queryServer</code>Net Server</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\">cluster.fork = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">env</span>) </span>&#123;</span><br><span class=\"line\">  cluster.setupMaster();</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> id = ++ids;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> workerProcess = createWorkerProcess(id, env);</span><br><span class=\"line\">  <span class=\"hljs-comment\">//</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> worker = <span class=\"hljs-keyword\">new</span> Worker(&#123;</span><br><span class=\"line\">    id: id,</span><br><span class=\"line\">    process: workerProcess, <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  </span><br><span class=\"line\">  worker.on(<span class=\"hljs-string\">\"message\"</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">    cluster.emit(<span class=\"hljs-string\">\"message\"</span>, <span class=\"hljs-keyword\">this</span>, message, handle);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  worker.process.once(<span class=\"hljs-string\">\"exit\"</span>, (exitCode, signalCode) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    worker.state = <span class=\"hljs-string\">\"dead\"</span>;</span><br><span class=\"line\">    worker.emit(<span class=\"hljs-string\">\"exit\"</span>, exitCode, signalCode);</span><br><span class=\"line\">    cluster.emit(<span class=\"hljs-string\">\"exit\"</span>, worker, exitCode, signalCode);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  worker.process.once(<span class=\"hljs-string\">\"disconnect\"</span>, () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    worker.state = <span class=\"hljs-string\">\"disconnected\"</span>;</span><br><span class=\"line\">    worker.emit(<span class=\"hljs-string\">\"disconnect\"</span>);</span><br><span class=\"line\">    cluster.emit(<span class=\"hljs-string\">\"disconnect\"</span>, worker);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  worker.process.on(<span class=\"hljs-string\">\"internalMessage\"</span>, internal(worker, onmessage));</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  fork </span></span><br><span class=\"line\">  process.nextTick(emitForkNT, worker);</span><br><span class=\"line\">  cluster.workers[worker.id] = worker; </span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> worker;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">createWorkerProcess</span>(<span class=\"hljs-params\">id, env</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> workerEnv = &#123; ...process.env, ...env, <span class=\"hljs-attr\">NODE_UNIQUE_ID</span>: <span class=\"hljs-string\">`<span class=\"hljs-subst\">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// child_processfork</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> fork(cluster.settings.exec, cluster.settings.args, &#123;</span><br><span class=\"line\">    cwd: cluster.settings.cwd,</span><br><span class=\"line\">    env: workerEnv,</span><br><span class=\"line\">    silent: cluster.settings.silent,</span><br><span class=\"line\">    windowsHide: cluster.settings.windowsHide,</span><br><span class=\"line\">    execArgv: execArgv,</span><br><span class=\"line\">    stdio: cluster.settings.stdio,</span><br><span class=\"line\">    gid: cluster.settings.gid,</span><br><span class=\"line\">    uid: cluster.settings.uid,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">onmessage</span>(<span class=\"hljs-params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> worker = <span class=\"hljs-keyword\">this</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... if message.act   queryServer</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (message.act === <span class=\"hljs-string\">\"queryServer\"</span>) queryServer(worker, message);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/utils.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// clusterchilidmastersendsendHelper</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> seq = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">sendHelper</span>(<span class=\"hljs-params\">proc, message, handle, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!proc.connected) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// NODE_*  internalMessage </span></span><br><span class=\"line\">  message = &#123; <span class=\"hljs-attr\">cmd</span>: <span class=\"hljs-string\">\"NODE_CLUSTER\"</span>, ...message, seq &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> cb === <span class=\"hljs-string\">\"function\"</span>) callbacks.set(seq, cb); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  seq += <span class=\"hljs-number\">1</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// cluster/child.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// cluster/master.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> proc.send(message, handle);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>cluster.forkWorkerinternalMessageclusterchildmaster<code>sendHelper</code></p>\n<h3 id=\"Q-cluster-forkTCP\"><a href=\"#Q-cluster-forkTCP\" class=\"headerlink\" title=\"Q:cluster.forkTCP\"></a>Q:cluster.forkTCP</h3><p><code>net</code>Servercluster<code>child</code><code>master</code></p>\n<p><code>http</code><code>net</code><code>net.createServer</code><code>listen</code></p>\n<h4 id=\"Child\"><a href=\"#Child\" class=\"headerlink\" title=\"Child:\"></a>Child:</h4><p>cluster.childTCP<code>port</code>8000<code>host</code></p>\n<p><code>listenInCluster</code><strong>cluster</strong></p>\n<p><code>listen</code><code>cluster._getServer</code><code>act</code>serverQuerycluster.master</p>\n<h4 id=\"Master\"><a href=\"#Master\" class=\"headerlink\" title=\"Master:\"></a>Master:</h4><p><code>master.onmessage</code>act<code>serverQuery</code></p>\n<p><code>queryServer</code><code>RoundRobinHandle</code></p>\n<p><code>RoundRobinHandle</code><code>net.createServer</code>Servercluster.master<code>listenInCluster</code><code>server._listen2</code>new  <code>TCP</code>src/tcp_wrap.cc<code>server._handle</code>cluster.masterTCPmasterchild</p>\n<p><code>RoundRobinHandle</code>server<code>listening</code><code>server._handle</code><code>distribute</code><code>onconnection</code></p>\n<p><code>distribute</code>TCPcluster.child<code>free</code><code>add</code>workerworkercluster.child<code>act</code><strong>newconn</strong>TCP</p>\n<h4 id=\"Child\"><a href=\"#Child\" class=\"headerlink\" title=\"Child:\"></a>Child:</h4><p>cluster.child<code>onconnection</code><code>act</code><strong>newconn</strong>server<code>onconnection</code>child<code>Socket</code><code>onnection</code></p>\n<p></p>\n<p><em></em></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/net.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">createServer</span>(<span class=\"hljs-params\">options, connectionListener</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Server(options, connectionListener);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">Server</span>(<span class=\"hljs-params\">options, connectionListener</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Server.prototype.listen = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">...args</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// port8000host</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> backlog;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> options.port === <span class=\"hljs-string\">\"number\"</span> || <span class=\"hljs-keyword\">typeof</span> options.port === <span class=\"hljs-string\">\"string\"</span>) &#123;</span><br><span class=\"line\">    backlog = options.backlog || backlogFromArgs;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (options.host) &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      listenInCluster(</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>,</span><br><span class=\"line\">        <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">        options.port | <span class=\"hljs-number\">0</span>,</span><br><span class=\"line\">        <span class=\"hljs-number\">4</span>,</span><br><span class=\"line\">        backlog,</span><br><span class=\"line\">        <span class=\"hljs-literal\">undefined</span>,</span><br><span class=\"line\">        options.exclusive</span><br><span class=\"line\">      );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">\t<span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">listenInCluster</span>(<span class=\"hljs-params\"></span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  server,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  address,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  port,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  addressType,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  backlog,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  fd,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  exclusive,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">  flags</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  exclusive = !!exclusive;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (cluster === <span class=\"hljs-literal\">undefined</span>) cluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">\"cluster\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (cluster.isMaster || exclusive) &#123;</span><br><span class=\"line\">    server._listen2(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> serverQuery = &#123;</span><br><span class=\"line\">    address: address,</span><br><span class=\"line\">    port: port, </span><br><span class=\"line\">    addressType: addressType,</span><br><span class=\"line\">    fd: fd,</span><br><span class=\"line\">    flags,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  cluster._getServer(server, serverQuery, listenOnMasterHandle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">listenOnMasterHandle</span>(<span class=\"hljs-params\">err, handle</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    server._handle = handle;</span><br><span class=\"line\">    server._listen2(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\">cluster._getServer = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">obj, options, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> address = options.address;</span><br><span class=\"line\">\t<span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// servercluster.child</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// index</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> indexesKey = [</span><br><span class=\"line\">    address, </span><br><span class=\"line\">    options.port,</span><br><span class=\"line\">    options.addressType,</span><br><span class=\"line\">    options.fd,</span><br><span class=\"line\">  ].join(<span class=\"hljs-string\">\":\"</span>); </span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> index = indexes.get(indexesKey);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (index === <span class=\"hljs-literal\">undefined</span>) index = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">else</span> index++;</span><br><span class=\"line\"></span><br><span class=\"line\">  indexes.set(indexesKey, index);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> message = &#123;</span><br><span class=\"line\">    act: <span class=\"hljs-string\">\"queryServer\"</span>,</span><br><span class=\"line\">    index,</span><br><span class=\"line\">    data: <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  send(message, (reply, handle) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (handle) shared(reply, handle, indexesKey, cb);</span><br><span class=\"line\">    <span class=\"hljs-comment\">// Shared listen socket.</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">else</span> rr(reply, indexesKey, cb); <span class=\"hljs-comment\">// Round-robin  handle null</span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">rr</span>(<span class=\"hljs-params\">message, indexesKey, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (message.errno) <span class=\"hljs-keyword\">return</span> cb(message.errno, <span class=\"hljs-literal\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> key = message.key;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">listen</span>(<span class=\"hljs-params\">backlog</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">close</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (key === <span class=\"hljs-literal\">undefined</span>) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    send(&#123; <span class=\"hljs-attr\">act</span>: <span class=\"hljs-string\">\"close\"</span>, key &#125;);</span><br><span class=\"line\">    handles.delete(key);</span><br><span class=\"line\">    indexes.delete(indexesKey);</span><br><span class=\"line\">    key = <span class=\"hljs-literal\">undefined</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getsockname</span>(<span class=\"hljs-params\">out</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (key) <span class=\"hljs-built_in\">Object</span>.assign(out, message.sockname);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> handle = &#123; close, listen, <span class=\"hljs-attr\">ref</span>: noop, <span class=\"hljs-attr\">unref</span>: noop &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (message.sockname) &#123;</span><br><span class=\"line\">    handle.getsockname = getsockname; <span class=\"hljs-comment\">// TCP handles only.</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  assert(handles.has(key) === <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">  handles.set(key, handle);</span><br><span class=\"line\">  cb(<span class=\"hljs-number\">0</span>, handle); <span class=\"hljs-comment\">// handlelistenInClusterhandleserver._handle</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// Round-robin connection.</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">onconnection</span>(<span class=\"hljs-params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> key = message.key; <span class=\"hljs-comment\">// maseterkey</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> server = handles.get(key); <span class=\"hljs-comment\">// clientserver</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> accepted = server !== <span class=\"hljs-literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  send(&#123; <span class=\"hljs-attr\">ack</span>: message.seq, accepted &#125;); <span class=\"hljs-comment\">//  master</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// cluster.child rrserveronconnection</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// cbnet.jsonconnection</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (accepted) server.onconnection(<span class=\"hljs-number\">0</span>, handle);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">queryServer</span>(<span class=\"hljs-params\">worker, message</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// workercluster.child worker</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> key =</span><br><span class=\"line\">    <span class=\"hljs-string\">`<span class=\"hljs-subst\">$&#123;message.address&#125;</span>:<span class=\"hljs-subst\">$&#123;message.port&#125;</span>:<span class=\"hljs-subst\">$&#123;message.addressType&#125;</span>:`</span> +</span><br><span class=\"line\">    <span class=\"hljs-string\">`<span class=\"hljs-subst\">$&#123;message.fd&#125;</span>:<span class=\"hljs-subst\">$&#123;message.index&#125;</span>`</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> handle = handles.get(key);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (handle === <span class=\"hljs-literal\">undefined</span>) &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"hljs-comment\">// RoundRobinShared</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> <span class=\"hljs-keyword\">constructor</span> = RoundRobinHandle;</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">    handle = new <span class=\"hljs-keyword\">constructor</span>(</span><br><span class=\"line\">      key,</span><br><span class=\"line\">      address,</span><br><span class=\"line\">      message.port,</span><br><span class=\"line\">      message.addressType,</span><br><span class=\"line\">      message.fd,</span><br><span class=\"line\">      message.flags</span><br><span class=\"line\">    );</span><br><span class=\"line\">    handles.set(key, handle);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">  // cluster.childworkerhandle</span><br><span class=\"line\">  handle.add(worker, (errno, reply, handle) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> &#123; data &#125; = handles.get(key);</span><br><span class=\"line\">    send(</span><br><span class=\"line\">      worker,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        errno,</span><br><span class=\"line\">        key,</span><br><span class=\"line\">        ack: message.seq,</span><br><span class=\"line\">        data,</span><br><span class=\"line\">        ...reply,</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      handle <span class=\"hljs-comment\">// round_robin_handle null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/round_robin_handle.js</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">RoundRobinHandle</span>(<span class=\"hljs-params\">key, address, port, addressType, fd, flags</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.key = key;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.all = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Map</span>();</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.free = [];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.handles = [];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.handle = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.server = net.createServer(assert.fail);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (fd &gt;= <span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">this</span>.server.listen(&#123; fd &#125;);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (port &gt;= <span class=\"hljs-number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.server.listen(&#123;</span><br><span class=\"line\">      port,</span><br><span class=\"line\">      host: address,</span><br><span class=\"line\">      <span class=\"hljs-comment\">// Currently, net module only supports `ipv6Only` option in `flags`.</span></span><br><span class=\"line\">      ipv6Only: <span class=\"hljs-built_in\">Boolean</span>(flags &amp; constants.UV_TCP_IPV6ONLY),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">this</span>.server.listen(address); <span class=\"hljs-comment\">// UNIX socket path.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.server.once(<span class=\"hljs-string\">\"listening\"</span>, () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.handle = <span class=\"hljs-keyword\">this</span>.server._handle;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// onconnection</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// distribute </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.handle.onconnection = <span class=\"hljs-function\">(<span class=\"hljs-params\">err, handle</span>) =&gt;</span> <span class=\"hljs-keyword\">this</span>.distribute(err, handle);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.server._handle = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.server = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.add = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">worker, send</span>) </span>&#123;</span><br><span class=\"line\">  assert(<span class=\"hljs-keyword\">this</span>.all.has(worker.id) === <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.all.set(worker.id, worker);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> done = <span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.handle.getsockname) &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// tcp\\udp getsockname</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> out = &#123;&#125;;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.handle.getsockname(out);</span><br><span class=\"line\">      <span class=\"hljs-comment\">// TODO(bnoordhuis) Check err.</span></span><br><span class=\"line\">      send(<span class=\"hljs-literal\">null</span>, &#123; <span class=\"hljs-attr\">sockname</span>: out &#125;, <span class=\"hljs-literal\">null</span>);</span><br><span class=\"line\">    &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">      send(<span class=\"hljs-literal\">null</span>, <span class=\"hljs-literal\">null</span>, <span class=\"hljs-literal\">null</span>); <span class=\"hljs-comment\">// UNIX socket.</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.handoff(worker); <span class=\"hljs-comment\">// In case there are connections pending.</span></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.server === <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span> done();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Still busy binding.</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.server.once(<span class=\"hljs-string\">\"listening\"</span>, done);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.server.once(<span class=\"hljs-string\">\"error\"</span>, (err) =&gt; &#123;</span><br><span class=\"line\">    send(err.errno, <span class=\"hljs-literal\">null</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.distribute = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>.handles.push(handle);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> worker = <span class=\"hljs-keyword\">this</span>.free.shift();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (worker) <span class=\"hljs-keyword\">this</span>.handoff(worker);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.handoff = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">worker</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// worker</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.all.has(worker.id) === <span class=\"hljs-literal\">false</span>) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>; <span class=\"hljs-comment\">// Worker is closing (or has closed) the server.</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> handle = <span class=\"hljs-keyword\">this</span>.handles.shift(); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (handle === <span class=\"hljs-literal\">undefined</span>) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.free.push(worker);  <span class=\"hljs-comment\">// workerfree</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> message = &#123; <span class=\"hljs-attr\">act</span>: <span class=\"hljs-string\">\"newconn\"</span>, <span class=\"hljs-attr\">key</span>: <span class=\"hljs-keyword\">this</span>.key &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  sendHelper(worker.process, message, handle, (reply) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (reply.accepted) handle.close();</span><br><span class=\"line\">    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">this</span>.distribute(<span class=\"hljs-number\">0</span>, handle); <span class=\"hljs-comment\">// Worker is shutting down. Send to another.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.handoff(worker);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>cluster</code>child_processfork<code>NODE_UNIQUE_ID</code>require(cluster)<code>master.js</code><code>child.js</code><code>RoundRobinHandle</code><code>cluster</code>TCP<code>net</code>masterchildchildchildmasterServer<code>RoundRobinHandle</code>serverTCP<code>free</code>workercluster.child</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p>Node.js<strong>child_process</strong>4<code>exec</code><code>execFile</code><code>fork</code><code>spawn</code><strong>cluster</strong>cluster.forkNet Server</p>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\" target=\"_blank\" rel=\"noopener\">fork</a>: </li>\n</ul>","more":"<p><br></p>\n<p><strong></strong></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"section\">#define UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"section\">#define V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"section\">#define V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"section\">#define V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"section\">#define V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"section\">#define NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"section\">#define NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"section\">#define NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p><strong>cluster</strong></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lib</span><br><span class=\"line\">  - internal</span><br><span class=\"line\"><span class=\"code\">    - cluster</span></span><br><span class=\"line\"><span class=\"code\">    - child.js</span></span><br><span class=\"line\"><span class=\"code\">      - master.js</span></span><br><span class=\"line\"><span class=\"code\">      - round_robin_handle.js</span></span><br><span class=\"line\"><span class=\"code\">      - shared_handle.js</span></span><br><span class=\"line\"><span class=\"code\">      - utils.js</span></span><br><span class=\"line\"><span class=\"code\">      - worker.js</span></span><br><span class=\"line\">  - cluster.js</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong></strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> cluster = <span class=\"built_in\">require</span>(<span class=\"string\">'cluster'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> http = <span class=\"built_in\">require</span>(<span class=\"string\">'http'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> numCPUs = <span class=\"built_in\">require</span>(<span class=\"string\">'os'</span>).cpus().length;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (cluster.isMaster) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">` <span class=\"subst\">$&#123;process.pid&#125;</span> `</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class=\"line\">    cluster.fork();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  cluster.on(<span class=\"string\">'exit'</span>, (worker, code, signal) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">` <span class=\"subst\">$&#123;worker.process.pid&#125;</span> `</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">//  TCP </span></span><br><span class=\"line\">  <span class=\"comment\">//  HTTP </span></span><br><span class=\"line\">  http.createServer(<span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    res.writeHead(<span class=\"number\">200</span>);</span><br><span class=\"line\">    res.end(<span class=\"string\">'\\n'</span>);</span><br><span class=\"line\">  &#125;).listen(<span class=\"number\">8000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">` <span class=\"subst\">$&#123;process.pid&#125;</span> `</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h3 id=\"Q-cluster-isMaster\"><a href=\"#Q-cluster-isMaster\" class=\"headerlink\" title=\"Q:cluster.isMaster\"></a>Q:cluster.isMaster</h3><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/cluster.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> childOrMaster = <span class=\"string\">'NODE_UNIQUE_ID'</span> <span class=\"keyword\">in</span> process.env ? <span class=\"string\">'child'</span> : <span class=\"string\">'master'</span>;</span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"built_in\">require</span>(<span class=\"string\">`internal/cluster/<span class=\"subst\">$&#123;childOrMaster&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>\n<p><code>lib/cluster.js</code>cluster<code>NODE_UNIQUE_ID</code></p>\n<p><code>cluster.fork</code><code>NODE_UNIQUE_ID</code><strong>child_process.fork</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">cluster.isMaster = <span class=\"literal\">true</span>;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"><span class=\"comment\">// fork</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> workerEnv = &#123; ...process.env, ...env, <span class=\"attr\">NODE_UNIQUE_ID</span>: <span class=\"string\">`<span class=\"subst\">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class=\"line\"><span class=\"keyword\">return</span> fork(cluster.settings.exec, cluster.settings.args, &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  env: workerEnv,</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">cluster.isMaster = <span class=\"literal\">false</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Q-cluster-fork\"><a href=\"#Q-cluster-fork\" class=\"headerlink\" title=\"Q:cluster.fork\"></a>Q:cluster.fork</h3><p><code>cluster.setupMaster</code></p>\n<p><code>createWorkerProcess</code><code>child_process.fork</code></p>\n<p><code>Worker</code>workercluster(master)<code>message</code><code>exit</code><code>disconnect</code><strong>Worker</strong><code>lib/internal/cluster/worker.js</code></p>\n<p><code>internalMessage</code>internalMessage</p>\n<blockquote>\n<p> <strong>{cmd: NODE_foo}</strong>  <strong>cmd</strong>  <strong>NODE_</strong>  Node.js  <strong>message</strong>  <strong>internalMessage</strong>  Node.js  <strong>internalMessage</strong> </p>\n</blockquote>\n<p><code>internalMessage</code><code>internal(worker, onmessage)</code><strong>internal</strong><code>lib/internal/cluster/master.js</code><strong>onmessage</strong></p>\n<p><strong>onmessage</strong>if-elsecluster.child(<code>act</code>)<code>queryServer</code>Net Server</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\">cluster.fork = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">env</span>) </span>&#123;</span><br><span class=\"line\">  cluster.setupMaster();</span><br><span class=\"line\">  <span class=\"keyword\">const</span> id = ++ids;</span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> workerProcess = createWorkerProcess(id, env);</span><br><span class=\"line\">  <span class=\"comment\">//</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> worker = <span class=\"keyword\">new</span> Worker(&#123;</span><br><span class=\"line\">    id: id,</span><br><span class=\"line\">    process: workerProcess, <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  </span><br><span class=\"line\">  worker.on(<span class=\"string\">\"message\"</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">    cluster.emit(<span class=\"string\">\"message\"</span>, <span class=\"keyword\">this</span>, message, handle);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  worker.process.once(<span class=\"string\">\"exit\"</span>, (exitCode, signalCode) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    worker.state = <span class=\"string\">\"dead\"</span>;</span><br><span class=\"line\">    worker.emit(<span class=\"string\">\"exit\"</span>, exitCode, signalCode);</span><br><span class=\"line\">    cluster.emit(<span class=\"string\">\"exit\"</span>, worker, exitCode, signalCode);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  worker.process.once(<span class=\"string\">\"disconnect\"</span>, () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    worker.state = <span class=\"string\">\"disconnected\"</span>;</span><br><span class=\"line\">    worker.emit(<span class=\"string\">\"disconnect\"</span>);</span><br><span class=\"line\">    cluster.emit(<span class=\"string\">\"disconnect\"</span>, worker);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  worker.process.on(<span class=\"string\">\"internalMessage\"</span>, internal(worker, onmessage));</span><br><span class=\"line\">  <span class=\"comment\">//  fork </span></span><br><span class=\"line\">  process.nextTick(emitForkNT, worker);</span><br><span class=\"line\">  cluster.workers[worker.id] = worker; </span><br><span class=\"line\">  <span class=\"keyword\">return</span> worker;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createWorkerProcess</span>(<span class=\"params\">id, env</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> workerEnv = &#123; ...process.env, ...env, <span class=\"attr\">NODE_UNIQUE_ID</span>: <span class=\"string\">`<span class=\"subst\">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class=\"line\">  <span class=\"comment\">// ... </span></span><br><span class=\"line\">  <span class=\"comment\">// child_processfork</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> fork(cluster.settings.exec, cluster.settings.args, &#123;</span><br><span class=\"line\">    cwd: cluster.settings.cwd,</span><br><span class=\"line\">    env: workerEnv,</span><br><span class=\"line\">    silent: cluster.settings.silent,</span><br><span class=\"line\">    windowsHide: cluster.settings.windowsHide,</span><br><span class=\"line\">    execArgv: execArgv,</span><br><span class=\"line\">    stdio: cluster.settings.stdio,</span><br><span class=\"line\">    gid: cluster.settings.gid,</span><br><span class=\"line\">    uid: cluster.settings.uid,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onmessage</span>(<span class=\"params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> worker = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  <span class=\"comment\">// ... if message.act   queryServer</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (message.act === <span class=\"string\">\"queryServer\"</span>) queryServer(worker, message);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/utils.js</span></span><br><span class=\"line\"><span class=\"comment\">// clusterchilidmastersendsendHelper</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> seq = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">sendHelper</span>(<span class=\"params\">proc, message, handle, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!proc.connected) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  <span class=\"comment\">// NODE_*  internalMessage </span></span><br><span class=\"line\">  message = &#123; <span class=\"attr\">cmd</span>: <span class=\"string\">\"NODE_CLUSTER\"</span>, ...message, seq &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> cb === <span class=\"string\">\"function\"</span>) callbacks.set(seq, cb); <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  seq += <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"comment\">// cluster/child.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"comment\">// cluster/master.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> proc.send(message, handle);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>cluster.forkWorkerinternalMessageclusterchildmaster<code>sendHelper</code></p>\n<h3 id=\"Q-cluster-forkTCP\"><a href=\"#Q-cluster-forkTCP\" class=\"headerlink\" title=\"Q:cluster.forkTCP\"></a>Q:cluster.forkTCP</h3><p><code>net</code>Servercluster<code>child</code><code>master</code></p>\n<p><code>http</code><code>net</code><code>net.createServer</code><code>listen</code></p>\n<h4 id=\"Child\"><a href=\"#Child\" class=\"headerlink\" title=\"Child:\"></a>Child:</h4><p>cluster.childTCP<code>port</code>8000<code>host</code></p>\n<p><code>listenInCluster</code><strong>cluster</strong></p>\n<p><code>listen</code><code>cluster._getServer</code><code>act</code>serverQuerycluster.master</p>\n<h4 id=\"Master\"><a href=\"#Master\" class=\"headerlink\" title=\"Master:\"></a>Master:</h4><p><code>master.onmessage</code>act<code>serverQuery</code></p>\n<p><code>queryServer</code><code>RoundRobinHandle</code></p>\n<p><code>RoundRobinHandle</code><code>net.createServer</code>Servercluster.master<code>listenInCluster</code><code>server._listen2</code>new  <code>TCP</code>src/tcp_wrap.cc<code>server._handle</code>cluster.masterTCPmasterchild</p>\n<p><code>RoundRobinHandle</code>server<code>listening</code><code>server._handle</code><code>distribute</code><code>onconnection</code></p>\n<p><code>distribute</code>TCPcluster.child<code>free</code><code>add</code>workerworkercluster.child<code>act</code><strong>newconn</strong>TCP</p>\n<h4 id=\"Child\"><a href=\"#Child\" class=\"headerlink\" title=\"Child:\"></a>Child:</h4><p>cluster.child<code>onconnection</code><code>act</code><strong>newconn</strong>server<code>onconnection</code>child<code>Socket</code><code>onnection</code></p>\n<p></p>\n<p><em></em></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/net.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createServer</span>(<span class=\"params\">options, connectionListener</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Server(options, connectionListener);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Server</span>(<span class=\"params\">options, connectionListener</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ... </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Server.prototype.listen = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"comment\">// port8000host</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> backlog;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options.port === <span class=\"string\">\"number\"</span> || <span class=\"keyword\">typeof</span> options.port === <span class=\"string\">\"string\"</span>) &#123;</span><br><span class=\"line\">    backlog = options.backlog || backlogFromArgs;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (options.host) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// </span></span><br><span class=\"line\">      listenInCluster(</span><br><span class=\"line\">        <span class=\"keyword\">this</span>,</span><br><span class=\"line\">        <span class=\"literal\">null</span>,</span><br><span class=\"line\">        options.port | <span class=\"number\">0</span>,</span><br><span class=\"line\">        <span class=\"number\">4</span>,</span><br><span class=\"line\">        backlog,</span><br><span class=\"line\">        <span class=\"literal\">undefined</span>,</span><br><span class=\"line\">        options.exclusive</span><br><span class=\"line\">      );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">\t<span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">listenInCluster</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  server,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  address,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  port,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  addressType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  backlog,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  fd,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  exclusive,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  flags</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  exclusive = !!exclusive;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (cluster === <span class=\"literal\">undefined</span>) cluster = <span class=\"built_in\">require</span>(<span class=\"string\">\"cluster\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (cluster.isMaster || exclusive) &#123;</span><br><span class=\"line\">    server._listen2(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> serverQuery = &#123;</span><br><span class=\"line\">    address: address,</span><br><span class=\"line\">    port: port, </span><br><span class=\"line\">    addressType: addressType,</span><br><span class=\"line\">    fd: fd,</span><br><span class=\"line\">    flags,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  cluster._getServer(server, serverQuery, listenOnMasterHandle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">listenOnMasterHandle</span>(<span class=\"params\">err, handle</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    server._handle = handle;</span><br><span class=\"line\">    server._listen2(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\">cluster._getServer = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">obj, options, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> address = options.address;</span><br><span class=\"line\">\t<span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"comment\">// servercluster.child</span></span><br><span class=\"line\">  <span class=\"comment\">// index</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> indexesKey = [</span><br><span class=\"line\">    address, </span><br><span class=\"line\">    options.port,</span><br><span class=\"line\">    options.addressType,</span><br><span class=\"line\">    options.fd,</span><br><span class=\"line\">  ].join(<span class=\"string\">\":\"</span>); </span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">let</span> index = indexes.get(indexesKey);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (index === <span class=\"literal\">undefined</span>) index = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> index++;</span><br><span class=\"line\"></span><br><span class=\"line\">  indexes.set(indexesKey, index);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> message = &#123;</span><br><span class=\"line\">    act: <span class=\"string\">\"queryServer\"</span>,</span><br><span class=\"line\">    index,</span><br><span class=\"line\">    data: <span class=\"literal\">null</span>,</span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  send(message, (reply, handle) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (handle) shared(reply, handle, indexesKey, cb);</span><br><span class=\"line\">    <span class=\"comment\">// Shared listen socket.</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span> rr(reply, indexesKey, cb); <span class=\"comment\">// Round-robin  handle null</span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">rr</span>(<span class=\"params\">message, indexesKey, cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (message.errno) <span class=\"keyword\">return</span> cb(message.errno, <span class=\"literal\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> key = message.key;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">listen</span>(<span class=\"params\">backlog</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">close</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (key === <span class=\"literal\">undefined</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    send(&#123; <span class=\"attr\">act</span>: <span class=\"string\">\"close\"</span>, key &#125;);</span><br><span class=\"line\">    handles.delete(key);</span><br><span class=\"line\">    indexes.delete(indexesKey);</span><br><span class=\"line\">    key = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getsockname</span>(<span class=\"params\">out</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (key) <span class=\"built_in\">Object</span>.assign(out, message.sockname);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> handle = &#123; close, listen, <span class=\"attr\">ref</span>: noop, <span class=\"attr\">unref</span>: noop &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (message.sockname) &#123;</span><br><span class=\"line\">    handle.getsockname = getsockname; <span class=\"comment\">// TCP handles only.</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  assert(handles.has(key) === <span class=\"literal\">false</span>);</span><br><span class=\"line\">  handles.set(key, handle);</span><br><span class=\"line\">  cb(<span class=\"number\">0</span>, handle); <span class=\"comment\">// handlelistenInClusterhandleserver._handle</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Round-robin connection.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onconnection</span>(<span class=\"params\">message, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> key = message.key; <span class=\"comment\">// maseterkey</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> server = handles.get(key); <span class=\"comment\">// clientserver</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> accepted = server !== <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  send(&#123; <span class=\"attr\">ack</span>: message.seq, accepted &#125;); <span class=\"comment\">//  master</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// cluster.child rrserveronconnection</span></span><br><span class=\"line\">  <span class=\"comment\">// cbnet.jsonconnection</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (accepted) server.onconnection(<span class=\"number\">0</span>, handle);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">queryServer</span>(<span class=\"params\">worker, message</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// workercluster.child worker</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> key =</span><br><span class=\"line\">    <span class=\"string\">`<span class=\"subst\">$&#123;message.address&#125;</span>:<span class=\"subst\">$&#123;message.port&#125;</span>:<span class=\"subst\">$&#123;message.addressType&#125;</span>:`</span> +</span><br><span class=\"line\">    <span class=\"string\">`<span class=\"subst\">$&#123;message.fd&#125;</span>:<span class=\"subst\">$&#123;message.index&#125;</span>`</span>;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> handle = handles.get(key);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (handle === <span class=\"literal\">undefined</span>) &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">// RoundRobinShared</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"keyword\">constructor</span> = RoundRobinHandle;</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">    handle = new <span class=\"keyword\">constructor</span>(</span><br><span class=\"line\">      key,</span><br><span class=\"line\">      address,</span><br><span class=\"line\">      message.port,</span><br><span class=\"line\">      message.addressType,</span><br><span class=\"line\">      message.fd,</span><br><span class=\"line\">      message.flags</span><br><span class=\"line\">    );</span><br><span class=\"line\">    handles.set(key, handle);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">  // cluster.childworkerhandle</span><br><span class=\"line\">  handle.add(worker, (errno, reply, handle) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; data &#125; = handles.get(key);</span><br><span class=\"line\">    send(</span><br><span class=\"line\">      worker,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        errno,</span><br><span class=\"line\">        key,</span><br><span class=\"line\">        ack: message.seq,</span><br><span class=\"line\">        data,</span><br><span class=\"line\">        ...reply,</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      handle <span class=\"comment\">// round_robin_handle null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/round_robin_handle.js</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">RoundRobinHandle</span>(<span class=\"params\">key, address, port, addressType, fd, flags</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.key = key;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.all = <span class=\"keyword\">new</span> <span class=\"built_in\">Map</span>();</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.free = [];</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.handles = [];</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.handle = <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.server = net.createServer(assert.fail);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fd &gt;= <span class=\"number\">0</span>) <span class=\"keyword\">this</span>.server.listen(&#123; fd &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (port &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.server.listen(&#123;</span><br><span class=\"line\">      port,</span><br><span class=\"line\">      host: address,</span><br><span class=\"line\">      <span class=\"comment\">// Currently, net module only supports `ipv6Only` option in `flags`.</span></span><br><span class=\"line\">      ipv6Only: <span class=\"built_in\">Boolean</span>(flags &amp; constants.UV_TCP_IPV6ONLY),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">this</span>.server.listen(address); <span class=\"comment\">// UNIX socket path.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.server.once(<span class=\"string\">\"listening\"</span>, () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.handle = <span class=\"keyword\">this</span>.server._handle;</span><br><span class=\"line\">    <span class=\"comment\">// onconnection</span></span><br><span class=\"line\">    <span class=\"comment\">// distribute </span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.handle.onconnection = <span class=\"function\">(<span class=\"params\">err, handle</span>) =&gt;</span> <span class=\"keyword\">this</span>.distribute(err, handle);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.server._handle = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.server = <span class=\"literal\">null</span>;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.add = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">worker, send</span>) </span>&#123;</span><br><span class=\"line\">  assert(<span class=\"keyword\">this</span>.all.has(worker.id) === <span class=\"literal\">false</span>);</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.all.set(worker.id, worker);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> done = <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.handle.getsockname) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// tcp\\udp getsockname</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> out = &#123;&#125;;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.handle.getsockname(out);</span><br><span class=\"line\">      <span class=\"comment\">// TODO(bnoordhuis) Check err.</span></span><br><span class=\"line\">      send(<span class=\"literal\">null</span>, &#123; <span class=\"attr\">sockname</span>: out &#125;, <span class=\"literal\">null</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      send(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>); <span class=\"comment\">// UNIX socket.</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.handoff(worker); <span class=\"comment\">// In case there are connections pending.</span></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.server === <span class=\"literal\">null</span>) <span class=\"keyword\">return</span> done();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Still busy binding.</span></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.server.once(<span class=\"string\">\"listening\"</span>, done);</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.server.once(<span class=\"string\">\"error\"</span>, (err) =&gt; &#123;</span><br><span class=\"line\">    send(err.errno, <span class=\"literal\">null</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.distribute = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, handle</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.handles.push(handle);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> worker = <span class=\"keyword\">this</span>.free.shift();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (worker) <span class=\"keyword\">this</span>.handoff(worker);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">RoundRobinHandle.prototype.handoff = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">worker</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// worker</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.all.has(worker.id) === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>; <span class=\"comment\">// Worker is closing (or has closed) the server.</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> handle = <span class=\"keyword\">this</span>.handles.shift(); <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (handle === <span class=\"literal\">undefined</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.free.push(worker);  <span class=\"comment\">// workerfree</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> message = &#123; <span class=\"attr\">act</span>: <span class=\"string\">\"newconn\"</span>, <span class=\"attr\">key</span>: <span class=\"keyword\">this</span>.key &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  sendHelper(worker.process, message, handle, (reply) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (reply.accepted) handle.close();</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">this</span>.distribute(<span class=\"number\">0</span>, handle); <span class=\"comment\">// Worker is shutting down. Send to another.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.handoff(worker);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>cluster</code>child_processfork<code>NODE_UNIQUE_ID</code>require(cluster)<code>master.js</code><code>child.js</code><code>RoundRobinHandle</code><code>cluster</code>TCP<code>net</code>masterchildchildchildmasterServer<code>RoundRobinHandle</code>serverTCP<code>free</code>workercluster.child</p>"},{"title":"2019 ","date":"2019-12-30T15:30:00.000Z","_content":"\n> It was the best of times, it was the worst of times.\n\n2019****2018Node.jsJava[Eureka](https://github.com/Netflix/eureka)[ZooKeeper](https://zookeeper.apache.org/)[Discon](https://disconf.readthedocs.io/zh_CN/latest/)[Cat](https://github.com/dianping/cat)[RocketMQ](https://rocketmq.apache.org/)[SeaweedFS](https://github.com/chrislusf/seaweedfs)[MySQL](https://www.mysql.com/cn/).NET C# + JavascriptWebNode.js[](http://aimianwu.com)`Egg.js`Node.jsEventLoopMemory Leak\n\n\n\n<!-- more -->\n\n\n\n<br/>\n\n### EventLoop\n\nNode.jsTCP `Close Wait`TCPClose WaitNode.jsJavascript\n\n**Node.js**\n\n`alinode`Docker```Cat`C++EventLoopNode.js\n![catMessageSenderFun](/images/summary-2019/1.png)\n\n****\n\n3\n\n1. Node.js****BFF\n2. Node.js\n3. Docker`Cat`CPU\n\n<br/>\n\n### Memory Leak\n\n2\n\n**** ...\n\n**Vue SSR** VueGithub[](https://github.com/vuejs/vue/issues/5089)\n\n![https://github.com/vuejs/vue/issues/5089](/images/summary-2019/2.jpg)\n\n**Node.jsHubTCPNode.js**\n\n<br/>\n\n### \n\n`Webpack`NBCI`Egg.js`\n\n**Egg.js**\n\nEgg.jsWebpackNode.jsNode.js\n\n<br/>\n\n<br/>\n\n## 20192020\n\n20192020BFF\n\n\n\n\n\n\n","source":"_posts/summary-2019.md","raw":"---\ntitle: 2019 \ncategory: work\ndate: 2019-12-30 23:30:00\n---\n\n> It was the best of times, it was the worst of times.\n\n2019****2018Node.jsJava[Eureka](https://github.com/Netflix/eureka)[ZooKeeper](https://zookeeper.apache.org/)[Discon](https://disconf.readthedocs.io/zh_CN/latest/)[Cat](https://github.com/dianping/cat)[RocketMQ](https://rocketmq.apache.org/)[SeaweedFS](https://github.com/chrislusf/seaweedfs)[MySQL](https://www.mysql.com/cn/).NET C# + JavascriptWebNode.js[](http://aimianwu.com)`Egg.js`Node.jsEventLoopMemory Leak\n\n\n\n<!-- more -->\n\n\n\n<br/>\n\n### EventLoop\n\nNode.jsTCP `Close Wait`TCPClose WaitNode.jsJavascript\n\n**Node.js**\n\n`alinode`Docker```Cat`C++EventLoopNode.js\n![catMessageSenderFun](/images/summary-2019/1.png)\n\n****\n\n3\n\n1. Node.js****BFF\n2. Node.js\n3. Docker`Cat`CPU\n\n<br/>\n\n### Memory Leak\n\n2\n\n**** ...\n\n**Vue SSR** VueGithub[](https://github.com/vuejs/vue/issues/5089)\n\n![https://github.com/vuejs/vue/issues/5089](/images/summary-2019/2.jpg)\n\n**Node.jsHubTCPNode.js**\n\n<br/>\n\n### \n\n`Webpack`NBCI`Egg.js`\n\n**Egg.js**\n\nEgg.jsWebpackNode.jsNode.js\n\n<br/>\n\n<br/>\n\n## 20192020\n\n20192020BFF\n\n\n\n\n\n\n","slug":"summary-2019","published":1,"updated":"2020-07-07T10:11:25.589Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6g000wd12is9oenoib","content":"<blockquote>\n<p>It was the best of times, it was the worst of times.</p>\n</blockquote>\n<p>2019<strong></strong>2018Node.jsJava<a href=\"https://github.com/Netflix/eureka\" target=\"_blank\" rel=\"noopener\">Eureka</a><a href=\"https://zookeeper.apache.org/\" target=\"_blank\" rel=\"noopener\">ZooKeeper</a><a href=\"https://disconf.readthedocs.io/zh_CN/latest/\" target=\"_blank\" rel=\"noopener\">Discon</a><a href=\"https://github.com/dianping/cat\" target=\"_blank\" rel=\"noopener\">Cat</a><a href=\"https://rocketmq.apache.org/\" target=\"_blank\" rel=\"noopener\">RocketMQ</a><a href=\"https://github.com/chrislusf/seaweedfs\" target=\"_blank\" rel=\"noopener\">SeaweedFS</a><a href=\"https://www.mysql.com/cn/\" target=\"_blank\" rel=\"noopener\">MySQL</a>.NET C# + JavascriptWebNode.js<a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\"></a><code>Egg.js</code>Node.jsEventLoopMemory Leak</p>\n<a id=\"more\"></a>\n<p><br></p>\n<h3 id=\"EventLoop\"><a href=\"#EventLoop\" class=\"headerlink\" title=\"EventLoop\"></a>EventLoop</h3><p>Node.jsTCP <code>Close Wait</code>TCPClose WaitNode.jsJavascript</p>\n<p><strong>Node.js</strong></p>\n<p><code>alinode</code>Docker<code></code><code>Cat</code>C++EventLoopNode.js<br><img src=\"/images/summary-2019/1.png\" alt=\"catMessageSenderFun\"></p>\n<p><strong></strong></p>\n<p>3</p>\n<ol>\n<li>Node.js<strong></strong>BFF</li>\n<li>Node.js</li>\n<li>Docker<code>Cat</code>CPU</li>\n</ol>\n<p><br></p>\n<h3 id=\"Memory-Leak\"><a href=\"#Memory-Leak\" class=\"headerlink\" title=\"Memory Leak\"></a>Memory Leak</h3><p>2</p>\n<p><strong></strong> </p>\n<p><strong>Vue SSR</strong> VueGithub<a href=\"https://github.com/vuejs/vue/issues/5089\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p><img src=\"/images/summary-2019/2.jpg\" alt=\"https://github.com/vuejs/vue/issues/5089\"></p>\n<p><strong>Node.jsHubTCPNode.js</strong></p>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>Webpack</code>NBCI<code>Egg.js</code></p>\n<p><strong>Egg.js</strong></p>\n<p>Egg.jsWebpackNode.jsNode.js</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"20192020\"><a href=\"#20192020\" class=\"headerlink\" title=\"20192020\"></a>20192020</h2><p>20192020BFF</p>\n","site":{"data":{}},"_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"<blockquote>\n<p>It was the best of times, it was the worst of times.</p>\n</blockquote>\n<p>2019<strong></strong>2018Node.jsJava<a href=\"https://github.com/Netflix/eureka\" target=\"_blank\" rel=\"noopener\">Eureka</a><a href=\"https://zookeeper.apache.org/\" target=\"_blank\" rel=\"noopener\">ZooKeeper</a><a href=\"https://disconf.readthedocs.io/zh_CN/latest/\" target=\"_blank\" rel=\"noopener\">Discon</a><a href=\"https://github.com/dianping/cat\" target=\"_blank\" rel=\"noopener\">Cat</a><a href=\"https://rocketmq.apache.org/\" target=\"_blank\" rel=\"noopener\">RocketMQ</a><a href=\"https://github.com/chrislusf/seaweedfs\" target=\"_blank\" rel=\"noopener\">SeaweedFS</a><a href=\"https://www.mysql.com/cn/\" target=\"_blank\" rel=\"noopener\">MySQL</a>.NET C# + JavascriptWebNode.js<a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\"></a><code>Egg.js</code>Node.jsEventLoopMemory Leak</p>","more":"<p><br></p>\n<h3 id=\"EventLoop\"><a href=\"#EventLoop\" class=\"headerlink\" title=\"EventLoop\"></a>EventLoop</h3><p>Node.jsTCP <code>Close Wait</code>TCPClose WaitNode.jsJavascript</p>\n<p><strong>Node.js</strong></p>\n<p><code>alinode</code>Docker<code></code><code>Cat</code>C++EventLoopNode.js<br><img src=\"/images/summary-2019/1.png\" alt=\"catMessageSenderFun\"></p>\n<p><strong></strong></p>\n<p>3</p>\n<ol>\n<li>Node.js<strong></strong>BFF</li>\n<li>Node.js</li>\n<li>Docker<code>Cat</code>CPU</li>\n</ol>\n<p><br></p>\n<h3 id=\"Memory-Leak\"><a href=\"#Memory-Leak\" class=\"headerlink\" title=\"Memory Leak\"></a>Memory Leak</h3><p>2</p>\n<p><strong></strong> </p>\n<p><strong>Vue SSR</strong> VueGithub<a href=\"https://github.com/vuejs/vue/issues/5089\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p><img src=\"/images/summary-2019/2.jpg\" alt=\"https://github.com/vuejs/vue/issues/5089\"></p>\n<p><strong>Node.jsHubTCPNode.js</strong></p>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>Webpack</code>NBCI<code>Egg.js</code></p>\n<p><strong>Egg.js</strong></p>\n<p>Egg.jsWebpackNode.jsNode.js</p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"20192020\"><a href=\"#20192020\" class=\"headerlink\" title=\"20192020\"></a>20192020</h2><p>20192020BFF</p>"},{"title":"HR","date":"2018-07-20T09:01:34.000Z","_content":"****\n\nHR\n\n1.HR\n\n2.HR\n\n3.HR\n\nHRHRHR\n<!-- more -->\n****\n\n- offerHRHR\n- HR\n- HR\n- offerofferHR\n\n****\n\n\n\n\n\n\n\n****\n\n","source":"_posts/the-quality-of-a-company-first-look-at-HR-department.md","raw":"---\ntitle: HR\ncategory: work\ndate: 2018-07-20 17:01:34\n---\n****\n\nHR\n\n1.HR\n\n2.HR\n\n3.HR\n\nHRHRHR\n<!-- more -->\n****\n\n- offerHRHR\n- HR\n- HR\n- offerofferHR\n\n****\n\n\n\n\n\n\n\n****\n\n","slug":"the-quality-of-a-company-first-look-at-HR-department","published":1,"updated":"2020-07-07T10:11:25.589Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6k0011d12i9h6fzx8d","content":"<p><strong></strong></p>\n<p>HR</p>\n<p>1.HR</p>\n<p>2.HR</p>\n<p>3.HR</p>\n<p>HRHRHR<br><a id=\"more\"></a><br><strong></strong></p>\n<ul>\n<li>offerHRHR</li>\n<li>HR</li>\n<li>HR</li>\n<li>offerofferHR</li>\n</ul>\n<p><strong></strong></p>\n<p></p>\n<p></p>\n<p><strong></strong></p>\n<p></p>\n","site":{"data":{}},"_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"<p><strong></strong></p>\n<p>HR</p>\n<p>1.HR</p>\n<p>2.HR</p>\n<p>3.HR</p>\n<p>HRHRHR<br></p>","more":"<br><strong></strong></p>\n<ul>\n<li>offerHRHR</li>\n<li>HR</li>\n<li>HR</li>\n<li>offerofferHR</li>\n</ul>\n<p><strong></strong></p>\n<p></p>\n<p></p>\n<p><strong></strong></p>\n<p></p>"},{"title":"2019","date":"2019-10-05T22:11:21.849Z","_content":"\n\n\n<!-- more -->\n\n<br/>\n\n### **#**\n\n`Airbnb`111132600100:(``\n\n![](/images/travel-zhoushan/travel-zhoushan-01.png)\n\n``\n\n![](/images/travel-zhoushan/travel-zhoushan-03.png)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg)\n\n<br/>\n\n### **#**\n\n2``13``\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg )\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg)\n\n<video width=\"100%\" muted controls>\n  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\">\n  Your browser does not support the video tag.\n</video>\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg)\n\n``730``\n\n<br/>\n\n### **#**\n\n__\n\n200\n\n![](/images/travel-zhoushan/travel-zhoushan-16.png)\n\n![6](/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg)\n\n![&1](/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg)\n\n![&2](/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg)\n\n![& ](/images/travel-zhoushan/travel-zhoushan-23.png)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg)\n\n![3](/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg)\n\n![ ](/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg)\n\n````\n\n> 114.9692000\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg)\n\n\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg)\n\nU``\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg)\n\n![3](/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg)\n\n![4](/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg)\n\n![](/images/travel-zhoushan/travel-zhoushan-32.png)\n\n\n\n### **#**\n\n3\n\n","source":"_posts/travel-zhoushan.md","raw":"---\ntitle: 2019\ncategory: travel\ndate: 2019-10-06T06:11:21.849Z\n---\n\n\n\n<!-- more -->\n\n<br/>\n\n### **#**\n\n`Airbnb`111132600100:(``\n\n![](/images/travel-zhoushan/travel-zhoushan-01.png)\n\n``\n\n![](/images/travel-zhoushan/travel-zhoushan-03.png)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg)\n\n<br/>\n\n### **#**\n\n2``13``\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg )\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg)\n\n<video width=\"100%\" muted controls>\n  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\">\n  Your browser does not support the video tag.\n</video>\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg)\n\n``730``\n\n<br/>\n\n### **#**\n\n__\n\n200\n\n![](/images/travel-zhoushan/travel-zhoushan-16.png)\n\n![6](/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg)\n\n![&1](/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg)\n\n![&2](/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg)\n\n![& ](/images/travel-zhoushan/travel-zhoushan-23.png)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg)\n\n![3](/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg)\n\n![ ](/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg)\n\n````\n\n> 114.9692000\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg)\n\n\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg)\n\nU``\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg)\n\n![3](/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg)\n\n![4](/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg)\n\n![](/images/travel-zhoushan/travel-zhoushan-32.png)\n\n\n\n### **#**\n\n3\n\n","slug":"travel-zhoushan","published":1,"updated":"2020-07-07T10:11:25.589Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6n0014d12ija0axog3","content":"<p></p>\n<a id=\"more\"></a>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p><code>Airbnb</code>111132600100:(<code></code></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-01.png\" alt=\"\"></p>\n<p><code></code></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-03.png\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg\" alt=\"\"></p>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>2<code></code>13<code></code></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg\" alt=\"1\"></p>\n<video width=\"100%\" muted controls><br>  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\"><br>  Your browser does not support the video tag.<br></video>\n\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg\" alt=\"\"></p>\n<p><code></code>730<code></code></p>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p><em></em></p>\n<p>200</p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-16.png\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg\" alt=\"6\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg\" alt=\"&amp;1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg\" alt=\"&amp;2\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-23.png\" alt=\"&amp; \"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg\" alt=\"3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg\" alt=\" \"></p>\n<p><code></code><code></code></p>\n<blockquote>\n<p>114.9692000</p>\n</blockquote>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg\" alt=\"\"></p>\n<p></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg\" alt=\"2\"></p>\n<p>U<code></code></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg\" alt=\"3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg\" alt=\"4\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-32.png\" alt=\"\"></p>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>3</p>\n","site":{"data":{}},"_categories":[{"name":"travel","path":"categories/travel/"}],"_tags":[],"excerpt":"<p></p>","more":"<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p><code>Airbnb</code>111132600100:(<code></code></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-01.png\" alt=\"\"></p>\n<p><code></code></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-03.png\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg\" alt=\"\"></p>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>2<code></code>13<code></code></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg\" alt=\"1\"></p>\n<video width=\"100%\" muted controls><br>  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\"><br>  Your browser does not support the video tag.<br></video>\n\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg\" alt=\"\"></p>\n<p><code></code>730<code></code></p>\n<p><br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p><em></em></p>\n<p>200</p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-16.png\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg\" alt=\"6\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg\" alt=\"&amp;1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg\" alt=\"&amp;2\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-23.png\" alt=\"&amp; \"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg\" alt=\"3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg\" alt=\" \"></p>\n<p><code></code><code></code></p>\n<blockquote>\n<p>114.9692000</p>\n</blockquote>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg\" alt=\"\"></p>\n<p></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg\" alt=\"2\"></p>\n<p>U<code></code></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg\" alt=\"3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg\" alt=\"4\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-32.png\" alt=\"\"></p>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>3</p>"},{"title":"","date":"2018-09-24T06:45:00.000Z","_content":"\n\n![](/images/traveling-to-the-philippines/1.jpg)\n\n<!-- more -->\n\nLoading\n\n![](/images/traveling-to-the-philippines/2.jpg)\n\n### \n\n9BGC5MIN3\n\nBGCHSBC,Google\n\n\n\n![](/images/traveling-to-the-philippines/3.jpg)\n\n![](/images/traveling-to-the-philippines/4.jpg)\n\n![A](/images/traveling-to-the-philippines/7.jpg)\n\n![B](/images/traveling-to-the-philippines/8.jpg)\n\n![](/images/traveling-to-the-philippines/6.jpg)\n\n![](/images/traveling-to-the-philippines/9.jpg)\n\n### \n\nBGC1500Php\n\n![](/images/traveling-to-the-philippines/10.jpg)\n\n![A](/images/traveling-to-the-philippines/11.jpg)\n\n![B](/images/traveling-to-the-philippines/12.jpg)\n\n![C](/images/traveling-to-the-philippines/27.jpg)\n\n![](/images/traveling-to-the-philippines/13.jpg)\n\n![ %](/images/traveling-to-the-philippines/14.jpg)\n\n![](/images/traveling-to-the-philippines/15.jpg)\n\n![712Php 100](/images/traveling-to-the-philippines/16.jpg)\n\n![300Php](/images/traveling-to-the-philippines/17.jpg)\n\n2\n\n![](/images/traveling-to-the-philippines/19.jpg)\n\n![](/images/traveling-to-the-philippines/21.jpg)\n\n![](/images/traveling-to-the-philippines/20.jpg)\n\n![7000+ 5500  T_T](/images/traveling-to-the-philippines/22.jpg)\n\n![A ](/images/traveling-to-the-philippines/23.jpg)\n\n![B ](/images/traveling-to-the-philippines/24.jpg)\n\n![C ](/images/traveling-to-the-philippines/25.jpg)\n\n![ 23](/images/traveling-to-the-philippines/26.jpg)\n\n### \n\nGrab\n\n![A](/images/traveling-to-the-philippines/28.jpg)\n\n**\n\n![A](/images/traveling-to-the-philippines/29.jpg)\n\n\n![B](/images/traveling-to-the-philippines/30.jpg)\n\n### \n\nBGCAB\n\n\n\n![](/images/traveling-to-the-philippines/31.jpg)\n\n![](/images/traveling-to-the-philippines/34.jpg)\n\n![](/images/traveling-to-the-philippines/33.jpeg)\n\n![ATM](/images/traveling-to-the-philippines/32.jpg)\n\n\n## \n\n72:)\n\n","source":"_posts/traveling-to-the-philippines.md","raw":"---\ntitle: \ncategory: work\ndate: 2018-09-24 14:45:00\n---\n\n\n![](/images/traveling-to-the-philippines/1.jpg)\n\n<!-- more -->\n\nLoading\n\n![](/images/traveling-to-the-philippines/2.jpg)\n\n### \n\n9BGC5MIN3\n\nBGCHSBC,Google\n\n\n\n![](/images/traveling-to-the-philippines/3.jpg)\n\n![](/images/traveling-to-the-philippines/4.jpg)\n\n![A](/images/traveling-to-the-philippines/7.jpg)\n\n![B](/images/traveling-to-the-philippines/8.jpg)\n\n![](/images/traveling-to-the-philippines/6.jpg)\n\n![](/images/traveling-to-the-philippines/9.jpg)\n\n### \n\nBGC1500Php\n\n![](/images/traveling-to-the-philippines/10.jpg)\n\n![A](/images/traveling-to-the-philippines/11.jpg)\n\n![B](/images/traveling-to-the-philippines/12.jpg)\n\n![C](/images/traveling-to-the-philippines/27.jpg)\n\n![](/images/traveling-to-the-philippines/13.jpg)\n\n![ %](/images/traveling-to-the-philippines/14.jpg)\n\n![](/images/traveling-to-the-philippines/15.jpg)\n\n![712Php 100](/images/traveling-to-the-philippines/16.jpg)\n\n![300Php](/images/traveling-to-the-philippines/17.jpg)\n\n2\n\n![](/images/traveling-to-the-philippines/19.jpg)\n\n![](/images/traveling-to-the-philippines/21.jpg)\n\n![](/images/traveling-to-the-philippines/20.jpg)\n\n![7000+ 5500  T_T](/images/traveling-to-the-philippines/22.jpg)\n\n![A ](/images/traveling-to-the-philippines/23.jpg)\n\n![B ](/images/traveling-to-the-philippines/24.jpg)\n\n![C ](/images/traveling-to-the-philippines/25.jpg)\n\n![ 23](/images/traveling-to-the-philippines/26.jpg)\n\n### \n\nGrab\n\n![A](/images/traveling-to-the-philippines/28.jpg)\n\n**\n\n![A](/images/traveling-to-the-philippines/29.jpg)\n\n\n![B](/images/traveling-to-the-philippines/30.jpg)\n\n### \n\nBGCAB\n\n\n\n![](/images/traveling-to-the-philippines/31.jpg)\n\n![](/images/traveling-to-the-philippines/34.jpg)\n\n![](/images/traveling-to-the-philippines/33.jpeg)\n\n![ATM](/images/traveling-to-the-philippines/32.jpg)\n\n\n## \n\n72:)\n\n","slug":"traveling-to-the-philippines","published":1,"updated":"2020-07-07T10:11:25.590Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6p0018d12ibydk0jqe","content":"<p></p>\n<p><img src=\"/images/traveling-to-the-philippines/1.jpg\" alt=\"\"></p>\n<a id=\"more\"></a>\n<p>Loading</p>\n<p><img src=\"/images/traveling-to-the-philippines/2.jpg\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>9BGC5MIN3</p>\n<p>BGCHSBC,Google</p>\n<p></p>\n<p><img src=\"/images/traveling-to-the-philippines/3.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/4.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/7.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/8.jpg\" alt=\"B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/6.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/9.jpg\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BGC1500Php</p>\n<p><img src=\"/images/traveling-to-the-philippines/10.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/11.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/12.jpg\" alt=\"B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/27.jpg\" alt=\"C\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/13.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/14.jpg\" alt=\" %\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/15.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/16.jpg\" alt=\"712Php 100\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/17.jpg\" alt=\"300Php\"></p>\n<p>2</p>\n<p><img src=\"/images/traveling-to-the-philippines/19.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/21.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/20.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/22.jpg\" alt=\"7000+ 5500  T_T\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/23.jpg\" alt=\"A \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/24.jpg\" alt=\"B \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/25.jpg\" alt=\"C \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/26.jpg\" alt=\" 23\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Grab</p>\n<p><img src=\"/images/traveling-to-the-philippines/28.jpg\" alt=\"A\"></p>\n<p><em></em></p>\n<p><img src=\"/images/traveling-to-the-philippines/29.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/30.jpg\" alt=\"B\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BGCAB</p>\n<p></p>\n<p><img src=\"/images/traveling-to-the-philippines/31.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/34.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/33.jpeg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/32.jpg\" alt=\"ATM\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>72:)</p>\n","site":{"data":{}},"_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"<p></p>\n<p><img src=\"/images/traveling-to-the-philippines/1.jpg\" alt=\"\"></p>","more":"<p>Loading</p>\n<p><img src=\"/images/traveling-to-the-philippines/2.jpg\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>9BGC5MIN3</p>\n<p>BGCHSBC,Google</p>\n<p></p>\n<p><img src=\"/images/traveling-to-the-philippines/3.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/4.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/7.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/8.jpg\" alt=\"B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/6.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/9.jpg\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BGC1500Php</p>\n<p><img src=\"/images/traveling-to-the-philippines/10.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/11.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/12.jpg\" alt=\"B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/27.jpg\" alt=\"C\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/13.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/14.jpg\" alt=\" %\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/15.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/16.jpg\" alt=\"712Php 100\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/17.jpg\" alt=\"300Php\"></p>\n<p>2</p>\n<p><img src=\"/images/traveling-to-the-philippines/19.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/21.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/20.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/22.jpg\" alt=\"7000+ 5500  T_T\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/23.jpg\" alt=\"A \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/24.jpg\" alt=\"B \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/25.jpg\" alt=\"C \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/26.jpg\" alt=\" 23\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Grab</p>\n<p><img src=\"/images/traveling-to-the-philippines/28.jpg\" alt=\"A\"></p>\n<p><em></em></p>\n<p><img src=\"/images/traveling-to-the-philippines/29.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/30.jpg\" alt=\"B\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BGCAB</p>\n<p></p>\n<p><img src=\"/images/traveling-to-the-philippines/31.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/34.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/33.jpeg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/32.jpg\" alt=\"ATM\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>72:)</p>"},{"title":"Egg Cluster ","keywords":",Eggjs,Egg Cluster","description":"Egg.js","date":"2019-01-18T05:48:01.464Z","_content":"\nEgg.js[](https://eggjs.org)____\n\n> 1. Egg [](https://eggjs.org/zh-cn/advanced/framework.html) \n> 2.[](https://eggjs.org/zh-cn/basics/plugin.html)\n> 3.[](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n> 4. [Koa](http://koajs.com/) \n> 5.\n> 6.[](https://eggjs.org/zh-cn/tutorials/progressive.html)\n\n1Koa2KoaExpress4Koa56\n\n3____nodejs\n\n<!-- more -->\n\n\n\n### __#__\n\n- __egg-core__: __EggCore__KoaApplication4 *Koa*\n- __egg__: EggCore__EggApplication__ApplicationAgentEggApplication\n- __egg-cluster__: ____\n\n*egg-clusterEgg.js*\n\n### egg-cluster\n\n```js\n// egg-cluster index.js  startCluster\nexports.startCluster = function (options, callback) {\n    new Master(options).ready(callback)\n}\n```\n\negg-clusterMastereggangentworkersapplication,\n![Master-Agent-Works ](/images/egg-cluster/1.jpg)\n\n### Agent-Works\n```js\nclass Master extends EventEmitter {\n    constructor(options) {\n        this.workerManager = new Manager();\n    \tthis.messenger = new Messenger(this);\n        // ...\n\t\tthis.once('agent-start', this.forkAppWorkers.bind(this));\n        // ...\n        detectPort((err, port) => {\n            // port\n            this.options.clusterPort = port;\n            //  agent\n            this.forkAgentWorker();\n        });\n        // ...\n    }\n    forkAgentWorker() {\n        // ... childprocess.fork egg-cluster/lib/agent_worker.js\n        const agentWorker = childprocess.fork(this.getAgentWorkerFile(), args, opt);\n        // ...\n    }\n    forkAppWorkers() {\n        //  worker \n        // cluster.fork egg-cluster/lib/agent_worker.js \n        //  httphttps\n    }\n}\n```\n\nagent_worker.jseggAgent\"agent-start\"MasterWorkers\n\n```js\n// egg-cluster/lib/agent_worker.js\n// ...\nprocess.send({ action: 'agent-start', to: 'master' }); \n// ...\n```\n\n### Agent-Works? ([IPC](https://eggjs.org/zh-cn/core/cluster-and-ipc.html))\n\n- MasterMessengeregg-cluster/lib/utils/messenger.js\n- EggApplicationMessengeregg/lib/core/messenger.js\n\nAgentWorker(Application)EggApplicationMessengersendMasterMastersendAgentWorkerMaster\n\n```js\n// egg-cluster master.js\nclass Master extends EventEmitter {\n    forkAppWorkers() {\n        // ...\n        cluster.on('fork', worker => {\n            // ...\n            worker.on('message', msg => {\n            \tif (typeof msg === 'string') msg = { action: msg, data: msg };\n\t            msg.from = 'app';\n    \t        this.messenger.send(msg);\n            });\n            // ...\n        })\n    }\n    forkAgentWorker() {\n        // ...\n        agentWorker.on('message', msg => {\n          if (typeof msg === 'string') msg = { action: msg, data: msg };\n          msg.from = 'agent';\n          this.messenger.send(msg);\n        });\n        // ...\n    }\n}\n```\n\n```js\n// egg messenger.js\nclass Messenger extends EventEmitter {\n    send(action, data, to) {\n        sendmessage(process, {\n          action,\n          data,\n          to,\n        });\n        return this;\n     }\n}\n```\n\n__from__...__to__...\n\n![Master-Agent-Works ](/images/egg-cluster/2.jpg)\n\n### [](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n\n![nworkerm](/images/egg-cluster/3.jpg)\n\n- n * m \n- Master\n- eggIPCMaster\n\nsocket[cluster-client](https://github.com/node-modules/cluster-client)\n\n- AgentLeader\n- WorkerFollowerAgent\n\nLeaderAgentdisconfeuerkaFollowerWorker\n\n![socket](/images/egg-cluster/4.jpg)\n\n### cluster-client \n\n```js\nclass ClusterClient extends Base {\n    // ...\n    async [init]() {\n        const name = this.options.name;\n        const port = this.options.port;\n        let server;\n        if (this.options.isLeader === true) {\n          server = await ClusterServer.create(name, port);\n          if (!server) {\n            throw new Error(`create \"${name}\" leader failed, the port:${port} is occupied by other`);\n          }\n        } else if (this.options.isLeader === false) {\n          // wait for leader active\n          await ClusterServer.waitFor(port, this.options.maxWaitTime);\n        } else {\n          debug('[ClusterClient:%s] init cluster client, try to seize the leader on port:%d', name, port);\n          server = await ClusterServer.create(name, port);\n        }\n\n        if (server) {\n          this[innerClient] = new Leader(Object.assign({ server }, this.options));\n          debug('[ClusterClient:%s] has seized port %d, and serves as leader client.', name, port);\n        } else {\n          this[innerClient] = new Follower(this.options);\n          debug('[ClusterClient:%s] gives up seizing port %d, and serves as follower client.', name, port);\n        }\n        // ...\n    }\n}\n```\n\n- portdetectPortclusterPort\n- net.create TCPLeaderFollowersocket\n- LeaderpublishFollower\n\ncluster-client\n\n\n\n### __#__\n\nEgg.js","source":"_posts/egg-cluster.md","raw":"---\ntitle: Egg Cluster \ncategory: JavaScript\nkeywords: ,Eggjs,Egg Cluster\ndescription: Egg.js\ntags:\n  - Node.js\n  - JavaScript\ndate: 2019-01-18T13:48:01.464Z\n---\n\nEgg.js[](https://eggjs.org)____\n\n> 1. Egg [](https://eggjs.org/zh-cn/advanced/framework.html) \n> 2.[](https://eggjs.org/zh-cn/basics/plugin.html)\n> 3.[](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n> 4. [Koa](http://koajs.com/) \n> 5.\n> 6.[](https://eggjs.org/zh-cn/tutorials/progressive.html)\n\n1Koa2KoaExpress4Koa56\n\n3____nodejs\n\n<!-- more -->\n\n\n\n### __#__\n\n- __egg-core__: __EggCore__KoaApplication4 *Koa*\n- __egg__: EggCore__EggApplication__ApplicationAgentEggApplication\n- __egg-cluster__: ____\n\n*egg-clusterEgg.js*\n\n### egg-cluster\n\n```js\n// egg-cluster index.js  startCluster\nexports.startCluster = function (options, callback) {\n    new Master(options).ready(callback)\n}\n```\n\negg-clusterMastereggangentworkersapplication,\n![Master-Agent-Works ](/images/egg-cluster/1.jpg)\n\n### Agent-Works\n```js\nclass Master extends EventEmitter {\n    constructor(options) {\n        this.workerManager = new Manager();\n    \tthis.messenger = new Messenger(this);\n        // ...\n\t\tthis.once('agent-start', this.forkAppWorkers.bind(this));\n        // ...\n        detectPort((err, port) => {\n            // port\n            this.options.clusterPort = port;\n            //  agent\n            this.forkAgentWorker();\n        });\n        // ...\n    }\n    forkAgentWorker() {\n        // ... childprocess.fork egg-cluster/lib/agent_worker.js\n        const agentWorker = childprocess.fork(this.getAgentWorkerFile(), args, opt);\n        // ...\n    }\n    forkAppWorkers() {\n        //  worker \n        // cluster.fork egg-cluster/lib/agent_worker.js \n        //  httphttps\n    }\n}\n```\n\nagent_worker.jseggAgent\"agent-start\"MasterWorkers\n\n```js\n// egg-cluster/lib/agent_worker.js\n// ...\nprocess.send({ action: 'agent-start', to: 'master' }); \n// ...\n```\n\n### Agent-Works? ([IPC](https://eggjs.org/zh-cn/core/cluster-and-ipc.html))\n\n- MasterMessengeregg-cluster/lib/utils/messenger.js\n- EggApplicationMessengeregg/lib/core/messenger.js\n\nAgentWorker(Application)EggApplicationMessengersendMasterMastersendAgentWorkerMaster\n\n```js\n// egg-cluster master.js\nclass Master extends EventEmitter {\n    forkAppWorkers() {\n        // ...\n        cluster.on('fork', worker => {\n            // ...\n            worker.on('message', msg => {\n            \tif (typeof msg === 'string') msg = { action: msg, data: msg };\n\t            msg.from = 'app';\n    \t        this.messenger.send(msg);\n            });\n            // ...\n        })\n    }\n    forkAgentWorker() {\n        // ...\n        agentWorker.on('message', msg => {\n          if (typeof msg === 'string') msg = { action: msg, data: msg };\n          msg.from = 'agent';\n          this.messenger.send(msg);\n        });\n        // ...\n    }\n}\n```\n\n```js\n// egg messenger.js\nclass Messenger extends EventEmitter {\n    send(action, data, to) {\n        sendmessage(process, {\n          action,\n          data,\n          to,\n        });\n        return this;\n     }\n}\n```\n\n__from__...__to__...\n\n![Master-Agent-Works ](/images/egg-cluster/2.jpg)\n\n### [](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n\n![nworkerm](/images/egg-cluster/3.jpg)\n\n- n * m \n- Master\n- eggIPCMaster\n\nsocket[cluster-client](https://github.com/node-modules/cluster-client)\n\n- AgentLeader\n- WorkerFollowerAgent\n\nLeaderAgentdisconfeuerkaFollowerWorker\n\n![socket](/images/egg-cluster/4.jpg)\n\n### cluster-client \n\n```js\nclass ClusterClient extends Base {\n    // ...\n    async [init]() {\n        const name = this.options.name;\n        const port = this.options.port;\n        let server;\n        if (this.options.isLeader === true) {\n          server = await ClusterServer.create(name, port);\n          if (!server) {\n            throw new Error(`create \"${name}\" leader failed, the port:${port} is occupied by other`);\n          }\n        } else if (this.options.isLeader === false) {\n          // wait for leader active\n          await ClusterServer.waitFor(port, this.options.maxWaitTime);\n        } else {\n          debug('[ClusterClient:%s] init cluster client, try to seize the leader on port:%d', name, port);\n          server = await ClusterServer.create(name, port);\n        }\n\n        if (server) {\n          this[innerClient] = new Leader(Object.assign({ server }, this.options));\n          debug('[ClusterClient:%s] has seized port %d, and serves as leader client.', name, port);\n        } else {\n          this[innerClient] = new Follower(this.options);\n          debug('[ClusterClient:%s] gives up seizing port %d, and serves as follower client.', name, port);\n        }\n        // ...\n    }\n}\n```\n\n- portdetectPortclusterPort\n- net.create TCPLeaderFollowersocket\n- LeaderpublishFollower\n\ncluster-client\n\n\n\n### __#__\n\nEgg.js","slug":"egg-cluster","published":1,"updated":"2020-07-07T10:11:25.586Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6s001cd12ifj6rubht","content":"<p>Egg.js<a href=\"https://eggjs.org\" target=\"_blank\" rel=\"noopener\"></a><strong></strong></p>\n<blockquote>\n<p>1. Egg <a href=\"https://eggjs.org/zh-cn/advanced/framework.html\" target=\"_blank\" rel=\"noopener\"></a> <br>2.<a href=\"https://eggjs.org/zh-cn/basics/plugin.html\" target=\"_blank\" rel=\"noopener\"></a><br>3.<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\"></a><br>4. <a href=\"http://koajs.com/\" target=\"_blank\" rel=\"noopener\">Koa</a> <br>5.<br>6.<a href=\"https://eggjs.org/zh-cn/tutorials/progressive.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n</blockquote>\n<p>1Koa2KoaExpress4Koa56</p>\n<p>3<strong></strong>nodejs</p>\n<a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><ul>\n<li><strong>egg-core</strong>: <strong>EggCore</strong>KoaApplication4 <em>Koa</em></li>\n<li><strong>egg</strong>: EggCore<strong>EggApplication</strong>ApplicationAgentEggApplication</li>\n<li><strong>egg-cluster</strong>: <strong></strong></li>\n</ul>\n<p><em>egg-clusterEgg.js</em></p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a>egg-cluster</h3><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster index.js  startCluster</span></span><br><span class=\"line\">exports.startCluster = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>egg-clusterMastereggangentworkersapplication,<br><img src=\"/images/egg-cluster/1.jpg\" alt=\"Master-Agent-Works \"></p>\n<h3 id=\"Agent-Works\"><a href=\"#Agent-Works\" class=\"headerlink\" title=\"Agent-Works\"></a>Agent-Works</h3><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.workerManager = <span class=\"hljs-keyword\">new</span> Manager();</span><br><span class=\"line\">    \t<span class=\"hljs-keyword\">this</span>.messenger = <span class=\"hljs-keyword\">new</span> Messenger(<span class=\"hljs-keyword\">this</span>);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">this</span>.once(<span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-keyword\">this</span>.forkAppWorkers.bind(<span class=\"hljs-keyword\">this</span>));</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        detectPort(<span class=\"hljs-function\">(<span class=\"hljs-params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"hljs-comment\">// port</span></span><br><span class=\"line\">            <span class=\"hljs-keyword\">this</span>.options.clusterPort = port;</span><br><span class=\"line\">            <span class=\"hljs-comment\">//  agent</span></span><br><span class=\"line\">            <span class=\"hljs-keyword\">this</span>.forkAgentWorker();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ... childprocess.fork egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> agentWorker = childprocess.fork(<span class=\"hljs-keyword\">this</span>.getAgentWorkerFile(), args, opt);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">//  worker </span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// cluster.fork egg-cluster/lib/agent_worker.js </span></span><br><span class=\"line\">        <span class=\"hljs-comment\">//  httphttps</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>agent_worker.jseggAgentagent-startMasterWorkers</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">process.send(&#123; <span class=\"hljs-attr\">action</span>: <span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'master'</span> &#125;); </span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"Agent-Works-IPC\"><a href=\"#Agent-Works-IPC\" class=\"headerlink\" title=\"Agent-Works? (IPC)\"></a>Agent-Works? (<a href=\"https://eggjs.org/zh-cn/core/cluster-and-ipc.html\" target=\"_blank\" rel=\"noopener\">IPC</a>)</h3><ul>\n<li>MasterMessengeregg-cluster/lib/utils/messenger.js</li>\n<li>EggApplicationMessengeregg/lib/core/messenger.js</li>\n</ul>\n<p>AgentWorker(Application)EggApplicationMessengersendMasterMastersendAgentWorkerMaster</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster master.js</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        cluster.on(<span class=\"hljs-string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">            <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">            worker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">            \t<span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">\t            msg.from = <span class=\"hljs-string\">'app'</span>;</span><br><span class=\"line\">    \t        <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        agentWorker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">          msg.from = <span class=\"hljs-string\">'agent'</span>;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg messenger.js</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Messenger</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    send(action, data, to) &#123;</span><br><span class=\"line\">        sendmessage(process, &#123;</span><br><span class=\"line\">          action,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          to,</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>from</strong><strong>to</strong></p>\n<p><img src=\"/images/egg-cluster/2.jpg\" alt=\"Master-Agent-Works \"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\"></a></h3><p><img src=\"/images/egg-cluster/3.jpg\" alt=\"nworkerm\"></p>\n<ul>\n<li>n * m </li>\n<li>Master</li>\n<li>eggIPCMaster</li>\n</ul>\n<p>socket<a href=\"https://github.com/node-modules/cluster-client\" target=\"_blank\" rel=\"noopener\">cluster-client</a></p>\n<ul>\n<li>AgentLeader</li>\n<li>WorkerFollowerAgent</li>\n</ul>\n<p>LeaderAgentdisconfeuerkaFollowerWorker</p>\n<p><img src=\"/images/egg-cluster/4.jpg\" alt=\"socket\"></p>\n<h3 id=\"cluster-client-\"><a href=\"#cluster-client-\" class=\"headerlink\" title=\"cluster-client \"></a>cluster-client </h3><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ClusterClient</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Base</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> [init]() &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> name = <span class=\"hljs-keyword\">this</span>.options.name;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> port = <span class=\"hljs-keyword\">this</span>.options.port;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> server;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.options.isLeader === <span class=\"hljs-literal\">true</span>) &#123;</span><br><span class=\"line\">          server = <span class=\"hljs-keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">          <span class=\"hljs-keyword\">if</span> (!server) &#123;</span><br><span class=\"line\">            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Error</span>(<span class=\"hljs-string\">`create \"<span class=\"hljs-subst\">$&#123;name&#125;</span>\" leader failed, the port:<span class=\"hljs-subst\">$&#123;port&#125;</span> is occupied by other`</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.options.isLeader === <span class=\"hljs-literal\">false</span>) &#123;</span><br><span class=\"line\">          <span class=\"hljs-comment\">// wait for leader active</span></span><br><span class=\"line\">          <span class=\"hljs-keyword\">await</span> ClusterServer.waitFor(port, <span class=\"hljs-keyword\">this</span>.options.maxWaitTime);</span><br><span class=\"line\">        &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">          debug(<span class=\"hljs-string\">'[ClusterClient:%s] init cluster client, try to seize the leader on port:%d'</span>, name, port);</span><br><span class=\"line\">          server = <span class=\"hljs-keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (server) &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">this</span>[innerClient] = <span class=\"hljs-keyword\">new</span> Leader(<span class=\"hljs-built_in\">Object</span>.assign(&#123; server &#125;, <span class=\"hljs-keyword\">this</span>.options));</span><br><span class=\"line\">          debug(<span class=\"hljs-string\">'[ClusterClient:%s] has seized port %d, and serves as leader client.'</span>, name, port);</span><br><span class=\"line\">        &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">this</span>[innerClient] = <span class=\"hljs-keyword\">new</span> Follower(<span class=\"hljs-keyword\">this</span>.options);</span><br><span class=\"line\">          debug(<span class=\"hljs-string\">'[ClusterClient:%s] gives up seizing port %d, and serves as follower client.'</span>, name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>portdetectPortclusterPort</li>\n<li>net.create TCPLeaderFollowersocket</li>\n<li>LeaderpublishFollower</li>\n</ul>\n<p>cluster-client</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>Egg.js</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p>Egg.js<a href=\"https://eggjs.org\" target=\"_blank\" rel=\"noopener\"></a><strong></strong></p>\n<blockquote>\n<p>1. Egg <a href=\"https://eggjs.org/zh-cn/advanced/framework.html\" target=\"_blank\" rel=\"noopener\"></a> <br>2.<a href=\"https://eggjs.org/zh-cn/basics/plugin.html\" target=\"_blank\" rel=\"noopener\"></a><br>3.<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\"></a><br>4. <a href=\"http://koajs.com/\" target=\"_blank\" rel=\"noopener\">Koa</a> <br>5.<br>6.<a href=\"https://eggjs.org/zh-cn/tutorials/progressive.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n</blockquote>\n<p>1Koa2KoaExpress4Koa56</p>\n<p>3<strong></strong>nodejs</p>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><ul>\n<li><strong>egg-core</strong>: <strong>EggCore</strong>KoaApplication4 <em>Koa</em></li>\n<li><strong>egg</strong>: EggCore<strong>EggApplication</strong>ApplicationAgentEggApplication</li>\n<li><strong>egg-cluster</strong>: <strong></strong></li>\n</ul>\n<p><em>egg-clusterEgg.js</em></p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a>egg-cluster</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster index.js  startCluster</span></span><br><span class=\"line\">exports.startCluster = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>egg-clusterMastereggangentworkersapplication,<br><img src=\"/images/egg-cluster/1.jpg\" alt=\"Master-Agent-Works \"></p>\n<h3 id=\"Agent-Works\"><a href=\"#Agent-Works\" class=\"headerlink\" title=\"Agent-Works\"></a>Agent-Works</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.workerManager = <span class=\"keyword\">new</span> Manager();</span><br><span class=\"line\">    \t<span class=\"keyword\">this</span>.messenger = <span class=\"keyword\">new</span> Messenger(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.once(<span class=\"string\">'agent-start'</span>, <span class=\"keyword\">this</span>.forkAppWorkers.bind(<span class=\"keyword\">this</span>));</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        detectPort(<span class=\"function\">(<span class=\"params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// port</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.options.clusterPort = port;</span><br><span class=\"line\">            <span class=\"comment\">//  agent</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.forkAgentWorker();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ... childprocess.fork egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> agentWorker = childprocess.fork(<span class=\"keyword\">this</span>.getAgentWorkerFile(), args, opt);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  worker </span></span><br><span class=\"line\">        <span class=\"comment\">// cluster.fork egg-cluster/lib/agent_worker.js </span></span><br><span class=\"line\">        <span class=\"comment\">//  httphttps</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>agent_worker.jseggAgentagent-startMasterWorkers</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">process.send(&#123; <span class=\"attr\">action</span>: <span class=\"string\">'agent-start'</span>, <span class=\"attr\">to</span>: <span class=\"string\">'master'</span> &#125;); </span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"Agent-Works-IPC\"><a href=\"#Agent-Works-IPC\" class=\"headerlink\" title=\"Agent-Works? (IPC)\"></a>Agent-Works? (<a href=\"https://eggjs.org/zh-cn/core/cluster-and-ipc.html\" target=\"_blank\" rel=\"noopener\">IPC</a>)</h3><ul>\n<li>MasterMessengeregg-cluster/lib/utils/messenger.js</li>\n<li>EggApplicationMessengeregg/lib/core/messenger.js</li>\n</ul>\n<p>AgentWorker(Application)EggApplicationMessengersendMasterMastersendAgentWorkerMaster</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster master.js</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        cluster.on(<span class=\"string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">            <span class=\"comment\">// ...</span></span><br><span class=\"line\">            worker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">\t            msg.from = <span class=\"string\">'app'</span>;</span><br><span class=\"line\">    \t        <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            <span class=\"comment\">// ...</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        agentWorker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">          msg.from = <span class=\"string\">'agent'</span>;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg messenger.js</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Messenger</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    send(action, data, to) &#123;</span><br><span class=\"line\">        sendmessage(process, &#123;</span><br><span class=\"line\">          action,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          to,</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>from</strong><strong>to</strong></p>\n<p><img src=\"/images/egg-cluster/2.jpg\" alt=\"Master-Agent-Works \"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\"></a></h3><p><img src=\"/images/egg-cluster/3.jpg\" alt=\"nworkerm\"></p>\n<ul>\n<li>n * m </li>\n<li>Master</li>\n<li>eggIPCMaster</li>\n</ul>\n<p>socket<a href=\"https://github.com/node-modules/cluster-client\" target=\"_blank\" rel=\"noopener\">cluster-client</a></p>\n<ul>\n<li>AgentLeader</li>\n<li>WorkerFollowerAgent</li>\n</ul>\n<p>LeaderAgentdisconfeuerkaFollowerWorker</p>\n<p><img src=\"/images/egg-cluster/4.jpg\" alt=\"socket\"></p>\n<h3 id=\"cluster-client-\"><a href=\"#cluster-client-\" class=\"headerlink\" title=\"cluster-client \"></a>cluster-client </h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ClusterClient</span> <span class=\"keyword\">extends</span> <span class=\"title\">Base</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">async</span> [init]() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> name = <span class=\"keyword\">this</span>.options.name;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> port = <span class=\"keyword\">this</span>.options.port;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> server;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.options.isLeader === <span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">          server = <span class=\"keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (!server) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">`create \"<span class=\"subst\">$&#123;name&#125;</span>\" leader failed, the port:<span class=\"subst\">$&#123;port&#125;</span> is occupied by other`</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.options.isLeader === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// wait for leader active</span></span><br><span class=\"line\">          <span class=\"keyword\">await</span> ClusterServer.waitFor(port, <span class=\"keyword\">this</span>.options.maxWaitTime);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          debug(<span class=\"string\">'[ClusterClient:%s] init cluster client, try to seize the leader on port:%d'</span>, name, port);</span><br><span class=\"line\">          server = <span class=\"keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (server) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>[innerClient] = <span class=\"keyword\">new</span> Leader(<span class=\"built_in\">Object</span>.assign(&#123; server &#125;, <span class=\"keyword\">this</span>.options));</span><br><span class=\"line\">          debug(<span class=\"string\">'[ClusterClient:%s] has seized port %d, and serves as leader client.'</span>, name, port);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>[innerClient] = <span class=\"keyword\">new</span> Follower(<span class=\"keyword\">this</span>.options);</span><br><span class=\"line\">          debug(<span class=\"string\">'[ClusterClient:%s] gives up seizing port %d, and serves as follower client.'</span>, name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>portdetectPortclusterPort</li>\n<li>net.create TCPLeaderFollowersocket</li>\n<li>LeaderpublishFollower</li>\n</ul>\n<p>cluster-client</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>Egg.js</p>"},{"title":"libuv & Node.js EventLoop ","keywords":"libuv,EventLoop,V8","description":"libuvNode.js EventLoopsetTimeout `nextTick`","date":"2020-02-29T21:39:36.647Z","_content":"\n[libuv](https://libuv.org/)EventLoop\n\n- `libuv``V8`\n- JavaScriptC/C++\n\n\n\n****\n\n```c++\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n20102020\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n### libuv & EventLoop\n\n![_images/loop_iteration.png](/images/v8-libuv-timer-event-loop/loop_iteration.png)\n\n`libuv`[The I/O loop](http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop)\n\n![image-20200301145547994](/images/v8-libuv-timer-event-loop/image-20200301145547994.png)\n\n[Event Loop Explained](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained)`pending callbacks``I/O callbacks`\n\n> Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point.  libuv\n\n**libuv**`pending callbacks`I/O callbackspollingpending callbacks\n\n<br/>\n\n> This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives `ECONNREFUSED` when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the **pending callbacks** phase.  Node.js\n\n**Node.js**`pending callbacks`callbacksTCP\n\n`pending callbacks`libuvI/ONode.jsI/OI/O `poll`\n\n<br/>\n\n<br/>\n\n## libuv\n\n```c\nint uv_run(uv_loop_t* loop, uv_run_mode mode) { //  mode  UV_RUN_DEFAULT\n  int timeout;\n  int r;\n  int ran_pending;\n\n  // alive\n  r = uv__loop_alive(loop);\n  if (!r)\n    uv__update_time(loop); // libuv\n\n  while (r != 0 && loop->stop_flag == 0) {\n    uv__update_time(loop); // libuv Update loop time\n    uv__run_timers(loop); //  timers \n    ran_pending = uv__run_pending(loop); // pending 01\n    uv__run_idle(loop); // idle  Node.js\n    uv__run_prepare(loop); // prepare  Node.js\n\n    timeout = 0; //  poll \n    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)\n      timeout = uv_backend_timeout(loop); //  poll \n    // timers diff = loop.time - min.timeout\n    //  diff >= 0 , timeout = 0\n    //  timeout = min(diff, INT_MAX)\n    \n    uv__io_poll(loop, timeout); //  poll \n    uv__run_check(loop); //  check \n    uv__run_closing_handles(loop); //  close \n\n    // mode  UV_RUN_DEFAULT \n    if (mode == UV_RUN_ONCE) {\n      uv__update_time(loop);\n      uv__run_timers(loop);\n    }\n\n    // alive\n    r = uv__loop_alive(loop);\n    if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)\n      break;\n  }\n\n  /* The if statement lets gcc compile it to a conditional store. Avoids\n   * dirtying a cache line.\n   */\n  if (loop->stop_flag != 0)\n    loop->stop_flag = 0;\n\n  return r;\n}\n```\n\n`uv_run`\n\n<br/>\n\n```c\nvoid uv__run_timers(uv_loop_t* loop) {\n  struct heap_node* heap_node; // timers \n  uv_timer_t* handle;\n\n  for (;;) {\n    heap_node = heap_min(timer_heap(loop)); // \n    if (heap_node == NULL) // \n      break;\n\n    handle = container_of(heap_node, uv_timer_t, heap_node); \n    if (handle->timeout > loop->time) // \n      break;\n\n    uv_timer_stop(handle);\n    uv_timer_again(handle);\n    \n    handle->timer_cb(handle); // \n  }\n}\n```\n\ntimers`loop->time`**`handle->timer_cb`JavaScriptsetTimeout**\n\n<br/>\n\n```c\nstatic int uv__run_pending(uv_loop_t* loop) {\n  QUEUE* q;\n  QUEUE pq;\n  uv__io_t* w;\n\n  if (QUEUE_EMPTY(&loop->pending_queue))\n    return 0;\n\n  QUEUE_MOVE(&loop->pending_queue, &pq);\n\n  while (!QUEUE_EMPTY(&pq)) { // \n    q = QUEUE_HEAD(&pq);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n    w = QUEUE_DATA(q, uv__io_t, pending_queue);\n    w->cb(loop, w, POLLOUT); // \n  }\n\n  return 1;\n}\n```\n\nlibuv\n\n<br/>\n\n```c\n#define UV_LOOP_WATCHER_DEFINE(name, type)                                    \\\n\tvoid uv__run_##name(uv_loop_t* loop) {                                      \\\n    uv_##name##_t* h;                                                         \\\n    QUEUE queue;                                                              \\\n    QUEUE* q;                                                                 \\\n    QUEUE_MOVE(&loop->name##_handles, &queue);                                \\\n    while (!QUEUE_EMPTY(&queue)) {                                            \\\n      q = QUEUE_HEAD(&queue);                                                 \\\n      h = QUEUE_DATA(q, uv_##name##_t, queue);                                \\\n      QUEUE_REMOVE(q);                                                        \\\n      QUEUE_INSERT_TAIL(&loop->name##_handles, q);                            \\\n      h->name##_cb(h);                                                        \\\n    }                                                                         \\\n  }     \n\nUV_LOOP_WATCHER_DEFINE(prepare, PREPARE)\nUV_LOOP_WATCHER_DEFINE(check, CHECK)\nUV_LOOP_WATCHER_DEFINE(idle, IDLE)\n```\n\n`UV_LOOP_WATCHER_DEFINE``prepare``check``idle`3\n\n<br/>\n\n```c\n// uv__io_poll \nvoid uv__io_poll(uv_loop_t* loop, int timeout) {\n  // ...\n  if (loop->nfds == 0) { //  \n    assert(QUEUE_EMPTY(&loop->watcher_queue));\n    return;\n  }\n\n  // loop->watcher_queueepoll\n  while (!QUEUE_EMPTY(&loop->watcher_queue)) {\n    q = QUEUE_HEAD(&loop->watcher_queue);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n\n    w = QUEUE_DATA(q, uv__io_t, watcher_queue);\n    // ...\n    if (w->events == 0)\n      op = EPOLL_CTL_ADD; // \n    else\n      op = EPOLL_CTL_MOD; // \n\n    epoll_ctl(loop->backend_fd, op, w->fd, &e) // epoll_ctl \n\n    w->events = w->pevents;\n  }\n\n  sigmask = 0;\n  if (loop->flags & UV_LOOP_BLOCK_SIGPROF) {\n    sigemptyset(&sigset);\n    sigaddset(&sigset, SIGPROF);\n    sigmask |= 1 << (SIGPROF - 1);\n  }\n\n  base = loop->time;\n  real_timeout = timeout;\n\n  for (;;) {\n    nfds = epoll_wait(loop->backend_fd,\n                        events,\n                        ARRAY_SIZE(events),\n                        timeout);\n    \n    if (nfds == 0) { // \n      assert(timeout != -1); // -1 nfds0\n      if (timeout == 0) // \n        return;\n      \n      goto update_timeout; //   epoll_wait \n    }\n\n    if (nfds == -1) { // \n      if (errno == ENOSYS) {\n        /* epoll_wait() or epoll_pwait() failed, try the other system call. */\n        assert(no_epoll_wait == 0 || no_epoll_pwait == 0);\n        continue;\n      }\n\n      if (errno != EINTR)\n        abort();\n\n      if (timeout == -1)\n        continue;\n\n      if (timeout == 0)\n        return;\n\n      goto update_timeout;\n    }\n\n    have_signals = 0;\n    nevents = 0;\n\n    loop->watchers[loop->nwatchers] = (void*) events;\n    loop->watchers[loop->nwatchers + 1] = (void*) (uintptr_t) nfds;\n    for (i = 0; i < nfds; i++) {\n      pe = events + i;\n      fd = pe->data.fd;\n      w = loop->watchers[fd];\n      w->cb(loop, w, pe->events); // forIO\n    }\n\n    if (timeout == 0)\n      return;\n\n    if (timeout == -1)\n      continue;\n\nupdate_timeout:\n    assert(timeout > 0);\n\n    real_timeout -= (loop->time - base);\n    if (real_timeout <= 0)\n      return;\n\n    timeout = real_timeout;\n  }\n}\n```\n\n`uv__io_poll`timeout`timers``epoll`IO`select``poll``epoll`\n\n> epoll[Linux](https://baike.baidu.com/item/Linux)[](https://baike.baidu.com/item//9809582)pollLinuxIOselect/poll[](https://baike.baidu.com/item//3763280)[CPU](https://baike.baidu.com/item/CPU/120556)IOReadyepollselect/pollIOLevel TriggeredEdge TriggeredIOepoll_wait/epoll_pwait \n\nlibuvepoll\n\n- epollselect/poll\n- epollselect/pollselect/pollNode.jslibuv\n\n<br/>\n\n```c\nstatic void uv__run_closing_handles(uv_loop_t* loop) {\n  uv_handle_t* p;\n  uv_handle_t* q;\n\n  p = loop->closing_handles;\n  loop->closing_handles = NULL;\n\n  while (p) {\n    q = p->next_closing;\n    uv__finish_close(p);\n    p = q;\n  }\n}\n```\n\n`close`\n\n<br/>\n\nlibuv`poll`\n\n<br/>\n\n<br/>\n\n\n\n## Node.js setTimeout\n\n**`handle->timer_cb`JavaScriptsetTimeout**\n\nNode.js`setTimemout`\n\n```javascript\nfunction setTimeout(callback, after, arg1, arg2, arg3) {\n  var args = [arg1, arg2, arg3]; // \n  const timeout = new Timeout(callback, after, args, false);\n  active(timeout);\n\n  return timeout;\n}\nfunction Timeout(callback, after, args, isRepeat) {\n  // \n  after *= 1; \n  if (!(after >= 1 && after <= TIMEOUT_MAX)) {\n    after = 1; //  1 \n  }\n  this._idleTimeout = after;\n  this._onTimeout = callback;\n  this._timerArgs = args;\n}\nfunction active(item) {\n  insert(item, true, getLibuvNow());  // getLibuvNow  loop->time\n}\nfunction insert(item, refed, start) {\n  let msecs = item._idleTimeout;\n  if (msecs < 0 || msecs === undefined)\n    return;\n\n  // Truncate so that accuracy of sub-millisecond timers is not assumed.\n  msecs = Math.trunc(msecs);\n\n  item._idleStart = start;\n\n  // Use an existing list if there is one, otherwise we need to make a new one.\n  // timerListMap key value TimersList\n  var list = timerListMap[msecs];\n  if (list === undefined) {\n    const expiry = start + msecs; // \n    timerListMap[msecs] = list = new TimersList(expiry, msecs); // \n    timerListQueue.insert(list); // timerListQueue \n\n    if (nextExpiry > expiry) {\n      scheduleTimer(msecs); //  V8 scheduleTimer\n      nextExpiry = expiry;\n    }\n  }\n  // ... \n  L.append(list, item); // setTimeoutTimeoutlist\n}\n```\n\nJavaScripttimerssetTimeoutV8V8`scheduleTimer(msecs);`V8\n\n```c\n// timers.cc\nvoid ScheduleTimer(const FunctionCallbackInfo<Value>& args) {\n  auto env = Environment::GetCurrent(args);\n  env->ScheduleTimer(args[0]->IntegerValue(env->context()).FromJust());\n}\n// env.cc\nvoid Environment::ScheduleTimer(int64_t duration_ms) {\n  if (started_cleanup_) return;\n  uv_timer_start(timer_handle(), RunTimers, duration_ms, 0);\n}\nvoid Environment::RunTimers(uv_timer_t* handle) {\n  Environment* env = Environment::from_timer_handle(handle);\n  \n  // timers_callback_function \n  Local<Function> cb = env->timers_callback_function();\n  do {\n    ret = cb->Call(env->context(), process, 1, &arg);\n  } while (ret.IsEmpty() && env->can_call_into_js());\n}\n// uv/timer.c\nint uv_timer_start(uv_timer_t* handle,\n                   uv_timer_cb cb,\n                   uint64_t timeout,\n                   uint64_t repeat) {\n  // uv_timer_t\n  // JavaScriptC++RunTimers\n  handle->timer_cb = cb;\n  handle->timeout = clamped_timeout;\n  handle->repeat = repeat;\n  handle->start_id = handle->loop->timer_counter++;\n\n  // uv_timer_ttimer_heap\n  heap_insert(timer_heap(handle->loop),\n              (struct heap_node*) &handle->heap_node,\n              timer_less_than);\n  uv__handle_start(handle);\n\n  return 0;\n}\n\n```\n\n**V8timersC++**`timers_callback_function`\n\n```c++\n// timers.cc\nvoid SetupTimers(const FunctionCallbackInfo<Value>& args) {\n  CHECK(args[0]->IsFunction());\n  CHECK(args[1]->IsFunction());\n  auto env = Environment::GetCurrent(args);\n\n  env->set_immediate_callback_function(args[0].As<Function>()); // immediate\n  env->set_timers_callback_function(args[1].As<Function>()); // timers\n}\n```\n\n```javascript\n// node.js\nconst {\n  setupTaskQueue,\n  queueMicrotask\n} = require('internal/process/task_queues');\nconst { nextTick, runNextTicks } = setupTaskQueue();\nprocess.nextTick = nextTick;\nprocess._tickCallback = runNextTicks;\n\nconst { getTimerCallbacks } = require('internal/timers');\nconst { setupTimers } = internalBinding('timers'); // c++ SetupTimers JavaScript\nconst { processImmediate, processTimers } = getTimerCallbacks(runNextTicks);\nsetupTimers(processImmediate, processTimers);\n```\n\n`node.js``processImmediate``processTimers`JavaScriptC++`timers_callback_function``processTimers`\n\n```getTimerCallbacks`\n\n```javascript\nfunction getTimerCallbacks(runNextTicks) {\n  function processImmediate() {\n    // \n  }\n\n\n  function processTimers(now) {\n    nextExpiry = Infinity;\n\n    let list;\n    let ranAtLeastOneList = false;\n    while (list = timerListQueue.peek()) {\n      if (list.expiry > now) { // now(libuv loop->time), \n        nextExpiry = list.expiry; // nextExpiry  \n        return refCount > 0 ? nextExpiry : -nextExpiry;\n      }\n      if (ranAtLeastOneList)\n        runNextTicks(); // \n      else\n        ranAtLeastOneList = true;\n      listOnTimeout(list, now);\n    }\n    return 0;\n  }\n\n  function listOnTimeout(list, now) {\n    const msecs = list.msecs;\n\n    debug('timeout callback %d', msecs);\n\n    var diff, timer;\n    let ranAtLeastOneTimer = false;\n    while (timer = L.peek(list)) { // list\n      // _idleStart libuv (loop->time)\n      // now libuv callback\n      diff = now - timer._idleStart; \n\n      // Check if this loop iteration is too early for the next timer.\n      // This happens if there are more timers scheduled for later in the list.\n      if (diff < msecs) {\n        list.expiry = Math.max(timer._idleStart + msecs, now + 1);\n        list.id = timerListId++;\n        timerListQueue.percolateDown(1);\n        debug('%d list wait because diff is %d', msecs, diff);\n        return;\n      }\n\n      if (ranAtLeastOneTimer)\n        runNextTicks(); // \n      else\n        ranAtLeastOneTimer = true;\n\n      // The actual logic for when a timeout happens.\n      L.remove(timer);\n\n      const asyncId = timer[async_id_symbol];\n      if (!timer._onTimeout) {\n        continue;\n      }\n      try {\n        const args = timer._timerArgs;\n        if (args === undefined)\n          timer._onTimeout(); // _onTimeout setTimeout \n        else\n          timer._onTimeout(...args);\n      } finally {\n        // ...\n      }\n    }\n    if (list === timerListMap[msecs]) {\n      delete timerListMap[msecs];\n      timerListQueue.shift();\n    }\n  }\n\n  return {\n    processImmediate,\n    processTimers\n  };\n}\n```\n\n`libuv``runNextTicks`**setTimeoutcallback``timerNode.js 11**\n\n> Timers\n> Interval timers will be rescheduled even if previous interval threw an error. #20002\n> **nextTick queue will be run after each immediate and timer. [#22842](https://github.com/nodejs/node/pull/22842)**\n\n11\n\n```javascript\nsetTimeout(() => {\n  console.log('time1');\n  Promise.resolve().then(() => {\n    console.log('promise1');\n  });\n});\n\nsetTimeout(() => {\n  console.log('time2');\n  Promise.resolve().then(() => {\n    console.log('promise2');\n  });\n});\n\n/* 11\ntime1\npromise1\ntime2\npromise2\n*/\n\n/* 11\ntime1\ntime2\npromise1\npromise2\n*/\n\n```\n\n\n\n<br/>\n\n<br/>\n\n## \n\nlibuvNode.js EventLoop```setTimeout` `nextTick`","source":"_posts/v8-libuv-timer-event-loop.md","raw":"---\ntitle: libuv & Node.js EventLoop \ncategory: JavaScript\nkeywords: libuv,EventLoop,V8\ndescription: libuvNode.js EventLoopsetTimeout `nextTick`\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-03-01T05:39:36.647Z\n---\n\n[libuv](https://libuv.org/)EventLoop\n\n- `libuv``V8`\n- JavaScriptC/C++\n\n\n\n****\n\n```c++\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n20102020\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n### libuv & EventLoop\n\n![_images/loop_iteration.png](/images/v8-libuv-timer-event-loop/loop_iteration.png)\n\n`libuv`[The I/O loop](http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop)\n\n![image-20200301145547994](/images/v8-libuv-timer-event-loop/image-20200301145547994.png)\n\n[Event Loop Explained](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained)`pending callbacks``I/O callbacks`\n\n> Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point.  libuv\n\n**libuv**`pending callbacks`I/O callbackspollingpending callbacks\n\n<br/>\n\n> This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives `ECONNREFUSED` when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the **pending callbacks** phase.  Node.js\n\n**Node.js**`pending callbacks`callbacksTCP\n\n`pending callbacks`libuvI/ONode.jsI/OI/O `poll`\n\n<br/>\n\n<br/>\n\n## libuv\n\n```c\nint uv_run(uv_loop_t* loop, uv_run_mode mode) { //  mode  UV_RUN_DEFAULT\n  int timeout;\n  int r;\n  int ran_pending;\n\n  // alive\n  r = uv__loop_alive(loop);\n  if (!r)\n    uv__update_time(loop); // libuv\n\n  while (r != 0 && loop->stop_flag == 0) {\n    uv__update_time(loop); // libuv Update loop time\n    uv__run_timers(loop); //  timers \n    ran_pending = uv__run_pending(loop); // pending 01\n    uv__run_idle(loop); // idle  Node.js\n    uv__run_prepare(loop); // prepare  Node.js\n\n    timeout = 0; //  poll \n    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)\n      timeout = uv_backend_timeout(loop); //  poll \n    // timers diff = loop.time - min.timeout\n    //  diff >= 0 , timeout = 0\n    //  timeout = min(diff, INT_MAX)\n    \n    uv__io_poll(loop, timeout); //  poll \n    uv__run_check(loop); //  check \n    uv__run_closing_handles(loop); //  close \n\n    // mode  UV_RUN_DEFAULT \n    if (mode == UV_RUN_ONCE) {\n      uv__update_time(loop);\n      uv__run_timers(loop);\n    }\n\n    // alive\n    r = uv__loop_alive(loop);\n    if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)\n      break;\n  }\n\n  /* The if statement lets gcc compile it to a conditional store. Avoids\n   * dirtying a cache line.\n   */\n  if (loop->stop_flag != 0)\n    loop->stop_flag = 0;\n\n  return r;\n}\n```\n\n`uv_run`\n\n<br/>\n\n```c\nvoid uv__run_timers(uv_loop_t* loop) {\n  struct heap_node* heap_node; // timers \n  uv_timer_t* handle;\n\n  for (;;) {\n    heap_node = heap_min(timer_heap(loop)); // \n    if (heap_node == NULL) // \n      break;\n\n    handle = container_of(heap_node, uv_timer_t, heap_node); \n    if (handle->timeout > loop->time) // \n      break;\n\n    uv_timer_stop(handle);\n    uv_timer_again(handle);\n    \n    handle->timer_cb(handle); // \n  }\n}\n```\n\ntimers`loop->time`**`handle->timer_cb`JavaScriptsetTimeout**\n\n<br/>\n\n```c\nstatic int uv__run_pending(uv_loop_t* loop) {\n  QUEUE* q;\n  QUEUE pq;\n  uv__io_t* w;\n\n  if (QUEUE_EMPTY(&loop->pending_queue))\n    return 0;\n\n  QUEUE_MOVE(&loop->pending_queue, &pq);\n\n  while (!QUEUE_EMPTY(&pq)) { // \n    q = QUEUE_HEAD(&pq);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n    w = QUEUE_DATA(q, uv__io_t, pending_queue);\n    w->cb(loop, w, POLLOUT); // \n  }\n\n  return 1;\n}\n```\n\nlibuv\n\n<br/>\n\n```c\n#define UV_LOOP_WATCHER_DEFINE(name, type)                                    \\\n\tvoid uv__run_##name(uv_loop_t* loop) {                                      \\\n    uv_##name##_t* h;                                                         \\\n    QUEUE queue;                                                              \\\n    QUEUE* q;                                                                 \\\n    QUEUE_MOVE(&loop->name##_handles, &queue);                                \\\n    while (!QUEUE_EMPTY(&queue)) {                                            \\\n      q = QUEUE_HEAD(&queue);                                                 \\\n      h = QUEUE_DATA(q, uv_##name##_t, queue);                                \\\n      QUEUE_REMOVE(q);                                                        \\\n      QUEUE_INSERT_TAIL(&loop->name##_handles, q);                            \\\n      h->name##_cb(h);                                                        \\\n    }                                                                         \\\n  }     \n\nUV_LOOP_WATCHER_DEFINE(prepare, PREPARE)\nUV_LOOP_WATCHER_DEFINE(check, CHECK)\nUV_LOOP_WATCHER_DEFINE(idle, IDLE)\n```\n\n`UV_LOOP_WATCHER_DEFINE``prepare``check``idle`3\n\n<br/>\n\n```c\n// uv__io_poll \nvoid uv__io_poll(uv_loop_t* loop, int timeout) {\n  // ...\n  if (loop->nfds == 0) { //  \n    assert(QUEUE_EMPTY(&loop->watcher_queue));\n    return;\n  }\n\n  // loop->watcher_queueepoll\n  while (!QUEUE_EMPTY(&loop->watcher_queue)) {\n    q = QUEUE_HEAD(&loop->watcher_queue);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n\n    w = QUEUE_DATA(q, uv__io_t, watcher_queue);\n    // ...\n    if (w->events == 0)\n      op = EPOLL_CTL_ADD; // \n    else\n      op = EPOLL_CTL_MOD; // \n\n    epoll_ctl(loop->backend_fd, op, w->fd, &e) // epoll_ctl \n\n    w->events = w->pevents;\n  }\n\n  sigmask = 0;\n  if (loop->flags & UV_LOOP_BLOCK_SIGPROF) {\n    sigemptyset(&sigset);\n    sigaddset(&sigset, SIGPROF);\n    sigmask |= 1 << (SIGPROF - 1);\n  }\n\n  base = loop->time;\n  real_timeout = timeout;\n\n  for (;;) {\n    nfds = epoll_wait(loop->backend_fd,\n                        events,\n                        ARRAY_SIZE(events),\n                        timeout);\n    \n    if (nfds == 0) { // \n      assert(timeout != -1); // -1 nfds0\n      if (timeout == 0) // \n        return;\n      \n      goto update_timeout; //   epoll_wait \n    }\n\n    if (nfds == -1) { // \n      if (errno == ENOSYS) {\n        /* epoll_wait() or epoll_pwait() failed, try the other system call. */\n        assert(no_epoll_wait == 0 || no_epoll_pwait == 0);\n        continue;\n      }\n\n      if (errno != EINTR)\n        abort();\n\n      if (timeout == -1)\n        continue;\n\n      if (timeout == 0)\n        return;\n\n      goto update_timeout;\n    }\n\n    have_signals = 0;\n    nevents = 0;\n\n    loop->watchers[loop->nwatchers] = (void*) events;\n    loop->watchers[loop->nwatchers + 1] = (void*) (uintptr_t) nfds;\n    for (i = 0; i < nfds; i++) {\n      pe = events + i;\n      fd = pe->data.fd;\n      w = loop->watchers[fd];\n      w->cb(loop, w, pe->events); // forIO\n    }\n\n    if (timeout == 0)\n      return;\n\n    if (timeout == -1)\n      continue;\n\nupdate_timeout:\n    assert(timeout > 0);\n\n    real_timeout -= (loop->time - base);\n    if (real_timeout <= 0)\n      return;\n\n    timeout = real_timeout;\n  }\n}\n```\n\n`uv__io_poll`timeout`timers``epoll`IO`select``poll``epoll`\n\n> epoll[Linux](https://baike.baidu.com/item/Linux)[](https://baike.baidu.com/item//9809582)pollLinuxIOselect/poll[](https://baike.baidu.com/item//3763280)[CPU](https://baike.baidu.com/item/CPU/120556)IOReadyepollselect/pollIOLevel TriggeredEdge TriggeredIOepoll_wait/epoll_pwait \n\nlibuvepoll\n\n- epollselect/poll\n- epollselect/pollselect/pollNode.jslibuv\n\n<br/>\n\n```c\nstatic void uv__run_closing_handles(uv_loop_t* loop) {\n  uv_handle_t* p;\n  uv_handle_t* q;\n\n  p = loop->closing_handles;\n  loop->closing_handles = NULL;\n\n  while (p) {\n    q = p->next_closing;\n    uv__finish_close(p);\n    p = q;\n  }\n}\n```\n\n`close`\n\n<br/>\n\nlibuv`poll`\n\n<br/>\n\n<br/>\n\n\n\n## Node.js setTimeout\n\n**`handle->timer_cb`JavaScriptsetTimeout**\n\nNode.js`setTimemout`\n\n```javascript\nfunction setTimeout(callback, after, arg1, arg2, arg3) {\n  var args = [arg1, arg2, arg3]; // \n  const timeout = new Timeout(callback, after, args, false);\n  active(timeout);\n\n  return timeout;\n}\nfunction Timeout(callback, after, args, isRepeat) {\n  // \n  after *= 1; \n  if (!(after >= 1 && after <= TIMEOUT_MAX)) {\n    after = 1; //  1 \n  }\n  this._idleTimeout = after;\n  this._onTimeout = callback;\n  this._timerArgs = args;\n}\nfunction active(item) {\n  insert(item, true, getLibuvNow());  // getLibuvNow  loop->time\n}\nfunction insert(item, refed, start) {\n  let msecs = item._idleTimeout;\n  if (msecs < 0 || msecs === undefined)\n    return;\n\n  // Truncate so that accuracy of sub-millisecond timers is not assumed.\n  msecs = Math.trunc(msecs);\n\n  item._idleStart = start;\n\n  // Use an existing list if there is one, otherwise we need to make a new one.\n  // timerListMap key value TimersList\n  var list = timerListMap[msecs];\n  if (list === undefined) {\n    const expiry = start + msecs; // \n    timerListMap[msecs] = list = new TimersList(expiry, msecs); // \n    timerListQueue.insert(list); // timerListQueue \n\n    if (nextExpiry > expiry) {\n      scheduleTimer(msecs); //  V8 scheduleTimer\n      nextExpiry = expiry;\n    }\n  }\n  // ... \n  L.append(list, item); // setTimeoutTimeoutlist\n}\n```\n\nJavaScripttimerssetTimeoutV8V8`scheduleTimer(msecs);`V8\n\n```c\n// timers.cc\nvoid ScheduleTimer(const FunctionCallbackInfo<Value>& args) {\n  auto env = Environment::GetCurrent(args);\n  env->ScheduleTimer(args[0]->IntegerValue(env->context()).FromJust());\n}\n// env.cc\nvoid Environment::ScheduleTimer(int64_t duration_ms) {\n  if (started_cleanup_) return;\n  uv_timer_start(timer_handle(), RunTimers, duration_ms, 0);\n}\nvoid Environment::RunTimers(uv_timer_t* handle) {\n  Environment* env = Environment::from_timer_handle(handle);\n  \n  // timers_callback_function \n  Local<Function> cb = env->timers_callback_function();\n  do {\n    ret = cb->Call(env->context(), process, 1, &arg);\n  } while (ret.IsEmpty() && env->can_call_into_js());\n}\n// uv/timer.c\nint uv_timer_start(uv_timer_t* handle,\n                   uv_timer_cb cb,\n                   uint64_t timeout,\n                   uint64_t repeat) {\n  // uv_timer_t\n  // JavaScriptC++RunTimers\n  handle->timer_cb = cb;\n  handle->timeout = clamped_timeout;\n  handle->repeat = repeat;\n  handle->start_id = handle->loop->timer_counter++;\n\n  // uv_timer_ttimer_heap\n  heap_insert(timer_heap(handle->loop),\n              (struct heap_node*) &handle->heap_node,\n              timer_less_than);\n  uv__handle_start(handle);\n\n  return 0;\n}\n\n```\n\n**V8timersC++**`timers_callback_function`\n\n```c++\n// timers.cc\nvoid SetupTimers(const FunctionCallbackInfo<Value>& args) {\n  CHECK(args[0]->IsFunction());\n  CHECK(args[1]->IsFunction());\n  auto env = Environment::GetCurrent(args);\n\n  env->set_immediate_callback_function(args[0].As<Function>()); // immediate\n  env->set_timers_callback_function(args[1].As<Function>()); // timers\n}\n```\n\n```javascript\n// node.js\nconst {\n  setupTaskQueue,\n  queueMicrotask\n} = require('internal/process/task_queues');\nconst { nextTick, runNextTicks } = setupTaskQueue();\nprocess.nextTick = nextTick;\nprocess._tickCallback = runNextTicks;\n\nconst { getTimerCallbacks } = require('internal/timers');\nconst { setupTimers } = internalBinding('timers'); // c++ SetupTimers JavaScript\nconst { processImmediate, processTimers } = getTimerCallbacks(runNextTicks);\nsetupTimers(processImmediate, processTimers);\n```\n\n`node.js``processImmediate``processTimers`JavaScriptC++`timers_callback_function``processTimers`\n\n```getTimerCallbacks`\n\n```javascript\nfunction getTimerCallbacks(runNextTicks) {\n  function processImmediate() {\n    // \n  }\n\n\n  function processTimers(now) {\n    nextExpiry = Infinity;\n\n    let list;\n    let ranAtLeastOneList = false;\n    while (list = timerListQueue.peek()) {\n      if (list.expiry > now) { // now(libuv loop->time), \n        nextExpiry = list.expiry; // nextExpiry  \n        return refCount > 0 ? nextExpiry : -nextExpiry;\n      }\n      if (ranAtLeastOneList)\n        runNextTicks(); // \n      else\n        ranAtLeastOneList = true;\n      listOnTimeout(list, now);\n    }\n    return 0;\n  }\n\n  function listOnTimeout(list, now) {\n    const msecs = list.msecs;\n\n    debug('timeout callback %d', msecs);\n\n    var diff, timer;\n    let ranAtLeastOneTimer = false;\n    while (timer = L.peek(list)) { // list\n      // _idleStart libuv (loop->time)\n      // now libuv callback\n      diff = now - timer._idleStart; \n\n      // Check if this loop iteration is too early for the next timer.\n      // This happens if there are more timers scheduled for later in the list.\n      if (diff < msecs) {\n        list.expiry = Math.max(timer._idleStart + msecs, now + 1);\n        list.id = timerListId++;\n        timerListQueue.percolateDown(1);\n        debug('%d list wait because diff is %d', msecs, diff);\n        return;\n      }\n\n      if (ranAtLeastOneTimer)\n        runNextTicks(); // \n      else\n        ranAtLeastOneTimer = true;\n\n      // The actual logic for when a timeout happens.\n      L.remove(timer);\n\n      const asyncId = timer[async_id_symbol];\n      if (!timer._onTimeout) {\n        continue;\n      }\n      try {\n        const args = timer._timerArgs;\n        if (args === undefined)\n          timer._onTimeout(); // _onTimeout setTimeout \n        else\n          timer._onTimeout(...args);\n      } finally {\n        // ...\n      }\n    }\n    if (list === timerListMap[msecs]) {\n      delete timerListMap[msecs];\n      timerListQueue.shift();\n    }\n  }\n\n  return {\n    processImmediate,\n    processTimers\n  };\n}\n```\n\n`libuv``runNextTicks`**setTimeoutcallback``timerNode.js 11**\n\n> Timers\n> Interval timers will be rescheduled even if previous interval threw an error. #20002\n> **nextTick queue will be run after each immediate and timer. [#22842](https://github.com/nodejs/node/pull/22842)**\n\n11\n\n```javascript\nsetTimeout(() => {\n  console.log('time1');\n  Promise.resolve().then(() => {\n    console.log('promise1');\n  });\n});\n\nsetTimeout(() => {\n  console.log('time2');\n  Promise.resolve().then(() => {\n    console.log('promise2');\n  });\n});\n\n/* 11\ntime1\npromise1\ntime2\npromise2\n*/\n\n/* 11\ntime1\ntime2\npromise1\npromise2\n*/\n\n```\n\n\n\n<br/>\n\n<br/>\n\n## \n\nlibuvNode.js EventLoop```setTimeout` `nextTick`","slug":"v8-libuv-timer-event-loop","published":1,"updated":"2020-07-07T10:11:25.590Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6u001fd12ix22cpydf","content":"<p><a href=\"https://libuv.org/\" target=\"_blank\" rel=\"noopener\">libuv</a>EventLoop</p>\n<ul>\n<li><code>libuv</code><code>V8</code></li>\n<li>JavaScriptC/C++</li>\n</ul>\n<p></p>\n<p><strong></strong></p>\n<figure class=\"highlight c++ hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// libuv</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// V8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// Node.js</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p>20102020</p>\n<a id=\"more\"></a>\n<p><br></p>\n<p><br></p>\n<h3 id=\"libuv-amp-EventLoop\"><a href=\"#libuv-amp-EventLoop\" class=\"headerlink\" title=\"libuv &amp; EventLoop\"></a>libuv &amp; EventLoop</h3><p><img src=\"/images/v8-libuv-timer-event-loop/loop_iteration.png\" alt=\"_images/loop_iteration.png\"></p>\n<p><code>libuv</code><a href=\"http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop\" target=\"_blank\" rel=\"noopener\">The I/O loop</a></p>\n<p><img src=\"/images/v8-libuv-timer-event-loop/image-20200301145547994.png\" alt=\"image-20200301145547994\"></p>\n<p><a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained\" target=\"_blank\" rel=\"noopener\">Event Loop Explained</a><code>pending callbacks</code><code>I/O callbacks</code></p>\n<blockquote>\n<p>Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point.  libuv</p>\n</blockquote>\n<p><strong>libuv</strong><code>pending callbacks</code>I/O callbackspollingpending callbacks</p>\n<p><br></p>\n<blockquote>\n<p>This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives <code>ECONNREFUSED</code> when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the <strong>pending callbacks</strong> phase.  Node.js</p>\n</blockquote>\n<p><strong>Node.js</strong><code>pending callbacks</code>callbacksTCP</p>\n<p><code>pending callbacks</code>libuvI/ONode.jsI/OI/O <code>poll</code></p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"libuv\"><a href=\"#libuv\" class=\"headerlink\" title=\"libuv\"></a>libuv</h2><figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">uv_run</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop, uv_run_mode mode)</span> </span>&#123; <span class=\"hljs-comment\">//  mode  UV_RUN_DEFAULT</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">int</span> timeout;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">int</span> r;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">int</span> ran_pending;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// alive</span></span><br><span class=\"line\">  r = uv__loop_alive(loop);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!r)</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"hljs-comment\">// libuv</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (r != <span class=\"hljs-number\">0</span> &amp;&amp; loop-&gt;stop_flag == <span class=\"hljs-number\">0</span>) &#123;</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"hljs-comment\">// libuv Update loop time</span></span><br><span class=\"line\">    uv__run_timers(loop); <span class=\"hljs-comment\">//  timers </span></span><br><span class=\"line\">    ran_pending = uv__run_pending(loop); <span class=\"hljs-comment\">// pending 01</span></span><br><span class=\"line\">    uv__run_idle(loop); <span class=\"hljs-comment\">// idle  Node.js</span></span><br><span class=\"line\">    uv__run_prepare(loop); <span class=\"hljs-comment\">// prepare  Node.js</span></span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">//  poll </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> ((mode == UV_RUN_ONCE &amp;&amp; !ran_pending) || mode == UV_RUN_DEFAULT)</span><br><span class=\"line\">      timeout = uv_backend_timeout(loop); <span class=\"hljs-comment\">//  poll </span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// timers diff = loop.time - min.timeout</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">//  diff &gt;= 0 , timeout = 0</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">//  timeout = min(diff, INT_MAX)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    uv__io_poll(loop, timeout); <span class=\"hljs-comment\">//  poll </span></span><br><span class=\"line\">    uv__run_check(loop); <span class=\"hljs-comment\">//  check </span></span><br><span class=\"line\">    uv__run_closing_handles(loop); <span class=\"hljs-comment\">//  close </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// mode  UV_RUN_DEFAULT </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (mode == UV_RUN_ONCE) &#123;</span><br><span class=\"line\">      uv__update_time(loop);</span><br><span class=\"line\">      uv__run_timers(loop);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// alive</span></span><br><span class=\"line\">    r = uv__loop_alive(loop);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* The if statement lets gcc compile it to a conditional store. Avoids</span></span><br><span class=\"line\"><span class=\"hljs-comment\">   * dirtying a cache line.</span></span><br><span class=\"line\"><span class=\"hljs-comment\">   */</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (loop-&gt;stop_flag != <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">    loop-&gt;stop_flag = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> r;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>uv_run</code></p>\n<p><br></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">uv__run_timers</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">heap_node</span>* <span class=\"hljs-title\">heap_node</span>;</span> <span class=\"hljs-comment\">// timers </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">uv_timer_t</span>* handle;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    heap_node = heap_min(timer_heap(loop)); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (heap_node == <span class=\"hljs-literal\">NULL</span>) <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    handle = container_of(heap_node, <span class=\"hljs-keyword\">uv_timer_t</span>, heap_node); </span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (handle-&gt;timeout &gt; loop-&gt;time) <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    uv_timer_stop(handle);</span><br><span class=\"line\">    uv_timer_again(handle);</span><br><span class=\"line\">    </span><br><span class=\"line\">    handle-&gt;timer_cb(handle); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>timers<code>loop-&gt;time</code><strong><code>handle-&gt;timer_cb</code>JavaScriptsetTimeout</strong></p>\n<p><br></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">uv__run_pending</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  QUEUE* q;</span><br><span class=\"line\">  QUEUE pq;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">uv__io_t</span>* w;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (QUEUE_EMPTY(&amp;loop-&gt;pending_queue))</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  QUEUE_MOVE(&amp;loop-&gt;pending_queue, &amp;pq);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (!QUEUE_EMPTY(&amp;pq)) &#123; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;pq);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"hljs-keyword\">uv__io_t</span>, pending_queue);</span><br><span class=\"line\">    w-&gt;cb(loop, w, POLLOUT); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>libuv</p>\n<p><br></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_LOOP_WATCHER_DEFINE(name, type)                                    \\</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">void</span> uv__run_#<span class=\"hljs-meta\">#name(uv_loop_t* loop) &#123;                                      \\</span></span><br><span class=\"line\">    uv_#<span class=\"hljs-meta\">#name##_t* h;                                                         \\</span></span><br><span class=\"line\">    QUEUE <span class=\"hljs-built_in\">queue</span>;                                                              \\</span><br><span class=\"line\">    QUEUE* q;                                                                 \\</span><br><span class=\"line\">    QUEUE_MOVE(&amp;loop-&gt;name##_handles, &amp;<span class=\"hljs-built_in\">queue</span>);                                \\</span><br><span class=\"line\">    <span class=\"hljs-keyword\">while</span> (!QUEUE_EMPTY(&amp;<span class=\"hljs-built_in\">queue</span>)) &#123;                                            \\</span><br><span class=\"line\">      q = QUEUE_HEAD(&amp;<span class=\"hljs-built_in\">queue</span>);                                                 \\</span><br><span class=\"line\">      h = QUEUE_DATA(q, uv_##name##<span class=\"hljs-keyword\">_t</span>, <span class=\"hljs-built_in\">queue</span>);                                \\</span><br><span class=\"line\">      QUEUE_REMOVE(q);                                                        \\</span><br><span class=\"line\">      QUEUE_INSERT_TAIL(&amp;loop-&gt;name##_handles, q);                            \\</span><br><span class=\"line\">      h-&gt;name##_cb(h);                                                        \\</span><br><span class=\"line\">    &#125;                                                                         \\</span><br><span class=\"line\">  &#125;     </span><br><span class=\"line\"></span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(prepare, PREPARE)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(check, CHECK)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(idle, IDLE)</span><br></pre></td></tr></table></figure>\n<p><code>UV_LOOP_WATCHER_DEFINE</code><code>prepare</code><code>check</code><code>idle</code>3</p>\n<p><br></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// uv__io_poll </span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">uv__io_poll</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop, <span class=\"hljs-keyword\">int</span> timeout)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (loop-&gt;nfds == <span class=\"hljs-number\">0</span>) &#123; <span class=\"hljs-comment\">//  </span></span><br><span class=\"line\">    assert(QUEUE_EMPTY(&amp;loop-&gt;watcher_queue));</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// loop-&gt;watcher_queueepoll</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (!QUEUE_EMPTY(&amp;loop-&gt;watcher_queue)) &#123;</span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;loop-&gt;watcher_queue);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\"></span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"hljs-keyword\">uv__io_t</span>, watcher_queue);</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (w-&gt;events == <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      op = EPOLL_CTL_ADD; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">      op = EPOLL_CTL_MOD; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_ctl(loop-&gt;backend_fd, op, w-&gt;fd, &amp;e) <span class=\"hljs-comment\">// epoll_ctl </span></span><br><span class=\"line\"></span><br><span class=\"line\">    w-&gt;events = w-&gt;pevents;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  sigmask = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (loop-&gt;flags &amp; UV_LOOP_BLOCK_SIGPROF) &#123;</span><br><span class=\"line\">    sigemptyset(&amp;sigset);</span><br><span class=\"line\">    sigaddset(&amp;sigset, SIGPROF);</span><br><span class=\"line\">    sigmask |= <span class=\"hljs-number\">1</span> &lt;&lt; (SIGPROF - <span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  base = loop-&gt;time;</span><br><span class=\"line\">  real_timeout = timeout;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    nfds = epoll_wait(loop-&gt;backend_fd,</span><br><span class=\"line\">                        events,</span><br><span class=\"line\">                        ARRAY_SIZE(events),</span><br><span class=\"line\">                        timeout);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (nfds == <span class=\"hljs-number\">0</span>) &#123; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      assert(timeout != <span class=\"hljs-number\">-1</span>); <span class=\"hljs-comment\">// -1 nfds0</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">0</span>) <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"hljs-keyword\">goto</span> update_timeout; <span class=\"hljs-comment\">//   epoll_wait </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (nfds == <span class=\"hljs-number\">-1</span>) &#123; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (errno == ENOSYS) &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">/* epoll_wait() or epoll_pwait() failed, try the other system call. */</span></span><br><span class=\"line\">        assert(no_epoll_wait == <span class=\"hljs-number\">0</span> || no_epoll_pwait == <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (errno != EINTR)</span><br><span class=\"line\">        <span class=\"hljs-built_in\">abort</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">-1</span>)</span><br><span class=\"line\">        <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">goto</span> update_timeout;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    have_signals = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">    nevents = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers] = (<span class=\"hljs-keyword\">void</span>*) events;</span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers + <span class=\"hljs-number\">1</span>] = (<span class=\"hljs-keyword\">void</span>*) (<span class=\"hljs-keyword\">uintptr_t</span>) nfds;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; nfds; i++) &#123;</span><br><span class=\"line\">      pe = events + i;</span><br><span class=\"line\">      fd = pe-&gt;data.fd;</span><br><span class=\"line\">      w = loop-&gt;watchers[fd];</span><br><span class=\"line\">      w-&gt;cb(loop, w, pe-&gt;events); <span class=\"hljs-comment\">// forIO</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">-1</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">update_timeout:</span><br><span class=\"line\">    assert(timeout &gt; <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    real_timeout -= (loop-&gt;time - base);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (real_timeout &lt;= <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = real_timeout;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>uv__io_poll</code>timeout<code>timers</code><code>epoll</code>IO<code>select</code><code>poll</code><code>epoll</code></p>\n<blockquote>\n<p>epoll<a href=\"https://baike.baidu.com/item/Linux\" target=\"_blank\" rel=\"noopener\">Linux</a><a href=\"https://baike.baidu.com/item//9809582\" target=\"_blank\" rel=\"noopener\"></a>pollLinuxIOselect/poll<a href=\"https://baike.baidu.com/item//3763280\" target=\"_blank\" rel=\"noopener\"></a><a href=\"https://baike.baidu.com/item/CPU/120556\" target=\"_blank\" rel=\"noopener\">CPU</a>IOReadyepollselect/pollIOLevel TriggeredEdge TriggeredIOepoll_wait/epoll_pwait </p>\n</blockquote>\n<p>libuvepoll</p>\n<ul>\n<li>epollselect/poll</li>\n<li>epollselect/pollselect/pollNode.jslibuv</li>\n</ul>\n<p><br></p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">uv__run_closing_handles</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">uv_handle_t</span>* p;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">uv_handle_t</span>* q;</span><br><span class=\"line\"></span><br><span class=\"line\">  p = loop-&gt;closing_handles;</span><br><span class=\"line\">  loop-&gt;closing_handles = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (p) &#123;</span><br><span class=\"line\">    q = p-&gt;next_closing;</span><br><span class=\"line\">    uv__finish_close(p);</span><br><span class=\"line\">    p = q;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>close</code></p>\n<p><br></p>\n<p>libuv<code>poll</code></p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"Node-js-setTimeout\"><a href=\"#Node-js-setTimeout\" class=\"headerlink\" title=\"Node.js setTimeout\"></a>Node.js setTimeout</h2><p><strong><code>handle-&gt;timer_cb</code>JavaScriptsetTimeout</strong></p>\n<p>Node.js<code>setTimemout</code></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">setTimeout</span>(<span class=\"hljs-params\">callback, after, arg1, arg2, arg3</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> args = [arg1, arg2, arg3]; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> timeout = <span class=\"hljs-keyword\">new</span> Timeout(callback, after, args, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">  active(timeout);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> timeout;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">Timeout</span>(<span class=\"hljs-params\">callback, after, args, isRepeat</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  after *= <span class=\"hljs-number\">1</span>; </span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!(after &gt;= <span class=\"hljs-number\">1</span> &amp;&amp; after &lt;= TIMEOUT_MAX)) &#123;</span><br><span class=\"line\">    after = <span class=\"hljs-number\">1</span>; <span class=\"hljs-comment\">//  1 </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>._idleTimeout = after;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>._onTimeout = callback;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">this</span>._timerArgs = args;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">active</span>(<span class=\"hljs-params\">item</span>) </span>&#123;</span><br><span class=\"line\">  insert(item, <span class=\"hljs-literal\">true</span>, getLibuvNow());  <span class=\"hljs-comment\">// getLibuvNow  loop-&gt;time</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">insert</span>(<span class=\"hljs-params\">item, refed, start</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> msecs = item._idleTimeout;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (msecs &lt; <span class=\"hljs-number\">0</span> || msecs === <span class=\"hljs-literal\">undefined</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Truncate so that accuracy of sub-millisecond timers is not assumed.</span></span><br><span class=\"line\">  msecs = <span class=\"hljs-built_in\">Math</span>.trunc(msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">  item._idleStart = start;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Use an existing list if there is one, otherwise we need to make a new one.</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// timerListMap key value TimersList</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> list = timerListMap[msecs];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (list === <span class=\"hljs-literal\">undefined</span>) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> expiry = start + msecs; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    timerListMap[msecs] = list = <span class=\"hljs-keyword\">new</span> TimersList(expiry, msecs); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    timerListQueue.insert(list); <span class=\"hljs-comment\">// timerListQueue </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (nextExpiry &gt; expiry) &#123;</span><br><span class=\"line\">      scheduleTimer(msecs); <span class=\"hljs-comment\">//  V8 scheduleTimer</span></span><br><span class=\"line\">      nextExpiry = expiry;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... </span></span><br><span class=\"line\">  L.append(list, item); <span class=\"hljs-comment\">// setTimeoutTimeoutlist</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>JavaScripttimerssetTimeoutV8V8<code>scheduleTimer(msecs);</code>V8</p>\n<figure class=\"highlight c hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">ScheduleTimer</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">auto</span> env = Environment::GetCurrent(args);</span><br><span class=\"line\">  env-&gt;ScheduleTimer(args[<span class=\"hljs-number\">0</span>]-&gt;IntegerValue(env-&gt;context()).FromJust());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// env.cc</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">void</span> Environment::ScheduleTimer(<span class=\"hljs-keyword\">int64_t</span> duration_ms) &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (started_cleanup_) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  uv_timer_start(timer_handle(), RunTimers, duration_ms, <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-keyword\">void</span> Environment::RunTimers(<span class=\"hljs-keyword\">uv_timer_t</span>* handle) &#123;</span><br><span class=\"line\">  Environment* env = Environment::from_timer_handle(handle);</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"hljs-comment\">// timers_callback_function </span></span><br><span class=\"line\">  Local&lt;Function&gt; cb = env-&gt;timers_callback_function();</span><br><span class=\"line\">  <span class=\"hljs-keyword\">do</span> &#123;</span><br><span class=\"line\">    ret = cb-&gt;Call(env-&gt;context(), process, <span class=\"hljs-number\">1</span>, &amp;arg);</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">while</span> (ret.IsEmpty() &amp;&amp; env-&gt;can_call_into_js());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// uv/timer.c</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">uv_timer_start</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">uv_timer_t</span>* handle,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                   uv_timer_cb cb,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                   <span class=\"hljs-keyword\">uint64_t</span> timeout,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                   <span class=\"hljs-keyword\">uint64_t</span> repeat)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// uv_timer_t</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// JavaScriptC++RunTimers</span></span><br><span class=\"line\">  handle-&gt;timer_cb = cb;</span><br><span class=\"line\">  handle-&gt;timeout = clamped_timeout;</span><br><span class=\"line\">  handle-&gt;repeat = repeat;</span><br><span class=\"line\">  handle-&gt;start_id = handle-&gt;loop-&gt;timer_counter++;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// uv_timer_ttimer_heap</span></span><br><span class=\"line\">  heap_insert(timer_heap(handle-&gt;loop),</span><br><span class=\"line\">              (struct heap_node*) &amp;handle-&gt;heap_node,</span><br><span class=\"line\">              timer_less_than);</span><br><span class=\"line\">  uv__handle_start(handle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>V8timersC++</strong><code>timers_callback_function</code></p>\n<figure class=\"highlight c++ hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">SetupTimers</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class=\"line\">  CHECK(args[<span class=\"hljs-number\">0</span>]-&gt;IsFunction());</span><br><span class=\"line\">  CHECK(args[<span class=\"hljs-number\">1</span>]-&gt;IsFunction());</span><br><span class=\"line\">  <span class=\"hljs-keyword\">auto</span> env = Environment::GetCurrent(args);</span><br><span class=\"line\"></span><br><span class=\"line\">  env-&gt;set_immediate_callback_function(args[<span class=\"hljs-number\">0</span>].As&lt;Function&gt;()); <span class=\"hljs-comment\">// immediate</span></span><br><span class=\"line\">  env-&gt;set_timers_callback_function(args[<span class=\"hljs-number\">1</span>].As&lt;Function&gt;()); <span class=\"hljs-comment\">// timers</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// node.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123;</span><br><span class=\"line\">  setupTaskQueue,</span><br><span class=\"line\">  queueMicrotask</span><br><span class=\"line\">&#125; = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'internal/process/task_queues'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123; nextTick, runNextTicks &#125; = setupTaskQueue();</span><br><span class=\"line\">process.nextTick = nextTick;</span><br><span class=\"line\">process._tickCallback = runNextTicks;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123; getTimerCallbacks &#125; = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'internal/timers'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123; setupTimers &#125; = internalBinding(<span class=\"hljs-string\">'timers'</span>); <span class=\"hljs-comment\">// c++ SetupTimers JavaScript</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> &#123; processImmediate, processTimers &#125; = getTimerCallbacks(runNextTicks);</span><br><span class=\"line\">setupTimers(processImmediate, processTimers);</span><br></pre></td></tr></table></figure>\n<p><code>node.js</code><code>processImmediate</code><code>processTimers</code>JavaScriptC++<code>timers_callback_function</code><code>processTimers</code></p>\n<p><code></code><code>getTimerCallbacks</code></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getTimerCallbacks</span>(<span class=\"hljs-params\">runNextTicks</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">processImmediate</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">processTimers</span>(<span class=\"hljs-params\">now</span>) </span>&#123;</span><br><span class=\"line\">    nextExpiry = <span class=\"hljs-literal\">Infinity</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> list;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> ranAtLeastOneList = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">while</span> (list = timerListQueue.peek()) &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (list.expiry &gt; now) &#123; <span class=\"hljs-comment\">// now(libuv loop-&gt;time), </span></span><br><span class=\"line\">        nextExpiry = list.expiry; <span class=\"hljs-comment\">// nextExpiry  </span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> refCount &gt; <span class=\"hljs-number\">0</span> ? nextExpiry : -nextExpiry;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (ranAtLeastOneList)</span><br><span class=\"line\">        runNextTicks(); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneList = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">      listOnTimeout(list, now);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">listOnTimeout</span>(<span class=\"hljs-params\">list, now</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> msecs = list.msecs;</span><br><span class=\"line\"></span><br><span class=\"line\">    debug(<span class=\"hljs-string\">'timeout callback %d'</span>, msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> diff, timer;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> ranAtLeastOneTimer = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">while</span> (timer = L.peek(list)) &#123; <span class=\"hljs-comment\">// list</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// _idleStart libuv (loop-&gt;time)</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// now libuv callback</span></span><br><span class=\"line\">      diff = now - timer._idleStart; </span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// Check if this loop iteration is too early for the next timer.</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// This happens if there are more timers scheduled for later in the list.</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (diff &lt; msecs) &#123;</span><br><span class=\"line\">        list.expiry = <span class=\"hljs-built_in\">Math</span>.max(timer._idleStart + msecs, now + <span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">        list.id = timerListId++;</span><br><span class=\"line\">        timerListQueue.percolateDown(<span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">        debug(<span class=\"hljs-string\">'%d list wait because diff is %d'</span>, msecs, diff);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (ranAtLeastOneTimer)</span><br><span class=\"line\">        runNextTicks(); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneTimer = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// The actual logic for when a timeout happens.</span></span><br><span class=\"line\">      L.remove(timer);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> asyncId = timer[async_id_symbol];</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (!timer._onTimeout) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> args = timer._timerArgs;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (args === <span class=\"hljs-literal\">undefined</span>)</span><br><span class=\"line\">          timer._onTimeout(); <span class=\"hljs-comment\">// _onTimeout setTimeout </span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">          timer._onTimeout(...args);</span><br><span class=\"line\">      &#125; <span class=\"hljs-keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (list === timerListMap[msecs]) &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">delete</span> timerListMap[msecs];</span><br><span class=\"line\">      timerListQueue.shift();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> &#123;</span><br><span class=\"line\">    processImmediate,</span><br><span class=\"line\">    processTimers</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>libuv</code><code>runNextTicks</code><strong>setTimeoutcallback<code></code>timerNode.js 11</strong></p>\n<blockquote>\n<p>Timers<br>Interval timers will be rescheduled even if previous interval threw an error. #20002<br><strong>nextTick queue will be run after each immediate and timer. <a href=\"https://github.com/nodejs/node/pull/22842\" target=\"_blank\" rel=\"noopener\">#22842</a></strong></p>\n</blockquote>\n<p>11</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'time1'</span>);</span><br><span class=\"line\">  <span class=\"hljs-built_in\">Promise</span>.resolve().then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'promise1'</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'time2'</span>);</span><br><span class=\"line\">  <span class=\"hljs-built_in\">Promise</span>.resolve().then(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'promise2'</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* 11</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* 11</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>libuvNode.js EventLoop<code></code><code>setTimeout</code> <code>nextTick</code></p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<p><a href=\"https://libuv.org/\" target=\"_blank\" rel=\"noopener\">libuv</a>EventLoop</p>\n<ul>\n<li><code>libuv</code><code>V8</code></li>\n<li>JavaScriptC/C++</li>\n</ul>\n<p></p>\n<p><strong></strong></p>\n<figure class=\"highlight c++ hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// libuv</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// V8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// Node.js</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n<p>20102020</p>","more":"<p><br></p>\n<p><br></p>\n<h3 id=\"libuv-amp-EventLoop\"><a href=\"#libuv-amp-EventLoop\" class=\"headerlink\" title=\"libuv &amp; EventLoop\"></a>libuv &amp; EventLoop</h3><p><img src=\"/images/v8-libuv-timer-event-loop/loop_iteration.png\" alt=\"_images/loop_iteration.png\"></p>\n<p><code>libuv</code><a href=\"http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop\" target=\"_blank\" rel=\"noopener\">The I/O loop</a></p>\n<p><img src=\"/images/v8-libuv-timer-event-loop/image-20200301145547994.png\" alt=\"image-20200301145547994\"></p>\n<p><a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained\" target=\"_blank\" rel=\"noopener\">Event Loop Explained</a><code>pending callbacks</code><code>I/O callbacks</code></p>\n<blockquote>\n<p>Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point.  libuv</p>\n</blockquote>\n<p><strong>libuv</strong><code>pending callbacks</code>I/O callbackspollingpending callbacks</p>\n<p><br></p>\n<blockquote>\n<p>This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives <code>ECONNREFUSED</code> when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the <strong>pending callbacks</strong> phase.  Node.js</p>\n</blockquote>\n<p><strong>Node.js</strong><code>pending callbacks</code>callbacksTCP</p>\n<p><code>pending callbacks</code>libuvI/ONode.jsI/OI/O <code>poll</code></p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"libuv\"><a href=\"#libuv\" class=\"headerlink\" title=\"libuv\"></a>libuv</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">uv_run</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop, uv_run_mode mode)</span> </span>&#123; <span class=\"comment\">//  mode  UV_RUN_DEFAULT</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> timeout;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> r;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> ran_pending;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// alive</span></span><br><span class=\"line\">  r = uv__loop_alive(loop);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!r)</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"comment\">// libuv</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (r != <span class=\"number\">0</span> &amp;&amp; loop-&gt;stop_flag == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"comment\">// libuv Update loop time</span></span><br><span class=\"line\">    uv__run_timers(loop); <span class=\"comment\">//  timers </span></span><br><span class=\"line\">    ran_pending = uv__run_pending(loop); <span class=\"comment\">// pending 01</span></span><br><span class=\"line\">    uv__run_idle(loop); <span class=\"comment\">// idle  Node.js</span></span><br><span class=\"line\">    uv__run_prepare(loop); <span class=\"comment\">// prepare  Node.js</span></span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = <span class=\"number\">0</span>; <span class=\"comment\">//  poll </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((mode == UV_RUN_ONCE &amp;&amp; !ran_pending) || mode == UV_RUN_DEFAULT)</span><br><span class=\"line\">      timeout = uv_backend_timeout(loop); <span class=\"comment\">//  poll </span></span><br><span class=\"line\">    <span class=\"comment\">// timers diff = loop.time - min.timeout</span></span><br><span class=\"line\">    <span class=\"comment\">//  diff &gt;= 0 , timeout = 0</span></span><br><span class=\"line\">    <span class=\"comment\">//  timeout = min(diff, INT_MAX)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    uv__io_poll(loop, timeout); <span class=\"comment\">//  poll </span></span><br><span class=\"line\">    uv__run_check(loop); <span class=\"comment\">//  check </span></span><br><span class=\"line\">    uv__run_closing_handles(loop); <span class=\"comment\">//  close </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// mode  UV_RUN_DEFAULT </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mode == UV_RUN_ONCE) &#123;</span><br><span class=\"line\">      uv__update_time(loop);</span><br><span class=\"line\">      uv__run_timers(loop);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// alive</span></span><br><span class=\"line\">    r = uv__loop_alive(loop);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* The if statement lets gcc compile it to a conditional store. Avoids</span></span><br><span class=\"line\"><span class=\"comment\">   * dirtying a cache line.</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loop-&gt;stop_flag != <span class=\"number\">0</span>)</span><br><span class=\"line\">    loop-&gt;stop_flag = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>uv_run</code></p>\n<p><br></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">uv__run_timers</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">heap_node</span>* <span class=\"title\">heap_node</span>;</span> <span class=\"comment\">// timers </span></span><br><span class=\"line\">  <span class=\"keyword\">uv_timer_t</span>* handle;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    heap_node = heap_min(timer_heap(loop)); <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (heap_node == <span class=\"literal\">NULL</span>) <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    handle = container_of(heap_node, <span class=\"keyword\">uv_timer_t</span>, heap_node); </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (handle-&gt;timeout &gt; loop-&gt;time) <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    uv_timer_stop(handle);</span><br><span class=\"line\">    uv_timer_again(handle);</span><br><span class=\"line\">    </span><br><span class=\"line\">    handle-&gt;timer_cb(handle); <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>timers<code>loop-&gt;time</code><strong><code>handle-&gt;timer_cb</code>JavaScriptsetTimeout</strong></p>\n<p><br></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">uv__run_pending</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  QUEUE* q;</span><br><span class=\"line\">  QUEUE pq;</span><br><span class=\"line\">  <span class=\"keyword\">uv__io_t</span>* w;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (QUEUE_EMPTY(&amp;loop-&gt;pending_queue))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  QUEUE_MOVE(&amp;loop-&gt;pending_queue, &amp;pq);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (!QUEUE_EMPTY(&amp;pq)) &#123; <span class=\"comment\">// </span></span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;pq);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"keyword\">uv__io_t</span>, pending_queue);</span><br><span class=\"line\">    w-&gt;cb(loop, w, POLLOUT); <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>libuv</p>\n<p><br></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> UV_LOOP_WATCHER_DEFINE(name, type)                                    \\</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span> uv__run_#<span class=\"meta\">#name(uv_loop_t* loop) &#123;                                      \\</span></span><br><span class=\"line\">    uv_#<span class=\"meta\">#name##_t* h;                                                         \\</span></span><br><span class=\"line\">    QUEUE <span class=\"built_in\">queue</span>;                                                              \\</span><br><span class=\"line\">    QUEUE* q;                                                                 \\</span><br><span class=\"line\">    QUEUE_MOVE(&amp;loop-&gt;name##_handles, &amp;<span class=\"built_in\">queue</span>);                                \\</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (!QUEUE_EMPTY(&amp;<span class=\"built_in\">queue</span>)) &#123;                                            \\</span><br><span class=\"line\">      q = QUEUE_HEAD(&amp;<span class=\"built_in\">queue</span>);                                                 \\</span><br><span class=\"line\">      h = QUEUE_DATA(q, uv_##name##<span class=\"keyword\">_t</span>, <span class=\"built_in\">queue</span>);                                \\</span><br><span class=\"line\">      QUEUE_REMOVE(q);                                                        \\</span><br><span class=\"line\">      QUEUE_INSERT_TAIL(&amp;loop-&gt;name##_handles, q);                            \\</span><br><span class=\"line\">      h-&gt;name##_cb(h);                                                        \\</span><br><span class=\"line\">    &#125;                                                                         \\</span><br><span class=\"line\">  &#125;     </span><br><span class=\"line\"></span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(prepare, PREPARE)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(check, CHECK)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(idle, IDLE)</span><br></pre></td></tr></table></figure>\n<p><code>UV_LOOP_WATCHER_DEFINE</code><code>prepare</code><code>check</code><code>idle</code>3</p>\n<p><br></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// uv__io_poll </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">uv__io_poll</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop, <span class=\"keyword\">int</span> timeout)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loop-&gt;nfds == <span class=\"number\">0</span>) &#123; <span class=\"comment\">//  </span></span><br><span class=\"line\">    assert(QUEUE_EMPTY(&amp;loop-&gt;watcher_queue));</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// loop-&gt;watcher_queueepoll</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (!QUEUE_EMPTY(&amp;loop-&gt;watcher_queue)) &#123;</span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;loop-&gt;watcher_queue);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\"></span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"keyword\">uv__io_t</span>, watcher_queue);</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (w-&gt;events == <span class=\"number\">0</span>)</span><br><span class=\"line\">      op = EPOLL_CTL_ADD; <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      op = EPOLL_CTL_MOD; <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_ctl(loop-&gt;backend_fd, op, w-&gt;fd, &amp;e) <span class=\"comment\">// epoll_ctl </span></span><br><span class=\"line\"></span><br><span class=\"line\">    w-&gt;events = w-&gt;pevents;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  sigmask = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loop-&gt;flags &amp; UV_LOOP_BLOCK_SIGPROF) &#123;</span><br><span class=\"line\">    sigemptyset(&amp;sigset);</span><br><span class=\"line\">    sigaddset(&amp;sigset, SIGPROF);</span><br><span class=\"line\">    sigmask |= <span class=\"number\">1</span> &lt;&lt; (SIGPROF - <span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  base = loop-&gt;time;</span><br><span class=\"line\">  real_timeout = timeout;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    nfds = epoll_wait(loop-&gt;backend_fd,</span><br><span class=\"line\">                        events,</span><br><span class=\"line\">                        ARRAY_SIZE(events),</span><br><span class=\"line\">                        timeout);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nfds == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// </span></span><br><span class=\"line\">      assert(timeout != <span class=\"number\">-1</span>); <span class=\"comment\">// -1 nfds0</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (timeout == <span class=\"number\">0</span>) <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"keyword\">goto</span> update_timeout; <span class=\"comment\">//   epoll_wait </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nfds == <span class=\"number\">-1</span>) &#123; <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (errno == ENOSYS) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/* epoll_wait() or epoll_pwait() failed, try the other system call. */</span></span><br><span class=\"line\">        assert(no_epoll_wait == <span class=\"number\">0</span> || no_epoll_pwait == <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (errno != EINTR)</span><br><span class=\"line\">        <span class=\"built_in\">abort</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (timeout == <span class=\"number\">-1</span>)</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (timeout == <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> update_timeout;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    have_signals = <span class=\"number\">0</span>;</span><br><span class=\"line\">    nevents = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers] = (<span class=\"keyword\">void</span>*) events;</span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers + <span class=\"number\">1</span>] = (<span class=\"keyword\">void</span>*) (<span class=\"keyword\">uintptr_t</span>) nfds;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; nfds; i++) &#123;</span><br><span class=\"line\">      pe = events + i;</span><br><span class=\"line\">      fd = pe-&gt;data.fd;</span><br><span class=\"line\">      w = loop-&gt;watchers[fd];</span><br><span class=\"line\">      w-&gt;cb(loop, w, pe-&gt;events); <span class=\"comment\">// forIO</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout == <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout == <span class=\"number\">-1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">update_timeout:</span><br><span class=\"line\">    assert(timeout &gt; <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    real_timeout -= (loop-&gt;time - base);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (real_timeout &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = real_timeout;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>uv__io_poll</code>timeout<code>timers</code><code>epoll</code>IO<code>select</code><code>poll</code><code>epoll</code></p>\n<blockquote>\n<p>epoll<a href=\"https://baike.baidu.com/item/Linux\" target=\"_blank\" rel=\"noopener\">Linux</a><a href=\"https://baike.baidu.com/item//9809582\" target=\"_blank\" rel=\"noopener\"></a>pollLinuxIOselect/poll<a href=\"https://baike.baidu.com/item//3763280\" target=\"_blank\" rel=\"noopener\"></a><a href=\"https://baike.baidu.com/item/CPU/120556\" target=\"_blank\" rel=\"noopener\">CPU</a>IOReadyepollselect/pollIOLevel TriggeredEdge TriggeredIOepoll_wait/epoll_pwait </p>\n</blockquote>\n<p>libuvepoll</p>\n<ul>\n<li>epollselect/poll</li>\n<li>epollselect/pollselect/pollNode.jslibuv</li>\n</ul>\n<p><br></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">uv__run_closing_handles</span><span class=\"params\">(<span class=\"keyword\">uv_loop_t</span>* loop)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">uv_handle_t</span>* p;</span><br><span class=\"line\">  <span class=\"keyword\">uv_handle_t</span>* q;</span><br><span class=\"line\"></span><br><span class=\"line\">  p = loop-&gt;closing_handles;</span><br><span class=\"line\">  loop-&gt;closing_handles = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (p) &#123;</span><br><span class=\"line\">    q = p-&gt;next_closing;</span><br><span class=\"line\">    uv__finish_close(p);</span><br><span class=\"line\">    p = q;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>close</code></p>\n<p><br></p>\n<p>libuv<code>poll</code></p>\n<p><br></p>\n<p><br></p>\n<h2 id=\"Node-js-setTimeout\"><a href=\"#Node-js-setTimeout\" class=\"headerlink\" title=\"Node.js setTimeout\"></a>Node.js setTimeout</h2><p><strong><code>handle-&gt;timer_cb</code>JavaScriptsetTimeout</strong></p>\n<p>Node.js<code>setTimemout</code></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setTimeout</span>(<span class=\"params\">callback, after, arg1, arg2, arg3</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> args = [arg1, arg2, arg3]; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> timeout = <span class=\"keyword\">new</span> Timeout(callback, after, args, <span class=\"literal\">false</span>);</span><br><span class=\"line\">  active(timeout);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> timeout;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Timeout</span>(<span class=\"params\">callback, after, args, isRepeat</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  after *= <span class=\"number\">1</span>; </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!(after &gt;= <span class=\"number\">1</span> &amp;&amp; after &lt;= TIMEOUT_MAX)) &#123;</span><br><span class=\"line\">    after = <span class=\"number\">1</span>; <span class=\"comment\">//  1 </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._idleTimeout = after;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._onTimeout = callback;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._timerArgs = args;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">active</span>(<span class=\"params\">item</span>) </span>&#123;</span><br><span class=\"line\">  insert(item, <span class=\"literal\">true</span>, getLibuvNow());  <span class=\"comment\">// getLibuvNow  loop-&gt;time</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">insert</span>(<span class=\"params\">item, refed, start</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> msecs = item._idleTimeout;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (msecs &lt; <span class=\"number\">0</span> || msecs === <span class=\"literal\">undefined</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Truncate so that accuracy of sub-millisecond timers is not assumed.</span></span><br><span class=\"line\">  msecs = <span class=\"built_in\">Math</span>.trunc(msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">  item._idleStart = start;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Use an existing list if there is one, otherwise we need to make a new one.</span></span><br><span class=\"line\">  <span class=\"comment\">// timerListMap key value TimersList</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> list = timerListMap[msecs];</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (list === <span class=\"literal\">undefined</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> expiry = start + msecs; <span class=\"comment\">// </span></span><br><span class=\"line\">    timerListMap[msecs] = list = <span class=\"keyword\">new</span> TimersList(expiry, msecs); <span class=\"comment\">// </span></span><br><span class=\"line\">    timerListQueue.insert(list); <span class=\"comment\">// timerListQueue </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nextExpiry &gt; expiry) &#123;</span><br><span class=\"line\">      scheduleTimer(msecs); <span class=\"comment\">//  V8 scheduleTimer</span></span><br><span class=\"line\">      nextExpiry = expiry;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ... </span></span><br><span class=\"line\">  L.append(list, item); <span class=\"comment\">// setTimeoutTimeoutlist</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>JavaScripttimerssetTimeoutV8V8<code>scheduleTimer(msecs);</code>V8</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">ScheduleTimer</span><span class=\"params\">(<span class=\"keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">auto</span> env = Environment::GetCurrent(args);</span><br><span class=\"line\">  env-&gt;ScheduleTimer(args[<span class=\"number\">0</span>]-&gt;IntegerValue(env-&gt;context()).FromJust());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// env.cc</span></span><br><span class=\"line\"><span class=\"keyword\">void</span> Environment::ScheduleTimer(<span class=\"keyword\">int64_t</span> duration_ms) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (started_cleanup_) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  uv_timer_start(timer_handle(), RunTimers, duration_ms, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">void</span> Environment::RunTimers(<span class=\"keyword\">uv_timer_t</span>* handle) &#123;</span><br><span class=\"line\">  Environment* env = Environment::from_timer_handle(handle);</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// timers_callback_function </span></span><br><span class=\"line\">  Local&lt;Function&gt; cb = env-&gt;timers_callback_function();</span><br><span class=\"line\">  <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">    ret = cb-&gt;Call(env-&gt;context(), process, <span class=\"number\">1</span>, &amp;arg);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">while</span> (ret.IsEmpty() &amp;&amp; env-&gt;can_call_into_js());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// uv/timer.c</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">uv_timer_start</span><span class=\"params\">(<span class=\"keyword\">uv_timer_t</span>* handle,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                   uv_timer_cb cb,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                   <span class=\"keyword\">uint64_t</span> timeout,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                   <span class=\"keyword\">uint64_t</span> repeat)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// uv_timer_t</span></span><br><span class=\"line\">  <span class=\"comment\">// JavaScriptC++RunTimers</span></span><br><span class=\"line\">  handle-&gt;timer_cb = cb;</span><br><span class=\"line\">  handle-&gt;timeout = clamped_timeout;</span><br><span class=\"line\">  handle-&gt;repeat = repeat;</span><br><span class=\"line\">  handle-&gt;start_id = handle-&gt;loop-&gt;timer_counter++;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// uv_timer_ttimer_heap</span></span><br><span class=\"line\">  heap_insert(timer_heap(handle-&gt;loop),</span><br><span class=\"line\">              (struct heap_node*) &amp;handle-&gt;heap_node,</span><br><span class=\"line\">              timer_less_than);</span><br><span class=\"line\">  uv__handle_start(handle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>V8timersC++</strong><code>timers_callback_function</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">SetupTimers</span><span class=\"params\">(<span class=\"keyword\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class=\"line\">  CHECK(args[<span class=\"number\">0</span>]-&gt;IsFunction());</span><br><span class=\"line\">  CHECK(args[<span class=\"number\">1</span>]-&gt;IsFunction());</span><br><span class=\"line\">  <span class=\"keyword\">auto</span> env = Environment::GetCurrent(args);</span><br><span class=\"line\"></span><br><span class=\"line\">  env-&gt;set_immediate_callback_function(args[<span class=\"number\">0</span>].As&lt;Function&gt;()); <span class=\"comment\">// immediate</span></span><br><span class=\"line\">  env-&gt;set_timers_callback_function(args[<span class=\"number\">1</span>].As&lt;Function&gt;()); <span class=\"comment\">// timers</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// node.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123;</span><br><span class=\"line\">  setupTaskQueue,</span><br><span class=\"line\">  queueMicrotask</span><br><span class=\"line\">&#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'internal/process/task_queues'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; nextTick, runNextTicks &#125; = setupTaskQueue();</span><br><span class=\"line\">process.nextTick = nextTick;</span><br><span class=\"line\">process._tickCallback = runNextTicks;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; getTimerCallbacks &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'internal/timers'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; setupTimers &#125; = internalBinding(<span class=\"string\">'timers'</span>); <span class=\"comment\">// c++ SetupTimers JavaScript</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; processImmediate, processTimers &#125; = getTimerCallbacks(runNextTicks);</span><br><span class=\"line\">setupTimers(processImmediate, processTimers);</span><br></pre></td></tr></table></figure>\n<p><code>node.js</code><code>processImmediate</code><code>processTimers</code>JavaScriptC++<code>timers_callback_function</code><code>processTimers</code></p>\n<p><code></code><code>getTimerCallbacks</code></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getTimerCallbacks</span>(<span class=\"params\">runNextTicks</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">processImmediate</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">processTimers</span>(<span class=\"params\">now</span>) </span>&#123;</span><br><span class=\"line\">    nextExpiry = <span class=\"literal\">Infinity</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">let</span> list;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> ranAtLeastOneList = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (list = timerListQueue.peek()) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (list.expiry &gt; now) &#123; <span class=\"comment\">// now(libuv loop-&gt;time), </span></span><br><span class=\"line\">        nextExpiry = list.expiry; <span class=\"comment\">// nextExpiry  </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> refCount &gt; <span class=\"number\">0</span> ? nextExpiry : -nextExpiry;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (ranAtLeastOneList)</span><br><span class=\"line\">        runNextTicks(); <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneList = <span class=\"literal\">true</span>;</span><br><span class=\"line\">      listOnTimeout(list, now);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">listOnTimeout</span>(<span class=\"params\">list, now</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> msecs = list.msecs;</span><br><span class=\"line\"></span><br><span class=\"line\">    debug(<span class=\"string\">'timeout callback %d'</span>, msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> diff, timer;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> ranAtLeastOneTimer = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (timer = L.peek(list)) &#123; <span class=\"comment\">// list</span></span><br><span class=\"line\">      <span class=\"comment\">// _idleStart libuv (loop-&gt;time)</span></span><br><span class=\"line\">      <span class=\"comment\">// now libuv callback</span></span><br><span class=\"line\">      diff = now - timer._idleStart; </span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Check if this loop iteration is too early for the next timer.</span></span><br><span class=\"line\">      <span class=\"comment\">// This happens if there are more timers scheduled for later in the list.</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (diff &lt; msecs) &#123;</span><br><span class=\"line\">        list.expiry = <span class=\"built_in\">Math</span>.max(timer._idleStart + msecs, now + <span class=\"number\">1</span>);</span><br><span class=\"line\">        list.id = timerListId++;</span><br><span class=\"line\">        timerListQueue.percolateDown(<span class=\"number\">1</span>);</span><br><span class=\"line\">        debug(<span class=\"string\">'%d list wait because diff is %d'</span>, msecs, diff);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (ranAtLeastOneTimer)</span><br><span class=\"line\">        runNextTicks(); <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneTimer = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// The actual logic for when a timeout happens.</span></span><br><span class=\"line\">      L.remove(timer);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> asyncId = timer[async_id_symbol];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!timer._onTimeout) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> args = timer._timerArgs;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (args === <span class=\"literal\">undefined</span>)</span><br><span class=\"line\">          timer._onTimeout(); <span class=\"comment\">// _onTimeout setTimeout </span></span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          timer._onTimeout(...args);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (list === timerListMap[msecs]) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">delete</span> timerListMap[msecs];</span><br><span class=\"line\">      timerListQueue.shift();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">    processImmediate,</span><br><span class=\"line\">    processTimers</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>libuv</code><code>runNextTicks</code><strong>setTimeoutcallback<code></code>timerNode.js 11</strong></p>\n<blockquote>\n<p>Timers<br>Interval timers will be rescheduled even if previous interval threw an error. #20002<br><strong>nextTick queue will be run after each immediate and timer. <a href=\"https://github.com/nodejs/node/pull/22842\" target=\"_blank\" rel=\"noopener\">#22842</a></strong></p>\n</blockquote>\n<p>11</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'time1'</span>);</span><br><span class=\"line\">  <span class=\"built_in\">Promise</span>.resolve().then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'promise1'</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'time2'</span>);</span><br><span class=\"line\">  <span class=\"built_in\">Promise</span>.resolve().then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'promise2'</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* 11</span></span><br><span class=\"line\"><span class=\"comment\">time1</span></span><br><span class=\"line\"><span class=\"comment\">promise1</span></span><br><span class=\"line\"><span class=\"comment\">time2</span></span><br><span class=\"line\"><span class=\"comment\">promise2</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* 11</span></span><br><span class=\"line\"><span class=\"comment\">time1</span></span><br><span class=\"line\"><span class=\"comment\">time2</span></span><br><span class=\"line\"><span class=\"comment\">promise1</span></span><br><span class=\"line\"><span class=\"comment\">promise2</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>libuvNode.js EventLoop<code></code><code>setTimeout</code> <code>nextTick</code></p>"},{"title":"V8JavaScript","keywords":"V8,Node.js,","description":"ParerCompiler2V8JavaScript","date":"2020-02-08T01:18:53.485Z","_content":"\n> ``172020****\n\n\n\n**Parer****Compiler**2V8JavaScript\n\n![Parser15-20%](/images/v8-parser-compiler/v8-pare-compile-cost.png)\n\n<!-- more -->\n\n\n\n# **Parser**\n\n![Parser](/images/v8-parser-compiler/parser-phase.png)\n\n** `1 MB / s`**\n\n<br/>\n\n#### **V8Parser2**\n\n`LayzePre-Parsing`\n\n- \n- `AST``Scopes`\n- Eage2\n- JavaScript\n\n`EageFull-Parsing`\n\n- \n- `AST`\n- `Scopes`\n- \n\n<br/>\n\n#### Q:2\n\nFull-ParsingDevTools`coverage`\n\n<br/>\n\n#### Q:2\n\nPre-ParsingFull-Parser: `0.5 * parse + 1 * parse = 1.5 parse` \n\n<br/>\n\n#### Q: `Pre-Parsing`  `Full-Parsing` \n\n```javascript\nlet a = 0; // Top-Level  Full-Parsing\n\n//  IIFE = Immediately Invoked Function Expression\n(function eager() {...})(); //  Full-Parsing\n                   \n// IIFE\nfunction lazy() {...} //  Pre-Parsing\n\nlazy(); // -> Full-Parsing \n                 \n// Full-Parsing\n!function eager2() {...}, function eager3() {...} // All eager\n \nlet f1 = function lazy() { ... }; //  Pre-Parsing\n              \nlet f2 = function lazy() {...}(); // lazy , eager\n```\n\n<br/>\n\n#### Q:Full-Parsing eager \n\n- lazy 2 lazy  eager '!|~'\n-  [optimize-js](https://github.com/nolanlawson/optimize-js) Github\n\n<br/>\n\n#### Q:\n\n```javascript\nfunction lazy_outer() { // lazy parse this\n  function inner() {\n    function inner2() {\n      // ...\n    }\n  }\n}\n\nlazy_outer(); // lazy parsing inner & inner2\ninner(); // lazy parsing inner & inner2 (3rd time!)\n```\n\n`Pre-Parsing`\n\n<br/>\n\n#### Q:Parser\n\n1. ****DevTools`coverage`\n2. V8Parser72bundlebundleParser\n\n<br/>\n\n#### Q:ParserCompiler\n\n1. `chrome://tracing/`[](http://aimianwu.com)\n\n2.tracing`Record`\n\n3.`Web developer`Edit categories`v8.runtime_stats`\n\n4.Tab http://aimianwu.com tracing Tab\n\n5.\"\"\n\n6.Process\n\n![](/images/v8-parser-compiler/parse-time.png)\n\n![](/images/v8-parser-compiler/parse-time-1.png)\n\n7.V8ParseCompile\n\n![](/images/v8-parser-compiler/parse-time-2.png)\n\n<br/>\n\n<br/>\n\n# **Compiler Pipeline**\n\nV8Compiler PipelineV8 5.9 Ignition + TurboFan 2010Full-codegen + Crankshaft Ignition + TurboFan Full-codegen + CrankshaftTurboFan[PPT](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389)\n\n<br/>\n\n#### Q:[](https://v8.dev/blog/launching-ignition-and-turbofan)\nJavaScript\n\n* JavaScriptV81/3Crankshaft\n* Crankshaft trycatchfinally  ESWebAssembly\nPC\n\n<br/>\n\n#### Q: V8 Compiler \n\nJavaScriptV8TurboFanIgnitionTurboFan`Optimize`DeoptimizeIgnition\n\n2[](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n* \n* JavaScript\n\n![](/images/v8-parser-compiler/not-change-types-1.png)\n\n![](/images/v8-parser-compiler/not-change-types-2.png)\n\n![](/images/v8-parser-compiler/not-change-types-3.png)\n\n> ObjectsV8De-optimisation\n\n```javascript\nfunction load(obj) {\n  return obj.x\n}\n\nvar obj = {\n  x: 1,\n  y: 4\n} \n```\n\n\n\n `obj = {}`  `obj = { x: \"Number\" }` `obj = { y: \"Number\" }` C++Java\n\n\n\n```javascript\nload({ x: 4, a: 7 });\nload({ x: 4, b: 9 });\nload({ x: 4, c: 3 });\nload({ x: 4, d: 1 });\n```\n\n\n\n```javascript\nload({ x: 4, a: 7, b: undefined, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: 9, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: 3, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: undefined, d: 1 });\n\n```\n\nTypeScript\n\n\n\n# \n\n`V8`[Script Streaming](https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html) https://v8.dev/ JavaScriptV8\n\nWebAssemblyNode.jsC++JavaScriptArduinoJavaScriptC/C++C/C++\n\n\n\n\n\n### \n\n[Parsing JavaScript - better lazy than eager](https://www.youtube.com/watch?v=Fg7niTmNNLg)\n\n[JavaScript engines - how do they even? ](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n[JavaScript Start-up Performance](https://medium.com/reloading/javascript-start-up-performance-69200f43b201)\n\n[V8: Hooking up the Ignition to the Turbofan](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103)","source":"_posts/v8-parser-compiler-javascript.md","raw":"---\ntitle: V8JavaScript\ncategory: JavaScript\nkeywords: V8,Node.js,\ndescription: ParerCompiler2V8JavaScript\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-02-08T09:18:53.485Z\n---\n\n> ``172020****\n\n\n\n**Parer****Compiler**2V8JavaScript\n\n![Parser15-20%](/images/v8-parser-compiler/v8-pare-compile-cost.png)\n\n<!-- more -->\n\n\n\n# **Parser**\n\n![Parser](/images/v8-parser-compiler/parser-phase.png)\n\n** `1 MB / s`**\n\n<br/>\n\n#### **V8Parser2**\n\n`LayzePre-Parsing`\n\n- \n- `AST``Scopes`\n- Eage2\n- JavaScript\n\n`EageFull-Parsing`\n\n- \n- `AST`\n- `Scopes`\n- \n\n<br/>\n\n#### Q:2\n\nFull-ParsingDevTools`coverage`\n\n<br/>\n\n#### Q:2\n\nPre-ParsingFull-Parser: `0.5 * parse + 1 * parse = 1.5 parse` \n\n<br/>\n\n#### Q: `Pre-Parsing`  `Full-Parsing` \n\n```javascript\nlet a = 0; // Top-Level  Full-Parsing\n\n//  IIFE = Immediately Invoked Function Expression\n(function eager() {...})(); //  Full-Parsing\n                   \n// IIFE\nfunction lazy() {...} //  Pre-Parsing\n\nlazy(); // -> Full-Parsing \n                 \n// Full-Parsing\n!function eager2() {...}, function eager3() {...} // All eager\n \nlet f1 = function lazy() { ... }; //  Pre-Parsing\n              \nlet f2 = function lazy() {...}(); // lazy , eager\n```\n\n<br/>\n\n#### Q:Full-Parsing eager \n\n- lazy 2 lazy  eager '!|~'\n-  [optimize-js](https://github.com/nolanlawson/optimize-js) Github\n\n<br/>\n\n#### Q:\n\n```javascript\nfunction lazy_outer() { // lazy parse this\n  function inner() {\n    function inner2() {\n      // ...\n    }\n  }\n}\n\nlazy_outer(); // lazy parsing inner & inner2\ninner(); // lazy parsing inner & inner2 (3rd time!)\n```\n\n`Pre-Parsing`\n\n<br/>\n\n#### Q:Parser\n\n1. ****DevTools`coverage`\n2. V8Parser72bundlebundleParser\n\n<br/>\n\n#### Q:ParserCompiler\n\n1. `chrome://tracing/`[](http://aimianwu.com)\n\n2.tracing`Record`\n\n3.`Web developer`Edit categories`v8.runtime_stats`\n\n4.Tab http://aimianwu.com tracing Tab\n\n5.\"\"\n\n6.Process\n\n![](/images/v8-parser-compiler/parse-time.png)\n\n![](/images/v8-parser-compiler/parse-time-1.png)\n\n7.V8ParseCompile\n\n![](/images/v8-parser-compiler/parse-time-2.png)\n\n<br/>\n\n<br/>\n\n# **Compiler Pipeline**\n\nV8Compiler PipelineV8 5.9 Ignition + TurboFan 2010Full-codegen + Crankshaft Ignition + TurboFan Full-codegen + CrankshaftTurboFan[PPT](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389)\n\n<br/>\n\n#### Q:[](https://v8.dev/blog/launching-ignition-and-turbofan)\nJavaScript\n\n* JavaScriptV81/3Crankshaft\n* Crankshaft trycatchfinally  ESWebAssembly\nPC\n\n<br/>\n\n#### Q: V8 Compiler \n\nJavaScriptV8TurboFanIgnitionTurboFan`Optimize`DeoptimizeIgnition\n\n2[](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n* \n* JavaScript\n\n![](/images/v8-parser-compiler/not-change-types-1.png)\n\n![](/images/v8-parser-compiler/not-change-types-2.png)\n\n![](/images/v8-parser-compiler/not-change-types-3.png)\n\n> ObjectsV8De-optimisation\n\n```javascript\nfunction load(obj) {\n  return obj.x\n}\n\nvar obj = {\n  x: 1,\n  y: 4\n} \n```\n\n\n\n `obj = {}`  `obj = { x: \"Number\" }` `obj = { y: \"Number\" }` C++Java\n\n\n\n```javascript\nload({ x: 4, a: 7 });\nload({ x: 4, b: 9 });\nload({ x: 4, c: 3 });\nload({ x: 4, d: 1 });\n```\n\n\n\n```javascript\nload({ x: 4, a: 7, b: undefined, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: 9, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: 3, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: undefined, d: 1 });\n\n```\n\nTypeScript\n\n\n\n# \n\n`V8`[Script Streaming](https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html) https://v8.dev/ JavaScriptV8\n\nWebAssemblyNode.jsC++JavaScriptArduinoJavaScriptC/C++C/C++\n\n\n\n\n\n### \n\n[Parsing JavaScript - better lazy than eager](https://www.youtube.com/watch?v=Fg7niTmNNLg)\n\n[JavaScript engines - how do they even? ](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n[JavaScript Start-up Performance](https://medium.com/reloading/javascript-start-up-performance-69200f43b201)\n\n[V8: Hooking up the Ignition to the Turbofan](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103)","slug":"v8-parser-compiler-javascript","published":1,"updated":"2020-07-07T10:11:25.591Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs6y001id12ibykhggc2","content":"<blockquote>\n<p><code></code>172020<strong></strong></p>\n</blockquote>\n<p><strong>Parer</strong><strong>Compiler</strong>2V8JavaScript</p>\n<p><img src=\"/images/v8-parser-compiler/v8-pare-compile-cost.png\" alt=\"Parser15-20%\"></p>\n<a id=\"more\"></a>\n<h1 id=\"Parser\"><a href=\"#Parser\" class=\"headerlink\" title=\"Parser\"></a><strong>Parser</strong></h1><p><img src=\"/images/v8-parser-compiler/parser-phase.png\" alt=\"Parser\"></p>\n<p><strong> <code>1 MB / s</code></strong></p>\n<p><br></p>\n<h4 id=\"V8Parser2\"><a href=\"#V8Parser2\" class=\"headerlink\" title=\"V8Parser2\"></a><strong>V8Parser2</strong></h4><p><code>LayzePre-Parsing</code></p>\n<ul>\n<li></li>\n<li><code>AST</code><code>Scopes</code></li>\n<li>Eage2</li>\n<li>JavaScript</li>\n</ul>\n<p><code>EageFull-Parsing</code></p>\n<ul>\n<li></li>\n<li><code>AST</code></li>\n<li><code>Scopes</code></li>\n<li></li>\n</ul>\n<p><br></p>\n<h4 id=\"Q-2\"><a href=\"#Q-2\" class=\"headerlink\" title=\"Q:2\"></a>Q:2</h4><p>Full-ParsingDevTools<code>coverage</code></p>\n<p><br></p>\n<h4 id=\"Q-2\"><a href=\"#Q-2\" class=\"headerlink\" title=\"Q:2\"></a>Q:2</h4><p>Pre-ParsingFull-Parser: <code>0.5 * parse + 1 * parse = 1.5 parse</code> </p>\n<p><br></p>\n<h4 id=\"Q--Pre-Parsing--Full-Parsing-\"><a href=\"#Q--Pre-Parsing--Full-Parsing-\" class=\"headerlink\" title=\"Q: Pre-Parsing  Full-Parsing \"></a>Q: <code>Pre-Parsing</code>  <code>Full-Parsing</code> </h4><figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">let</span> a = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// Top-Level  Full-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//  IIFE = Immediately Invoked Function Expression</span></span><br><span class=\"line\">(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">eager</span>(<span class=\"hljs-params\"></span>) </span>&#123;...&#125;)(); <span class=\"hljs-comment\">//  Full-Parsing</span></span><br><span class=\"line\">                   </span><br><span class=\"line\"><span class=\"hljs-comment\">// IIFE</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">lazy</span>(<span class=\"hljs-params\"></span>) </span>&#123;...&#125; <span class=\"hljs-comment\">//  Pre-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\">lazy(); <span class=\"hljs-comment\">// -&gt; Full-Parsing </span></span><br><span class=\"line\">                 </span><br><span class=\"line\"><span class=\"hljs-comment\">// Full-Parsing</span></span><br><span class=\"line\">!<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">eager2</span>(<span class=\"hljs-params\"></span>) </span>&#123;...&#125;, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">eager3</span>(<span class=\"hljs-params\"></span>) </span>&#123;...&#125; <span class=\"hljs-comment\">// All eager</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> f1 = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">lazy</span>(<span class=\"hljs-params\"></span>) </span>&#123; ... &#125;; <span class=\"hljs-comment\">//  Pre-Parsing</span></span><br><span class=\"line\">              </span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> f2 = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">lazy</span>(<span class=\"hljs-params\"></span>) </span>&#123;...&#125;(); <span class=\"hljs-comment\">// lazy , eager</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h4 id=\"Q-Full-Parsing-eager-\"><a href=\"#Q-Full-Parsing-eager-\" class=\"headerlink\" title=\"Q:Full-Parsing eager \"></a>Q:Full-Parsing eager </h4><ul>\n<li>lazy 2 lazy  eager !|~</li>\n<li> <a href=\"https://github.com/nolanlawson/optimize-js\" target=\"_blank\" rel=\"noopener\">optimize-js</a> Github</li>\n</ul>\n<p><br></p>\n<h4 id=\"Q-\"><a href=\"#Q-\" class=\"headerlink\" title=\"Q:\"></a>Q:</h4><figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">lazy_outer</span>(<span class=\"hljs-params\"></span>) </span>&#123; <span class=\"hljs-comment\">// lazy parse this</span></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">inner</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">inner2</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">lazy_outer(); <span class=\"hljs-comment\">// lazy parsing inner &amp; inner2</span></span><br><span class=\"line\">inner(); <span class=\"hljs-comment\">// lazy parsing inner &amp; inner2 (3rd time!)</span></span><br></pre></td></tr></table></figure>\n<p><code>Pre-Parsing</code></p>\n<p><br></p>\n<h4 id=\"Q-Parser\"><a href=\"#Q-Parser\" class=\"headerlink\" title=\"Q:Parser\"></a>Q:Parser</h4><ol>\n<li><strong></strong>DevTools<code>coverage</code></li>\n<li>V8Parser72bundlebundleParser</li>\n</ol>\n<p><br></p>\n<h4 id=\"Q-ParserCompiler\"><a href=\"#Q-ParserCompiler\" class=\"headerlink\" title=\"Q:ParserCompiler\"></a>Q:ParserCompiler</h4><p>1. <code>chrome://tracing/</code><a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p>2.tracing<code>Record</code></p>\n<p>3.<code>Web developer</code>Edit categories<code>v8.runtime_stats</code></p>\n<p>4.Tab <a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\">http://aimianwu.com</a> tracing Tab</p>\n<p>5.</p>\n<p>6.Process</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-1.png\" alt=\"\"></p>\n<p>7.V8ParseCompile</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-2.png\" alt=\"\"></p>\n<p><br></p>\n<p><br></p>\n<h1 id=\"Compiler-Pipeline\"><a href=\"#Compiler-Pipeline\" class=\"headerlink\" title=\"Compiler Pipeline\"></a><strong>Compiler Pipeline</strong></h1><p>V8Compiler PipelineV8 5.9 Ignition + TurboFan 2010Full-codegen + Crankshaft Ignition + TurboFan Full-codegen + CrankshaftTurboFan<a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389\" target=\"_blank\" rel=\"noopener\">PPT</a></p>\n<p><br></p>\n<h4 id=\"Q-\"><a href=\"#Q-\" class=\"headerlink\" title=\"Q:\"></a>Q:<a href=\"https://v8.dev/blog/launching-ignition-and-turbofan\" target=\"_blank\" rel=\"noopener\"></a></h4><p>JavaScript</p>\n<ul>\n<li>JavaScriptV81/3Crankshaft</li>\n<li>Crankshaft trycatchfinally  ESWebAssembly<br>PC</li>\n</ul>\n<p><br></p>\n<h4 id=\"Q--V8-Compiler-\"><a href=\"#Q--V8-Compiler-\" class=\"headerlink\" title=\"Q: V8 Compiler \"></a>Q: V8 Compiler </h4><p>JavaScriptV8TurboFanIgnitionTurboFan<code>Optimize</code>DeoptimizeIgnition</p>\n<p>2<a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\" target=\"_blank\" rel=\"noopener\"></a></p>\n<ul>\n<li></li>\n<li>JavaScript</li>\n</ul>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-1.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-2.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-3.png\" alt=\"\"></p>\n<blockquote>\n<p>ObjectsV8De-optimisation</p>\n</blockquote>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">load</span>(<span class=\"hljs-params\">obj</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> obj.x</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">var</span> obj = &#123;</span><br><span class=\"line\">  x: <span class=\"hljs-number\">1</span>,</span><br><span class=\"line\">  y: <span class=\"hljs-number\">4</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>obj = {}</code>  <code>obj = { x: &quot;Number&quot; }</code> <code>obj = { y: &quot;Number&quot; }</code> C++Java</p>\n<p></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-number\">7</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-number\">9</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-number\">3</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-number\">1</span> &#125;);</span><br></pre></td></tr></table></figure>\n<p></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-number\">7</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-number\">9</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-number\">1</span> &#125;);</span><br></pre></td></tr></table></figure>\n<p>TypeScript</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><code>V8</code><a href=\"https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html\" target=\"_blank\" rel=\"noopener\">Script Streaming</a> <a href=\"https://v8.dev/\" target=\"_blank\" rel=\"noopener\">https://v8.dev/</a> JavaScriptV8</p>\n<p>WebAssemblyNode.jsC++JavaScriptArduinoJavaScriptC/C++C/C++</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"https://www.youtube.com/watch?v=Fg7niTmNNLg\" target=\"_blank\" rel=\"noopener\">Parsing JavaScript - better lazy than eager</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\" target=\"_blank\" rel=\"noopener\">JavaScript engines - how do they even? </a></p>\n<p><a href=\"https://medium.com/reloading/javascript-start-up-performance-69200f43b201\" target=\"_blank\" rel=\"noopener\">JavaScript Start-up Performance</a></p>\n<p><a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103\" target=\"_blank\" rel=\"noopener\">V8: Hooking up the Ignition to the Turbofan</a></p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<blockquote>\n<p><code></code>172020<strong></strong></p>\n</blockquote>\n<p><strong>Parer</strong><strong>Compiler</strong>2V8JavaScript</p>\n<p><img src=\"/images/v8-parser-compiler/v8-pare-compile-cost.png\" alt=\"Parser15-20%\"></p>","more":"<h1 id=\"Parser\"><a href=\"#Parser\" class=\"headerlink\" title=\"Parser\"></a><strong>Parser</strong></h1><p><img src=\"/images/v8-parser-compiler/parser-phase.png\" alt=\"Parser\"></p>\n<p><strong> <code>1 MB / s</code></strong></p>\n<p><br></p>\n<h4 id=\"V8Parser2\"><a href=\"#V8Parser2\" class=\"headerlink\" title=\"V8Parser2\"></a><strong>V8Parser2</strong></h4><p><code>LayzePre-Parsing</code></p>\n<ul>\n<li></li>\n<li><code>AST</code><code>Scopes</code></li>\n<li>Eage2</li>\n<li>JavaScript</li>\n</ul>\n<p><code>EageFull-Parsing</code></p>\n<ul>\n<li></li>\n<li><code>AST</code></li>\n<li><code>Scopes</code></li>\n<li></li>\n</ul>\n<p><br></p>\n<h4 id=\"Q-2\"><a href=\"#Q-2\" class=\"headerlink\" title=\"Q:2\"></a>Q:2</h4><p>Full-ParsingDevTools<code>coverage</code></p>\n<p><br></p>\n<h4 id=\"Q-2\"><a href=\"#Q-2\" class=\"headerlink\" title=\"Q:2\"></a>Q:2</h4><p>Pre-ParsingFull-Parser: <code>0.5 * parse + 1 * parse = 1.5 parse</code> </p>\n<p><br></p>\n<h4 id=\"Q--Pre-Parsing--Full-Parsing-\"><a href=\"#Q--Pre-Parsing--Full-Parsing-\" class=\"headerlink\" title=\"Q: Pre-Parsing  Full-Parsing \"></a>Q: <code>Pre-Parsing</code>  <code>Full-Parsing</code> </h4><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> a = <span class=\"number\">0</span>; <span class=\"comment\">// Top-Level  Full-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//  IIFE = Immediately Invoked Function Expression</span></span><br><span class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">eager</span>(<span class=\"params\"></span>) </span>&#123;...&#125;)(); <span class=\"comment\">//  Full-Parsing</span></span><br><span class=\"line\">                   </span><br><span class=\"line\"><span class=\"comment\">// IIFE</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lazy</span>(<span class=\"params\"></span>) </span>&#123;...&#125; <span class=\"comment\">//  Pre-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\">lazy(); <span class=\"comment\">// -&gt; Full-Parsing </span></span><br><span class=\"line\">                 </span><br><span class=\"line\"><span class=\"comment\">// Full-Parsing</span></span><br><span class=\"line\">!<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">eager2</span>(<span class=\"params\"></span>) </span>&#123;...&#125;, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">eager3</span>(<span class=\"params\"></span>) </span>&#123;...&#125; <span class=\"comment\">// All eager</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">let</span> f1 = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lazy</span>(<span class=\"params\"></span>) </span>&#123; ... &#125;; <span class=\"comment\">//  Pre-Parsing</span></span><br><span class=\"line\">              </span><br><span class=\"line\"><span class=\"keyword\">let</span> f2 = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lazy</span>(<span class=\"params\"></span>) </span>&#123;...&#125;(); <span class=\"comment\">// lazy , eager</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h4 id=\"Q-Full-Parsing-eager-\"><a href=\"#Q-Full-Parsing-eager-\" class=\"headerlink\" title=\"Q:Full-Parsing eager \"></a>Q:Full-Parsing eager </h4><ul>\n<li>lazy 2 lazy  eager !|~</li>\n<li> <a href=\"https://github.com/nolanlawson/optimize-js\" target=\"_blank\" rel=\"noopener\">optimize-js</a> Github</li>\n</ul>\n<p><br></p>\n<h4 id=\"Q-\"><a href=\"#Q-\" class=\"headerlink\" title=\"Q:\"></a>Q:</h4><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lazy_outer</span>(<span class=\"params\"></span>) </span>&#123; <span class=\"comment\">// lazy parse this</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">inner</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">inner2</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">lazy_outer(); <span class=\"comment\">// lazy parsing inner &amp; inner2</span></span><br><span class=\"line\">inner(); <span class=\"comment\">// lazy parsing inner &amp; inner2 (3rd time!)</span></span><br></pre></td></tr></table></figure>\n<p><code>Pre-Parsing</code></p>\n<p><br></p>\n<h4 id=\"Q-Parser\"><a href=\"#Q-Parser\" class=\"headerlink\" title=\"Q:Parser\"></a>Q:Parser</h4><ol>\n<li><strong></strong>DevTools<code>coverage</code></li>\n<li>V8Parser72bundlebundleParser</li>\n</ol>\n<p><br></p>\n<h4 id=\"Q-ParserCompiler\"><a href=\"#Q-ParserCompiler\" class=\"headerlink\" title=\"Q:ParserCompiler\"></a>Q:ParserCompiler</h4><p>1. <code>chrome://tracing/</code><a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p>2.tracing<code>Record</code></p>\n<p>3.<code>Web developer</code>Edit categories<code>v8.runtime_stats</code></p>\n<p>4.Tab <a href=\"http://aimianwu.com\" target=\"_blank\" rel=\"noopener\">http://aimianwu.com</a> tracing Tab</p>\n<p>5.</p>\n<p>6.Process</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-1.png\" alt=\"\"></p>\n<p>7.V8ParseCompile</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-2.png\" alt=\"\"></p>\n<p><br></p>\n<p><br></p>\n<h1 id=\"Compiler-Pipeline\"><a href=\"#Compiler-Pipeline\" class=\"headerlink\" title=\"Compiler Pipeline\"></a><strong>Compiler Pipeline</strong></h1><p>V8Compiler PipelineV8 5.9 Ignition + TurboFan 2010Full-codegen + Crankshaft Ignition + TurboFan Full-codegen + CrankshaftTurboFan<a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389\" target=\"_blank\" rel=\"noopener\">PPT</a></p>\n<p><br></p>\n<h4 id=\"Q-\"><a href=\"#Q-\" class=\"headerlink\" title=\"Q:\"></a>Q:<a href=\"https://v8.dev/blog/launching-ignition-and-turbofan\" target=\"_blank\" rel=\"noopener\"></a></h4><p>JavaScript</p>\n<ul>\n<li>JavaScriptV81/3Crankshaft</li>\n<li>Crankshaft trycatchfinally  ESWebAssembly<br>PC</li>\n</ul>\n<p><br></p>\n<h4 id=\"Q--V8-Compiler-\"><a href=\"#Q--V8-Compiler-\" class=\"headerlink\" title=\"Q: V8 Compiler \"></a>Q: V8 Compiler </h4><p>JavaScriptV8TurboFanIgnitionTurboFan<code>Optimize</code>DeoptimizeIgnition</p>\n<p>2<a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\" target=\"_blank\" rel=\"noopener\"></a></p>\n<ul>\n<li></li>\n<li>JavaScript</li>\n</ul>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-1.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-2.png\" alt=\"\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-3.png\" alt=\"\"></p>\n<blockquote>\n<p>ObjectsV8De-optimisation</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">load</span>(<span class=\"params\">obj</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> obj.x</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> obj = &#123;</span><br><span class=\"line\">  x: <span class=\"number\">1</span>,</span><br><span class=\"line\">  y: <span class=\"number\">4</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>obj = {}</code>  <code>obj = { x: &quot;Number&quot; }</code> <code>obj = { y: &quot;Number&quot; }</code> C++Java</p>\n<p></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"number\">7</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">9</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">c</span>: <span class=\"number\">3</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">d</span>: <span class=\"number\">1</span> &#125;);</span><br></pre></td></tr></table></figure>\n<p></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"number\">7</span>, <span class=\"attr\">b</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">c</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">d</span>: <span class=\"literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">b</span>: <span class=\"number\">9</span>, <span class=\"attr\">c</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">d</span>: <span class=\"literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">b</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">c</span>: <span class=\"number\">3</span>, <span class=\"attr\">d</span>: <span class=\"literal\">undefined</span> &#125;);</span><br><span class=\"line\">load(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">b</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">c</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">d</span>: <span class=\"number\">1</span> &#125;);</span><br></pre></td></tr></table></figure>\n<p>TypeScript</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><code>V8</code><a href=\"https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html\" target=\"_blank\" rel=\"noopener\">Script Streaming</a> <a href=\"https://v8.dev/\" target=\"_blank\" rel=\"noopener\">https://v8.dev/</a> JavaScriptV8</p>\n<p>WebAssemblyNode.jsC++JavaScriptArduinoJavaScriptC/C++C/C++</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"https://www.youtube.com/watch?v=Fg7niTmNNLg\" target=\"_blank\" rel=\"noopener\">Parsing JavaScript - better lazy than eager</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\" target=\"_blank\" rel=\"noopener\">JavaScript engines - how do they even? </a></p>\n<p><a href=\"https://medium.com/reloading/javascript-start-up-performance-69200f43b201\" target=\"_blank\" rel=\"noopener\">JavaScript Start-up Performance</a></p>\n<p><a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103\" target=\"_blank\" rel=\"noopener\">V8: Hooking up the Ignition to the Turbofan</a></p>"},{"title":"Vue Component ","date":"2018-11-17T06:45:00.000Z","_content":"WebUIJS\n\nJSES6Class[Vue](https://vuejs.org/)\n\n<!-- more -->\n\n### \n\n2\n\n![ \"\"](/images/vue-component-extends/1.jpg)\n\n![ \"\"](/images/vue-component-extends/2.jpg)\n\n2\n![ ](/images/vue-component-extends/3.jpg)\n\n### \n\n- Vue  2.5\n\n- [Element-UI](http://element.eleme.io/) Demo\n\n- [](https://github.com/miser/vue-compoent-extends-experiment)\n\n\n### \n\nvue cli\n```js\nvue create vue-component-extedns\n```\n\nVue\n\n\n__Element-UI__\n\n```js\n// main.js \nimport Vue from 'vue'\nimport ElementUI from 'element-ui'\nimport 'element-ui/lib/theme-chalk/index.css'\nimport App from './App.vue'\n\nVue.config.productionTip = false\nVue.use(ElementUI)\n\nnew Vue({\n  render: h => h(App)\n}).$mount('#app')\n\n```\n\ncomponentsListPageAbstract.vueAdminPageAbstract.vueButtonClick.vueTitle.vue\n\n**\n\n```html\n// ButtonClick.vue\n<template>\n<div>\n  <el-button size=\"small\" plain type=\"primary\" @click.stop=\"click\">\n    {{ label }}\n  </el-button>\n</div>\n</template>\n<script type=\"text/javascript\">\n  export default {\n    props: ['click', 'label', 'opt'],\n    mounted () {\n      console.log('ButtonClick mounted')\n    }\n  }\n</script>\n\n// Title.vue\n<template>\n  <div class=\"title\">{{ title }}</div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['title']\n}\n</script>\n\n// ListPageAbstract.vue\n<template>\n  <div>\n    <Title :title=\"title\" />\n    <div>\n      <el-form v-if=\"config && config.filter\" ref='form' :inline=\"true\" :model=\"filterForm\">\n        <el-form-item v-if=\"config.filter.conditions.indexOf('name') >= 0\" label=\"\" prop=\"name\">\n          <el-input v-model=\"filterForm.name\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('phone') >= 0\" label=\"\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('date') >= 0\" label=\"\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('status') >= 0\" label=\"\" prop=\"status\">\n          <el-select v-model=\"filterForm.status\" placeholder=\"\">\n            <el-option v-for=\"option in statusOptions\" :label=\"option.text\" :value=\"option.value\" :key=\"option.value\"></el-option>\n          </el-select>\n        </el-form-item>\n        <!-- <div>\n        <slot name=\"filter-slot\"></slot>\n        </div> -->\n        <el-form-item>\n          <el-button type=\"primary\" @click.stop=\"config.filter.action\"></el-button>\n        </el-form-item>\n      </el-form>\n    </div>\n    <el-table v-if=\"config\" :data=\"list\" >\n      <el-table-column v-for=\"(item, index) in config.table.column\" :key=\"index\"\n      :prop=\"item.key\" :label=\"item.label\">\n      </el-table-column>\n      <el-table-column v-if=\"config.table.action\" :label=\"config.table.action.headerLabel\">\n      <template slot-scope=\"scope\">\n      <Button :click=\"config.table.action.click.bind(null, scope.row)\" :label=\"config.table.action.label\" :opt=\"config.table.action\" />\n      </template>\n      </el-table-column>\n    </el-table>\n  </div>\n</template>\n<script type=\"text/javascript\">\nimport Button from './ButtonClick.vue'\nimport Title from './Title.vue'\n\nexport default {\n  components: { Button, Title },\n  data: function () {\n    return {\n      filterForm: { },\n      statusOptions: [],\n      list: [],\n      title: null,\n      config: null\n    }\n  },\n  mounted: function () {\n    this.config = this.createConfig()\n    this.fetchOptions()\n    this.fetchData()\n  },\n  methods: {\n    createConfig () {\n      let config = {}\n      config.filter = {\n        conditions: [ 'name', 'status' ],\n        action: () => {\n          this.fetchData(this.filterForm)\n        }\n      }\n      config.table = {\n        column: [\n          { key: 'name', label: '' },\n          { key: 'phone', label: '' },\n          { key: 'status', label: '' }\n        ],\n        action: {\n          headerLabel: '',\n          label: '',\n          click: this.editRow\n        }\n      }\n      return config\n    },\n    fetchOptions () {\n      this.statusOptions = [\n        { value: 1, text: 'status1' },\n        { value: 2, text: 'status2' }\n      ]\n    },\n    async fetchData () { },\n    editRow (item) {\n      console.log(`update data => ${item.name}`)\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  color: red;\n  margin-bottom: 20px;\n}\n</style>\n\n// AdminListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract'\n// ajax\n// \nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'Admin Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'Admin Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'Admin Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'Admin Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  data () {\n    return {\n      title: ''\n    }\n  },\n  methods: {\n    fetchOptions () {\n      ListPageAbstract.methods.fetchOptions.call(this)\n      console.log('to do other thing')\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    }\n  }\n}\n</script>\n```\n\n\n\n- Title.vue ListPageAbstract.vuecss\n- ButtonClick.vue \n- ListPageAbstract.vue \n- AdminListPage.vue \n\nAdminListPage[extends](https://cn.vuejs.org/v2/api/#extends)ListPageAbstractJSListPageAbstractnamephonedatestatusVue[Slot](https://cn.vuejs.org/v2/api/#slot)ListPageAbstract.vue__filter-slot__AdminListPage.vueslot\n\n```html\n// AdminListPage.vue add template \n<template slot=\"filter-slot\">\n  <div slot=\"filter-slot\">\n    other input filter\n  </div>\n</template>\n<script type=\"text/javascript\">\n```\n\nother input filter\n\n![ other input filter](/images/vue-component-extends/4.jpg)\n\n```html\n// AdminListPage.vue \n<template slot=\"filter-slot\">\n  <Page>\n    <div slot=\"filter-slot\">\n      other input filter\n    </div>\n  </Page>\n</template>\nexport default {\n  extends: ListPageAbstract,\n  components: {\n    Page: ListPageAbstract,\n  }\n  // ...\n}\n```\n\nUIListPageAbstractmounted22ListPageAbstractAdminVuegithubfeature [#6811](https://github.com/vuejs/vue/issues/6811)\n\nfilterUserListPageButtonPop.vueUserListPage.vue\n\n**\n\n```html\n// ButtonPop.vue\n<template>\n  <div>\n    <el-button size=\"small\" plain type=\"primary\"\n      @click.stop=\"dialogVisible = true\">{{ label }}</el-button>\n    <el-dialog\n      title=\"\"\n      :visible.sync=\"dialogVisible\"\n      width=\"30%\">\n      <span></span>\n      <span slot=\"footer\" class=\"dialog-footer\">\n      <el-button @click=\"dialogVisible = false\"> </el-button>\n      <el-button type=\"primary\" @click=\"deleteInfo\"> </el-button>\n      </span>\n    </el-dialog>\n  </div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['click', 'label', 'opt'],\n  data () {\n    return {\n      dialogVisible: false\n    }\n  },\n  mounted () {\n    console.log('ButtonPop mounted')\n  },\n  methods: {\n    async deleteInfo () {\n      await this.click()\n      this.dialogVisible = false\n    }\n  }\n}\n</script>\n\n// UserListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract.vue'\nimport Button from './ButtonPop.vue'\n// ajax\n// \nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'User Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'User Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'User Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'User Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  components: { Button },\n  data: function () { return {} },\n  mounted: function () {\n    this.title = ''\n  },\n  methods: {\n    createConfig () {\n      // \n      let config = ListPageAbstract.methods.createConfig.call(this)\n      config.filter.conditions.splice(1, 0, 'phone')\n\n      let table = config.table\n      table.column.push({ key: 'date', label: '' })\n      table.action = {\n        headerLabel: '',\n        label: '',\n        click: this.deleteRow\n      }\n      return config\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    },\n    deleteRow (item) {\n      return new Promise((resolve, reject) => {\n        console.log(`delete date: ${item.name}`)\n        setTimeout(() => {\n          this.list.splice(this.list.indexOf(item), 1)\n          resolve()\n        }, 1000)\n      })\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  margin-bottom: 50px;\n  color: blue;\n}\n</style>\n```\n\nApp.vuePageAdminListPageUserListPage\n\n\n\n```js\n  components: { Button }\n```\n\nButtonButtonClickUserButtonPopFilter\n\n__VueVueoptionsmerge__\n\n4Userstylecss\n\nVuemixinslot\n","source":"_posts/vue-component-extends.md","raw":"---\ntitle: Vue Component \ncategory: JavaScript\ndate: 2018-11-17 14:45:00\n---\nWebUIJS\n\nJSES6Class[Vue](https://vuejs.org/)\n\n<!-- more -->\n\n### \n\n2\n\n![ \"\"](/images/vue-component-extends/1.jpg)\n\n![ \"\"](/images/vue-component-extends/2.jpg)\n\n2\n![ ](/images/vue-component-extends/3.jpg)\n\n### \n\n- Vue  2.5\n\n- [Element-UI](http://element.eleme.io/) Demo\n\n- [](https://github.com/miser/vue-compoent-extends-experiment)\n\n\n### \n\nvue cli\n```js\nvue create vue-component-extedns\n```\n\nVue\n\n\n__Element-UI__\n\n```js\n// main.js \nimport Vue from 'vue'\nimport ElementUI from 'element-ui'\nimport 'element-ui/lib/theme-chalk/index.css'\nimport App from './App.vue'\n\nVue.config.productionTip = false\nVue.use(ElementUI)\n\nnew Vue({\n  render: h => h(App)\n}).$mount('#app')\n\n```\n\ncomponentsListPageAbstract.vueAdminPageAbstract.vueButtonClick.vueTitle.vue\n\n**\n\n```html\n// ButtonClick.vue\n<template>\n<div>\n  <el-button size=\"small\" plain type=\"primary\" @click.stop=\"click\">\n    {{ label }}\n  </el-button>\n</div>\n</template>\n<script type=\"text/javascript\">\n  export default {\n    props: ['click', 'label', 'opt'],\n    mounted () {\n      console.log('ButtonClick mounted')\n    }\n  }\n</script>\n\n// Title.vue\n<template>\n  <div class=\"title\">{{ title }}</div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['title']\n}\n</script>\n\n// ListPageAbstract.vue\n<template>\n  <div>\n    <Title :title=\"title\" />\n    <div>\n      <el-form v-if=\"config && config.filter\" ref='form' :inline=\"true\" :model=\"filterForm\">\n        <el-form-item v-if=\"config.filter.conditions.indexOf('name') >= 0\" label=\"\" prop=\"name\">\n          <el-input v-model=\"filterForm.name\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('phone') >= 0\" label=\"\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('date') >= 0\" label=\"\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('status') >= 0\" label=\"\" prop=\"status\">\n          <el-select v-model=\"filterForm.status\" placeholder=\"\">\n            <el-option v-for=\"option in statusOptions\" :label=\"option.text\" :value=\"option.value\" :key=\"option.value\"></el-option>\n          </el-select>\n        </el-form-item>\n        <!-- <div>\n        <slot name=\"filter-slot\"></slot>\n        </div> -->\n        <el-form-item>\n          <el-button type=\"primary\" @click.stop=\"config.filter.action\"></el-button>\n        </el-form-item>\n      </el-form>\n    </div>\n    <el-table v-if=\"config\" :data=\"list\" >\n      <el-table-column v-for=\"(item, index) in config.table.column\" :key=\"index\"\n      :prop=\"item.key\" :label=\"item.label\">\n      </el-table-column>\n      <el-table-column v-if=\"config.table.action\" :label=\"config.table.action.headerLabel\">\n      <template slot-scope=\"scope\">\n      <Button :click=\"config.table.action.click.bind(null, scope.row)\" :label=\"config.table.action.label\" :opt=\"config.table.action\" />\n      </template>\n      </el-table-column>\n    </el-table>\n  </div>\n</template>\n<script type=\"text/javascript\">\nimport Button from './ButtonClick.vue'\nimport Title from './Title.vue'\n\nexport default {\n  components: { Button, Title },\n  data: function () {\n    return {\n      filterForm: { },\n      statusOptions: [],\n      list: [],\n      title: null,\n      config: null\n    }\n  },\n  mounted: function () {\n    this.config = this.createConfig()\n    this.fetchOptions()\n    this.fetchData()\n  },\n  methods: {\n    createConfig () {\n      let config = {}\n      config.filter = {\n        conditions: [ 'name', 'status' ],\n        action: () => {\n          this.fetchData(this.filterForm)\n        }\n      }\n      config.table = {\n        column: [\n          { key: 'name', label: '' },\n          { key: 'phone', label: '' },\n          { key: 'status', label: '' }\n        ],\n        action: {\n          headerLabel: '',\n          label: '',\n          click: this.editRow\n        }\n      }\n      return config\n    },\n    fetchOptions () {\n      this.statusOptions = [\n        { value: 1, text: 'status1' },\n        { value: 2, text: 'status2' }\n      ]\n    },\n    async fetchData () { },\n    editRow (item) {\n      console.log(`update data => ${item.name}`)\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  color: red;\n  margin-bottom: 20px;\n}\n</style>\n\n// AdminListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract'\n// ajax\n// \nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'Admin Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'Admin Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'Admin Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'Admin Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  data () {\n    return {\n      title: ''\n    }\n  },\n  methods: {\n    fetchOptions () {\n      ListPageAbstract.methods.fetchOptions.call(this)\n      console.log('to do other thing')\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    }\n  }\n}\n</script>\n```\n\n\n\n- Title.vue ListPageAbstract.vuecss\n- ButtonClick.vue \n- ListPageAbstract.vue \n- AdminListPage.vue \n\nAdminListPage[extends](https://cn.vuejs.org/v2/api/#extends)ListPageAbstractJSListPageAbstractnamephonedatestatusVue[Slot](https://cn.vuejs.org/v2/api/#slot)ListPageAbstract.vue__filter-slot__AdminListPage.vueslot\n\n```html\n// AdminListPage.vue add template \n<template slot=\"filter-slot\">\n  <div slot=\"filter-slot\">\n    other input filter\n  </div>\n</template>\n<script type=\"text/javascript\">\n```\n\nother input filter\n\n![ other input filter](/images/vue-component-extends/4.jpg)\n\n```html\n// AdminListPage.vue \n<template slot=\"filter-slot\">\n  <Page>\n    <div slot=\"filter-slot\">\n      other input filter\n    </div>\n  </Page>\n</template>\nexport default {\n  extends: ListPageAbstract,\n  components: {\n    Page: ListPageAbstract,\n  }\n  // ...\n}\n```\n\nUIListPageAbstractmounted22ListPageAbstractAdminVuegithubfeature [#6811](https://github.com/vuejs/vue/issues/6811)\n\nfilterUserListPageButtonPop.vueUserListPage.vue\n\n**\n\n```html\n// ButtonPop.vue\n<template>\n  <div>\n    <el-button size=\"small\" plain type=\"primary\"\n      @click.stop=\"dialogVisible = true\">{{ label }}</el-button>\n    <el-dialog\n      title=\"\"\n      :visible.sync=\"dialogVisible\"\n      width=\"30%\">\n      <span></span>\n      <span slot=\"footer\" class=\"dialog-footer\">\n      <el-button @click=\"dialogVisible = false\"> </el-button>\n      <el-button type=\"primary\" @click=\"deleteInfo\"> </el-button>\n      </span>\n    </el-dialog>\n  </div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['click', 'label', 'opt'],\n  data () {\n    return {\n      dialogVisible: false\n    }\n  },\n  mounted () {\n    console.log('ButtonPop mounted')\n  },\n  methods: {\n    async deleteInfo () {\n      await this.click()\n      this.dialogVisible = false\n    }\n  }\n}\n</script>\n\n// UserListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract.vue'\nimport Button from './ButtonPop.vue'\n// ajax\n// \nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'User Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'User Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'User Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'User Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  components: { Button },\n  data: function () { return {} },\n  mounted: function () {\n    this.title = ''\n  },\n  methods: {\n    createConfig () {\n      // \n      let config = ListPageAbstract.methods.createConfig.call(this)\n      config.filter.conditions.splice(1, 0, 'phone')\n\n      let table = config.table\n      table.column.push({ key: 'date', label: '' })\n      table.action = {\n        headerLabel: '',\n        label: '',\n        click: this.deleteRow\n      }\n      return config\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    },\n    deleteRow (item) {\n      return new Promise((resolve, reject) => {\n        console.log(`delete date: ${item.name}`)\n        setTimeout(() => {\n          this.list.splice(this.list.indexOf(item), 1)\n          resolve()\n        }, 1000)\n      })\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  margin-bottom: 50px;\n  color: blue;\n}\n</style>\n```\n\nApp.vuePageAdminListPageUserListPage\n\n\n\n```js\n  components: { Button }\n```\n\nButtonButtonClickUserButtonPopFilter\n\n__VueVueoptionsmerge__\n\n4Userstylecss\n\nVuemixinslot\n","slug":"vue-component-extends","published":1,"updated":"2020-07-07T10:11:25.591Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckcc0bs70001ld12itkordewq","content":"<p>WebUIJS</p>\n<p>JSES6Class<a href=\"https://vuejs.org/\" target=\"_blank\" rel=\"noopener\">Vue</a></p>\n<a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>2</p>\n<p><img src=\"/images/vue-component-extends/1.jpg\" alt=\" &quot;&quot;\"></p>\n<p><img src=\"/images/vue-component-extends/2.jpg\" alt=\" &quot;&quot;\"></p>\n<p>2<br><img src=\"/images/vue-component-extends/3.jpg\" alt=\" \"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>Vue  2.5</p>\n</li>\n<li><p><a href=\"http://element.eleme.io/\" target=\"_blank\" rel=\"noopener\">Element-UI</a> Demo</p>\n</li>\n<li><p><a href=\"https://github.com/miser/vue-compoent-extends-experiment\" target=\"_blank\" rel=\"noopener\"></a></p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>vue cli<br><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vue create vue-component-extedns</span><br></pre></td></tr></table></figure></p>\n<p>Vue</p>\n<p><strong>Element-UI</strong></p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// main.js </span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> Vue <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'vue'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> ElementUI <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'element-ui'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> <span class=\"hljs-string\">'element-ui/lib/theme-chalk/index.css'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> App <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./App.vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.productionTip = <span class=\"hljs-literal\">false</span></span><br><span class=\"line\">Vue.use(ElementUI)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">new</span> Vue(&#123;</span><br><span class=\"line\">  render: <span class=\"hljs-function\"><span class=\"hljs-params\">h</span> =&gt;</span> h(App)</span><br><span class=\"line\">&#125;).$mount(<span class=\"hljs-string\">'#app'</span>)</span><br></pre></td></tr></table></figure>\n<p>componentsListPageAbstract.vueAdminPageAbstract.vueButtonClick.vueTitle.vue</p>\n<p><em></em></p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonClick.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">\"small\"</span> <span class=\"hljs-attr\">plain</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"click\"</span>&gt;</span></span><br><span class=\"line\">    &#123;&#123; label &#125;&#125;</span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    props: [<span class=\"hljs-string\">'click'</span>, <span class=\"hljs-string\">'label'</span>, <span class=\"hljs-string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    mounted () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'ButtonClick mounted'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Title.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"title\"</span>&gt;</span>&#123;&#123; title &#125;&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  props: [<span class=\"hljs-string\">'title'</span>]</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// ListPageAbstract.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Title</span> <span class=\"hljs-attr\">:title</span>=<span class=\"hljs-string\">\"title\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config &amp;&amp; config.filter\"</span> <span class=\"hljs-attr\">ref</span>=<span class=\"hljs-string\">'form'</span> <span class=\"hljs-attr\">:inline</span>=<span class=\"hljs-string\">\"true\"</span> <span class=\"hljs-attr\">:model</span>=<span class=\"hljs-string\">\"filterForm\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('name') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"name\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.name\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('phone') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.date\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('date') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.date\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('status') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"status\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-select</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.status\"</span> <span class=\"hljs-attr\">placeholder</span>=<span class=\"hljs-string\">\"\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-option</span> <span class=\"hljs-attr\">v-for</span>=<span class=\"hljs-string\">\"option in statusOptions\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"option.text\"</span> <span class=\"hljs-attr\">:value</span>=<span class=\"hljs-string\">\"option.value\"</span> <span class=\"hljs-attr\">:key</span>=<span class=\"hljs-string\">\"option.value\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-option</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-select</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">&lt;!-- &lt;div&gt;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">        &lt;slot name=\"filter-slot\"&gt;&lt;/slot&gt;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">        &lt;/div&gt; --&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"config.filter.action\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config\"</span> <span class=\"hljs-attr\">:data</span>=<span class=\"hljs-string\">\"list\"</span> &gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table-column</span> <span class=\"hljs-attr\">v-for</span>=<span class=\"hljs-string\">\"(item, index) in config.table.column\"</span> <span class=\"hljs-attr\">:key</span>=<span class=\"hljs-string\">\"index\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">:prop</span>=<span class=\"hljs-string\">\"item.key\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"item.label\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table-column</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.table.action\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"config.table.action.headerLabel\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot-scope</span>=<span class=\"hljs-string\">\"scope\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Button</span> <span class=\"hljs-attr\">:click</span>=<span class=\"hljs-string\">\"config.table.action.click.bind(null, scope.row)\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"config.table.action.label\"</span> <span class=\"hljs-attr\">:opt</span>=<span class=\"hljs-string\">\"config.table.action\"</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> Button <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ButtonClick.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> Title <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./Title.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  components: &#123; Button, Title &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  data: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      filterForm: &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      statusOptions: [],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      list: [],</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      title: <span class=\"hljs-literal\">null</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      config: <span class=\"hljs-literal\">null</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  mounted: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.config = <span class=\"hljs-keyword\">this</span>.createConfig()</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.fetchOptions()</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.fetchData()</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> config = &#123;&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      config.filter = &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        conditions: [ <span class=\"hljs-string\">'name'</span>, <span class=\"hljs-string\">'status'</span> ],</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        action: <span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          <span class=\"hljs-keyword\">this</span>.fetchData(<span class=\"hljs-keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      config.table = &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        column: [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          &#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'name'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">''</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          &#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'phone'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">''</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          &#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'status'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">''</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        ],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        action: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          headerLabel: <span class=\"hljs-string\">''</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          label: <span class=\"hljs-string\">''</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          click: <span class=\"hljs-keyword\">this</span>.editRow</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.statusOptions = [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        &#123; <span class=\"hljs-attr\">value</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">text</span>: <span class=\"hljs-string\">'status1'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        &#123; <span class=\"hljs-attr\">value</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-attr\">text</span>: <span class=\"hljs-string\">'status2'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      ]</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    editRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`update data =&gt; <span class=\"hljs-subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">style</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  color: red;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  margin-bottom: 20px;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">style</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// AdminListPage.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> ListPageAbstract <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ListPageAbstract'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// ajax</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// </span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">search</span> (<span class=\"hljs-params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Peter'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'313141414'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Marry'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'123931873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status2'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Sue'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'342391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Join'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'143391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    ]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      list = list.filter(<span class=\"hljs-function\"><span class=\"hljs-params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      title: <span class=\"hljs-string\">''</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      ListPageAbstract.methods.fetchOptions.call(<span class=\"hljs-keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'to do other thing'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> list = <span class=\"hljs-keyword\">await</span> search(<span class=\"hljs-keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li>Title.vue ListPageAbstract.vuecss</li>\n<li>ButtonClick.vue </li>\n<li>ListPageAbstract.vue </li>\n<li>AdminListPage.vue </li>\n</ul>\n<p>AdminListPage<a href=\"https://cn.vuejs.org/v2/api/#extends\" target=\"_blank\" rel=\"noopener\">extends</a>ListPageAbstractJSListPageAbstractnamephonedatestatusVue<a href=\"https://cn.vuejs.org/v2/api/#slot\" target=\"_blank\" rel=\"noopener\">Slot</a>ListPageAbstract.vue<strong>filter-slot</strong>AdminListPage.vueslot</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue add template </span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">    other input filter</span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br></pre></td></tr></table></figure>\n<p>other input filter</p>\n<p><img src=\"/images/vue-component-extends/4.jpg\" alt=\" other input filter\"></p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue </span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">      other input filter</span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Page</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">export default &#123;</span><br><span class=\"line\">  extends: ListPageAbstract,</span><br><span class=\"line\">  components: &#123;</span><br><span class=\"line\">    Page: ListPageAbstract,</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>UIListPageAbstractmounted22ListPageAbstractAdminVuegithubfeature <a href=\"https://github.com/vuejs/vue/issues/6811\" target=\"_blank\" rel=\"noopener\">#6811</a></p>\n<p>filterUserListPageButtonPop.vueUserListPage.vue</p>\n<p><em></em></p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonPop.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">\"small\"</span> <span class=\"hljs-attr\">plain</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"dialogVisible = true\"</span>&gt;</span>&#123;&#123; label &#125;&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-dialog</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">title</span>=<span class=\"hljs-string\">\"\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">:visible.sync</span>=<span class=\"hljs-string\">\"dialogVisible\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">width</span>=<span class=\"hljs-string\">\"30%\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"footer\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"dialog-footer\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> @<span class=\"hljs-attr\">click</span>=<span class=\"hljs-string\">\"dialogVisible = false\"</span>&gt;</span> <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click</span>=<span class=\"hljs-string\">\"deleteInfo\"</span>&gt;</span> <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-dialog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  props: [<span class=\"hljs-string\">'click'</span>, <span class=\"hljs-string\">'label'</span>, <span class=\"hljs-string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      dialogVisible: <span class=\"hljs-literal\">false</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  mounted () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'ButtonPop mounted'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> deleteInfo () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">await</span> <span class=\"hljs-keyword\">this</span>.click()</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.dialogVisible = <span class=\"hljs-literal\">false</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// UserListPage.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> ListPageAbstract <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ListPageAbstract.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> Button <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ButtonPop.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// ajax</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// </span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">search</span> (<span class=\"hljs-params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Peter'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'313141414'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Marry'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'123931873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status2'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Sue'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'342391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Join'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'143391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    ]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      list = list.filter(<span class=\"hljs-function\"><span class=\"hljs-params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  components: &#123; Button &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  data: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123; <span class=\"hljs-keyword\">return</span> &#123;&#125; &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  mounted: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.title = <span class=\"hljs-string\">''</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-comment\">// </span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> config = ListPageAbstract.methods.createConfig.call(<span class=\"hljs-keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      config.filter.conditions.splice(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-string\">'phone'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> table = config.table</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      table.column.push(&#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'date'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">''</span> &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      table.action = &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        headerLabel: <span class=\"hljs-string\">''</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        label: <span class=\"hljs-string\">''</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        click: <span class=\"hljs-keyword\">this</span>.deleteRow</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> list = <span class=\"hljs-keyword\">await</span> search(<span class=\"hljs-keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    deleteRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`delete date: <span class=\"hljs-subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          <span class=\"hljs-keyword\">this</span>.list.splice(<span class=\"hljs-keyword\">this</span>.list.indexOf(item), <span class=\"hljs-number\">1</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">          resolve()</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">style</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  margin-bottom: 50px;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  color: blue;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">style</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>App.vuePageAdminListPageUserListPage</p>\n<p></p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">components: &#123; Button &#125;</span><br></pre></td></tr></table></figure>\n<p>ButtonButtonClickUserButtonPopFilter</p>\n<p><strong>VueVueoptionsmerge</strong></p>\n<p>4Userstylecss</p>\n<p>Vuemixinslot</p>\n","site":{"data":{}},"_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[],"excerpt":"<p>WebUIJS</p>\n<p>JSES6Class<a href=\"https://vuejs.org/\" target=\"_blank\" rel=\"noopener\">Vue</a></p>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>2</p>\n<p><img src=\"/images/vue-component-extends/1.jpg\" alt=\" &quot;&quot;\"></p>\n<p><img src=\"/images/vue-component-extends/2.jpg\" alt=\" &quot;&quot;\"></p>\n<p>2<br><img src=\"/images/vue-component-extends/3.jpg\" alt=\" \"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>Vue  2.5</p>\n</li>\n<li><p><a href=\"http://element.eleme.io/\" target=\"_blank\" rel=\"noopener\">Element-UI</a> Demo</p>\n</li>\n<li><p><a href=\"https://github.com/miser/vue-compoent-extends-experiment\" target=\"_blank\" rel=\"noopener\"></a></p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>vue cli<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vue create vue-component-extedns</span><br></pre></td></tr></table></figure></p>\n<p>Vue</p>\n<p><strong>Element-UI</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// main.js </span></span><br><span class=\"line\"><span class=\"keyword\">import</span> Vue <span class=\"keyword\">from</span> <span class=\"string\">'vue'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> ElementUI <span class=\"keyword\">from</span> <span class=\"string\">'element-ui'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">'element-ui/lib/theme-chalk/index.css'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> App <span class=\"keyword\">from</span> <span class=\"string\">'./App.vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.productionTip = <span class=\"literal\">false</span></span><br><span class=\"line\">Vue.use(ElementUI)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">new</span> Vue(&#123;</span><br><span class=\"line\">  render: <span class=\"function\"><span class=\"params\">h</span> =&gt;</span> h(App)</span><br><span class=\"line\">&#125;).$mount(<span class=\"string\">'#app'</span>)</span><br></pre></td></tr></table></figure>\n<p>componentsListPageAbstract.vueAdminPageAbstract.vueButtonClick.vueTitle.vue</p>\n<p><em></em></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonClick.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">size</span>=<span class=\"string\">\"small\"</span> <span class=\"attr\">plain</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span> @<span class=\"attr\">click.stop</span>=<span class=\"string\">\"click\"</span>&gt;</span></span><br><span class=\"line\">    &#123;&#123; label &#125;&#125;</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    props: [<span class=\"string\">'click'</span>, <span class=\"string\">'label'</span>, <span class=\"string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"undefined\">    mounted () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">'ButtonClick mounted'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Title.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"title\"</span>&gt;</span>&#123;&#123; title &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  props: [<span class=\"string\">'title'</span>]</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// ListPageAbstract.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Title</span> <span class=\"attr\">:title</span>=<span class=\"string\">\"title\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-form</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config &amp;&amp; config.filter\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">'form'</span> <span class=\"attr\">:inline</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">:model</span>=<span class=\"string\">\"filterForm\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('name') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"name\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.name\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('phone') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.date\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('date') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.date\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('status') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"status\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-select</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.status\"</span> <span class=\"attr\">placeholder</span>=<span class=\"string\">\"\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">el-option</span> <span class=\"attr\">v-for</span>=<span class=\"string\">\"option in statusOptions\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"option.text\"</span> <span class=\"attr\">:value</span>=<span class=\"string\">\"option.value\"</span> <span class=\"attr\">:key</span>=<span class=\"string\">\"option.value\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-option</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">el-select</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- &lt;div&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;slot name=\"filter-slot\"&gt;&lt;/slot&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;/div&gt; --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span> @<span class=\"attr\">click.stop</span>=<span class=\"string\">\"config.filter.action\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-form</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-table</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config\"</span> <span class=\"attr\">:data</span>=<span class=\"string\">\"list\"</span> &gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-table-column</span> <span class=\"attr\">v-for</span>=<span class=\"string\">\"(item, index) in config.table.column\"</span> <span class=\"attr\">:key</span>=<span class=\"string\">\"index\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">:prop</span>=<span class=\"string\">\"item.key\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"item.label\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-table-column</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.table.action\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"config.table.action.headerLabel\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot-scope</span>=<span class=\"string\">\"scope\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Button</span> <span class=\"attr\">:click</span>=<span class=\"string\">\"config.table.action.click.bind(null, scope.row)\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"config.table.action.label\"</span> <span class=\"attr\">:opt</span>=<span class=\"string\">\"config.table.action\"</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">el-table</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> Button <span class=\"keyword\">from</span> <span class=\"string\">'./ButtonClick.vue'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> Title <span class=\"keyword\">from</span> <span class=\"string\">'./Title.vue'</span></span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  components: &#123; Button, Title &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  data: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      filterForm: &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">      statusOptions: [],</span></span><br><span class=\"line\"><span class=\"undefined\">      list: [],</span></span><br><span class=\"line\"><span class=\"javascript\">      title: <span class=\"literal\">null</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">      config: <span class=\"literal\">null</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  mounted: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.config = <span class=\"keyword\">this</span>.createConfig()</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.fetchOptions()</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.fetchData()</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> config = &#123;&#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      config.filter = &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        conditions: [ <span class=\"string\">'name'</span>, <span class=\"string\">'status'</span> ],</span></span><br><span class=\"line\"><span class=\"javascript\">        action: <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">this</span>.fetchData(<span class=\"keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      config.table = &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">        column: [</span></span><br><span class=\"line\"><span class=\"javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">'name'</span>, <span class=\"attr\">label</span>: <span class=\"string\">''</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">'phone'</span>, <span class=\"attr\">label</span>: <span class=\"string\">''</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">'status'</span>, <span class=\"attr\">label</span>: <span class=\"string\">''</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">        ],</span></span><br><span class=\"line\"><span class=\"undefined\">        action: &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          headerLabel: <span class=\"string\">''</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">          label: <span class=\"string\">''</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">          click: <span class=\"keyword\">this</span>.editRow</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.statusOptions = [</span></span><br><span class=\"line\"><span class=\"javascript\">        &#123; <span class=\"attr\">value</span>: <span class=\"number\">1</span>, <span class=\"attr\">text</span>: <span class=\"string\">'status1'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">        &#123; <span class=\"attr\">value</span>: <span class=\"number\">2</span>, <span class=\"attr\">text</span>: <span class=\"string\">'status2'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      ]</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> fetchData () &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">    editRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">`update data =&gt; <span class=\"subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">style</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  color: red;</span></span><br><span class=\"line\"><span class=\"undefined\">  margin-bottom: 20px;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// AdminListPage.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> ListPageAbstract <span class=\"keyword\">from</span> <span class=\"string\">'./ListPageAbstract'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// ajax</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// </span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span> (<span class=\"params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Peter'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'313141414'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Marry'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'123931873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status2'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Sue'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'342391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Join'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'143391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">    ]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      list = list.filter(<span class=\"function\"><span class=\"params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      title: <span class=\"string\">''</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      ListPageAbstract.methods.fetchOptions.call(<span class=\"keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">'to do other thing'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> list = <span class=\"keyword\">await</span> search(<span class=\"keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li>Title.vue ListPageAbstract.vuecss</li>\n<li>ButtonClick.vue </li>\n<li>ListPageAbstract.vue </li>\n<li>AdminListPage.vue </li>\n</ul>\n<p>AdminListPage<a href=\"https://cn.vuejs.org/v2/api/#extends\" target=\"_blank\" rel=\"noopener\">extends</a>ListPageAbstractJSListPageAbstractnamephonedatestatusVue<a href=\"https://cn.vuejs.org/v2/api/#slot\" target=\"_blank\" rel=\"noopener\">Slot</a>ListPageAbstract.vue<strong>filter-slot</strong>AdminListPage.vueslot</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue add template </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">    other input filter</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br></pre></td></tr></table></figure>\n<p>other input filter</p>\n<p><img src=\"/images/vue-component-extends/4.jpg\" alt=\" other input filter\"></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">      other input filter</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">Page</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">export default &#123;</span><br><span class=\"line\">  extends: ListPageAbstract,</span><br><span class=\"line\">  components: &#123;</span><br><span class=\"line\">    Page: ListPageAbstract,</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>UIListPageAbstractmounted22ListPageAbstractAdminVuegithubfeature <a href=\"https://github.com/vuejs/vue/issues/6811\" target=\"_blank\" rel=\"noopener\">#6811</a></p>\n<p>filterUserListPageButtonPop.vueUserListPage.vue</p>\n<p><em></em></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonPop.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">size</span>=<span class=\"string\">\"small\"</span> <span class=\"attr\">plain</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      @<span class=\"attr\">click.stop</span>=<span class=\"string\">\"dialogVisible = true\"</span>&gt;</span>&#123;&#123; label &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-dialog</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">title</span>=<span class=\"string\">\"\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">:visible.sync</span>=<span class=\"string\">\"dialogVisible\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">width</span>=<span class=\"string\">\"30%\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"footer\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"dialog-footer\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-button</span> @<span class=\"attr\">click</span>=<span class=\"string\">\"dialogVisible = false\"</span>&gt;</span> <span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span> @<span class=\"attr\">click</span>=<span class=\"string\">\"deleteInfo\"</span>&gt;</span> <span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">el-dialog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  props: [<span class=\"string\">'click'</span>, <span class=\"string\">'label'</span>, <span class=\"string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      dialogVisible: <span class=\"literal\">false</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  mounted () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'ButtonPop mounted'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> deleteInfo () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">await</span> <span class=\"keyword\">this</span>.click()</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.dialogVisible = <span class=\"literal\">false</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// UserListPage.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> ListPageAbstract <span class=\"keyword\">from</span> <span class=\"string\">'./ListPageAbstract.vue'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> Button <span class=\"keyword\">from</span> <span class=\"string\">'./ButtonPop.vue'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// ajax</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// </span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span> (<span class=\"params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Peter'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'313141414'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Marry'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'123931873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status2'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Sue'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'342391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Join'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'143391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">    ]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      list = list.filter(<span class=\"function\"><span class=\"params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"undefined\">  components: &#123; Button &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  data: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123; <span class=\"keyword\">return</span> &#123;&#125; &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  mounted: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.title = <span class=\"string\">''</span></span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"comment\">// </span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> config = ListPageAbstract.methods.createConfig.call(<span class=\"keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      config.filter.conditions.splice(<span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"string\">'phone'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> table = config.table</span></span><br><span class=\"line\"><span class=\"javascript\">      table.column.push(&#123; <span class=\"attr\">key</span>: <span class=\"string\">'date'</span>, <span class=\"attr\">label</span>: <span class=\"string\">''</span> &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">      table.action = &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        headerLabel: <span class=\"string\">''</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">        label: <span class=\"string\">''</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">        click: <span class=\"keyword\">this</span>.deleteRow</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> list = <span class=\"keyword\">await</span> search(<span class=\"keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">    deleteRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">`delete date: <span class=\"subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">        setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">this</span>.list.splice(<span class=\"keyword\">this</span>.list.indexOf(item), <span class=\"number\">1</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">          resolve()</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">style</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  margin-bottom: 50px;</span></span><br><span class=\"line\"><span class=\"undefined\">  color: blue;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>App.vuePageAdminListPageUserListPage</p>\n<p></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">components: &#123; Button &#125;</span><br></pre></td></tr></table></figure>\n<p>ButtonButtonClickUserButtonPopFilter</p>\n<p><strong>VueVueoptionsmerge</strong></p>\n<p>4Userstylecss</p>\n<p>Vuemixinslot</p>"},{"title":"Lighthouse","date":"2020-07-07T13:56:46.000Z","_content":"\n## \n\n CI\n\n### \n\n**First Contentful Paint**canvasSVG**\n\n**First Meaningful Paint****\n\n**First CPU Idle**input\n\n**Time to Interactive**\n\n<br/>\n\n## Lighthouse \n\n>   Chrome   Lighthouse \n\n![Lighthouse ](/images/lighthouse/report.png)\n\n<br/>\n\n## \n\n![Lighthouse ](/images/lighthouse/architecture.png)\n\n**Driver** Chrome\n\n**Gatherers** Audit\n\n**Artifacts** Gatherers\n\n**Audit** //Artifacts*Lighthouse*\n\n**Report** Lighthouse\n\n**Lighthouse  Driver  DevTools Protocol  Chrome Gatherersartifacts,AuditsLHRHTML**\n\n### Lighthouse CI\n\n\n\n```yaml\nname: CI\non: [push]\njobs:\n  lighthouseci:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n      - uses: actions/setup-node@v1\n      - run: npm install && npm install -g @lhci/cli@0.4.x\n      - run: npm run build\n      - run: lhci autorun --upload.target=temporary-public-storage\n```\n\n- **npm run build** dist\n\n- **lhci autorun** `healthcheck``collect``assert``upload`\n  - healthcheck Chrome\n  - collect \n  - assert \n  - upload  `temporary-public-storage`google\n\n","source":"_posts/lighthouse.md","raw":"---\ntitle: Lighthouse\ndate: 2020-07-07 21:56:46\ntags:\n---\n\n## \n\n CI\n\n### \n\n**First Contentful Paint**canvasSVG**\n\n**First Meaningful Paint****\n\n**First CPU Idle**input\n\n**Time to Interactive**\n\n<br/>\n\n## Lighthouse \n\n>   Chrome   Lighthouse \n\n![Lighthouse ](/images/lighthouse/report.png)\n\n<br/>\n\n## \n\n![Lighthouse ](/images/lighthouse/architecture.png)\n\n**Driver** Chrome\n\n**Gatherers** Audit\n\n**Artifacts** Gatherers\n\n**Audit** //Artifacts*Lighthouse*\n\n**Report** Lighthouse\n\n**Lighthouse  Driver  DevTools Protocol  Chrome Gatherersartifacts,AuditsLHRHTML**\n\n### Lighthouse CI\n\n\n\n```yaml\nname: CI\non: [push]\njobs:\n  lighthouseci:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n      - uses: actions/setup-node@v1\n      - run: npm install && npm install -g @lhci/cli@0.4.x\n      - run: npm run build\n      - run: lhci autorun --upload.target=temporary-public-storage\n```\n\n- **npm run build** dist\n\n- **lhci autorun** `healthcheck``collect``assert``upload`\n  - healthcheck Chrome\n  - collect \n  - assert \n  - upload  `temporary-public-storage`google\n\n","slug":"lighthouse","published":1,"updated":"2020-07-10T06:20:22.780Z","_id":"ckcc5y7bu0022d12iu04q7e5g","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p> CI</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>First Contentful Paint</strong>canvasSVG<em></em></p>\n<p><strong>First Meaningful Paint</strong><em></em></p>\n<p><strong>First CPU Idle</strong>input</p>\n<p><strong>Time to Interactive</strong></p>\n<p><br></p>\n<h2 id=\"Lighthouse-\"><a href=\"#Lighthouse-\" class=\"headerlink\" title=\"Lighthouse \"></a>Lighthouse </h2><blockquote>\n<p>  Chrome   Lighthouse </p>\n</blockquote>\n<p><img src=\"/images/lighthouse/report.png\" alt=\"Lighthouse \"></p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"/images/lighthouse/architecture.png\" alt=\"Lighthouse \"></p>\n<p><strong>Driver</strong> Chrome</p>\n<p><strong>Gatherers</strong> Audit</p>\n<p><strong>Artifacts</strong> Gatherers</p>\n<p><strong>Audit</strong> //Artifacts<em>Lighthouse</em></p>\n<p><strong>Report</strong> Lighthouse</p>\n<p><strong>Lighthouse  Driver  DevTools Protocol  Chrome Gatherersartifacts,AuditsLHRHTML</strong></p>\n<h3 id=\"Lighthouse-CI\"><a href=\"#Lighthouse-CI\" class=\"headerlink\" title=\"Lighthouse CI\"></a>Lighthouse CI</h3><p></p>\n<figure class=\"highlight yaml hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">CI</span></span><br><span class=\"line\"><span class=\"hljs-attr\">on:</span> <span class=\"hljs-string\">[push]</span></span><br><span class=\"line\"><span class=\"hljs-attr\">jobs:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">  lighthouseci:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span></span><br><span class=\"line\"><span class=\"hljs-attr\">    steps:</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - uses:</span> <span class=\"hljs-string\">actions/checkout@v2</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - uses:</span> <span class=\"hljs-string\">actions/setup-node@v1</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - run:</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-string\">&amp;&amp;</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-bullet\">-g</span> <span class=\"hljs-string\">@lhci/cli@0.4.x</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - run:</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">build</span></span><br><span class=\"line\"><span class=\"hljs-attr\">      - run:</span> <span class=\"hljs-string\">lhci</span> <span class=\"hljs-string\">autorun</span> <span class=\"hljs-bullet\">--upload.target=temporary-public-storage</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><p><strong>npm run build</strong> dist</p>\n</li>\n<li><p><strong>lhci autorun</strong> <code>healthcheck</code><code>collect</code><code>assert</code><code>upload</code></p>\n<ul>\n<li>healthcheck Chrome</li>\n<li>collect </li>\n<li>assert </li>\n<li>upload  <code>temporary-public-storage</code>google</li>\n</ul>\n</li>\n</ul>\n","site":{"data":{}},"_categories":[],"_tags":[],"excerpt":"","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p> CI</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>First Contentful Paint</strong>canvasSVG<em></em></p>\n<p><strong>First Meaningful Paint</strong><em></em></p>\n<p><strong>First CPU Idle</strong>input</p>\n<p><strong>Time to Interactive</strong></p>\n<p><br></p>\n<h2 id=\"Lighthouse-\"><a href=\"#Lighthouse-\" class=\"headerlink\" title=\"Lighthouse \"></a>Lighthouse </h2><blockquote>\n<p>  Chrome   Lighthouse </p>\n</blockquote>\n<p><img src=\"/images/lighthouse/report.png\" alt=\"Lighthouse \"></p>\n<p><br></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"/images/lighthouse/architecture.png\" alt=\"Lighthouse \"></p>\n<p><strong>Driver</strong> Chrome</p>\n<p><strong>Gatherers</strong> Audit</p>\n<p><strong>Artifacts</strong> Gatherers</p>\n<p><strong>Audit</strong> //Artifacts<em>Lighthouse</em></p>\n<p><strong>Report</strong> Lighthouse</p>\n<p><strong>Lighthouse  Driver  DevTools Protocol  Chrome Gatherersartifacts,AuditsLHRHTML</strong></p>\n<h3 id=\"Lighthouse-CI\"><a href=\"#Lighthouse-CI\" class=\"headerlink\" title=\"Lighthouse CI\"></a>Lighthouse CI</h3><p></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">CI</span></span><br><span class=\"line\"><span class=\"attr\">on:</span> <span class=\"string\">[push]</span></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\"><span class=\"attr\">  lighthouseci:</span></span><br><span class=\"line\"><span class=\"attr\">    runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\"><span class=\"attr\">    steps:</span></span><br><span class=\"line\"><span class=\"attr\">      - uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\"><span class=\"attr\">      - uses:</span> <span class=\"string\">actions/setup-node@v1</span></span><br><span class=\"line\"><span class=\"attr\">      - run:</span> <span class=\"string\">npm</span> <span class=\"string\">install</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">npm</span> <span class=\"string\">install</span> <span class=\"bullet\">-g</span> <span class=\"string\">@lhci/cli@0.4.x</span></span><br><span class=\"line\"><span class=\"attr\">      - run:</span> <span class=\"string\">npm</span> <span class=\"string\">run</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">      - run:</span> <span class=\"string\">lhci</span> <span class=\"string\">autorun</span> <span class=\"bullet\">--upload.target=temporary-public-storage</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><p><strong>npm run build</strong> dist</p>\n</li>\n<li><p><strong>lhci autorun</strong> <code>healthcheck</code><code>collect</code><code>assert</code><code>upload</code></p>\n<ul>\n<li>healthcheck Chrome</li>\n<li>collect </li>\n<li>assert </li>\n<li>upload  <code>temporary-public-storage</code>google</li>\n</ul>\n</li>\n</ul>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"ckcc0bs570000d12iwhc9qpyq","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs5x000bd12itk5q9163"},{"post_id":"ckcc0bs5q0006d12ims95wvqz","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs62000fd12iviyzr0a4"},{"post_id":"ckcc0bs5t0009d12idrzu6e7l","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs65000id12ip94yfp65"},{"post_id":"ckcc0bs5d0001d12i4s9mkjdx","category_id":"ckcc0bs5s0007d12i55rhv16a","_id":"ckcc0bs69000md12i8arrq5hv"},{"post_id":"ckcc0bs5w000ad12irl0yaj38","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs6c000qd12i72hm0fy0"},{"post_id":"ckcc0bs60000ed12iio0rfwo6","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs6g000ud12ibxcw1lz7"},{"post_id":"ckcc0bs5k0004d12ir6oazsoe","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs6i000yd12i469b1oev"},{"post_id":"ckcc0bs67000ld12i883r2soz","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs6m0012d12ifbjatlzw"},{"post_id":"ckcc0bs6d000td12ipm80x4aw","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs6o0015d12i41zjfyas"},{"post_id":"ckcc0bs63000hd12ihv1bmsa1","category_id":"ckcc0bs6a000od12ihlgzwobt","_id":"ckcc0bs6q0019d12ie6vz5u52"},{"post_id":"ckcc0bs6g000wd12is9oenoib","category_id":"ckcc0bs5s0007d12i55rhv16a","_id":"ckcc0bs6t001dd12iny29myrm"},{"post_id":"ckcc0bs6k0011d12i9h6fzx8d","category_id":"ckcc0bs5s0007d12i55rhv16a","_id":"ckcc0bs6w001gd12iun4fkqwk"},{"post_id":"ckcc0bs6a000pd12iw204eeos","category_id":"ckcc0bs6a000od12ihlgzwobt","_id":"ckcc0bs6z001jd12iibqowzt2"},{"post_id":"ckcc0bs6p0018d12ibydk0jqe","category_id":"ckcc0bs5s0007d12i55rhv16a","_id":"ckcc0bs71001md12iqsgal2kb"},{"post_id":"ckcc0bs6s001cd12ifj6rubht","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs72001od12i0bjkc5l9"},{"post_id":"ckcc0bs6u001fd12ix22cpydf","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs73001qd12ic36ewd4d"},{"post_id":"ckcc0bs6n0014d12ija0axog3","category_id":"ckcc0bs6r001bd12i099h5srq","_id":"ckcc0bs73001sd12i9s98j76x"},{"post_id":"ckcc0bs6y001id12ibykhggc2","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs73001ud12iz2sw33ot"},{"post_id":"ckcc0bs70001ld12itkordewq","category_id":"ckcc0bs5h0002d12iguz5x1er","_id":"ckcc0bs73001wd12i820kv0r6"}],"PostTag":[{"post_id":"ckcc0bs570000d12iwhc9qpyq","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs62000gd12it9tg7env"},{"post_id":"ckcc0bs570000d12iwhc9qpyq","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs66000jd12ih36ktm1j"},{"post_id":"ckcc0bs5w000ad12irl0yaj38","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs69000nd12ido0ehpr8"},{"post_id":"ckcc0bs5w000ad12irl0yaj38","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs6c000rd12ifeiw5n4w"},{"post_id":"ckcc0bs60000ed12iio0rfwo6","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs6g000vd12ib5l477nl"},{"post_id":"ckcc0bs60000ed12iio0rfwo6","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs6i000zd12iswa12gfo"},{"post_id":"ckcc0bs67000ld12i883r2soz","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs6m0013d12i8lony6ps"},{"post_id":"ckcc0bs67000ld12i883r2soz","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs6o0016d12it2yefa58"},{"post_id":"ckcc0bs5k0004d12ir6oazsoe","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs6q001ad12izqqlc33b"},{"post_id":"ckcc0bs5k0004d12ir6oazsoe","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs6t001ed12ig6j3aokn"},{"post_id":"ckcc0bs6d000td12ipm80x4aw","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs6x001hd12i732cesqh"},{"post_id":"ckcc0bs6d000td12ipm80x4aw","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs6z001kd12ia3vy8p2p"},{"post_id":"ckcc0bs63000hd12ihv1bmsa1","tag_id":"ckcc0bs6c000sd12i46mcfevt","_id":"ckcc0bs71001nd12iqgvyhjuu"},{"post_id":"ckcc0bs6a000pd12iw204eeos","tag_id":"ckcc0bs6c000sd12i46mcfevt","_id":"ckcc0bs72001pd12ig4276628"},{"post_id":"ckcc0bs6a000pd12iw204eeos","tag_id":"ckcc0bs6o0017d12iea00bfqs","_id":"ckcc0bs73001rd12igmjtht8t"},{"post_id":"ckcc0bs6s001cd12ifj6rubht","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs73001td12io5exnjnk"},{"post_id":"ckcc0bs6s001cd12ifj6rubht","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs73001vd12i09rmpbji"},{"post_id":"ckcc0bs6u001fd12ix22cpydf","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs74001xd12i0jzimpha"},{"post_id":"ckcc0bs6u001fd12ix22cpydf","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs74001yd12ia4rl2lgo"},{"post_id":"ckcc0bs6y001id12ibykhggc2","tag_id":"ckcc0bs5k0003d12ikwo92vqf","_id":"ckcc0bs74001zd12ip97rxn90"},{"post_id":"ckcc0bs6y001id12ibykhggc2","tag_id":"ckcc0bs5s0008d12iu04lzb7n","_id":"ckcc0bs740020d12i2bbtg91g"}],"Tag":[{"name":"Node.js","_id":"ckcc0bs5k0003d12ikwo92vqf"},{"name":"JavaScript","_id":"ckcc0bs5s0008d12iu04lzb7n"},{"name":"","_id":"ckcc0bs6c000sd12i46mcfevt"},{"name":"","_id":"ckcc0bs6o0017d12iea00bfqs"}]}}