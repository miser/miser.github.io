{"meta":{"version":1,"warehouse":"5.0.1"},"models":{"Asset":[{"_id":"themes/minos/source/CNAME","path":"CNAME","modified":0,"renderable":1},{"_id":"themes/minos/source/baidu_verify_CXKjj3fklD.html","path":"baidu_verify_CXKjj3fklD.html","modified":0,"renderable":1},{"_id":"themes/minos/source/baidu_verify_yIFJ6q4kkQ.html","path":"baidu_verify_yIFJ6q4kkQ.html","modified":0,"renderable":1},{"_id":"themes/minos/source/css/insight.scss","path":"css/insight.scss","modified":0,"renderable":1},{"_id":"themes/minos/source/css/style.scss","path":"css/style.scss","modified":1,"renderable":1},{"_id":"themes/minos/source/images/check.svg","path":"images/check.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/exclamation.svg","path":"images/exclamation.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/logo.png","path":"images/logo.png","modified":0,"renderable":1},{"_id":"themes/minos/source/images/question.svg","path":"images/question.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/info.svg","path":"images/info.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/quote-left.svg","path":"images/quote-left.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/js/insight.js","path":"js/insight.js","modified":0,"renderable":1},{"_id":"themes/minos/source/js/script.js","path":"js/script.js","modified":0,"renderable":1},{"_id":"source/ads.txt","path":"ads.txt","modified":0,"renderable":0},{"_id":"source/images/give-a-reward.png","path":"images/give-a-reward.png","modified":0,"renderable":0},{"_id":"source/images/bec/1.jpeg","path":"images/bec/1.jpeg","modified":0,"renderable":0},{"_id":"source/images/bec/2.jpeg","path":"images/bec/2.jpeg","modified":0,"renderable":0},{"_id":"source/images/debug-libuv/build.jpg","path":"images/debug-libuv/build.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-boot/egg-boot.jpg","path":"images/egg-boot/egg-boot.jpg","modified":0,"renderable":0},{"_id":"source/images/debug-libuv/debug.jpg","path":"images/debug-libuv/debug.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-cluster/3.jpg","path":"images/egg-cluster/3.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-cluster/2.jpg","path":"images/egg-cluster/2.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-cluster/1.jpg","path":"images/egg-cluster/1.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-cluster/4.jpg","path":"images/egg-cluster/4.jpg","modified":0,"renderable":0},{"_id":"source/images/icestark-sandbox/icestark.png","path":"images/icestark-sandbox/icestark.png","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/1.png","path":"images/js-capture-error/1.png","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/2.jpg","path":"images/js-capture-error/2.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/4.jpg","path":"images/js-capture-error/4.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/10.jpg","path":"images/js-capture-error/10.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/6.jpg","path":"images/js-capture-error/6.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/3.jpg","path":"images/js-capture-error/3.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/7.jpg","path":"images/js-capture-error/7.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/5.jpg","path":"images/js-capture-error/5.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/8.jpg","path":"images/js-capture-error/8.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/9.jpg","path":"images/js-capture-error/9.jpg","modified":0,"renderable":0},{"_id":"source/images/js-css-image-loading/1.png","path":"images/js-css-image-loading/1.png","modified":0,"renderable":0},{"_id":"source/images/lighthouse/architecture.png","path":"images/lighthouse/architecture.png","modified":0,"renderable":0},{"_id":"source/images/lighthouse/audits.png","path":"images/lighthouse/audits.png","modified":0,"renderable":0},{"_id":"source/images/lighthouse/gatherers.png","path":"images/lighthouse/gatherers.png","modified":0,"renderable":0},{"_id":"source/images/lighthouse/report.png","path":"images/lighthouse/report.png","modified":0,"renderable":0},{"_id":"source/images/monitor-hub/image-20200403185942130.png","path":"images/monitor-hub/image-20200403185942130.png","modified":0,"renderable":0},{"_id":"source/images/monitor-hub/image-20200403210837664.png","path":"images/monitor-hub/image-20200403210837664.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version/arch.png","path":"images/node-gateway-ssr-multi-version/arch.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/0.png","path":"images/node-gateway-ssr-multi-version-2/0.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/1.png","path":"images/node-gateway-ssr-multi-version-2/1.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/3.png","path":"images/node-gateway-ssr-multi-version-2/3.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/5.png","path":"images/node-gateway-ssr-multi-version-2/5.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/2.png","path":"images/node-gateway-ssr-multi-version-2/2.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/7.png","path":"images/node-gateway-ssr-multi-version-2/7.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/4.png","path":"images/node-gateway-ssr-multi-version-2/4.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/8.png","path":"images/node-gateway-ssr-multi-version-2/8.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/9.png","path":"images/node-gateway-ssr-multi-version-2/9.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/6.png","path":"images/node-gateway-ssr-multi-version-2/6.png","modified":0,"renderable":0},{"_id":"source/images/node-gateway-ssr-multi-version-2/FE-Schedule.pptx","path":"images/node-gateway-ssr-multi-version-2/FE-Schedule.pptx","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_01.png","path":"images/node-perf-heapdump-flame-graph/connection_01.png","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/heapdump_01.png","path":"images/node-perf-heapdump-flame-graph/heapdump_01.png","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/monitor.pptx","path":"images/node-perf-heapdump-flame-graph/monitor.pptx","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.svg","path":"images/node-perf-heapdump-flame-graph/node-flamegraph.svg","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_02.png","path":"images/node-perf-heapdump-flame-graph/connection_02.png","modified":0,"renderable":0},{"_id":"source/images/nodejs-istio-k8s-docker/arch.jpg","path":"images/nodejs-istio-k8s-docker/arch.jpg","modified":0,"renderable":0},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.png","path":"images/node-perf-heapdump-flame-graph/node-flamegraph.png","modified":0,"renderable":0},{"_id":"source/images/summary-2019/2.jpg","path":"images/summary-2019/2.jpg","modified":0,"renderable":0},{"_id":"source/images/summary-2019/1.png","path":"images/summary-2019/1.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-01.png","path":"images/travel-zhoushan/travel-zhoushan-01.png","modified":0,"renderable":0},{"_id":"source/images/nodejs-istio-k8s-docker/book-app.png","path":"images/nodejs-istio-k8s-docker/book-app.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-02.jpg","path":"images/travel-zhoushan/travel-zhoushan-02.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-03.png","path":"images/travel-zhoushan/travel-zhoushan-03.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-06.jpg","path":"images/travel-zhoushan/travel-zhoushan-06.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-05.jpg","path":"images/travel-zhoushan/travel-zhoushan-05.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-07.jpg","path":"images/travel-zhoushan/travel-zhoushan-07.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-08.jpg","path":"images/travel-zhoushan/travel-zhoushan-08.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-10.jpg","path":"images/travel-zhoushan/travel-zhoushan-10.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-11.jpg","path":"images/travel-zhoushan/travel-zhoushan-11.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-13.jpg","path":"images/travel-zhoushan/travel-zhoushan-13.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-12.jpg","path":"images/travel-zhoushan/travel-zhoushan-12.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-04.jpg","path":"images/travel-zhoushan/travel-zhoushan-04.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-15.mp4","path":"images/travel-zhoushan/travel-zhoushan-15.mp4","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-16.png","path":"images/travel-zhoushan/travel-zhoushan-16.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-18.jpg","path":"images/travel-zhoushan/travel-zhoushan-18.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-19.jpg","path":"images/travel-zhoushan/travel-zhoushan-19.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-20.jpg","path":"images/travel-zhoushan/travel-zhoushan-20.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-21.jpg","path":"images/travel-zhoushan/travel-zhoushan-21.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-22.jpg","path":"images/travel-zhoushan/travel-zhoushan-22.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-17.jpg","path":"images/travel-zhoushan/travel-zhoushan-17.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-24.jpg","path":"images/travel-zhoushan/travel-zhoushan-24.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-23.png","path":"images/travel-zhoushan/travel-zhoushan-23.png","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-26.jpg","path":"images/travel-zhoushan/travel-zhoushan-26.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-27.jpg","path":"images/travel-zhoushan/travel-zhoushan-27.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-25.jpg","path":"images/travel-zhoushan/travel-zhoushan-25.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-28.jpg","path":"images/travel-zhoushan/travel-zhoushan-28.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-29.jpg","path":"images/travel-zhoushan/travel-zhoushan-29.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-09.jpg","path":"images/travel-zhoushan/travel-zhoushan-09.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-30.jpg","path":"images/travel-zhoushan/travel-zhoushan-30.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-31.jpg","path":"images/travel-zhoushan/travel-zhoushan-31.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/travel-zhoushan-32.png","path":"images/travel-zhoushan/travel-zhoushan-32.png","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/1.jpg","path":"images/traveling-to-the-philippines/1.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/11.jpg","path":"images/traveling-to-the-philippines/11.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/12.jpg","path":"images/traveling-to-the-philippines/12.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/14.jpg","path":"images/traveling-to-the-philippines/14.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/15.jpg","path":"images/traveling-to-the-philippines/15.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/10.jpg","path":"images/traveling-to-the-philippines/10.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/16.jpg","path":"images/traveling-to-the-philippines/16.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/17.jpg","path":"images/traveling-to-the-philippines/17.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/2.jpg","path":"images/traveling-to-the-philippines/2.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/20.jpg","path":"images/traveling-to-the-philippines/20.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/19.jpg","path":"images/traveling-to-the-philippines/19.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/21.jpg","path":"images/traveling-to-the-philippines/21.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/22.jpg","path":"images/traveling-to-the-philippines/22.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/23.jpg","path":"images/traveling-to-the-philippines/23.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/24.jpg","path":"images/traveling-to-the-philippines/24.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/25.jpg","path":"images/traveling-to-the-philippines/25.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/13.jpg","path":"images/traveling-to-the-philippines/13.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/27.jpg","path":"images/traveling-to-the-philippines/27.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/28.jpg","path":"images/traveling-to-the-philippines/28.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/26.jpg","path":"images/traveling-to-the-philippines/26.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/3.jpg","path":"images/traveling-to-the-philippines/3.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/30.jpg","path":"images/traveling-to-the-philippines/30.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/31.jpg","path":"images/traveling-to-the-philippines/31.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/32.jpg","path":"images/traveling-to-the-philippines/32.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/29.jpg","path":"images/traveling-to-the-philippines/29.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/33.jpeg","path":"images/traveling-to-the-philippines/33.jpeg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/34.jpg","path":"images/traveling-to-the-philippines/34.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/8.jpg","path":"images/traveling-to-the-philippines/8.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/9.jpg","path":"images/traveling-to-the-philippines/9.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/7.jpg","path":"images/traveling-to-the-philippines/7.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-libuv-timer-event-loop/image-20200301145547994.png","path":"images/v8-libuv-timer-event-loop/image-20200301145547994.png","modified":0,"renderable":0},{"_id":"source/images/v8-libuv-timer-event-loop/loop_iteration.png","path":"images/v8-libuv-timer-event-loop/loop_iteration.png","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/not-change-types-1.png","path":"images/v8-parser-compiler/not-change-types-1.png","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/not-change-types-2.png","path":"images/v8-parser-compiler/not-change-types-2.png","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/4.jpg","path":"images/traveling-to-the-philippines/4.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/not-change-types-3.png","path":"images/v8-parser-compiler/not-change-types-3.png","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parse-time-1.png","path":"images/v8-parser-compiler/parse-time-1.png","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parse-time.png","path":"images/v8-parser-compiler/parse-time.png","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parser-phase.png","path":"images/v8-parser-compiler/parser-phase.png","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/v8-pare-compile-cost.png","path":"images/v8-parser-compiler/v8-pare-compile-cost.png","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/6.jpg","path":"images/traveling-to-the-philippines/6.jpg","modified":0,"renderable":0},{"_id":"source/images/v8-parser-compiler/parse-time-2.png","path":"images/v8-parser-compiler/parse-time-2.png","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/1.jpg","path":"images/vue-component-extends/1.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/3.jpg","path":"images/vue-component-extends/3.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/2.jpg","path":"images/vue-component-extends/2.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/4.jpg","path":"images/vue-component-extends/4.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-02.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-04.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-05.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-09.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-06.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-07.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-08.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-10.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-11.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-12.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-13.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-17.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-18.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-19.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-20.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-21.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-22.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-24.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-26.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-25.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-27.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-28.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-29.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-30.jpg","modified":0,"renderable":0},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg","path":"images/travel-zhoushan/optimize/travel-zhoushan-31.jpg","modified":0,"renderable":0}],"Cache":[{"_id":"themes/minos/.gitignore","hash":"1e32cd03954ae9a15e790df87605f9bc11c33e4c","modified":1712418789479},{"_id":"themes/minos/LICENSE","hash":"c3aeede5ce76bbbf93cec6656644b16bc08f206b","modified":1712418789480},{"_id":"themes/minos/README.md","hash":"c407e58328acba3e8a9442dbc8401c79cc9e8f36","modified":1712418789480},{"_id":"themes/minos/package.json","hash":"76b6439e405b7b479535d40bad6d982957ac4fa7","modified":1712418789501},{"_id":"themes/minos/_config.yml.example","hash":"7b5ddc62970927039597ece115bfd6666eda8e4d","modified":1712418789481},{"_id":"themes/minos/languages/en.yml","hash":"b0106e055e348cff3dc04bbfa92eaf078887914a","modified":1712418789482},{"_id":"themes/minos/languages/es.yml","hash":"2492235c429294caef66d220d2b958d147d2a8e7","modified":1712418789482},{"_id":"themes/minos/languages/ko.yml","hash":"5cdf4a031fc3fcbab392dec89053e2417485e4c7","modified":1712418789483},{"_id":"themes/minos/languages/ru.yml","hash":"c7d59fc5906eeb9230ca794515cabd6064e853bc","modified":1712418789483},{"_id":"themes/minos/layout/archive.ejs","hash":"4239b7b97f02d86e83878ee0c32b0eccb9893420","modified":1712418789484},{"_id":"themes/minos/languages/zh-cn.yml","hash":"ba7eabb49391804f1d83acd1a4e03d1a73e02089","modified":1712418789484},{"_id":"themes/minos/layout/categories.ejs","hash":"b609b00fd03b521689dfc2d267aead94d49fcc80","modified":1712418789485},{"_id":"themes/minos/layout/category.ejs","hash":"587fc7dac77115589ed8cb368ed4a8a2a6f129af","modified":1712418789485},{"_id":"themes/minos/layout/index.ejs","hash":"64c432857172b1c775bf82c0a60ca1ecdc7d9d21","modified":1712418789495},{"_id":"themes/minos/layout/post.ejs","hash":"bba00a681d797817baf34737467be2eca3bdcfbb","modified":1712418789498},{"_id":"themes/minos/layout/tag.ejs","hash":"b72bf2ebd9c5d9d7546f448a4331f13dc6b49950","modified":1712418789500},{"_id":"themes/minos/layout/layout.ejs","hash":"af7b8632db08e2945de0d37d89061feea2212288","modified":1712496661066},{"_id":"themes/minos/source/CNAME","hash":"7b413e78021f20020e4ad381c84a5b173dc572dc","modified":1712418789505},{"_id":"themes/minos/source/baidu_verify_CXKjj3fklD.html","hash":"bf461c955fdd6b20f4ba6c3bb95c402bf00f247d","modified":1712418789505},{"_id":"themes/minos/source/baidu_verify_yIFJ6q4kkQ.html","hash":"ea49a0fba4306b904b14c9257b691b51814ed4f7","modified":1712418789506},{"_id":"themes/minos/layout/tags.ejs","hash":"9b54bfb0c56e54ff89da9a0a390414ef13a14931","modified":1712418789500},{"_id":"themes/minos/scripts/01_check.js","hash":"4b880b42500b01c5c813cab3ae0950e6f923b66b","modified":1712418789502},{"_id":"themes/minos/scripts/10_i18n.js","hash":"07242498a7e6c6e0dd7f53333dc4ad1ea00ac2c7","modified":1731152412879},{"_id":"themes/minos/scripts/99_config.js","hash":"c4496562e4ecae5e49dbc57490edae0682f77989","modified":1712418789503},{"_id":"themes/minos/scripts/99_tags.js","hash":"b4267774742039961197b5a64983f951182d5234","modified":1712418789504},{"_id":"themes/minos/scripts/rfc5646.js","hash":"50de178e1fcd2224c99db56227652eb1dbaabe40","modified":1712418789504},{"_id":"themes/minos/layout/comment/changyan.ejs","hash":"e0a2716e7a6c7da26182135fce4776596761a699","modified":1712418789486},{"_id":"themes/minos/layout/comment/disqus.ejs","hash":"2e35b7578478cf25544ae7f4b3535521ad73c5a2","modified":1712418789487},{"_id":"themes/minos/layout/comment/isso.ejs","hash":"55bfe636859f118b40750bd36e2c3ef1a2ec4c0e","modified":1712418789488},{"_id":"themes/minos/scripts/99_content.js","hash":"4d445f2ff4ef4fa52faff4d3cf6760ede05c9dcf","modified":1712418789503},{"_id":"themes/minos/layout/comment/facebook.ejs","hash":"cd2fe44bc6be457d4cb6dc43c75023e9f83d66f7","modified":1712418789487},{"_id":"themes/minos/layout/comment/livere.ejs","hash":"792a1e44b71ed8048903ea898aeaf74a6c109037","modified":1712418789489},{"_id":"themes/minos/layout/comment/youyan.ejs","hash":"bcb4b7282a7bcfcb514133e752c0f9d606b3c4d5","modified":1712418789490},{"_id":"themes/minos/layout/common/adv.ejs","hash":"6dd810223e145bd58f383954bd0bece7d71d3d9e","modified":1731154525696},{"_id":"themes/minos/layout/comment/valine.ejs","hash":"8de28aae5fac5d1aafed602b537813e2940034d6","modified":1712418789490},{"_id":"themes/minos/layout/comment/gitment.ejs","hash":"033fb890dc1de71f7d3b97061d0d75f4564bd09a","modified":1712418789488},{"_id":"themes/minos/layout/common/article.ejs","hash":"edd33d2e80c6871407786c3311ed9e36f951894d","modified":1712418789492},{"_id":"themes/minos/layout/common/navbar.ejs","hash":"690c70004dd3365e27d0e19778a83206206a1ecd","modified":1712418789493},{"_id":"themes/minos/layout/common/scripts.ejs","hash":"0262a28c2e0f4a9e57fe1da871c517909710eca3","modified":1712418789495},{"_id":"themes/minos/layout/common/languages.ejs","hash":"9b503282ca6e665ca41412b277debf4cd15635fd","modified":1712418789493},{"_id":"themes/minos/layout/common/paginator.ejs","hash":"2ea7e6c7349d4529bfcfd50c51088c7475743686","modified":1712418789494},{"_id":"themes/minos/layout/plugins/gallery.ejs","hash":"a1b9814c597f0e6b74be2bb5550e50c2915ae482","modified":1712418789496},{"_id":"themes/minos/layout/common/head.ejs","hash":"ab13b3324034ac74e7c69efd0209322858d26554","modified":1712418789493},{"_id":"themes/minos/layout/plugins/google-analytics.ejs","hash":"725fd626b6535c6d05b88e736eeefbca6d39e7e8","modified":1712418789497},{"_id":"themes/minos/layout/search/google-cse.ejs","hash":"ab3aa6c57d7dd045b8838280548aa447ec38ffa6","modified":1712418789498},{"_id":"themes/minos/layout/plugins/mathjax.ejs","hash":"700c9fbe39016a4d51426812e150af780020ef77","modified":1712418789497},{"_id":"themes/minos/layout/search/insight.ejs","hash":"2ef94c3ddae02db57c9dc5cf69da72b1c90c9236","modified":1712418789499},{"_id":"themes/minos/layout/share/addthis.ejs","hash":"9cc26da261527bbba8b0180e0f73e0c6ae5416b5","modified":1712418789499},{"_id":"themes/minos/layout/common/footer.ejs","hash":"b4bcd5dc08c3cbeb553189341b6002b2a60a0fe9","modified":1712418789492},{"_id":"themes/minos/layout/share/sharethis.ejs","hash":"307d905cd39ac4908ef5589829a18777f314428d","modified":1712418789500},{"_id":"themes/minos/source/css/insight.scss","hash":"b7340f343e8bfe967b21b502d6cb5b78295fd9e0","modified":1712418789506},{"_id":"themes/minos/source/css/style.scss","hash":"823b1a4f18b9ce34c6b62bf1449ae3854c40df32","modified":1731160632525},{"_id":"themes/minos/source/images/check.svg","hash":"16e9a53d7c49621be8e3f1a28b11bcf5e751105e","modified":1712418789508},{"_id":"themes/minos/source/images/exclamation.svg","hash":"213125a083bcef89806b4285190e050eef2660f2","modified":1712418789508},{"_id":"themes/minos/source/images/logo.png","hash":"4e012d9ba58cb8f87ee775262ef871c158ac5948","modified":1712418789508},{"_id":"themes/minos/source/images/question.svg","hash":"e4005d2eabfbd3bdd291236f56a4d385e3b337b2","modified":1712418789509},{"_id":"themes/minos/source/images/info.svg","hash":"60613abd8f8522c6cebdbb4bf7bf3fcc482245bd","modified":1712418789508},{"_id":"themes/minos/source/images/quote-left.svg","hash":"d2561fa8d13e63ff196b71232a5968415ec6e372","modified":1712418789509},{"_id":"themes/minos/source/js/insight.js","hash":"4be407e66c2c45333a8cf1a064a9302cd6d90422","modified":1712418789509},{"_id":"themes/minos/source/js/script.js","hash":"b51152561a894d1b0afee2d908364e69b253bfc2","modified":1712418789510},{"_id":"source/ads.txt","hash":"6180cdd25e466a5faab6cb0cf9890f8349062f91","modified":1712496069060},{"_id":"source/_posts/bec.md","hash":"753aae55516a319d4c406f3517f31ae2acef0f2b","modified":1712418786594},{"_id":"source/_posts/20240514-dream.md","hash":"53d5477dbdf97dc1437f9adb8fd8c2ba19f8e425","modified":1731152412876},{"_id":"source/_posts/debug-libuv.md","hash":"c73bbba1dcb314cbdedd2627376ae124be4a1f6b","modified":1712583535777},{"_id":"source/_posts/child_process-exec-fork-spawn.md","hash":"3bac6cc96b27af3a551d05a7e19ba3db063dfdf5","modified":1712583538592},{"_id":"source/_posts/egg-cluster.md","hash":"a2aaf6b348c22f3756f1857506b2dfd95044d050","modified":1712583324528},{"_id":"source/_posts/coder-painter.md","hash":"b5e7dc3b4918a13061f140ab745bbf5e9139ca39","modified":1712583536342},{"_id":"source/_posts/icestark-sandbox.md","hash":"b29e4a62da91ed662e3cc5f90ac7597e4b3ef7c7","modified":1712583242453},{"_id":"source/_posts/js-capture-error.md","hash":"3b83f7ffff3f13d983eca7ef6d60613d51209863","modified":1712583243156},{"_id":"source/_posts/egg-boot.md","hash":"71bf2bac04716094ca948569c3ee52dfbd98f733","modified":1712583535200},{"_id":"source/_posts/express-gateway.md","hash":"3db0054f12dd56b720263300fd68475673b9b3fb","modified":1712583273865},{"_id":"source/_posts/lighthouse.md","hash":"1eaf5c0e072935059e0373c4bde129703b889bd8","modified":1712583534582},{"_id":"source/_posts/monitor-hub.md","hash":"8c139be13be2fe1d1cf3513ce61dcfcc225bd2c1","modified":1712583533982},{"_id":"source/_posts/monitorEventLoopDelay-libuv-uv-timer-start.md","hash":"aa589c36a7232cd6692754130d21df299bea4d3d","modified":1712583533380},{"_id":"source/_posts/js-css-image-loading.md","hash":"c01bcb1137a93a15897679b35fc2c70ccc826160","modified":1712583242489},{"_id":"source/_posts/node-gateway-ssr-multi-version.md","hash":"9c57b135bc40019605e8153208d22c87e25573a3","modified":1712583532167},{"_id":"source/_posts/node-js-net-cluster-fork.md","hash":"415ec88598331d15be1d9027418659d3eff9829b","modified":1712583531018},{"_id":"source/_posts/node-gateway-ssr-multi-version-2.md","hash":"46556254073f3e087ab32cf1e59b93031ab29b39","modified":1712583532741},{"_id":"source/_posts/node-perf-heapdump-flame-graph.md","hash":"f7116d61a3575cd4105a7248584461199617909a","modified":1712583242489},{"_id":"source/_posts/nodejs-istio-k8s-docker.md","hash":"523433ba12735690b8bb2c2b54ef33c04dbe61a2","modified":1712583529265},{"_id":"source/_posts/summary-2019.md","hash":"1c866bd9c88c61b0adf3b9397cbb03229283e2d0","modified":1712583527059},{"_id":"source/_posts/ssr-nodejs-thread-test.md","hash":"66f040827eacac1b3856350a530aaa57d2a44e90","modified":1712583527808},{"_id":"source/_posts/travel-zhoushan.md","hash":"cc3de8def5d9bffaa3dc6031cba662b09b2f4d0c","modified":1712583525561},{"_id":"source/_posts/traveling-to-the-philippines.md","hash":"e6b258f2e5781fb33191b806926916c91da7abfb","modified":1712583524770},{"_id":"source/_posts/the-quality-of-a-company-first-look-at-HR-department.md","hash":"1df48f0a98403a651afadef0bd2dfebff989c6f5","modified":1712583526333},{"_id":"source/_posts/v8-parser-compiler-javascript.md","hash":"94be5be979e3f69fb66cb73a806ac17ed861269f","modified":1712583522870},{"_id":"source/_posts/vue-component-extends.md","hash":"152e224dd72cfc3ce1689ba29e56a3920c508048","modified":1712583242491},{"_id":"source/_posts/v8-libuv-timer-event-loop.md","hash":"30df52788ab9bbb43d613c58476db8921977e6e3","modified":1712583523885},{"_id":"source/images/debug-libuv/build.jpg","hash":"6af810b2316843d8ad436ebe3320254f8b82e715","modified":1712418786640},{"_id":"source/images/debug-libuv/debug.jpg","hash":"9d31a226b9d27518efd9dade7ab2a545aa86879d","modified":1712418786642},{"_id":"source/images/egg-cluster/3.jpg","hash":"2e999d8632a8a784f778c48b4c26238ce61dfad5","modified":1712418786655},{"_id":"source/images/egg-cluster/1.jpg","hash":"862150374047d825dc6cf409a86c4ca75e132c86","modified":1712418786650},{"_id":"source/images/js-capture-error/6.jpg","hash":"4df941e78df71a066d31a4e4d9f7a2acf6663c8a","modified":1712418786711},{"_id":"source/images/js-capture-error/3.jpg","hash":"8ab14ad4b43d54cd690218c0a9205ae8d5f102de","modified":1712418786704},{"_id":"source/images/js-capture-error/7.jpg","hash":"2048e9e10834e569f9ac9d13befbbeab25e0db98","modified":1712418786712},{"_id":"source/images/lighthouse/architecture.png","hash":"67429cd13974c7d16138a5d5d2c4167e84e0596d","modified":1712418786718},{"_id":"source/images/js-capture-error/8.jpg","hash":"d16542cad83c53000902969dca6604833675dd5b","modified":1712418786713},{"_id":"source/images/node-gateway-ssr-multi-version-2/0.png","hash":"893846cee98a8ecb6f48c512f4fe80018529aaa7","modified":1712418786743},{"_id":"source/images/node-perf-heapdump-flame-graph/monitor.pptx","hash":"5bc6ab601976c87a5a8a749d383732b7e5f1a4e3","modified":1712418786791},{"_id":"source/images/summary-2019/2.jpg","hash":"70d8c75bfc4dca70ce90c96b712ca0032ac1ee25","modified":1712418786834},{"_id":"source/images/v8-libuv-timer-event-loop/image-20200301145547994.png","hash":"ee45995af24bc027413f4e3d277ff17a7adebcbd","modified":1712418789394},{"_id":"source/images/vue-component-extends/3.jpg","hash":"34366ce9fa8f6d101918ee510b87d50a980f1898","modified":1712418789474},{"_id":"source/images/vue-component-extends/2.jpg","hash":"849929e4e6cb963667a09efe4ffb6b1dc1c30052","modified":1712418789472},{"_id":"source/images/vue-component-extends/1.jpg","hash":"f8ed085d61eac35e39a75469cec2fb53184c8f99","modified":1712418789469},{"_id":"source/images/vue-component-extends/4.jpg","hash":"9b02fc2442e9c12e70a3f2099e080a8abbfce0f8","modified":1712418789478},{"_id":"source/_posts/2024-11/me.md","hash":"7eb52f7e9c63e5eb178fcdc371b60f7fa83326f1","modified":1731155111179},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg","hash":"5082c1e85542f1e6e84f40ed90eeaa6a8d1dbe7a","modified":1712418786877},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg","hash":"029f1682134caee2658d729e22cbcc258cd39654","modified":1712418786880},{"_id":"source/images/give-a-reward.png","hash":"7171e8e86f6a02a6177f0a5dfd1b0068149d497d","modified":1712418786662},{"_id":"source/images/bec/2.jpeg","hash":"42aa67b3eaa413a0d98e32bc1be92e9b81044e67","modified":1712418786636},{"_id":"source/images/egg-cluster/2.jpg","hash":"3f3006fab2f9e349a3cd43708c8f5fce54c1083e","modified":1712418786654},{"_id":"source/images/egg-cluster/4.jpg","hash":"31f6945a8694b2cbbb7bc8906ca166b96cc0803e","modified":1712418786658},{"_id":"source/images/icestark-sandbox/icestark.png","hash":"d4380205063aec2ecdbc507c759ed87747fa7c3d","modified":1712418786669},{"_id":"source/images/js-capture-error/9.jpg","hash":"0d70c8c909842dc05faf690ee1496d98093e8e87","modified":1712418786714},{"_id":"source/images/lighthouse/audits.png","hash":"cf2bfd32538fb2fbc6bbf7e5bb456c9da91511e6","modified":1712418786720},{"_id":"source/images/lighthouse/gatherers.png","hash":"b6e69978af7b375180cd48648fa94fd1a32593da","modified":1712418786721},{"_id":"source/images/node-gateway-ssr-multi-version/arch.png","hash":"2e3b70aae25d01ec24cdb3dea9461cb2f8ccf6d5","modified":1712418786779},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.svg","hash":"0072b22f1e5424e3016a722a654e214e8736331c","modified":1712418786818},{"_id":"source/images/v8-libuv-timer-event-loop/loop_iteration.png","hash":"b1d06a5e6d9965267cbddc95219a325e85b3ad2b","modified":1712418789396},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg","hash":"2982f2cd7c06f1b14ca41db91c7092e9cc5206b4","modified":1712418786839},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg","hash":"2d29c5722ddaaa7cafa4bdee76c489a78fec439c","modified":1712418786864},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg","hash":"c830ac739f78b03a03377239257cebb87febd6d4","modified":1712418786865},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg","hash":"0e1b7775a6f0516481a363969e9ab4d37def3f54","modified":1712418786867},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg","hash":"e7f56cab7af9c047abc4272ad8c3409ead3ad663","modified":1712418786878},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg","hash":"750783ca8fea2c0f2bf16b77d68ffb9fb8a0fa08","modified":1712418786880},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg","hash":"d0e9ea419aaf7ea366bd1a4d9eb9689935f2305e","modified":1712418786881},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg","hash":"a3b2ef5a334b629fa4e18263b5b132abd5d16541","modified":1712418786883},{"_id":"source/images/bec/1.jpeg","hash":"3d518ead7f234d224ad987089dc9abbfc44914a7","modified":1712418786630},{"_id":"source/images/egg-boot/egg-boot.jpg","hash":"1929f0597221ba9d865bf88c8ebe18ab3b6a83a6","modified":1712418786648},{"_id":"source/images/js-capture-error/4.jpg","hash":"c2a26768421ef97bbfd6cf6e13484c93f622202b","modified":1712418786706},{"_id":"source/images/js-capture-error/10.jpg","hash":"990afee0f1c758900bbe01a93cb2713ce18f825b","modified":1712418786683},{"_id":"source/images/js-css-image-loading/1.png","hash":"199fffb885dde4ce13b60b4f1394be4206fc562e","modified":1712418786717},{"_id":"source/images/node-gateway-ssr-multi-version-2/1.png","hash":"331dd667abef0b0f1a680138ca4319c1864e5f3b","modified":1712418786746},{"_id":"source/images/node-gateway-ssr-multi-version-2/5.png","hash":"9d9f07ce088493e7f5ec6d2778b9f280449cf052","modified":1712418786758},{"_id":"source/images/node-gateway-ssr-multi-version-2/7.png","hash":"80635c4ee716fa39147380295e73923c9901a562","modified":1712418786763},{"_id":"source/images/node-gateway-ssr-multi-version-2/4.png","hash":"8e1aa316f3d112db8ea3fe37a0d15e3f54967bb4","modified":1712418786755},{"_id":"source/images/node-gateway-ssr-multi-version-2/6.png","hash":"7a38e0f64c4805abf2809c562f6db0e230cca314","modified":1712418786760},{"_id":"source/images/node-perf-heapdump-flame-graph/heapdump_01.png","hash":"c30667247e0244f0d0a6cf529da72a6449afe651","modified":1712418786790},{"_id":"source/images/node-gateway-ssr-multi-version-2/9.png","hash":"66961a537cbf40299d4ec34c83e0b31d8333699e","modified":1712418786768},{"_id":"source/images/summary-2019/1.png","hash":"655187e02155f10971fe9f163a66074550f29155","modified":1712418786833},{"_id":"source/images/nodejs-istio-k8s-docker/book-app.png","hash":"648f6fc10d7e088f30efb0ad0bb08e143737a3c1","modified":1712418786830},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg","hash":"4b152e2db8fcb10aba35c92f36aca475825f284a","modified":1712418786841},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg","hash":"7ff38eb37caee04ee91091a2e6ea0084510d505f","modified":1712418786842},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg","hash":"a68ab75a84afaf83421a2559f3a84c819b47aee4","modified":1712418786848},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg","hash":"c692bb49352bd50a4b37804626f7bebcc0d481b9","modified":1712418786847},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg","hash":"031da43506b73b3ff0029d9929c47021544e3a0d","modified":1712418786844},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg","hash":"f4aaa1e3fb2b886a0583785a8543d891c8f7a3ae","modified":1712418786862},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg","hash":"9b5ba7108e28db706c6df61d044fb38c2e099fb0","modified":1712418786874},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg","hash":"c057b812fe43486a785b397beea307be4bfab119","modified":1712418786876},{"_id":"source/images/monitor-hub/image-20200403185942130.png","hash":"1cd2b816b28379319621c6d5b64f226ff6854ed1","modified":1712418786737},{"_id":"source/images/node-gateway-ssr-multi-version-2/3.png","hash":"5493eaa9a3df170fff91e080b5f7046cbd27a76f","modified":1712418786752},{"_id":"source/images/node-gateway-ssr-multi-version-2/2.png","hash":"2d9ac1455f51d881dab34b7f3770fdcb541ec745","modified":1712418786749},{"_id":"source/images/node-gateway-ssr-multi-version-2/8.png","hash":"0116905756aee093403b80c67da5e6f9a0f97c59","modified":1712418786766},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_01.png","hash":"aa9e23b48cfc40528b142c19e019904fd84d2023","modified":1712418786783},{"_id":"source/images/v8-parser-compiler/not-change-types-1.png","hash":"fe446fdd1f610c3f19e6230e81b6c226ccc6de3f","modified":1712418789398},{"_id":"source/images/v8-parser-compiler/not-change-types-2.png","hash":"ab851928246605eb0bd616d6054a86174bec094c","modified":1712418789400},{"_id":"source/images/v8-parser-compiler/not-change-types-3.png","hash":"67f392afae56f849a98469156955c988019dd164","modified":1712418789402},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg","hash":"afe1491a544cebfb9f5a50d93b8ee9de7720d07c","modified":1712418786837},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg","hash":"52c555ae72305fb8b3d918ade392bc562324edbc","modified":1712418786850},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg","hash":"a7b3909cff8c02bbec4a0e574e571f144c3af3ff","modified":1712418786855},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg","hash":"3114758346437c5fb21de28f43defa51c8e8eb1e","modified":1712418786857},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg","hash":"7a56c40ea9699e56311d4dd521dc727e9389cb1d","modified":1712418786860},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg","hash":"89e1ce7b5ff9583c9c5c00bc333cc96b3621adc4","modified":1712418786869},{"_id":"source/images/js-capture-error/5.jpg","hash":"0582a343ea918d89bf3927a061e6f9fd34008755","modified":1712418786710},{"_id":"source/images/monitor-hub/image-20200403210837664.png","hash":"2310aeb85168982b8e83b167bebd97e25198a046","modified":1712418786742},{"_id":"source/images/node-perf-heapdump-flame-graph/connection_02.png","hash":"46096c60b811ac5f923bbc177369c54765b3f018","modified":1712418786787},{"_id":"source/images/v8-parser-compiler/parse-time.png","hash":"fb656e7b12618b464a89f55457ca4e10e74d0b61","modified":1712418789430},{"_id":"source/images/js-capture-error/1.png","hash":"dacb219805eddb286537551536ee485f06f2ee89","modified":1712418786679},{"_id":"source/images/v8-parser-compiler/parser-phase.png","hash":"e7a3a59548e4e12625198ccbc703aa43af26fe84","modified":1712418789434},{"_id":"source/images/v8-parser-compiler/parse-time-2.png","hash":"02e8ee4c9774696248b101f0b161163209ec5cfa","modified":1712418789416},{"_id":"source/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg","hash":"ceaefc338091cf00f390566f1bee28a85307d22b","modified":1712418786872},{"_id":"source/images/nodejs-istio-k8s-docker/arch.jpg","hash":"b75734a1049f76fa33c9e26f4864da33d3876df9","modified":1712418786828},{"_id":"source/images/node-gateway-ssr-multi-version-2/FE-Schedule.pptx","hash":"894b98ec3d7f55f242212b393526e3fb8d7ca3ca","modified":1712418786777},{"_id":"source/images/travel-zhoushan/travel-zhoushan-23.png","hash":"0b220b29e01c603619cc0e43ecf8188e2f1bbc5b","modified":1712418787604},{"_id":"source/images/travel-zhoushan/travel-zhoushan-32.png","hash":"7bc5f30bc360006afd5c9a9b5db45e64dcffc90d","modified":1712418787927},{"_id":"source/images/v8-parser-compiler/parse-time-1.png","hash":"47aa703918420af77205acd2dad7f60749266a16","modified":1712418789411},{"_id":"source/images/lighthouse/report.png","hash":"12d66e89769f29802519f68f399255e931247b36","modified":1712418786732},{"_id":"source/images/travel-zhoushan/travel-zhoushan-16.png","hash":"5104979e08693d7777c21afc3bd90aaeae487acd","modified":1712418787367},{"_id":"source/images/travel-zhoushan/travel-zhoushan-03.png","hash":"a5353d5d6952bfbc9ab32ff08cace44deef3c9f7","modified":1712418786952},{"_id":"source/images/travel-zhoushan/travel-zhoushan-01.png","hash":"c82df63b6f3873c4495430971ecad76fa44afd62","modified":1712418786903},{"_id":"source/images/travel-zhoushan/travel-zhoushan-12.jpg","hash":"f379cdb4ac2109ffe2d1d016950620c7d1c17b47","modified":1712418787323},{"_id":"source/images/js-capture-error/2.jpg","hash":"75a01876e36c3470e2589b8f3c30bb55b20e1a9e","modified":1712418786703},{"_id":"source/images/travel-zhoushan/travel-zhoushan-13.jpg","hash":"16ad58171a226cfb0e00f26ec53bb62ba3f684c7","modified":1712418787336},{"_id":"source/images/v8-parser-compiler/v8-pare-compile-cost.png","hash":"ec6e1f86d094fae4a15102a24ceae28e1a76b71d","modified":1712418789465},{"_id":"source/images/node-perf-heapdump-flame-graph/node-flamegraph.png","hash":"444d87431a45f3e4c6ca2d2511de8e0cd12e7d1b","modified":1712418786816},{"_id":"source/images/travel-zhoushan/travel-zhoushan-29.jpg","hash":"348566a2036e2cc505f1a1bb5913e159f2e485dd","modified":1712418787831},{"_id":"source/images/traveling-to-the-philippines/27.jpg","hash":"4e15125876b160a47f66fe0835fb26efcc37e456","modified":1712418788813},{"_id":"source/images/travel-zhoushan/travel-zhoushan-15.mp4","hash":"43cd9598df59af319fe3e010b53965c700cf16c8","modified":1712418787355},{"_id":"source/images/traveling-to-the-philippines/26.jpg","hash":"17d6879785c31dc08c8625d2b54672c277e880ae","modified":1712418788777},{"_id":"source/images/traveling-to-the-philippines/2.jpg","hash":"3d1b5fe7a18c3b157d7a76931a24134516f1df2b","modified":1712418788469},{"_id":"source/images/traveling-to-the-philippines/13.jpg","hash":"86666ad42e2c18f8df3b3bb438e383e7aab19b26","modified":1712418788159},{"_id":"source/images/traveling-to-the-philippines/25.jpg","hash":"fb8326a57bddda0a8ff03966041b78d335019441","modified":1712418788736},{"_id":"source/images/travel-zhoushan/travel-zhoushan-04.jpg","hash":"cf166199ee1d541d0456d7061aeb3100dbb7c7ff","modified":1712418786988},{"_id":"source/images/traveling-to-the-philippines/11.jpg","hash":"f2f6843fb714053053631e0d60f4a84e93b130f1","modified":1712418788088},{"_id":"source/images/traveling-to-the-philippines/6.jpg","hash":"afb158c4f30418d27c35298e833bc4c5aecbbe14","modified":1712418789231},{"_id":"source/images/travel-zhoushan/travel-zhoushan-26.jpg","hash":"0dd35c9e96125c3ab6e40157b3f8070b288d7e3b","modified":1712418787725},{"_id":"source/images/traveling-to-the-philippines/9.jpg","hash":"c1425a41b66d74ab1608a45f63f486640a4c2072","modified":1712418789391},{"_id":"source/images/traveling-to-the-philippines/12.jpg","hash":"dcb70fbb7bf5e0b9419d74e3cdfdc45052eb19a1","modified":1712418788125},{"_id":"source/images/traveling-to-the-philippines/34.jpg","hash":"5dc39ae840f701145ec5f0fbbcb56615781f5233","modified":1712418789149},{"_id":"source/images/travel-zhoushan/travel-zhoushan-24.jpg","hash":"264c7a63264ee5332738b3a99817989b38a61819","modified":1712418787642},{"_id":"source/images/travel-zhoushan/travel-zhoushan-28.jpg","hash":"587f64edad989dcfeaff693ff755916335b54c94","modified":1712418787804},{"_id":"source/images/traveling-to-the-philippines/17.jpg","hash":"3eefa5a106856f685427d3a7322841b7ebcd36cb","modified":1712418788357},{"_id":"source/images/traveling-to-the-philippines/23.jpg","hash":"eb7a3d220d5870d49a34d54a8dd53f2774eeffc2","modified":1712418788653},{"_id":"source/images/traveling-to-the-philippines/3.jpg","hash":"a505e8b86786f108e626d482c08774e46920139d","modified":1712418788941},{"_id":"source/images/traveling-to-the-philippines/4.jpg","hash":"e0631786797fea0feb1e84ff174270f792eb4255","modified":1712418789193},{"_id":"source/images/travel-zhoushan/travel-zhoushan-17.jpg","hash":"8fe28b82a34569ceb18913b5dc795dd8d56deabb","modified":1712418787404},{"_id":"source/images/travel-zhoushan/travel-zhoushan-31.jpg","hash":"c6ccb78e1da3bcd0279af135a504bbbb11ea646a","modified":1712418787909},{"_id":"source/images/traveling-to-the-philippines/14.jpg","hash":"d4fb952d4f8ce6df905c4e3304308807722ded7d","modified":1712418788206},{"_id":"source/images/traveling-to-the-philippines/20.jpg","hash":"68f8036efb53cae3adf8bc445a6f30897b5ed234","modified":1712418788494},{"_id":"source/images/travel-zhoushan/travel-zhoushan-05.jpg","hash":"d7fe5055a1f180956e681e38beb49898238b3963","modified":1712418787038},{"_id":"source/images/travel-zhoushan/travel-zhoushan-27.jpg","hash":"675b38ad451c65f8df5b8aaa7b47a1448a4f0a5d","modified":1712418787766},{"_id":"source/images/traveling-to-the-philippines/30.jpg","hash":"83c2db4773744d39f66c1d52e51f53971c5afcaf","modified":1712418788991},{"_id":"source/images/traveling-to-the-philippines/31.jpg","hash":"69d4edc45e6f4e40d31b51351555b91013a44510","modified":1712418789026},{"_id":"source/images/travel-zhoushan/travel-zhoushan-19.jpg","hash":"b55c1563ed9bc5306277b6d41f009524849d246a","modified":1712418787486},{"_id":"source/images/travel-zhoushan/travel-zhoushan-09.jpg","hash":"cc60d174362ec7d60e0c11d9dc45d0dc7ba96e4c","modified":1712418787244},{"_id":"source/images/travel-zhoushan/travel-zhoushan-30.jpg","hash":"5168ee4903f6891ecc6dee81c9071ea5cd4d9f11","modified":1712418787871},{"_id":"source/images/traveling-to-the-philippines/32.jpg","hash":"42a513f3038d178f52ec6601da1ce74d93cee165","modified":1712418789070},{"_id":"source/images/traveling-to-the-philippines/1.jpg","hash":"b1fa05a24083c98a28b934344f1bdf5a67df06f0","modified":1712418787994},{"_id":"source/images/travel-zhoushan/travel-zhoushan-08.jpg","hash":"7a667808d1aa7684164259cdda466bb62ca1f617","modified":1712418787202},{"_id":"source/images/travel-zhoushan/travel-zhoushan-18.jpg","hash":"b0891f3a3b64bb64155cc7d417b9679660ebb589","modified":1712418787444},{"_id":"source/images/travel-zhoushan/travel-zhoushan-20.jpg","hash":"7c43901d421c36aa2ccd048867db904ff86e5f91","modified":1712418787525},{"_id":"source/images/travel-zhoushan/travel-zhoushan-25.jpg","hash":"770bab21f8890fb3951f97efcd2d3147e19d6b87","modified":1712418787683},{"_id":"source/images/traveling-to-the-philippines/10.jpg","hash":"0b2f9ef30a378d3af94492a9f5472bb365a4f61a","modified":1712418788049},{"_id":"source/images/traveling-to-the-philippines/29.jpg","hash":"416513cc33a1ee5c5290fca1dcc6bf1dde2f837b","modified":1712418788893},{"_id":"source/images/traveling-to-the-philippines/8.jpg","hash":"472272b727cb7da43edde1d504f983e6fc34ad8c","modified":1712418789335},{"_id":"source/images/travel-zhoushan/travel-zhoushan-10.jpg","hash":"f07e56dbb331068eb3330448f53fa1e79774a553","modified":1712418787279},{"_id":"source/images/traveling-to-the-philippines/28.jpg","hash":"0c26af42740f5c1579efb1afecfff73cf0a6fee6","modified":1712418788848},{"_id":"source/images/travel-zhoushan/travel-zhoushan-21.jpg","hash":"52ecd7fb0a5f963a8127590591d4a3850b1dec75","modified":1712418787560},{"_id":"source/images/traveling-to-the-philippines/24.jpg","hash":"e487c3820c05646939bf32c0ee75c8d297230442","modified":1712418788688},{"_id":"source/images/travel-zhoushan/travel-zhoushan-06.jpg","hash":"4b52d8525264fa7c2b0b115fedb60f3e58ae7332","modified":1712418787096},{"_id":"source/images/traveling-to-the-philippines/16.jpg","hash":"d8049cceba3e0e37b60227071c6e832d330c6ce8","modified":1712418788301},{"_id":"source/images/traveling-to-the-philippines/7.jpg","hash":"1a58dcad2808f5d5973c6b9095bc7e70b10a77eb","modified":1712418789288},{"_id":"source/images/travel-zhoushan/travel-zhoushan-11.jpg","hash":"92cc948f3787754e4787ad08370236a40bde67bb","modified":1712418787312},{"_id":"source/images/travel-zhoushan/travel-zhoushan-02.jpg","hash":"a09fa91e40653b84356bf9ef283e3e712518e4c4","modified":1712418786939},{"_id":"source/images/traveling-to-the-philippines/15.jpg","hash":"1236ad3788f5f58a9a2bf0e739e72aeecf78a7a4","modified":1712418788248},{"_id":"source/images/traveling-to-the-philippines/33.jpeg","hash":"0c442a5b7cd93eec6e56c59e814d97361121c238","modified":1712418789106},{"_id":"source/images/travel-zhoushan/travel-zhoushan-07.jpg","hash":"5ab19fbe4f011e2a77a4932912d0edcdfb577ae3","modified":1712418787155},{"_id":"source/images/traveling-to-the-philippines/22.jpg","hash":"2e0e76e19e6b3224f5aef6666853fc76bec5e040","modified":1712418788613},{"_id":"source/images/travel-zhoushan/travel-zhoushan-22.jpg","hash":"84c28148493d37d9dbaa050866af2498b64a54e3","modified":1712418787595},{"_id":"source/images/traveling-to-the-philippines/21.jpg","hash":"4c6034c62b008a531593252d4a0dacfd6afe7a5b","modified":1712418788537},{"_id":"source/images/traveling-to-the-philippines/19.jpg","hash":"1d7e6d3b9652d43eb331c2a65201339c0d6c6544","modified":1712418788432},{"_id":"public/baidu_urls.txt","hash":"19db4185cd2d06f0e4ed34f0d4d03b426e22ed37","modified":1731161526278},{"_id":"public/baidusitemap.xml","hash":"cb942db6a9908f8c152006add5ba8523921d6d0d","modified":1731161526278},{"_id":"public/content.json","hash":"b4e39c803db6c9330b6c4923d7ab94a6d4842fe9","modified":1731161526278},{"_id":"public/2024/11/06/me/index.html","hash":"0f98d8b0de8130ae0268f09ccac725a47690cef6","modified":1731161526278},{"_id":"public/2020/11/06/monitorEventLoopDelay-libuv-uv-timer-start/index.html","hash":"af21fe82e84476b914f350153f6ded1375541c86","modified":1731161526278},{"_id":"public/2024/05/15/20240514-dream/index.html","hash":"2d1badb33d16ed6072146747423b6c9915efc97e","modified":1731161526278},{"_id":"public/2020/11/04/node-gateway-ssr-multi-version-2/index.html","hash":"5a6708e1177f69a22f30b088d1bf69f4b9623e0c","modified":1731161526278},{"_id":"public/2020/09/28/debug-libuv/index.html","hash":"7df0d8b319ec7e2db5ee887d6e448b4dd7a95f43","modified":1731161526278},{"_id":"public/2020/09/02/ssr-nodejs-thread-test/index.html","hash":"d1a023744bd06c31488661d0e28f296d67c8d727","modified":1731161526278},{"_id":"public/2020/08/16/coder-painter/index.html","hash":"aaac1521f03a288874e02b707901a78895ed3f7b","modified":1731161526278},{"_id":"public/2020/07/07/lighthouse/index.html","hash":"9e6348cc3dae2361b6fdc5441f0d806b39ab3b5a","modified":1731161526278},{"_id":"public/2020/11/09/icestark-sandbox/index.html","hash":"1503379b9717dee9971c063217b43d7d285b7399","modified":1731161526278},{"_id":"public/2020/06/29/node-gateway-ssr-multi-version/index.html","hash":"be24f9f80cd785c57b138ce789152214fa383ba3","modified":1731161526278},{"_id":"public/2020/05/03/node-js-net-cluster-fork/index.html","hash":"5524ba052533d17faa3a7df474b9e2ecee2085e7","modified":1731161526278},{"_id":"public/2020/06/28/nodejs-istio-k8s-docker/index.html","hash":"d1f225871f9a982f71fb20aa97b5678de9624e73","modified":1731161526278},{"_id":"public/2020/04/06/child_process-exec-fork-spawn/index.html","hash":"38008a754092616387316c503c7207069d21f6be","modified":1731161526278},{"_id":"public/2020/02/21/node-perf-heapdump-flame-graph/index.html","hash":"d9115ec68b11f57ebe97893e46293f50944dda83","modified":1731161526278},{"_id":"public/2020/02/08/v8-parser-compiler-javascript/index.html","hash":"dd66aca60407b9dc900fe89d067762e308d067e1","modified":1731161526278},{"_id":"public/2020/01/22/express-gateway/index.html","hash":"aa2ba54a39dd8ca0eb8b11ba960a1d1f74e46e7c","modified":1731161526278},{"_id":"public/2019/12/30/summary-2019/index.html","hash":"28c85995a4b7880e14317579d54b4613b467613f","modified":1731161526278},{"_id":"public/2020/04/03/monitor-hub/index.html","hash":"2ae35ab1cb7dd823ef5b815d0a7e520af2a5b6fa","modified":1731161526278},{"_id":"public/2019/10/06/travel-zhoushan/index.html","hash":"96becfc6e92dd25b7daf95f091d79abf6867965e","modified":1731161526278},{"_id":"public/2019/06/19/bec/index.html","hash":"0ac74ccfb652776e62c44c2c066189382d21fe1d","modified":1731161526278},{"_id":"public/2018/11/17/vue-component-extends/index.html","hash":"f386d14636c614d268f73974222d96d50735bc6a","modified":1731161526278},{"_id":"public/2020/03/01/v8-libuv-timer-event-loop/index.html","hash":"60876cf501b9dcffe2553324c9a7a9a10d98c4c0","modified":1731161526278},{"_id":"public/2018/09/24/traveling-to-the-philippines/index.html","hash":"1d224d4e06f2345625bc7474430fa19867605365","modified":1731161526278},{"_id":"public/2018/09/24/js-css-image-loading/index.html","hash":"658c0db56a610ae2b9248ae2a9357e8af9fd621e","modified":1731161526278},{"_id":"public/2019/05/09/egg-boot/index.html","hash":"0cbb1d54429c14c6a3b9b06bf1b619dd4924b4c8","modified":1731161526278},{"_id":"public/2018/07/20/the-quality-of-a-company-first-look-at-HR-department/index.html","hash":"7d1e8aa174770526bf0c954b1ee8c47ea4d8736b","modified":1731161526278},{"_id":"public/categories/work/index.html","hash":"5cf9ffda68ce4d52c2c93c922c6644cbe3fcc90b","modified":1731161526278},{"_id":"public/2018/10/23/js-capture-error/index.html","hash":"f22b84c0c784bfec28c2128bbc5233269c566adb","modified":1731161526278},{"_id":"public/categories//index.html","hash":"fa58471183a3928de96c4d180fbda115c5238a62","modified":1731161526278},{"_id":"public/categories/JavaScript/index.html","hash":"13fac026cbd51fba93137583d4e8eefb658d0f47","modified":1731161526278},{"_id":"public/2019/01/18/egg-cluster/index.html","hash":"335b3349706d67a7fb54fafae4ea2eb7691eec3d","modified":1731161526278},{"_id":"public/categories/JavaScript/page/2/index.html","hash":"87f89e8e8185f7c766bd1ddc23fe609630ac559e","modified":1731161526278},{"_id":"public/categories//index.html","hash":"81805c111b66618c728f212fcbc2dd3836fbe9c2","modified":1731161526278},{"_id":"public/categories//index.html","hash":"6e90cc6caf68836da86234fba62ca8e8d0c51531","modified":1731161526278},{"_id":"public/index.html","hash":"8cfbcbfe597e9ea78b3e78de136072911146dc9e","modified":1731161526278},{"_id":"public/categories/C-C/index.html","hash":"4db4d2c9525ee9120577fc1f583ce1b323164e55","modified":1731161526278},{"_id":"public/page/2/index.html","hash":"3a69aebcc7082f569c43e6bf190b7b84b1af2d6b","modified":1731161526278},{"_id":"public/page/3/index.html","hash":"fb94f518f633d67cf12b8acb4bc895cee0509f4f","modified":1731161526278},{"_id":"public/page/4/index.html","hash":"e9eb77bcbc38e63fc799eb0436ea0220293bdf8d","modified":1731161526278},{"_id":"public/archives/index.html","hash":"8eabf47752a373372a121d879781a6393e3a257f","modified":1731161526278},{"_id":"public/archives/page/2/index.html","hash":"8a4c39f7f849ffb689e6a0adacd11300ea6d676f","modified":1731161526278},{"_id":"public/categories/travel/index.html","hash":"7ce0499f9a3a2e094a3358b3080114b7ed885c0e","modified":1731161526278},{"_id":"public/archives/page/3/index.html","hash":"9cacb03a6864b27c093e6e913e89b466adc8c8e6","modified":1731161526278},{"_id":"public/page/5/index.html","hash":"007c8d820a2f06a5bf48c8403a2423c73f644d34","modified":1731161526278},{"_id":"public/page/6/index.html","hash":"16d6cc17c8a44fab1d500d4f51aa624779d4bcc9","modified":1731161526278},{"_id":"public/archives/2018/09/index.html","hash":"75b133f4913de157b6bd15745465b44e2062e789","modified":1731161526278},{"_id":"public/archives/2018/07/index.html","hash":"e2da53b74cc6e7de1e1120baa9a59da341b1a9e0","modified":1731161526278},{"_id":"public/archives/2018/11/index.html","hash":"3d57320bc28ffe92af60364a1c4377b0f1ba133c","modified":1731161526278},{"_id":"public/archives/2019/index.html","hash":"ecbc5a5918416f7fd699a7b1c592049e0fbc5f28","modified":1731161526278},{"_id":"public/archives/2018/10/index.html","hash":"5640750bc455d3d5bb03ebb807c2b85637fa55ad","modified":1731161526278},{"_id":"public/archives/2019/01/index.html","hash":"deca80d83aa973d4cfea92727b4f9c8b8fc16b19","modified":1731161526278},{"_id":"public/archives/2019/05/index.html","hash":"066de27f06528b01de0e1e22dc31b1d282fbc226","modified":1731161526278},{"_id":"public/archives/2019/06/index.html","hash":"3667ab7b0ffaecb1e2a95627e389d42ced5d369c","modified":1731161526278},{"_id":"public/archives/2019/10/index.html","hash":"6e3fef5c796cdeee11ee982f2c05c4a307daf935","modified":1731161526278},{"_id":"public/archives/2018/index.html","hash":"f7666b1bc08fb8cacfd5f3969154c9c280caaac6","modified":1731161526278},{"_id":"public/archives/2019/12/index.html","hash":"4bd77994109643ea508a1c110933dbda18b003e9","modified":1731161526278},{"_id":"public/archives/2020/index.html","hash":"cb21be731cc8a59d283cdc7a019bebc3d61785f5","modified":1731161526278},{"_id":"public/archives/2020/page/2/index.html","hash":"24085d1203679e96c6db16f8c14d15d70e20fe0c","modified":1731161526278},{"_id":"public/archives/2020/01/index.html","hash":"5048f9991a058bc0bc216e0933be0a5936103794","modified":1731161526278},{"_id":"public/archives/2020/02/index.html","hash":"acd921257fe045d54f9df76c9eeb77e009434db5","modified":1731161526278},{"_id":"public/archives/2020/03/index.html","hash":"2a949edddf3b878df2e0275b1ef24e8968ed3d07","modified":1731161526278},{"_id":"public/archives/2020/04/index.html","hash":"df660a2989e9428fe155d66bbcca1a60e5536007","modified":1731161526278},{"_id":"public/archives/2020/06/index.html","hash":"dae72ced10e144345596c03d28a983b5501e7bd3","modified":1731161526278},{"_id":"public/archives/2020/07/index.html","hash":"aee77ab43f7f57e7d0507d345bcd383803f99f84","modified":1731161526278},{"_id":"public/archives/2020/08/index.html","hash":"7c432e156ed3bbfeaf30ef6676d9ccd4dbc045d9","modified":1731161526278},{"_id":"public/archives/2024/index.html","hash":"9047ae03d9506300b175e94558183ea6530d85dc","modified":1731161526278},{"_id":"public/archives/2024/05/index.html","hash":"bf033916d82b511f465ba60c040f89b958b1d604","modified":1731161526278},{"_id":"public/archives/2024/11/index.html","hash":"d4803f3909d1be6fb1a32f93850a57f3dfef419f","modified":1731161526278},{"_id":"public/tags/life/index.html","hash":"cd34bf8ef0b5ff64a4a46c0eee820dfc86089334","modified":1731161526278},{"_id":"public/archives/2020/05/index.html","hash":"beba12ca27070f91db20df69da980e8cf2bca2c9","modified":1731161526278},{"_id":"public/archives/2020/09/index.html","hash":"ac5f4baa253046a571954fafdbcd6d959d0e50ed","modified":1731161526278},{"_id":"public/archives/2020/11/index.html","hash":"d0a4c8999378068b0dd935845b91fd98b2fc6be2","modified":1731161526278},{"_id":"public/tags/Node-js/index.html","hash":"2c2bbdca4d595301fa5ea7d3400037a6b827ad11","modified":1731161526278},{"_id":"public/tags/Node-js/page/2/index.html","hash":"2967d80b471a469a01ee80bbbc73a5a4c1cf5639","modified":1731161526278},{"_id":"public/tags//index.html","hash":"bb23ace3a23b56ba7d858fe6fd3b138cfe586738","modified":1731161526278},{"_id":"public/tags/JavaScript/index.html","hash":"3e9455aa3a7fae16eca734f5b76b17e3c1fbe37b","modified":1731161526278},{"_id":"public/tags/Web/index.html","hash":"7ffcc539316ecf49760b2c9abc37b822e63348f1","modified":1731161526278},{"_id":"public/tags//index.html","hash":"a9ae2f83cc59e8b35410200bd987f1ff0ac840c0","modified":1731161526278},{"_id":"public/tags/libuv/index.html","hash":"2dff825caab49a938159bfc390e9b54546de2129","modified":1731161526278},{"_id":"public/tags//index.html","hash":"7847ac845bf327e901c87213b54fc6ac38a1dbdc","modified":1731161526278},{"_id":"public/tags/V8/index.html","hash":"042f3c1a9f497c4d8acb54c09e306a7027b0ce0a","modified":1731161526278},{"_id":"public/categories/index.html","hash":"2be9684da29a2b4030a749d5937ec80a8677d4d0","modified":1731161526278},{"_id":"public/tags/SSR/index.html","hash":"0dc30aa0b55b866b9a28b38b5cf4a6fad082de95","modified":1731161526278},{"_id":"public/tags//index.html","hash":"5972eda8edf88d29cc9bb8a0e3ec8795f59037e8","modified":1731161526278},{"_id":"public/tags/index.html","hash":"04028818fa7720232f2e351846ea52f74f0ed821","modified":1731161526278},{"_id":"public/tags//index.html","hash":"5dd992e27e6be4157478bf969d13081557829e2a","modified":1731161526278},{"_id":"public/css/style.css","hash":"51a26c4b4b67f701e780a11fdbe2ce193d2b13ae","modified":1731161526278}],"Category":[{"name":"work","_id":"cm3a45wdm000218fdemr5cdmp"},{"name":"","_id":"cm3a45wdt000718fd8jmtcqq6"},{"name":"","_id":"cm3a45wdx000d18fdfmuc3seo"},{"name":"JavaScript","_id":"cm3a45we0000j18fdezycd5dy"},{"name":"C/C++","_id":"cm3a45we3000o18fdcnlxeuzn"},{"name":"travel","_id":"cm3a45wem001w18fdhy506zak"},{"name":"","_id":"cm3a45wez003718fd0rzr3ex9"}],"Data":[],"Page":[],"Post":[{"title":"Set A Flag","date":"2019-06-19T05:30:00.000Z","_content":"##### Practice speaking and listening, pass the BEC exam.\n\n\n![book1](/images/bec/1.jpeg)\n![book2](/images/bec/2.jpeg)\n","source":"_posts/bec.md","raw":"---\ntitle: Set A Flag\ncategory: work\ndate: 2019-06-19T13:30:00.000Z\n---\n##### Practice speaking and listening, pass the BEC exam.\n\n\n![book1](/images/bec/1.jpeg)\n![book2](/images/bec/2.jpeg)\n","slug":"bec","published":1,"updated":"2024-04-06T15:53:06.594Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wdc000018fd7nynekj9","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><h5 id=\"Practice-speaking-and-listening-pass-the-BEC-exam\"><a href=\"#Practice-speaking-and-listening-pass-the-BEC-exam\" class=\"headerlink\" title=\"Practice speaking and listening, pass the BEC exam.\"></a>Practice speaking and listening, pass the BEC exam.</h5><p><img src=\"/images/bec/1.jpeg\" alt=\"book1\"><br><img src=\"/images/bec/2.jpeg\" alt=\"book2\"></p>\n</body></html>","_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"","more":"<h5 id=\"Practice-speaking-and-listening-pass-the-BEC-exam\"><a href=\"#Practice-speaking-and-listening-pass-the-BEC-exam\" class=\"headerlink\" title=\"Practice speaking and listening, pass the BEC exam.\"></a>Practice speaking and listening, pass the BEC exam.</h5><p><img src=\"/images/bec/1.jpeg\" alt=\"book1\"><br><img src=\"/images/bec/2.jpeg\" alt=\"book2\"></p>\n"},{"title":"20240514-","date":"2024-05-15T02:03:19.000Z","keywords":",","description":"iPad","_content":"## \n\n\n## \niPad\n\n<br>\n\n*Blog*\n","source":"_posts/20240514-dream.md","raw":"---\ntitle: 20240514-\ndate: 2024-05-15 10:03:19\ncategory: \ntags: \n    - life\nkeywords: ,\ndescription: iPad\n---\n## \n\n\n## \niPad\n\n<br>\n\n*Blog*\n","slug":"20240514-dream","published":1,"updated":"2024-11-09T11:40:12.876Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wdj000118fd0whhbcta","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>iPad</p>\n<br>\n\n<p><em>Blog</em></p>\n</body></html>","_categories":[{"name":"","path":"categories//"}],"_tags":[{"name":"life","path":"tags/life/"}],"excerpt":"","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>iPad</p>\n<br>\n\n<p><em>Blog</em></p>\n"},{"title":"","keywords":",,","description":"","date":"2020-08-16T07:32:03.586Z","_content":"\n## \n\n\n\n\n\n github ********````\n\n Code Review ****\n\n<!-- more -->\n\n## \n\n\n\n****\n\n-  `if-else` \n-  `Ctrl + C`  `Ctrl + V`\n- \n  ......\n\n TA  IE  IE \n\n## \n\n 3  Q \n\n## \n\n\n\n\n\n- \n- \n- \n- \n- \n- \n\n\n\n- \n- \n-  UI \n- \n- \n\n## \n\n| \n\n````\n\n\n\n\n\n## \n\n\n\n\n\n\n","source":"_posts/coder-painter.md","raw":"---\ntitle: \ncategory: \nkeywords: ,,\ndescription: \ntags:\n\t- \ndate: 2020-08-16T15:32:03.586Z\n---\n\n## \n\n\n\n\n\n github ********````\n\n Code Review ****\n\n<!-- more -->\n\n## \n\n\n\n****\n\n-  `if-else` \n-  `Ctrl + C`  `Ctrl + V`\n- \n  ......\n\n TA  IE  IE \n\n## \n\n 3  Q \n\n## \n\n\n\n\n\n- \n- \n- \n- \n- \n- \n\n\n\n- \n- \n-  UI \n- \n- \n\n## \n\n| \n\n````\n\n\n\n\n\n## \n\n\n\n\n\n\n","slug":"coder-painter","published":1,"updated":"2024-04-08T13:38:56.342Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wdo000318fd5es8aahd","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p></p>\n<p> github <strong></strong><strong></strong><code></code><code></code></p>\n<p> Code Review <strong></strong></p>\n<span id=\"more\"></span>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p><strong></strong></p>\n<ul>\n<li> <code>if-else</code> </li>\n<li> <code>Ctrl + C</code>  <code>Ctrl + V</code></li>\n<li><br></li>\n</ul>\n<p> TA  IE  IE </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p> 3  Q </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li> UI </li>\n<li></li>\n<li></li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>| </p>\n<p><code></code><code></code></p>\n<p></p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p></p>\n<p></p>\n</body></html>","_categories":[{"name":"","path":"categories//"}],"_tags":[{"name":"","path":"tags//"}],"excerpt":"<html><head></head><body><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p></p>\n<p> github <strong></strong><strong></strong><code></code><code></code></p>\n<p> Code Review <strong></strong></p></body></html>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p><strong></strong></p>\n<ul>\n<li> <code>if-else</code> </li>\n<li> <code>Ctrl + C</code>  <code>Ctrl + V</code></li>\n<li><br></li>\n</ul>\n<p> TA  IE  IE </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p> 3  Q </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li> UI </li>\n<li></li>\n<li></li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>| </p>\n<p><code></code><code></code></p>\n<p></p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p></p>\n<p></p>"},{"title":"Node.js","keywords":"Node.js,,Node.js","description":"Node.js child_process, execexecFileforkspawncluster, fork","date":"2020-04-06T00:09:36.472Z","_content":"\n**Node.js **\n\n**child_process**\n\n- [exec](http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback):  shell  shell  `command` 1024\\*1024 \n- [execFile](http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback): `exec` shell `file` `exec` `exec` 1024\\*1204 \n- [fork](http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options):  `spawn` Node.js  `spawn``ChildProcess` `ChildProcess`\n- [spawn](http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options):  spawn \n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): \n\n<!-- more -->\n\n<br/>\n\n### ****\n\n[libuv & Node.js EventLoop ](https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/)\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**child_process**\n\n```javascript\nNode \n  - lib \n  \t- internal \n  \t\t- child_process.js \n  \t- child_process.js;\n```\n\n`lib/child_process.js``exec``execFile``fork``spawn``lib/internal/child_process.js``spawn`\n\n<br/>\n\n**exec**\n\n```javascript\n// lib/child_process.js\nfunction exec(command, options, callback) {\n  const opts = normalizeExecArgs(command, options, callback);\n  return module.exports.execFile(opts.file, opts.options, opts.callback);\n}\nfunction normalizeExecArgs(command, options, callback) {\n  if (typeof options === \"function\") {\n    callback = options;\n    options = undefined;\n  }\n\n  // Make a shallow copy so we don't clobber the user's options object.\n  options = { ...options };\n  options.shell = typeof options.shell === \"string\" ? options.shell : true;\n\n  return {\n    file: command,\n    options: options,\n    callback: callback,\n  };\n}\n```\n\n exec `shell` execFile \n\n<br/>\n\n**execFile**\n\n```javascript\n// lib/child_process.js\nfunction execFile(file /* , args, options, callback */) {\n  let args = [];\n  let callback;\n  let options;\n\n  // ...\n\n  options = {\n    encoding: \"utf8\",\n    timeout: 0,\n    maxBuffer: MAX_BUFFER,\n    killSignal: \"SIGTERM\",\n    cwd: null,\n    env: null,\n    shell: false, // execFile shell\n    ...options,\n  };\n\n  // spawn\n  const child = spawn(file, args, {\n    cwd: options.cwd,\n    env: options.env,\n    gid: options.gid,\n    uid: options.uid,\n    shell: options.shell,\n    windowsHide: !!options.windowsHide,\n    windowsVerbatimArguments: !!options.windowsVerbatimArguments,\n  });\n\n  var encoding;\n  const _stdout = []; // \n  const _stderr = []; // \n  // ...\n  var stdoutLen = 0; // \n  var stderrLen = 0; // \n  var killed = false; // \n  var exited = false; // \n  var timeoutId; // \n\n  var ex = null; // \n\n  var cmd = file; // \n\n  // \n  function exithandler(code, signal) {\n    if (exited) return;\n    exited = true;\n\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      timeoutId = null;\n    }\n\n    if (!callback) return;\n\n    // merge chunks\n    var stdout;\n    var stderr;\n    if (encoding || (child.stdout && child.stdout.readableEncoding)) {\n      stdout = _stdout.join(\"\");\n    } else {\n      stdout = Buffer.concat(_stdout); //  encoding Buffer\n    }\n    if (encoding || (child.stderr && child.stderr.readableEncoding)) {\n      stderr = _stderr.join(\"\");\n    } else {\n      stderr = Buffer.concat(_stderr); //  encoding Buffer\n    }\n\n    if (!ex && code === 0 && signal === null) {\n      callback(null, stdout, stderr); // \n      return;\n    }\n\n    if (args.length !== 0) cmd += ` ${args.join(\" \")}`;\n\n    if (!ex) {\n      // eslint-disable-next-line no-restricted-syntax\n      ex = new Error(\"Command failed: \" + cmd + \"\\n\" + stderr);\n      ex.killed = child.killed || killed;\n      ex.code = code < 0 ? getSystemErrorName(code) : code;\n      ex.signal = signal;\n    }\n\n    ex.cmd = cmd;\n    callback(ex, stdout, stderr); // \n  }\n\n  function errorhandler(e) {\n    ex = e;\n\n    // child.stdout  child.stderr \n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    exithandler();\n  }\n\n  function kill() {\n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    killed = true;\n    try {\n      child.kill(options.killSignal);\n    } catch (e) {\n      ex = e;\n      exithandler();\n    }\n  }\n\n  // \n  if (options.timeout > 0) {\n    timeoutId = setTimeout(function delayedKill() {\n      kill();\n      timeoutId = null;\n    }, options.timeout);\n  }\n\n  if (child.stdout) {\n    if (encoding) child.stdout.setEncoding(encoding);\n\n    child.stdout.on(\"data\", function onChildStdout(chunk) {\n      const encoding = child.stdout.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stdoutLen += length; // \n\n      if (stdoutLen > options.maxBuffer) {\n        // \n        const truncatedLen = options.maxBuffer - (stdoutLen - length);\n        _stdout.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stdout\");\n        kill();\n      } else {\n        _stdout.push(chunk); // chunk\n      }\n    });\n  }\n\n  // child.stdout\n  if (child.stderr) {\n    if (encoding) child.stderr.setEncoding(encoding);\n\n    child.stderr.on(\"data\", function onChildStderr(chunk) {\n      const encoding = child.stderr.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stderrLen += length;\n\n      if (stderrLen > options.maxBuffer) {\n        const truncatedLen = options.maxBuffer - (stderrLen - length);\n        _stderr.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stderr\");\n        kill();\n      } else {\n        _stderr.push(chunk);\n      }\n    });\n  }\n\n  child.addListener(\"close\", exithandler);\n  child.addListener(\"error\", errorhandler);\n\n  return child;\n}\n```\n\n`exec``execFile``shell``child.stderr.on('data')``child.stdout.on('data')`\n\n`_stderr``_stdout`\n\n**`spawn`**\n\n<br/>\n\n**fork**\n\n```javascript\n// lib/child_process.js\nfunction fork(modulePath /* , args, options */) {\n  // Get options and args arguments.\n  var execArgv;\n  var options = {};\n  var args = [];\n\n  // ...\n\n  // forkstdioipc\n  if (typeof options.stdio === \"string\") {\n    options.stdio = stdioStringToArray(options.stdio, \"ipc\");\n  } else if (!Array.isArray(options.stdio)) {\n    // Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,\n    // and stderr from the parent if silent isn't set.\n    options.stdio = stdioStringToArray(\n      options.silent ? \"pipe\" : \"inherit\",\n      \"ipc\"\n    );\n  } else if (!options.stdio.includes(\"ipc\")) {\n    throw new ERR_CHILD_PROCESS_IPC_REQUIRED(\"options.stdio\");\n  }\n\n  options.execPath = options.execPath || process.execPath; // Node\n  options.shell = false; //  shell\n\n  return spawn(options.execPath, args, options);\n}\n```\n\n 12~22 fork  stdio  ipc `ipc``spawn`\n\n<br/>\n\n**spawn**\n\n```javascript\n// lib/child_process.js\nfunction spawn(file, args, options) {\n  const child = new ChildProcess();\n\n  options = normalizeSpawnArguments(file, args, options);\n  debug(\"spawn\", options);\n  child.spawn(options);\n\n  return child;\n}\n```\n\n`lib/child_process.js` spawn  ChildProcess  spawn\n\n<br/>\n\n**ChildProcess**\n\n```javascript\n// `lib/internal/child_process.js`\nfunction ChildProcess() {\n  EventEmitter.call(this);\n\n  // ...\n\n  this._handle = new Process(); // new  ProcessWrap   process_wrap.cc\n}\n\nChildProcess.prototype.spawn = function (options) {\n  let i = 0;\n\n  //  pipe\n  let stdio = options.stdio || \"pipe\";\n\n  // stdio\n  stdio = getValidStdio(stdio, false);\n\n  const ipc = stdio.ipc;\n  const ipcFd = stdio.ipcFd;\n  stdio = options.stdio = stdio.stdio;\n\n  // ...\n\n  // ProcessWrapspawn\n  const err = this._handle.spawn(options);\n\n  // err\n  // ...\n\n  this.pid = this._handle.pid;\n\n  for (i = 0; i < stdio.length; i++) {\n    const stream = stdio[i];\n    // ...\n    if (stream.handle) {\n      // When i === 0 - we're dealing with stdin\n      // (which is the only one writable pipe).\n      //  socket\n      stream.socket = createSocket(\n        this.pid !== 0 ? stream.handle : null,\n        i > 0\n      );\n\n      if (i > 0 && this.pid !== 0) {\n        this._closesNeeded++;\n        stream.socket.on(\"close\", () => {\n          maybeClose(this);\n        });\n      }\n    }\n  }\n  this.stdin =\n    stdio.length >= 1 && stdio[0].socket !== undefined ? stdio[0].socket : null;\n  this.stdout =\n    stdio.length >= 2 && stdio[1].socket !== undefined ? stdio[1].socket : null;\n  this.stderr =\n    stdio.length >= 3 && stdio[2].socket !== undefined ? stdio[2].socket : null;\n\n  this.stdio = [];\n\n  for (i = 0; i < stdio.length; i++)\n    this.stdio.push(stdio[i].socket === undefined ? null : stdio[i].socket);\n\n  // Add .send() method and start listening for IPC data\n  // setupChannel \n  if (ipc !== undefined) setupChannel(this, ipc);\n\n  return err;\n};\n\nfunction stdioStringToArray(stdio, channel) {\n  // stdio[xxx,xxx,xxx]\n  // channel[xxx,xxx,xxx,channel]\n}\n\nfunction getValidStdio(stdio, sync) {\n  var ipc;\n  var ipcFd;\n\n  stdio = stdio.reduce((acc, stdio, i) => {\n    function cleanup() {\n      for (var i = 0; i < acc.length; i++) {\n        if ((acc[i].type === \"pipe\" || acc[i].type === \"ipc\") && acc[i].handle)\n          acc[i].handle.close();\n      }\n    }\n\n    if (stdio === \"ignore\") {\n      acc.push({ type: \"ignore\" }); // \n    } else if (stdio === \"pipe\" || (typeof stdio === \"number\" && stdio < 0)) {\n      var a = {\n        type: \"pipe\",\n        readable: i === 0, // 0stdin\n        writable: i !== 0, // 1stdout2stderr \n      };\n      // spawn syncfalsestdinstdoutstderrSOCKETPipe\n      if (!sync) a.handle = new Pipe(PipeConstants.SOCKET);\n\n      acc.push(a);\n    } else if (stdio === \"ipc\") {\n      // IPCPipe\n      ipc = new Pipe(PipeConstants.IPC);\n      ipcFd = i; // ipc\n\n      acc.push({\n        type: \"pipe\",\n        handle: ipc,\n        ipc: true,\n      });\n    } else if (stdio === \"inherit\") {\n      acc.push({\n        type: \"inherit\",\n        fd: i,\n      });\n    }\n    // ...\n    return acc;\n  }, []);\n\n  return { stdio, ipc, ipcFd };\n}\n```\n\n`ChildProcess` V8  new ProcessWrap  this.\\_handle\n\n`ChildProcess.prototype.spawn`[`stdio`](http://nodejs.cn/api/child_process.html#child_process_options_stdio)`pipe``ipc` Pipe \n\n```c\n// pipe_wrap.cc\nvoid PipeWrap::New(const FunctionCallbackInfo<Value>& args) {\n  switch (type) {\n    case SOCKET:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = false;\n      break;\n    case IPC:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = true;\n      break;\n  }\n  new PipeWrap(env, args.This(), provider, ipc);\n}\nPipeWrap::PipeWrap(Environment* env,\n                   Local<Object> object,\n                   ProviderType provider,\n                   bool ipc)\n    : ConnectionWrap(env, object, provider) {\n  int r = uv_pipe_init(env->event_loop(), &handle_, ipc);\n}\n// deps/uv/src/unix/pipe.c\nint uv_pipe_init(uv_loop_t* loop, uv_pipe_t* handle, int ipc) {\n  uv__stream_init(loop, (uv_stream_t*)handle, UV_NAMED_PIPE);\n  handle->shutdown_req = NULL;\n  handle->connect_req = NULL;\n  handle->pipe_fname = NULL;\n  handle->ipc = ipc;\n  return 0;\n}\n```\n\n`uv_pipe_t` ipc  true  false** libuv **\n\n`ChildProcess.prototype.spawn` stdio `this._handle.spawn(options);``process_wrap.cc` ProcessWrap.Spawn `uv_spawn`\n\n```c\n// deps/uv/src/unix/process.c\nint uv_spawn(uv_loop_t* loop,\n             uv_process_t* process,\n             const uv_process_options_t* options) {\n#if defined(__APPLE__) && (TARGET_OS_TV || TARGET_OS_WATCH)\n  /* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */\n  return UV_ENOSYS;\n#else\n  // ...\n\n  uv_signal_start(&loop->child_watcher, uv__chld, SIGCHLD);\n\n  /* Acquire write lock to prevent opening new fds in worker threads */\n  uv_rwlock_wrlock(&loop->cloexec_lock);\n  pid = fork();\n\n  if (pid == -1) {\n    err = UV__ERR(errno);\n    uv_rwlock_wrunlock(&loop->cloexec_lock);\n    uv__close(signal_pipe[0]);\n    uv__close(signal_pipe[1]);\n    goto error;\n  }\n\n  if (pid == 0) {\n    uv__process_child_init(options, stdio_count, pipes, signal_pipe[1]);\n    abort();\n  }\n\n  /* Release lock in parent process */\n  uv_rwlock_wrunlock(&loop->cloexec_lock);\n  uv__close(signal_pipe[1]);\n\n  // ...\n}\n```\n\n`fork` fork  0 `uv__process_child_init`\n\n`ChildProcess.prototype.spawn``stdio` handle `createSocket` socket \n\n```javascript\nfunction createSocket(pipe, readable) {\n  return net.Socket({ handle: pipe, readable, writable: !readable });\n}\n```\n\n`stdio` pipe  ipc  socket stdinstdout  stderr `exec``execFile``fork` ipc  stdio  fork  send `setupChannel`\n\n<br/>\n\n<br/>\n\n****Node.js `child_process` JavaScript  libuv  cluster.fork  child_process.fork \n","source":"_posts/child_process-exec-fork-spawn.md","raw":"---\ntitle: Node.js\ncategory: JavaScript\nkeywords: Node.js,,Node.js\ndescription: Node.js child_process, execexecFileforkspawncluster, fork\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-04-06T08:09:36.472Z\n---\n\n**Node.js **\n\n**child_process**\n\n- [exec](http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback):  shell  shell  `command` 1024\\*1024 \n- [execFile](http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback): `exec` shell `file` `exec` `exec` 1024\\*1204 \n- [fork](http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options):  `spawn` Node.js  `spawn``ChildProcess` `ChildProcess`\n- [spawn](http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options):  spawn \n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): \n\n<!-- more -->\n\n<br/>\n\n### ****\n\n[libuv & Node.js EventLoop ](https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/)\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**child_process**\n\n```javascript\nNode \n  - lib \n  \t- internal \n  \t\t- child_process.js \n  \t- child_process.js;\n```\n\n`lib/child_process.js``exec``execFile``fork``spawn``lib/internal/child_process.js``spawn`\n\n<br/>\n\n**exec**\n\n```javascript\n// lib/child_process.js\nfunction exec(command, options, callback) {\n  const opts = normalizeExecArgs(command, options, callback);\n  return module.exports.execFile(opts.file, opts.options, opts.callback);\n}\nfunction normalizeExecArgs(command, options, callback) {\n  if (typeof options === \"function\") {\n    callback = options;\n    options = undefined;\n  }\n\n  // Make a shallow copy so we don't clobber the user's options object.\n  options = { ...options };\n  options.shell = typeof options.shell === \"string\" ? options.shell : true;\n\n  return {\n    file: command,\n    options: options,\n    callback: callback,\n  };\n}\n```\n\n exec `shell` execFile \n\n<br/>\n\n**execFile**\n\n```javascript\n// lib/child_process.js\nfunction execFile(file /* , args, options, callback */) {\n  let args = [];\n  let callback;\n  let options;\n\n  // ...\n\n  options = {\n    encoding: \"utf8\",\n    timeout: 0,\n    maxBuffer: MAX_BUFFER,\n    killSignal: \"SIGTERM\",\n    cwd: null,\n    env: null,\n    shell: false, // execFile shell\n    ...options,\n  };\n\n  // spawn\n  const child = spawn(file, args, {\n    cwd: options.cwd,\n    env: options.env,\n    gid: options.gid,\n    uid: options.uid,\n    shell: options.shell,\n    windowsHide: !!options.windowsHide,\n    windowsVerbatimArguments: !!options.windowsVerbatimArguments,\n  });\n\n  var encoding;\n  const _stdout = []; // \n  const _stderr = []; // \n  // ...\n  var stdoutLen = 0; // \n  var stderrLen = 0; // \n  var killed = false; // \n  var exited = false; // \n  var timeoutId; // \n\n  var ex = null; // \n\n  var cmd = file; // \n\n  // \n  function exithandler(code, signal) {\n    if (exited) return;\n    exited = true;\n\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      timeoutId = null;\n    }\n\n    if (!callback) return;\n\n    // merge chunks\n    var stdout;\n    var stderr;\n    if (encoding || (child.stdout && child.stdout.readableEncoding)) {\n      stdout = _stdout.join(\"\");\n    } else {\n      stdout = Buffer.concat(_stdout); //  encoding Buffer\n    }\n    if (encoding || (child.stderr && child.stderr.readableEncoding)) {\n      stderr = _stderr.join(\"\");\n    } else {\n      stderr = Buffer.concat(_stderr); //  encoding Buffer\n    }\n\n    if (!ex && code === 0 && signal === null) {\n      callback(null, stdout, stderr); // \n      return;\n    }\n\n    if (args.length !== 0) cmd += ` ${args.join(\" \")}`;\n\n    if (!ex) {\n      // eslint-disable-next-line no-restricted-syntax\n      ex = new Error(\"Command failed: \" + cmd + \"\\n\" + stderr);\n      ex.killed = child.killed || killed;\n      ex.code = code < 0 ? getSystemErrorName(code) : code;\n      ex.signal = signal;\n    }\n\n    ex.cmd = cmd;\n    callback(ex, stdout, stderr); // \n  }\n\n  function errorhandler(e) {\n    ex = e;\n\n    // child.stdout  child.stderr \n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    exithandler();\n  }\n\n  function kill() {\n    if (child.stdout) child.stdout.destroy();\n\n    if (child.stderr) child.stderr.destroy();\n\n    killed = true;\n    try {\n      child.kill(options.killSignal);\n    } catch (e) {\n      ex = e;\n      exithandler();\n    }\n  }\n\n  // \n  if (options.timeout > 0) {\n    timeoutId = setTimeout(function delayedKill() {\n      kill();\n      timeoutId = null;\n    }, options.timeout);\n  }\n\n  if (child.stdout) {\n    if (encoding) child.stdout.setEncoding(encoding);\n\n    child.stdout.on(\"data\", function onChildStdout(chunk) {\n      const encoding = child.stdout.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stdoutLen += length; // \n\n      if (stdoutLen > options.maxBuffer) {\n        // \n        const truncatedLen = options.maxBuffer - (stdoutLen - length);\n        _stdout.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stdout\");\n        kill();\n      } else {\n        _stdout.push(chunk); // chunk\n      }\n    });\n  }\n\n  // child.stdout\n  if (child.stderr) {\n    if (encoding) child.stderr.setEncoding(encoding);\n\n    child.stderr.on(\"data\", function onChildStderr(chunk) {\n      const encoding = child.stderr.readableEncoding;\n      const length = encoding\n        ? Buffer.byteLength(chunk, encoding)\n        : chunk.length;\n      stderrLen += length;\n\n      if (stderrLen > options.maxBuffer) {\n        const truncatedLen = options.maxBuffer - (stderrLen - length);\n        _stderr.push(chunk.slice(0, truncatedLen));\n\n        ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER(\"stderr\");\n        kill();\n      } else {\n        _stderr.push(chunk);\n      }\n    });\n  }\n\n  child.addListener(\"close\", exithandler);\n  child.addListener(\"error\", errorhandler);\n\n  return child;\n}\n```\n\n`exec``execFile``shell``child.stderr.on('data')``child.stdout.on('data')`\n\n`_stderr``_stdout`\n\n**`spawn`**\n\n<br/>\n\n**fork**\n\n```javascript\n// lib/child_process.js\nfunction fork(modulePath /* , args, options */) {\n  // Get options and args arguments.\n  var execArgv;\n  var options = {};\n  var args = [];\n\n  // ...\n\n  // forkstdioipc\n  if (typeof options.stdio === \"string\") {\n    options.stdio = stdioStringToArray(options.stdio, \"ipc\");\n  } else if (!Array.isArray(options.stdio)) {\n    // Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,\n    // and stderr from the parent if silent isn't set.\n    options.stdio = stdioStringToArray(\n      options.silent ? \"pipe\" : \"inherit\",\n      \"ipc\"\n    );\n  } else if (!options.stdio.includes(\"ipc\")) {\n    throw new ERR_CHILD_PROCESS_IPC_REQUIRED(\"options.stdio\");\n  }\n\n  options.execPath = options.execPath || process.execPath; // Node\n  options.shell = false; //  shell\n\n  return spawn(options.execPath, args, options);\n}\n```\n\n 12~22 fork  stdio  ipc `ipc``spawn`\n\n<br/>\n\n**spawn**\n\n```javascript\n// lib/child_process.js\nfunction spawn(file, args, options) {\n  const child = new ChildProcess();\n\n  options = normalizeSpawnArguments(file, args, options);\n  debug(\"spawn\", options);\n  child.spawn(options);\n\n  return child;\n}\n```\n\n`lib/child_process.js` spawn  ChildProcess  spawn\n\n<br/>\n\n**ChildProcess**\n\n```javascript\n// `lib/internal/child_process.js`\nfunction ChildProcess() {\n  EventEmitter.call(this);\n\n  // ...\n\n  this._handle = new Process(); // new  ProcessWrap   process_wrap.cc\n}\n\nChildProcess.prototype.spawn = function (options) {\n  let i = 0;\n\n  //  pipe\n  let stdio = options.stdio || \"pipe\";\n\n  // stdio\n  stdio = getValidStdio(stdio, false);\n\n  const ipc = stdio.ipc;\n  const ipcFd = stdio.ipcFd;\n  stdio = options.stdio = stdio.stdio;\n\n  // ...\n\n  // ProcessWrapspawn\n  const err = this._handle.spawn(options);\n\n  // err\n  // ...\n\n  this.pid = this._handle.pid;\n\n  for (i = 0; i < stdio.length; i++) {\n    const stream = stdio[i];\n    // ...\n    if (stream.handle) {\n      // When i === 0 - we're dealing with stdin\n      // (which is the only one writable pipe).\n      //  socket\n      stream.socket = createSocket(\n        this.pid !== 0 ? stream.handle : null,\n        i > 0\n      );\n\n      if (i > 0 && this.pid !== 0) {\n        this._closesNeeded++;\n        stream.socket.on(\"close\", () => {\n          maybeClose(this);\n        });\n      }\n    }\n  }\n  this.stdin =\n    stdio.length >= 1 && stdio[0].socket !== undefined ? stdio[0].socket : null;\n  this.stdout =\n    stdio.length >= 2 && stdio[1].socket !== undefined ? stdio[1].socket : null;\n  this.stderr =\n    stdio.length >= 3 && stdio[2].socket !== undefined ? stdio[2].socket : null;\n\n  this.stdio = [];\n\n  for (i = 0; i < stdio.length; i++)\n    this.stdio.push(stdio[i].socket === undefined ? null : stdio[i].socket);\n\n  // Add .send() method and start listening for IPC data\n  // setupChannel \n  if (ipc !== undefined) setupChannel(this, ipc);\n\n  return err;\n};\n\nfunction stdioStringToArray(stdio, channel) {\n  // stdio[xxx,xxx,xxx]\n  // channel[xxx,xxx,xxx,channel]\n}\n\nfunction getValidStdio(stdio, sync) {\n  var ipc;\n  var ipcFd;\n\n  stdio = stdio.reduce((acc, stdio, i) => {\n    function cleanup() {\n      for (var i = 0; i < acc.length; i++) {\n        if ((acc[i].type === \"pipe\" || acc[i].type === \"ipc\") && acc[i].handle)\n          acc[i].handle.close();\n      }\n    }\n\n    if (stdio === \"ignore\") {\n      acc.push({ type: \"ignore\" }); // \n    } else if (stdio === \"pipe\" || (typeof stdio === \"number\" && stdio < 0)) {\n      var a = {\n        type: \"pipe\",\n        readable: i === 0, // 0stdin\n        writable: i !== 0, // 1stdout2stderr \n      };\n      // spawn syncfalsestdinstdoutstderrSOCKETPipe\n      if (!sync) a.handle = new Pipe(PipeConstants.SOCKET);\n\n      acc.push(a);\n    } else if (stdio === \"ipc\") {\n      // IPCPipe\n      ipc = new Pipe(PipeConstants.IPC);\n      ipcFd = i; // ipc\n\n      acc.push({\n        type: \"pipe\",\n        handle: ipc,\n        ipc: true,\n      });\n    } else if (stdio === \"inherit\") {\n      acc.push({\n        type: \"inherit\",\n        fd: i,\n      });\n    }\n    // ...\n    return acc;\n  }, []);\n\n  return { stdio, ipc, ipcFd };\n}\n```\n\n`ChildProcess` V8  new ProcessWrap  this.\\_handle\n\n`ChildProcess.prototype.spawn`[`stdio`](http://nodejs.cn/api/child_process.html#child_process_options_stdio)`pipe``ipc` Pipe \n\n```c\n// pipe_wrap.cc\nvoid PipeWrap::New(const FunctionCallbackInfo<Value>& args) {\n  switch (type) {\n    case SOCKET:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = false;\n      break;\n    case IPC:\n      provider = PROVIDER_PIPEWRAP;\n      ipc = true;\n      break;\n  }\n  new PipeWrap(env, args.This(), provider, ipc);\n}\nPipeWrap::PipeWrap(Environment* env,\n                   Local<Object> object,\n                   ProviderType provider,\n                   bool ipc)\n    : ConnectionWrap(env, object, provider) {\n  int r = uv_pipe_init(env->event_loop(), &handle_, ipc);\n}\n// deps/uv/src/unix/pipe.c\nint uv_pipe_init(uv_loop_t* loop, uv_pipe_t* handle, int ipc) {\n  uv__stream_init(loop, (uv_stream_t*)handle, UV_NAMED_PIPE);\n  handle->shutdown_req = NULL;\n  handle->connect_req = NULL;\n  handle->pipe_fname = NULL;\n  handle->ipc = ipc;\n  return 0;\n}\n```\n\n`uv_pipe_t` ipc  true  false** libuv **\n\n`ChildProcess.prototype.spawn` stdio `this._handle.spawn(options);``process_wrap.cc` ProcessWrap.Spawn `uv_spawn`\n\n```c\n// deps/uv/src/unix/process.c\nint uv_spawn(uv_loop_t* loop,\n             uv_process_t* process,\n             const uv_process_options_t* options) {\n#if defined(__APPLE__) && (TARGET_OS_TV || TARGET_OS_WATCH)\n  /* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */\n  return UV_ENOSYS;\n#else\n  // ...\n\n  uv_signal_start(&loop->child_watcher, uv__chld, SIGCHLD);\n\n  /* Acquire write lock to prevent opening new fds in worker threads */\n  uv_rwlock_wrlock(&loop->cloexec_lock);\n  pid = fork();\n\n  if (pid == -1) {\n    err = UV__ERR(errno);\n    uv_rwlock_wrunlock(&loop->cloexec_lock);\n    uv__close(signal_pipe[0]);\n    uv__close(signal_pipe[1]);\n    goto error;\n  }\n\n  if (pid == 0) {\n    uv__process_child_init(options, stdio_count, pipes, signal_pipe[1]);\n    abort();\n  }\n\n  /* Release lock in parent process */\n  uv_rwlock_wrunlock(&loop->cloexec_lock);\n  uv__close(signal_pipe[1]);\n\n  // ...\n}\n```\n\n`fork` fork  0 `uv__process_child_init`\n\n`ChildProcess.prototype.spawn``stdio` handle `createSocket` socket \n\n```javascript\nfunction createSocket(pipe, readable) {\n  return net.Socket({ handle: pipe, readable, writable: !readable });\n}\n```\n\n`stdio` pipe  ipc  socket stdinstdout  stderr `exec``execFile``fork` ipc  stdio  fork  send `setupChannel`\n\n<br/>\n\n<br/>\n\n****Node.js `child_process` JavaScript  libuv  cluster.fork  child_process.fork \n","slug":"child_process-exec-fork-spawn","published":1,"updated":"2024-04-08T13:38:58.592Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wdr000518fd1arq7m43","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p><strong>Node.js </strong></p>\n<p><strong>child_process</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback\">exec</a>:  shell  shell  <code>command</code> 1024*1024 </li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback\">execFile</a>: <code>exec</code> shell <code>file</code> <code>exec</code> <code>exec</code> 1024*1204 </li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options\">fork</a>:  <code>spawn</code> Node.js  <code>spawn</code><code>ChildProcess</code> <code>ChildProcess</code></li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options\">spawn</a>:  spawn </li>\n</ul>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\">fork</a>: </li>\n</ul>\n<span id=\"more\"></span>\n\n<br>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h3><p><a href=\"https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/\">libuv &amp; Node.js EventLoop </a></p>\n<figure class=\"highlight markdown hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"hljs-section\">#define UV<span class=\"hljs-emphasis\">_VERSION_</span>MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV<span class=\"hljs-emphasis\">_VERSION_</span>MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV<span class=\"hljs-emphasis\">_VERSION_</span>PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"hljs-section\">#define V8<span class=\"hljs-emphasis\">_MAJOR_</span>VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8<span class=\"hljs-emphasis\">_MINOR_</span>VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8<span class=\"hljs-emphasis\">_BUILD_</span>NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8<span class=\"hljs-emphasis\">_PATCH_</span>LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE<span class=\"hljs-emphasis\">_MAJOR_</span>VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE<span class=\"hljs-emphasis\">_MINOR_</span>VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE<span class=\"hljs-emphasis\">_PATCH_</span>VERSION 0</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>child_process</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Node</span> </span><br><span class=\"line\">  - lib </span><br><span class=\"line\">  \t- internal </span><br><span class=\"line\">  \t\t- child_process.<span class=\"hljs-property\">js</span> </span><br><span class=\"line\">  \t- child_process.<span class=\"hljs-property\">js</span>;</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>lib/child_process.js</code><code>exec</code><code>execFile</code><code>fork</code><code>spawn</code><code>lib/internal/child_process.js</code><code>spawn</code></p>\n<br>\n\n<p><strong>exec</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">exec</span>(<span class=\"hljs-params\">command, options, callback</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> opts = <span class=\"title function_\">normalizeExecArgs</span>(command, options, callback);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"variable language_\">module</span>.<span class=\"hljs-property\">exports</span>.<span class=\"title function_\">execFile</span>(opts.<span class=\"hljs-property\">file</span>, opts.<span class=\"hljs-property\">options</span>, opts.<span class=\"hljs-property\">callback</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">normalizeExecArgs</span>(<span class=\"hljs-params\">command, options, callback</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> options === <span class=\"hljs-string\">\"function\"</span>) {</span><br><span class=\"line\">    callback = options;</span><br><span class=\"line\">    options = <span class=\"hljs-literal\">undefined</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Make a shallow copy so we don't clobber the user's options object.</span></span><br><span class=\"line\">  options = { ...options };</span><br><span class=\"line\">  options.<span class=\"hljs-property\">shell</span> = <span class=\"hljs-keyword\">typeof</span> options.<span class=\"hljs-property\">shell</span> === <span class=\"hljs-string\">\"string\"</span> ? options.<span class=\"hljs-property\">shell</span> : <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> {</span><br><span class=\"line\">    <span class=\"hljs-attr\">file</span>: command,</span><br><span class=\"line\">    <span class=\"hljs-attr\">options</span>: options,</span><br><span class=\"line\">    <span class=\"hljs-attr\">callback</span>: callback,</span><br><span class=\"line\">  };</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p> exec <code>shell</code> execFile </p>\n<br>\n\n<p><strong>execFile</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">execFile</span>(<span class=\"hljs-params\">file <span class=\"hljs-comment\">/* , args, options, callback */</span></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> args = [];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> callback;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> options;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  options = {</span><br><span class=\"line\">    <span class=\"hljs-attr\">encoding</span>: <span class=\"hljs-string\">\"utf8\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">timeout</span>: <span class=\"hljs-number\">0</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">maxBuffer</span>: <span class=\"variable constant_\">MAX_BUFFER</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">killSignal</span>: <span class=\"hljs-string\">\"SIGTERM\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">cwd</span>: <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">env</span>: <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">shell</span>: <span class=\"hljs-literal\">false</span>, <span class=\"hljs-comment\">// execFile shell</span></span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  };</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// spawn</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> child = <span class=\"title function_\">spawn</span>(file, args, {</span><br><span class=\"line\">    <span class=\"hljs-attr\">cwd</span>: options.<span class=\"hljs-property\">cwd</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">env</span>: options.<span class=\"hljs-property\">env</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">gid</span>: options.<span class=\"hljs-property\">gid</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">uid</span>: options.<span class=\"hljs-property\">uid</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">shell</span>: options.<span class=\"hljs-property\">shell</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">windowsHide</span>: !!options.<span class=\"hljs-property\">windowsHide</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">windowsVerbatimArguments</span>: !!options.<span class=\"hljs-property\">windowsVerbatimArguments</span>,</span><br><span class=\"line\">  });</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> encoding;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> _stdout = []; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> _stderr = []; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> stdoutLen = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> stderrLen = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> killed = <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> exited = <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> timeoutId; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> ex = <span class=\"hljs-literal\">null</span>; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> cmd = file; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">exithandler</span>(<span class=\"hljs-params\">code, signal</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (exited) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    exited = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (timeoutId) {</span><br><span class=\"line\">      <span class=\"hljs-built_in\">clearTimeout</span>(timeoutId);</span><br><span class=\"line\">      timeoutId = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!callback) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// merge chunks</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> stdout;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> stderr;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding || (child.<span class=\"hljs-property\">stdout</span> &amp;&amp; child.<span class=\"hljs-property\">stdout</span>.<span class=\"hljs-property\">readableEncoding</span>)) {</span><br><span class=\"line\">      stdout = _stdout.<span class=\"title function_\">join</span>(<span class=\"hljs-string\">\"\"</span>);</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">      stdout = <span class=\"title class_\">Buffer</span>.<span class=\"title function_\">concat</span>(_stdout); <span class=\"hljs-comment\">//  encoding Buffer</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding || (child.<span class=\"hljs-property\">stderr</span> &amp;&amp; child.<span class=\"hljs-property\">stderr</span>.<span class=\"hljs-property\">readableEncoding</span>)) {</span><br><span class=\"line\">      stderr = _stderr.<span class=\"title function_\">join</span>(<span class=\"hljs-string\">\"\"</span>);</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">      stderr = <span class=\"title class_\">Buffer</span>.<span class=\"title function_\">concat</span>(_stderr); <span class=\"hljs-comment\">//  encoding Buffer</span></span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!ex &amp;&amp; code === <span class=\"hljs-number\">0</span> &amp;&amp; signal === <span class=\"hljs-literal\">null</span>) {</span><br><span class=\"line\">      <span class=\"title function_\">callback</span>(<span class=\"hljs-literal\">null</span>, stdout, stderr); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (args.<span class=\"hljs-property\">length</span> !== <span class=\"hljs-number\">0</span>) cmd += <span class=\"hljs-string\">` <span class=\"hljs-subst\">${args.join(<span class=\"hljs-string\">\" \"</span>)}</span>`</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!ex) {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// eslint-disable-next-line no-restricted-syntax</span></span><br><span class=\"line\">      ex = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"hljs-string\">\"Command failed: \"</span> + cmd + <span class=\"hljs-string\">\"\\n\"</span> + stderr);</span><br><span class=\"line\">      ex.<span class=\"hljs-property\">killed</span> = child.<span class=\"hljs-property\">killed</span> || killed;</span><br><span class=\"line\">      ex.<span class=\"hljs-property\">code</span> = code &lt; <span class=\"hljs-number\">0</span> ? <span class=\"title function_\">getSystemErrorName</span>(code) : code;</span><br><span class=\"line\">      ex.<span class=\"hljs-property\">signal</span> = signal;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    ex.<span class=\"hljs-property\">cmd</span> = cmd;</span><br><span class=\"line\">    <span class=\"title function_\">callback</span>(ex, stdout, stderr); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">errorhandler</span>(<span class=\"hljs-params\">e</span>) {</span><br><span class=\"line\">    ex = e;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// child.stdout  child.stderr </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.<span class=\"hljs-property\">stdout</span>) child.<span class=\"hljs-property\">stdout</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.<span class=\"hljs-property\">stderr</span>) child.<span class=\"hljs-property\">stderr</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">exithandler</span>();</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">kill</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.<span class=\"hljs-property\">stdout</span>) child.<span class=\"hljs-property\">stdout</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (child.<span class=\"hljs-property\">stderr</span>) child.<span class=\"hljs-property\">stderr</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    killed = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">try</span> {</span><br><span class=\"line\">      child.<span class=\"title function_\">kill</span>(options.<span class=\"hljs-property\">killSignal</span>);</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">catch</span> (e) {</span><br><span class=\"line\">      ex = e;</span><br><span class=\"line\">      <span class=\"title function_\">exithandler</span>();</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (options.<span class=\"hljs-property\">timeout</span> &gt; <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">    timeoutId = <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span> <span class=\"title function_\">delayedKill</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">      <span class=\"title function_\">kill</span>();</span><br><span class=\"line\">      timeoutId = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">    }, options.<span class=\"hljs-property\">timeout</span>);</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (child.<span class=\"hljs-property\">stdout</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding) child.<span class=\"hljs-property\">stdout</span>.<span class=\"title function_\">setEncoding</span>(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.<span class=\"hljs-property\">stdout</span>.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">\"data\"</span>, <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">onChildStdout</span>(<span class=\"hljs-params\">chunk</span>) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> encoding = child.<span class=\"hljs-property\">stdout</span>.<span class=\"hljs-property\">readableEncoding</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? <span class=\"title class_\">Buffer</span>.<span class=\"title function_\">byteLength</span>(chunk, encoding)</span><br><span class=\"line\">        : chunk.<span class=\"hljs-property\">length</span>;</span><br><span class=\"line\">      stdoutLen += length; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (stdoutLen &gt; options.<span class=\"hljs-property\">maxBuffer</span>) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> truncatedLen = options.<span class=\"hljs-property\">maxBuffer</span> - (stdoutLen - length);</span><br><span class=\"line\">        _stdout.<span class=\"title function_\">push</span>(chunk.<span class=\"title function_\">slice</span>(<span class=\"hljs-number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"hljs-keyword\">new</span> <span class=\"title function_\">ERR_CHILD_PROCESS_STDIO_MAXBUFFER</span>(<span class=\"hljs-string\">\"stdout\"</span>);</span><br><span class=\"line\">        <span class=\"title function_\">kill</span>();</span><br><span class=\"line\">      } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        _stdout.<span class=\"title function_\">push</span>(chunk); <span class=\"hljs-comment\">// chunk</span></span><br><span class=\"line\">      }</span><br><span class=\"line\">    });</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// child.stdout</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (child.<span class=\"hljs-property\">stderr</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (encoding) child.<span class=\"hljs-property\">stderr</span>.<span class=\"title function_\">setEncoding</span>(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.<span class=\"hljs-property\">stderr</span>.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">\"data\"</span>, <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">onChildStderr</span>(<span class=\"hljs-params\">chunk</span>) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> encoding = child.<span class=\"hljs-property\">stderr</span>.<span class=\"hljs-property\">readableEncoding</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? <span class=\"title class_\">Buffer</span>.<span class=\"title function_\">byteLength</span>(chunk, encoding)</span><br><span class=\"line\">        : chunk.<span class=\"hljs-property\">length</span>;</span><br><span class=\"line\">      stderrLen += length;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (stderrLen &gt; options.<span class=\"hljs-property\">maxBuffer</span>) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> truncatedLen = options.<span class=\"hljs-property\">maxBuffer</span> - (stderrLen - length);</span><br><span class=\"line\">        _stderr.<span class=\"title function_\">push</span>(chunk.<span class=\"title function_\">slice</span>(<span class=\"hljs-number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"hljs-keyword\">new</span> <span class=\"title function_\">ERR_CHILD_PROCESS_STDIO_MAXBUFFER</span>(<span class=\"hljs-string\">\"stderr\"</span>);</span><br><span class=\"line\">        <span class=\"title function_\">kill</span>();</span><br><span class=\"line\">      } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        _stderr.<span class=\"title function_\">push</span>(chunk);</span><br><span class=\"line\">      }</span><br><span class=\"line\">    });</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  child.<span class=\"title function_\">addListener</span>(<span class=\"hljs-string\">\"close\"</span>, exithandler);</span><br><span class=\"line\">  child.<span class=\"title function_\">addListener</span>(<span class=\"hljs-string\">\"error\"</span>, errorhandler);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> child;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>exec</code><code>execFile</code><code>shell</code><code>child.stderr.on('data')</code><code>child.stdout.on('data')</code></p>\n<p><code>_stderr</code><code>_stdout</code></p>\n<p><strong><code>spawn</code></strong></p>\n<br>\n\n<p><strong>fork</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">fork</span>(<span class=\"hljs-params\">modulePath <span class=\"hljs-comment\">/* , args, options */</span></span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// Get options and args arguments.</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> execArgv;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> options = {};</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> args = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// forkstdioipc</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> options.<span class=\"hljs-property\">stdio</span> === <span class=\"hljs-string\">\"string\"</span>) {</span><br><span class=\"line\">    options.<span class=\"hljs-property\">stdio</span> = <span class=\"title function_\">stdioStringToArray</span>(options.<span class=\"hljs-property\">stdio</span>, <span class=\"hljs-string\">\"ipc\"</span>);</span><br><span class=\"line\">  } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!<span class=\"title class_\">Array</span>.<span class=\"title function_\">isArray</span>(options.<span class=\"hljs-property\">stdio</span>)) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// and stderr from the parent if silent isn't set.</span></span><br><span class=\"line\">    options.<span class=\"hljs-property\">stdio</span> = <span class=\"title function_\">stdioStringToArray</span>(</span><br><span class=\"line\">      options.<span class=\"hljs-property\">silent</span> ? <span class=\"hljs-string\">\"pipe\"</span> : <span class=\"hljs-string\">\"inherit\"</span>,</span><br><span class=\"line\">      <span class=\"hljs-string\">\"ipc\"</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!options.<span class=\"hljs-property\">stdio</span>.<span class=\"title function_\">includes</span>(<span class=\"hljs-string\">\"ipc\"</span>)) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"title function_\">ERR_CHILD_PROCESS_IPC_REQUIRED</span>(<span class=\"hljs-string\">\"options.stdio\"</span>);</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  options.<span class=\"hljs-property\">execPath</span> = options.<span class=\"hljs-property\">execPath</span> || process.<span class=\"hljs-property\">execPath</span>; <span class=\"hljs-comment\">// Node</span></span><br><span class=\"line\">  options.<span class=\"hljs-property\">shell</span> = <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">//  shell</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"title function_\">spawn</span>(options.<span class=\"hljs-property\">execPath</span>, args, options);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p> 12~22 fork  stdio  ipc <code>ipc</code><code>spawn</code></p>\n<br>\n\n<p><strong>spawn</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">spawn</span>(<span class=\"hljs-params\">file, args, options</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> child = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">ChildProcess</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  options = <span class=\"title function_\">normalizeSpawnArguments</span>(file, args, options);</span><br><span class=\"line\">  <span class=\"title function_\">debug</span>(<span class=\"hljs-string\">\"spawn\"</span>, options);</span><br><span class=\"line\">  child.<span class=\"title function_\">spawn</span>(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> child;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>lib/child_process.js</code> spawn  ChildProcess  spawn</p>\n<br>\n\n<p><strong>ChildProcess</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// `lib/internal/child_process.js`</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">ChildProcess</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"title class_\">EventEmitter</span>.<span class=\"title function_\">call</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">_handle</span> = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Process</span>(); <span class=\"hljs-comment\">// new  ProcessWrap   process_wrap.cc</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">ChildProcess</span>.<span class=\"hljs-property\"><span class=\"hljs-keyword\">prototype</span></span>.<span class=\"hljs-property\">spawn</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">options</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  pipe</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> stdio = options.<span class=\"hljs-property\">stdio</span> || <span class=\"hljs-string\">\"pipe\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// stdio</span></span><br><span class=\"line\">  stdio = <span class=\"title function_\">getValidStdio</span>(stdio, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> ipc = stdio.<span class=\"hljs-property\">ipc</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> ipcFd = stdio.<span class=\"hljs-property\">ipcFd</span>;</span><br><span class=\"line\">  stdio = options.<span class=\"hljs-property\">stdio</span> = stdio.<span class=\"hljs-property\">stdio</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ProcessWrapspawn</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> err = <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">_handle</span>.<span class=\"title function_\">spawn</span>(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// err</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">pid</span> = <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">_handle</span>.<span class=\"hljs-property\">pid</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; stdio.<span class=\"hljs-property\">length</span>; i++) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> stream = stdio[i];</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (stream.<span class=\"hljs-property\">handle</span>) {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// When i === 0 - we're dealing with stdin</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// (which is the only one writable pipe).</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">//  socket</span></span><br><span class=\"line\">      stream.<span class=\"hljs-property\">socket</span> = <span class=\"title function_\">createSocket</span>(</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">pid</span> !== <span class=\"hljs-number\">0</span> ? stream.<span class=\"hljs-property\">handle</span> : <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">        i &gt; <span class=\"hljs-number\">0</span></span><br><span class=\"line\">      );</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (i &gt; <span class=\"hljs-number\">0</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">pid</span> !== <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">_closesNeeded</span>++;</span><br><span class=\"line\">        stream.<span class=\"hljs-property\">socket</span>.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">\"close\"</span>, <span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">          <span class=\"title function_\">maybeClose</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        });</span><br><span class=\"line\">      }</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">stdin</span> =</span><br><span class=\"line\">    stdio.<span class=\"hljs-property\">length</span> &gt;= <span class=\"hljs-number\">1</span> &amp;&amp; stdio[<span class=\"hljs-number\">0</span>].<span class=\"hljs-property\">socket</span> !== <span class=\"hljs-literal\">undefined</span> ? stdio[<span class=\"hljs-number\">0</span>].<span class=\"hljs-property\">socket</span> : <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">stdout</span> =</span><br><span class=\"line\">    stdio.<span class=\"hljs-property\">length</span> &gt;= <span class=\"hljs-number\">2</span> &amp;&amp; stdio[<span class=\"hljs-number\">1</span>].<span class=\"hljs-property\">socket</span> !== <span class=\"hljs-literal\">undefined</span> ? stdio[<span class=\"hljs-number\">1</span>].<span class=\"hljs-property\">socket</span> : <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">stderr</span> =</span><br><span class=\"line\">    stdio.<span class=\"hljs-property\">length</span> &gt;= <span class=\"hljs-number\">3</span> &amp;&amp; stdio[<span class=\"hljs-number\">2</span>].<span class=\"hljs-property\">socket</span> !== <span class=\"hljs-literal\">undefined</span> ? stdio[<span class=\"hljs-number\">2</span>].<span class=\"hljs-property\">socket</span> : <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">stdio</span> = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; stdio.<span class=\"hljs-property\">length</span>; i++)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">stdio</span>.<span class=\"title function_\">push</span>(stdio[i].<span class=\"hljs-property\">socket</span> === <span class=\"hljs-literal\">undefined</span> ? <span class=\"hljs-literal\">null</span> : stdio[i].<span class=\"hljs-property\">socket</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Add .send() method and start listening for IPC data</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// setupChannel </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (ipc !== <span class=\"hljs-literal\">undefined</span>) <span class=\"title function_\">setupChannel</span>(<span class=\"variable language_\">this</span>, ipc);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> err;</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">stdioStringToArray</span>(<span class=\"hljs-params\">stdio, channel</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// stdio[xxx,xxx,xxx]</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// channel[xxx,xxx,xxx,channel]</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">getValidStdio</span>(<span class=\"hljs-params\">stdio, sync</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> ipc;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> ipcFd;</span><br><span class=\"line\"></span><br><span class=\"line\">  stdio = stdio.<span class=\"title function_\">reduce</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">acc, stdio, i</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">cleanup</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; acc.<span class=\"hljs-property\">length</span>; i++) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> ((acc[i].<span class=\"hljs-property\">type</span> === <span class=\"hljs-string\">\"pipe\"</span> || acc[i].<span class=\"hljs-property\">type</span> === <span class=\"hljs-string\">\"ipc\"</span>) &amp;&amp; acc[i].<span class=\"hljs-property\">handle</span>)</span><br><span class=\"line\">          acc[i].<span class=\"hljs-property\">handle</span>.<span class=\"title function_\">close</span>();</span><br><span class=\"line\">      }</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"ignore\"</span>) {</span><br><span class=\"line\">      acc.<span class=\"title function_\">push</span>({ <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">\"ignore\"</span> }); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"pipe\"</span> || (<span class=\"hljs-keyword\">typeof</span> stdio === <span class=\"hljs-string\">\"number\"</span> &amp;&amp; stdio &lt; <span class=\"hljs-number\">0</span>)) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">var</span> a = {</span><br><span class=\"line\">        <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">\"pipe\"</span>,</span><br><span class=\"line\">        <span class=\"hljs-attr\">readable</span>: i === <span class=\"hljs-number\">0</span>, <span class=\"hljs-comment\">// 0stdin</span></span><br><span class=\"line\">        <span class=\"hljs-attr\">writable</span>: i !== <span class=\"hljs-number\">0</span>, <span class=\"hljs-comment\">// 1stdout2stderr </span></span><br><span class=\"line\">      };</span><br><span class=\"line\">      <span class=\"hljs-comment\">// spawn syncfalsestdinstdoutstderrSOCKETPipe</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (!sync) a.<span class=\"hljs-property\">handle</span> = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Pipe</span>(<span class=\"title class_\">PipeConstants</span>.<span class=\"hljs-property\">SOCKET</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      acc.<span class=\"title function_\">push</span>(a);</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"ipc\"</span>) {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// IPCPipe</span></span><br><span class=\"line\">      ipc = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Pipe</span>(<span class=\"title class_\">PipeConstants</span>.<span class=\"hljs-property\">IPC</span>);</span><br><span class=\"line\">      ipcFd = i; <span class=\"hljs-comment\">// ipc</span></span><br><span class=\"line\"></span><br><span class=\"line\">      acc.<span class=\"title function_\">push</span>({</span><br><span class=\"line\">        <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">\"pipe\"</span>,</span><br><span class=\"line\">        <span class=\"hljs-attr\">handle</span>: ipc,</span><br><span class=\"line\">        <span class=\"hljs-attr\">ipc</span>: <span class=\"hljs-literal\">true</span>,</span><br><span class=\"line\">      });</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (stdio === <span class=\"hljs-string\">\"inherit\"</span>) {</span><br><span class=\"line\">      acc.<span class=\"title function_\">push</span>({</span><br><span class=\"line\">        <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">\"inherit\"</span>,</span><br><span class=\"line\">        <span class=\"hljs-attr\">fd</span>: i,</span><br><span class=\"line\">      });</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> acc;</span><br><span class=\"line\">  }, []);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> { stdio, ipc, ipcFd };</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>ChildProcess</code> V8  new ProcessWrap  this._handle</p>\n<p><code>ChildProcess.prototype.spawn</code><a href=\"http://nodejs.cn/api/child_process.html#child_process_options_stdio\"><code>stdio</code></a><code>pipe</code><code>ipc</code> Pipe </p>\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// pipe_wrap.cc</span></span><br><span class=\"line\"><span class=\"hljs-type\">void</span> <span class=\"title function_\">PipeWrap::New</span><span class=\"hljs-params\">(<span class=\"hljs-type\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">switch</span> (type) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">case</span> SOCKET:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">case</span> IPC:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  new PipeWrap(env, args.This(), provider, ipc);</span><br><span class=\"line\">}</span><br><span class=\"line\">PipeWrap::PipeWrap(Environment* env,</span><br><span class=\"line\">                   Local&lt;Object&gt; object,</span><br><span class=\"line\">                   ProviderType provider,</span><br><span class=\"line\">                   <span class=\"hljs-type\">bool</span> ipc)</span><br><span class=\"line\">    : ConnectionWrap(env, object, provider) {</span><br><span class=\"line\">  <span class=\"hljs-type\">int</span> r = uv_pipe_init(env-&gt;event_loop(), &amp;handle_, ipc);</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">// deps/uv/src/unix/pipe.c</span></span><br><span class=\"line\"><span class=\"hljs-type\">int</span> <span class=\"title function_\">uv_pipe_init</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_loop_t</span>* loop, <span class=\"hljs-type\">uv_pipe_t</span>* handle, <span class=\"hljs-type\">int</span> ipc)</span> {</span><br><span class=\"line\">  uv__stream_init(loop, (<span class=\"hljs-type\">uv_stream_t</span>*)handle, UV_NAMED_PIPE);</span><br><span class=\"line\">  handle-&gt;shutdown_req = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;connect_req = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;pipe_fname = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;ipc = ipc;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>uv_pipe_t</code> ipc  true  false<strong> libuv </strong></p>\n<p><code>ChildProcess.prototype.spawn</code> stdio <code>this._handle.spawn(options);</code><code>process_wrap.cc</code> ProcessWrap.Spawn <code>uv_spawn</code></p>\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// deps/uv/src/unix/process.c</span></span><br><span class=\"line\"><span class=\"hljs-type\">int</span> <span class=\"title function_\">uv_spawn</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_loop_t</span>* loop,</span></span><br><span class=\"line\"><span class=\"hljs-params\">             <span class=\"hljs-type\">uv_process_t</span>* process,</span></span><br><span class=\"line\"><span class=\"hljs-params\">             <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uv_process_options_t</span>* options)</span> {</span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">if</span> defined(__APPLE__) &amp;&amp; (TARGET_OS_TV || TARGET_OS_WATCH)</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> UV_ENOSYS;</span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">else</span></span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  uv_signal_start(&amp;loop-&gt;child_watcher, uv__chld, SIGCHLD);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* Acquire write lock to prevent opening new fds in worker threads */</span></span><br><span class=\"line\">  uv_rwlock_wrlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  pid = fork();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (pid == <span class=\"hljs-number\">-1</span>) {</span><br><span class=\"line\">    err = UV__ERR(errno);</span><br><span class=\"line\">    uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"hljs-number\">0</span>]);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"hljs-number\">1</span>]);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">goto</span> error;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (pid == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">    uv__process_child_init(options, stdio_count, pipes, signal_pipe[<span class=\"hljs-number\">1</span>]);</span><br><span class=\"line\">    <span class=\"hljs-built_in\">abort</span>();</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* Release lock in parent process */</span></span><br><span class=\"line\">  uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  uv__close(signal_pipe[<span class=\"hljs-number\">1</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>fork</code> fork  0 <code>uv__process_child_init</code></p>\n<p><code>ChildProcess.prototype.spawn</code><code>stdio</code> handle <code>createSocket</code> socket </p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">createSocket</span>(<span class=\"hljs-params\">pipe, readable</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> net.<span class=\"title class_\">Socket</span>({ <span class=\"hljs-attr\">handle</span>: pipe, readable, <span class=\"hljs-attr\">writable</span>: !readable });</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>stdio</code> pipe  ipc  socket stdinstdout  stderr <code>exec</code><code>execFile</code><code>fork</code> ipc  stdio  fork  send <code>setupChannel</code></p>\n<br>\n\n<br>\n\n<p><strong></strong>Node.js <code>child_process</code> JavaScript  libuv  cluster.fork  child_process.fork </p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<html><head></head><body><p><strong>Node.js </strong></p>\n<p><strong>child_process</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback\">exec</a>:  shell  shell  <code>command</code> 1024*1024 </li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_execfile_file_args_options_callback\">execFile</a>: <code>exec</code> shell <code>file</code> <code>exec</code> <code>exec</code> 1024*1204 </li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_fork_modulepath_args_options\">fork</a>:  <code>spawn</code> Node.js  <code>spawn</code><code>ChildProcess</code> <code>ChildProcess</code></li>\n<li><a href=\"http://nodejs.cn/api/child_process.html#child_process_child_process_spawn_command_args_options\">spawn</a>:  spawn </li>\n</ul>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\">fork</a>: </li>\n</ul></body></html>","more":"<br/>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h3><p><a href=\"https://miser.github.io/2020/03/01/v8-libuv-timer-event-loop/\">libuv &amp; Node.js EventLoop </a></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"section\">#define UV<span class=\"emphasis\">_VERSION_</span>MAJOR 1</span></span><br><span class=\"line\"><span class=\"section\">#define UV<span class=\"emphasis\">_VERSION_</span>MINOR 33</span></span><br><span class=\"line\"><span class=\"section\">#define UV<span class=\"emphasis\">_VERSION_</span>PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"section\">#define V8<span class=\"emphasis\">_MAJOR_</span>VERSION 7</span></span><br><span class=\"line\"><span class=\"section\">#define V8<span class=\"emphasis\">_MINOR_</span>VERSION 8</span></span><br><span class=\"line\"><span class=\"section\">#define V8<span class=\"emphasis\">_BUILD_</span>NUMBER 279</span></span><br><span class=\"line\"><span class=\"section\">#define V8<span class=\"emphasis\">_PATCH_</span>LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"section\">#define NODE<span class=\"emphasis\">_MAJOR_</span>VERSION 14</span></span><br><span class=\"line\"><span class=\"section\">#define NODE<span class=\"emphasis\">_MINOR_</span>VERSION 0</span></span><br><span class=\"line\"><span class=\"section\">#define NODE<span class=\"emphasis\">_PATCH_</span>VERSION 0</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>child_process</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Node</span> </span><br><span class=\"line\">  - lib </span><br><span class=\"line\">  \t- internal </span><br><span class=\"line\">  \t\t- child_process.<span class=\"property\">js</span> </span><br><span class=\"line\">  \t- child_process.<span class=\"property\">js</span>;</span><br></pre></td></tr></table></figure>\n\n<p><code>lib/child_process.js</code><code>exec</code><code>execFile</code><code>fork</code><code>spawn</code><code>lib/internal/child_process.js</code><code>spawn</code></p>\n<br/>\n\n<p><strong>exec</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">exec</span>(<span class=\"params\">command, options, callback</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> opts = <span class=\"title function_\">normalizeExecArgs</span>(command, options, callback);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"variable language_\">module</span>.<span class=\"property\">exports</span>.<span class=\"title function_\">execFile</span>(opts.<span class=\"property\">file</span>, opts.<span class=\"property\">options</span>, opts.<span class=\"property\">callback</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">normalizeExecArgs</span>(<span class=\"params\">command, options, callback</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options === <span class=\"string\">&quot;function&quot;</span>) &#123;</span><br><span class=\"line\">    callback = options;</span><br><span class=\"line\">    options = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Make a shallow copy so we don&#x27;t clobber the user&#x27;s options object.</span></span><br><span class=\"line\">  options = &#123; ...options &#125;;</span><br><span class=\"line\">  options.<span class=\"property\">shell</span> = <span class=\"keyword\">typeof</span> options.<span class=\"property\">shell</span> === <span class=\"string\">&quot;string&quot;</span> ? options.<span class=\"property\">shell</span> : <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">file</span>: command,</span><br><span class=\"line\">    <span class=\"attr\">options</span>: options,</span><br><span class=\"line\">    <span class=\"attr\">callback</span>: callback,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> exec <code>shell</code> execFile </p>\n<br/>\n\n<p><strong>execFile</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">execFile</span>(<span class=\"params\">file <span class=\"comment\">/* , args, options, callback */</span></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> args = [];</span><br><span class=\"line\">  <span class=\"keyword\">let</span> callback;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> options;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  options = &#123;</span><br><span class=\"line\">    <span class=\"attr\">encoding</span>: <span class=\"string\">&quot;utf8&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">timeout</span>: <span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"attr\">maxBuffer</span>: <span class=\"variable constant_\">MAX_BUFFER</span>,</span><br><span class=\"line\">    <span class=\"attr\">killSignal</span>: <span class=\"string\">&quot;SIGTERM&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">cwd</span>: <span class=\"literal\">null</span>,</span><br><span class=\"line\">    <span class=\"attr\">env</span>: <span class=\"literal\">null</span>,</span><br><span class=\"line\">    <span class=\"attr\">shell</span>: <span class=\"literal\">false</span>, <span class=\"comment\">// execFile shell</span></span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// spawn</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> child = <span class=\"title function_\">spawn</span>(file, args, &#123;</span><br><span class=\"line\">    <span class=\"attr\">cwd</span>: options.<span class=\"property\">cwd</span>,</span><br><span class=\"line\">    <span class=\"attr\">env</span>: options.<span class=\"property\">env</span>,</span><br><span class=\"line\">    <span class=\"attr\">gid</span>: options.<span class=\"property\">gid</span>,</span><br><span class=\"line\">    <span class=\"attr\">uid</span>: options.<span class=\"property\">uid</span>,</span><br><span class=\"line\">    <span class=\"attr\">shell</span>: options.<span class=\"property\">shell</span>,</span><br><span class=\"line\">    <span class=\"attr\">windowsHide</span>: !!options.<span class=\"property\">windowsHide</span>,</span><br><span class=\"line\">    <span class=\"attr\">windowsVerbatimArguments</span>: !!options.<span class=\"property\">windowsVerbatimArguments</span>,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> encoding;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> _stdout = []; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> _stderr = []; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> stdoutLen = <span class=\"number\">0</span>; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> stderrLen = <span class=\"number\">0</span>; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> killed = <span class=\"literal\">false</span>; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> exited = <span class=\"literal\">false</span>; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> timeoutId; <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> ex = <span class=\"literal\">null</span>; <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> cmd = file; <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">exithandler</span>(<span class=\"params\">code, signal</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (exited) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    exited = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeoutId) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">clearTimeout</span>(timeoutId);</span><br><span class=\"line\">      timeoutId = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!callback) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// merge chunks</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> stdout;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> stderr;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding || (child.<span class=\"property\">stdout</span> &amp;&amp; child.<span class=\"property\">stdout</span>.<span class=\"property\">readableEncoding</span>)) &#123;</span><br><span class=\"line\">      stdout = _stdout.<span class=\"title function_\">join</span>(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      stdout = <span class=\"title class_\">Buffer</span>.<span class=\"title function_\">concat</span>(_stdout); <span class=\"comment\">//  encoding Buffer</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding || (child.<span class=\"property\">stderr</span> &amp;&amp; child.<span class=\"property\">stderr</span>.<span class=\"property\">readableEncoding</span>)) &#123;</span><br><span class=\"line\">      stderr = _stderr.<span class=\"title function_\">join</span>(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      stderr = <span class=\"title class_\">Buffer</span>.<span class=\"title function_\">concat</span>(_stderr); <span class=\"comment\">//  encoding Buffer</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ex &amp;&amp; code === <span class=\"number\">0</span> &amp;&amp; signal === <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">callback</span>(<span class=\"literal\">null</span>, stdout, stderr); <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (args.<span class=\"property\">length</span> !== <span class=\"number\">0</span>) cmd += <span class=\"string\">` <span class=\"subst\">$&#123;args.join(<span class=\"string\">&quot; &quot;</span>)&#125;</span>`</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ex) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// eslint-disable-next-line no-restricted-syntax</span></span><br><span class=\"line\">      ex = <span class=\"keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"string\">&quot;Command failed: &quot;</span> + cmd + <span class=\"string\">&quot;\\n&quot;</span> + stderr);</span><br><span class=\"line\">      ex.<span class=\"property\">killed</span> = child.<span class=\"property\">killed</span> || killed;</span><br><span class=\"line\">      ex.<span class=\"property\">code</span> = code &lt; <span class=\"number\">0</span> ? <span class=\"title function_\">getSystemErrorName</span>(code) : code;</span><br><span class=\"line\">      ex.<span class=\"property\">signal</span> = signal;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ex.<span class=\"property\">cmd</span> = cmd;</span><br><span class=\"line\">    <span class=\"title function_\">callback</span>(ex, stdout, stderr); <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">errorhandler</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">    ex = e;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// child.stdout  child.stderr </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.<span class=\"property\">stdout</span>) child.<span class=\"property\">stdout</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.<span class=\"property\">stderr</span>) child.<span class=\"property\">stderr</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">exithandler</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">kill</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.<span class=\"property\">stdout</span>) child.<span class=\"property\">stdout</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child.<span class=\"property\">stderr</span>) child.<span class=\"property\">stderr</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    killed = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      child.<span class=\"title function_\">kill</span>(options.<span class=\"property\">killSignal</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">      ex = e;</span><br><span class=\"line\">      <span class=\"title function_\">exithandler</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (options.<span class=\"property\">timeout</span> &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    timeoutId = <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> <span class=\"title function_\">delayedKill</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">kill</span>();</span><br><span class=\"line\">      timeoutId = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;, options.<span class=\"property\">timeout</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (child.<span class=\"property\">stdout</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding) child.<span class=\"property\">stdout</span>.<span class=\"title function_\">setEncoding</span>(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.<span class=\"property\">stdout</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&quot;data&quot;</span>, <span class=\"keyword\">function</span> <span class=\"title function_\">onChildStdout</span>(<span class=\"params\">chunk</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> encoding = child.<span class=\"property\">stdout</span>.<span class=\"property\">readableEncoding</span>;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? <span class=\"title class_\">Buffer</span>.<span class=\"title function_\">byteLength</span>(chunk, encoding)</span><br><span class=\"line\">        : chunk.<span class=\"property\">length</span>;</span><br><span class=\"line\">      stdoutLen += length; <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (stdoutLen &gt; options.<span class=\"property\">maxBuffer</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> truncatedLen = options.<span class=\"property\">maxBuffer</span> - (stdoutLen - length);</span><br><span class=\"line\">        _stdout.<span class=\"title function_\">push</span>(chunk.<span class=\"title function_\">slice</span>(<span class=\"number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"keyword\">new</span> <span class=\"title function_\">ERR_CHILD_PROCESS_STDIO_MAXBUFFER</span>(<span class=\"string\">&quot;stdout&quot;</span>);</span><br><span class=\"line\">        <span class=\"title function_\">kill</span>();</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        _stdout.<span class=\"title function_\">push</span>(chunk); <span class=\"comment\">// chunk</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// child.stdout</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (child.<span class=\"property\">stderr</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (encoding) child.<span class=\"property\">stderr</span>.<span class=\"title function_\">setEncoding</span>(encoding);</span><br><span class=\"line\"></span><br><span class=\"line\">    child.<span class=\"property\">stderr</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&quot;data&quot;</span>, <span class=\"keyword\">function</span> <span class=\"title function_\">onChildStderr</span>(<span class=\"params\">chunk</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> encoding = child.<span class=\"property\">stderr</span>.<span class=\"property\">readableEncoding</span>;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> length = encoding</span><br><span class=\"line\">        ? <span class=\"title class_\">Buffer</span>.<span class=\"title function_\">byteLength</span>(chunk, encoding)</span><br><span class=\"line\">        : chunk.<span class=\"property\">length</span>;</span><br><span class=\"line\">      stderrLen += length;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (stderrLen &gt; options.<span class=\"property\">maxBuffer</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> truncatedLen = options.<span class=\"property\">maxBuffer</span> - (stderrLen - length);</span><br><span class=\"line\">        _stderr.<span class=\"title function_\">push</span>(chunk.<span class=\"title function_\">slice</span>(<span class=\"number\">0</span>, truncatedLen));</span><br><span class=\"line\"></span><br><span class=\"line\">        ex = <span class=\"keyword\">new</span> <span class=\"title function_\">ERR_CHILD_PROCESS_STDIO_MAXBUFFER</span>(<span class=\"string\">&quot;stderr&quot;</span>);</span><br><span class=\"line\">        <span class=\"title function_\">kill</span>();</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        _stderr.<span class=\"title function_\">push</span>(chunk);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  child.<span class=\"title function_\">addListener</span>(<span class=\"string\">&quot;close&quot;</span>, exithandler);</span><br><span class=\"line\">  child.<span class=\"title function_\">addListener</span>(<span class=\"string\">&quot;error&quot;</span>, errorhandler);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> child;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>exec</code><code>execFile</code><code>shell</code><code>child.stderr.on(&#39;data&#39;)</code><code>child.stdout.on(&#39;data&#39;)</code></p>\n<p><code>_stderr</code><code>_stdout</code></p>\n<p><strong><code>spawn</code></strong></p>\n<br/>\n\n<p><strong>fork</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">fork</span>(<span class=\"params\">modulePath <span class=\"comment\">/* , args, options */</span></span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// Get options and args arguments.</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> execArgv;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> options = &#123;&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> args = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// forkstdioipc</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options.<span class=\"property\">stdio</span> === <span class=\"string\">&quot;string&quot;</span>) &#123;</span><br><span class=\"line\">    options.<span class=\"property\">stdio</span> = <span class=\"title function_\">stdioStringToArray</span>(options.<span class=\"property\">stdio</span>, <span class=\"string\">&quot;ipc&quot;</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!<span class=\"title class_\">Array</span>.<span class=\"title function_\">isArray</span>(options.<span class=\"property\">stdio</span>)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Use a separate fd=3 for the IPC channel. Inherit stdin, stdout,</span></span><br><span class=\"line\">    <span class=\"comment\">// and stderr from the parent if silent isn&#x27;t set.</span></span><br><span class=\"line\">    options.<span class=\"property\">stdio</span> = <span class=\"title function_\">stdioStringToArray</span>(</span><br><span class=\"line\">      options.<span class=\"property\">silent</span> ? <span class=\"string\">&quot;pipe&quot;</span> : <span class=\"string\">&quot;inherit&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ipc&quot;</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!options.<span class=\"property\">stdio</span>.<span class=\"title function_\">includes</span>(<span class=\"string\">&quot;ipc&quot;</span>)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title function_\">ERR_CHILD_PROCESS_IPC_REQUIRED</span>(<span class=\"string\">&quot;options.stdio&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  options.<span class=\"property\">execPath</span> = options.<span class=\"property\">execPath</span> || process.<span class=\"property\">execPath</span>; <span class=\"comment\">// Node</span></span><br><span class=\"line\">  options.<span class=\"property\">shell</span> = <span class=\"literal\">false</span>; <span class=\"comment\">//  shell</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"title function_\">spawn</span>(options.<span class=\"property\">execPath</span>, args, options);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> 12~22 fork  stdio  ipc <code>ipc</code><code>spawn</code></p>\n<br/>\n\n<p><strong>spawn</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/child_process.js</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">spawn</span>(<span class=\"params\">file, args, options</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> child = <span class=\"keyword\">new</span> <span class=\"title class_\">ChildProcess</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  options = <span class=\"title function_\">normalizeSpawnArguments</span>(file, args, options);</span><br><span class=\"line\">  <span class=\"title function_\">debug</span>(<span class=\"string\">&quot;spawn&quot;</span>, options);</span><br><span class=\"line\">  child.<span class=\"title function_\">spawn</span>(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> child;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>lib/child_process.js</code> spawn  ChildProcess  spawn</p>\n<br/>\n\n<p><strong>ChildProcess</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// `lib/internal/child_process.js`</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">ChildProcess</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"title class_\">EventEmitter</span>.<span class=\"title function_\">call</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">_handle</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Process</span>(); <span class=\"comment\">// new  ProcessWrap   process_wrap.cc</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">ChildProcess</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">spawn</span> = <span class=\"keyword\">function</span> (<span class=\"params\">options</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  pipe</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> stdio = options.<span class=\"property\">stdio</span> || <span class=\"string\">&quot;pipe&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// stdio</span></span><br><span class=\"line\">  stdio = <span class=\"title function_\">getValidStdio</span>(stdio, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> ipc = stdio.<span class=\"property\">ipc</span>;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> ipcFd = stdio.<span class=\"property\">ipcFd</span>;</span><br><span class=\"line\">  stdio = options.<span class=\"property\">stdio</span> = stdio.<span class=\"property\">stdio</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ProcessWrapspawn</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> err = <span class=\"variable language_\">this</span>.<span class=\"property\">_handle</span>.<span class=\"title function_\">spawn</span>(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// err</span></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">pid</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">_handle</span>.<span class=\"property\">pid</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; stdio.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> stream = stdio[i];</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (stream.<span class=\"property\">handle</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// When i === 0 - we&#x27;re dealing with stdin</span></span><br><span class=\"line\">      <span class=\"comment\">// (which is the only one writable pipe).</span></span><br><span class=\"line\">      <span class=\"comment\">//  socket</span></span><br><span class=\"line\">      stream.<span class=\"property\">socket</span> = <span class=\"title function_\">createSocket</span>(</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">pid</span> !== <span class=\"number\">0</span> ? stream.<span class=\"property\">handle</span> : <span class=\"literal\">null</span>,</span><br><span class=\"line\">        i &gt; <span class=\"number\">0</span></span><br><span class=\"line\">      );</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (i &gt; <span class=\"number\">0</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">pid</span> !== <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">_closesNeeded</span>++;</span><br><span class=\"line\">        stream.<span class=\"property\">socket</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&quot;close&quot;</span>, <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"title function_\">maybeClose</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">stdin</span> =</span><br><span class=\"line\">    stdio.<span class=\"property\">length</span> &gt;= <span class=\"number\">1</span> &amp;&amp; stdio[<span class=\"number\">0</span>].<span class=\"property\">socket</span> !== <span class=\"literal\">undefined</span> ? stdio[<span class=\"number\">0</span>].<span class=\"property\">socket</span> : <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">stdout</span> =</span><br><span class=\"line\">    stdio.<span class=\"property\">length</span> &gt;= <span class=\"number\">2</span> &amp;&amp; stdio[<span class=\"number\">1</span>].<span class=\"property\">socket</span> !== <span class=\"literal\">undefined</span> ? stdio[<span class=\"number\">1</span>].<span class=\"property\">socket</span> : <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">stderr</span> =</span><br><span class=\"line\">    stdio.<span class=\"property\">length</span> &gt;= <span class=\"number\">3</span> &amp;&amp; stdio[<span class=\"number\">2</span>].<span class=\"property\">socket</span> !== <span class=\"literal\">undefined</span> ? stdio[<span class=\"number\">2</span>].<span class=\"property\">socket</span> : <span class=\"literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">stdio</span> = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; stdio.<span class=\"property\">length</span>; i++)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">stdio</span>.<span class=\"title function_\">push</span>(stdio[i].<span class=\"property\">socket</span> === <span class=\"literal\">undefined</span> ? <span class=\"literal\">null</span> : stdio[i].<span class=\"property\">socket</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Add .send() method and start listening for IPC data</span></span><br><span class=\"line\">  <span class=\"comment\">// setupChannel </span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ipc !== <span class=\"literal\">undefined</span>) <span class=\"title function_\">setupChannel</span>(<span class=\"variable language_\">this</span>, ipc);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> err;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">stdioStringToArray</span>(<span class=\"params\">stdio, channel</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// stdio[xxx,xxx,xxx]</span></span><br><span class=\"line\">  <span class=\"comment\">// channel[xxx,xxx,xxx,channel]</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getValidStdio</span>(<span class=\"params\">stdio, sync</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ipc;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ipcFd;</span><br><span class=\"line\"></span><br><span class=\"line\">  stdio = stdio.<span class=\"title function_\">reduce</span>(<span class=\"function\">(<span class=\"params\">acc, stdio, i</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">cleanup</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; acc.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((acc[i].<span class=\"property\">type</span> === <span class=\"string\">&quot;pipe&quot;</span> || acc[i].<span class=\"property\">type</span> === <span class=\"string\">&quot;ipc&quot;</span>) &amp;&amp; acc[i].<span class=\"property\">handle</span>)</span><br><span class=\"line\">          acc[i].<span class=\"property\">handle</span>.<span class=\"title function_\">close</span>();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (stdio === <span class=\"string\">&quot;ignore&quot;</span>) &#123;</span><br><span class=\"line\">      acc.<span class=\"title function_\">push</span>(&#123; <span class=\"attr\">type</span>: <span class=\"string\">&quot;ignore&quot;</span> &#125;); <span class=\"comment\">// </span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (stdio === <span class=\"string\">&quot;pipe&quot;</span> || (<span class=\"keyword\">typeof</span> stdio === <span class=\"string\">&quot;number&quot;</span> &amp;&amp; stdio &lt; <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> a = &#123;</span><br><span class=\"line\">        <span class=\"attr\">type</span>: <span class=\"string\">&quot;pipe&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">readable</span>: i === <span class=\"number\">0</span>, <span class=\"comment\">// 0stdin</span></span><br><span class=\"line\">        <span class=\"attr\">writable</span>: i !== <span class=\"number\">0</span>, <span class=\"comment\">// 1stdout2stderr </span></span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">      <span class=\"comment\">// spawn syncfalsestdinstdoutstderrSOCKETPipe</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!sync) a.<span class=\"property\">handle</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Pipe</span>(<span class=\"title class_\">PipeConstants</span>.<span class=\"property\">SOCKET</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      acc.<span class=\"title function_\">push</span>(a);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (stdio === <span class=\"string\">&quot;ipc&quot;</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// IPCPipe</span></span><br><span class=\"line\">      ipc = <span class=\"keyword\">new</span> <span class=\"title class_\">Pipe</span>(<span class=\"title class_\">PipeConstants</span>.<span class=\"property\">IPC</span>);</span><br><span class=\"line\">      ipcFd = i; <span class=\"comment\">// ipc</span></span><br><span class=\"line\"></span><br><span class=\"line\">      acc.<span class=\"title function_\">push</span>(&#123;</span><br><span class=\"line\">        <span class=\"attr\">type</span>: <span class=\"string\">&quot;pipe&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">handle</span>: ipc,</span><br><span class=\"line\">        <span class=\"attr\">ipc</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (stdio === <span class=\"string\">&quot;inherit&quot;</span>) &#123;</span><br><span class=\"line\">      acc.<span class=\"title function_\">push</span>(&#123;</span><br><span class=\"line\">        <span class=\"attr\">type</span>: <span class=\"string\">&quot;inherit&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">fd</span>: i,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> acc;</span><br><span class=\"line\">  &#125;, []);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123; stdio, ipc, ipcFd &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>ChildProcess</code> V8  new ProcessWrap  this._handle</p>\n<p><code>ChildProcess.prototype.spawn</code><a href=\"http://nodejs.cn/api/child_process.html#child_process_options_stdio\"><code>stdio</code></a><code>pipe</code><code>ipc</code> Pipe </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// pipe_wrap.cc</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">PipeWrap::New</span><span class=\"params\">(<span class=\"type\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">switch</span> (type) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> SOCKET:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"literal\">false</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> IPC:</span><br><span class=\"line\">      provider = PROVIDER_PIPEWRAP;</span><br><span class=\"line\">      ipc = <span class=\"literal\">true</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  new PipeWrap(env, args.This(), provider, ipc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">PipeWrap::PipeWrap(Environment* env,</span><br><span class=\"line\">                   Local&lt;Object&gt; object,</span><br><span class=\"line\">                   ProviderType provider,</span><br><span class=\"line\">                   <span class=\"type\">bool</span> ipc)</span><br><span class=\"line\">    : ConnectionWrap(env, object, provider) &#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> r = uv_pipe_init(env-&gt;event_loop(), &amp;handle_, ipc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// deps/uv/src/unix/pipe.c</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">uv_pipe_init</span><span class=\"params\">(<span class=\"type\">uv_loop_t</span>* loop, <span class=\"type\">uv_pipe_t</span>* handle, <span class=\"type\">int</span> ipc)</span> &#123;</span><br><span class=\"line\">  uv__stream_init(loop, (<span class=\"type\">uv_stream_t</span>*)handle, UV_NAMED_PIPE);</span><br><span class=\"line\">  handle-&gt;shutdown_req = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;connect_req = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;pipe_fname = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  handle-&gt;ipc = ipc;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>uv_pipe_t</code> ipc  true  false<strong> libuv </strong></p>\n<p><code>ChildProcess.prototype.spawn</code> stdio <code>this._handle.spawn(options);</code><code>process_wrap.cc</code> ProcessWrap.Spawn <code>uv_spawn</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// deps/uv/src/unix/process.c</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">uv_spawn</span><span class=\"params\">(<span class=\"type\">uv_loop_t</span>* loop,</span></span><br><span class=\"line\"><span class=\"params\">             <span class=\"type\">uv_process_t</span>* process,</span></span><br><span class=\"line\"><span class=\"params\">             <span class=\"type\">const</span> <span class=\"type\">uv_process_options_t</span>* options)</span> &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> defined(__APPLE__) &amp;&amp; (TARGET_OS_TV || TARGET_OS_WATCH)</span></span><br><span class=\"line\">  <span class=\"comment\">/* fork is marked __WATCHOS_PROHIBITED __TVOS_PROHIBITED. */</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> UV_ENOSYS;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  uv_signal_start(&amp;loop-&gt;child_watcher, uv__chld, SIGCHLD);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Acquire write lock to prevent opening new fds in worker threads */</span></span><br><span class=\"line\">  uv_rwlock_wrlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  pid = fork();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pid == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">    err = UV__ERR(errno);</span><br><span class=\"line\">    uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    uv__close(signal_pipe[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> error;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    uv__process_child_init(options, stdio_count, pipes, signal_pipe[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"built_in\">abort</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Release lock in parent process */</span></span><br><span class=\"line\">  uv_rwlock_wrunlock(&amp;loop-&gt;cloexec_lock);</span><br><span class=\"line\">  uv__close(signal_pipe[<span class=\"number\">1</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>fork</code> fork  0 <code>uv__process_child_init</code></p>\n<p><code>ChildProcess.prototype.spawn</code><code>stdio</code> handle <code>createSocket</code> socket </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">createSocket</span>(<span class=\"params\">pipe, readable</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> net.<span class=\"title class_\">Socket</span>(&#123; <span class=\"attr\">handle</span>: pipe, readable, <span class=\"attr\">writable</span>: !readable &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>stdio</code> pipe  ipc  socket stdinstdout  stderr <code>exec</code><code>execFile</code><code>fork</code> ipc  stdio  fork  send <code>setupChannel</code></p>\n<br/>\n\n<br/>\n\n<p><strong></strong>Node.js <code>child_process</code> JavaScript  libuv  cluster.fork  child_process.fork </p>"},{"title":"debug libuv","keywords":"debug,libuv,C/C++","description":" libuv  C/C++ JavaScript ","date":"2020-09-28T10:31:53.000Z","_content":"\nlibuv  v1.36.0  `gyp_uv.py` ([commit](https://github.com/libuv/libuv/commit/53f3c687fc288708721a5a3d9563febda1b9d2c1)) libuv.a [v1.35 ](https://github.com/libuv/libuv/tree/v1.35.0)`cmake`\n\n### \n\n```shelll\n//  libuv\ngit clone https://github.com/libuv/libuv\ncd libuv\nmkdir -p build\n// DCMAKE_BUILD_TYPE  Debug  libuv \n (cd build && cmake -DCMAKE_BUILD_TYPE=Debug ..)\ncmake --build build\n```\n\n build  libuv_a.a  \n![build dir](/images/debug-libuv/build.jpg)\n\n###  hello world \n\n CLion `helloworld` CMakeLists.txt  libuv  libuv  linuv \n\n```CMakeLists.txt\ncmake_minimum_required(VERSION 3.17)\nproject(helloworld)\nadd_executable(helloworld main.cpp)\n\n#  clone libuv \nset(LIBUVDIR /your/libuv/path)\n# \ninclude_directories(${LIBUVDIR}/src)\ninclude_directories(${LIBUVDIR}/include)\n\nadd_library(libuv STATIC IMPORTED)\nset_target_properties(libuv\n        PROPERTIES IMPORTED_LOCATION\n        ${LIBUVDIR}/build/libuv_a.a)\n\n# \ntarget_link_libraries(helloworld libuv)\n```\n\n main.cpp \n\n```cpp\n#include <stdio.h>\n#include <uv.h>\n\nstatic void cb(uv_write_t *req, int status) {\n  printf(\"Hello from Callback.\\n\");\n}\n\nint main() {\n  uv_tty_t tty;\n  uv_write_t req;\n  uv_tty_init(uv_default_loop(), &tty, 1, 0);\n  char str[] = \"Hello UV!\\n\";\n  int len = strlen(str);\n  uv_buf_t bufs[] = {uv_buf_init(str, len)};\n  uv_write(&req, (uv_stream_t *) &tty, bufs, 1, cb);\n  uv_run(uv_default_loop(), UV_RUN_DEFAULT);\n  return 0;\n}\n```\n\n libuv \n![debug libuv](/images/debug-libuv/debug.jpg)\n\n libuv  C/C++ JavaScript \n","source":"_posts/debug-libuv.md","raw":"---\ntitle: debug libuv\ncategory: C/C++\nkeywords: debug,libuv,C/C++\ndescription:  libuv  C/C++ JavaScript \ntags:\n  - Node.js\n  - libuv\ndate: 2020-09-28 18:31:53\n---\n\nlibuv  v1.36.0  `gyp_uv.py` ([commit](https://github.com/libuv/libuv/commit/53f3c687fc288708721a5a3d9563febda1b9d2c1)) libuv.a [v1.35 ](https://github.com/libuv/libuv/tree/v1.35.0)`cmake`\n\n### \n\n```shelll\n//  libuv\ngit clone https://github.com/libuv/libuv\ncd libuv\nmkdir -p build\n// DCMAKE_BUILD_TYPE  Debug  libuv \n (cd build && cmake -DCMAKE_BUILD_TYPE=Debug ..)\ncmake --build build\n```\n\n build  libuv_a.a  \n![build dir](/images/debug-libuv/build.jpg)\n\n###  hello world \n\n CLion `helloworld` CMakeLists.txt  libuv  libuv  linuv \n\n```CMakeLists.txt\ncmake_minimum_required(VERSION 3.17)\nproject(helloworld)\nadd_executable(helloworld main.cpp)\n\n#  clone libuv \nset(LIBUVDIR /your/libuv/path)\n# \ninclude_directories(${LIBUVDIR}/src)\ninclude_directories(${LIBUVDIR}/include)\n\nadd_library(libuv STATIC IMPORTED)\nset_target_properties(libuv\n        PROPERTIES IMPORTED_LOCATION\n        ${LIBUVDIR}/build/libuv_a.a)\n\n# \ntarget_link_libraries(helloworld libuv)\n```\n\n main.cpp \n\n```cpp\n#include <stdio.h>\n#include <uv.h>\n\nstatic void cb(uv_write_t *req, int status) {\n  printf(\"Hello from Callback.\\n\");\n}\n\nint main() {\n  uv_tty_t tty;\n  uv_write_t req;\n  uv_tty_init(uv_default_loop(), &tty, 1, 0);\n  char str[] = \"Hello UV!\\n\";\n  int len = strlen(str);\n  uv_buf_t bufs[] = {uv_buf_init(str, len)};\n  uv_write(&req, (uv_stream_t *) &tty, bufs, 1, cb);\n  uv_run(uv_default_loop(), UV_RUN_DEFAULT);\n  return 0;\n}\n```\n\n libuv \n![debug libuv](/images/debug-libuv/debug.jpg)\n\n libuv  C/C++ JavaScript \n","slug":"debug-libuv","published":1,"updated":"2024-04-08T13:38:55.777Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wdt000618fdb7snh7ob","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p>libuv  v1.36.0  <code>gyp_uv.py</code> (<a href=\"https://github.com/libuv/libuv/commit/53f3c687fc288708721a5a3d9563febda1b9d2c1\">commit</a>) libuv.a <a href=\"https://github.com/libuv/libuv/tree/v1.35.0\">v1.35 </a><code>cmake</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//  libuv</span><br><span class=\"line\">git clone https://github.com/libuv/libuv</span><br><span class=\"line\">cd libuv</span><br><span class=\"line\">mkdir -p build</span><br><span class=\"line\">// DCMAKE_BUILD_TYPE  Debug  libuv </span><br><span class=\"line\"> (cd build &amp;&amp; cmake -DCMAKE_BUILD_TYPE=Debug ..)</span><br><span class=\"line\">cmake --build build</span><br></pre></td></tr></tbody></table></figure>\n\n<p> build  libuv_a.a  <br><img src=\"/images/debug-libuv/build.jpg\" alt=\"build dir\"></p>\n<h3 id=\"-hello-world-\"><a href=\"#-hello-world-\" class=\"headerlink\" title=\" hello world \"></a> hello world </h3><p> CLion <code>helloworld</code> CMakeLists.txt  libuv  libuv  linuv </p>\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cmake_minimum_required(VERSION 3.17)</span><br><span class=\"line\">project(helloworld)</span><br><span class=\"line\">add_executable(helloworld main.cpp)</span><br><span class=\"line\"></span><br><span class=\"line\">#  clone libuv </span><br><span class=\"line\">set(LIBUVDIR /your/libuv/path)</span><br><span class=\"line\"># </span><br><span class=\"line\">include_directories(${LIBUVDIR}/src)</span><br><span class=\"line\">include_directories(${LIBUVDIR}/include)</span><br><span class=\"line\"></span><br><span class=\"line\">add_library(libuv STATIC IMPORTED)</span><br><span class=\"line\">set_target_properties(libuv</span><br><span class=\"line\">        PROPERTIES IMPORTED_LOCATION</span><br><span class=\"line\">        ${LIBUVDIR}/build/libuv_a.a)</span><br><span class=\"line\"></span><br><span class=\"line\"># </span><br><span class=\"line\">target_link_libraries(helloworld libuv)</span><br></pre></td></tr></tbody></table></figure>\n\n<p> main.cpp </p>\n<figure class=\"highlight cpp hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;uv.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title\">cb</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_write_t</span> *req, <span class=\"hljs-type\">int</span> status)</span> </span>{</span><br><span class=\"line\">  <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">\"Hello from Callback.\\n\"</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">  <span class=\"hljs-type\">uv_tty_t</span> tty;</span><br><span class=\"line\">  <span class=\"hljs-type\">uv_write_t</span> req;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">uv_tty_init</span>(<span class=\"hljs-built_in\">uv_default_loop</span>(), &amp;tty, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">  <span class=\"hljs-type\">char</span> str[] = <span class=\"hljs-string\">\"Hello UV!\\n\"</span>;</span><br><span class=\"line\">  <span class=\"hljs-type\">int</span> len = <span class=\"hljs-built_in\">strlen</span>(str);</span><br><span class=\"line\">  <span class=\"hljs-type\">uv_buf_t</span> bufs[] = {<span class=\"hljs-built_in\">uv_buf_init</span>(str, len)};</span><br><span class=\"line\">  <span class=\"hljs-built_in\">uv_write</span>(&amp;req, (<span class=\"hljs-type\">uv_stream_t</span> *) &amp;tty, bufs, <span class=\"hljs-number\">1</span>, cb);</span><br><span class=\"line\">  <span class=\"hljs-built_in\">uv_run</span>(<span class=\"hljs-built_in\">uv_default_loop</span>(), UV_RUN_DEFAULT);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p> libuv <br><img src=\"/images/debug-libuv/debug.jpg\" alt=\"debug libuv\"></p>\n<p> libuv  C/C++ JavaScript </p>\n</body></html>","_categories":[{"name":"C/C++","path":"categories/C-C/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"libuv","path":"tags/libuv/"}],"excerpt":"","more":"<p>libuv  v1.36.0  <code>gyp_uv.py</code> (<a href=\"https://github.com/libuv/libuv/commit/53f3c687fc288708721a5a3d9563febda1b9d2c1\">commit</a>) libuv.a <a href=\"https://github.com/libuv/libuv/tree/v1.35.0\">v1.35 </a><code>cmake</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//  libuv</span><br><span class=\"line\">git clone https://github.com/libuv/libuv</span><br><span class=\"line\">cd libuv</span><br><span class=\"line\">mkdir -p build</span><br><span class=\"line\">// DCMAKE_BUILD_TYPE  Debug  libuv </span><br><span class=\"line\"> (cd build &amp;&amp; cmake -DCMAKE_BUILD_TYPE=Debug ..)</span><br><span class=\"line\">cmake --build build</span><br></pre></td></tr></table></figure>\n\n<p> build  libuv_a.a  <br><img src=\"/images/debug-libuv/build.jpg\" alt=\"build dir\"></p>\n<h3 id=\"-hello-world-\"><a href=\"#-hello-world-\" class=\"headerlink\" title=\" hello world \"></a> hello world </h3><p> CLion <code>helloworld</code> CMakeLists.txt  libuv  libuv  linuv </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cmake_minimum_required(VERSION 3.17)</span><br><span class=\"line\">project(helloworld)</span><br><span class=\"line\">add_executable(helloworld main.cpp)</span><br><span class=\"line\"></span><br><span class=\"line\">#  clone libuv </span><br><span class=\"line\">set(LIBUVDIR /your/libuv/path)</span><br><span class=\"line\"># </span><br><span class=\"line\">include_directories($&#123;LIBUVDIR&#125;/src)</span><br><span class=\"line\">include_directories($&#123;LIBUVDIR&#125;/include)</span><br><span class=\"line\"></span><br><span class=\"line\">add_library(libuv STATIC IMPORTED)</span><br><span class=\"line\">set_target_properties(libuv</span><br><span class=\"line\">        PROPERTIES IMPORTED_LOCATION</span><br><span class=\"line\">        $&#123;LIBUVDIR&#125;/build/libuv_a.a)</span><br><span class=\"line\"></span><br><span class=\"line\"># </span><br><span class=\"line\">target_link_libraries(helloworld libuv)</span><br></pre></td></tr></table></figure>\n\n<p> main.cpp </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;uv.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">cb</span><span class=\"params\">(<span class=\"type\">uv_write_t</span> *req, <span class=\"type\">int</span> status)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello from Callback.\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"type\">uv_tty_t</span> tty;</span><br><span class=\"line\">  <span class=\"type\">uv_write_t</span> req;</span><br><span class=\"line\">  <span class=\"built_in\">uv_tty_init</span>(<span class=\"built_in\">uv_default_loop</span>(), &amp;tty, <span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"type\">char</span> str[] = <span class=\"string\">&quot;Hello UV!\\n&quot;</span>;</span><br><span class=\"line\">  <span class=\"type\">int</span> len = <span class=\"built_in\">strlen</span>(str);</span><br><span class=\"line\">  <span class=\"type\">uv_buf_t</span> bufs[] = &#123;<span class=\"built_in\">uv_buf_init</span>(str, len)&#125;;</span><br><span class=\"line\">  <span class=\"built_in\">uv_write</span>(&amp;req, (<span class=\"type\">uv_stream_t</span> *) &amp;tty, bufs, <span class=\"number\">1</span>, cb);</span><br><span class=\"line\">  <span class=\"built_in\">uv_run</span>(<span class=\"built_in\">uv_default_loop</span>(), UV_RUN_DEFAULT);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> libuv <br><img src=\"/images/debug-libuv/debug.jpg\" alt=\"debug libuv\"></p>\n<p> libuv  C&#x2F;C++ JavaScript </p>\n"},{"title":"Egg Cluster ","keywords":",Eggjs,Egg Cluster","description":"Egg.js","date":"2019-01-18T05:48:01.464Z","_content":"\nEgg.js[](https://eggjs.org)____\n\n> 1. Egg [](https://eggjs.org/zh-cn/advanced/framework.html) \n> 2.[](https://eggjs.org/zh-cn/basics/plugin.html)\n> 3.[](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n> 4. [Koa](http://koajs.com/) \n> 5.\n> 6.[](https://eggjs.org/zh-cn/tutorials/progressive.html)\n\n1Koa2KoaExpress4Koa56\n\n3____nodejs\n\n<!-- more -->\n\n\n\n### __#__\n\n- __egg-core__: __EggCore__KoaApplication4 *Koa*\n- __egg__: EggCore__EggApplication__ApplicationAgentEggApplication\n- __egg-cluster__: ____\n\n*egg-clusterEgg.js*\n\n### egg-cluster\n\n```javascript\n// egg-cluster index.js  startCluster\nexports.startCluster = function (options, callback) {\n    new Master(options).ready(callback)\n}\n```\n\negg-clusterMastereggangentworkersapplication,\n![Master-Agent-Works ](/images/egg-cluster/1.jpg)\n\n### Agent-Works\n```javascript\nclass Master extends EventEmitter {\n    constructor(options) {\n        this.workerManager = new Manager();\n    \tthis.messenger = new Messenger(this);\n        // ...\n\t\tthis.once('agent-start', this.forkAppWorkers.bind(this));\n        // ...\n        detectPort((err, port) => {\n            // port\n            this.options.clusterPort = port;\n            //  agent\n            this.forkAgentWorker();\n        });\n        // ...\n    }\n    forkAgentWorker() {\n        // ... childprocess.fork egg-cluster/lib/agent_worker.js\n        const agentWorker = childprocess.fork(this.getAgentWorkerFile(), args, opt);\n        // ...\n    }\n    forkAppWorkers() {\n        //  worker \n        // cluster.fork egg-cluster/lib/agent_worker.js \n        //  httphttps\n    }\n}\n```\n\nagent_worker.jseggAgent\"agent-start\"MasterWorkers\n\n```javascript\n// egg-cluster/lib/agent_worker.js\n// ...\nprocess.send({ action: 'agent-start', to: 'master' }); \n// ...\n```\n\n### Agent-Works? ([IPC](https://eggjs.org/zh-cn/core/cluster-and-ipc.html))\n\n- MasterMessengeregg-cluster/lib/utils/messenger.js\n- EggApplicationMessengeregg/lib/core/messenger.js\n\nAgentWorker(Application)EggApplicationMessengersendMasterMastersendAgentWorkerMaster\n\n```javascript\n// egg-cluster master.js\nclass Master extends EventEmitter {\n    forkAppWorkers() {\n        // ...\n        cluster.on('fork', worker => {\n            // ...\n            worker.on('message', msg => {\n            \tif (typeof msg === 'string') msg = { action: msg, data: msg };\n\t            msg.from = 'app';\n    \t        this.messenger.send(msg);\n            });\n            // ...\n        })\n    }\n    forkAgentWorker() {\n        // ...\n        agentWorker.on('message', msg => {\n          if (typeof msg === 'string') msg = { action: msg, data: msg };\n          msg.from = 'agent';\n          this.messenger.send(msg);\n        });\n        // ...\n    }\n}\n```\n\n```javascript\n// egg messenger.js\nclass Messenger extends EventEmitter {\n    send(action, data, to) {\n        sendmessage(process, {\n          action,\n          data,\n          to,\n        });\n        return this;\n     }\n}\n```\n\n__from__...__to__...\n\n![Master-Agent-Works ](/images/egg-cluster/2.jpg)\n\n### [](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n\n![nworkerm](/images/egg-cluster/3.jpg)\n\n- n * m \n- Master\n- eggIPCMaster\n\nsocket[cluster-client](https://github.com/node-modules/cluster-client)\n\n- AgentLeader\n- WorkerFollowerAgent\n\nLeaderAgentdisconfeuerkaFollowerWorker\n\n![socket](/images/egg-cluster/4.jpg)\n\n### cluster-client \n\n```javascript\nclass ClusterClient extends Base {\n    // ...\n    async [init]() {\n        const name = this.options.name;\n        const port = this.options.port;\n        let server;\n        if (this.options.isLeader === true) {\n          server = await ClusterServer.create(name, port);\n          if (!server) {\n            throw new Error(`create \"${name}\" leader failed, the port:${port} is occupied by other`);\n          }\n        } else if (this.options.isLeader === false) {\n          // wait for leader active\n          await ClusterServer.waitFor(port, this.options.maxWaitTime);\n        } else {\n          debug('[ClusterClient:%s] init cluster client, try to seize the leader on port:%d', name, port);\n          server = await ClusterServer.create(name, port);\n        }\n\n        if (server) {\n          this[innerClient] = new Leader(Object.assign({ server }, this.options));\n          debug('[ClusterClient:%s] has seized port %d, and serves as leader client.', name, port);\n        } else {\n          this[innerClient] = new Follower(this.options);\n          debug('[ClusterClient:%s] gives up seizing port %d, and serves as follower client.', name, port);\n        }\n        // ...\n    }\n}\n```\n\n- portdetectPortclusterPort\n- net.create TCPLeaderFollowersocket\n- LeaderpublishFollower\n\ncluster-client\n\n\n\n### __#__\n\nEgg.js","source":"_posts/egg-cluster.md","raw":"---\ntitle: Egg Cluster \ncategory: JavaScript\nkeywords: ,Eggjs,Egg Cluster\ndescription: Egg.js\ntags:\n  - Node.js\n  - JavaScript\ndate: 2019-01-18T13:48:01.464Z\n---\n\nEgg.js[](https://eggjs.org)____\n\n> 1. Egg [](https://eggjs.org/zh-cn/advanced/framework.html) \n> 2.[](https://eggjs.org/zh-cn/basics/plugin.html)\n> 3.[](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n> 4. [Koa](http://koajs.com/) \n> 5.\n> 6.[](https://eggjs.org/zh-cn/tutorials/progressive.html)\n\n1Koa2KoaExpress4Koa56\n\n3____nodejs\n\n<!-- more -->\n\n\n\n### __#__\n\n- __egg-core__: __EggCore__KoaApplication4 *Koa*\n- __egg__: EggCore__EggApplication__ApplicationAgentEggApplication\n- __egg-cluster__: ____\n\n*egg-clusterEgg.js*\n\n### egg-cluster\n\n```javascript\n// egg-cluster index.js  startCluster\nexports.startCluster = function (options, callback) {\n    new Master(options).ready(callback)\n}\n```\n\negg-clusterMastereggangentworkersapplication,\n![Master-Agent-Works ](/images/egg-cluster/1.jpg)\n\n### Agent-Works\n```javascript\nclass Master extends EventEmitter {\n    constructor(options) {\n        this.workerManager = new Manager();\n    \tthis.messenger = new Messenger(this);\n        // ...\n\t\tthis.once('agent-start', this.forkAppWorkers.bind(this));\n        // ...\n        detectPort((err, port) => {\n            // port\n            this.options.clusterPort = port;\n            //  agent\n            this.forkAgentWorker();\n        });\n        // ...\n    }\n    forkAgentWorker() {\n        // ... childprocess.fork egg-cluster/lib/agent_worker.js\n        const agentWorker = childprocess.fork(this.getAgentWorkerFile(), args, opt);\n        // ...\n    }\n    forkAppWorkers() {\n        //  worker \n        // cluster.fork egg-cluster/lib/agent_worker.js \n        //  httphttps\n    }\n}\n```\n\nagent_worker.jseggAgent\"agent-start\"MasterWorkers\n\n```javascript\n// egg-cluster/lib/agent_worker.js\n// ...\nprocess.send({ action: 'agent-start', to: 'master' }); \n// ...\n```\n\n### Agent-Works? ([IPC](https://eggjs.org/zh-cn/core/cluster-and-ipc.html))\n\n- MasterMessengeregg-cluster/lib/utils/messenger.js\n- EggApplicationMessengeregg/lib/core/messenger.js\n\nAgentWorker(Application)EggApplicationMessengersendMasterMastersendAgentWorkerMaster\n\n```javascript\n// egg-cluster master.js\nclass Master extends EventEmitter {\n    forkAppWorkers() {\n        // ...\n        cluster.on('fork', worker => {\n            // ...\n            worker.on('message', msg => {\n            \tif (typeof msg === 'string') msg = { action: msg, data: msg };\n\t            msg.from = 'app';\n    \t        this.messenger.send(msg);\n            });\n            // ...\n        })\n    }\n    forkAgentWorker() {\n        // ...\n        agentWorker.on('message', msg => {\n          if (typeof msg === 'string') msg = { action: msg, data: msg };\n          msg.from = 'agent';\n          this.messenger.send(msg);\n        });\n        // ...\n    }\n}\n```\n\n```javascript\n// egg messenger.js\nclass Messenger extends EventEmitter {\n    send(action, data, to) {\n        sendmessage(process, {\n          action,\n          data,\n          to,\n        });\n        return this;\n     }\n}\n```\n\n__from__...__to__...\n\n![Master-Agent-Works ](/images/egg-cluster/2.jpg)\n\n### [](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n\n![nworkerm](/images/egg-cluster/3.jpg)\n\n- n * m \n- Master\n- eggIPCMaster\n\nsocket[cluster-client](https://github.com/node-modules/cluster-client)\n\n- AgentLeader\n- WorkerFollowerAgent\n\nLeaderAgentdisconfeuerkaFollowerWorker\n\n![socket](/images/egg-cluster/4.jpg)\n\n### cluster-client \n\n```javascript\nclass ClusterClient extends Base {\n    // ...\n    async [init]() {\n        const name = this.options.name;\n        const port = this.options.port;\n        let server;\n        if (this.options.isLeader === true) {\n          server = await ClusterServer.create(name, port);\n          if (!server) {\n            throw new Error(`create \"${name}\" leader failed, the port:${port} is occupied by other`);\n          }\n        } else if (this.options.isLeader === false) {\n          // wait for leader active\n          await ClusterServer.waitFor(port, this.options.maxWaitTime);\n        } else {\n          debug('[ClusterClient:%s] init cluster client, try to seize the leader on port:%d', name, port);\n          server = await ClusterServer.create(name, port);\n        }\n\n        if (server) {\n          this[innerClient] = new Leader(Object.assign({ server }, this.options));\n          debug('[ClusterClient:%s] has seized port %d, and serves as leader client.', name, port);\n        } else {\n          this[innerClient] = new Follower(this.options);\n          debug('[ClusterClient:%s] gives up seizing port %d, and serves as follower client.', name, port);\n        }\n        // ...\n    }\n}\n```\n\n- portdetectPortclusterPort\n- net.create TCPLeaderFollowersocket\n- LeaderpublishFollower\n\ncluster-client\n\n\n\n### __#__\n\nEgg.js","slug":"egg-cluster","published":1,"updated":"2024-04-08T13:35:24.528Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wdu000818fd0hspcv1m","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p>Egg.js<a href=\"https://eggjs.org/\"></a>____</p>\n<blockquote>\n<p>1. Egg <a href=\"https://eggjs.org/zh-cn/advanced/framework.html\"></a> <br>2.<a href=\"https://eggjs.org/zh-cn/basics/plugin.html\"></a><br>3.<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\"></a><br>4. <a href=\"http://koajs.com/\">Koa</a> <br>5.<br>6.<a href=\"https://eggjs.org/zh-cn/tutorials/progressive.html\"></a></p>\n</blockquote>\n<p>1Koa2KoaExpress4Koa56</p>\n<p>3____nodejs</p>\n<span id=\"more\"></span>\n\n\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><ul>\n<li><strong>egg-core</strong>: __EggCore__KoaApplication4 <em>Koa</em></li>\n<li><strong>egg</strong>: EggCore__EggApplication__ApplicationAgentEggApplication</li>\n<li><strong>egg-cluster</strong>: ____</li>\n</ul>\n<p><em>egg-clusterEgg.js</em></p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a>egg-cluster</h3><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster index.js  startCluster</span></span><br><span class=\"line\"><span class=\"hljs-built_in\">exports</span>.<span class=\"hljs-property\">startCluster</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">options, callback</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Master</span>(options).<span class=\"title function_\">ready</span>(callback)</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>egg-clusterMastereggangentworkersapplication,<br><img src=\"/images/egg-cluster/1.jpg\" alt=\"Master-Agent-Works \"></p>\n<h3 id=\"Agent-Works\"><a href=\"#Agent-Works\" class=\"headerlink\" title=\"Agent-Works\"></a>Agent-Works</h3><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">EventEmitter</span> {</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"hljs-params\">options</span>) {</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">workerManager</span> = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Manager</span>();</span><br><span class=\"line\">    \t<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span> = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Messenger</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">\t\t<span class=\"variable language_\">this</span>.<span class=\"title function_\">once</span>(<span class=\"hljs-string\">'agent-start'</span>, <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">forkAppWorkers</span>.<span class=\"title function_\">bind</span>(<span class=\"variable language_\">this</span>));</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        <span class=\"title function_\">detectPort</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">err, port</span>) =&gt;</span> {</span><br><span class=\"line\">            <span class=\"hljs-comment\">// port</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>.<span class=\"hljs-property\">clusterPort</span> = port;</span><br><span class=\"line\">            <span class=\"hljs-comment\">//  agent</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">forkAgentWorker</span>();</span><br><span class=\"line\">        });</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"title function_\">forkAgentWorker</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ... childprocess.fork egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> agentWorker = childprocess.<span class=\"title function_\">fork</span>(<span class=\"variable language_\">this</span>.<span class=\"title function_\">getAgentWorkerFile</span>(), args, opt);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"title function_\">forkAppWorkers</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">//  worker </span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// cluster.fork egg-cluster/lib/agent_worker.js </span></span><br><span class=\"line\">        <span class=\"hljs-comment\">//  httphttps</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>agent_worker.jseggAgentagent-startMasterWorkers</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">process.<span class=\"title function_\">send</span>({ <span class=\"hljs-attr\">action</span>: <span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'master'</span> }); </span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></tbody></table></figure>\n\n<h3 id=\"Agent-Works-IPC\"><a href=\"#Agent-Works-IPC\" class=\"headerlink\" title=\"Agent-Works? (IPC)\"></a>Agent-Works? (<a href=\"https://eggjs.org/zh-cn/core/cluster-and-ipc.html\">IPC</a>)</h3><ul>\n<li>MasterMessengeregg-cluster/lib/utils/messenger.js</li>\n<li>EggApplicationMessengeregg/lib/core/messenger.js</li>\n</ul>\n<p>AgentWorker(Application)EggApplicationMessengersendMasterMastersendAgentWorkerMaster</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster master.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">EventEmitter</span> {</span><br><span class=\"line\">    <span class=\"title function_\">forkAppWorkers</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        cluster.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">'fork'</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">worker</span> =&gt;</span> {</span><br><span class=\"line\">            <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">            worker.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">'message'</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">msg</span> =&gt;</span> {</span><br><span class=\"line\">            \t<span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = { <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg };</span><br><span class=\"line\">\t            msg.<span class=\"hljs-property\">from</span> = <span class=\"hljs-string\">'app'</span>;</span><br><span class=\"line\">    \t        <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span>.<span class=\"title function_\">send</span>(msg);</span><br><span class=\"line\">            });</span><br><span class=\"line\">            <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        })</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"title function_\">forkAgentWorker</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        agentWorker.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">'message'</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">msg</span> =&gt;</span> {</span><br><span class=\"line\">          <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = { <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg };</span><br><span class=\"line\">          msg.<span class=\"hljs-property\">from</span> = <span class=\"hljs-string\">'agent'</span>;</span><br><span class=\"line\">          <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span>.<span class=\"title function_\">send</span>(msg);</span><br><span class=\"line\">        });</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg messenger.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Messenger</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">EventEmitter</span> {</span><br><span class=\"line\">    <span class=\"title function_\">send</span>(<span class=\"hljs-params\">action, data, to</span>) {</span><br><span class=\"line\">        <span class=\"title function_\">sendmessage</span>(process, {</span><br><span class=\"line\">          action,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          to,</span><br><span class=\"line\">        });</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">     }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>__from__<strong>to</strong></p>\n<p><img src=\"/images/egg-cluster/2.jpg\" alt=\"Master-Agent-Works \"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\"></a></h3><p><img src=\"/images/egg-cluster/3.jpg\" alt=\"nworkerm\"></p>\n<ul>\n<li>n * m </li>\n<li>Master</li>\n<li>eggIPCMaster</li>\n</ul>\n<p>socket<a href=\"https://github.com/node-modules/cluster-client\">cluster-client</a></p>\n<ul>\n<li>AgentLeader</li>\n<li>WorkerFollowerAgent</li>\n</ul>\n<p>LeaderAgentdisconfeuerkaFollowerWorker</p>\n<p><img src=\"/images/egg-cluster/4.jpg\" alt=\"socket\"></p>\n<h3 id=\"cluster-client-\"><a href=\"#cluster-client-\" class=\"headerlink\" title=\"cluster-client \"></a>cluster-client </h3><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">ClusterClient</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">Base</span> {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> [init]() {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> name = <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>.<span class=\"hljs-property\">name</span>;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> port = <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>.<span class=\"hljs-property\">port</span>;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> server;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>.<span class=\"hljs-property\">isLeader</span> === <span class=\"hljs-literal\">true</span>) {</span><br><span class=\"line\">          server = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">ClusterServer</span>.<span class=\"title function_\">create</span>(name, port);</span><br><span class=\"line\">          <span class=\"hljs-keyword\">if</span> (!server) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"hljs-string\">`create \"<span class=\"hljs-subst\">${name}</span>\" leader failed, the port:<span class=\"hljs-subst\">${port}</span> is occupied by other`</span>);</span><br><span class=\"line\">          }</span><br><span class=\"line\">        } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>.<span class=\"hljs-property\">isLeader</span> === <span class=\"hljs-literal\">false</span>) {</span><br><span class=\"line\">          <span class=\"hljs-comment\">// wait for leader active</span></span><br><span class=\"line\">          <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">ClusterServer</span>.<span class=\"title function_\">waitFor</span>(port, <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>.<span class=\"hljs-property\">maxWaitTime</span>);</span><br><span class=\"line\">        } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">          <span class=\"title function_\">debug</span>(<span class=\"hljs-string\">'[ClusterClient:%s] init cluster client, try to seize the leader on port:%d'</span>, name, port);</span><br><span class=\"line\">          server = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">ClusterServer</span>.<span class=\"title function_\">create</span>(name, port);</span><br><span class=\"line\">        }</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (server) {</span><br><span class=\"line\">          <span class=\"variable language_\">this</span>[innerClient] = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Leader</span>(<span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>({ server }, <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>));</span><br><span class=\"line\">          <span class=\"title function_\">debug</span>(<span class=\"hljs-string\">'[ClusterClient:%s] has seized port %d, and serves as leader client.'</span>, name, port);</span><br><span class=\"line\">        } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">          <span class=\"variable language_\">this</span>[innerClient] = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Follower</span>(<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>);</span><br><span class=\"line\">          <span class=\"title function_\">debug</span>(<span class=\"hljs-string\">'[ClusterClient:%s] gives up seizing port %d, and serves as follower client.'</span>, name, port);</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<ul>\n<li>portdetectPortclusterPort</li>\n<li>net.create TCPLeaderFollowersocket</li>\n<li>LeaderpublishFollower</li>\n</ul>\n<p>cluster-client</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>Egg.js</p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<html><head></head><body><p>Egg.js<a href=\"https://eggjs.org/\"></a>____</p>\n<blockquote>\n<p>1. Egg <a href=\"https://eggjs.org/zh-cn/advanced/framework.html\"></a> <br>2.<a href=\"https://eggjs.org/zh-cn/basics/plugin.html\"></a><br>3.<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\"></a><br>4. <a href=\"http://koajs.com/\">Koa</a> <br>5.<br>6.<a href=\"https://eggjs.org/zh-cn/tutorials/progressive.html\"></a></p>\n</blockquote>\n<p>1Koa2KoaExpress4Koa56</p>\n<p>3____nodejs</p></body></html>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><ul>\n<li><strong>egg-core</strong>: __EggCore__KoaApplication4 <em>Koa</em></li>\n<li><strong>egg</strong>: EggCore__EggApplication__ApplicationAgentEggApplication</li>\n<li><strong>egg-cluster</strong>: ____</li>\n</ul>\n<p><em>egg-clusterEgg.js</em></p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a>egg-cluster</h3><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster index.js  startCluster</span></span><br><span class=\"line\"><span class=\"built_in\">exports</span>.<span class=\"property\">startCluster</span> = <span class=\"keyword\">function</span> (<span class=\"params\">options, callback</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">new</span> <span class=\"title class_\">Master</span>(options).<span class=\"title function_\">ready</span>(callback)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>egg-clusterMastereggangentworkersapplication,<br><img src=\"/images/egg-cluster/1.jpg\" alt=\"Master-Agent-Works \"></p>\n<h3 id=\"Agent-Works\"><a href=\"#Agent-Works\" class=\"headerlink\" title=\"Agent-Works\"></a>Agent-Works</h3><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">EventEmitter</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">options</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">workerManager</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Manager</span>();</span><br><span class=\"line\">    \t<span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Messenger</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">\t\t<span class=\"variable language_\">this</span>.<span class=\"title function_\">once</span>(<span class=\"string\">&#x27;agent-start&#x27;</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">forkAppWorkers</span>.<span class=\"title function_\">bind</span>(<span class=\"variable language_\">this</span>));</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        <span class=\"title function_\">detectPort</span>(<span class=\"function\">(<span class=\"params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// port</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">options</span>.<span class=\"property\">clusterPort</span> = port;</span><br><span class=\"line\">            <span class=\"comment\">//  agent</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">forkAgentWorker</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">forkAgentWorker</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ... childprocess.fork egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> agentWorker = childprocess.<span class=\"title function_\">fork</span>(<span class=\"variable language_\">this</span>.<span class=\"title function_\">getAgentWorkerFile</span>(), args, opt);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">forkAppWorkers</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  worker </span></span><br><span class=\"line\">        <span class=\"comment\">// cluster.fork egg-cluster/lib/agent_worker.js </span></span><br><span class=\"line\">        <span class=\"comment\">//  httphttps</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>agent_worker.jseggAgentagent-startMasterWorkers</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">process.<span class=\"title function_\">send</span>(&#123; <span class=\"attr\">action</span>: <span class=\"string\">&#x27;agent-start&#x27;</span>, <span class=\"attr\">to</span>: <span class=\"string\">&#x27;master&#x27;</span> &#125;); </span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Agent-Works-IPC\"><a href=\"#Agent-Works-IPC\" class=\"headerlink\" title=\"Agent-Works? (IPC)\"></a>Agent-Works? (<a href=\"https://eggjs.org/zh-cn/core/cluster-and-ipc.html\">IPC</a>)</h3><ul>\n<li>MasterMessengeregg-cluster&#x2F;lib&#x2F;utils&#x2F;messenger.js</li>\n<li>EggApplicationMessengeregg&#x2F;lib&#x2F;core&#x2F;messenger.js</li>\n</ul>\n<p>AgentWorker(Application)EggApplicationMessengersendMasterMastersendAgentWorkerMaster</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster master.js</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">EventEmitter</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">forkAppWorkers</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        cluster.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;fork&#x27;</span>, <span class=\"function\"><span class=\"params\">worker</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// ...</span></span><br><span class=\"line\">            worker.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;message&#x27;</span>, <span class=\"function\"><span class=\"params\">msg</span> =&gt;</span> &#123;</span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">&#x27;string&#x27;</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">\t            msg.<span class=\"property\">from</span> = <span class=\"string\">&#x27;app&#x27;</span>;</span><br><span class=\"line\">    \t        <span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span>.<span class=\"title function_\">send</span>(msg);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            <span class=\"comment\">// ...</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">forkAgentWorker</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        agentWorker.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;message&#x27;</span>, <span class=\"function\"><span class=\"params\">msg</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">&#x27;string&#x27;</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">          msg.<span class=\"property\">from</span> = <span class=\"string\">&#x27;agent&#x27;</span>;</span><br><span class=\"line\">          <span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span>.<span class=\"title function_\">send</span>(msg);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg messenger.js</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Messenger</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">EventEmitter</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">send</span>(<span class=\"params\">action, data, to</span>) &#123;</span><br><span class=\"line\">        <span class=\"title function_\">sendmessage</span>(process, &#123;</span><br><span class=\"line\">          action,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          to,</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>__from__<strong>to</strong></p>\n<p><img src=\"/images/egg-cluster/2.jpg\" alt=\"Master-Agent-Works \"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\"></a></h3><p><img src=\"/images/egg-cluster/3.jpg\" alt=\"nworkerm\"></p>\n<ul>\n<li>n * m </li>\n<li>Master</li>\n<li>eggIPCMaster</li>\n</ul>\n<p>socket<a href=\"https://github.com/node-modules/cluster-client\">cluster-client</a></p>\n<ul>\n<li>AgentLeader</li>\n<li>WorkerFollowerAgent</li>\n</ul>\n<p>LeaderAgentdisconfeuerkaFollowerWorker</p>\n<p><img src=\"/images/egg-cluster/4.jpg\" alt=\"socket\"></p>\n<h3 id=\"cluster-client-\"><a href=\"#cluster-client-\" class=\"headerlink\" title=\"cluster-client \"></a>cluster-client </h3><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ClusterClient</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">Base</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">async</span> [init]() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> name = <span class=\"variable language_\">this</span>.<span class=\"property\">options</span>.<span class=\"property\">name</span>;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> port = <span class=\"variable language_\">this</span>.<span class=\"property\">options</span>.<span class=\"property\">port</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> server;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">options</span>.<span class=\"property\">isLeader</span> === <span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">          server = <span class=\"keyword\">await</span> <span class=\"title class_\">ClusterServer</span>.<span class=\"title function_\">create</span>(name, port);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (!server) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"string\">`create &quot;<span class=\"subst\">$&#123;name&#125;</span>&quot; leader failed, the port:<span class=\"subst\">$&#123;port&#125;</span> is occupied by other`</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">options</span>.<span class=\"property\">isLeader</span> === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// wait for leader active</span></span><br><span class=\"line\">          <span class=\"keyword\">await</span> <span class=\"title class_\">ClusterServer</span>.<span class=\"title function_\">waitFor</span>(port, <span class=\"variable language_\">this</span>.<span class=\"property\">options</span>.<span class=\"property\">maxWaitTime</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"title function_\">debug</span>(<span class=\"string\">&#x27;[ClusterClient:%s] init cluster client, try to seize the leader on port:%d&#x27;</span>, name, port);</span><br><span class=\"line\">          server = <span class=\"keyword\">await</span> <span class=\"title class_\">ClusterServer</span>.<span class=\"title function_\">create</span>(name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (server) &#123;</span><br><span class=\"line\">          <span class=\"variable language_\">this</span>[innerClient] = <span class=\"keyword\">new</span> <span class=\"title class_\">Leader</span>(<span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>(&#123; server &#125;, <span class=\"variable language_\">this</span>.<span class=\"property\">options</span>));</span><br><span class=\"line\">          <span class=\"title function_\">debug</span>(<span class=\"string\">&#x27;[ClusterClient:%s] has seized port %d, and serves as leader client.&#x27;</span>, name, port);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"variable language_\">this</span>[innerClient] = <span class=\"keyword\">new</span> <span class=\"title class_\">Follower</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">options</span>);</span><br><span class=\"line\">          <span class=\"title function_\">debug</span>(<span class=\"string\">&#x27;[ClusterClient:%s] gives up seizing port %d, and serves as follower client.&#x27;</span>, name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>portdetectPortclusterPort</li>\n<li>net.create TCPLeaderFollowersocket</li>\n<li>LeaderpublishFollower</li>\n</ul>\n<p>cluster-client</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>Egg.js</p>"},{"title":"Eggjs Boot","keywords":"Eggjs Boot,Eggjs,Eggjs","description":"This article will introduce the boot of Eggjs that is a Node.js web framework.It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.","date":"2019-05-09T07:01:08.568Z","_content":"\n### **#Preface**\n\nThis article will introduce the boot of [Eggjs](<https://eggjs.org/>) that is a Node.js web framework.\n\nIt is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.\n\nEggjs has a few major libs, egg-coreeggegg-clusteregg-binegg-scripts and so on.\n\n**egg-core**: it extends Koa and is as a parent object of every agent and worker.\n\n**egg**: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.\n\n**egg-cluster**: it creates a cluster and manages them.\n\n**egg-scripts and Egg-bin**: their job is run the whole app in a different environment.\n\n<br/>\n\n_**Tips: We will discuss Eggjs with basing 2.x.x version.**_\n\n<br/>\n\n<!-- more -->\n\n## **#Scan Libs Code**\n\n_* The directory and the code segment are not whole content after this post, these major are only for a better explanation._\n\n### **egg-core**\n\n```\n lib\n   / loader (dir)\n   mixin (dir)\n   utils (dir)\n  egg.js\n  lifecycle.js\n```\n\nThe above is the directory structure of egg-core.The _**egg.js**_ and folder of the _**loader**_ are important to point for this lib.\n\nSee egg.js\n\n```javascript\nconst KoaApplication = require('koa')\nconst Lifecycle = require('./lifecycle')\n\nclass EggCore extends KoaApplication {\n  constructor(options = {}) {\n    // ...\n    this.lifecycle = new Lifecycle({\n      baseDir: options.baseDir,\n      app: this,\n      logger: this.console\n    })\n\n    const Loader = this[EGG_LOADER]\n    assert(Loader, \"Symbol.for('egg#loader') is required\")\n    this.loader = new Loader({\n      baseDir: options.baseDir,\n      app: this,\n      plugins: options.plugins,\n      logger: this.console,\n      serverScope: options.serverScope,\n      env: options.env\n    })\n    // ...\n  }\n  beforeStart(scope) {\n    this.lifecycle.registerBeforeStart(scope)\n  }\n  ready(flagOrFunction) {\n    return this.lifecycle.ready(flagOrFunction)\n  }\n  get [EGG_LOADER]() {\n    return require('./loader/egg_loader')\n  }\n}\n```\n\nFirst, we can know why it is called that bases on Koa because EggCore extends KoaApplication.\n\nSecond, it defines a few new fields in the construction function, such as _lifecycle_ and _loader_. The _loader_ field helps app for creating important feature include configplugincontrollerextendroutermiddlewareservice and so on, it will load some js file in the special directory when the app is starting.\n\nAnother side, both _beforeStart_ and _ready_ often are called when we need to write some plugins.\n\n### **egg**\n\n```\n / app\n / config\n / lib\n  - / core\n    - / messenger\n  - / jsdoc\n  - / loader\n  - agent.js\n  - application.js\n  - egg.js\n  - start.js\n- index.js\n```\n\nThere is an egg.js file that is the same name in the egg-core, but it bases on _EggCore Class_ and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.\n\nSee egg.js\n\n```javascript\nconst EggCore = require('egg-core').EggCore\nconst cluster = require('cluster-client')\nconst Messenger = require('./core/messenger')\n\nclass EggApplication extends EggCore {\n  constructor(options = {}) {\n    this.loader.loadConfig()\n    this.messenger = Messenger.create(this)\n\n    // trigger serverDidReady hook when all app workers\n    // and agent worker is ready\n    this.messenger.once('egg-ready', () => {\n      this.lifecycle.triggerServerDidReady()\n    })\n\n    this.ready(() =>\n      process.nextTick(() => {\n        const dumpStartTime = Date.now()\n        this.dumpConfig()\n        this.dumpTiming()\n        this.coreLogger.info(\n          '[egg:core] dump config after ready, %s',\n          ms(Date.now() - dumpStartTime)\n        )\n      })\n    )\n\n    this.cluster = (clientClass, options) => {\n      options = Object.assign({}, this.config.clusterClient, options, {\n        singleMode: this.options.mode === 'single',\n        // cluster need a port that can't conflict on the environment\n        port: this.options.clusterPort,\n        // agent worker is leader, app workers are follower\n        isLeader: this.type === 'agent',\n        logger: this.coreLogger\n      })\n      const client = cluster(clientClass, options)\n      this._patchClusterClient(client)\n      return client\n    }\n  }\n}\n```\n\nSee agent.js and application.js\n\n```javascript\n// agent.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AgentWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Agent extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'agent'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AgentWorkerLoader\n  }\n}\n\n// application.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AppWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Application extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'application'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AppWorkerLoader\n  }\n}\n```\n\nWe can see that they override the _EGG_LOADER_ property, which uses to create a new _loader_ field in the construction of EggCore that is their parent class. Finally, they call the _load_ function.\n\nWe have the base application code. rNext, look a few of libs for starting web app.\n\n### **egg-scripts and egg-bin**\n\nBoth these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don't know them at most of time.\n\n```javascript\n// package.json\n{\n  \"scripts\": {\n    \"start\": \"env egg-scripts start\",\n    \"dev\": \"env egg-bin dev\",\n    \"stop\": \"egg-scripts stop\",\n    \"debug\": \"egg-bin debug\",\n    \"test\": \"npm run lint -- --fix && npm run test-local\",\n    \"test-local\": \"env egg-bin test\",\n    \"cov\": \"egg-bin cov\"\n}\n```\n\nThe _scripts_ command of this eggjs app conforms to the above description.\n\n### **egg-cluster**\n\nThe cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.\n\n```\n- / lib\n  - / utils\n  - agent_worker.js\n  - app_worker.js\n  - master.js\n- index.js\n```\n\nI had written an [article](/2019/01/18/egg-cluster) about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.\n\n## **#From start to getting the first request**\n\n**What happens when we input `npm run dev` or `npm start` in the terminal?**\n\n- **egg-scripts(prod):** it can require _framework_ by `child_process.spawn` and calls _startCluster_ function.\n- **egg-bin(dev):** it can require _framework_ by `child_process.fork` and calls _startCluster_ function.\n- `[parent process]`: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the `framework` is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as `--framework { your path }`\n\n**Pseudo Code**\n\n```javascript\n// egg-scripts\n// parent process\nconst spawn = require('child_process').spawn // create new process\nspawn('node', 'require({{ framework path }}).startCluster(...)', options))\n\n// egg-bin\n// parent process\nconst cp = require('child_process')\ncp.fork('require({{ framework path }}).startCluster(...)', args, options) // create new process\n```\n\nEgg-scripts uses `spawn` function to require framework while egg-scripts calls `fork` function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.\n\nWe have two processes. In general, this newly created process is called the master process.\n\n**Why is the master process called birdge?**\n\n```javascript\n// egg index.js\nexports.startCluster = require('egg-cluster').startCluster\n```\n\nActually, we exec `egg-cluster`'s startCluster function when we require the framework. We open `index.js` file in the egg-cluster lib. \n\n__First, it is real enter point for whole web app.__\n\n```javascript\n// index.js\nconst Master = require('./lib/master')\nexports.startCluster = function(options, callback) {\n  new Master(options).ready(callback)\n}\n\n// ./lib/master.js\nconst ready = require('get-ready')\nconst detectPort = require('detect-port')\nconst Manager = require('./utils/manager')\nconst Messenger = require('./utils/messenger')\n\nclass Master extends EventEmitter {\n  constructor(options) {\n    super()\n    this.options = parseOptions(options)\n    this.workerManager = new Manager()\n    this.messenger = new Messenger(this)\n\n    ready.mixin(this)\n\n    this.ready(() => {\n      this.isStarted = true\n      const action = 'egg-ready'\n      this.messenger.send({\n        action,\n        to: 'parent',\n        data: { port: this[REALPORT], address: this[APP_ADDRESS] }\n      })\n      this.messenger.send({ action, to: 'app', data: this.options })\n      this.messenger.send({ action, to: 'agent', data: this.options })\n\n      // start check agent and worker status\n      if (this.isProduction) {\n        this.workerManager.startCheck()\n      }\n    })\n\n    // fork app workers after agent started\n    this.once('agent-start', this.forkAppWorkers.bind(this))\n\n    detectPort((err, port) => {\n      /* istanbul ignore if */\n      if (err) {\n        err.name = 'ClusterPortConflictError'\n        err.message = '[master] try get free port error, ' + err.message\n        this.logger.error(err)\n        process.exit(1)\n      }\n      this.options.clusterPort = port\n      this.forkAgentWorker()\n    })\n  }\n  forkAppWorkers() {\n    // ...\n    cluster.on('fork', worker => {\n      // ...\n      worker.on('message', msg => {\n        if (typeof msg === 'string') msg = { action: msg, data: msg };\n        msg.from = 'app';\n        this.messenger.send(msg);\n      });\n      // ...\n    })\n  }\n  forkAgentWorker() {\n    // ...\n    agentWorker.on('message', msg => {\n      if (typeof msg === 'string') msg = { action: msg, data: msg };\n      msg.from = 'agent';\n      this.messenger.send(msg);\n    });\n    // ...\n  }\n}\n\n\n// the callback of ready function will be trigger after all major boots had been loaded\n\n// forkAgentWorker\nconst agent = new Agent(options)\nagent.ready(err => {\n  if (err) return\n  process.send({ action: 'agent-start', to: 'master' })\n})\n\n// fork a single worker\nconst app = new Application(options);\nfunction startServer(err) {  \n  let server;\n  if (options.https) {\n    const httpsOptions = Object.assign({}, options.https, {\n      key: fs.readFileSync(options.https.key),\n      cert: fs.readFileSync(options.https.cert),\n    });\n    server = require('https').createServer(httpsOptions, app.callback());\n  } else {\n    server = require('http').createServer(app.callback());\n  }\n\n  // emit `server` event in app\n  app.emit('server', server);\n  \n  server.listen(...args);\n}\napp.ready(startServer);\n```\n\nOn the other hand, this web will be constructed during creating a `Master` object.\n\n- workerManager: it will hold on all worker porcesses.\n- messenger: we make `master` a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an [article(Chinese)]([http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works-IPC)) about it.\n\n> - The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)\n> - EggApplication maintain the other Messenge instance egg/lib/core/messenger.js\n> - Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master\n\n- ready.mixin & this.ready: 'get-ready' often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.\n\n- detectPort: apply for an available port, default is 7001.If Successly, it will `fork` an agent process and register a callback message for new created an agent object.\n\n- `[agent process]`: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.\n\n  - loadPlugin: find all plugin, record their dir paths => this.dirs\n\n  - loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.\n  - loadAgentExtend: load and merge all of the extending of agent object  (*app > plugin > core*)\n  - loadContextExtend: load and merge all of the extending of context object  (*app > plugin > core*)\n  - loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.[Application Startup Configuration(official)](https://eggjs.org/en/basics/app-start.html). It help you for better writing a few plugins.\n  - Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending `'agent-start'` to the master process.\n\n![egg boot process](/images/egg-boot/egg-boot.jpg)\n\n- `[master process]`: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get `'agent-start'` message from the agent process. It will open a new relatable load, we take a single worker process example.\n\n- `[a single worker process]`: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.\n\n  - loadPlugin: same as the agent\n\n  - loadConfig: same as the agent\n\n  - loadApplicationExtend: same as the agent  (*app > plugin > core*)\n\n  - loadRequestExtend: load and merge all of the extending of request object (*app > plugin > core*)\n\n  - loadResponseExtend: load and merge all of the extending of response object (*app > plugin > core*)\n\n  - loadContextExtend: same as the agent\n\n  - loadHelperExtend: load and merge all of the extending of helper object (*app > plugin > core*)\n\n  - loadCustomApp: same as the agent *app > plugin*\n\n  - loadService: load and merge all of the extending of helper object *app > plugin*\n\n  - loadMiddleware: load middlewares and iterate them => mw, if it conforms the middleware standard, it will be used with app.use(mw) *app > plugin > core*\n\n  - loadController: iterate all controllers' functions => key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only *app*). This middleware will be triggered when getting a new request, the Controller is defined in the `app/controller ` directory and the key is it's function.\n\n    ```javascript\n    function methodToMiddleware(Controller, key) {\n      return function classControllerMiddleware(...args) {\n        const controller = new Controller(this);\n        if (!this.app.config.controller || !this.app.config.controller.supportParams) {\n          args = [ this ];\n        }\n        return utils.callFn(controller[key], args, controller);\n      };\n    }\n    ```\n\n    \n\n  - loadRouter: it makes requests path associated with the controllers' function that has been become to middleware (only *app*)\n\n  - loadCustomLoader: load ourselves function to create some built-in objects for app object or other.[Customloader](https://eggjs.org/en/advanced/loader.html#customloader)\n\n- `[master process]`: it listens to all worker processes and triggers the master's ready once they have finished booting.\n- send `egg-ready` to the parent process, the agent process, the app worker processes\n- Last, traverse BOOTS and run serverDidReady function of each item.\n\nIt is the whole boot for Eggjs framework but doesn't include, such as restarting a worker process when it exits or disconnects,  shuting down...\n\n__Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.__\n\n\n\n**What happens when web app get an Http request?**\n\n*We only discuss Eggjs code in the applaction layer. :)*\n\nThe `agent` can't deal with any request because it doesn't listen port. All request always hand over to `workers`. We look at creating worker code, it will run a app.callback function and listen port when it has booted.\n\nThis callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller's function.\n\n```javascript\n// koa/lib/application\nclass Application extends Emitter {\n  callback() {\n    const fn = compose(this.middleware);\n\n    if (!this.listenerCount('error')) this.on('error', this.onerror);\n\n    const handleRequest = (req, res) => {\n      const ctx = this.createContext(req, res);\n      return this.handleRequest(ctx, fn);\n    };\n\n    return handleRequest;\n  }\n  handleRequest(ctx, fnMiddleware) {\n    const res = ctx.res;\n    res.statusCode = 404;\n    const onerror = err => ctx.onerror(err);\n    const handleResponse = () => respond(ctx);\n    onFinished(res, onerror);\n    return fnMiddleware(ctx).then(handleResponse).catch(onerror);\n  }\n}\n\n// egg/lib/application\nclass Application extends EggApplication {\n\thandleRequest(ctx, fnMiddleware) {\n    this.emit('request', ctx)\n    super.handleRequest(ctx, fnMiddleware)\n    onFinished(ctx.res, () => this.emit('response', ctx))\n  }\n}\n```\n\n\n\n__In summary, we have know how to boot web app and deal with request in Eggjs.__ When we know it, we can easily write some plugins and middlewares to finish the business requirements.\n\n","source":"_posts/egg-boot.md","raw":"---\ntitle: Eggjs Boot\ncategory: JavaScript\nkeywords: Eggjs Boot,Eggjs,Eggjs\ndescription: This article will introduce the boot of Eggjs that is a Node.js web framework.It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.\ntags:\n  - Node.js\n  - JavaScript\ndate: 2019-05-09T15:01:08.568Z\n---\n\n### **#Preface**\n\nThis article will introduce the boot of [Eggjs](<https://eggjs.org/>) that is a Node.js web framework.\n\nIt is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.\n\nEggjs has a few major libs, egg-coreeggegg-clusteregg-binegg-scripts and so on.\n\n**egg-core**: it extends Koa and is as a parent object of every agent and worker.\n\n**egg**: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.\n\n**egg-cluster**: it creates a cluster and manages them.\n\n**egg-scripts and Egg-bin**: their job is run the whole app in a different environment.\n\n<br/>\n\n_**Tips: We will discuss Eggjs with basing 2.x.x version.**_\n\n<br/>\n\n<!-- more -->\n\n## **#Scan Libs Code**\n\n_* The directory and the code segment are not whole content after this post, these major are only for a better explanation._\n\n### **egg-core**\n\n```\n lib\n   / loader (dir)\n   mixin (dir)\n   utils (dir)\n  egg.js\n  lifecycle.js\n```\n\nThe above is the directory structure of egg-core.The _**egg.js**_ and folder of the _**loader**_ are important to point for this lib.\n\nSee egg.js\n\n```javascript\nconst KoaApplication = require('koa')\nconst Lifecycle = require('./lifecycle')\n\nclass EggCore extends KoaApplication {\n  constructor(options = {}) {\n    // ...\n    this.lifecycle = new Lifecycle({\n      baseDir: options.baseDir,\n      app: this,\n      logger: this.console\n    })\n\n    const Loader = this[EGG_LOADER]\n    assert(Loader, \"Symbol.for('egg#loader') is required\")\n    this.loader = new Loader({\n      baseDir: options.baseDir,\n      app: this,\n      plugins: options.plugins,\n      logger: this.console,\n      serverScope: options.serverScope,\n      env: options.env\n    })\n    // ...\n  }\n  beforeStart(scope) {\n    this.lifecycle.registerBeforeStart(scope)\n  }\n  ready(flagOrFunction) {\n    return this.lifecycle.ready(flagOrFunction)\n  }\n  get [EGG_LOADER]() {\n    return require('./loader/egg_loader')\n  }\n}\n```\n\nFirst, we can know why it is called that bases on Koa because EggCore extends KoaApplication.\n\nSecond, it defines a few new fields in the construction function, such as _lifecycle_ and _loader_. The _loader_ field helps app for creating important feature include configplugincontrollerextendroutermiddlewareservice and so on, it will load some js file in the special directory when the app is starting.\n\nAnother side, both _beforeStart_ and _ready_ often are called when we need to write some plugins.\n\n### **egg**\n\n```\n / app\n / config\n / lib\n  - / core\n    - / messenger\n  - / jsdoc\n  - / loader\n  - agent.js\n  - application.js\n  - egg.js\n  - start.js\n- index.js\n```\n\nThere is an egg.js file that is the same name in the egg-core, but it bases on _EggCore Class_ and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.\n\nSee egg.js\n\n```javascript\nconst EggCore = require('egg-core').EggCore\nconst cluster = require('cluster-client')\nconst Messenger = require('./core/messenger')\n\nclass EggApplication extends EggCore {\n  constructor(options = {}) {\n    this.loader.loadConfig()\n    this.messenger = Messenger.create(this)\n\n    // trigger serverDidReady hook when all app workers\n    // and agent worker is ready\n    this.messenger.once('egg-ready', () => {\n      this.lifecycle.triggerServerDidReady()\n    })\n\n    this.ready(() =>\n      process.nextTick(() => {\n        const dumpStartTime = Date.now()\n        this.dumpConfig()\n        this.dumpTiming()\n        this.coreLogger.info(\n          '[egg:core] dump config after ready, %s',\n          ms(Date.now() - dumpStartTime)\n        )\n      })\n    )\n\n    this.cluster = (clientClass, options) => {\n      options = Object.assign({}, this.config.clusterClient, options, {\n        singleMode: this.options.mode === 'single',\n        // cluster need a port that can't conflict on the environment\n        port: this.options.clusterPort,\n        // agent worker is leader, app workers are follower\n        isLeader: this.type === 'agent',\n        logger: this.coreLogger\n      })\n      const client = cluster(clientClass, options)\n      this._patchClusterClient(client)\n      return client\n    }\n  }\n}\n```\n\nSee agent.js and application.js\n\n```javascript\n// agent.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AgentWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Agent extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'agent'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AgentWorkerLoader\n  }\n}\n\n// application.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AppWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Application extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'application'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AppWorkerLoader\n  }\n}\n```\n\nWe can see that they override the _EGG_LOADER_ property, which uses to create a new _loader_ field in the construction of EggCore that is their parent class. Finally, they call the _load_ function.\n\nWe have the base application code. rNext, look a few of libs for starting web app.\n\n### **egg-scripts and egg-bin**\n\nBoth these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don't know them at most of time.\n\n```javascript\n// package.json\n{\n  \"scripts\": {\n    \"start\": \"env egg-scripts start\",\n    \"dev\": \"env egg-bin dev\",\n    \"stop\": \"egg-scripts stop\",\n    \"debug\": \"egg-bin debug\",\n    \"test\": \"npm run lint -- --fix && npm run test-local\",\n    \"test-local\": \"env egg-bin test\",\n    \"cov\": \"egg-bin cov\"\n}\n```\n\nThe _scripts_ command of this eggjs app conforms to the above description.\n\n### **egg-cluster**\n\nThe cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.\n\n```\n- / lib\n  - / utils\n  - agent_worker.js\n  - app_worker.js\n  - master.js\n- index.js\n```\n\nI had written an [article](/2019/01/18/egg-cluster) about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.\n\n## **#From start to getting the first request**\n\n**What happens when we input `npm run dev` or `npm start` in the terminal?**\n\n- **egg-scripts(prod):** it can require _framework_ by `child_process.spawn` and calls _startCluster_ function.\n- **egg-bin(dev):** it can require _framework_ by `child_process.fork` and calls _startCluster_ function.\n- `[parent process]`: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the `framework` is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as `--framework { your path }`\n\n**Pseudo Code**\n\n```javascript\n// egg-scripts\n// parent process\nconst spawn = require('child_process').spawn // create new process\nspawn('node', 'require({{ framework path }}).startCluster(...)', options))\n\n// egg-bin\n// parent process\nconst cp = require('child_process')\ncp.fork('require({{ framework path }}).startCluster(...)', args, options) // create new process\n```\n\nEgg-scripts uses `spawn` function to require framework while egg-scripts calls `fork` function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.\n\nWe have two processes. In general, this newly created process is called the master process.\n\n**Why is the master process called birdge?**\n\n```javascript\n// egg index.js\nexports.startCluster = require('egg-cluster').startCluster\n```\n\nActually, we exec `egg-cluster`'s startCluster function when we require the framework. We open `index.js` file in the egg-cluster lib. \n\n__First, it is real enter point for whole web app.__\n\n```javascript\n// index.js\nconst Master = require('./lib/master')\nexports.startCluster = function(options, callback) {\n  new Master(options).ready(callback)\n}\n\n// ./lib/master.js\nconst ready = require('get-ready')\nconst detectPort = require('detect-port')\nconst Manager = require('./utils/manager')\nconst Messenger = require('./utils/messenger')\n\nclass Master extends EventEmitter {\n  constructor(options) {\n    super()\n    this.options = parseOptions(options)\n    this.workerManager = new Manager()\n    this.messenger = new Messenger(this)\n\n    ready.mixin(this)\n\n    this.ready(() => {\n      this.isStarted = true\n      const action = 'egg-ready'\n      this.messenger.send({\n        action,\n        to: 'parent',\n        data: { port: this[REALPORT], address: this[APP_ADDRESS] }\n      })\n      this.messenger.send({ action, to: 'app', data: this.options })\n      this.messenger.send({ action, to: 'agent', data: this.options })\n\n      // start check agent and worker status\n      if (this.isProduction) {\n        this.workerManager.startCheck()\n      }\n    })\n\n    // fork app workers after agent started\n    this.once('agent-start', this.forkAppWorkers.bind(this))\n\n    detectPort((err, port) => {\n      /* istanbul ignore if */\n      if (err) {\n        err.name = 'ClusterPortConflictError'\n        err.message = '[master] try get free port error, ' + err.message\n        this.logger.error(err)\n        process.exit(1)\n      }\n      this.options.clusterPort = port\n      this.forkAgentWorker()\n    })\n  }\n  forkAppWorkers() {\n    // ...\n    cluster.on('fork', worker => {\n      // ...\n      worker.on('message', msg => {\n        if (typeof msg === 'string') msg = { action: msg, data: msg };\n        msg.from = 'app';\n        this.messenger.send(msg);\n      });\n      // ...\n    })\n  }\n  forkAgentWorker() {\n    // ...\n    agentWorker.on('message', msg => {\n      if (typeof msg === 'string') msg = { action: msg, data: msg };\n      msg.from = 'agent';\n      this.messenger.send(msg);\n    });\n    // ...\n  }\n}\n\n\n// the callback of ready function will be trigger after all major boots had been loaded\n\n// forkAgentWorker\nconst agent = new Agent(options)\nagent.ready(err => {\n  if (err) return\n  process.send({ action: 'agent-start', to: 'master' })\n})\n\n// fork a single worker\nconst app = new Application(options);\nfunction startServer(err) {  \n  let server;\n  if (options.https) {\n    const httpsOptions = Object.assign({}, options.https, {\n      key: fs.readFileSync(options.https.key),\n      cert: fs.readFileSync(options.https.cert),\n    });\n    server = require('https').createServer(httpsOptions, app.callback());\n  } else {\n    server = require('http').createServer(app.callback());\n  }\n\n  // emit `server` event in app\n  app.emit('server', server);\n  \n  server.listen(...args);\n}\napp.ready(startServer);\n```\n\nOn the other hand, this web will be constructed during creating a `Master` object.\n\n- workerManager: it will hold on all worker porcesses.\n- messenger: we make `master` a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an [article(Chinese)]([http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works-IPC)) about it.\n\n> - The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)\n> - EggApplication maintain the other Messenge instance egg/lib/core/messenger.js\n> - Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master\n\n- ready.mixin & this.ready: 'get-ready' often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.\n\n- detectPort: apply for an available port, default is 7001.If Successly, it will `fork` an agent process and register a callback message for new created an agent object.\n\n- `[agent process]`: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.\n\n  - loadPlugin: find all plugin, record their dir paths => this.dirs\n\n  - loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.\n  - loadAgentExtend: load and merge all of the extending of agent object  (*app > plugin > core*)\n  - loadContextExtend: load and merge all of the extending of context object  (*app > plugin > core*)\n  - loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.[Application Startup Configuration(official)](https://eggjs.org/en/basics/app-start.html). It help you for better writing a few plugins.\n  - Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending `'agent-start'` to the master process.\n\n![egg boot process](/images/egg-boot/egg-boot.jpg)\n\n- `[master process]`: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get `'agent-start'` message from the agent process. It will open a new relatable load, we take a single worker process example.\n\n- `[a single worker process]`: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.\n\n  - loadPlugin: same as the agent\n\n  - loadConfig: same as the agent\n\n  - loadApplicationExtend: same as the agent  (*app > plugin > core*)\n\n  - loadRequestExtend: load and merge all of the extending of request object (*app > plugin > core*)\n\n  - loadResponseExtend: load and merge all of the extending of response object (*app > plugin > core*)\n\n  - loadContextExtend: same as the agent\n\n  - loadHelperExtend: load and merge all of the extending of helper object (*app > plugin > core*)\n\n  - loadCustomApp: same as the agent *app > plugin*\n\n  - loadService: load and merge all of the extending of helper object *app > plugin*\n\n  - loadMiddleware: load middlewares and iterate them => mw, if it conforms the middleware standard, it will be used with app.use(mw) *app > plugin > core*\n\n  - loadController: iterate all controllers' functions => key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only *app*). This middleware will be triggered when getting a new request, the Controller is defined in the `app/controller ` directory and the key is it's function.\n\n    ```javascript\n    function methodToMiddleware(Controller, key) {\n      return function classControllerMiddleware(...args) {\n        const controller = new Controller(this);\n        if (!this.app.config.controller || !this.app.config.controller.supportParams) {\n          args = [ this ];\n        }\n        return utils.callFn(controller[key], args, controller);\n      };\n    }\n    ```\n\n    \n\n  - loadRouter: it makes requests path associated with the controllers' function that has been become to middleware (only *app*)\n\n  - loadCustomLoader: load ourselves function to create some built-in objects for app object or other.[Customloader](https://eggjs.org/en/advanced/loader.html#customloader)\n\n- `[master process]`: it listens to all worker processes and triggers the master's ready once they have finished booting.\n- send `egg-ready` to the parent process, the agent process, the app worker processes\n- Last, traverse BOOTS and run serverDidReady function of each item.\n\nIt is the whole boot for Eggjs framework but doesn't include, such as restarting a worker process when it exits or disconnects,  shuting down...\n\n__Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.__\n\n\n\n**What happens when web app get an Http request?**\n\n*We only discuss Eggjs code in the applaction layer. :)*\n\nThe `agent` can't deal with any request because it doesn't listen port. All request always hand over to `workers`. We look at creating worker code, it will run a app.callback function and listen port when it has booted.\n\nThis callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller's function.\n\n```javascript\n// koa/lib/application\nclass Application extends Emitter {\n  callback() {\n    const fn = compose(this.middleware);\n\n    if (!this.listenerCount('error')) this.on('error', this.onerror);\n\n    const handleRequest = (req, res) => {\n      const ctx = this.createContext(req, res);\n      return this.handleRequest(ctx, fn);\n    };\n\n    return handleRequest;\n  }\n  handleRequest(ctx, fnMiddleware) {\n    const res = ctx.res;\n    res.statusCode = 404;\n    const onerror = err => ctx.onerror(err);\n    const handleResponse = () => respond(ctx);\n    onFinished(res, onerror);\n    return fnMiddleware(ctx).then(handleResponse).catch(onerror);\n  }\n}\n\n// egg/lib/application\nclass Application extends EggApplication {\n\thandleRequest(ctx, fnMiddleware) {\n    this.emit('request', ctx)\n    super.handleRequest(ctx, fnMiddleware)\n    onFinished(ctx.res, () => this.emit('response', ctx))\n  }\n}\n```\n\n\n\n__In summary, we have know how to boot web app and deal with request in Eggjs.__ When we know it, we can easily write some plugins and middlewares to finish the business requirements.\n\n","slug":"egg-boot","published":1,"updated":"2024-04-08T13:38:55.200Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wdw000b18fd6gku6rg7","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><h3 id=\"Preface\"><a href=\"#Preface\" class=\"headerlink\" title=\"#Preface\"></a><strong>#Preface</strong></h3><p>This article will introduce the boot of <a href=\"https://eggjs.org/\">Eggjs</a> that is a Node.js web framework.</p>\n<p>It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.</p>\n<p>Eggjs has a few major libs, egg-coreeggegg-clusteregg-binegg-scripts and so on.</p>\n<p><strong>egg-core</strong>: it extends Koa and is as a parent object of every agent and worker.</p>\n<p><strong>egg</strong>: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.</p>\n<p><strong>egg-cluster</strong>: it creates a cluster and manages them.</p>\n<p><strong>egg-scripts and Egg-bin</strong>: their job is run the whole app in a different environment.</p>\n<br>\n\n<p><em><strong>Tips: We will discuss Eggjs with basing 2.x.x version.</strong></em></p>\n<br>\n\n<span id=\"more\"></span>\n\n<h2 id=\"Scan-Libs-Code\"><a href=\"#Scan-Libs-Code\" class=\"headerlink\" title=\"#Scan Libs Code\"></a><strong>#Scan Libs Code</strong></h2><p><em>* The directory and the code segment are not whole content after this post, these major are only for a better explanation.</em></p>\n<h3 id=\"egg-core\"><a href=\"#egg-core\" class=\"headerlink\" title=\"egg-core\"></a><strong>egg-core</strong></h3><figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> lib</span><br><span class=\"line\">   / loader (dir)</span><br><span class=\"line\">   mixin (dir)</span><br><span class=\"line\">   utils (dir)</span><br><span class=\"line\">  egg.js</span><br><span class=\"line\">  lifecycle.js</span><br></pre></td></tr></tbody></table></figure>\n\n<p>The above is the directory structure of egg-core.The <em><strong>egg.js</strong></em> and folder of the <em><strong>loader</strong></em> are important to point for this lib.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">KoaApplication</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">Lifecycle</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./lifecycle'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">EggCore</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">KoaApplication</span> {</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"hljs-params\">options = {}</span>) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">lifecycle</span> = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Lifecycle</span>({</span><br><span class=\"line\">      <span class=\"hljs-attr\">baseDir</span>: options.<span class=\"hljs-property\">baseDir</span>,</span><br><span class=\"line\">      <span class=\"hljs-attr\">app</span>: <span class=\"variable language_\">this</span>,</span><br><span class=\"line\">      <span class=\"hljs-attr\">logger</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">console</span></span><br><span class=\"line\">    })</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> <span class=\"title class_\">Loader</span> = <span class=\"variable language_\">this</span>[<span class=\"variable constant_\">EGG_LOADER</span>]</span><br><span class=\"line\">    <span class=\"title function_\">assert</span>(<span class=\"title class_\">Loader</span>, <span class=\"hljs-string\">\"Symbol.for('egg#loader') is required\"</span>)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">loader</span> = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Loader</span>({</span><br><span class=\"line\">      <span class=\"hljs-attr\">baseDir</span>: options.<span class=\"hljs-property\">baseDir</span>,</span><br><span class=\"line\">      <span class=\"hljs-attr\">app</span>: <span class=\"variable language_\">this</span>,</span><br><span class=\"line\">      <span class=\"hljs-attr\">plugins</span>: options.<span class=\"hljs-property\">plugins</span>,</span><br><span class=\"line\">      <span class=\"hljs-attr\">logger</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">console</span>,</span><br><span class=\"line\">      <span class=\"hljs-attr\">serverScope</span>: options.<span class=\"hljs-property\">serverScope</span>,</span><br><span class=\"line\">      <span class=\"hljs-attr\">env</span>: options.<span class=\"hljs-property\">env</span></span><br><span class=\"line\">    })</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"title function_\">beforeStart</span>(<span class=\"hljs-params\">scope</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">lifecycle</span>.<span class=\"title function_\">registerBeforeStart</span>(scope)</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"title function_\">ready</span>(<span class=\"hljs-params\">flagOrFunction</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">lifecycle</span>.<span class=\"title function_\">ready</span>(flagOrFunction)</span><br><span class=\"line\">  }</span><br><span class=\"line\">  get [<span class=\"variable constant_\">EGG_LOADER</span>]() {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader/egg_loader'</span>)</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>First, we can know why it is called that bases on Koa because EggCore extends KoaApplication.</p>\n<p>Second, it defines a few new fields in the construction function, such as <em>lifecycle</em> and <em>loader</em>. The <em>loader</em> field helps app for creating important feature include configplugincontrollerextendroutermiddlewareservice and so on, it will load some js file in the special directory when the app is starting.</p>\n<p>Another side, both <em>beforeStart</em> and <em>ready</em> often are called when we need to write some plugins.</p>\n<h3 id=\"egg\"><a href=\"#egg\" class=\"headerlink\" title=\"egg\"></a><strong>egg</strong></h3><figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> / app</span><br><span class=\"line\"> / config</span><br><span class=\"line\"> / lib</span><br><span class=\"line\">  - / core</span><br><span class=\"line\">    - / messenger</span><br><span class=\"line\">  - / jsdoc</span><br><span class=\"line\">  - / loader</span><br><span class=\"line\">  - agent.js</span><br><span class=\"line\">  - application.js</span><br><span class=\"line\">  - egg.js</span><br><span class=\"line\">  - start.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></tbody></table></figure>\n\n<p>There is an egg.js file that is the same name in the egg-core, but it bases on <em>EggCore Class</em> and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">EggCore</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'egg-core'</span>).<span class=\"hljs-property\">EggCore</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> cluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'cluster-client'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">Messenger</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./core/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">EggApplication</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">EggCore</span> {</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"hljs-params\">options = {}</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">loader</span>.<span class=\"title function_\">loadConfig</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span> = <span class=\"title class_\">Messenger</span>.<span class=\"title function_\">create</span>(<span class=\"variable language_\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// trigger serverDidReady hook when all app workers</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// and agent worker is ready</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span>.<span class=\"title function_\">once</span>(<span class=\"hljs-string\">'egg-ready'</span>, <span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">lifecycle</span>.<span class=\"title function_\">triggerServerDidReady</span>()</span><br><span class=\"line\">    })</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">ready</span>(<span class=\"hljs-function\">() =&gt;</span></span><br><span class=\"line\">      process.<span class=\"title function_\">nextTick</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> dumpStartTime = <span class=\"title class_\">Date</span>.<span class=\"title function_\">now</span>()</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">dumpConfig</span>()</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">dumpTiming</span>()</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">coreLogger</span>.<span class=\"title function_\">info</span>(</span><br><span class=\"line\">          <span class=\"hljs-string\">'[egg:core] dump config after ready, %s'</span>,</span><br><span class=\"line\">          <span class=\"title function_\">ms</span>(<span class=\"title class_\">Date</span>.<span class=\"title function_\">now</span>() - dumpStartTime)</span><br><span class=\"line\">        )</span><br><span class=\"line\">      })</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">cluster</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">clientClass, options</span>) =&gt;</span> {</span><br><span class=\"line\">      options = <span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>({}, <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">clusterClient</span>, options, {</span><br><span class=\"line\">        <span class=\"hljs-attr\">singleMode</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>.<span class=\"hljs-property\">mode</span> === <span class=\"hljs-string\">'single'</span>,</span><br><span class=\"line\">        <span class=\"hljs-comment\">// cluster need a port that can't conflict on the environment</span></span><br><span class=\"line\">        <span class=\"hljs-attr\">port</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>.<span class=\"hljs-property\">clusterPort</span>,</span><br><span class=\"line\">        <span class=\"hljs-comment\">// agent worker is leader, app workers are follower</span></span><br><span class=\"line\">        <span class=\"hljs-attr\">isLeader</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">type</span> === <span class=\"hljs-string\">'agent'</span>,</span><br><span class=\"line\">        <span class=\"hljs-attr\">logger</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">coreLogger</span></span><br><span class=\"line\">      })</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> client = <span class=\"title function_\">cluster</span>(clientClass, options)</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">_patchClusterClient</span>(client)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> client</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>See agent.js and application.js</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// agent.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">EggApplication</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">AgentWorkerLoader</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader'</span>).<span class=\"hljs-property\">AgentWorkerLoader</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"variable constant_\">EGG_LOADER</span> = <span class=\"title class_\">Symbol</span>.<span class=\"title function_\">for</span>(<span class=\"hljs-string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Agent</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">EggApplication</span> {</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"hljs-params\">options = {}</span>) {</span><br><span class=\"line\">    options.<span class=\"hljs-property\">type</span> = <span class=\"hljs-string\">'agent'</span></span><br><span class=\"line\">    <span class=\"variable language_\">super</span>(options)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">loader</span>.<span class=\"title function_\">load</span>()</span><br><span class=\"line\">  }</span><br><span class=\"line\">  get [<span class=\"variable constant_\">EGG_LOADER</span>]() {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"title class_\">AgentWorkerLoader</span></span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// application.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">EggApplication</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">AgentWorkerLoader</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader'</span>).<span class=\"hljs-property\">AppWorkerLoader</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"variable constant_\">EGG_LOADER</span> = <span class=\"title class_\">Symbol</span>.<span class=\"title function_\">for</span>(<span class=\"hljs-string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">EggApplication</span> {</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"hljs-params\">options = {}</span>) {</span><br><span class=\"line\">    options.<span class=\"hljs-property\">type</span> = <span class=\"hljs-string\">'application'</span></span><br><span class=\"line\">    <span class=\"variable language_\">super</span>(options)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">loader</span>.<span class=\"title function_\">load</span>()</span><br><span class=\"line\">  }</span><br><span class=\"line\">  get [<span class=\"variable constant_\">EGG_LOADER</span>]() {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"title class_\">AppWorkerLoader</span></span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>We can see that they override the <em>EGG_LOADER</em> property, which uses to create a new <em>loader</em> field in the construction of EggCore that is their parent class. Finally, they call the <em>load</em> function.</p>\n<p>We have the base application code. rNext, look a few of libs for starting web app.</p>\n<h3 id=\"egg-scripts-and-egg-bin\"><a href=\"#egg-scripts-and-egg-bin\" class=\"headerlink\" title=\"egg-scripts and egg-bin\"></a><strong>egg-scripts and egg-bin</strong></h3><p>Both these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost dont know them at most of time.</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// package.json</span></span><br><span class=\"line\">{</span><br><span class=\"line\">  <span class=\"hljs-string\">\"scripts\"</span>: {</span><br><span class=\"line\">    <span class=\"hljs-string\">\"start\"</span>: <span class=\"hljs-string\">\"env egg-scripts start\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"dev\"</span>: <span class=\"hljs-string\">\"env egg-bin dev\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"stop\"</span>: <span class=\"hljs-string\">\"egg-scripts stop\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"debug\"</span>: <span class=\"hljs-string\">\"egg-bin debug\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"test\"</span>: <span class=\"hljs-string\">\"npm run lint -- --fix &amp;&amp; npm run test-local\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"test-local\"</span>: <span class=\"hljs-string\">\"env egg-bin test\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"cov\"</span>: <span class=\"hljs-string\">\"egg-bin cov\"</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>The <em>scripts</em> command of this eggjs app conforms to the above description.</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a><strong>egg-cluster</strong></h3><p>The cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.</p>\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- / lib</span><br><span class=\"line\">  - / utils</span><br><span class=\"line\">  - agent_worker.js</span><br><span class=\"line\">  - app_worker.js</span><br><span class=\"line\">  - master.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></tbody></table></figure>\n\n<p>I had written an <a href=\"/2019/01/18/egg-cluster\">article</a> about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.</p>\n<h2 id=\"From-start-to-getting-the-first-request\"><a href=\"#From-start-to-getting-the-first-request\" class=\"headerlink\" title=\"#From start to getting the first request\"></a><strong>#From start to getting the first request</strong></h2><p><strong>What happens when we input <code>npm run dev</code> or <code>npm start</code> in the terminal?</strong></p>\n<ul>\n<li><strong>egg-scripts(prod):</strong> it can require <em>framework</em> by <code>child_process.spawn</code> and calls <em>startCluster</em> function.</li>\n<li><strong>egg-bin(dev):</strong> it can require <em>framework</em> by <code>child_process.fork</code> and calls <em>startCluster</em> function.</li>\n<li><code>[parent process]</code>: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the <code>framework</code> is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as <code>--framework { your path }</code></li>\n</ul>\n<p><strong>Pseudo Code</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-scripts</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// parent process</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> spawn = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>).<span class=\"hljs-property\">spawn</span> <span class=\"hljs-comment\">// create new process</span></span><br><span class=\"line\"><span class=\"title function_\">spawn</span>(<span class=\"hljs-string\">'node'</span>, <span class=\"hljs-string\">'require({{ framework path }}).startCluster(...)'</span>, options))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// egg-bin</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// parent process</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> cp = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>)</span><br><span class=\"line\">cp.<span class=\"title function_\">fork</span>(<span class=\"hljs-string\">'require({{ framework path }}).startCluster(...)'</span>, args, options) <span class=\"hljs-comment\">// create new process</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>Egg-scripts uses <code>spawn</code> function to require framework while egg-scripts calls <code>fork</code> function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.</p>\n<p>We have two processes. In general, this newly created process is called the master process.</p>\n<p><strong>Why is the master process called birdge?</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg index.js</span></span><br><span class=\"line\"><span class=\"hljs-built_in\">exports</span>.<span class=\"hljs-property\">startCluster</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'egg-cluster'</span>).<span class=\"hljs-property\">startCluster</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>Actually, we exec <code>egg-cluster</code>s startCluster function when we require the framework. We open <code>index.js</code> file in the egg-cluster lib. </p>\n<p><strong>First, it is real enter point for whole web app.</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// index.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">Master</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./lib/master'</span>)</span><br><span class=\"line\"><span class=\"hljs-built_in\">exports</span>.<span class=\"hljs-property\">startCluster</span> = <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">options, callback</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Master</span>(options).<span class=\"title function_\">ready</span>(callback)</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// ./lib/master.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> ready = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'get-ready'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> detectPort = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'detect-port'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">Manager</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./utils/manager'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">Messenger</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./utils/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">EventEmitter</span> {</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"hljs-params\">options</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">super</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span> = <span class=\"title function_\">parseOptions</span>(options)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">workerManager</span> = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Manager</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span> = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Messenger</span>(<span class=\"variable language_\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    ready.<span class=\"title function_\">mixin</span>(<span class=\"variable language_\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">ready</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">isStarted</span> = <span class=\"hljs-literal\">true</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> action = <span class=\"hljs-string\">'egg-ready'</span></span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span>.<span class=\"title function_\">send</span>({</span><br><span class=\"line\">        action,</span><br><span class=\"line\">        <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'parent'</span>,</span><br><span class=\"line\">        <span class=\"hljs-attr\">data</span>: { <span class=\"hljs-attr\">port</span>: <span class=\"variable language_\">this</span>[<span class=\"variable constant_\">REALPORT</span>], <span class=\"hljs-attr\">address</span>: <span class=\"variable language_\">this</span>[<span class=\"variable constant_\">APP_ADDRESS</span>] }</span><br><span class=\"line\">      })</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span>.<span class=\"title function_\">send</span>({ action, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'app'</span>, <span class=\"hljs-attr\">data</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span> })</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span>.<span class=\"title function_\">send</span>({ action, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'agent'</span>, <span class=\"hljs-attr\">data</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span> })</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// start check agent and worker status</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">isProduction</span>) {</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">workerManager</span>.<span class=\"title function_\">startCheck</span>()</span><br><span class=\"line\">      }</span><br><span class=\"line\">    })</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// fork app workers after agent started</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">once</span>(<span class=\"hljs-string\">'agent-start'</span>, <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">forkAppWorkers</span>.<span class=\"title function_\">bind</span>(<span class=\"variable language_\">this</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">detectPort</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">err, port</span>) =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-comment\">/* istanbul ignore if */</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (err) {</span><br><span class=\"line\">        err.<span class=\"hljs-property\">name</span> = <span class=\"hljs-string\">'ClusterPortConflictError'</span></span><br><span class=\"line\">        err.<span class=\"hljs-property\">message</span> = <span class=\"hljs-string\">'[master] try get free port error, '</span> + err.<span class=\"hljs-property\">message</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">logger</span>.<span class=\"title function_\">error</span>(err)</span><br><span class=\"line\">        process.<span class=\"title function_\">exit</span>(<span class=\"hljs-number\">1</span>)</span><br><span class=\"line\">      }</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">options</span>.<span class=\"hljs-property\">clusterPort</span> = port</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">forkAgentWorker</span>()</span><br><span class=\"line\">    })</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"title function_\">forkAppWorkers</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    cluster.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">'fork'</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">worker</span> =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">      worker.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">'message'</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">msg</span> =&gt;</span> {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = { <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg };</span><br><span class=\"line\">        msg.<span class=\"hljs-property\">from</span> = <span class=\"hljs-string\">'app'</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span>.<span class=\"title function_\">send</span>(msg);</span><br><span class=\"line\">      });</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    })</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"title function_\">forkAgentWorker</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    agentWorker.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">'message'</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">msg</span> =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = { <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg };</span><br><span class=\"line\">      msg.<span class=\"hljs-property\">from</span> = <span class=\"hljs-string\">'agent'</span>;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">messenger</span>.<span class=\"title function_\">send</span>(msg);</span><br><span class=\"line\">    });</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// the callback of ready function will be trigger after all major boots had been loaded</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// forkAgentWorker</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> agent = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Agent</span>(options)</span><br><span class=\"line\">agent.<span class=\"title function_\">ready</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (err) <span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">  process.<span class=\"title function_\">send</span>({ <span class=\"hljs-attr\">action</span>: <span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'master'</span> })</span><br><span class=\"line\">})</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// fork a single worker</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Application</span>(options);</span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">startServer</span>(<span class=\"hljs-params\">err</span>) {  </span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> server;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (options.<span class=\"hljs-property\">https</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> httpsOptions = <span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>({}, options.<span class=\"hljs-property\">https</span>, {</span><br><span class=\"line\">      <span class=\"hljs-attr\">key</span>: fs.<span class=\"title function_\">readFileSync</span>(options.<span class=\"hljs-property\">https</span>.<span class=\"hljs-property\">key</span>),</span><br><span class=\"line\">      <span class=\"hljs-attr\">cert</span>: fs.<span class=\"title function_\">readFileSync</span>(options.<span class=\"hljs-property\">https</span>.<span class=\"hljs-property\">cert</span>),</span><br><span class=\"line\">    });</span><br><span class=\"line\">    server = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'https'</span>).<span class=\"title function_\">createServer</span>(httpsOptions, app.<span class=\"title function_\">callback</span>());</span><br><span class=\"line\">  } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">    server = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'http'</span>).<span class=\"title function_\">createServer</span>(app.<span class=\"title function_\">callback</span>());</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// emit `server` event in app</span></span><br><span class=\"line\">  app.<span class=\"title function_\">emit</span>(<span class=\"hljs-string\">'server'</span>, server);</span><br><span class=\"line\">  </span><br><span class=\"line\">  server.<span class=\"title function_\">listen</span>(...args);</span><br><span class=\"line\">}</span><br><span class=\"line\">app.<span class=\"title function_\">ready</span>(startServer);</span><br></pre></td></tr></tbody></table></figure>\n\n<p>On the other hand, this web will be constructed during creating a <code>Master</code> object.</p>\n<ul>\n<li>workerManager: it will hold on all worker porcesses.</li>\n<li>messenger: we make <code>master</code> a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an <a href=\"%5Bhttp://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC%5D(http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC)\">article(Chinese)</a> about it.</li>\n</ul>\n<blockquote>\n<ul>\n<li>The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)</li>\n<li>EggApplication maintain the other Messenge instance egg/lib/core/messenger.js</li>\n<li>Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master</li>\n</ul>\n</blockquote>\n<ul>\n<li><p>ready.mixin &amp; this.ready: get-ready often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.</p>\n</li>\n<li><p>detectPort: apply for an available port, default is 7001.If Successly, it will <code>fork</code> an agent process and register a callback message for new created an agent object.</p>\n</li>\n<li><p><code>[agent process]</code>: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.</p>\n<ul>\n<li><p>loadPlugin: find all plugin, record their dir paths =&gt; this.dirs</p>\n</li>\n<li><p>loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.</p>\n</li>\n<li><p>loadAgentExtend: load and merge all of the extending of agent object  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadContextExtend: load and merge all of the extending of context object  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.<a href=\"https://eggjs.org/en/basics/app-start.html\">Application Startup Configuration(official)</a>. It help you for better writing a few plugins.</p>\n</li>\n<li><p>Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending <code>'agent-start'</code> to the master process.</p>\n</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"/images/egg-boot/egg-boot.jpg\" alt=\"egg boot process\"></p>\n<ul>\n<li><p><code>[master process]</code>: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get <code>'agent-start'</code> message from the agent process. It will open a new relatable load, we take a single worker process example.</p>\n</li>\n<li><p><code>[a single worker process]</code>: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.</p>\n<ul>\n<li><p>loadPlugin: same as the agent</p>\n</li>\n<li><p>loadConfig: same as the agent</p>\n</li>\n<li><p>loadApplicationExtend: same as the agent  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadRequestExtend: load and merge all of the extending of request object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadResponseExtend: load and merge all of the extending of response object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadContextExtend: same as the agent</p>\n</li>\n<li><p>loadHelperExtend: load and merge all of the extending of helper object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadCustomApp: same as the agent <em>app &gt; plugin</em></p>\n</li>\n<li><p>loadService: load and merge all of the extending of helper object <em>app &gt; plugin</em></p>\n</li>\n<li><p>loadMiddleware: load middlewares and iterate them =&gt; mw, if it conforms the middleware standard, it will be used with app.use(mw) <em>app &gt; plugin &gt; core</em></p>\n</li>\n<li><p>loadController: iterate all controllers functions =&gt; key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only <em>app</em>). This middleware will be triggered when getting a new request, the Controller is defined in the <code>app/controller </code> directory and the key is its function.</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">methodToMiddleware</span>(<span class=\"hljs-params\">Controller, key</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">classControllerMiddleware</span>(<span class=\"hljs-params\">...args</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> controller = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Controller</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">app</span>.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">controller</span> || !<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">app</span>.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">controller</span>.<span class=\"hljs-property\">supportParams</span>) {</span><br><span class=\"line\">      args = [ <span class=\"variable language_\">this</span> ];</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> utils.<span class=\"title function_\">callFn</span>(controller[key], args, controller);</span><br><span class=\"line\">  };</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n\n</li>\n<li><p>loadRouter: it makes requests path associated with the controllers function that has been become to middleware (only <em>app</em>)</p>\n</li>\n<li><p>loadCustomLoader: load ourselves function to create some built-in objects for app object or other.<a href=\"https://eggjs.org/en/advanced/loader.html#customloader\">Customloader</a></p>\n</li>\n</ul>\n</li>\n<li><p><code>[master process]</code>: it listens to all worker processes and triggers the masters ready once they have finished booting.</p>\n</li>\n<li><p>send <code>egg-ready</code> to the parent process, the agent process, the app worker processes</p>\n</li>\n<li><p>Last, traverse BOOTS and run serverDidReady function of each item.</p>\n</li>\n</ul>\n<p>It is the whole boot for Eggjs framework but doesnt include, such as restarting a worker process when it exits or disconnects,  shuting down</p>\n<p><strong>Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.</strong></p>\n<p><strong>What happens when web app get an Http request?</strong></p>\n<p><em>We only discuss Eggjs code in the applaction layer. :)</em></p>\n<p>The <code>agent</code> cant deal with any request because it doesnt listen port. All request always hand over to <code>workers</code>. We look at creating worker code, it will run a app.callback function and listen port when it has booted.</p>\n<p>This callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controllers function.</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// koa/lib/application</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">Emitter</span> {</span><br><span class=\"line\">  <span class=\"title function_\">callback</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> fn = <span class=\"title function_\">compose</span>(<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">middleware</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!<span class=\"variable language_\">this</span>.<span class=\"title function_\">listenerCount</span>(<span class=\"hljs-string\">'error'</span>)) <span class=\"variable language_\">this</span>.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">'error'</span>, <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">onerror</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> <span class=\"title function_\">handleRequest</span> = (<span class=\"hljs-params\">req, res</span>) =&gt; {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> ctx = <span class=\"variable language_\">this</span>.<span class=\"title function_\">createContext</span>(req, res);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">handleRequest</span>(ctx, fn);</span><br><span class=\"line\">    };</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> handleRequest;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"title function_\">handleRequest</span>(<span class=\"hljs-params\">ctx, fnMiddleware</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> res = ctx.<span class=\"hljs-property\">res</span>;</span><br><span class=\"line\">    res.<span class=\"hljs-property\">statusCode</span> = <span class=\"hljs-number\">404</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> <span class=\"title function_\">onerror</span> = err =&gt; ctx.<span class=\"title function_\">onerror</span>(err);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> <span class=\"title function_\">handleResponse</span> = (<span class=\"hljs-params\"></span>) =&gt; <span class=\"title function_\">respond</span>(ctx);</span><br><span class=\"line\">    <span class=\"title function_\">onFinished</span>(res, onerror);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"title function_\">fnMiddleware</span>(ctx).<span class=\"title function_\">then</span>(handleResponse).<span class=\"title function_\">catch</span>(onerror);</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// egg/lib/application</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">EggApplication</span> {</span><br><span class=\"line\">\t<span class=\"title function_\">handleRequest</span>(<span class=\"hljs-params\">ctx, fnMiddleware</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">emit</span>(<span class=\"hljs-string\">'request'</span>, ctx)</span><br><span class=\"line\">    <span class=\"variable language_\">super</span>.<span class=\"title function_\">handleRequest</span>(ctx, fnMiddleware)</span><br><span class=\"line\">    <span class=\"title function_\">onFinished</span>(ctx.<span class=\"hljs-property\">res</span>, <span class=\"hljs-function\">() =&gt;</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">emit</span>(<span class=\"hljs-string\">'response'</span>, ctx))</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n\n\n<p><strong>In summary, we have know how to boot web app and deal with request in Eggjs.</strong> When we know it, we can easily write some plugins and middlewares to finish the business requirements.</p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<html><head></head><body><h3 id=\"Preface\"><a href=\"#Preface\" class=\"headerlink\" title=\"#Preface\"></a><strong>#Preface</strong></h3><p>This article will introduce the boot of <a href=\"https://eggjs.org/\">Eggjs</a> that is a Node.js web framework.</p>\n<p>It is based on Koa and can satisfy  your requirement through a large of plugins and middleware, even a your own framework. It is very important to create a cluster, an agent process and some worker processes when it is running. The cluster makes it stronger. Next, we can understand it by reading the source code.</p>\n<p>Eggjs has a few major libs, egg-coreeggegg-clusteregg-binegg-scripts and so on.</p>\n<p><strong>egg-core</strong>: it extends Koa and is as a parent object of every agent and worker.</p>\n<p><strong>egg</strong>: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.</p>\n<p><strong>egg-cluster</strong>: it creates a cluster and manages them.</p>\n<p><strong>egg-scripts and Egg-bin</strong>: their job is run the whole app in a different environment.</p>\n<br>\n\n<p><em><strong>Tips: We will discuss Eggjs with basing 2.x.x version.</strong></em></p>\n<br></body></html>","more":"<h2 id=\"Scan-Libs-Code\"><a href=\"#Scan-Libs-Code\" class=\"headerlink\" title=\"#Scan Libs Code\"></a><strong>#Scan Libs Code</strong></h2><p><em>* The directory and the code segment are not whole content after this post, these major are only for a better explanation.</em></p>\n<h3 id=\"egg-core\"><a href=\"#egg-core\" class=\"headerlink\" title=\"egg-core\"></a><strong>egg-core</strong></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> lib</span><br><span class=\"line\">   / loader (dir)</span><br><span class=\"line\">   mixin (dir)</span><br><span class=\"line\">   utils (dir)</span><br><span class=\"line\">  egg.js</span><br><span class=\"line\">  lifecycle.js</span><br></pre></td></tr></table></figure>\n\n<p>The above is the directory structure of egg-core.The <em><strong>egg.js</strong></em> and folder of the <em><strong>loader</strong></em> are important to point for this lib.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">KoaApplication</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;koa&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">Lifecycle</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./lifecycle&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">EggCore</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">KoaApplication</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">options = &#123;&#125;</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">lifecycle</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Lifecycle</span>(&#123;</span><br><span class=\"line\">      <span class=\"attr\">baseDir</span>: options.<span class=\"property\">baseDir</span>,</span><br><span class=\"line\">      <span class=\"attr\">app</span>: <span class=\"variable language_\">this</span>,</span><br><span class=\"line\">      <span class=\"attr\">logger</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">console</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"title class_\">Loader</span> = <span class=\"variable language_\">this</span>[<span class=\"variable constant_\">EGG_LOADER</span>]</span><br><span class=\"line\">    <span class=\"title function_\">assert</span>(<span class=\"title class_\">Loader</span>, <span class=\"string\">&quot;Symbol.for(&#x27;egg#loader&#x27;) is required&quot;</span>)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">loader</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Loader</span>(&#123;</span><br><span class=\"line\">      <span class=\"attr\">baseDir</span>: options.<span class=\"property\">baseDir</span>,</span><br><span class=\"line\">      <span class=\"attr\">app</span>: <span class=\"variable language_\">this</span>,</span><br><span class=\"line\">      <span class=\"attr\">plugins</span>: options.<span class=\"property\">plugins</span>,</span><br><span class=\"line\">      <span class=\"attr\">logger</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">console</span>,</span><br><span class=\"line\">      <span class=\"attr\">serverScope</span>: options.<span class=\"property\">serverScope</span>,</span><br><span class=\"line\">      <span class=\"attr\">env</span>: options.<span class=\"property\">env</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"title function_\">beforeStart</span>(<span class=\"params\">scope</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">lifecycle</span>.<span class=\"title function_\">registerBeforeStart</span>(scope)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"title function_\">ready</span>(<span class=\"params\">flagOrFunction</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"property\">lifecycle</span>.<span class=\"title function_\">ready</span>(flagOrFunction)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [<span class=\"variable constant_\">EGG_LOADER</span>]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./loader/egg_loader&#x27;</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>First, we can know why it is called that bases on Koa because EggCore extends KoaApplication.</p>\n<p>Second, it defines a few new fields in the construction function, such as <em>lifecycle</em> and <em>loader</em>. The <em>loader</em> field helps app for creating important feature include configplugincontrollerextendroutermiddlewareservice and so on, it will load some js file in the special directory when the app is starting.</p>\n<p>Another side, both <em>beforeStart</em> and <em>ready</em> often are called when we need to write some plugins.</p>\n<h3 id=\"egg\"><a href=\"#egg\" class=\"headerlink\" title=\"egg\"></a><strong>egg</strong></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> / app</span><br><span class=\"line\"> / config</span><br><span class=\"line\"> / lib</span><br><span class=\"line\">  - / core</span><br><span class=\"line\">    - / messenger</span><br><span class=\"line\">  - / jsdoc</span><br><span class=\"line\">  - / loader</span><br><span class=\"line\">  - agent.js</span><br><span class=\"line\">  - application.js</span><br><span class=\"line\">  - egg.js</span><br><span class=\"line\">  - start.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n\n<p>There is an egg.js file that is the same name in the egg-core, but it bases on <em>EggCore Class</em> and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">EggCore</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;egg-core&#x27;</span>).<span class=\"property\">EggCore</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> cluster = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;cluster-client&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">Messenger</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./core/messenger&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">EggApplication</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">EggCore</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">options = &#123;&#125;</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">loader</span>.<span class=\"title function_\">loadConfig</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span> = <span class=\"title class_\">Messenger</span>.<span class=\"title function_\">create</span>(<span class=\"variable language_\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// trigger serverDidReady hook when all app workers</span></span><br><span class=\"line\">    <span class=\"comment\">// and agent worker is ready</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span>.<span class=\"title function_\">once</span>(<span class=\"string\">&#x27;egg-ready&#x27;</span>, <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">lifecycle</span>.<span class=\"title function_\">triggerServerDidReady</span>()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">ready</span>(<span class=\"function\">() =&gt;</span></span><br><span class=\"line\">      process.<span class=\"title function_\">nextTick</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> dumpStartTime = <span class=\"title class_\">Date</span>.<span class=\"title function_\">now</span>()</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">dumpConfig</span>()</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">dumpTiming</span>()</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">coreLogger</span>.<span class=\"title function_\">info</span>(</span><br><span class=\"line\">          <span class=\"string\">&#x27;[egg:core] dump config after ready, %s&#x27;</span>,</span><br><span class=\"line\">          <span class=\"title function_\">ms</span>(<span class=\"title class_\">Date</span>.<span class=\"title function_\">now</span>() - dumpStartTime)</span><br><span class=\"line\">        )</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">cluster</span> = <span class=\"function\">(<span class=\"params\">clientClass, options</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      options = <span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>(&#123;&#125;, <span class=\"variable language_\">this</span>.<span class=\"property\">config</span>.<span class=\"property\">clusterClient</span>, options, &#123;</span><br><span class=\"line\">        <span class=\"attr\">singleMode</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">options</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;single&#x27;</span>,</span><br><span class=\"line\">        <span class=\"comment\">// cluster need a port that can&#x27;t conflict on the environment</span></span><br><span class=\"line\">        <span class=\"attr\">port</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">options</span>.<span class=\"property\">clusterPort</span>,</span><br><span class=\"line\">        <span class=\"comment\">// agent worker is leader, app workers are follower</span></span><br><span class=\"line\">        <span class=\"attr\">isLeader</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">type</span> === <span class=\"string\">&#x27;agent&#x27;</span>,</span><br><span class=\"line\">        <span class=\"attr\">logger</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">coreLogger</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"keyword\">const</span> client = <span class=\"title function_\">cluster</span>(clientClass, options)</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">_patchClusterClient</span>(client)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> client</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>See agent.js and application.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// agent.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">EggApplication</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./egg&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">AgentWorkerLoader</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./loader&#x27;</span>).<span class=\"property\">AgentWorkerLoader</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">EGG_LOADER</span> = <span class=\"title class_\">Symbol</span>.<span class=\"title function_\">for</span>(<span class=\"string\">&#x27;egg#loader&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Agent</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">EggApplication</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">options = &#123;&#125;</span>) &#123;</span><br><span class=\"line\">    options.<span class=\"property\">type</span> = <span class=\"string\">&#x27;agent&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">super</span>(options)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">loader</span>.<span class=\"title function_\">load</span>()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [<span class=\"variable constant_\">EGG_LOADER</span>]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title class_\">AgentWorkerLoader</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// application.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">EggApplication</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./egg&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">AgentWorkerLoader</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./loader&#x27;</span>).<span class=\"property\">AppWorkerLoader</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">EGG_LOADER</span> = <span class=\"title class_\">Symbol</span>.<span class=\"title function_\">for</span>(<span class=\"string\">&#x27;egg#loader&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">EggApplication</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">options = &#123;&#125;</span>) &#123;</span><br><span class=\"line\">    options.<span class=\"property\">type</span> = <span class=\"string\">&#x27;application&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">super</span>(options)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">loader</span>.<span class=\"title function_\">load</span>()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [<span class=\"variable constant_\">EGG_LOADER</span>]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title class_\">AppWorkerLoader</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>We can see that they override the <em>EGG_LOADER</em> property, which uses to create a new <em>loader</em> field in the construction of EggCore that is their parent class. Finally, they call the <em>load</em> function.</p>\n<p>We have the base application code. rNext, look a few of libs for starting web app.</p>\n<h3 id=\"egg-scripts-and-egg-bin\"><a href=\"#egg-scripts-and-egg-bin\" class=\"headerlink\" title=\"egg-scripts and egg-bin\"></a><strong>egg-scripts and egg-bin</strong></h3><p>Both these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost dont know them at most of time.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// package.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;scripts&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;start&quot;</span>: <span class=\"string\">&quot;env egg-scripts start&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;dev&quot;</span>: <span class=\"string\">&quot;env egg-bin dev&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;stop&quot;</span>: <span class=\"string\">&quot;egg-scripts stop&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;debug&quot;</span>: <span class=\"string\">&quot;egg-bin debug&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;test&quot;</span>: <span class=\"string\">&quot;npm run lint -- --fix &amp;&amp; npm run test-local&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;test-local&quot;</span>: <span class=\"string\">&quot;env egg-bin test&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;cov&quot;</span>: <span class=\"string\">&quot;egg-bin cov&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The <em>scripts</em> command of this eggjs app conforms to the above description.</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a><strong>egg-cluster</strong></h3><p>The cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- / lib</span><br><span class=\"line\">  - / utils</span><br><span class=\"line\">  - agent_worker.js</span><br><span class=\"line\">  - app_worker.js</span><br><span class=\"line\">  - master.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n\n<p>I had written an <a href=\"/2019/01/18/egg-cluster\">article</a> about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.</p>\n<h2 id=\"From-start-to-getting-the-first-request\"><a href=\"#From-start-to-getting-the-first-request\" class=\"headerlink\" title=\"#From start to getting the first request\"></a><strong>#From start to getting the first request</strong></h2><p><strong>What happens when we input <code>npm run dev</code> or <code>npm start</code> in the terminal?</strong></p>\n<ul>\n<li><strong>egg-scripts(prod):</strong> it can require <em>framework</em> by <code>child_process.spawn</code> and calls <em>startCluster</em> function.</li>\n<li><strong>egg-bin(dev):</strong> it can require <em>framework</em> by <code>child_process.fork</code> and calls <em>startCluster</em> function.</li>\n<li><code>[parent process]</code>: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the <code>framework</code> is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as <code>--framework &#123; your path &#125;</code></li>\n</ul>\n<p><strong>Pseudo Code</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-scripts</span></span><br><span class=\"line\"><span class=\"comment\">// parent process</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> spawn = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;child_process&#x27;</span>).<span class=\"property\">spawn</span> <span class=\"comment\">// create new process</span></span><br><span class=\"line\"><span class=\"title function_\">spawn</span>(<span class=\"string\">&#x27;node&#x27;</span>, <span class=\"string\">&#x27;require(&#123;&#123; framework path &#125;&#125;).startCluster(...)&#x27;</span>, options))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// egg-bin</span></span><br><span class=\"line\"><span class=\"comment\">// parent process</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> cp = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;child_process&#x27;</span>)</span><br><span class=\"line\">cp.<span class=\"title function_\">fork</span>(<span class=\"string\">&#x27;require(&#123;&#123; framework path &#125;&#125;).startCluster(...)&#x27;</span>, args, options) <span class=\"comment\">// create new process</span></span><br></pre></td></tr></table></figure>\n\n<p>Egg-scripts uses <code>spawn</code> function to require framework while egg-scripts calls <code>fork</code> function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.</p>\n<p>We have two processes. In general, this newly created process is called the master process.</p>\n<p><strong>Why is the master process called birdge?</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg index.js</span></span><br><span class=\"line\"><span class=\"built_in\">exports</span>.<span class=\"property\">startCluster</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;egg-cluster&#x27;</span>).<span class=\"property\">startCluster</span></span><br></pre></td></tr></table></figure>\n\n<p>Actually, we exec <code>egg-cluster</code>s startCluster function when we require the framework. We open <code>index.js</code> file in the egg-cluster lib. </p>\n<p><strong>First, it is real enter point for whole web app.</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// index.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">Master</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./lib/master&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">exports</span>.<span class=\"property\">startCluster</span> = <span class=\"keyword\">function</span>(<span class=\"params\">options, callback</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">new</span> <span class=\"title class_\">Master</span>(options).<span class=\"title function_\">ready</span>(callback)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ./lib/master.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> ready = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;get-ready&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> detectPort = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;detect-port&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">Manager</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./utils/manager&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">Messenger</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./utils/messenger&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">EventEmitter</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">options</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">super</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">options</span> = <span class=\"title function_\">parseOptions</span>(options)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">workerManager</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Manager</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Messenger</span>(<span class=\"variable language_\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    ready.<span class=\"title function_\">mixin</span>(<span class=\"variable language_\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">ready</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">isStarted</span> = <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> action = <span class=\"string\">&#x27;egg-ready&#x27;</span></span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span>.<span class=\"title function_\">send</span>(&#123;</span><br><span class=\"line\">        action,</span><br><span class=\"line\">        <span class=\"attr\">to</span>: <span class=\"string\">&#x27;parent&#x27;</span>,</span><br><span class=\"line\">        <span class=\"attr\">data</span>: &#123; <span class=\"attr\">port</span>: <span class=\"variable language_\">this</span>[<span class=\"variable constant_\">REALPORT</span>], <span class=\"attr\">address</span>: <span class=\"variable language_\">this</span>[<span class=\"variable constant_\">APP_ADDRESS</span>] &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span>.<span class=\"title function_\">send</span>(&#123; action, <span class=\"attr\">to</span>: <span class=\"string\">&#x27;app&#x27;</span>, <span class=\"attr\">data</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">options</span> &#125;)</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span>.<span class=\"title function_\">send</span>(&#123; action, <span class=\"attr\">to</span>: <span class=\"string\">&#x27;agent&#x27;</span>, <span class=\"attr\">data</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">options</span> &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// start check agent and worker status</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">isProduction</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">workerManager</span>.<span class=\"title function_\">startCheck</span>()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// fork app workers after agent started</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">once</span>(<span class=\"string\">&#x27;agent-start&#x27;</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">forkAppWorkers</span>.<span class=\"title function_\">bind</span>(<span class=\"variable language_\">this</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">detectPort</span>(<span class=\"function\">(<span class=\"params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* istanbul ignore if */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">        err.<span class=\"property\">name</span> = <span class=\"string\">&#x27;ClusterPortConflictError&#x27;</span></span><br><span class=\"line\">        err.<span class=\"property\">message</span> = <span class=\"string\">&#x27;[master] try get free port error, &#x27;</span> + err.<span class=\"property\">message</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">logger</span>.<span class=\"title function_\">error</span>(err)</span><br><span class=\"line\">        process.<span class=\"title function_\">exit</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">options</span>.<span class=\"property\">clusterPort</span> = port</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">forkAgentWorker</span>()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"title function_\">forkAppWorkers</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    cluster.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;fork&#x27;</span>, <span class=\"function\"><span class=\"params\">worker</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">      worker.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;message&#x27;</span>, <span class=\"function\"><span class=\"params\">msg</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">&#x27;string&#x27;</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">        msg.<span class=\"property\">from</span> = <span class=\"string\">&#x27;app&#x27;</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span>.<span class=\"title function_\">send</span>(msg);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"title function_\">forkAgentWorker</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    agentWorker.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;message&#x27;</span>, <span class=\"function\"><span class=\"params\">msg</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">&#x27;string&#x27;</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">      msg.<span class=\"property\">from</span> = <span class=\"string\">&#x27;agent&#x27;</span>;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">messenger</span>.<span class=\"title function_\">send</span>(msg);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// the callback of ready function will be trigger after all major boots had been loaded</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// forkAgentWorker</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> agent = <span class=\"keyword\">new</span> <span class=\"title class_\">Agent</span>(options)</span><br><span class=\"line\">agent.<span class=\"title function_\">ready</span>(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (err) <span class=\"keyword\">return</span></span><br><span class=\"line\">  process.<span class=\"title function_\">send</span>(&#123; <span class=\"attr\">action</span>: <span class=\"string\">&#x27;agent-start&#x27;</span>, <span class=\"attr\">to</span>: <span class=\"string\">&#x27;master&#x27;</span> &#125;)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// fork a single worker</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> <span class=\"title class_\">Application</span>(options);</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">startServer</span>(<span class=\"params\">err</span>) &#123;  </span><br><span class=\"line\">  <span class=\"keyword\">let</span> server;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (options.<span class=\"property\">https</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> httpsOptions = <span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>(&#123;&#125;, options.<span class=\"property\">https</span>, &#123;</span><br><span class=\"line\">      <span class=\"attr\">key</span>: fs.<span class=\"title function_\">readFileSync</span>(options.<span class=\"property\">https</span>.<span class=\"property\">key</span>),</span><br><span class=\"line\">      <span class=\"attr\">cert</span>: fs.<span class=\"title function_\">readFileSync</span>(options.<span class=\"property\">https</span>.<span class=\"property\">cert</span>),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    server = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;https&#x27;</span>).<span class=\"title function_\">createServer</span>(httpsOptions, app.<span class=\"title function_\">callback</span>());</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    server = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;http&#x27;</span>).<span class=\"title function_\">createServer</span>(app.<span class=\"title function_\">callback</span>());</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// emit `server` event in app</span></span><br><span class=\"line\">  app.<span class=\"title function_\">emit</span>(<span class=\"string\">&#x27;server&#x27;</span>, server);</span><br><span class=\"line\">  </span><br><span class=\"line\">  server.<span class=\"title function_\">listen</span>(...args);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">app.<span class=\"title function_\">ready</span>(startServer);</span><br></pre></td></tr></table></figure>\n\n<p>On the other hand, this web will be constructed during creating a <code>Master</code> object.</p>\n<ul>\n<li>workerManager: it will hold on all worker porcesses.</li>\n<li>messenger: we make <code>master</code> a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an <a href=\"%5Bhttp://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC%5D(http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC)\">article(Chinese)</a> about it.</li>\n</ul>\n<blockquote>\n<ul>\n<li>The Master maintains a Messenger instance (egg-cluster&#x2F;lib&#x2F;utils&#x2F;messenger.js)</li>\n<li>EggApplication maintain the other Messenge instance egg&#x2F;lib&#x2F;core&#x2F;messenger.js</li>\n<li>Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master</li>\n</ul>\n</blockquote>\n<ul>\n<li><p>ready.mixin &amp; this.ready: get-ready often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.</p>\n</li>\n<li><p>detectPort: apply for an available port, default is 7001.If Successly, it will <code>fork</code> an agent process and register a callback message for new created an agent object.</p>\n</li>\n<li><p><code>[agent process]</code>: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.</p>\n<ul>\n<li><p>loadPlugin: find all plugin, record their dir paths &#x3D;&gt; this.dirs</p>\n</li>\n<li><p>loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.</p>\n</li>\n<li><p>loadAgentExtend: load and merge all of the extending of agent object  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadContextExtend: load and merge all of the extending of context object  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.<a href=\"https://eggjs.org/en/basics/app-start.html\">Application Startup Configuration(official)</a>. It help you for better writing a few plugins.</p>\n</li>\n<li><p>Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending <code>&#39;agent-start&#39;</code> to the master process.</p>\n</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"/images/egg-boot/egg-boot.jpg\" alt=\"egg boot process\"></p>\n<ul>\n<li><p><code>[master process]</code>: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get <code>&#39;agent-start&#39;</code> message from the agent process. It will open a new relatable load, we take a single worker process example.</p>\n</li>\n<li><p><code>[a single worker process]</code>: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.</p>\n<ul>\n<li><p>loadPlugin: same as the agent</p>\n</li>\n<li><p>loadConfig: same as the agent</p>\n</li>\n<li><p>loadApplicationExtend: same as the agent  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadRequestExtend: load and merge all of the extending of request object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadResponseExtend: load and merge all of the extending of response object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadContextExtend: same as the agent</p>\n</li>\n<li><p>loadHelperExtend: load and merge all of the extending of helper object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadCustomApp: same as the agent <em>app &gt; plugin</em></p>\n</li>\n<li><p>loadService: load and merge all of the extending of helper object <em>app &gt; plugin</em></p>\n</li>\n<li><p>loadMiddleware: load middlewares and iterate them &#x3D;&gt; mw, if it conforms the middleware standard, it will be used with app.use(mw) <em>app &gt; plugin &gt; core</em></p>\n</li>\n<li><p>loadController: iterate all controllers functions &#x3D;&gt; key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only <em>app</em>). This middleware will be triggered when getting a new request, the Controller is defined in the <code>app/controller </code> directory and the key is its function.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">methodToMiddleware</span>(<span class=\"params\">Controller, key</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">function</span> <span class=\"title function_\">classControllerMiddleware</span>(<span class=\"params\">...args</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> controller = <span class=\"keyword\">new</span> <span class=\"title class_\">Controller</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"variable language_\">this</span>.<span class=\"property\">app</span>.<span class=\"property\">config</span>.<span class=\"property\">controller</span> || !<span class=\"variable language_\">this</span>.<span class=\"property\">app</span>.<span class=\"property\">config</span>.<span class=\"property\">controller</span>.<span class=\"property\">supportParams</span>) &#123;</span><br><span class=\"line\">      args = [ <span class=\"variable language_\">this</span> ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> utils.<span class=\"title function_\">callFn</span>(controller[key], args, controller);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n</li>\n<li><p>loadRouter: it makes requests path associated with the controllers function that has been become to middleware (only <em>app</em>)</p>\n</li>\n<li><p>loadCustomLoader: load ourselves function to create some built-in objects for app object or other.<a href=\"https://eggjs.org/en/advanced/loader.html#customloader\">Customloader</a></p>\n</li>\n</ul>\n</li>\n<li><p><code>[master process]</code>: it listens to all worker processes and triggers the masters ready once they have finished booting.</p>\n</li>\n<li><p>send <code>egg-ready</code> to the parent process, the agent process, the app worker processes</p>\n</li>\n<li><p>Last, traverse BOOTS and run serverDidReady function of each item.</p>\n</li>\n</ul>\n<p>It is the whole boot for Eggjs framework but doesnt include, such as restarting a worker process when it exits or disconnects,  shuting down</p>\n<p><strong>Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.</strong></p>\n<p><strong>What happens when web app get an Http request?</strong></p>\n<p><em>We only discuss Eggjs code in the applaction layer. :)</em></p>\n<p>The <code>agent</code> cant deal with any request because it doesnt listen port. All request always hand over to <code>workers</code>. We look at creating worker code, it will run a app.callback function and listen port when it has booted.</p>\n<p>This callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controllers function.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// koa/lib/application</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">Emitter</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">callback</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> fn = <span class=\"title function_\">compose</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">middleware</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"variable language_\">this</span>.<span class=\"title function_\">listenerCount</span>(<span class=\"string\">&#x27;error&#x27;</span>)) <span class=\"variable language_\">this</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;error&#x27;</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">onerror</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"title function_\">handleRequest</span> = (<span class=\"params\">req, res</span>) =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> ctx = <span class=\"variable language_\">this</span>.<span class=\"title function_\">createContext</span>(req, res);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">handleRequest</span>(ctx, fn);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> handleRequest;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"title function_\">handleRequest</span>(<span class=\"params\">ctx, fnMiddleware</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> res = ctx.<span class=\"property\">res</span>;</span><br><span class=\"line\">    res.<span class=\"property\">statusCode</span> = <span class=\"number\">404</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"title function_\">onerror</span> = err =&gt; ctx.<span class=\"title function_\">onerror</span>(err);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"title function_\">handleResponse</span> = (<span class=\"params\"></span>) =&gt; <span class=\"title function_\">respond</span>(ctx);</span><br><span class=\"line\">    <span class=\"title function_\">onFinished</span>(res, onerror);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">fnMiddleware</span>(ctx).<span class=\"title function_\">then</span>(handleResponse).<span class=\"title function_\">catch</span>(onerror);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// egg/lib/application</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">EggApplication</span> &#123;</span><br><span class=\"line\">\t<span class=\"title function_\">handleRequest</span>(<span class=\"params\">ctx, fnMiddleware</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">emit</span>(<span class=\"string\">&#x27;request&#x27;</span>, ctx)</span><br><span class=\"line\">    <span class=\"variable language_\">super</span>.<span class=\"title function_\">handleRequest</span>(ctx, fnMiddleware)</span><br><span class=\"line\">    <span class=\"title function_\">onFinished</span>(ctx.<span class=\"property\">res</span>, <span class=\"function\">() =&gt;</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">emit</span>(<span class=\"string\">&#x27;response&#x27;</span>, ctx))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>In summary, we have know how to boot web app and deal with request in Eggjs.</strong> When we know it, we can easily write some plugins and middlewares to finish the business requirements.</p>"},{"title":"icestark ","date":"2020-11-09T15:11:36.000Z","_content":"\n##  icestark\n\n> icestark \n\n[](https://github.com/ice-lab/icestark)\n\n## \n\n![](/images/icestark-sandbox/icestark.png)\n\n<!-- more -->\n\n#### \n\n```javascript\n//    handleStateChange\nconst hijackHistory = (): void => {\n  window.history.pushState = (state: any, title: string, url?: string, ...rest) => {\n    originalPush.apply(window.history, [state, title, url, ...rest]);\n    const eventName = 'pushState';\n    handleStateChange(createPopStateEvent(state, eventName), url, eventName);\n  };\n\n  window.history.replaceState = (state: any, title: string, url?: string, ...rest) => {\n    originalReplace.apply(window.history, [state, title, url, ...rest]);\n    const eventName = 'replaceState';\n    handleStateChange(createPopStateEvent(state, eventName), url, eventName);\n  };\n\n  window.addEventListener('popstate', urlChange, false);\n  window.addEventListener('hashchange', urlChange, false);\n};\n\nconst handleStateChange = (event: PopStateEvent, url: string, method: RouteType) => {\n  setHistoryEvent(event);\n  // globalConfiguration.reroute(url, method);\n  reroute(url, method);\n};\n\nfunction reroute (url: string, type: RouteType | 'init' | 'popstate'| 'hashchange' ) {\n  const { pathname, query, hash } = urlParse(url, true);\n  const unmountApps = [];\n  const activeApps = [];\n  // \n  getMicroApps().forEach((microApp: AppConfig) => {\n    const shouldBeActive = microApp.checkActive(url);\n    if (shouldBeActive) {\n      activeApps.push(microApp);\n    } else {\n      unmountApps.push(microApp);\n    }\n  });\n  Promise.all(\n    unmountApps.map(async (unmountApp) => {\n      // mounted\n      if (unmountApp.status === MOUNTED || unmountApp.status === LOADING_ASSETS) {\n        globalConfiguration.onAppLeave(unmountApp);\n      }\n      await unmountMicroApp(unmountApp.name);\n    }).concat(activeApps.map(async (activeApp) => {\n      if (activeApp.status !== MOUNTED) {\n        globalConfiguration.onAppEnter(activeApp);\n      }\n      // \n      await createMicroApp(activeApp);\n    }))\n  )\n};\n\nasync function loadAppModule(appConfig: AppConfig) {\n  const appSandbox = createSandbox(appConfig.sandbox);\n  const { url, container, entry, entryContent, name } = appConfig;\n  // JSCSS URL HTML\n  const appAssets = url ? getUrlAssets(url) : await getEntryAssets({ ... });\n  //  JSCSS\n  await appendAssets(appAssets, appSandbox);\n  lifecycle = {\n    mount: getCache(AppLifeCycleEnum.AppEnter),\n    unmount: getCache(AppLifeCycleEnum.AppLeave),\n  };\n  return combineLifecyle(lifecycle, appConfig); // \n}\n\nexport async function appendAssets(assets: Assets, sandbox?: Sandbox) {\n  // CSS  link  CSS Modules\n  await loadAndAppendCssAssets(assets);\n  // JS \n  await loadAndAppendJsAssets(assets, sandbox);\n}\n\nexport async function loadAndAppendJsAssets(assets: Assets, sandbox?: Sandbox) {\n  //  JS URL\n  const jsContents = await fetchScripts(jsList);\n  // excute code by order\n  jsContents.forEach(script => {\n    sandbox.execScriptInSandbox(script);\n  });\n}\n\nclass Sandbox {\n  private eventListeners = {};\n  private timeoutIds: number[] = [];\n  private intervalIds: number[] = [];\n\n  constructor(props: SandboxProps = {}) {\n    this.sandbox = null;\n  }\n\n  execScriptInSandbox(script: string): void {\n    this.createProxySandbox();\n    // with + Function \n    //  sandbox \n    const execScript = `with (sandbox) {;${script}\\n}`;\n    const code = new Function('sandbox', execScript).bind(this.sandbox);\n    // run code with sandbox\n    // sandbox  window\n    code(this.sandbox);\n  }\n\ncreateProxySandbox() {\n    const proxyWindow = Object.create(null) as Window;\n    const originalWindow = window;\n    const originalAddEventListener = window.addEventListener;\n    const originalRemoveEventListener = window.removeEventListener;\n    const originalSetInerval = window.setInterval;\n    const originalSetTimeout = window.setTimeout;\n    // \n    // \n    // \n    proxyWindow.addEventListener = (eventName, fn, ...rest) => {\n      const listeners = this.eventListeners[eventName] || [];\n      listeners.push(fn);\n      return originalAddEventListener.apply(originalWindow, [eventName, fn, ...rest]);\n    };\n    proxyWindow.removeEventListener = (eventName, fn, ...rest) => {\n      const listeners = this.eventListeners[eventName] || [];\n      if (listeners.includes(fn)) {\n        listeners.splice(listeners.indexOf(fn), 1);\n      }\n      return originalRemoveEventListener.apply(originalWindow, [eventName, fn, ...rest]);\n    };\n    proxyWindow.setTimeout = (...args) => {\n      const timerId = originalSetTimeout(...args);\n      this.timeoutIds.push(timerId);\n      return timerId;\n    };\n    // hijack setInterval\n    proxyWindow.setInterval = (...args) => {\n      const intervalId = originalSetInerval(...args);\n      this.intervalIds.push(intervalId);\n      return intervalId;\n    };\n\n    const sandbox = new Proxy(proxyWindow, {\n      set(target: Window, p: PropertyKey, value: any): boolean {\n\n      },\n      get(target: Window, p: PropertyKey): any {\n\n      },\n      has(target: Window, p: PropertyKey): boolean {\n        return p in target || p in originalWindow;\n      },\n    });\n    this.sandbox = sandbox;\n  }\n  clear() {\n    // remove event listeners\n    Object.keys(this.eventListeners).forEach((eventName) => {\n      (this.eventListeners[eventName] || []).forEach(listener => {\n        window.removeEventListener(eventName, listener);\n      });\n    });\n    // clear timeout\n    this.timeoutIds.forEach(id => window.clearTimeout(id));\n    this.intervalIds.forEach(id => window.clearInterval(id));\n  }\n}\n\nasync function createMicroApp(app: string | AppConfig, appLifecyle?: AppLifecylceOptions) {\n  const appConfig = getAppConfigForLoad(app, appLifecyle);\n  lifeCycle = await loadAppModule(appConfig);\n  // mount\n  mountMicroApp(appConfig.name);\n}\n```\n\n icestark  JS  with + new Function  Proxy  window \n","source":"_posts/icestark-sandbox.md","raw":"---\ntitle: icestark \ndate: 2020-11-09 23:11:36\ntags:\n---\n\n##  icestark\n\n> icestark \n\n[](https://github.com/ice-lab/icestark)\n\n## \n\n![](/images/icestark-sandbox/icestark.png)\n\n<!-- more -->\n\n#### \n\n```javascript\n//    handleStateChange\nconst hijackHistory = (): void => {\n  window.history.pushState = (state: any, title: string, url?: string, ...rest) => {\n    originalPush.apply(window.history, [state, title, url, ...rest]);\n    const eventName = 'pushState';\n    handleStateChange(createPopStateEvent(state, eventName), url, eventName);\n  };\n\n  window.history.replaceState = (state: any, title: string, url?: string, ...rest) => {\n    originalReplace.apply(window.history, [state, title, url, ...rest]);\n    const eventName = 'replaceState';\n    handleStateChange(createPopStateEvent(state, eventName), url, eventName);\n  };\n\n  window.addEventListener('popstate', urlChange, false);\n  window.addEventListener('hashchange', urlChange, false);\n};\n\nconst handleStateChange = (event: PopStateEvent, url: string, method: RouteType) => {\n  setHistoryEvent(event);\n  // globalConfiguration.reroute(url, method);\n  reroute(url, method);\n};\n\nfunction reroute (url: string, type: RouteType | 'init' | 'popstate'| 'hashchange' ) {\n  const { pathname, query, hash } = urlParse(url, true);\n  const unmountApps = [];\n  const activeApps = [];\n  // \n  getMicroApps().forEach((microApp: AppConfig) => {\n    const shouldBeActive = microApp.checkActive(url);\n    if (shouldBeActive) {\n      activeApps.push(microApp);\n    } else {\n      unmountApps.push(microApp);\n    }\n  });\n  Promise.all(\n    unmountApps.map(async (unmountApp) => {\n      // mounted\n      if (unmountApp.status === MOUNTED || unmountApp.status === LOADING_ASSETS) {\n        globalConfiguration.onAppLeave(unmountApp);\n      }\n      await unmountMicroApp(unmountApp.name);\n    }).concat(activeApps.map(async (activeApp) => {\n      if (activeApp.status !== MOUNTED) {\n        globalConfiguration.onAppEnter(activeApp);\n      }\n      // \n      await createMicroApp(activeApp);\n    }))\n  )\n};\n\nasync function loadAppModule(appConfig: AppConfig) {\n  const appSandbox = createSandbox(appConfig.sandbox);\n  const { url, container, entry, entryContent, name } = appConfig;\n  // JSCSS URL HTML\n  const appAssets = url ? getUrlAssets(url) : await getEntryAssets({ ... });\n  //  JSCSS\n  await appendAssets(appAssets, appSandbox);\n  lifecycle = {\n    mount: getCache(AppLifeCycleEnum.AppEnter),\n    unmount: getCache(AppLifeCycleEnum.AppLeave),\n  };\n  return combineLifecyle(lifecycle, appConfig); // \n}\n\nexport async function appendAssets(assets: Assets, sandbox?: Sandbox) {\n  // CSS  link  CSS Modules\n  await loadAndAppendCssAssets(assets);\n  // JS \n  await loadAndAppendJsAssets(assets, sandbox);\n}\n\nexport async function loadAndAppendJsAssets(assets: Assets, sandbox?: Sandbox) {\n  //  JS URL\n  const jsContents = await fetchScripts(jsList);\n  // excute code by order\n  jsContents.forEach(script => {\n    sandbox.execScriptInSandbox(script);\n  });\n}\n\nclass Sandbox {\n  private eventListeners = {};\n  private timeoutIds: number[] = [];\n  private intervalIds: number[] = [];\n\n  constructor(props: SandboxProps = {}) {\n    this.sandbox = null;\n  }\n\n  execScriptInSandbox(script: string): void {\n    this.createProxySandbox();\n    // with + Function \n    //  sandbox \n    const execScript = `with (sandbox) {;${script}\\n}`;\n    const code = new Function('sandbox', execScript).bind(this.sandbox);\n    // run code with sandbox\n    // sandbox  window\n    code(this.sandbox);\n  }\n\ncreateProxySandbox() {\n    const proxyWindow = Object.create(null) as Window;\n    const originalWindow = window;\n    const originalAddEventListener = window.addEventListener;\n    const originalRemoveEventListener = window.removeEventListener;\n    const originalSetInerval = window.setInterval;\n    const originalSetTimeout = window.setTimeout;\n    // \n    // \n    // \n    proxyWindow.addEventListener = (eventName, fn, ...rest) => {\n      const listeners = this.eventListeners[eventName] || [];\n      listeners.push(fn);\n      return originalAddEventListener.apply(originalWindow, [eventName, fn, ...rest]);\n    };\n    proxyWindow.removeEventListener = (eventName, fn, ...rest) => {\n      const listeners = this.eventListeners[eventName] || [];\n      if (listeners.includes(fn)) {\n        listeners.splice(listeners.indexOf(fn), 1);\n      }\n      return originalRemoveEventListener.apply(originalWindow, [eventName, fn, ...rest]);\n    };\n    proxyWindow.setTimeout = (...args) => {\n      const timerId = originalSetTimeout(...args);\n      this.timeoutIds.push(timerId);\n      return timerId;\n    };\n    // hijack setInterval\n    proxyWindow.setInterval = (...args) => {\n      const intervalId = originalSetInerval(...args);\n      this.intervalIds.push(intervalId);\n      return intervalId;\n    };\n\n    const sandbox = new Proxy(proxyWindow, {\n      set(target: Window, p: PropertyKey, value: any): boolean {\n\n      },\n      get(target: Window, p: PropertyKey): any {\n\n      },\n      has(target: Window, p: PropertyKey): boolean {\n        return p in target || p in originalWindow;\n      },\n    });\n    this.sandbox = sandbox;\n  }\n  clear() {\n    // remove event listeners\n    Object.keys(this.eventListeners).forEach((eventName) => {\n      (this.eventListeners[eventName] || []).forEach(listener => {\n        window.removeEventListener(eventName, listener);\n      });\n    });\n    // clear timeout\n    this.timeoutIds.forEach(id => window.clearTimeout(id));\n    this.intervalIds.forEach(id => window.clearInterval(id));\n  }\n}\n\nasync function createMicroApp(app: string | AppConfig, appLifecyle?: AppLifecylceOptions) {\n  const appConfig = getAppConfigForLoad(app, appLifecyle);\n  lifeCycle = await loadAppModule(appConfig);\n  // mount\n  mountMicroApp(appConfig.name);\n}\n```\n\n icestark  JS  with + new Function  Proxy  window \n","slug":"icestark-sandbox","published":1,"updated":"2024-04-08T13:34:02.453Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wdy000e18fdc22z4qni","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><h2 id=\"-icestark\"><a href=\"#-icestark\" class=\"headerlink\" title=\" icestark\"></a> icestark</h2><blockquote>\n<p>icestark </p>\n</blockquote>\n<p><a href=\"https://github.com/ice-lab/icestark\"></a></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"/images/icestark-sandbox/icestark.png\" alt=\"\"></p>\n<span id=\"more\"></span>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">//    handleStateChange</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> hijackHistory = (): <span class=\"hljs-function\"><span class=\"hljs-params\">void</span> =&gt;</span> {</span><br><span class=\"line\">  <span class=\"variable language_\">window</span>.<span class=\"hljs-property\">history</span>.<span class=\"hljs-property\">pushState</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">state: any, title: string, url?: string, ...rest</span>) =&gt;</span> {</span><br><span class=\"line\">    originalPush.<span class=\"title function_\">apply</span>(<span class=\"variable language_\">window</span>.<span class=\"hljs-property\">history</span>, [state, title, url, ...rest]);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> eventName = <span class=\"hljs-string\">'pushState'</span>;</span><br><span class=\"line\">    <span class=\"title function_\">handleStateChange</span>(<span class=\"title function_\">createPopStateEvent</span>(state, eventName), url, eventName);</span><br><span class=\"line\">  };</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">window</span>.<span class=\"hljs-property\">history</span>.<span class=\"hljs-property\">replaceState</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">state: any, title: string, url?: string, ...rest</span>) =&gt;</span> {</span><br><span class=\"line\">    originalReplace.<span class=\"title function_\">apply</span>(<span class=\"variable language_\">window</span>.<span class=\"hljs-property\">history</span>, [state, title, url, ...rest]);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> eventName = <span class=\"hljs-string\">'replaceState'</span>;</span><br><span class=\"line\">    <span class=\"title function_\">handleStateChange</span>(<span class=\"title function_\">createPopStateEvent</span>(state, eventName), url, eventName);</span><br><span class=\"line\">  };</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">window</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"hljs-string\">'popstate'</span>, urlChange, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">  <span class=\"variable language_\">window</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"hljs-string\">'hashchange'</span>, urlChange, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title function_\">handleStateChange</span> = (<span class=\"hljs-params\">event: PopStateEvent, url: string, method: RouteType</span>) =&gt; {</span><br><span class=\"line\">  <span class=\"title function_\">setHistoryEvent</span>(event);</span><br><span class=\"line\">  <span class=\"hljs-comment\">// globalConfiguration.reroute(url, method);</span></span><br><span class=\"line\">  <span class=\"title function_\">reroute</span>(url, method);</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">reroute</span> (<span class=\"hljs-attr\">url</span>: string, <span class=\"hljs-attr\">type</span>: <span class=\"title class_\">RouteType</span> | <span class=\"hljs-string\">'init'</span> | <span class=\"hljs-string\">'popstate'</span>| <span class=\"hljs-string\">'hashchange'</span> ) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> { pathname, query, hash } = <span class=\"title function_\">urlParse</span>(url, <span class=\"hljs-literal\">true</span>);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> unmountApps = [];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> activeApps = [];</span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"title function_\">getMicroApps</span>().<span class=\"title function_\">forEach</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">microApp: AppConfig</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> shouldBeActive = microApp.<span class=\"title function_\">checkActive</span>(url);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (shouldBeActive) {</span><br><span class=\"line\">      activeApps.<span class=\"title function_\">push</span>(microApp);</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">      unmountApps.<span class=\"title function_\">push</span>(microApp);</span><br><span class=\"line\">    }</span><br><span class=\"line\">  });</span><br><span class=\"line\">  <span class=\"title class_\">Promise</span>.<span class=\"title function_\">all</span>(</span><br><span class=\"line\">    unmountApps.<span class=\"title function_\">map</span>(<span class=\"hljs-keyword\">async</span> (unmountApp) =&gt; {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// mounted</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (unmountApp.<span class=\"hljs-property\">status</span> === <span class=\"variable constant_\">MOUNTED</span> || unmountApp.<span class=\"hljs-property\">status</span> === <span class=\"variable constant_\">LOADING_ASSETS</span>) {</span><br><span class=\"line\">        globalConfiguration.<span class=\"title function_\">onAppLeave</span>(unmountApp);</span><br><span class=\"line\">      }</span><br><span class=\"line\">      <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">unmountMicroApp</span>(unmountApp.<span class=\"hljs-property\">name</span>);</span><br><span class=\"line\">    }).<span class=\"title function_\">concat</span>(activeApps.<span class=\"title function_\">map</span>(<span class=\"hljs-keyword\">async</span> (activeApp) =&gt; {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (activeApp.<span class=\"hljs-property\">status</span> !== <span class=\"variable constant_\">MOUNTED</span>) {</span><br><span class=\"line\">        globalConfiguration.<span class=\"title function_\">onAppEnter</span>(activeApp);</span><br><span class=\"line\">      }</span><br><span class=\"line\">      <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">createMicroApp</span>(activeApp);</span><br><span class=\"line\">    }))</span><br><span class=\"line\">  )</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">loadAppModule</span>(<span class=\"hljs-params\">appConfig: AppConfig</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> appSandbox = <span class=\"title function_\">createSandbox</span>(appConfig.<span class=\"hljs-property\">sandbox</span>);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> { url, container, entry, entryContent, name } = appConfig;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// JSCSS URL HTML</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> appAssets = url ? <span class=\"title function_\">getUrlAssets</span>(url) : <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">getEntryAssets</span>({ ... });</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  JSCSS</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">appendAssets</span>(appAssets, appSandbox);</span><br><span class=\"line\">  lifecycle = {</span><br><span class=\"line\">    <span class=\"hljs-attr\">mount</span>: <span class=\"title function_\">getCache</span>(<span class=\"title class_\">AppLifeCycleEnum</span>.<span class=\"hljs-property\">AppEnter</span>),</span><br><span class=\"line\">    <span class=\"hljs-attr\">unmount</span>: <span class=\"title function_\">getCache</span>(<span class=\"title class_\">AppLifeCycleEnum</span>.<span class=\"hljs-property\">AppLeave</span>),</span><br><span class=\"line\">  };</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"title function_\">combineLifecyle</span>(lifecycle, appConfig); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">appendAssets</span>(<span class=\"hljs-params\">assets: Assets, sandbox?: Sandbox</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// CSS  link  CSS Modules</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">loadAndAppendCssAssets</span>(assets);</span><br><span class=\"line\">  <span class=\"hljs-comment\">// JS </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">loadAndAppendJsAssets</span>(assets, sandbox);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">loadAndAppendJsAssets</span>(<span class=\"hljs-params\">assets: Assets, sandbox?: Sandbox</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  JS URL</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> jsContents = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">fetchScripts</span>(jsList);</span><br><span class=\"line\">  <span class=\"hljs-comment\">// excute code by order</span></span><br><span class=\"line\">  jsContents.<span class=\"title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">script</span> =&gt;</span> {</span><br><span class=\"line\">    sandbox.<span class=\"title function_\">execScriptInSandbox</span>(script);</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Sandbox</span> {</span><br><span class=\"line\">  private eventListeners = {};</span><br><span class=\"line\">  private <span class=\"hljs-attr\">timeoutIds</span>: number[] = [];</span><br><span class=\"line\">  private <span class=\"hljs-attr\">intervalIds</span>: number[] = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"hljs-params\">props: SandboxProps = {}</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">sandbox</span> = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">execScriptInSandbox</span>(<span class=\"hljs-attr\">script</span>: string): <span class=\"hljs-keyword\">void</span> {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">createProxySandbox</span>();</span><br><span class=\"line\">    <span class=\"hljs-comment\">// with + Function </span></span><br><span class=\"line\">    <span class=\"hljs-comment\">//  sandbox </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> execScript = <span class=\"hljs-string\">`with (sandbox) {;<span class=\"hljs-subst\">${script}</span>\\n}`</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> code = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Function</span>(<span class=\"hljs-string\">'sandbox'</span>, execScript).<span class=\"title function_\">bind</span>(<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">sandbox</span>);</span><br><span class=\"line\">    <span class=\"hljs-comment\">// run code with sandbox</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// sandbox  window</span></span><br><span class=\"line\">    <span class=\"title function_\">code</span>(<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">sandbox</span>);</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">createProxySandbox</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> proxyWindow = <span class=\"title class_\">Object</span>.<span class=\"title function_\">create</span>(<span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">as</span> <span class=\"title class_\">Window</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> originalWindow = <span class=\"variable language_\">window</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> originalAddEventListener = <span class=\"variable language_\">window</span>.<span class=\"hljs-property\">addEventListener</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> originalRemoveEventListener = <span class=\"variable language_\">window</span>.<span class=\"hljs-property\">removeEventListener</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> originalSetInerval = <span class=\"variable language_\">window</span>.<span class=\"hljs-property\">setInterval</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> originalSetTimeout = <span class=\"variable language_\">window</span>.<span class=\"hljs-property\">setTimeout</span>;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    proxyWindow.<span class=\"hljs-property\">addEventListener</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">eventName, fn, ...rest</span>) =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> listeners = <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">eventListeners</span>[eventName] || [];</span><br><span class=\"line\">      listeners.<span class=\"title function_\">push</span>(fn);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> originalAddEventListener.<span class=\"title function_\">apply</span>(originalWindow, [eventName, fn, ...rest]);</span><br><span class=\"line\">    };</span><br><span class=\"line\">    proxyWindow.<span class=\"hljs-property\">removeEventListener</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">eventName, fn, ...rest</span>) =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> listeners = <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">eventListeners</span>[eventName] || [];</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (listeners.<span class=\"title function_\">includes</span>(fn)) {</span><br><span class=\"line\">        listeners.<span class=\"title function_\">splice</span>(listeners.<span class=\"title function_\">indexOf</span>(fn), <span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">      }</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> originalRemoveEventListener.<span class=\"title function_\">apply</span>(originalWindow, [eventName, fn, ...rest]);</span><br><span class=\"line\">    };</span><br><span class=\"line\">    proxyWindow.<span class=\"hljs-property\">setTimeout</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">...args</span>) =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> timerId = <span class=\"title function_\">originalSetTimeout</span>(...args);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">timeoutIds</span>.<span class=\"title function_\">push</span>(timerId);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> timerId;</span><br><span class=\"line\">    };</span><br><span class=\"line\">    <span class=\"hljs-comment\">// hijack setInterval</span></span><br><span class=\"line\">    proxyWindow.<span class=\"hljs-property\">setInterval</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">...args</span>) =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> intervalId = <span class=\"title function_\">originalSetInerval</span>(...args);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">intervalIds</span>.<span class=\"title function_\">push</span>(intervalId);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> intervalId;</span><br><span class=\"line\">    };</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> sandbox = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Proxy</span>(proxyWindow, {</span><br><span class=\"line\">      <span class=\"title function_\">set</span>(<span class=\"hljs-attr\">target</span>: <span class=\"title class_\">Window</span>, <span class=\"hljs-attr\">p</span>: <span class=\"title class_\">PropertyKey</span>, <span class=\"hljs-attr\">value</span>: any): boolean {</span><br><span class=\"line\"></span><br><span class=\"line\">      },</span><br><span class=\"line\">      <span class=\"title function_\">get</span>(<span class=\"hljs-attr\">target</span>: <span class=\"title class_\">Window</span>, <span class=\"hljs-attr\">p</span>: <span class=\"title class_\">PropertyKey</span>): any {</span><br><span class=\"line\"></span><br><span class=\"line\">      },</span><br><span class=\"line\">      <span class=\"title function_\">has</span>(<span class=\"hljs-attr\">target</span>: <span class=\"title class_\">Window</span>, <span class=\"hljs-attr\">p</span>: <span class=\"title class_\">PropertyKey</span>): boolean {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> p <span class=\"hljs-keyword\">in</span> target || p <span class=\"hljs-keyword\">in</span> originalWindow;</span><br><span class=\"line\">      },</span><br><span class=\"line\">    });</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">sandbox</span> = sandbox;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"title function_\">clear</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// remove event listeners</span></span><br><span class=\"line\">    <span class=\"title class_\">Object</span>.<span class=\"title function_\">keys</span>(<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">eventListeners</span>).<span class=\"title function_\">forEach</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">eventName</span>) =&gt;</span> {</span><br><span class=\"line\">      (<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">eventListeners</span>[eventName] || []).<span class=\"title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">listener</span> =&gt;</span> {</span><br><span class=\"line\">        <span class=\"variable language_\">window</span>.<span class=\"title function_\">removeEventListener</span>(eventName, listener);</span><br><span class=\"line\">      });</span><br><span class=\"line\">    });</span><br><span class=\"line\">    <span class=\"hljs-comment\">// clear timeout</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">timeoutIds</span>.<span class=\"title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">id</span> =&gt;</span> <span class=\"variable language_\">window</span>.<span class=\"hljs-built_in\">clearTimeout</span>(id));</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">intervalIds</span>.<span class=\"title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">id</span> =&gt;</span> <span class=\"variable language_\">window</span>.<span class=\"hljs-built_in\">clearInterval</span>(id));</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">createMicroApp</span>(<span class=\"hljs-params\">app: string | AppConfig, appLifecyle?: AppLifecylceOptions</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> appConfig = <span class=\"title function_\">getAppConfigForLoad</span>(app, appLifecyle);</span><br><span class=\"line\">  lifeCycle = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">loadAppModule</span>(appConfig);</span><br><span class=\"line\">  <span class=\"hljs-comment\">// mount</span></span><br><span class=\"line\">  <span class=\"title function_\">mountMicroApp</span>(appConfig.<span class=\"hljs-property\">name</span>);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p> icestark  JS  with + new Function  Proxy  window </p>\n</body></html>","_categories":[],"_tags":[],"excerpt":"<html><head></head><body><h2 id=\"-icestark\"><a href=\"#-icestark\" class=\"headerlink\" title=\" icestark\"></a> icestark</h2><blockquote>\n<p>icestark </p>\n</blockquote>\n<p><a href=\"https://github.com/ice-lab/icestark\"></a></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"/images/icestark-sandbox/icestark.png\" alt=\"\"></p></body></html>","more":"<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//    handleStateChange</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> hijackHistory = (): <span class=\"function\"><span class=\"params\">void</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">window</span>.<span class=\"property\">history</span>.<span class=\"property\">pushState</span> = <span class=\"function\">(<span class=\"params\">state: any, title: string, url?: string, ...rest</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    originalPush.<span class=\"title function_\">apply</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">history</span>, [state, title, url, ...rest]);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> eventName = <span class=\"string\">&#x27;pushState&#x27;</span>;</span><br><span class=\"line\">    <span class=\"title function_\">handleStateChange</span>(<span class=\"title function_\">createPopStateEvent</span>(state, eventName), url, eventName);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">window</span>.<span class=\"property\">history</span>.<span class=\"property\">replaceState</span> = <span class=\"function\">(<span class=\"params\">state: any, title: string, url?: string, ...rest</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    originalReplace.<span class=\"title function_\">apply</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">history</span>, [state, title, url, ...rest]);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> eventName = <span class=\"string\">&#x27;replaceState&#x27;</span>;</span><br><span class=\"line\">    <span class=\"title function_\">handleStateChange</span>(<span class=\"title function_\">createPopStateEvent</span>(state, eventName), url, eventName);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">window</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;popstate&#x27;</span>, urlChange, <span class=\"literal\">false</span>);</span><br><span class=\"line\">  <span class=\"variable language_\">window</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;hashchange&#x27;</span>, urlChange, <span class=\"literal\">false</span>);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">handleStateChange</span> = (<span class=\"params\">event: PopStateEvent, url: string, method: RouteType</span>) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"title function_\">setHistoryEvent</span>(event);</span><br><span class=\"line\">  <span class=\"comment\">// globalConfiguration.reroute(url, method);</span></span><br><span class=\"line\">  <span class=\"title function_\">reroute</span>(url, method);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">reroute</span> (<span class=\"attr\">url</span>: string, <span class=\"attr\">type</span>: <span class=\"title class_\">RouteType</span> | <span class=\"string\">&#x27;init&#x27;</span> | <span class=\"string\">&#x27;popstate&#x27;</span>| <span class=\"string\">&#x27;hashchange&#x27;</span> ) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> &#123; pathname, query, hash &#125; = <span class=\"title function_\">urlParse</span>(url, <span class=\"literal\">true</span>);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> unmountApps = [];</span><br><span class=\"line\">  <span class=\"keyword\">const</span> activeApps = [];</span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"title function_\">getMicroApps</span>().<span class=\"title function_\">forEach</span>(<span class=\"function\">(<span class=\"params\">microApp: AppConfig</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> shouldBeActive = microApp.<span class=\"title function_\">checkActive</span>(url);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (shouldBeActive) &#123;</span><br><span class=\"line\">      activeApps.<span class=\"title function_\">push</span>(microApp);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      unmountApps.<span class=\"title function_\">push</span>(microApp);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  <span class=\"title class_\">Promise</span>.<span class=\"title function_\">all</span>(</span><br><span class=\"line\">    unmountApps.<span class=\"title function_\">map</span>(<span class=\"keyword\">async</span> (unmountApp) =&gt; &#123;</span><br><span class=\"line\">      <span class=\"comment\">// mounted</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (unmountApp.<span class=\"property\">status</span> === <span class=\"variable constant_\">MOUNTED</span> || unmountApp.<span class=\"property\">status</span> === <span class=\"variable constant_\">LOADING_ASSETS</span>) &#123;</span><br><span class=\"line\">        globalConfiguration.<span class=\"title function_\">onAppLeave</span>(unmountApp);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">await</span> <span class=\"title function_\">unmountMicroApp</span>(unmountApp.<span class=\"property\">name</span>);</span><br><span class=\"line\">    &#125;).<span class=\"title function_\">concat</span>(activeApps.<span class=\"title function_\">map</span>(<span class=\"keyword\">async</span> (activeApp) =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (activeApp.<span class=\"property\">status</span> !== <span class=\"variable constant_\">MOUNTED</span>) &#123;</span><br><span class=\"line\">        globalConfiguration.<span class=\"title function_\">onAppEnter</span>(activeApp);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">await</span> <span class=\"title function_\">createMicroApp</span>(activeApp);</span><br><span class=\"line\">    &#125;))</span><br><span class=\"line\">  )</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">loadAppModule</span>(<span class=\"params\">appConfig: AppConfig</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> appSandbox = <span class=\"title function_\">createSandbox</span>(appConfig.<span class=\"property\">sandbox</span>);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> &#123; url, container, entry, entryContent, name &#125; = appConfig;</span><br><span class=\"line\">  <span class=\"comment\">// JSCSS URL HTML</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> appAssets = url ? <span class=\"title function_\">getUrlAssets</span>(url) : <span class=\"keyword\">await</span> <span class=\"title function_\">getEntryAssets</span>(&#123; ... &#125;);</span><br><span class=\"line\">  <span class=\"comment\">//  JSCSS</span></span><br><span class=\"line\">  <span class=\"keyword\">await</span> <span class=\"title function_\">appendAssets</span>(appAssets, appSandbox);</span><br><span class=\"line\">  lifecycle = &#123;</span><br><span class=\"line\">    <span class=\"attr\">mount</span>: <span class=\"title function_\">getCache</span>(<span class=\"title class_\">AppLifeCycleEnum</span>.<span class=\"property\">AppEnter</span>),</span><br><span class=\"line\">    <span class=\"attr\">unmount</span>: <span class=\"title function_\">getCache</span>(<span class=\"title class_\">AppLifeCycleEnum</span>.<span class=\"property\">AppLeave</span>),</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"title function_\">combineLifecyle</span>(lifecycle, appConfig); <span class=\"comment\">// </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">appendAssets</span>(<span class=\"params\">assets: Assets, sandbox?: Sandbox</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// CSS  link  CSS Modules</span></span><br><span class=\"line\">  <span class=\"keyword\">await</span> <span class=\"title function_\">loadAndAppendCssAssets</span>(assets);</span><br><span class=\"line\">  <span class=\"comment\">// JS </span></span><br><span class=\"line\">  <span class=\"keyword\">await</span> <span class=\"title function_\">loadAndAppendJsAssets</span>(assets, sandbox);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">loadAndAppendJsAssets</span>(<span class=\"params\">assets: Assets, sandbox?: Sandbox</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">//  JS URL</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> jsContents = <span class=\"keyword\">await</span> <span class=\"title function_\">fetchScripts</span>(jsList);</span><br><span class=\"line\">  <span class=\"comment\">// excute code by order</span></span><br><span class=\"line\">  jsContents.<span class=\"title function_\">forEach</span>(<span class=\"function\"><span class=\"params\">script</span> =&gt;</span> &#123;</span><br><span class=\"line\">    sandbox.<span class=\"title function_\">execScriptInSandbox</span>(script);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Sandbox</span> &#123;</span><br><span class=\"line\">  private eventListeners = &#123;&#125;;</span><br><span class=\"line\">  private <span class=\"attr\">timeoutIds</span>: number[] = [];</span><br><span class=\"line\">  private <span class=\"attr\">intervalIds</span>: number[] = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">props: SandboxProps = &#123;&#125;</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">sandbox</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">execScriptInSandbox</span>(<span class=\"attr\">script</span>: string): <span class=\"keyword\">void</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">createProxySandbox</span>();</span><br><span class=\"line\">    <span class=\"comment\">// with + Function </span></span><br><span class=\"line\">    <span class=\"comment\">//  sandbox </span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> execScript = <span class=\"string\">`with (sandbox) &#123;;<span class=\"subst\">$&#123;script&#125;</span>\\n&#125;`</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> code = <span class=\"keyword\">new</span> <span class=\"title class_\">Function</span>(<span class=\"string\">&#x27;sandbox&#x27;</span>, execScript).<span class=\"title function_\">bind</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">sandbox</span>);</span><br><span class=\"line\">    <span class=\"comment\">// run code with sandbox</span></span><br><span class=\"line\">    <span class=\"comment\">// sandbox  window</span></span><br><span class=\"line\">    <span class=\"title function_\">code</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">sandbox</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">createProxySandbox</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> proxyWindow = <span class=\"title class_\">Object</span>.<span class=\"title function_\">create</span>(<span class=\"literal\">null</span>) <span class=\"keyword\">as</span> <span class=\"title class_\">Window</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> originalWindow = <span class=\"variable language_\">window</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> originalAddEventListener = <span class=\"variable language_\">window</span>.<span class=\"property\">addEventListener</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> originalRemoveEventListener = <span class=\"variable language_\">window</span>.<span class=\"property\">removeEventListener</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> originalSetInerval = <span class=\"variable language_\">window</span>.<span class=\"property\">setInterval</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> originalSetTimeout = <span class=\"variable language_\">window</span>.<span class=\"property\">setTimeout</span>;</span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    proxyWindow.<span class=\"property\">addEventListener</span> = <span class=\"function\">(<span class=\"params\">eventName, fn, ...rest</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> listeners = <span class=\"variable language_\">this</span>.<span class=\"property\">eventListeners</span>[eventName] || [];</span><br><span class=\"line\">      listeners.<span class=\"title function_\">push</span>(fn);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> originalAddEventListener.<span class=\"title function_\">apply</span>(originalWindow, [eventName, fn, ...rest]);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    proxyWindow.<span class=\"property\">removeEventListener</span> = <span class=\"function\">(<span class=\"params\">eventName, fn, ...rest</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> listeners = <span class=\"variable language_\">this</span>.<span class=\"property\">eventListeners</span>[eventName] || [];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (listeners.<span class=\"title function_\">includes</span>(fn)) &#123;</span><br><span class=\"line\">        listeners.<span class=\"title function_\">splice</span>(listeners.<span class=\"title function_\">indexOf</span>(fn), <span class=\"number\">1</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> originalRemoveEventListener.<span class=\"title function_\">apply</span>(originalWindow, [eventName, fn, ...rest]);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    proxyWindow.<span class=\"property\">setTimeout</span> = <span class=\"function\">(<span class=\"params\">...args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> timerId = <span class=\"title function_\">originalSetTimeout</span>(...args);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">timeoutIds</span>.<span class=\"title function_\">push</span>(timerId);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> timerId;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"comment\">// hijack setInterval</span></span><br><span class=\"line\">    proxyWindow.<span class=\"property\">setInterval</span> = <span class=\"function\">(<span class=\"params\">...args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> intervalId = <span class=\"title function_\">originalSetInerval</span>(...args);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">intervalIds</span>.<span class=\"title function_\">push</span>(intervalId);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> intervalId;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> sandbox = <span class=\"keyword\">new</span> <span class=\"title class_\">Proxy</span>(proxyWindow, &#123;</span><br><span class=\"line\">      <span class=\"title function_\">set</span>(<span class=\"attr\">target</span>: <span class=\"title class_\">Window</span>, <span class=\"attr\">p</span>: <span class=\"title class_\">PropertyKey</span>, <span class=\"attr\">value</span>: any): boolean &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"title function_\">get</span>(<span class=\"attr\">target</span>: <span class=\"title class_\">Window</span>, <span class=\"attr\">p</span>: <span class=\"title class_\">PropertyKey</span>): any &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"title function_\">has</span>(<span class=\"attr\">target</span>: <span class=\"title class_\">Window</span>, <span class=\"attr\">p</span>: <span class=\"title class_\">PropertyKey</span>): boolean &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> p <span class=\"keyword\">in</span> target || p <span class=\"keyword\">in</span> originalWindow;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">sandbox</span> = sandbox;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"title function_\">clear</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// remove event listeners</span></span><br><span class=\"line\">    <span class=\"title class_\">Object</span>.<span class=\"title function_\">keys</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">eventListeners</span>).<span class=\"title function_\">forEach</span>(<span class=\"function\">(<span class=\"params\">eventName</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      (<span class=\"variable language_\">this</span>.<span class=\"property\">eventListeners</span>[eventName] || []).<span class=\"title function_\">forEach</span>(<span class=\"function\"><span class=\"params\">listener</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">window</span>.<span class=\"title function_\">removeEventListener</span>(eventName, listener);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"comment\">// clear timeout</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">timeoutIds</span>.<span class=\"title function_\">forEach</span>(<span class=\"function\"><span class=\"params\">id</span> =&gt;</span> <span class=\"variable language_\">window</span>.<span class=\"built_in\">clearTimeout</span>(id));</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">intervalIds</span>.<span class=\"title function_\">forEach</span>(<span class=\"function\"><span class=\"params\">id</span> =&gt;</span> <span class=\"variable language_\">window</span>.<span class=\"built_in\">clearInterval</span>(id));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">createMicroApp</span>(<span class=\"params\">app: string | AppConfig, appLifecyle?: AppLifecylceOptions</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> appConfig = <span class=\"title function_\">getAppConfigForLoad</span>(app, appLifecyle);</span><br><span class=\"line\">  lifeCycle = <span class=\"keyword\">await</span> <span class=\"title function_\">loadAppModule</span>(appConfig);</span><br><span class=\"line\">  <span class=\"comment\">// mount</span></span><br><span class=\"line\">  <span class=\"title function_\">mountMicroApp</span>(appConfig.<span class=\"property\">name</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> icestark  JS  with + new Function  Proxy  window </p>"},{"title":"","date":"2018-10-23T02:29:29.089Z","_content":"\n#### \n\n\n\n#### \n\n1. window.onerror js Promiseasync/await \n\n2.Promise **catch**\n\n3.async/await  **try - catch**\n\n4.Vue  Vue.config.errorHandler  Promiseasync/await  Vue  window.onerror\n\n<!-- more -->\n\n####  chrome & https://jsbin.com\n\n##### [window.onerror](https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror)\n\n```javascript\nwindow.onerror = function (message, source, lineno, colno, error) {\n  /*\n    messageHTML onerror=\"\"event\n    sourceURL\n    lineno\n    colno\n    errorError\n    */\n};\n```\n\n```javascript\nwindow.onerror = function () {\n  console.log(arguments);\n};\n\nlet data;\nlet info = data.info;\n\n/* console \n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 6,\n  3: 17,\n  4: [object Error] { ... }\n}\n*/\n```\n\n**onerror** Promise  Promise  setTimeout  js \n\n```javascript\nwindow.onerror = function () {\n  console.log(arguments);\n};\n\nfunction timer() {\n  setTimeout(function () {\n    let data;\n    let info = data.info;\n  }, 100);\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    timer();\n  }).catch(function (error) {\n    console.log(error);\n    console.log(\"inner error\");\n  });\n}\n\np()\n  .then(function () {\n    console.log(\"running then\");\n  })\n  .catch(function (error) {\n    console.log(error);\n    console.log(\"outer error\");\n  });\n\n/* console \n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 8,\n  3: 22,\n  4: [object Error] { ... }\n}\n*/\n```\n\n##### [Promise catch](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)\n\n##### Q catch  Promise \n\n```javascript\nwindow.onerror = function () {\n  console.log(arguments);\n  console.log(\"onerror\");\n};\n\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn();\n  });\n}\ntry {\n  p().then(function (res) {\n    console.log(\"running then\");\n  });\n} catch (e) {\n  console.log(e);\n  console.log(\"try - catch\");\n}\n\n/* console \n */\n```\n\nPromise **try - catch****onerror**\n\n```javascript\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn();\n  }).catch(function (error) {\n    console.log(error);\n    console.log(\"inner error\");\n    return \"return inner error\";\n  });\n}\ntry {\n  p()\n    .then(function (res) {\n      console.log(res);\n      console.log(\"running then\");\n    })\n    .catch(function (error) {\n      console.log(error);\n      console.log(\"outer error\");\n    });\n} catch (e) {\n  console.log(e);\n  console.log(\"try - catch\");\n}\n\n/* console \n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n\"running then\"\n*/\n```\n\n then  Promise **catch**\n\n##### [async/await](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function)  **try - catch**\n\n```javascript\nwindow.onerror = function () {\n  console.log(arguments);\n};\n\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn();\n  });\n}\n(async function () {\n  let res = await p();\n  console.log(res);\n})();\n\n/* console \n */\n```\n\nPromise **onerror**\n\n```javascript\nwindow.onerror = function () {\n  console.log(arguments);\n};\n\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    resolve(\"resolve\");\n  });\n}\n(async function () {\n  let res = await p();\n  console.log(\"get res\");\n  errorFn();\n})();\n\n/* console \nget res\n*/\n```\n\n Promise **onerror**\n\n```javascript\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn();\n  });\n}\n(async function () {\n  try {\n    let res = await p();\n    console.log(res);\n  } catch (e) {\n    console.log(e);\n    console.log(\"try - catch\");\n  }\n})();\n\n/* console \n[object Error] { ... }\n\"try - catch\"\n*/\n```\n\n**try - catch**\n\n```javascript\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn();\n  }).catch(function (error) {\n    console.log(error);\n    console.log(\"inner error\");\n    return \"return inner error\";\n  });\n}\n(async function () {\n  try {\n    let res = await p();\n    console.log(res);\n  } catch (e) {\n    console.log(e);\n    console.log(\"try - catch\");\n  }\n})();\n\n/* console \n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n*/\n```\n\n Promise  catch  async/await  **try - catch**\n\n##### [Vue.config.errorHandler](https://cn.vuejs.org/v2/api/index.html#errorHandler)\n\n```javascript\nVue.config.errorHandler = function (err, vm, info) {\n  // handle error\n  // `info`  Vue \n  //  2.2.0+ \n};\n```\n\n>  Vue \n\n errorHandler  vue-cli  vue \n\nhttps://github.com/miser/vue-capture-error\n\n main.js\n\n```javascript\nVue.config.errorHandler = function (err, vm, info) {\n  console.log(arguments);\n  console.log(\"vue errorHandler\");\n};\n```\n\n App.vue\n\n```javascript\n{\n  // ...\n  created () {\n    this.normal()\n  },\n  methods: {\n    normal () {\n      let data\n      let info = data.info\n    }\n  }\n  // ...\n}\n\n/*  console \n0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal \n1: VueComponent {_uid: 1, _isVue: true, $options: {}, _renderProxy: Proxy, _self: VueComponent, }\n2: \"created hook\n*/\n```\n\nerrorHandler  errorHandler  window.onerror  Promse  async/await \n\njs  [axios](https://github.com/axios/axios)  ajax  Promise \n\nmain.js \n\n```javascript\nconst request = axios.create();\nrequest.interceptors.response.use((response) => {\n  return response;\n});\n\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args)\n      .then((res) => {\n        resolve(res);\n      })\n      .catch((err) => {\n        reject(err);\n      });\n  });\n};\n```\n\n App.vue\n\n```javascript\n{\n  // ...\n  created () {\n    this.fetch1()\n  },\n  methods: {\n    fetch1 () {\n        Vue.request('https://api1.github.com/')\n\t      .then(response => {\n            console.log(response)\n          })\n    }\n  }\n  // ...\n}\n```\n\napi.github.com  github  api  api1.github.com  errorHandler  Vue.request  catch  Promise.then \n\n App.vue\n\n```javascript\n{\n  // ...\n  created () {\n    this.fetch2()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n      .then(response => {\n        let data = response.data\n        let info = data.api.info\n      })\n    }\n  }\n  // ...\n}\n```\n\nerrorHandler  vue  issue  Promise  async/await :\n\n> https://github.com/vuejs/vue/issues/6551\n>\n> Vue cannot capture errors that are thrown asynchronously, similar to how try... catch won't catch async errors. It's your responsibility to handle async errors properly, e.g. using Promise.catch  @yyx990803\n\n Promise.catch \n\n> https://github.com/vuejs/vue/issues/7653\n>\n> @Doeke  mixin Promise  Promise Promise  catch  Promise \n\nmain.js @Doeke \n\n```javascript\nVue.mixin({\n  beforeCreate: function () {\n    const methods = this.$options.methods || {};\n    Object.entries(methods).forEach(([key, method]) => {\n      if (method._asyncWrapped) return;\n      const wrappedMethod = function (...args) {\n        const result = method.apply(this, args);\n        const resultIsPromise = result && typeof result.then === \"function\";\n        if (!resultIsPromise) return result;\n\n        return new Promise(async (resolve, reject) => {\n          try {\n            resolve(await result);\n          } catch (error) {\n            if (!error._handled) {\n              const errorHandler = Vue.config.errorHandler;\n              errorHandler(error);\n              error._handled = true;\n            }\n            reject(error);\n          }\n        });\n      };\n      wrappedMethod._asyncWrapped = true;\n      methods[key] = wrappedMethod;\n    });\n  },\n});\n```\n\n App.vue\n\n```javascript\n{\n  // ...\n  created () {\n    this.fetch2()\n    this.fetch3()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch2\n        })\n    },\n    fetch3 () {\n      return Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch3\n        })\n    }\n  }\n  // ...\n}\n```\n\n console fetch3  errorHandler  fetch2 \n\n Promise  async/await \n\n App.vue\n\n```javascript\n{\n  // ...\n  created () {\n    this.fetch4()\n    this.fetch5()\n  },\n  methods: {\n    async fetch4 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch4\n    },\n    async fetch5 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch5\n      return response\n    }\n  }\n  // ...\n}\n```\n\nfetch4  Promisefetch5  Promise  fetch4  fetch5  async/await  Promise  [babeljs](https://babeljs.io)  Try it out\"  async/await Promise\n\n#### \n\n**** axios.create \n\n**** Promise  errorHandler Promise  mixin  Promise  catch  errorHandler **_!_**\n\n#### \n\n**#  **\n\n\n\n**#  [Sentry](https://sentry.io/) **\n\n JS SDK\n\n```\nnpm install raven-js --save\n```\n\n main.js\n\n```javascript\n// ...\nimport Raven from \"raven-js\";\nimport RavenVue from \"raven-js/plugins/vue\";\n\nRaven.config(\"https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044\") // sentry token\n  .addPlugin(RavenVue, Vue)\n  .install();\n\nVue.config.errorHandler = function (err, vm, info) {\n  Raven.captureException(err);\n};\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args)\n      .then((res) => {\n        resolve(res);\n      })\n      .catch((err) => {\n        Raven.captureException(err);\n        reject(err);\n      });\n  });\n};\n// ...\n```\n\n App.vue  js \n\n```javascript\n// ...\ncreated () {\n    this.normal()\n    // this.fetch1()\n    // this.fetch2()\n    // this.fetch3()\n    // this.fetch4()\n    // this.fetch5()\n}\n// ...\n```\n\n sentry \n![](/images/js-capture-error/1.png)\n![IP](/images/js-capture-error/2.jpg)\n 2 sentry  issue \n\n fetch1  ajax \n![api1.github.com](/images/js-capture-error/3.jpg)\n\n fetch2  Promise  Promise  async/await  Promise.then  2 \n\n![Promise.then](/images/js-capture-error/4.jpg)\n![async/await](/images/js-capture-error/5.jpg)\n\n\n\n```javascript\nRaven.setUser({\n  name: \"miser name\",\n  id: \"miser id\",\n});\n```\n\n![](/images/js-capture-error/6.jpg)\n\n****\n\n![npm run build ](/images/js-capture-error/7.jpg)\n\n sentry [SourceMaps](https://github.com/google/closure-compiler/wiki/Source-Maps) debug \n\n[webpack-sentry-plugin](https://www.npmjs.com/package/webpack-sentry-plugin) webpack  vue.config.js \n\n```javascript\nconst SentryPlugin = require(\"webpack-sentry-plugin\");\n\nmodule.exports = {\n  configureWebpack: {\n    plugins: [\n      new SentryPlugin({\n        organization: \"fe-org\", //  \n        project: \"popcorn-vue\", //  \n        apiKey:\n          \"17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150\",\n        release: \"1.2.4-beta\", // sourcemaps\n      }),\n    ],\n  },\n};\n```\n\n main.js\n\n```javascript\nRaven.config(\"https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044\", {\n  release: \"1.2.4-beta\", // \n})\n  .addPlugin(RavenVue, Vue)\n  .install();\n```\n\n```\nnpm run build\n```\n\n sentry  popcorn-vue ****\n\n![1.2.4-beta1.2.3-beta](/images/js-capture-error/8.jpg)\n![ 1.2.4-beta jsjs.map](/images/js-capture-error/9.jpg)\n\n build  index.html SourceMaps  js  js.map \n\n issue https://github.com/getsentry/sentry-electron/issues/54  2 \n\n--  js.map  js \n-- js  js.map \n\n 2 \n\n index.htmlfile:///**\\*\\***/vue-capture-error/dist/index.html nginx \n\n```\nbrew install nginx\nnginx\n```\n\n build  dist  nginx  /usr/local/var/www/ http://localhost:8080\n\n sentry \n\n![](/images/js-capture-error/10.jpg)\n","source":"_posts/js-capture-error.md","raw":"---\ntitle: \ncategory: JavaScript\ndate: 2018-10-23T10:29:29.089Z\n---\n\n#### \n\n\n\n#### \n\n1. window.onerror js Promiseasync/await \n\n2.Promise **catch**\n\n3.async/await  **try - catch**\n\n4.Vue  Vue.config.errorHandler  Promiseasync/await  Vue  window.onerror\n\n<!-- more -->\n\n####  chrome & https://jsbin.com\n\n##### [window.onerror](https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror)\n\n```javascript\nwindow.onerror = function (message, source, lineno, colno, error) {\n  /*\n    messageHTML onerror=\"\"event\n    sourceURL\n    lineno\n    colno\n    errorError\n    */\n};\n```\n\n```javascript\nwindow.onerror = function () {\n  console.log(arguments);\n};\n\nlet data;\nlet info = data.info;\n\n/* console \n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 6,\n  3: 17,\n  4: [object Error] { ... }\n}\n*/\n```\n\n**onerror** Promise  Promise  setTimeout  js \n\n```javascript\nwindow.onerror = function () {\n  console.log(arguments);\n};\n\nfunction timer() {\n  setTimeout(function () {\n    let data;\n    let info = data.info;\n  }, 100);\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    timer();\n  }).catch(function (error) {\n    console.log(error);\n    console.log(\"inner error\");\n  });\n}\n\np()\n  .then(function () {\n    console.log(\"running then\");\n  })\n  .catch(function (error) {\n    console.log(error);\n    console.log(\"outer error\");\n  });\n\n/* console \n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 8,\n  3: 22,\n  4: [object Error] { ... }\n}\n*/\n```\n\n##### [Promise catch](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)\n\n##### Q catch  Promise \n\n```javascript\nwindow.onerror = function () {\n  console.log(arguments);\n  console.log(\"onerror\");\n};\n\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn();\n  });\n}\ntry {\n  p().then(function (res) {\n    console.log(\"running then\");\n  });\n} catch (e) {\n  console.log(e);\n  console.log(\"try - catch\");\n}\n\n/* console \n */\n```\n\nPromise **try - catch****onerror**\n\n```javascript\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn();\n  }).catch(function (error) {\n    console.log(error);\n    console.log(\"inner error\");\n    return \"return inner error\";\n  });\n}\ntry {\n  p()\n    .then(function (res) {\n      console.log(res);\n      console.log(\"running then\");\n    })\n    .catch(function (error) {\n      console.log(error);\n      console.log(\"outer error\");\n    });\n} catch (e) {\n  console.log(e);\n  console.log(\"try - catch\");\n}\n\n/* console \n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n\"running then\"\n*/\n```\n\n then  Promise **catch**\n\n##### [async/await](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function)  **try - catch**\n\n```javascript\nwindow.onerror = function () {\n  console.log(arguments);\n};\n\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn();\n  });\n}\n(async function () {\n  let res = await p();\n  console.log(res);\n})();\n\n/* console \n */\n```\n\nPromise **onerror**\n\n```javascript\nwindow.onerror = function () {\n  console.log(arguments);\n};\n\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    resolve(\"resolve\");\n  });\n}\n(async function () {\n  let res = await p();\n  console.log(\"get res\");\n  errorFn();\n})();\n\n/* console \nget res\n*/\n```\n\n Promise **onerror**\n\n```javascript\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn();\n  });\n}\n(async function () {\n  try {\n    let res = await p();\n    console.log(res);\n  } catch (e) {\n    console.log(e);\n    console.log(\"try - catch\");\n  }\n})();\n\n/* console \n[object Error] { ... }\n\"try - catch\"\n*/\n```\n\n**try - catch**\n\n```javascript\nfunction errorFn() {\n  let data;\n  let info = data.info;\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn();\n  }).catch(function (error) {\n    console.log(error);\n    console.log(\"inner error\");\n    return \"return inner error\";\n  });\n}\n(async function () {\n  try {\n    let res = await p();\n    console.log(res);\n  } catch (e) {\n    console.log(e);\n    console.log(\"try - catch\");\n  }\n})();\n\n/* console \n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n*/\n```\n\n Promise  catch  async/await  **try - catch**\n\n##### [Vue.config.errorHandler](https://cn.vuejs.org/v2/api/index.html#errorHandler)\n\n```javascript\nVue.config.errorHandler = function (err, vm, info) {\n  // handle error\n  // `info`  Vue \n  //  2.2.0+ \n};\n```\n\n>  Vue \n\n errorHandler  vue-cli  vue \n\nhttps://github.com/miser/vue-capture-error\n\n main.js\n\n```javascript\nVue.config.errorHandler = function (err, vm, info) {\n  console.log(arguments);\n  console.log(\"vue errorHandler\");\n};\n```\n\n App.vue\n\n```javascript\n{\n  // ...\n  created () {\n    this.normal()\n  },\n  methods: {\n    normal () {\n      let data\n      let info = data.info\n    }\n  }\n  // ...\n}\n\n/*  console \n0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal \n1: VueComponent {_uid: 1, _isVue: true, $options: {}, _renderProxy: Proxy, _self: VueComponent, }\n2: \"created hook\n*/\n```\n\nerrorHandler  errorHandler  window.onerror  Promse  async/await \n\njs  [axios](https://github.com/axios/axios)  ajax  Promise \n\nmain.js \n\n```javascript\nconst request = axios.create();\nrequest.interceptors.response.use((response) => {\n  return response;\n});\n\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args)\n      .then((res) => {\n        resolve(res);\n      })\n      .catch((err) => {\n        reject(err);\n      });\n  });\n};\n```\n\n App.vue\n\n```javascript\n{\n  // ...\n  created () {\n    this.fetch1()\n  },\n  methods: {\n    fetch1 () {\n        Vue.request('https://api1.github.com/')\n\t      .then(response => {\n            console.log(response)\n          })\n    }\n  }\n  // ...\n}\n```\n\napi.github.com  github  api  api1.github.com  errorHandler  Vue.request  catch  Promise.then \n\n App.vue\n\n```javascript\n{\n  // ...\n  created () {\n    this.fetch2()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n      .then(response => {\n        let data = response.data\n        let info = data.api.info\n      })\n    }\n  }\n  // ...\n}\n```\n\nerrorHandler  vue  issue  Promise  async/await :\n\n> https://github.com/vuejs/vue/issues/6551\n>\n> Vue cannot capture errors that are thrown asynchronously, similar to how try... catch won't catch async errors. It's your responsibility to handle async errors properly, e.g. using Promise.catch  @yyx990803\n\n Promise.catch \n\n> https://github.com/vuejs/vue/issues/7653\n>\n> @Doeke  mixin Promise  Promise Promise  catch  Promise \n\nmain.js @Doeke \n\n```javascript\nVue.mixin({\n  beforeCreate: function () {\n    const methods = this.$options.methods || {};\n    Object.entries(methods).forEach(([key, method]) => {\n      if (method._asyncWrapped) return;\n      const wrappedMethod = function (...args) {\n        const result = method.apply(this, args);\n        const resultIsPromise = result && typeof result.then === \"function\";\n        if (!resultIsPromise) return result;\n\n        return new Promise(async (resolve, reject) => {\n          try {\n            resolve(await result);\n          } catch (error) {\n            if (!error._handled) {\n              const errorHandler = Vue.config.errorHandler;\n              errorHandler(error);\n              error._handled = true;\n            }\n            reject(error);\n          }\n        });\n      };\n      wrappedMethod._asyncWrapped = true;\n      methods[key] = wrappedMethod;\n    });\n  },\n});\n```\n\n App.vue\n\n```javascript\n{\n  // ...\n  created () {\n    this.fetch2()\n    this.fetch3()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch2\n        })\n    },\n    fetch3 () {\n      return Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch3\n        })\n    }\n  }\n  // ...\n}\n```\n\n console fetch3  errorHandler  fetch2 \n\n Promise  async/await \n\n App.vue\n\n```javascript\n{\n  // ...\n  created () {\n    this.fetch4()\n    this.fetch5()\n  },\n  methods: {\n    async fetch4 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch4\n    },\n    async fetch5 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch5\n      return response\n    }\n  }\n  // ...\n}\n```\n\nfetch4  Promisefetch5  Promise  fetch4  fetch5  async/await  Promise  [babeljs](https://babeljs.io)  Try it out\"  async/await Promise\n\n#### \n\n**** axios.create \n\n**** Promise  errorHandler Promise  mixin  Promise  catch  errorHandler **_!_**\n\n#### \n\n**#  **\n\n\n\n**#  [Sentry](https://sentry.io/) **\n\n JS SDK\n\n```\nnpm install raven-js --save\n```\n\n main.js\n\n```javascript\n// ...\nimport Raven from \"raven-js\";\nimport RavenVue from \"raven-js/plugins/vue\";\n\nRaven.config(\"https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044\") // sentry token\n  .addPlugin(RavenVue, Vue)\n  .install();\n\nVue.config.errorHandler = function (err, vm, info) {\n  Raven.captureException(err);\n};\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args)\n      .then((res) => {\n        resolve(res);\n      })\n      .catch((err) => {\n        Raven.captureException(err);\n        reject(err);\n      });\n  });\n};\n// ...\n```\n\n App.vue  js \n\n```javascript\n// ...\ncreated () {\n    this.normal()\n    // this.fetch1()\n    // this.fetch2()\n    // this.fetch3()\n    // this.fetch4()\n    // this.fetch5()\n}\n// ...\n```\n\n sentry \n![](/images/js-capture-error/1.png)\n![IP](/images/js-capture-error/2.jpg)\n 2 sentry  issue \n\n fetch1  ajax \n![api1.github.com](/images/js-capture-error/3.jpg)\n\n fetch2  Promise  Promise  async/await  Promise.then  2 \n\n![Promise.then](/images/js-capture-error/4.jpg)\n![async/await](/images/js-capture-error/5.jpg)\n\n\n\n```javascript\nRaven.setUser({\n  name: \"miser name\",\n  id: \"miser id\",\n});\n```\n\n![](/images/js-capture-error/6.jpg)\n\n****\n\n![npm run build ](/images/js-capture-error/7.jpg)\n\n sentry [SourceMaps](https://github.com/google/closure-compiler/wiki/Source-Maps) debug \n\n[webpack-sentry-plugin](https://www.npmjs.com/package/webpack-sentry-plugin) webpack  vue.config.js \n\n```javascript\nconst SentryPlugin = require(\"webpack-sentry-plugin\");\n\nmodule.exports = {\n  configureWebpack: {\n    plugins: [\n      new SentryPlugin({\n        organization: \"fe-org\", //  \n        project: \"popcorn-vue\", //  \n        apiKey:\n          \"17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150\",\n        release: \"1.2.4-beta\", // sourcemaps\n      }),\n    ],\n  },\n};\n```\n\n main.js\n\n```javascript\nRaven.config(\"https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044\", {\n  release: \"1.2.4-beta\", // \n})\n  .addPlugin(RavenVue, Vue)\n  .install();\n```\n\n```\nnpm run build\n```\n\n sentry  popcorn-vue ****\n\n![1.2.4-beta1.2.3-beta](/images/js-capture-error/8.jpg)\n![ 1.2.4-beta jsjs.map](/images/js-capture-error/9.jpg)\n\n build  index.html SourceMaps  js  js.map \n\n issue https://github.com/getsentry/sentry-electron/issues/54  2 \n\n--  js.map  js \n-- js  js.map \n\n 2 \n\n index.htmlfile:///**\\*\\***/vue-capture-error/dist/index.html nginx \n\n```\nbrew install nginx\nnginx\n```\n\n build  dist  nginx  /usr/local/var/www/ http://localhost:8080\n\n sentry \n\n![](/images/js-capture-error/10.jpg)\n","slug":"js-capture-error","published":1,"updated":"2024-04-08T13:34:03.156Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wdz000g18fd6fsr6pkq","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>1. window.onerror js Promiseasync/await </p>\n<p>2.Promise <strong>catch</strong></p>\n<p>3.async/await  <strong>try - catch</strong></p>\n<p>4.Vue  Vue.config.errorHandler  Promiseasync/await  Vue  window.onerror</p>\n<span id=\"more\"></span>\n\n<h4 id=\"-chrome-https-jsbin-com\"><a href=\"#-chrome-https-jsbin-com\" class=\"headerlink\" title=\" chrome &amp; https://jsbin.com\"></a> chrome &amp; <a href=\"https://jsbin.com)/\">https://jsbin.com</a></h4><h5 id=\"window-onerror\"><a href=\"#window-onerror\" class=\"headerlink\" title=\"window.onerror\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror\">window.onerror</a></h5><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"hljs-property\">onerror</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">message, source, lineno, colno, error</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">/*</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    messageHTML onerror=\"\"event</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    sourceURL</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    lineno</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    colno</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    errorError</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    */</span></span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"hljs-property\">onerror</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> data;</span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">info</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Arguments] {</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  2: 6,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  3: 17,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  4: [object Error] { ... }</span></span><br><span class=\"line\"><span class=\"hljs-comment\">}</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>onerror</strong> Promise  Promise  setTimeout  js </p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"hljs-property\">onerror</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">timer</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> data;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">info</span>;</span><br><span class=\"line\">  }, <span class=\"hljs-number\">100</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) {</span><br><span class=\"line\">    <span class=\"title function_\">timer</span>();</span><br><span class=\"line\">  }).<span class=\"title function_\">catch</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"inner error\"</span>);</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">p</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"running then\"</span>);</span><br><span class=\"line\">  })</span><br><span class=\"line\">  .<span class=\"title function_\">catch</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"outer error\"</span>);</span><br><span class=\"line\">  });</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Arguments] {</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  2: 8,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  3: 22,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  4: [object Error] { ... }</span></span><br><span class=\"line\"><span class=\"hljs-comment\">}</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></tbody></table></figure>\n\n<h5 id=\"Promise-catch\"><a href=\"#Promise-catch\" class=\"headerlink\" title=\"Promise catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch\">Promise catch</a></h5><h5 id=\"Q-catch--Promise-\"><a href=\"#Q-catch--Promise-\" class=\"headerlink\" title=\"Q catch  Promise \"></a>Q catch  Promise </h5><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"hljs-property\">onerror</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"onerror\"</span>);</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">info</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) {</span><br><span class=\"line\">    <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-keyword\">try</span> {</span><br><span class=\"line\">  <span class=\"title function_\">p</span>().<span class=\"title function_\">then</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">res</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"running then\"</span>);</span><br><span class=\"line\">  });</span><br><span class=\"line\">} <span class=\"hljs-keyword\">catch</span> (e) {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e);</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"try - catch\"</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\"> */</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>Promise <strong>try - catch</strong><strong>onerror</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">info</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) {</span><br><span class=\"line\">    <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">  }).<span class=\"title function_\">catch</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"inner error\"</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"return inner error\"</span>;</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-keyword\">try</span> {</span><br><span class=\"line\">  <span class=\"title function_\">p</span>()</span><br><span class=\"line\">    .<span class=\"title function_\">then</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">res</span>) {</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(res);</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"running then\"</span>);</span><br><span class=\"line\">    })</span><br><span class=\"line\">    .<span class=\"title function_\">catch</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) {</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"outer error\"</span>);</span><br><span class=\"line\">    });</span><br><span class=\"line\">} <span class=\"hljs-keyword\">catch</span> (e) {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e);</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"try - catch\"</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] { ... }</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"running then\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p> then  Promise <strong>catch</strong></p>\n<h5 id=\"async-await--try-catch\"><a href=\"#async-await--try-catch\" class=\"headerlink\" title=\"async/await  try - catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function\">async/await</a>  <strong>try - catch</strong></h5><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"hljs-property\">onerror</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">info</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) {</span><br><span class=\"line\">    <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">p</span>();</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(res);</span><br><span class=\"line\">})();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\"> */</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>Promise <strong>onerror</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"hljs-property\">onerror</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">info</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) {</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>(<span class=\"hljs-string\">\"resolve\"</span>);</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">p</span>();</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"get res\"</span>);</span><br><span class=\"line\">  <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">})();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">get res</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p> Promise <strong>onerror</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">info</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) {</span><br><span class=\"line\">    <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">try</span> {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">p</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(res);</span><br><span class=\"line\">  } <span class=\"hljs-keyword\">catch</span> (e) {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"try - catch\"</span>);</span><br><span class=\"line\">  }</span><br><span class=\"line\">})();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] { ... }</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"try - catch\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>try - catch</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">info</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) {</span><br><span class=\"line\">    <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">  }).<span class=\"title function_\">catch</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"inner error\"</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"return inner error\"</span>;</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">try</span> {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">p</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(res);</span><br><span class=\"line\">  } <span class=\"hljs-keyword\">catch</span> (e) {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"try - catch\"</span>);</span><br><span class=\"line\">  }</span><br><span class=\"line\">})();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] { ... }</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p> Promise  catch  async/await  <strong>try - catch</strong></p>\n<h5 id=\"Vue-config-errorHandler\"><a href=\"#Vue-config-errorHandler\" class=\"headerlink\" title=\"Vue.config.errorHandler\"></a><a href=\"https://cn.vuejs.org/v2/api/index.html#errorHandler\">Vue.config.errorHandler</a></h5><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">errorHandler</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// handle error</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// `info`  Vue </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  2.2.0+ </span></span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p> Vue </p>\n</blockquote>\n<p> errorHandler  vue-cli  vue </p>\n<p><a href=\"https://github.com/miser/vue-capture-error\">https://github.com/miser/vue-capture-error</a></p>\n<p> main.js</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">errorHandler</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"vue errorHandler\"</span>);</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n\n<p> App.vue</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">normal</span>()</span><br><span class=\"line\">  },</span><br><span class=\"line\">  <span class=\"hljs-attr\">methods</span>: {</span><br><span class=\"line\">    normal () {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">info</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/*  console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal </span></span><br><span class=\"line\"><span class=\"hljs-comment\">1: VueComponent {_uid: 1, _isVue: true, $options: {}, _renderProxy: Proxy, _self: VueComponent, }</span></span><br><span class=\"line\"><span class=\"hljs-comment\">2: \"created hook</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>errorHandler  errorHandler  window.onerror  Promse  async/await </p>\n<p>js  <a href=\"https://github.com/axios/axios\">axios</a>  ajax  Promise </p>\n<p>main.js </p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> request = axios.<span class=\"title function_\">create</span>();</span><br><span class=\"line\">request.<span class=\"hljs-property\">interceptors</span>.<span class=\"hljs-property\">response</span>.<span class=\"title function_\">use</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">response</span>) =&gt;</span> {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> response;</span><br><span class=\"line\">});</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"hljs-property\">request</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">args</span>) =&gt;</span> {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"title function_\">request</span>(args)</span><br><span class=\"line\">      .<span class=\"title function_\">then</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">res</span>) =&gt;</span> {</span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>(res);</span><br><span class=\"line\">      })</span><br><span class=\"line\">      .<span class=\"title function_\">catch</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">err</span>) =&gt;</span> {</span><br><span class=\"line\">        <span class=\"title function_\">reject</span>(err);</span><br><span class=\"line\">      });</span><br><span class=\"line\">  });</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n\n<p> App.vue</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch1</span>()</span><br><span class=\"line\">  },</span><br><span class=\"line\">  <span class=\"hljs-attr\">methods</span>: {</span><br><span class=\"line\">    fetch1 () {</span><br><span class=\"line\">        <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"hljs-string\">'https://api1.github.com/'</span>)</span><br><span class=\"line\">\t      .<span class=\"title function_\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> {</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(response)</span><br><span class=\"line\">          })</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>api.github.com  github  api  api1.github.com  errorHandler  Vue.request  catch  Promise.then </p>\n<p> App.vue</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch2</span>()</span><br><span class=\"line\">  },</span><br><span class=\"line\">  <span class=\"hljs-attr\">methods</span>: {</span><br><span class=\"line\">    fetch2 () {</span><br><span class=\"line\">      <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      .<span class=\"title function_\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> data = response.<span class=\"hljs-property\">data</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">api</span>.<span class=\"hljs-property\">info</span></span><br><span class=\"line\">      })</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>errorHandler  vue  issue  Promise  async/await :</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/6551\">https://github.com/vuejs/vue/issues/6551</a></p>\n<p>Vue cannot capture errors that are thrown asynchronously, similar to how try catch wont catch async errors. Its your responsibility to handle async errors properly, e.g. using Promise.catch  @yyx990803</p>\n</blockquote>\n<p> Promise.catch </p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/7653\">https://github.com/vuejs/vue/issues/7653</a></p>\n<p>@Doeke  mixin Promise  Promise Promise  catch  Promise </p>\n</blockquote>\n<p>main.js @Doeke </p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"title function_\">mixin</span>({</span><br><span class=\"line\">  <span class=\"hljs-attr\">beforeCreate</span>: <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> methods = <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">$options</span>.<span class=\"hljs-property\">methods</span> || {};</span><br><span class=\"line\">    <span class=\"title class_\">Object</span>.<span class=\"title function_\">entries</span>(methods).<span class=\"title function_\">forEach</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">[key, method]</span>) =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (method.<span class=\"hljs-property\">_asyncWrapped</span>) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> wrappedMethod = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">...args</span>) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> result = method.<span class=\"title function_\">apply</span>(<span class=\"variable language_\">this</span>, args);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> resultIsPromise = result &amp;&amp; <span class=\"hljs-keyword\">typeof</span> result.<span class=\"hljs-property\">then</span> === <span class=\"hljs-string\">\"function\"</span>;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (!resultIsPromise) <span class=\"hljs-keyword\">return</span> result;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-keyword\">async</span> (resolve, reject) =&gt; {</span><br><span class=\"line\">          <span class=\"hljs-keyword\">try</span> {</span><br><span class=\"line\">            <span class=\"title function_\">resolve</span>(<span class=\"hljs-keyword\">await</span> result);</span><br><span class=\"line\">          } <span class=\"hljs-keyword\">catch</span> (error) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span> (!error.<span class=\"hljs-property\">_handled</span>) {</span><br><span class=\"line\">              <span class=\"hljs-keyword\">const</span> errorHandler = <span class=\"title class_\">Vue</span>.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">errorHandler</span>;</span><br><span class=\"line\">              <span class=\"title function_\">errorHandler</span>(error);</span><br><span class=\"line\">              error.<span class=\"hljs-property\">_handled</span> = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">            }</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">          }</span><br><span class=\"line\">        });</span><br><span class=\"line\">      };</span><br><span class=\"line\">      wrappedMethod.<span class=\"hljs-property\">_asyncWrapped</span> = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">      methods[key] = wrappedMethod;</span><br><span class=\"line\">    });</span><br><span class=\"line\">  },</span><br><span class=\"line\">});</span><br></pre></td></tr></tbody></table></figure>\n\n<p> App.vue</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch2</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch3</span>()</span><br><span class=\"line\">  },</span><br><span class=\"line\">  <span class=\"hljs-attr\">methods</span>: {</span><br><span class=\"line\">    fetch2 () {</span><br><span class=\"line\">      <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .<span class=\"title function_\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> {</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> data = response.<span class=\"hljs-property\">data</span></span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">api</span>.<span class=\"hljs-property\">fetch2</span></span><br><span class=\"line\">        })</span><br><span class=\"line\">    },</span><br><span class=\"line\">    fetch3 () {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .<span class=\"title function_\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> {</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> data = response.<span class=\"hljs-property\">data</span></span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">api</span>.<span class=\"hljs-property\">fetch3</span></span><br><span class=\"line\">        })</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p> console fetch3  errorHandler  fetch2 </p>\n<p> Promise  async/await </p>\n<p> App.vue</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch4</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch5</span>()</span><br><span class=\"line\">  },</span><br><span class=\"line\">  <span class=\"hljs-attr\">methods</span>: {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> fetch4 () {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> response = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data = response.<span class=\"hljs-property\">data</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">api</span>.<span class=\"hljs-property\">fetch4</span></span><br><span class=\"line\">    },</span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> fetch5 () {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> response = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data = response.<span class=\"hljs-property\">data</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.<span class=\"hljs-property\">api</span>.<span class=\"hljs-property\">fetch5</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> response</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>fetch4  Promisefetch5  Promise  fetch4  fetch5  async/await  Promise  <a href=\"https://babeljs.io/\">babeljs</a>  Try it out  async/await Promise</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong> axios.create </p>\n<p><strong></strong> Promise  errorHandler Promise  mixin  Promise  catch  errorHandler **<em>!</em>**</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong>#  </strong></p>\n<p></p>\n<p>**#  <a href=\"https://sentry.io/\">Sentry</a> **</p>\n<p> JS SDK</p>\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install raven-js --save</span><br></pre></td></tr></tbody></table></figure>\n\n<p> main.js</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> <span class=\"title class_\">Raven</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"raven-js\"</span>;</span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> <span class=\"title class_\">RavenVue</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"raven-js/plugins/vue\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Raven</span>.<span class=\"title function_\">config</span>(<span class=\"hljs-string\">\"https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044\"</span>) <span class=\"hljs-comment\">// sentry token</span></span><br><span class=\"line\">  .<span class=\"title function_\">addPlugin</span>(<span class=\"title class_\">RavenVue</span>, <span class=\"title class_\">Vue</span>)</span><br><span class=\"line\">  .<span class=\"title function_\">install</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">errorHandler</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) {</span><br><span class=\"line\">  <span class=\"title class_\">Raven</span>.<span class=\"title function_\">captureException</span>(err);</span><br><span class=\"line\">};</span><br><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"hljs-property\">request</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">args</span>) =&gt;</span> {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"title function_\">request</span>(args)</span><br><span class=\"line\">      .<span class=\"title function_\">then</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">res</span>) =&gt;</span> {</span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>(res);</span><br><span class=\"line\">      })</span><br><span class=\"line\">      .<span class=\"title function_\">catch</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">err</span>) =&gt;</span> {</span><br><span class=\"line\">        <span class=\"title class_\">Raven</span>.<span class=\"title function_\">captureException</span>(err);</span><br><span class=\"line\">        <span class=\"title function_\">reject</span>(err);</span><br><span class=\"line\">      });</span><br><span class=\"line\">  });</span><br><span class=\"line\">};</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p> App.vue  js </p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">created () {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">normal</span>()</span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch1()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch2()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch3()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch4()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch5()</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p> sentry <br><img src=\"/images/js-capture-error/1.png\" alt=\"\"><br><img src=\"/images/js-capture-error/2.jpg\" alt=\"IP\"><br> 2 sentry  issue </p>\n<p> fetch1  ajax <br><img src=\"/images/js-capture-error/3.jpg\" alt=\"api1.github.com\"></p>\n<p> fetch2  Promise  Promise  async/await  Promise.then  2 </p>\n<p><img src=\"/images/js-capture-error/4.jpg\" alt=\"Promise.then\"><br><img src=\"/images/js-capture-error/5.jpg\" alt=\"async/await\"></p>\n<p></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Raven</span>.<span class=\"title function_\">setUser</span>({</span><br><span class=\"line\">  <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">\"miser name\"</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">id</span>: <span class=\"hljs-string\">\"miser id\"</span>,</span><br><span class=\"line\">});</span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src=\"/images/js-capture-error/6.jpg\" alt=\"\"></p>\n<p><strong></strong></p>\n<p><img src=\"/images/js-capture-error/7.jpg\" alt=\"npm run build \"></p>\n<p> sentry <a href=\"https://github.com/google/closure-compiler/wiki/Source-Maps\">SourceMaps</a> debug </p>\n<p><a href=\"https://www.npmjs.com/package/webpack-sentry-plugin\">webpack-sentry-plugin</a> webpack  vue.config.js </p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">SentryPlugin</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">\"webpack-sentry-plugin\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"hljs-property\">exports</span> = {</span><br><span class=\"line\">  <span class=\"hljs-attr\">configureWebpack</span>: {</span><br><span class=\"line\">    <span class=\"hljs-attr\">plugins</span>: [</span><br><span class=\"line\">      <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">SentryPlugin</span>({</span><br><span class=\"line\">        <span class=\"hljs-attr\">organization</span>: <span class=\"hljs-string\">\"fe-org\"</span>, <span class=\"hljs-comment\">//  </span></span><br><span class=\"line\">        <span class=\"hljs-attr\">project</span>: <span class=\"hljs-string\">\"popcorn-vue\"</span>, <span class=\"hljs-comment\">//  </span></span><br><span class=\"line\">        <span class=\"hljs-attr\">apiKey</span>:</span><br><span class=\"line\">          <span class=\"hljs-string\">\"17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150\"</span>,</span><br><span class=\"line\">        <span class=\"hljs-attr\">release</span>: <span class=\"hljs-string\">\"1.2.4-beta\"</span>, <span class=\"hljs-comment\">// sourcemaps</span></span><br><span class=\"line\">      }),</span><br><span class=\"line\">    ],</span><br><span class=\"line\">  },</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n\n<p> main.js</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Raven</span>.<span class=\"title function_\">config</span>(<span class=\"hljs-string\">\"https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044\"</span>, {</span><br><span class=\"line\">  <span class=\"hljs-attr\">release</span>: <span class=\"hljs-string\">\"1.2.4-beta\"</span>, <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">})</span><br><span class=\"line\">  .<span class=\"title function_\">addPlugin</span>(<span class=\"title class_\">RavenVue</span>, <span class=\"title class_\">Vue</span>)</span><br><span class=\"line\">  .<span class=\"title function_\">install</span>();</span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run build</span><br></pre></td></tr></tbody></table></figure>\n\n<p> sentry  popcorn-vue <strong></strong></p>\n<p><img src=\"/images/js-capture-error/8.jpg\" alt=\"1.2.4-beta1.2.3-beta\"><br><img src=\"/images/js-capture-error/9.jpg\" alt=\" 1.2.4-beta jsjs.map\"></p>\n<p> build  index.html SourceMaps  js  js.map </p>\n<p> issue <a href=\"https://github.com/getsentry/sentry-electron/issues/54\">https://github.com/getsentry/sentry-electron/issues/54</a>  2 </p>\n<p>  js.map  js <br> js  js.map </p>\n<p> 2 </p>\n<p> index.htmlfile:///<strong>**</strong>/vue-capture-error/dist/index.html nginx </p>\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install nginx</span><br><span class=\"line\">nginx</span><br></pre></td></tr></tbody></table></figure>\n\n<p> build  dist  nginx  /usr/local/var/www/ <a href=\"http://localhost:8080/\">http://localhost:8080</a></p>\n<p> sentry </p>\n<p><img src=\"/images/js-capture-error/10.jpg\" alt=\"\"></p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[],"excerpt":"<html><head></head><body><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>1. window.onerror js Promiseasync/await </p>\n<p>2.Promise <strong>catch</strong></p>\n<p>3.async/await  <strong>try - catch</strong></p>\n<p>4.Vue  Vue.config.errorHandler  Promiseasync/await  Vue  window.onerror</p></body></html>","more":"<h4 id=\"-chrome-https-jsbin-com\"><a href=\"#-chrome-https-jsbin-com\" class=\"headerlink\" title=\" chrome &amp; https://jsbin.com\"></a> chrome &amp; <a href=\"https://jsbin.com)/\">https://jsbin.com</a></h4><h5 id=\"window-onerror\"><a href=\"#window-onerror\" class=\"headerlink\" title=\"window.onerror\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror\">window.onerror</a></h5><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"property\">onerror</span> = <span class=\"keyword\">function</span> (<span class=\"params\">message, source, lineno, colno, error</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    messageHTML onerror=&quot;&quot;event</span></span><br><span class=\"line\"><span class=\"comment\">    sourceURL</span></span><br><span class=\"line\"><span class=\"comment\">    lineno</span></span><br><span class=\"line\"><span class=\"comment\">    colno</span></span><br><span class=\"line\"><span class=\"comment\">    errorError</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"property\">onerror</span> = <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> data;</span><br><span class=\"line\"><span class=\"keyword\">let</span> info = data.<span class=\"property\">info</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"comment\">  0: &quot;Uncaught TypeError: Cannot read property &#x27;info&#x27; of undefined&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">  1: &quot;yiveral.js&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">  2: 6,</span></span><br><span class=\"line\"><span class=\"comment\">  3: 17,</span></span><br><span class=\"line\"><span class=\"comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>onerror</strong> Promise  Promise  setTimeout  js </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"property\">onerror</span> = <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">timer</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> data;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> info = data.<span class=\"property\">info</span>;</span><br><span class=\"line\">  &#125;, <span class=\"number\">100</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">timer</span>();</span><br><span class=\"line\">  &#125;).<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span> (<span class=\"params\">error</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;inner error&quot;</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">p</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;running then&quot;</span>);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span> (<span class=\"params\">error</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;outer error&quot;</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"comment\">  0: &quot;Uncaught TypeError: Cannot read property &#x27;info&#x27; of undefined&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">  1: &quot;yiveral.js&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">  2: 8,</span></span><br><span class=\"line\"><span class=\"comment\">  3: 22,</span></span><br><span class=\"line\"><span class=\"comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Promise-catch\"><a href=\"#Promise-catch\" class=\"headerlink\" title=\"Promise catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch\">Promise catch</a></h5><h5 id=\"Q-catch--Promise-\"><a href=\"#Q-catch--Promise-\" class=\"headerlink\" title=\"Q catch  Promise \"></a>Q catch  Promise </h5><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"property\">onerror</span> = <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;onerror&quot;</span>);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.<span class=\"property\">info</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">p</span>().<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\">res</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;running then&quot;</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e);</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;try - catch&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n\n<p>Promise <strong>try - catch</strong><strong>onerror</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.<span class=\"property\">info</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">  &#125;).<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span> (<span class=\"params\">error</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;inner error&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;return inner error&quot;</span>;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">p</span>()</span><br><span class=\"line\">    .<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\">res</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(res);</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;running then&quot;</span>);</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    .<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span> (<span class=\"params\">error</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;outer error&quot;</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e);</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;try - catch&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&quot;inner error&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot;return inner error&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot;running then&quot;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n<p> then  Promise <strong>catch</strong></p>\n<h5 id=\"async-await--try-catch\"><a href=\"#async-await--try-catch\" class=\"headerlink\" title=\"async&#x2F;await  try - catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function\">async&#x2F;await</a>  <strong>try - catch</strong></h5><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"property\">onerror</span> = <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.<span class=\"property\">info</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> <span class=\"title function_\">p</span>();</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(res);</span><br><span class=\"line\">&#125;)();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n\n<p>Promise <strong>onerror</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"property\">onerror</span> = <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.<span class=\"property\">info</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>(<span class=\"string\">&quot;resolve&quot;</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> <span class=\"title function_\">p</span>();</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;get res&quot;</span>);</span><br><span class=\"line\">  <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">&#125;)();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">get res</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n<p> Promise <strong>onerror</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.<span class=\"property\">info</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> <span class=\"title function_\">p</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(res);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;try - catch&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&quot;try - catch&quot;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>try - catch</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">errorFn</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.<span class=\"property\">info</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">errorFn</span>();</span><br><span class=\"line\">  &#125;).<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span> (<span class=\"params\">error</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;inner error&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;return inner error&quot;</span>;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> <span class=\"title function_\">p</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(res);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e);</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;try - catch&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console </span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&quot;inner error&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&quot;return inner error&quot;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n<p> Promise  catch  async&#x2F;await  <strong>try - catch</strong></p>\n<h5 id=\"Vue-config-errorHandler\"><a href=\"#Vue-config-errorHandler\" class=\"headerlink\" title=\"Vue.config.errorHandler\"></a><a href=\"https://cn.vuejs.org/v2/api/index.html#errorHandler\">Vue.config.errorHandler</a></h5><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"property\">config</span>.<span class=\"property\">errorHandler</span> = <span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// handle error</span></span><br><span class=\"line\">  <span class=\"comment\">// `info`  Vue </span></span><br><span class=\"line\">  <span class=\"comment\">//  2.2.0+ </span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p> Vue </p>\n</blockquote>\n<p> errorHandler  vue-cli  vue </p>\n<p><a href=\"https://github.com/miser/vue-capture-error\">https://github.com/miser/vue-capture-error</a></p>\n<p> main.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"property\">config</span>.<span class=\"property\">errorHandler</span> = <span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"variable language_\">arguments</span>);</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;vue errorHandler&quot;</span>);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p> App.vue</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">normal</span>()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">methods</span>: &#123;</span><br><span class=\"line\">    normal () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.<span class=\"property\">info</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*  console </span></span><br><span class=\"line\"><span class=\"comment\">0: TypeError: Cannot read property &#x27;info&#x27; of undefined at VueComponent.normal </span></span><br><span class=\"line\"><span class=\"comment\">1: VueComponent &#123;_uid: 1, _isVue: true, $options: &#123;&#125;, _renderProxy: Proxy, _self: VueComponent, &#125;</span></span><br><span class=\"line\"><span class=\"comment\">2: &quot;created hook</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n<p>errorHandler  errorHandler  window.onerror  Promse  async&#x2F;await </p>\n<p>js  <a href=\"https://github.com/axios/axios\">axios</a>  ajax  Promise </p>\n<p>main.js </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> request = axios.<span class=\"title function_\">create</span>();</span><br><span class=\"line\">request.<span class=\"property\">interceptors</span>.<span class=\"property\">response</span>.<span class=\"title function_\">use</span>(<span class=\"function\">(<span class=\"params\">response</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> response;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"property\">request</span> = <span class=\"function\">(<span class=\"params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">request</span>(args)</span><br><span class=\"line\">      .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>(res);</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      .<span class=\"title function_\">catch</span>(<span class=\"function\">(<span class=\"params\">err</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_\">reject</span>(err);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p> App.vue</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch1</span>()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">methods</span>: &#123;</span><br><span class=\"line\">    fetch1 () &#123;</span><br><span class=\"line\">        <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"string\">&#x27;https://api1.github.com/&#x27;</span>)</span><br><span class=\"line\">\t      .<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(response)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>api.github.com  github  api  api1.github.com  errorHandler  Vue.request  catch  Promise.then </p>\n<p> App.vue</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch2</span>()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">methods</span>: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"string\">&#x27;https://api.github.com/&#x27;</span>)</span><br><span class=\"line\">      .<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> data = response.<span class=\"property\">data</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> info = data.<span class=\"property\">api</span>.<span class=\"property\">info</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>errorHandler  vue  issue  Promise  async&#x2F;await :</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/6551\">https://github.com/vuejs/vue/issues/6551</a></p>\n<p>Vue cannot capture errors that are thrown asynchronously, similar to how try catch wont catch async errors. Its your responsibility to handle async errors properly, e.g. using Promise.catch  @yyx990803</p>\n</blockquote>\n<p> Promise.catch </p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/7653\">https://github.com/vuejs/vue/issues/7653</a></p>\n<p>@Doeke  mixin Promise  Promise Promise  catch  Promise </p>\n</blockquote>\n<p>main.js @Doeke </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"title function_\">mixin</span>(&#123;</span><br><span class=\"line\">  <span class=\"attr\">beforeCreate</span>: <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> methods = <span class=\"variable language_\">this</span>.<span class=\"property\">$options</span>.<span class=\"property\">methods</span> || &#123;&#125;;</span><br><span class=\"line\">    <span class=\"title class_\">Object</span>.<span class=\"title function_\">entries</span>(methods).<span class=\"title function_\">forEach</span>(<span class=\"function\">(<span class=\"params\">[key, method]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (method.<span class=\"property\">_asyncWrapped</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> wrappedMethod = <span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> result = method.<span class=\"title function_\">apply</span>(<span class=\"variable language_\">this</span>, args);</span><br><span class=\"line\">        <span class=\"keyword\">const</span> resultIsPromise = result &amp;&amp; <span class=\"keyword\">typeof</span> result.<span class=\"property\">then</span> === <span class=\"string\">&quot;function&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!resultIsPromise) <span class=\"keyword\">return</span> result;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">async</span> (resolve, reject) =&gt; &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"title function_\">resolve</span>(<span class=\"keyword\">await</span> result);</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!error.<span class=\"property\">_handled</span>) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">const</span> errorHandler = <span class=\"title class_\">Vue</span>.<span class=\"property\">config</span>.<span class=\"property\">errorHandler</span>;</span><br><span class=\"line\">              <span class=\"title function_\">errorHandler</span>(error);</span><br><span class=\"line\">              error.<span class=\"property\">_handled</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">      wrappedMethod.<span class=\"property\">_asyncWrapped</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">      methods[key] = wrappedMethod;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p> App.vue</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch2</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch3</span>()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">methods</span>: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"string\">&#x27;https://api.github.com/&#x27;</span>)</span><br><span class=\"line\">        .<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">let</span> data = response.<span class=\"property\">data</span></span><br><span class=\"line\">          <span class=\"keyword\">let</span> info = data.<span class=\"property\">api</span>.<span class=\"property\">fetch2</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    fetch3 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"string\">&#x27;https://api.github.com/&#x27;</span>)</span><br><span class=\"line\">        .<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">let</span> data = response.<span class=\"property\">data</span></span><br><span class=\"line\">          <span class=\"keyword\">let</span> info = data.<span class=\"property\">api</span>.<span class=\"property\">fetch3</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> console fetch3  errorHandler  fetch2 </p>\n<p> Promise  async&#x2F;await </p>\n<p> App.vue</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch4</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetch5</span>()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">methods</span>: &#123;</span><br><span class=\"line\">    <span class=\"keyword\">async</span> fetch4 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> response = <span class=\"keyword\">await</span> <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"string\">&#x27;https://api.github.com/&#x27;</span>)</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = response.<span class=\"property\">data</span></span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.<span class=\"property\">api</span>.<span class=\"property\">fetch4</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"keyword\">async</span> fetch5 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> response = <span class=\"keyword\">await</span> <span class=\"title class_\">Vue</span>.<span class=\"title function_\">request</span>(<span class=\"string\">&#x27;https://api.github.com/&#x27;</span>)</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = response.<span class=\"property\">data</span></span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.<span class=\"property\">api</span>.<span class=\"property\">fetch5</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> response</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>fetch4  Promisefetch5  Promise  fetch4  fetch5  async&#x2F;await  Promise  <a href=\"https://babeljs.io/\">babeljs</a>  Try it out  async&#x2F;await Promise</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong> axios.create </p>\n<p><strong></strong> Promise  errorHandler Promise  mixin  Promise  catch  errorHandler **<em>!</em>**</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong>#  </strong></p>\n<p></p>\n<p>**#  <a href=\"https://sentry.io/\">Sentry</a> **</p>\n<p> JS SDK</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install raven-js --save</span><br></pre></td></tr></table></figure>\n\n<p> main.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"title class_\">Raven</span> <span class=\"keyword\">from</span> <span class=\"string\">&quot;raven-js&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"title class_\">RavenVue</span> <span class=\"keyword\">from</span> <span class=\"string\">&quot;raven-js/plugins/vue&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Raven</span>.<span class=\"title function_\">config</span>(<span class=\"string\">&quot;https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044&quot;</span>) <span class=\"comment\">// sentry token</span></span><br><span class=\"line\">  .<span class=\"title function_\">addPlugin</span>(<span class=\"title class_\">RavenVue</span>, <span class=\"title class_\">Vue</span>)</span><br><span class=\"line\">  .<span class=\"title function_\">install</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"property\">config</span>.<span class=\"property\">errorHandler</span> = <span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) &#123;</span><br><span class=\"line\">  <span class=\"title class_\">Raven</span>.<span class=\"title function_\">captureException</span>(err);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"property\">request</span> = <span class=\"function\">(<span class=\"params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">request</span>(args)</span><br><span class=\"line\">      .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>(res);</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      .<span class=\"title function_\">catch</span>(<span class=\"function\">(<span class=\"params\">err</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"title class_\">Raven</span>.<span class=\"title function_\">captureException</span>(err);</span><br><span class=\"line\">        <span class=\"title function_\">reject</span>(err);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure>\n\n<p> App.vue  js </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">created () &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">normal</span>()</span><br><span class=\"line\">    <span class=\"comment\">// this.fetch1()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch2()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch3()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch4()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch5()</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure>\n\n<p> sentry <br><img src=\"/images/js-capture-error/1.png\" alt=\"\"><br><img src=\"/images/js-capture-error/2.jpg\" alt=\"IP\"><br> 2 sentry  issue </p>\n<p> fetch1  ajax <br><img src=\"/images/js-capture-error/3.jpg\" alt=\"api1.github.com\"></p>\n<p> fetch2  Promise  Promise  async&#x2F;await  Promise.then  2 </p>\n<p><img src=\"/images/js-capture-error/4.jpg\" alt=\"Promise.then\"><br><img src=\"/images/js-capture-error/5.jpg\" alt=\"async/await\"></p>\n<p></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Raven</span>.<span class=\"title function_\">setUser</span>(&#123;</span><br><span class=\"line\">  <span class=\"attr\">name</span>: <span class=\"string\">&quot;miser name&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">id</span>: <span class=\"string\">&quot;miser id&quot;</span>,</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/images/js-capture-error/6.jpg\" alt=\"\"></p>\n<p><strong></strong></p>\n<p><img src=\"/images/js-capture-error/7.jpg\" alt=\"npm run build \"></p>\n<p> sentry <a href=\"https://github.com/google/closure-compiler/wiki/Source-Maps\">SourceMaps</a> debug </p>\n<p><a href=\"https://www.npmjs.com/package/webpack-sentry-plugin\">webpack-sentry-plugin</a> webpack  vue.config.js </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">SentryPlugin</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&quot;webpack-sentry-plugin&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = &#123;</span><br><span class=\"line\">  <span class=\"attr\">configureWebpack</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">plugins</span>: [</span><br><span class=\"line\">      <span class=\"keyword\">new</span> <span class=\"title class_\">SentryPlugin</span>(&#123;</span><br><span class=\"line\">        <span class=\"attr\">organization</span>: <span class=\"string\">&quot;fe-org&quot;</span>, <span class=\"comment\">//  </span></span><br><span class=\"line\">        <span class=\"attr\">project</span>: <span class=\"string\">&quot;popcorn-vue&quot;</span>, <span class=\"comment\">//  </span></span><br><span class=\"line\">        <span class=\"attr\">apiKey</span>:</span><br><span class=\"line\">          <span class=\"string\">&quot;17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">release</span>: <span class=\"string\">&quot;1.2.4-beta&quot;</span>, <span class=\"comment\">// sourcemaps</span></span><br><span class=\"line\">      &#125;),</span><br><span class=\"line\">    ],</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p> main.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Raven</span>.<span class=\"title function_\">config</span>(<span class=\"string\">&quot;https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044&quot;</span>, &#123;</span><br><span class=\"line\">  <span class=\"attr\">release</span>: <span class=\"string\">&quot;1.2.4-beta&quot;</span>, <span class=\"comment\">// </span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">addPlugin</span>(<span class=\"title class_\">RavenVue</span>, <span class=\"title class_\">Vue</span>)</span><br><span class=\"line\">  .<span class=\"title function_\">install</span>();</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run build</span><br></pre></td></tr></table></figure>\n\n<p> sentry  popcorn-vue <strong></strong></p>\n<p><img src=\"/images/js-capture-error/8.jpg\" alt=\"1.2.4-beta1.2.3-beta\"><br><img src=\"/images/js-capture-error/9.jpg\" alt=\" 1.2.4-beta jsjs.map\"></p>\n<p> build  index.html SourceMaps  js  js.map </p>\n<p> issue <a href=\"https://github.com/getsentry/sentry-electron/issues/54\">https://github.com/getsentry/sentry-electron/issues/54</a>  2 </p>\n<p>  js.map  js <br> js  js.map </p>\n<p> 2 </p>\n<p> index.htmlfile:&#x2F;&#x2F;&#x2F;<strong>**</strong>&#x2F;vue-capture-error&#x2F;dist&#x2F;index.html nginx </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install nginx</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure>\n\n<p> build  dist  nginx  &#x2F;usr&#x2F;local&#x2F;var&#x2F;www&#x2F; <a href=\"http://localhost:8080/\">http://localhost:8080</a></p>\n<p> sentry </p>\n<p><img src=\"/images/js-capture-error/10.jpg\" alt=\"\"></p>"},{"title":"Express Gateway","keywords":"Express,Gateway,Node.js ","description":"BFFNode.jsExpress GatewayExpress","date":"2020-01-22T07:32:03.586Z","_content":"\nBFFNode.js2\n\n- [Express Gateway](https://www.express-gateway.io/)\n- [Moleculer](https://moleculer.services/)\n\nLua [Kong](https://konghq.com/)Java Zuul2JavascriptNode.js\n\n**Express Gateway**Express\n\n<!-- more -->\n\n<br/>\n\n## \n\n### **Endpoints**\n\nURL2\n\n- API endpoints\n- Service endpoints\n\nAPI endpointsService endpoints\n\n\n\n### **Policies**\n\npolicyExpress MiddlewareAPI\n\n\n\n### **Pipelines**\n\npipelineAPI endpointspoliciesAPIAPI endpointservice endpoint\n\n\n\n<br/>\n\n\n\n## \n\n[Installation](https://www.express-gateway.io/getting-started/)CLI\n\n```javascript\nnpm install -g express-gateway\n\neg gateway create\n\ncd `Dir Path` && npm start\n```\n\n**2**\n\n- system.config.ymlsession\n- gateway.config.yml\n\n http://localhost:8080/ip  https://httpbin.org/ip JSON\n\n```javascripton\n{\n  \"origin\": \"180.167.xxx.xxx\"\n}\n```\n\nproxy`round-robin``static`IPURLIP\n\n\n\n## \n\n[express-gateway-example](https://github.com/miser/express-gateway-example)\n\n- JWT\n- 2`account``banner`\n  - account: ID\n  - banner: 2banner\n\nexpress-gateway-exampleeg(express-gateway)expressgateway2accountbannerJWT`secret-files`\n\n```c\nopenssl genrsa -out private.pem 512\nopenssl rsa -in private.pem -outform PEM -pubout -out public.pem\n\n```\n\n****\n\n```yaml\n// gateway.config.yml\nhttp:\n  port: 8080\n# admin:\n#   port: 9876\n#   host: localhost\napiEndpoints:\n  login:\n    host: localhost\n    paths: '/account/login'\n  account:\n    host: localhost\n    paths: '/account/*'\n  banner:\n    host: localhost\n    paths: '/banner/*'\nserviceEndpoints:\n  accountSrv:\n    url: 'http://localhost:3001'\n  bannerSrv:\n    url: 'http://localhost:3002'\npolicies:\n  - jwt\n  - proxy\npipelines:\n  login:\n    apiEndpoints:\n      - login\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv \n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n\n```\n\n**3apiEndpoints**\n\n- loginpath _/account/login_\n- accountpath _/account/*_\n- bannerpath _/banner/*_\n\n**2serviceEndpoints**\n\n- accountSrv`account`3001\n- bannerSrv`banner`3002\n\n**pipelines**\n\n- loginbanner2apiEndpoints\n- accountapiEndpointsJWTactionURL querytoken\n\n****\n\n`npm start`Postman GEThttp://localhost:8080/account/profile 401token401pipelinesaccountGET http://localhost:8080/banner/ JWT\n\n```\n{\"code\":200,\"message\":\"success\",\"data\":[\"/images/1.png\",\"/images/2.png\"]}\n```\n\n**token**\n\nPOST http://localhost:8080/account/login ,JWT\n\n```javascripton\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"token\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"\n}\n```\n\ntokenURL queryprofileID\n\n```javascripton\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": {\n        \"id\": \"2020\"\n    }\n}\n```\n\nGateway**``**\n\n<br/>\n\n## \n\n\n\n- [Conditions](https://www.express-gateway.io/docs/policies/customization/conditions/)\n\n- [Policies](https://www.express-gateway.io/docs/policies/)\n\ngateway`plugins``policies``conditions` `manifest.js``policies/index.js``conditions/index.js`\n\n```javascript\n// manifest.js\nmodule.exports = {\n  version: '0.0.1',\n  init: function (pluginContext) {\n    const policy = require('./policies/index.js');\n    pluginContext.registerPolicy(policy);\n\n    const condition = require('./conditions/index.js');\n    pluginContext.registerCondition(condition);\n  }\n}\n```\n\nregisterPolicyregisterCondition`system.config.yml`\n\n```yaml\n// system.config.yml\nplugins:\n  example:\n    package: './plugins/manifest.js'\n```\n\n\n\n**Conditions **\n\n\n\n> ##### `function (req, conditionConfig) => true/false` Handler\n>\n> - Executes on each request in current pipeline. If not matched will prevent policy from being fired\n\napiEndpointspipelinesloginaccountSrvloginurlJWTConditiongateway.config.yml\n\n```yaml\n// gateway.config.yml\napiEndpoints:\n  # login:\n  #   host: localhost\n  #   paths: '/account/login'\n  \n# ...\n\npipelines:\n  # login:\n  #   apiEndpoints:\n  #     - login\n  #   policies:\n  #     - proxy:\n  #         - action:\n  #             serviceEndpoint: accountSrv \n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - \n            condition:\n              name: 'white-list'\n              list: ['/account/login']\n            action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n```\n\njwtcondition`conditions/index.js`URL Path \n\n```javascript\nmodule.exports = {\n  name: 'white-list',\n  schema: {\n    $id: 'white-list',\n  },\n  handler: conditionConfig => req => {\n    return conditionConfig.list.indexOf(req.url) < 0;\n  }\n};\n```\n\nCondition\n\n\n\n**Policies **\n\n\n\nbannerv2banner`/banner/v2/list``/banner`v2URL\n\n```yaml\npipelines:\n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - rewrite:\n          - action:\n              search: '/banner'\n              replace: '/banner/v1/list'\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n```\n\n`policies/index.js`\n\n```javascript\nmodule.exports = {\n  name: 'rewrite',\n  schema: {\n    $id: 'rewrite',\n  },\n  policy: (actionParams) => {\n    return (req, res, next) => {\n      req.url = req.url.replace(actionParams.search, actionParams.replace);\n      next()\n    };\n  }\n};\n```\n\nGET http://localhost:8080/banner/ v2\n\n```javascripton\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": [\n        \"/images/v2_1.png\"\n    ]\n}\n```\n\nURL\n\n\n\n<br/>\n\n<br/>\n\n\n\n## \n\nExpress-GatewayBFFGraphQLJavaScript","source":"_posts/express-gateway.md","raw":"---\ntitle: Express Gateway\ncategory: JavaScript\nkeywords: Express,Gateway,Node.js \ndescription: BFFNode.jsExpress GatewayExpress\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-01-22T15:32:03.586Z\n---\n\nBFFNode.js2\n\n- [Express Gateway](https://www.express-gateway.io/)\n- [Moleculer](https://moleculer.services/)\n\nLua [Kong](https://konghq.com/)Java Zuul2JavascriptNode.js\n\n**Express Gateway**Express\n\n<!-- more -->\n\n<br/>\n\n## \n\n### **Endpoints**\n\nURL2\n\n- API endpoints\n- Service endpoints\n\nAPI endpointsService endpoints\n\n\n\n### **Policies**\n\npolicyExpress MiddlewareAPI\n\n\n\n### **Pipelines**\n\npipelineAPI endpointspoliciesAPIAPI endpointservice endpoint\n\n\n\n<br/>\n\n\n\n## \n\n[Installation](https://www.express-gateway.io/getting-started/)CLI\n\n```javascript\nnpm install -g express-gateway\n\neg gateway create\n\ncd `Dir Path` && npm start\n```\n\n**2**\n\n- system.config.ymlsession\n- gateway.config.yml\n\n http://localhost:8080/ip  https://httpbin.org/ip JSON\n\n```javascripton\n{\n  \"origin\": \"180.167.xxx.xxx\"\n}\n```\n\nproxy`round-robin``static`IPURLIP\n\n\n\n## \n\n[express-gateway-example](https://github.com/miser/express-gateway-example)\n\n- JWT\n- 2`account``banner`\n  - account: ID\n  - banner: 2banner\n\nexpress-gateway-exampleeg(express-gateway)expressgateway2accountbannerJWT`secret-files`\n\n```c\nopenssl genrsa -out private.pem 512\nopenssl rsa -in private.pem -outform PEM -pubout -out public.pem\n\n```\n\n****\n\n```yaml\n// gateway.config.yml\nhttp:\n  port: 8080\n# admin:\n#   port: 9876\n#   host: localhost\napiEndpoints:\n  login:\n    host: localhost\n    paths: '/account/login'\n  account:\n    host: localhost\n    paths: '/account/*'\n  banner:\n    host: localhost\n    paths: '/banner/*'\nserviceEndpoints:\n  accountSrv:\n    url: 'http://localhost:3001'\n  bannerSrv:\n    url: 'http://localhost:3002'\npolicies:\n  - jwt\n  - proxy\npipelines:\n  login:\n    apiEndpoints:\n      - login\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv \n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n\n```\n\n**3apiEndpoints**\n\n- loginpath _/account/login_\n- accountpath _/account/*_\n- bannerpath _/banner/*_\n\n**2serviceEndpoints**\n\n- accountSrv`account`3001\n- bannerSrv`banner`3002\n\n**pipelines**\n\n- loginbanner2apiEndpoints\n- accountapiEndpointsJWTactionURL querytoken\n\n****\n\n`npm start`Postman GEThttp://localhost:8080/account/profile 401token401pipelinesaccountGET http://localhost:8080/banner/ JWT\n\n```\n{\"code\":200,\"message\":\"success\",\"data\":[\"/images/1.png\",\"/images/2.png\"]}\n```\n\n**token**\n\nPOST http://localhost:8080/account/login ,JWT\n\n```javascripton\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"token\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"\n}\n```\n\ntokenURL queryprofileID\n\n```javascripton\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": {\n        \"id\": \"2020\"\n    }\n}\n```\n\nGateway**``**\n\n<br/>\n\n## \n\n\n\n- [Conditions](https://www.express-gateway.io/docs/policies/customization/conditions/)\n\n- [Policies](https://www.express-gateway.io/docs/policies/)\n\ngateway`plugins``policies``conditions` `manifest.js``policies/index.js``conditions/index.js`\n\n```javascript\n// manifest.js\nmodule.exports = {\n  version: '0.0.1',\n  init: function (pluginContext) {\n    const policy = require('./policies/index.js');\n    pluginContext.registerPolicy(policy);\n\n    const condition = require('./conditions/index.js');\n    pluginContext.registerCondition(condition);\n  }\n}\n```\n\nregisterPolicyregisterCondition`system.config.yml`\n\n```yaml\n// system.config.yml\nplugins:\n  example:\n    package: './plugins/manifest.js'\n```\n\n\n\n**Conditions **\n\n\n\n> ##### `function (req, conditionConfig) => true/false` Handler\n>\n> - Executes on each request in current pipeline. If not matched will prevent policy from being fired\n\napiEndpointspipelinesloginaccountSrvloginurlJWTConditiongateway.config.yml\n\n```yaml\n// gateway.config.yml\napiEndpoints:\n  # login:\n  #   host: localhost\n  #   paths: '/account/login'\n  \n# ...\n\npipelines:\n  # login:\n  #   apiEndpoints:\n  #     - login\n  #   policies:\n  #     - proxy:\n  #         - action:\n  #             serviceEndpoint: accountSrv \n  account:\n    apiEndpoints:\n      - account\n    policies:\n      - jwt:\n          - \n            condition:\n              name: 'white-list'\n              list: ['/account/login']\n            action:\n              jwtExtractor: 'query'\n              jwtExtractorField: 'token'\n              checkCredentialExistence: false\n              secretOrPublicKeyFile: '../secret-files/public.pem'\n      - proxy:\n          - action:\n              serviceEndpoint: accountSrv\n```\n\njwtcondition`conditions/index.js`URL Path \n\n```javascript\nmodule.exports = {\n  name: 'white-list',\n  schema: {\n    $id: 'white-list',\n  },\n  handler: conditionConfig => req => {\n    return conditionConfig.list.indexOf(req.url) < 0;\n  }\n};\n```\n\nCondition\n\n\n\n**Policies **\n\n\n\nbannerv2banner`/banner/v2/list``/banner`v2URL\n\n```yaml\npipelines:\n  banner:\n    apiEndpoints:\n      - banner\n    policies:\n      - rewrite:\n          - action:\n              search: '/banner'\n              replace: '/banner/v1/list'\n      - proxy:\n          - action:\n              serviceEndpoint: bannerSrv\n```\n\n`policies/index.js`\n\n```javascript\nmodule.exports = {\n  name: 'rewrite',\n  schema: {\n    $id: 'rewrite',\n  },\n  policy: (actionParams) => {\n    return (req, res, next) => {\n      req.url = req.url.replace(actionParams.search, actionParams.replace);\n      next()\n    };\n  }\n};\n```\n\nGET http://localhost:8080/banner/ v2\n\n```javascripton\n{\n    \"code\": 200,\n    \"message\": \"success\",\n    \"data\": [\n        \"/images/v2_1.png\"\n    ]\n}\n```\n\nURL\n\n\n\n<br/>\n\n<br/>\n\n\n\n## \n\nExpress-GatewayBFFGraphQLJavaScript","slug":"express-gateway","published":1,"updated":"2024-04-08T13:34:33.865Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45we1000k18fdf3m25dyr","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p>BFFNode.js2</p>\n<ul>\n<li><a href=\"https://www.express-gateway.io/\">Express Gateway</a></li>\n<li><a href=\"https://moleculer.services/\">Moleculer</a></li>\n</ul>\n<p>Lua <a href=\"https://konghq.com/\">Kong</a>Java Zuul2JavascriptNode.js</p>\n<p><strong>Express Gateway</strong>Express</p>\n<span id=\"more\"></span>\n\n<br>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"Endpoints\"><a href=\"#Endpoints\" class=\"headerlink\" title=\"Endpoints\"></a><strong>Endpoints</strong></h3><p>URL2</p>\n<ul>\n<li>API endpoints</li>\n<li>Service endpoints</li>\n</ul>\n<p>API endpointsService endpoints</p>\n<h3 id=\"Policies\"><a href=\"#Policies\" class=\"headerlink\" title=\"Policies\"></a><strong>Policies</strong></h3><p>policyExpress MiddlewareAPI</p>\n<h3 id=\"Pipelines\"><a href=\"#Pipelines\" class=\"headerlink\" title=\"Pipelines\"></a><strong>Pipelines</strong></h3><p>pipelineAPI endpointspoliciesAPIAPI endpointservice endpoint</p>\n<br>\n\n\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://www.express-gateway.io/getting-started/\">Installation</a>CLI</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g express-gateway</span><br><span class=\"line\"></span><br><span class=\"line\">eg gateway create</span><br><span class=\"line\"></span><br><span class=\"line\">cd <span class=\"hljs-string\">`Dir Path`</span> &amp;&amp; npm start</span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>2</strong></p>\n<ul>\n<li>system.config.ymlsession</li>\n<li>gateway.config.yml</li>\n</ul>\n<p> <a href=\"http://localhost:8080/ip\">http://localhost:8080/ip</a>  <a href=\"https://httpbin.org/ip\">https://httpbin.org/ip</a> JSON</p>\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{</span><br><span class=\"line\">  \"origin\": \"180.167.xxx.xxx\"</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>proxy<code>round-robin</code><code>static</code>IPURLIP</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://github.com/miser/express-gateway-example\">express-gateway-example</a></p>\n<ul>\n<li>JWT</li>\n<li>2<code>account</code><code>banner</code><ul>\n<li>account: ID</li>\n<li>banner: 2banner</li>\n</ul>\n</li>\n</ul>\n<p>express-gateway-exampleeg(express-gateway)expressgateway2accountbannerJWT<code>secret-files</code></p>\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl genrsa -out private.pem <span class=\"hljs-number\">512</span></span><br><span class=\"line\">openssl rsa -in private.pem -outform PEM -pubout -out public.pem</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong></strong></p>\n<figure class=\"highlight yaml hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"hljs-attr\">http:</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">8080</span></span><br><span class=\"line\"><span class=\"hljs-comment\"># admin:</span></span><br><span class=\"line\"><span class=\"hljs-comment\">#   port: 9876</span></span><br><span class=\"line\"><span class=\"hljs-comment\">#   host: localhost</span></span><br><span class=\"line\"><span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">login:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">host:</span> <span class=\"hljs-string\">localhost</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">paths:</span> <span class=\"hljs-string\">'/account/login'</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">account:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">host:</span> <span class=\"hljs-string\">localhost</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">paths:</span> <span class=\"hljs-string\">'/account/*'</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">banner:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">host:</span> <span class=\"hljs-string\">localhost</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">paths:</span> <span class=\"hljs-string\">'/banner/*'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">serviceEndpoints:</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">accountSrv:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">url:</span> <span class=\"hljs-string\">'http://localhost:3001'</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">bannerSrv:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">url:</span> <span class=\"hljs-string\">'http://localhost:3002'</span></span><br><span class=\"line\"><span class=\"hljs-attr\">policies:</span></span><br><span class=\"line\">  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">jwt</span></span><br><span class=\"line\">  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">proxy</span></span><br><span class=\"line\"><span class=\"hljs-attr\">pipelines:</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">login:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">login</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">policies:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">proxy:</span></span><br><span class=\"line\">          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">action:</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">serviceEndpoint:</span> <span class=\"hljs-string\">accountSrv</span> </span><br><span class=\"line\">  <span class=\"hljs-attr\">banner:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">banner</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">policies:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">proxy:</span></span><br><span class=\"line\">          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">action:</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">serviceEndpoint:</span> <span class=\"hljs-string\">bannerSrv</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">account:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">account</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">policies:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">jwt:</span></span><br><span class=\"line\">          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">action:</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">jwtExtractor:</span> <span class=\"hljs-string\">'query'</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">jwtExtractorField:</span> <span class=\"hljs-string\">'token'</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">checkCredentialExistence:</span> <span class=\"hljs-literal\">false</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">secretOrPublicKeyFile:</span> <span class=\"hljs-string\">'../secret-files/public.pem'</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">proxy:</span></span><br><span class=\"line\">          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">action:</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">serviceEndpoint:</span> <span class=\"hljs-string\">accountSrv</span></span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>3apiEndpoints</strong></p>\n<ul>\n<li>loginpath <em>/account/login</em></li>\n<li>accountpath <em>/account/*</em></li>\n<li>bannerpath <em>/banner/*</em></li>\n</ul>\n<p><strong>2serviceEndpoints</strong></p>\n<ul>\n<li>accountSrv<code>account</code>3001</li>\n<li>bannerSrv<code>banner</code>3002</li>\n</ul>\n<p><strong>pipelines</strong></p>\n<ul>\n<li>loginbanner2apiEndpoints</li>\n<li>accountapiEndpointsJWTactionURL querytoken</li>\n</ul>\n<p><strong></strong></p>\n<p><code>npm start</code>Postman GET<a href=\"http://localhost:8080/account/profile\">http://localhost:8080/account/profile</a> 401token401pipelinesaccountGET <a href=\"http://localhost:8080/banner/\">http://localhost:8080/banner/</a> JWT</p>\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{\"code\":200,\"message\":\"success\",\"data\":[\"/images/1.png\",\"/images/2.png\"]}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>token</strong></p>\n<p>POST <a href=\"http://localhost:8080/account/login\">http://localhost:8080/account/login</a> ,JWT</p>\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{</span><br><span class=\"line\">    \"code\": 200,</span><br><span class=\"line\">    \"message\": \"success\",</span><br><span class=\"line\">    \"token\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA\"</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>tokenURL queryprofileID</p>\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{</span><br><span class=\"line\">    \"code\": 200,</span><br><span class=\"line\">    \"message\": \"success\",</span><br><span class=\"line\">    \"data\": {</span><br><span class=\"line\">        \"id\": \"2020\"</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>Gateway**<code></code>**</p>\n<br>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<ul>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/customization/conditions/\">Conditions</a></p>\n</li>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/\">Policies</a></p>\n</li>\n</ul>\n<p>gateway<code>plugins</code><code>policies</code><code>conditions</code> <code>manifest.js</code><code>policies/index.js</code><code>conditions/index.js</code></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// manifest.js</span></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"hljs-property\">exports</span> = {</span><br><span class=\"line\">  <span class=\"hljs-attr\">version</span>: <span class=\"hljs-string\">'0.0.1'</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">init</span>: <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">pluginContext</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> policy = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./policies/index.js'</span>);</span><br><span class=\"line\">    pluginContext.<span class=\"title function_\">registerPolicy</span>(policy);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> condition = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./conditions/index.js'</span>);</span><br><span class=\"line\">    pluginContext.<span class=\"title function_\">registerCondition</span>(condition);</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>registerPolicyregisterCondition<code>system.config.yml</code></p>\n<figure class=\"highlight yaml hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">system.config.yml</span></span><br><span class=\"line\"><span class=\"hljs-attr\">plugins:</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">example:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">package:</span> <span class=\"hljs-string\">'./plugins/manifest.js'</span></span><br></pre></td></tr></tbody></table></figure>\n\n\n\n<p><strong>Conditions </strong></p>\n<p></p>\n<blockquote>\n<h5 id=\"function-req-conditionConfig-true-false-Handler\"><a href=\"#function-req-conditionConfig-true-false-Handler\" class=\"headerlink\" title=\"function (req, conditionConfig) => true/false Handler\"></a><code>function (req, conditionConfig) =&gt; true/false</code> Handler</h5><ul>\n<li>Executes on each request in current pipeline. If not matched will prevent policy from being fired</li>\n</ul>\n</blockquote>\n<p>apiEndpointspipelinesloginaccountSrvloginurlJWTConditiongateway.config.yml</p>\n<figure class=\"highlight yaml hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\"># login:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   host: localhost</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   paths: '/account/login'</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"hljs-comment\"># ...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-attr\">pipelines:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\"># login:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#     - login</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#   policies:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#     - proxy:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#         - action:</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">#             serviceEndpoint: accountSrv </span></span><br><span class=\"line\">  <span class=\"hljs-attr\">account:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">account</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">policies:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">jwt:</span></span><br><span class=\"line\">          <span class=\"hljs-bullet\">-</span> </span><br><span class=\"line\">            <span class=\"hljs-attr\">condition:</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">'white-list'</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">list:</span> [<span class=\"hljs-string\">'/account/login'</span>]</span><br><span class=\"line\">            <span class=\"hljs-attr\">action:</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">jwtExtractor:</span> <span class=\"hljs-string\">'query'</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">jwtExtractorField:</span> <span class=\"hljs-string\">'token'</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">checkCredentialExistence:</span> <span class=\"hljs-literal\">false</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">secretOrPublicKeyFile:</span> <span class=\"hljs-string\">'../secret-files/public.pem'</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">proxy:</span></span><br><span class=\"line\">          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">action:</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">serviceEndpoint:</span> <span class=\"hljs-string\">accountSrv</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>jwtcondition<code>conditions/index.js</code>URL Path </p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"hljs-property\">exports</span> = {</span><br><span class=\"line\">  <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'white-list'</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">schema</span>: {</span><br><span class=\"line\">    <span class=\"hljs-attr\">$id</span>: <span class=\"hljs-string\">'white-list'</span>,</span><br><span class=\"line\">  },</span><br><span class=\"line\">  <span class=\"hljs-attr\">handler</span>: <span class=\"hljs-function\"><span class=\"hljs-params\">conditionConfig</span> =&gt;</span> <span class=\"hljs-function\"><span class=\"hljs-params\">req</span> =&gt;</span> {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> conditionConfig.<span class=\"hljs-property\">list</span>.<span class=\"title function_\">indexOf</span>(req.<span class=\"hljs-property\">url</span>) &lt; <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n\n<p>Condition</p>\n<p><strong>Policies </strong></p>\n<p></p>\n<p>bannerv2banner<code>/banner/v2/list</code><code>/banner</code>v2URL</p>\n<figure class=\"highlight yaml hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-attr\">pipelines:</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">banner:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">apiEndpoints:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">banner</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">policies:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">rewrite:</span></span><br><span class=\"line\">          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">action:</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">search:</span> <span class=\"hljs-string\">'/banner'</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">replace:</span> <span class=\"hljs-string\">'/banner/v1/list'</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">proxy:</span></span><br><span class=\"line\">          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">action:</span></span><br><span class=\"line\">              <span class=\"hljs-attr\">serviceEndpoint:</span> <span class=\"hljs-string\">bannerSrv</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>policies/index.js</code></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"hljs-property\">exports</span> = {</span><br><span class=\"line\">  <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'rewrite'</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">schema</span>: {</span><br><span class=\"line\">    <span class=\"hljs-attr\">$id</span>: <span class=\"hljs-string\">'rewrite'</span>,</span><br><span class=\"line\">  },</span><br><span class=\"line\">  <span class=\"hljs-attr\">policy</span>: <span class=\"hljs-function\">(<span class=\"hljs-params\">actionParams</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-function\">(<span class=\"hljs-params\">req, res, next</span>) =&gt;</span> {</span><br><span class=\"line\">      req.<span class=\"hljs-property\">url</span> = req.<span class=\"hljs-property\">url</span>.<span class=\"title function_\">replace</span>(actionParams.<span class=\"hljs-property\">search</span>, actionParams.<span class=\"hljs-property\">replace</span>);</span><br><span class=\"line\">      <span class=\"title function_\">next</span>()</span><br><span class=\"line\">    };</span><br><span class=\"line\">  }</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n\n<p>GET <a href=\"http://localhost:8080/banner/\">http://localhost:8080/banner/</a> v2</p>\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{</span><br><span class=\"line\">    \"code\": 200,</span><br><span class=\"line\">    \"message\": \"success\",</span><br><span class=\"line\">    \"data\": [</span><br><span class=\"line\">        \"/images/v2_1.png\"</span><br><span class=\"line\">    ]</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>URL</p>\n<br>\n\n<br>\n\n\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Express-GatewayBFFGraphQLJavaScript</p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<html><head></head><body><p>BFFNode.js2</p>\n<ul>\n<li><a href=\"https://www.express-gateway.io/\">Express Gateway</a></li>\n<li><a href=\"https://moleculer.services/\">Moleculer</a></li>\n</ul>\n<p>Lua <a href=\"https://konghq.com/\">Kong</a>Java Zuul2JavascriptNode.js</p>\n<p><strong>Express Gateway</strong>Express</p></body></html>","more":"<br/>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"Endpoints\"><a href=\"#Endpoints\" class=\"headerlink\" title=\"Endpoints\"></a><strong>Endpoints</strong></h3><p>URL2</p>\n<ul>\n<li>API endpoints</li>\n<li>Service endpoints</li>\n</ul>\n<p>API endpointsService endpoints</p>\n<h3 id=\"Policies\"><a href=\"#Policies\" class=\"headerlink\" title=\"Policies\"></a><strong>Policies</strong></h3><p>policyExpress MiddlewareAPI</p>\n<h3 id=\"Pipelines\"><a href=\"#Pipelines\" class=\"headerlink\" title=\"Pipelines\"></a><strong>Pipelines</strong></h3><p>pipelineAPI endpointspoliciesAPIAPI endpointservice endpoint</p>\n<br/>\n\n\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://www.express-gateway.io/getting-started/\">Installation</a>CLI</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g express-gateway</span><br><span class=\"line\"></span><br><span class=\"line\">eg gateway create</span><br><span class=\"line\"></span><br><span class=\"line\">cd <span class=\"string\">`Dir Path`</span> &amp;&amp; npm start</span><br></pre></td></tr></table></figure>\n\n<p><strong>2</strong></p>\n<ul>\n<li>system.config.ymlsession</li>\n<li>gateway.config.yml</li>\n</ul>\n<p> <a href=\"http://localhost:8080/ip\">http://localhost:8080/ip</a>  <a href=\"https://httpbin.org/ip\">https://httpbin.org/ip</a> JSON</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;origin&quot;: &quot;180.167.xxx.xxx&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>proxy<code>round-robin</code><code>static</code>IPURLIP</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://github.com/miser/express-gateway-example\">express-gateway-example</a></p>\n<ul>\n<li>JWT</li>\n<li>2<code>account</code><code>banner</code><ul>\n<li>account: ID</li>\n<li>banner: 2banner</li>\n</ul>\n</li>\n</ul>\n<p>express-gateway-exampleeg(express-gateway)expressgateway2accountbannerJWT<code>secret-files</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl genrsa -out private.pem <span class=\"number\">512</span></span><br><span class=\"line\">openssl rsa -in private.pem -outform PEM -pubout -out public.pem</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong></strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"attr\">http:</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"comment\"># admin:</span></span><br><span class=\"line\"><span class=\"comment\">#   port: 9876</span></span><br><span class=\"line\"><span class=\"comment\">#   host: localhost</span></span><br><span class=\"line\"><span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"attr\">login:</span></span><br><span class=\"line\">    <span class=\"attr\">host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\">    <span class=\"attr\">paths:</span> <span class=\"string\">&#x27;/account/login&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">account:</span></span><br><span class=\"line\">    <span class=\"attr\">host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\">    <span class=\"attr\">paths:</span> <span class=\"string\">&#x27;/account/*&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">banner:</span></span><br><span class=\"line\">    <span class=\"attr\">host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\">    <span class=\"attr\">paths:</span> <span class=\"string\">&#x27;/banner/*&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">serviceEndpoints:</span></span><br><span class=\"line\">  <span class=\"attr\">accountSrv:</span></span><br><span class=\"line\">    <span class=\"attr\">url:</span> <span class=\"string\">&#x27;http://localhost:3001&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">bannerSrv:</span></span><br><span class=\"line\">    <span class=\"attr\">url:</span> <span class=\"string\">&#x27;http://localhost:3002&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">policies:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">jwt</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">proxy</span></span><br><span class=\"line\"><span class=\"attr\">pipelines:</span></span><br><span class=\"line\">  <span class=\"attr\">login:</span></span><br><span class=\"line\">    <span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">login</span></span><br><span class=\"line\">    <span class=\"attr\">policies:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">proxy:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">action:</span></span><br><span class=\"line\">              <span class=\"attr\">serviceEndpoint:</span> <span class=\"string\">accountSrv</span> </span><br><span class=\"line\">  <span class=\"attr\">banner:</span></span><br><span class=\"line\">    <span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">banner</span></span><br><span class=\"line\">    <span class=\"attr\">policies:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">proxy:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">action:</span></span><br><span class=\"line\">              <span class=\"attr\">serviceEndpoint:</span> <span class=\"string\">bannerSrv</span></span><br><span class=\"line\">  <span class=\"attr\">account:</span></span><br><span class=\"line\">    <span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">account</span></span><br><span class=\"line\">    <span class=\"attr\">policies:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">jwt:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">action:</span></span><br><span class=\"line\">              <span class=\"attr\">jwtExtractor:</span> <span class=\"string\">&#x27;query&#x27;</span></span><br><span class=\"line\">              <span class=\"attr\">jwtExtractorField:</span> <span class=\"string\">&#x27;token&#x27;</span></span><br><span class=\"line\">              <span class=\"attr\">checkCredentialExistence:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">              <span class=\"attr\">secretOrPublicKeyFile:</span> <span class=\"string\">&#x27;../secret-files/public.pem&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">proxy:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">action:</span></span><br><span class=\"line\">              <span class=\"attr\">serviceEndpoint:</span> <span class=\"string\">accountSrv</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong>3apiEndpoints</strong></p>\n<ul>\n<li>loginpath <em>&#x2F;account&#x2F;login</em></li>\n<li>accountpath <em>&#x2F;account&#x2F;*</em></li>\n<li>bannerpath <em>&#x2F;banner&#x2F;*</em></li>\n</ul>\n<p><strong>2serviceEndpoints</strong></p>\n<ul>\n<li>accountSrv<code>account</code>3001</li>\n<li>bannerSrv<code>banner</code>3002</li>\n</ul>\n<p><strong>pipelines</strong></p>\n<ul>\n<li>loginbanner2apiEndpoints</li>\n<li>accountapiEndpointsJWTactionURL querytoken</li>\n</ul>\n<p><strong></strong></p>\n<p><code>npm start</code>Postman GET<a href=\"http://localhost:8080/account/profile\">http://localhost:8080/account/profile</a> 401token401pipelinesaccountGET <a href=\"http://localhost:8080/banner/\">http://localhost:8080/banner/</a> JWT</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;code&quot;:200,&quot;message&quot;:&quot;success&quot;,&quot;data&quot;:[&quot;/images/1.png&quot;,&quot;/images/2.png&quot;]&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>token</strong></p>\n<p>POST <a href=\"http://localhost:8080/account/login\">http://localhost:8080/account/login</a> ,JWT</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;code&quot;: 200,</span><br><span class=\"line\">    &quot;message&quot;: &quot;success&quot;,</span><br><span class=\"line\">    &quot;token&quot;: &quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MjAyMCwibmFtZSI6Im1pc2VyIiwiaWF0IjoxNTgwMTQxODIwLCJleHAiOjE1ODAxNDU0MjB9.mixQa9rJqQAT2makAqWfpOCxTC-r0XussuoSrYYTb0aXcs0gMItSI5Aj6ShneX2H1BW1grXwtkrSqY8_FfhIjA&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>tokenURL queryprofileID</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;code&quot;: 200,</span><br><span class=\"line\">    &quot;message&quot;: &quot;success&quot;,</span><br><span class=\"line\">    &quot;data&quot;: &#123;</span><br><span class=\"line\">        &quot;id&quot;: &quot;2020&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Gateway**<code></code>**</p>\n<br/>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<ul>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/customization/conditions/\">Conditions</a></p>\n</li>\n<li><p><a href=\"https://www.express-gateway.io/docs/policies/\">Policies</a></p>\n</li>\n</ul>\n<p>gateway<code>plugins</code><code>policies</code><code>conditions</code> <code>manifest.js</code><code>policies/index.js</code><code>conditions/index.js</code></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// manifest.js</span></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = &#123;</span><br><span class=\"line\">  <span class=\"attr\">version</span>: <span class=\"string\">&#x27;0.0.1&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">init</span>: <span class=\"keyword\">function</span> (<span class=\"params\">pluginContext</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> policy = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./policies/index.js&#x27;</span>);</span><br><span class=\"line\">    pluginContext.<span class=\"title function_\">registerPolicy</span>(policy);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> condition = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./conditions/index.js&#x27;</span>);</span><br><span class=\"line\">    pluginContext.<span class=\"title function_\">registerCondition</span>(condition);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>registerPolicyregisterCondition<code>system.config.yml</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">system.config.yml</span></span><br><span class=\"line\"><span class=\"attr\">plugins:</span></span><br><span class=\"line\">  <span class=\"attr\">example:</span></span><br><span class=\"line\">    <span class=\"attr\">package:</span> <span class=\"string\">&#x27;./plugins/manifest.js&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>Conditions </strong></p>\n<p></p>\n<blockquote>\n<h5 id=\"function-req-conditionConfig-true-false-Handler\"><a href=\"#function-req-conditionConfig-true-false-Handler\" class=\"headerlink\" title=\"function (req, conditionConfig) =&gt; true/false Handler\"></a><code>function (req, conditionConfig) =&gt; true/false</code> Handler</h5><ul>\n<li>Executes on each request in current pipeline. If not matched will prevent policy from being fired</li>\n</ul>\n</blockquote>\n<p>apiEndpointspipelinesloginaccountSrvloginurlJWTConditiongateway.config.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">gateway.config.yml</span></span><br><span class=\"line\"><span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"comment\"># login:</span></span><br><span class=\"line\">  <span class=\"comment\">#   host: localhost</span></span><br><span class=\"line\">  <span class=\"comment\">#   paths: &#x27;/account/login&#x27;</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># ...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">pipelines:</span></span><br><span class=\"line\">  <span class=\"comment\"># login:</span></span><br><span class=\"line\">  <span class=\"comment\">#   apiEndpoints:</span></span><br><span class=\"line\">  <span class=\"comment\">#     - login</span></span><br><span class=\"line\">  <span class=\"comment\">#   policies:</span></span><br><span class=\"line\">  <span class=\"comment\">#     - proxy:</span></span><br><span class=\"line\">  <span class=\"comment\">#         - action:</span></span><br><span class=\"line\">  <span class=\"comment\">#             serviceEndpoint: accountSrv </span></span><br><span class=\"line\">  <span class=\"attr\">account:</span></span><br><span class=\"line\">    <span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">account</span></span><br><span class=\"line\">    <span class=\"attr\">policies:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">jwt:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> </span><br><span class=\"line\">            <span class=\"attr\">condition:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">&#x27;white-list&#x27;</span></span><br><span class=\"line\">              <span class=\"attr\">list:</span> [<span class=\"string\">&#x27;/account/login&#x27;</span>]</span><br><span class=\"line\">            <span class=\"attr\">action:</span></span><br><span class=\"line\">              <span class=\"attr\">jwtExtractor:</span> <span class=\"string\">&#x27;query&#x27;</span></span><br><span class=\"line\">              <span class=\"attr\">jwtExtractorField:</span> <span class=\"string\">&#x27;token&#x27;</span></span><br><span class=\"line\">              <span class=\"attr\">checkCredentialExistence:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">              <span class=\"attr\">secretOrPublicKeyFile:</span> <span class=\"string\">&#x27;../secret-files/public.pem&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">proxy:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">action:</span></span><br><span class=\"line\">              <span class=\"attr\">serviceEndpoint:</span> <span class=\"string\">accountSrv</span></span><br></pre></td></tr></table></figure>\n\n<p>jwtcondition<code>conditions/index.js</code>URL Path </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = &#123;</span><br><span class=\"line\">  <span class=\"attr\">name</span>: <span class=\"string\">&#x27;white-list&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">schema</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">$id</span>: <span class=\"string\">&#x27;white-list&#x27;</span>,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">handler</span>: <span class=\"function\"><span class=\"params\">conditionConfig</span> =&gt;</span> <span class=\"function\"><span class=\"params\">req</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> conditionConfig.<span class=\"property\">list</span>.<span class=\"title function_\">indexOf</span>(req.<span class=\"property\">url</span>) &lt; <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>Condition</p>\n<p><strong>Policies </strong></p>\n<p></p>\n<p>bannerv2banner<code>/banner/v2/list</code><code>/banner</code>v2URL</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">pipelines:</span></span><br><span class=\"line\">  <span class=\"attr\">banner:</span></span><br><span class=\"line\">    <span class=\"attr\">apiEndpoints:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">banner</span></span><br><span class=\"line\">    <span class=\"attr\">policies:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">rewrite:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">action:</span></span><br><span class=\"line\">              <span class=\"attr\">search:</span> <span class=\"string\">&#x27;/banner&#x27;</span></span><br><span class=\"line\">              <span class=\"attr\">replace:</span> <span class=\"string\">&#x27;/banner/v1/list&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">proxy:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">action:</span></span><br><span class=\"line\">              <span class=\"attr\">serviceEndpoint:</span> <span class=\"string\">bannerSrv</span></span><br></pre></td></tr></table></figure>\n\n<p><code>policies/index.js</code></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = &#123;</span><br><span class=\"line\">  <span class=\"attr\">name</span>: <span class=\"string\">&#x27;rewrite&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">schema</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">$id</span>: <span class=\"string\">&#x27;rewrite&#x27;</span>,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">policy</span>: <span class=\"function\">(<span class=\"params\">actionParams</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\">(<span class=\"params\">req, res, next</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      req.<span class=\"property\">url</span> = req.<span class=\"property\">url</span>.<span class=\"title function_\">replace</span>(actionParams.<span class=\"property\">search</span>, actionParams.<span class=\"property\">replace</span>);</span><br><span class=\"line\">      <span class=\"title function_\">next</span>()</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>GET <a href=\"http://localhost:8080/banner/\">http://localhost:8080/banner/</a> v2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;code&quot;: 200,</span><br><span class=\"line\">    &quot;message&quot;: &quot;success&quot;,</span><br><span class=\"line\">    &quot;data&quot;: [</span><br><span class=\"line\">        &quot;/images/v2_1.png&quot;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>URL</p>\n<br/>\n\n<br/>\n\n\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Express-GatewayBFFGraphQLJavaScript</p>"},{"title":"Lighthouse ","date":"2020-07-07T13:56:46.000Z","keywords":"Lighthouse,gather,audit,puppeteer,DevTools,","description":"Lighthouse  puppeteer  gather  audit  gather  audit  Driver  DevTools  Chrome ","_content":"\n## \n\n  CI \n\n### \n\n**First Contentful Paint** canvas  SVG __\n\n**First Meaningful Paint**__\n\n**First CPU Idle** input \n\n**Time to Interactive**\n\n<br/>\n\n## Lighthouse \n\n>   Chrome   Lighthouse \n\n![Lighthouse ](/images/lighthouse/report.png)\n\n<!-- more -->\n<br/>\n\n## \n\n![Lighthouse ](/images/lighthouse/architecture.png)\n\n**Driver**  Chrome \n\n**Gatherers**  Audit\n\n**Artifacts**  Gatherers \n\n**Audit** // Artifacts *Lighthouse *\n\n**Report**  Lighthouse \n\n**Lighthouse  Driver  DevTools Protocol  Chrome  Gatherers artifacts, Audits  LHR  HTML **\n\n### Lighthouse CI\n\n\n\n```yaml\nname: CI\non: [push]\njobs:\n  lighthouseci:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n      - uses: actions/setup-node@v1\n      - run: npm install && npm install -g @lhci/cli@0.4.x\n      - run: npm run build\n      - run: lhci autorun --upload.target=temporary-public-storage\n```\n\n- **npm run build**  dist \n\n- **lhci autorun** `healthcheck``collect``assert``upload`\n\n### collect \n\n> _@lhci/cli  0.4.x_\n\n```javascript\n// autorun\nasync function runCommand(options) {\n  //  healthcheck\n  const healthcheckStatus = runChildCommand(\"healthcheck\", [\n    ...defaultFlags,\n    \"--fatal\",\n  ]).status;\n  //  collect\n  const collectStatus = runChildCommand(\"collect\", [\n    ...defaultFlags,\n    ...collectArgs,\n  ]).status;\n\n  //  assert   assert    upload \n  if (\n    ciConfiguration.assert ||\n    (!ciConfiguration.assert && !ciConfiguration.upload)\n  ) {\n    const assertStatus = runChildCommand(\"assert\", [\n      ...defaultFlags,\n      ...assertArgs,\n    ]).status;\n  }\n\n  //  upload   upload  \n  if (ciConfiguration.upload) {\n    const uploadStatus = runChildCommand(\"upload\", defaultFlags).status;\n    if (options.failOnUploadFailure && uploadStatus !== 0)\n      process.exit(uploadStatus);\n    if (uploadStatus !== 0)\n      process.stderr.write(`WARNING: upload command failed.\\n`);\n  }\n}\n```\n\n `autorun` \n\n- healthcheck  Chrome\n- collect \n- assert \n- upload  `temporary-public-storage` google \n\n```javascript\nasync function runCommand(options) {\n  if (!options.additive) clearSavedReportsAndLHRs();\n\n  checkIgnoredChromeFlagsOption(options);\n\n  const puppeteer = new PuppeteerManager(options);\n\n  //  staticDistDir distbuildpublic--static-dist-dir\n  // staticDistDir\n  //  =>  express server \n  //  =>  startServerCommand\n  // \n  const { urls, close } = await startServerAndDetermineUrls(options);\n  for (const url of urls) {\n    //  puppeteerScript \n    await puppeteer.invokePuppeteerScriptForUrl(url);\n    //\n    await runOnUrl(url, options, { puppeteer });\n  }\n}\n\nasync function runOnUrl(url, options, context) {\n  const runner = getRunner(options); //\n\n  // 3\n  for (let i = 0; i < options.numberOfRuns; i++) {\n    // Node.js  lighthouse-cli\n    const lhr = await runner.runUntilSuccess(url, {\n      ...options,\n      settings,\n    });\n    saveLHR(lhr); //  lighthouse result \n  }\n}\n```\n\n- [puppeteer](https://github.com/puppeteer/puppeteer) DevTools Protocol  Headless Chrome  Node.js \n- numberOfRuns  3 3  Node.js  .lighthouseci  3  lhr-xxx.json  lhr-xxx.html  assertion-results.json \n- runUntilSuccess  lighthouse-cli \n\n```javascript\n// lighthouse-cli \nasync function runLighthouse(url, flags, config) {\n  let launchedChrome;\n\n  //  chrome-launcher  headless Chrome\n  launchedChrome = await getDebuggableChrome(flags);\n  flags.port = launchedChrome.port; // Chrome websocket \n\n  // lighthouse-core/index.js\n  const runnerResult = await lighthouse(url, flags, config);\n\n  if (runnerResult) {\n    await saveResults(runnerResult, flags);\n  }\n\n  return runnerResult;\n}\n```\n\n lighthouse-cli  headless Chrome Chrome, lighthouse-core \n\n```javascript\n// lighthouse-core/index.js\nasync function lighthouse(url, flags = {}, configJSON, connection) {\n  // \n  // Gatherer3beforePasspassafterPass\n  const config = generateConfig(configJSON, flags);\n\n  // ChromeProtocol  Chrome  websocket\n  const connection =\n    connection || new ChromeProtocol(flags.port, flags.hostname);\n\n  //  Gather  Audit \n  return Runner.run(connection, { url, config });\n}\n\nasync function run(connection, runOpts) {\n  //  artifacts\n  artifacts = await Runner._gatherArtifactsFromBrowser(\n    requestedUrl,\n    runOpts,\n    connection\n  );\n  // artifacts audits\n  const auditResults = await Runner._runAudits(\n    settings,\n    runOpts.config.audits,\n    artifacts,\n    lighthouseRunWarnings\n  );\n\n  const lhr = {\n    // ...\n  };\n\n  //  lhr \n  lhr.i18n.icuMessagePaths = i18n.replaceIcuMessageInstanceIds(\n    lhr,\n    settings.locale\n  );\n\n  const report = generateReport(lhr, settings.output);\n\n  return { lhr, artifacts, report };\n}\n\nasync function _gatherArtifactsFromBrowser(\n  requestedUrl,\n  runnerOpts,\n  connection\n) {\n  const driver = runnerOpts.driverMock || new Driver(connection);\n  const gatherOpts = {\n    driver,\n    requestedUrl,\n    settings: runnerOpts.config.settings,\n  };\n  //  Gather artifacts\n  const artifacts = await GatherRunner.run(\n    runnerOpts.config.passes,\n    gatherOpts\n  );\n  return artifacts;\n}\n```\n\nartifactsaudits\n\n####  artifacts \n\n```javascript\n// gather-runner.js\nasync function run(passConfigs, options) {\n  const artifacts = {};\n  const driver = options.driver;\n\n  //  Chrome \n  await driver.connect();\n  //  about:blank \n  await GatherRunner.loadBlank(driver);\n\n  //  artifacts\n  // userAgentemulate\n  const baseArtifacts = await GatherRunner.initializeBaseArtifacts(options);\n  // \n  baseArtifacts.BenchmarkIndex = await options.driver.getBenchmarkIndex();\n\n  // \n  await GatherRunner.setupDriver(driver, options);\n\n  // passConfigs  Gather\n  // runPass\n  for (const passConfig of passConfigs) {\n    const passContext = {\n      driver,\n      url: options.requestedUrl,\n      settings: options.settings,\n      passConfig,\n      baseArtifacts,\n      LighthouseRunWarnings: baseArtifacts.LighthouseRunWarnings,\n    };\n    // loadBlank => setupPassNetwork => cleanBrowserCaches\n    // => beforePass // gather \n    // => beginRecording\n    // => loadPage\n    // => pass // gather \n    // => endRecording\n    // => afterPass // gather \n    // => collectArtifacts\n    const passResults = await GatherRunner.runPass(passContext);\n    //  artifacts \n    Object.assign(artifacts, passResults.artifacts);\n  }\n  return { ...baseArtifacts, ...artifacts }; // Cast to drop Partial<>.\n}\n// Gatherer \nclass Gatherer {\n  get name() {\n    return this.constructor.name;\n  }\n  beforePass(passContext) {}\n\n  pass(passContext) {}\n\n  afterPass(passContext, loadData) {}\n}\n```\n\nrunPass  Lighthouse loadBlanksetupPassNetworkcleanBrowserCachesbeforePassbeginRecording devtoolsLog  tracepassendRecording devtoolsLog  traceafterPasscollectArtifactsbeforePasspass  afterPass  gather  artifacts  lighthouse-core  gather/gatherers \n\n![gatherers](/images/lighthouse/gatherers.png)\n\n `ImageElements`  afterPass \n\n```javascript\n// image-elements.js\nclass ImageElements extends Gatherer {\n  async afterPass(passContext, loadData) {\n    const driver = passContext.driver;\n    const indexedNetworkRecords = loadData.networkRecords.reduce(\n      (map, record) => {\n        if (\n          /^image/.test(record.mimeType) &&\n          record.finished &&\n          record.statusCode === 200\n        ) {\n          map[record.url] = record;\n        }\n        return map;\n      }\n    );\n\n    const expression = `(function() {\n      ${pageFunctions.getElementsInDocumentString}; // define function on page\n      ${getClientRect.toString()};\n      ${getHTMLImages.toString()};\n      ${getCSSImages.toString()};\n      ${collectImageElementInfo.toString()};\n\n      return collectImageElementInfo();\n    })()`;\n\n    const elements = await driver.evaluateAsync(expression);\n    const top50Images = Object.values(indexedNetworkRecords)\n      .sort((a, b) => b.resourceSize - a.resourceSize)\n      .slice(0, 50);\n\n    const imageUsage = [];\n    for (let element of elements) {\n      // ...\n      // Chrome determineNaturalSize \n    }\n    return imageUsage;\n  }\n}\n\nfunction determineNaturalSize(url) {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    img.addEventListener(\"error\", (_) =>\n      reject(new Error(\"determineNaturalSize failed img load\"))\n    );\n    img.addEventListener(\"load\", () => {\n      resolve({\n        naturalWidth: img.naturalWidth,\n        naturalHeight: img.naturalHeight,\n      });\n    });\n\n    img.src = url;\n  });\n}\n```\n\n afterPass  beforePass `loadData`\n\n ImageElements \n\n- \n- expression driver.evaluateAsync  Chrome, \n-  50 \n- elements  top50Images imageUsage\n\n** JavaScript  `driver.evaluateAsync`  Chrome **\n\n#### \n\n lighthouse-core  audits  gather  audit,\n\n![audits](/images/lighthouse/audits.png)\n\n```javascript\n//  lighthouse-core/index.js \nconst auditResults = await Runner._runAudits(\n  settings,\n  runOpts.config.audits,\n  artifacts, // \n  lighthouseRunWarnings\n);\n\nasync function _runAudits(settings, audits, artifacts, runWarnings) {\n  // audits\n  for (const auditDefn of audits) {\n    const auditResult = await Runner._runAudit(\n      auditDefn,\n      artifacts,\n      sharedAuditContext,\n      runWarnings\n    );\n    auditResults.push(auditResult);\n  }\n  return auditResults;\n}\n\nasync function _runAudit(\n  auditDefn,\n  artifacts,\n  sharedAuditContext,\n  runWarnings\n) {\n  const audit = auditDefn.implementation;\n  let auditResult;\n\n  const auditOptions = Object.assign(\n    {},\n    audit.defaultOptions,\n    auditDefn.options\n  );\n  const auditContext = {\n    options: auditOptions,\n    ...sharedAuditContext,\n  };\n  //  audit \n  const product = await audit.audit(narrowedArtifacts, auditContext);\n\n  auditResult = Audit.generateAuditResult(audit, product);\n\n  return auditResult;\n}\n\nclass Audit {\n  // Audit  audit \n  static audit(artifacts, context) {\n    throw new Error(\"audit() method must be overriden\");\n  }\n}\n```\n\n\n\n```javascript\n// /audits/image-size-responsive.js\nclass ImageSizeResponsive extends Audit {\n  static audit(artifacts) {\n    const DPR = artifacts.ViewportDimensions.devicePixelRatio;\n    const results = Array.from(artifacts.ImageElements) //  gather ImageElements\n      .filter(isCandidate) // \n      .filter(image => !imageHasRightSize(image, DPR)) // \n      .filter(\n        image => isVisible(image.clientRect, artifacts.ViewportDimensions) // \n      )\n      .map(image => getResult(image, DPR)); // \n\n    const headings = [\n      // ...\n    ];\n\n    const finalResults = // ...\n\n    return {\n      // true\n      //  audits  score  true \n      score: Number(results.length === 0),\n      details: Audit.makeTableDetails(headings, finalResults)\n    };\n  }\n}\n```\n\ngather  audit  2  audit  gather 2 audit  artifacts  gather \n\n## \n\nLighthouse  puppeteer  gather  audit  gather  audit  Driver  DevTools  Chrome \n","source":"_posts/lighthouse.md","raw":"---\ntitle: Lighthouse \ndate: 2020-07-07 21:56:46\nkeywords: Lighthouse,gather,audit,puppeteer,DevTools,\ndescription: Lighthouse  puppeteer  gather  audit  gather  audit  Driver  DevTools  Chrome \ntags:\n  - \n\t- JavaScript\n\t- Web\n---\n\n## \n\n  CI \n\n### \n\n**First Contentful Paint** canvas  SVG __\n\n**First Meaningful Paint**__\n\n**First CPU Idle** input \n\n**Time to Interactive**\n\n<br/>\n\n## Lighthouse \n\n>   Chrome   Lighthouse \n\n![Lighthouse ](/images/lighthouse/report.png)\n\n<!-- more -->\n<br/>\n\n## \n\n![Lighthouse ](/images/lighthouse/architecture.png)\n\n**Driver**  Chrome \n\n**Gatherers**  Audit\n\n**Artifacts**  Gatherers \n\n**Audit** // Artifacts *Lighthouse *\n\n**Report**  Lighthouse \n\n**Lighthouse  Driver  DevTools Protocol  Chrome  Gatherers artifacts, Audits  LHR  HTML **\n\n### Lighthouse CI\n\n\n\n```yaml\nname: CI\non: [push]\njobs:\n  lighthouseci:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n      - uses: actions/setup-node@v1\n      - run: npm install && npm install -g @lhci/cli@0.4.x\n      - run: npm run build\n      - run: lhci autorun --upload.target=temporary-public-storage\n```\n\n- **npm run build**  dist \n\n- **lhci autorun** `healthcheck``collect``assert``upload`\n\n### collect \n\n> _@lhci/cli  0.4.x_\n\n```javascript\n// autorun\nasync function runCommand(options) {\n  //  healthcheck\n  const healthcheckStatus = runChildCommand(\"healthcheck\", [\n    ...defaultFlags,\n    \"--fatal\",\n  ]).status;\n  //  collect\n  const collectStatus = runChildCommand(\"collect\", [\n    ...defaultFlags,\n    ...collectArgs,\n  ]).status;\n\n  //  assert   assert    upload \n  if (\n    ciConfiguration.assert ||\n    (!ciConfiguration.assert && !ciConfiguration.upload)\n  ) {\n    const assertStatus = runChildCommand(\"assert\", [\n      ...defaultFlags,\n      ...assertArgs,\n    ]).status;\n  }\n\n  //  upload   upload  \n  if (ciConfiguration.upload) {\n    const uploadStatus = runChildCommand(\"upload\", defaultFlags).status;\n    if (options.failOnUploadFailure && uploadStatus !== 0)\n      process.exit(uploadStatus);\n    if (uploadStatus !== 0)\n      process.stderr.write(`WARNING: upload command failed.\\n`);\n  }\n}\n```\n\n `autorun` \n\n- healthcheck  Chrome\n- collect \n- assert \n- upload  `temporary-public-storage` google \n\n```javascript\nasync function runCommand(options) {\n  if (!options.additive) clearSavedReportsAndLHRs();\n\n  checkIgnoredChromeFlagsOption(options);\n\n  const puppeteer = new PuppeteerManager(options);\n\n  //  staticDistDir distbuildpublic--static-dist-dir\n  // staticDistDir\n  //  =>  express server \n  //  =>  startServerCommand\n  // \n  const { urls, close } = await startServerAndDetermineUrls(options);\n  for (const url of urls) {\n    //  puppeteerScript \n    await puppeteer.invokePuppeteerScriptForUrl(url);\n    //\n    await runOnUrl(url, options, { puppeteer });\n  }\n}\n\nasync function runOnUrl(url, options, context) {\n  const runner = getRunner(options); //\n\n  // 3\n  for (let i = 0; i < options.numberOfRuns; i++) {\n    // Node.js  lighthouse-cli\n    const lhr = await runner.runUntilSuccess(url, {\n      ...options,\n      settings,\n    });\n    saveLHR(lhr); //  lighthouse result \n  }\n}\n```\n\n- [puppeteer](https://github.com/puppeteer/puppeteer) DevTools Protocol  Headless Chrome  Node.js \n- numberOfRuns  3 3  Node.js  .lighthouseci  3  lhr-xxx.json  lhr-xxx.html  assertion-results.json \n- runUntilSuccess  lighthouse-cli \n\n```javascript\n// lighthouse-cli \nasync function runLighthouse(url, flags, config) {\n  let launchedChrome;\n\n  //  chrome-launcher  headless Chrome\n  launchedChrome = await getDebuggableChrome(flags);\n  flags.port = launchedChrome.port; // Chrome websocket \n\n  // lighthouse-core/index.js\n  const runnerResult = await lighthouse(url, flags, config);\n\n  if (runnerResult) {\n    await saveResults(runnerResult, flags);\n  }\n\n  return runnerResult;\n}\n```\n\n lighthouse-cli  headless Chrome Chrome, lighthouse-core \n\n```javascript\n// lighthouse-core/index.js\nasync function lighthouse(url, flags = {}, configJSON, connection) {\n  // \n  // Gatherer3beforePasspassafterPass\n  const config = generateConfig(configJSON, flags);\n\n  // ChromeProtocol  Chrome  websocket\n  const connection =\n    connection || new ChromeProtocol(flags.port, flags.hostname);\n\n  //  Gather  Audit \n  return Runner.run(connection, { url, config });\n}\n\nasync function run(connection, runOpts) {\n  //  artifacts\n  artifacts = await Runner._gatherArtifactsFromBrowser(\n    requestedUrl,\n    runOpts,\n    connection\n  );\n  // artifacts audits\n  const auditResults = await Runner._runAudits(\n    settings,\n    runOpts.config.audits,\n    artifacts,\n    lighthouseRunWarnings\n  );\n\n  const lhr = {\n    // ...\n  };\n\n  //  lhr \n  lhr.i18n.icuMessagePaths = i18n.replaceIcuMessageInstanceIds(\n    lhr,\n    settings.locale\n  );\n\n  const report = generateReport(lhr, settings.output);\n\n  return { lhr, artifacts, report };\n}\n\nasync function _gatherArtifactsFromBrowser(\n  requestedUrl,\n  runnerOpts,\n  connection\n) {\n  const driver = runnerOpts.driverMock || new Driver(connection);\n  const gatherOpts = {\n    driver,\n    requestedUrl,\n    settings: runnerOpts.config.settings,\n  };\n  //  Gather artifacts\n  const artifacts = await GatherRunner.run(\n    runnerOpts.config.passes,\n    gatherOpts\n  );\n  return artifacts;\n}\n```\n\nartifactsaudits\n\n####  artifacts \n\n```javascript\n// gather-runner.js\nasync function run(passConfigs, options) {\n  const artifacts = {};\n  const driver = options.driver;\n\n  //  Chrome \n  await driver.connect();\n  //  about:blank \n  await GatherRunner.loadBlank(driver);\n\n  //  artifacts\n  // userAgentemulate\n  const baseArtifacts = await GatherRunner.initializeBaseArtifacts(options);\n  // \n  baseArtifacts.BenchmarkIndex = await options.driver.getBenchmarkIndex();\n\n  // \n  await GatherRunner.setupDriver(driver, options);\n\n  // passConfigs  Gather\n  // runPass\n  for (const passConfig of passConfigs) {\n    const passContext = {\n      driver,\n      url: options.requestedUrl,\n      settings: options.settings,\n      passConfig,\n      baseArtifacts,\n      LighthouseRunWarnings: baseArtifacts.LighthouseRunWarnings,\n    };\n    // loadBlank => setupPassNetwork => cleanBrowserCaches\n    // => beforePass // gather \n    // => beginRecording\n    // => loadPage\n    // => pass // gather \n    // => endRecording\n    // => afterPass // gather \n    // => collectArtifacts\n    const passResults = await GatherRunner.runPass(passContext);\n    //  artifacts \n    Object.assign(artifacts, passResults.artifacts);\n  }\n  return { ...baseArtifacts, ...artifacts }; // Cast to drop Partial<>.\n}\n// Gatherer \nclass Gatherer {\n  get name() {\n    return this.constructor.name;\n  }\n  beforePass(passContext) {}\n\n  pass(passContext) {}\n\n  afterPass(passContext, loadData) {}\n}\n```\n\nrunPass  Lighthouse loadBlanksetupPassNetworkcleanBrowserCachesbeforePassbeginRecording devtoolsLog  tracepassendRecording devtoolsLog  traceafterPasscollectArtifactsbeforePasspass  afterPass  gather  artifacts  lighthouse-core  gather/gatherers \n\n![gatherers](/images/lighthouse/gatherers.png)\n\n `ImageElements`  afterPass \n\n```javascript\n// image-elements.js\nclass ImageElements extends Gatherer {\n  async afterPass(passContext, loadData) {\n    const driver = passContext.driver;\n    const indexedNetworkRecords = loadData.networkRecords.reduce(\n      (map, record) => {\n        if (\n          /^image/.test(record.mimeType) &&\n          record.finished &&\n          record.statusCode === 200\n        ) {\n          map[record.url] = record;\n        }\n        return map;\n      }\n    );\n\n    const expression = `(function() {\n      ${pageFunctions.getElementsInDocumentString}; // define function on page\n      ${getClientRect.toString()};\n      ${getHTMLImages.toString()};\n      ${getCSSImages.toString()};\n      ${collectImageElementInfo.toString()};\n\n      return collectImageElementInfo();\n    })()`;\n\n    const elements = await driver.evaluateAsync(expression);\n    const top50Images = Object.values(indexedNetworkRecords)\n      .sort((a, b) => b.resourceSize - a.resourceSize)\n      .slice(0, 50);\n\n    const imageUsage = [];\n    for (let element of elements) {\n      // ...\n      // Chrome determineNaturalSize \n    }\n    return imageUsage;\n  }\n}\n\nfunction determineNaturalSize(url) {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    img.addEventListener(\"error\", (_) =>\n      reject(new Error(\"determineNaturalSize failed img load\"))\n    );\n    img.addEventListener(\"load\", () => {\n      resolve({\n        naturalWidth: img.naturalWidth,\n        naturalHeight: img.naturalHeight,\n      });\n    });\n\n    img.src = url;\n  });\n}\n```\n\n afterPass  beforePass `loadData`\n\n ImageElements \n\n- \n- expression driver.evaluateAsync  Chrome, \n-  50 \n- elements  top50Images imageUsage\n\n** JavaScript  `driver.evaluateAsync`  Chrome **\n\n#### \n\n lighthouse-core  audits  gather  audit,\n\n![audits](/images/lighthouse/audits.png)\n\n```javascript\n//  lighthouse-core/index.js \nconst auditResults = await Runner._runAudits(\n  settings,\n  runOpts.config.audits,\n  artifacts, // \n  lighthouseRunWarnings\n);\n\nasync function _runAudits(settings, audits, artifacts, runWarnings) {\n  // audits\n  for (const auditDefn of audits) {\n    const auditResult = await Runner._runAudit(\n      auditDefn,\n      artifacts,\n      sharedAuditContext,\n      runWarnings\n    );\n    auditResults.push(auditResult);\n  }\n  return auditResults;\n}\n\nasync function _runAudit(\n  auditDefn,\n  artifacts,\n  sharedAuditContext,\n  runWarnings\n) {\n  const audit = auditDefn.implementation;\n  let auditResult;\n\n  const auditOptions = Object.assign(\n    {},\n    audit.defaultOptions,\n    auditDefn.options\n  );\n  const auditContext = {\n    options: auditOptions,\n    ...sharedAuditContext,\n  };\n  //  audit \n  const product = await audit.audit(narrowedArtifacts, auditContext);\n\n  auditResult = Audit.generateAuditResult(audit, product);\n\n  return auditResult;\n}\n\nclass Audit {\n  // Audit  audit \n  static audit(artifacts, context) {\n    throw new Error(\"audit() method must be overriden\");\n  }\n}\n```\n\n\n\n```javascript\n// /audits/image-size-responsive.js\nclass ImageSizeResponsive extends Audit {\n  static audit(artifacts) {\n    const DPR = artifacts.ViewportDimensions.devicePixelRatio;\n    const results = Array.from(artifacts.ImageElements) //  gather ImageElements\n      .filter(isCandidate) // \n      .filter(image => !imageHasRightSize(image, DPR)) // \n      .filter(\n        image => isVisible(image.clientRect, artifacts.ViewportDimensions) // \n      )\n      .map(image => getResult(image, DPR)); // \n\n    const headings = [\n      // ...\n    ];\n\n    const finalResults = // ...\n\n    return {\n      // true\n      //  audits  score  true \n      score: Number(results.length === 0),\n      details: Audit.makeTableDetails(headings, finalResults)\n    };\n  }\n}\n```\n\ngather  audit  2  audit  gather 2 audit  artifacts  gather \n\n## \n\nLighthouse  puppeteer  gather  audit  gather  audit  Driver  DevTools  Chrome \n","slug":"lighthouse","published":1,"updated":"2024-04-08T13:38:54.582Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45we2000m18fd4rya1sis","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>  CI </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>First Contentful Paint</strong> canvas  SVG <em></em></p>\n<p><strong>First Meaningful Paint</strong><em></em></p>\n<p><strong>First CPU Idle</strong> input </p>\n<p><strong>Time to Interactive</strong></p>\n<br>\n\n<h2 id=\"Lighthouse-\"><a href=\"#Lighthouse-\" class=\"headerlink\" title=\"Lighthouse \"></a>Lighthouse </h2><blockquote>\n<p>  Chrome   Lighthouse </p>\n</blockquote>\n<p><img src=\"/images/lighthouse/report.png\" alt=\"Lighthouse \"></p>\n<span id=\"more\"></span>\n<br>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"/images/lighthouse/architecture.png\" alt=\"Lighthouse \"></p>\n<p><strong>Driver</strong>  Chrome </p>\n<p><strong>Gatherers</strong>  Audit</p>\n<p><strong>Artifacts</strong>  Gatherers </p>\n<p><strong>Audit</strong> // Artifacts <em>Lighthouse </em></p>\n<p><strong>Report</strong>  Lighthouse </p>\n<p><strong>Lighthouse  Driver  DevTools Protocol  Chrome  Gatherers artifacts, Audits  LHR  HTML </strong></p>\n<h3 id=\"Lighthouse-CI\"><a href=\"#Lighthouse-CI\" class=\"headerlink\" title=\"Lighthouse CI\"></a>Lighthouse CI</h3><p></p>\n<figure class=\"highlight yaml hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">CI</span></span><br><span class=\"line\"><span class=\"hljs-attr\">on:</span> [<span class=\"hljs-string\">push</span>]</span><br><span class=\"line\"><span class=\"hljs-attr\">jobs:</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">lighthouseci:</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"hljs-attr\">steps:</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v2</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/setup-node@v1</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-string\">&amp;&amp;</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-string\">-g</span> <span class=\"hljs-string\">@lhci/cli@0.4.x</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">build</span></span><br><span class=\"line\">      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">lhci</span> <span class=\"hljs-string\">autorun</span> <span class=\"hljs-string\">--upload.target=temporary-public-storage</span></span><br></pre></td></tr></tbody></table></figure>\n\n<ul>\n<li><p><strong>npm run build</strong>  dist </p>\n</li>\n<li><p><strong>lhci autorun</strong> <code>healthcheck</code><code>collect</code><code>assert</code><code>upload</code></p>\n</li>\n</ul>\n<h3 id=\"collect-\"><a href=\"#collect-\" class=\"headerlink\" title=\"collect \"></a>collect </h3><blockquote>\n<p><em>@lhci/cli  0.4.x</em></p>\n</blockquote>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// autorun</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">runCommand</span>(<span class=\"hljs-params\">options</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  healthcheck</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> healthcheckStatus = <span class=\"title function_\">runChildCommand</span>(<span class=\"hljs-string\">\"healthcheck\"</span>, [</span><br><span class=\"line\">    ...defaultFlags,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"--fatal\"</span>,</span><br><span class=\"line\">  ]).<span class=\"hljs-property\">status</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  collect</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> collectStatus = <span class=\"title function_\">runChildCommand</span>(<span class=\"hljs-string\">\"collect\"</span>, [</span><br><span class=\"line\">    ...defaultFlags,</span><br><span class=\"line\">    ...collectArgs,</span><br><span class=\"line\">  ]).<span class=\"hljs-property\">status</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  assert   assert    upload </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (</span><br><span class=\"line\">    ciConfiguration.<span class=\"hljs-property\">assert</span> ||</span><br><span class=\"line\">    (!ciConfiguration.<span class=\"hljs-property\">assert</span> &amp;&amp; !ciConfiguration.<span class=\"hljs-property\">upload</span>)</span><br><span class=\"line\">  ) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> assertStatus = <span class=\"title function_\">runChildCommand</span>(<span class=\"hljs-string\">\"assert\"</span>, [</span><br><span class=\"line\">      ...defaultFlags,</span><br><span class=\"line\">      ...assertArgs,</span><br><span class=\"line\">    ]).<span class=\"hljs-property\">status</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  upload   upload  </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (ciConfiguration.<span class=\"hljs-property\">upload</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> uploadStatus = <span class=\"title function_\">runChildCommand</span>(<span class=\"hljs-string\">\"upload\"</span>, defaultFlags).<span class=\"hljs-property\">status</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (options.<span class=\"hljs-property\">failOnUploadFailure</span> &amp;&amp; uploadStatus !== <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      process.<span class=\"title function_\">exit</span>(uploadStatus);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (uploadStatus !== <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      process.<span class=\"hljs-property\">stderr</span>.<span class=\"title function_\">write</span>(<span class=\"hljs-string\">`WARNING: upload command failed.\\n`</span>);</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p> <code>autorun</code> </p>\n<ul>\n<li>healthcheck  Chrome</li>\n<li>collect </li>\n<li>assert </li>\n<li>upload  <code>temporary-public-storage</code> google </li>\n</ul>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">runCommand</span>(<span class=\"hljs-params\">options</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!options.<span class=\"hljs-property\">additive</span>) <span class=\"title function_\">clearSavedReportsAndLHRs</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">checkIgnoredChromeFlagsOption</span>(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> puppeteer = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">PuppeteerManager</span>(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  staticDistDir distbuildpublic--static-dist-dir</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// staticDistDir</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  =&gt;  express server </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  =&gt;  startServerCommand</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> { urls, close } = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">startServerAndDetermineUrls</span>(options);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> url <span class=\"hljs-keyword\">of</span> urls) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">//  puppeteerScript </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">await</span> puppeteer.<span class=\"title function_\">invokePuppeteerScriptForUrl</span>(url);</span><br><span class=\"line\">    <span class=\"hljs-comment\">//</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">runOnUrl</span>(url, options, { puppeteer });</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">runOnUrl</span>(<span class=\"hljs-params\">url, options, context</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> runner = <span class=\"title function_\">getRunner</span>(options); <span class=\"hljs-comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 3</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>; i &lt; options.<span class=\"hljs-property\">numberOfRuns</span>; i++) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// Node.js  lighthouse-cli</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> lhr = <span class=\"hljs-keyword\">await</span> runner.<span class=\"title function_\">runUntilSuccess</span>(url, {</span><br><span class=\"line\">      ...options,</span><br><span class=\"line\">      settings,</span><br><span class=\"line\">    });</span><br><span class=\"line\">    <span class=\"title function_\">saveLHR</span>(lhr); <span class=\"hljs-comment\">//  lighthouse result </span></span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<ul>\n<li><a href=\"https://github.com/puppeteer/puppeteer\">puppeteer</a> DevTools Protocol  Headless Chrome  Node.js </li>\n<li>numberOfRuns  3 3  Node.js  .lighthouseci  3  lhr-xxx.json  lhr-xxx.html  assertion-results.json </li>\n<li>runUntilSuccess  lighthouse-cli </li>\n</ul>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lighthouse-cli </span></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">runLighthouse</span>(<span class=\"hljs-params\">url, flags, config</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> launchedChrome;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  chrome-launcher  headless Chrome</span></span><br><span class=\"line\">  launchedChrome = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">getDebuggableChrome</span>(flags);</span><br><span class=\"line\">  flags.<span class=\"hljs-property\">port</span> = launchedChrome.<span class=\"hljs-property\">port</span>; <span class=\"hljs-comment\">// Chrome websocket </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// lighthouse-core/index.js</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> runnerResult = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">lighthouse</span>(url, flags, config);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (runnerResult) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">saveResults</span>(runnerResult, flags);</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> runnerResult;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p> lighthouse-cli  headless Chrome Chrome, lighthouse-core </p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lighthouse-core/index.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">lighthouse</span>(<span class=\"hljs-params\">url, flags = {}, configJSON, connection</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Gatherer3beforePasspassafterPass</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> config = <span class=\"title function_\">generateConfig</span>(configJSON, flags);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// ChromeProtocol  Chrome  websocket</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> connection =</span><br><span class=\"line\">    connection || <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">ChromeProtocol</span>(flags.<span class=\"hljs-property\">port</span>, flags.<span class=\"hljs-property\">hostname</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  Gather  Audit </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"title class_\">Runner</span>.<span class=\"title function_\">run</span>(connection, { url, config });</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">run</span>(<span class=\"hljs-params\">connection, runOpts</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  artifacts</span></span><br><span class=\"line\">  artifacts = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">Runner</span>.<span class=\"title function_\">_gatherArtifactsFromBrowser</span>(</span><br><span class=\"line\">    requestedUrl,</span><br><span class=\"line\">    runOpts,</span><br><span class=\"line\">    connection</span><br><span class=\"line\">  );</span><br><span class=\"line\">  <span class=\"hljs-comment\">// artifacts audits</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> auditResults = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">Runner</span>.<span class=\"title function_\">_runAudits</span>(</span><br><span class=\"line\">    settings,</span><br><span class=\"line\">    runOpts.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">audits</span>,</span><br><span class=\"line\">    artifacts,</span><br><span class=\"line\">    lighthouseRunWarnings</span><br><span class=\"line\">  );</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> lhr = {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  };</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  lhr </span></span><br><span class=\"line\">  lhr.<span class=\"hljs-property\">i18n</span>.<span class=\"hljs-property\">icuMessagePaths</span> = i18n.<span class=\"title function_\">replaceIcuMessageInstanceIds</span>(</span><br><span class=\"line\">    lhr,</span><br><span class=\"line\">    settings.<span class=\"hljs-property\">locale</span></span><br><span class=\"line\">  );</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> report = <span class=\"title function_\">generateReport</span>(lhr, settings.<span class=\"hljs-property\">output</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> { lhr, artifacts, report };</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">_gatherArtifactsFromBrowser</span>(<span class=\"hljs-params\"></span></span><br><span class=\"line\"><span class=\"hljs-params\">  requestedUrl,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  runnerOpts,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  connection</span></span><br><span class=\"line\"><span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> driver = runnerOpts.<span class=\"hljs-property\">driverMock</span> || <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Driver</span>(connection);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> gatherOpts = {</span><br><span class=\"line\">    driver,</span><br><span class=\"line\">    requestedUrl,</span><br><span class=\"line\">    <span class=\"hljs-attr\">settings</span>: runnerOpts.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">settings</span>,</span><br><span class=\"line\">  };</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  Gather artifacts</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> artifacts = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">GatherRunner</span>.<span class=\"title function_\">run</span>(</span><br><span class=\"line\">    runnerOpts.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">passes</span>,</span><br><span class=\"line\">    gatherOpts</span><br><span class=\"line\">  );</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> artifacts;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>artifactsaudits</p>\n<h4 id=\"-artifacts-\"><a href=\"#-artifacts-\" class=\"headerlink\" title=\" artifacts \"></a> artifacts </h4><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// gather-runner.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">run</span>(<span class=\"hljs-params\">passConfigs, options</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> artifacts = {};</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> driver = options.<span class=\"hljs-property\">driver</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  Chrome </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">await</span> driver.<span class=\"title function_\">connect</span>();</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  about:blank </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">GatherRunner</span>.<span class=\"title function_\">loadBlank</span>(driver);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  artifacts</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// userAgentemulate</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> baseArtifacts = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">GatherRunner</span>.<span class=\"title function_\">initializeBaseArtifacts</span>(options);</span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  baseArtifacts.<span class=\"hljs-property\">BenchmarkIndex</span> = <span class=\"hljs-keyword\">await</span> options.<span class=\"hljs-property\">driver</span>.<span class=\"title function_\">getBenchmarkIndex</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">GatherRunner</span>.<span class=\"title function_\">setupDriver</span>(driver, options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// passConfigs  Gather</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// runPass</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> passConfig <span class=\"hljs-keyword\">of</span> passConfigs) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> passContext = {</span><br><span class=\"line\">      driver,</span><br><span class=\"line\">      <span class=\"hljs-attr\">url</span>: options.<span class=\"hljs-property\">requestedUrl</span>,</span><br><span class=\"line\">      <span class=\"hljs-attr\">settings</span>: options.<span class=\"hljs-property\">settings</span>,</span><br><span class=\"line\">      passConfig,</span><br><span class=\"line\">      baseArtifacts,</span><br><span class=\"line\">      <span class=\"title class_\">LighthouseRunWarnings</span>: baseArtifacts.<span class=\"hljs-property\">LighthouseRunWarnings</span>,</span><br><span class=\"line\">    };</span><br><span class=\"line\">    <span class=\"hljs-comment\">// loadBlank =&gt; setupPassNetwork =&gt; cleanBrowserCaches</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// =&gt; beforePass // gather </span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// =&gt; beginRecording</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// =&gt; loadPage</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// =&gt; pass // gather </span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// =&gt; endRecording</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// =&gt; afterPass // gather </span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// =&gt; collectArtifacts</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> passResults = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">GatherRunner</span>.<span class=\"title function_\">runPass</span>(passContext);</span><br><span class=\"line\">    <span class=\"hljs-comment\">//  artifacts </span></span><br><span class=\"line\">    <span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>(artifacts, passResults.<span class=\"hljs-property\">artifacts</span>);</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> { ...baseArtifacts, ...artifacts }; <span class=\"hljs-comment\">// Cast to drop Partial&lt;&gt;.</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">// Gatherer </span></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Gatherer</span> {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">get</span> <span class=\"title function_\">name</span>() {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">constructor</span>.<span class=\"hljs-property\">name</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"title function_\">beforePass</span>(<span class=\"hljs-params\">passContext</span>) {}</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">pass</span>(<span class=\"hljs-params\">passContext</span>) {}</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">afterPass</span>(<span class=\"hljs-params\">passContext, loadData</span>) {}</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>runPass  Lighthouse loadBlanksetupPassNetworkcleanBrowserCachesbeforePassbeginRecording devtoolsLog  tracepassendRecording devtoolsLog  traceafterPasscollectArtifactsbeforePasspass  afterPass  gather  artifacts  lighthouse-core  gather/gatherers </p>\n<p><img src=\"/images/lighthouse/gatherers.png\" alt=\"gatherers\"></p>\n<p> <code>ImageElements</code>  afterPass </p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// image-elements.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">ImageElements</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">Gatherer</span> {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">async</span> <span class=\"title function_\">afterPass</span>(<span class=\"hljs-params\">passContext, loadData</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> driver = passContext.<span class=\"hljs-property\">driver</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> indexedNetworkRecords = loadData.<span class=\"hljs-property\">networkRecords</span>.<span class=\"title function_\">reduce</span>(</span><br><span class=\"line\">      <span class=\"hljs-function\">(<span class=\"hljs-params\">map, record</span>) =&gt;</span> {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (</span><br><span class=\"line\">          <span class=\"hljs-regexp\">/^image/</span>.<span class=\"title function_\">test</span>(record.<span class=\"hljs-property\">mimeType</span>) &amp;&amp;</span><br><span class=\"line\">          record.<span class=\"hljs-property\">finished</span> &amp;&amp;</span><br><span class=\"line\">          record.<span class=\"hljs-property\">statusCode</span> === <span class=\"hljs-number\">200</span></span><br><span class=\"line\">        ) {</span><br><span class=\"line\">          map[record.<span class=\"hljs-property\">url</span>] = record;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> map;</span><br><span class=\"line\">      }</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> expression = <span class=\"hljs-string\">`(function() {</span></span><br><span class=\"line\"><span class=\"hljs-string\">      <span class=\"hljs-subst\">${pageFunctions.getElementsInDocumentString}</span>; // define function on page</span></span><br><span class=\"line\"><span class=\"hljs-string\">      <span class=\"hljs-subst\">${getClientRect.toString()}</span>;</span></span><br><span class=\"line\"><span class=\"hljs-string\">      <span class=\"hljs-subst\">${getHTMLImages.toString()}</span>;</span></span><br><span class=\"line\"><span class=\"hljs-string\">      <span class=\"hljs-subst\">${getCSSImages.toString()}</span>;</span></span><br><span class=\"line\"><span class=\"hljs-string\">      <span class=\"hljs-subst\">${collectImageElementInfo.toString()}</span>;</span></span><br><span class=\"line\"><span class=\"hljs-string\"></span></span><br><span class=\"line\"><span class=\"hljs-string\">      return collectImageElementInfo();</span></span><br><span class=\"line\"><span class=\"hljs-string\">    })()`</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> elements = <span class=\"hljs-keyword\">await</span> driver.evaluateAsync(expression);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> top50Images = <span class=\"title class_\">Object</span>.<span class=\"title function_\">values</span>(indexedNetworkRecords)</span><br><span class=\"line\">      .<span class=\"title function_\">sort</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">a, b</span>) =&gt;</span> b.<span class=\"hljs-property\">resourceSize</span> - a.<span class=\"hljs-property\">resourceSize</span>)</span><br><span class=\"line\">      .<span class=\"title function_\">slice</span>(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">50</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> imageUsage = [];</span><br><span class=\"line\">    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> element <span class=\"hljs-keyword\">of</span> elements) {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// Chrome determineNaturalSize </span></span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> imageUsage;</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">determineNaturalSize</span>(<span class=\"hljs-params\">url</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> img = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Image</span>();</span><br><span class=\"line\">    img.<span class=\"title function_\">addEventListener</span>(<span class=\"hljs-string\">\"error\"</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">_</span>) =&gt;</span></span><br><span class=\"line\">      <span class=\"title function_\">reject</span>(<span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"hljs-string\">\"determineNaturalSize failed img load\"</span>))</span><br><span class=\"line\">    );</span><br><span class=\"line\">    img.<span class=\"title function_\">addEventListener</span>(<span class=\"hljs-string\">\"load\"</span>, <span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>({</span><br><span class=\"line\">        <span class=\"hljs-attr\">naturalWidth</span>: img.<span class=\"hljs-property\">naturalWidth</span>,</span><br><span class=\"line\">        <span class=\"hljs-attr\">naturalHeight</span>: img.<span class=\"hljs-property\">naturalHeight</span>,</span><br><span class=\"line\">      });</span><br><span class=\"line\">    });</span><br><span class=\"line\"></span><br><span class=\"line\">    img.<span class=\"hljs-property\">src</span> = url;</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p> afterPass  beforePass <code>loadData</code></p>\n<p> ImageElements </p>\n<ul>\n<li></li>\n<li>expression driver.evaluateAsync  Chrome, </li>\n<li> 50 </li>\n<li>elements  top50Images imageUsage</li>\n</ul>\n<p><strong> JavaScript  <code>driver.evaluateAsync</code>  Chrome </strong></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> lighthouse-core  audits  gather  audit,</p>\n<p><img src=\"/images/lighthouse/audits.png\" alt=\"audits\"></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">//  lighthouse-core/index.js </span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> auditResults = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">Runner</span>.<span class=\"title function_\">_runAudits</span>(</span><br><span class=\"line\">  settings,</span><br><span class=\"line\">  runOpts.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">audits</span>,</span><br><span class=\"line\">  artifacts, <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  lighthouseRunWarnings</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">_runAudits</span>(<span class=\"hljs-params\">settings, audits, artifacts, runWarnings</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// audits</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> auditDefn <span class=\"hljs-keyword\">of</span> audits) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> auditResult = <span class=\"hljs-keyword\">await</span> <span class=\"title class_\">Runner</span>.<span class=\"title function_\">_runAudit</span>(</span><br><span class=\"line\">      auditDefn,</span><br><span class=\"line\">      artifacts,</span><br><span class=\"line\">      sharedAuditContext,</span><br><span class=\"line\">      runWarnings</span><br><span class=\"line\">    );</span><br><span class=\"line\">    auditResults.<span class=\"title function_\">push</span>(auditResult);</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> auditResults;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">_runAudit</span>(<span class=\"hljs-params\"></span></span><br><span class=\"line\"><span class=\"hljs-params\">  auditDefn,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  artifacts,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  sharedAuditContext,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  runWarnings</span></span><br><span class=\"line\"><span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> audit = auditDefn.<span class=\"hljs-property\">implementation</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> auditResult;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> auditOptions = <span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>(</span><br><span class=\"line\">    {},</span><br><span class=\"line\">    audit.<span class=\"hljs-property\">defaultOptions</span>,</span><br><span class=\"line\">    auditDefn.<span class=\"hljs-property\">options</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> auditContext = {</span><br><span class=\"line\">    <span class=\"hljs-attr\">options</span>: auditOptions,</span><br><span class=\"line\">    ...sharedAuditContext,</span><br><span class=\"line\">  };</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  audit </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> product = <span class=\"hljs-keyword\">await</span> audit.<span class=\"title function_\">audit</span>(narrowedArtifacts, auditContext);</span><br><span class=\"line\"></span><br><span class=\"line\">  auditResult = <span class=\"title class_\">Audit</span>.<span class=\"title function_\">generateAuditResult</span>(audit, product);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> auditResult;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Audit</span> {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// Audit  audit </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">static</span> <span class=\"title function_\">audit</span>(<span class=\"hljs-params\">artifacts, context</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"hljs-string\">\"audit() method must be overriden\"</span>);</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// /audits/image-size-responsive.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">ImageSizeResponsive</span> <span class=\"hljs-keyword\">extends</span> <span class=\"title class_ inherited__\">Audit</span> {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">static</span> <span class=\"title function_\">audit</span>(<span class=\"hljs-params\">artifacts</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> <span class=\"variable constant_\">DPR</span> = artifacts.<span class=\"hljs-property\">ViewportDimensions</span>.<span class=\"hljs-property\">devicePixelRatio</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> results = <span class=\"title class_\">Array</span>.<span class=\"title function_\">from</span>(artifacts.<span class=\"hljs-property\">ImageElements</span>) <span class=\"hljs-comment\">//  gather ImageElements</span></span><br><span class=\"line\">      .<span class=\"title function_\">filter</span>(isCandidate) <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      .<span class=\"title function_\">filter</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">image</span> =&gt;</span> !<span class=\"title function_\">imageHasRightSize</span>(image, <span class=\"variable constant_\">DPR</span>)) <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      .<span class=\"title function_\">filter</span>(</span><br><span class=\"line\">        <span class=\"hljs-function\"><span class=\"hljs-params\">image</span> =&gt;</span> <span class=\"title function_\">isVisible</span>(image.<span class=\"hljs-property\">clientRect</span>, artifacts.<span class=\"hljs-property\">ViewportDimensions</span>) <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      )</span><br><span class=\"line\">      .<span class=\"title function_\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">image</span> =&gt;</span> <span class=\"title function_\">getResult</span>(image, <span class=\"variable constant_\">DPR</span>)); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> headings = [</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    ];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> finalResults = <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// true</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">//  audits  score  true </span></span><br><span class=\"line\">      <span class=\"hljs-attr\">score</span>: <span class=\"title class_\">Number</span>(results.<span class=\"hljs-property\">length</span> === <span class=\"hljs-number\">0</span>),</span><br><span class=\"line\">      <span class=\"hljs-attr\">details</span>: <span class=\"title class_\">Audit</span>.<span class=\"title function_\">makeTableDetails</span>(headings, finalResults)</span><br><span class=\"line\">    };</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>gather  audit  2  audit  gather 2 audit  artifacts  gather </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Lighthouse  puppeteer  gather  audit  gather  audit  Driver  DevTools  Chrome </p>\n</body></html>","_categories":[],"_tags":[{"name":"JavaScript","path":"tags/JavaScript/"},{"name":"","path":"tags//"},{"name":"Web","path":"tags/Web/"}],"excerpt":"<html><head></head><body><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>  CI </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>First Contentful Paint</strong> canvas  SVG <em></em></p>\n<p><strong>First Meaningful Paint</strong><em></em></p>\n<p><strong>First CPU Idle</strong> input </p>\n<p><strong>Time to Interactive</strong></p>\n<br>\n\n<h2 id=\"Lighthouse-\"><a href=\"#Lighthouse-\" class=\"headerlink\" title=\"Lighthouse \"></a>Lighthouse </h2><blockquote>\n<p>  Chrome   Lighthouse </p>\n</blockquote>\n<p><img src=\"/images/lighthouse/report.png\" alt=\"Lighthouse \"></p></body></html>","more":"<br/>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"/images/lighthouse/architecture.png\" alt=\"Lighthouse \"></p>\n<p><strong>Driver</strong>  Chrome </p>\n<p><strong>Gatherers</strong>  Audit</p>\n<p><strong>Artifacts</strong>  Gatherers </p>\n<p><strong>Audit</strong> &#x2F;&#x2F; Artifacts <em>Lighthouse </em></p>\n<p><strong>Report</strong>  Lighthouse </p>\n<p><strong>Lighthouse  Driver  DevTools Protocol  Chrome  Gatherers artifacts, Audits  LHR  HTML </strong></p>\n<h3 id=\"Lighthouse-CI\"><a href=\"#Lighthouse-CI\" class=\"headerlink\" title=\"Lighthouse CI\"></a>Lighthouse CI</h3><p></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">CI</span></span><br><span class=\"line\"><span class=\"attr\">on:</span> [<span class=\"string\">push</span>]</span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\">  <span class=\"attr\">lighthouseci:</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">uses:</span> <span class=\"string\">actions/setup-node@v1</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">run:</span> <span class=\"string\">npm</span> <span class=\"string\">install</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">npm</span> <span class=\"string\">install</span> <span class=\"string\">-g</span> <span class=\"string\">@lhci/cli@0.4.x</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">run:</span> <span class=\"string\">npm</span> <span class=\"string\">run</span> <span class=\"string\">build</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">run:</span> <span class=\"string\">lhci</span> <span class=\"string\">autorun</span> <span class=\"string\">--upload.target=temporary-public-storage</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p><strong>npm run build</strong>  dist </p>\n</li>\n<li><p><strong>lhci autorun</strong> <code>healthcheck</code><code>collect</code><code>assert</code><code>upload</code></p>\n</li>\n</ul>\n<h3 id=\"collect-\"><a href=\"#collect-\" class=\"headerlink\" title=\"collect \"></a>collect </h3><blockquote>\n<p><em>@lhci&#x2F;cli  0.4.x</em></p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// autorun</span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">runCommand</span>(<span class=\"params\">options</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">//  healthcheck</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> healthcheckStatus = <span class=\"title function_\">runChildCommand</span>(<span class=\"string\">&quot;healthcheck&quot;</span>, [</span><br><span class=\"line\">    ...defaultFlags,</span><br><span class=\"line\">    <span class=\"string\">&quot;--fatal&quot;</span>,</span><br><span class=\"line\">  ]).<span class=\"property\">status</span>;</span><br><span class=\"line\">  <span class=\"comment\">//  collect</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> collectStatus = <span class=\"title function_\">runChildCommand</span>(<span class=\"string\">&quot;collect&quot;</span>, [</span><br><span class=\"line\">    ...defaultFlags,</span><br><span class=\"line\">    ...collectArgs,</span><br><span class=\"line\">  ]).<span class=\"property\">status</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  assert   assert    upload </span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (</span><br><span class=\"line\">    ciConfiguration.<span class=\"property\">assert</span> ||</span><br><span class=\"line\">    (!ciConfiguration.<span class=\"property\">assert</span> &amp;&amp; !ciConfiguration.<span class=\"property\">upload</span>)</span><br><span class=\"line\">  ) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> assertStatus = <span class=\"title function_\">runChildCommand</span>(<span class=\"string\">&quot;assert&quot;</span>, [</span><br><span class=\"line\">      ...defaultFlags,</span><br><span class=\"line\">      ...assertArgs,</span><br><span class=\"line\">    ]).<span class=\"property\">status</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  upload   upload  </span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ciConfiguration.<span class=\"property\">upload</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> uploadStatus = <span class=\"title function_\">runChildCommand</span>(<span class=\"string\">&quot;upload&quot;</span>, defaultFlags).<span class=\"property\">status</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (options.<span class=\"property\">failOnUploadFailure</span> &amp;&amp; uploadStatus !== <span class=\"number\">0</span>)</span><br><span class=\"line\">      process.<span class=\"title function_\">exit</span>(uploadStatus);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (uploadStatus !== <span class=\"number\">0</span>)</span><br><span class=\"line\">      process.<span class=\"property\">stderr</span>.<span class=\"title function_\">write</span>(<span class=\"string\">`WARNING: upload command failed.\\n`</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> <code>autorun</code> </p>\n<ul>\n<li>healthcheck  Chrome</li>\n<li>collect </li>\n<li>assert </li>\n<li>upload  <code>temporary-public-storage</code> google </li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">runCommand</span>(<span class=\"params\">options</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!options.<span class=\"property\">additive</span>) <span class=\"title function_\">clearSavedReportsAndLHRs</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">checkIgnoredChromeFlagsOption</span>(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> puppeteer = <span class=\"keyword\">new</span> <span class=\"title class_\">PuppeteerManager</span>(options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  staticDistDir distbuildpublic--static-dist-dir</span></span><br><span class=\"line\">  <span class=\"comment\">// staticDistDir</span></span><br><span class=\"line\">  <span class=\"comment\">//  =&gt;  express server </span></span><br><span class=\"line\">  <span class=\"comment\">//  =&gt;  startServerCommand</span></span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> &#123; urls, close &#125; = <span class=\"keyword\">await</span> <span class=\"title function_\">startServerAndDetermineUrls</span>(options);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> url <span class=\"keyword\">of</span> urls) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//  puppeteerScript </span></span><br><span class=\"line\">    <span class=\"keyword\">await</span> puppeteer.<span class=\"title function_\">invokePuppeteerScriptForUrl</span>(url);</span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"keyword\">await</span> <span class=\"title function_\">runOnUrl</span>(url, options, &#123; puppeteer &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">runOnUrl</span>(<span class=\"params\">url, options, context</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> runner = <span class=\"title function_\">getRunner</span>(options); <span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 3</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; options.<span class=\"property\">numberOfRuns</span>; i++) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Node.js  lighthouse-cli</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> lhr = <span class=\"keyword\">await</span> runner.<span class=\"title function_\">runUntilSuccess</span>(url, &#123;</span><br><span class=\"line\">      ...options,</span><br><span class=\"line\">      settings,</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"title function_\">saveLHR</span>(lhr); <span class=\"comment\">//  lighthouse result </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><a href=\"https://github.com/puppeteer/puppeteer\">puppeteer</a> DevTools Protocol  Headless Chrome  Node.js </li>\n<li>numberOfRuns  3 3  Node.js  .lighthouseci  3  lhr-xxx.json  lhr-xxx.html  assertion-results.json </li>\n<li>runUntilSuccess  lighthouse-cli </li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lighthouse-cli </span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">runLighthouse</span>(<span class=\"params\">url, flags, config</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> launchedChrome;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  chrome-launcher  headless Chrome</span></span><br><span class=\"line\">  launchedChrome = <span class=\"keyword\">await</span> <span class=\"title function_\">getDebuggableChrome</span>(flags);</span><br><span class=\"line\">  flags.<span class=\"property\">port</span> = launchedChrome.<span class=\"property\">port</span>; <span class=\"comment\">// Chrome websocket </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// lighthouse-core/index.js</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> runnerResult = <span class=\"keyword\">await</span> <span class=\"title function_\">lighthouse</span>(url, flags, config);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (runnerResult) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">await</span> <span class=\"title function_\">saveResults</span>(runnerResult, flags);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> runnerResult;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> lighthouse-cli  headless Chrome Chrome, lighthouse-core </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lighthouse-core/index.js</span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">lighthouse</span>(<span class=\"params\">url, flags = &#123;&#125;, configJSON, connection</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"comment\">// Gatherer3beforePasspassafterPass</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> config = <span class=\"title function_\">generateConfig</span>(configJSON, flags);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ChromeProtocol  Chrome  websocket</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> connection =</span><br><span class=\"line\">    connection || <span class=\"keyword\">new</span> <span class=\"title class_\">ChromeProtocol</span>(flags.<span class=\"property\">port</span>, flags.<span class=\"property\">hostname</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  Gather  Audit </span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"title class_\">Runner</span>.<span class=\"title function_\">run</span>(connection, &#123; url, config &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">run</span>(<span class=\"params\">connection, runOpts</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">//  artifacts</span></span><br><span class=\"line\">  artifacts = <span class=\"keyword\">await</span> <span class=\"title class_\">Runner</span>.<span class=\"title function_\">_gatherArtifactsFromBrowser</span>(</span><br><span class=\"line\">    requestedUrl,</span><br><span class=\"line\">    runOpts,</span><br><span class=\"line\">    connection</span><br><span class=\"line\">  );</span><br><span class=\"line\">  <span class=\"comment\">// artifacts audits</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> auditResults = <span class=\"keyword\">await</span> <span class=\"title class_\">Runner</span>.<span class=\"title function_\">_runAudits</span>(</span><br><span class=\"line\">    settings,</span><br><span class=\"line\">    runOpts.<span class=\"property\">config</span>.<span class=\"property\">audits</span>,</span><br><span class=\"line\">    artifacts,</span><br><span class=\"line\">    lighthouseRunWarnings</span><br><span class=\"line\">  );</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> lhr = &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  lhr </span></span><br><span class=\"line\">  lhr.<span class=\"property\">i18n</span>.<span class=\"property\">icuMessagePaths</span> = i18n.<span class=\"title function_\">replaceIcuMessageInstanceIds</span>(</span><br><span class=\"line\">    lhr,</span><br><span class=\"line\">    settings.<span class=\"property\">locale</span></span><br><span class=\"line\">  );</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> report = <span class=\"title function_\">generateReport</span>(lhr, settings.<span class=\"property\">output</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123; lhr, artifacts, report &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">_gatherArtifactsFromBrowser</span>(<span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">  requestedUrl,</span></span><br><span class=\"line\"><span class=\"params\">  runnerOpts,</span></span><br><span class=\"line\"><span class=\"params\">  connection</span></span><br><span class=\"line\"><span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> driver = runnerOpts.<span class=\"property\">driverMock</span> || <span class=\"keyword\">new</span> <span class=\"title class_\">Driver</span>(connection);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> gatherOpts = &#123;</span><br><span class=\"line\">    driver,</span><br><span class=\"line\">    requestedUrl,</span><br><span class=\"line\">    <span class=\"attr\">settings</span>: runnerOpts.<span class=\"property\">config</span>.<span class=\"property\">settings</span>,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  <span class=\"comment\">//  Gather artifacts</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> artifacts = <span class=\"keyword\">await</span> <span class=\"title class_\">GatherRunner</span>.<span class=\"title function_\">run</span>(</span><br><span class=\"line\">    runnerOpts.<span class=\"property\">config</span>.<span class=\"property\">passes</span>,</span><br><span class=\"line\">    gatherOpts</span><br><span class=\"line\">  );</span><br><span class=\"line\">  <span class=\"keyword\">return</span> artifacts;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>artifactsaudits</p>\n<h4 id=\"-artifacts-\"><a href=\"#-artifacts-\" class=\"headerlink\" title=\" artifacts \"></a> artifacts </h4><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// gather-runner.js</span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">run</span>(<span class=\"params\">passConfigs, options</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> artifacts = &#123;&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> driver = options.<span class=\"property\">driver</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  Chrome </span></span><br><span class=\"line\">  <span class=\"keyword\">await</span> driver.<span class=\"title function_\">connect</span>();</span><br><span class=\"line\">  <span class=\"comment\">//  about:blank </span></span><br><span class=\"line\">  <span class=\"keyword\">await</span> <span class=\"title class_\">GatherRunner</span>.<span class=\"title function_\">loadBlank</span>(driver);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  artifacts</span></span><br><span class=\"line\">  <span class=\"comment\">// userAgentemulate</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> baseArtifacts = <span class=\"keyword\">await</span> <span class=\"title class_\">GatherRunner</span>.<span class=\"title function_\">initializeBaseArtifacts</span>(options);</span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  baseArtifacts.<span class=\"property\">BenchmarkIndex</span> = <span class=\"keyword\">await</span> options.<span class=\"property\">driver</span>.<span class=\"title function_\">getBenchmarkIndex</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">await</span> <span class=\"title class_\">GatherRunner</span>.<span class=\"title function_\">setupDriver</span>(driver, options);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// passConfigs  Gather</span></span><br><span class=\"line\">  <span class=\"comment\">// runPass</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> passConfig <span class=\"keyword\">of</span> passConfigs) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> passContext = &#123;</span><br><span class=\"line\">      driver,</span><br><span class=\"line\">      <span class=\"attr\">url</span>: options.<span class=\"property\">requestedUrl</span>,</span><br><span class=\"line\">      <span class=\"attr\">settings</span>: options.<span class=\"property\">settings</span>,</span><br><span class=\"line\">      passConfig,</span><br><span class=\"line\">      baseArtifacts,</span><br><span class=\"line\">      <span class=\"title class_\">LighthouseRunWarnings</span>: baseArtifacts.<span class=\"property\">LighthouseRunWarnings</span>,</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"comment\">// loadBlank =&gt; setupPassNetwork =&gt; cleanBrowserCaches</span></span><br><span class=\"line\">    <span class=\"comment\">// =&gt; beforePass // gather </span></span><br><span class=\"line\">    <span class=\"comment\">// =&gt; beginRecording</span></span><br><span class=\"line\">    <span class=\"comment\">// =&gt; loadPage</span></span><br><span class=\"line\">    <span class=\"comment\">// =&gt; pass // gather </span></span><br><span class=\"line\">    <span class=\"comment\">// =&gt; endRecording</span></span><br><span class=\"line\">    <span class=\"comment\">// =&gt; afterPass // gather </span></span><br><span class=\"line\">    <span class=\"comment\">// =&gt; collectArtifacts</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> passResults = <span class=\"keyword\">await</span> <span class=\"title class_\">GatherRunner</span>.<span class=\"title function_\">runPass</span>(passContext);</span><br><span class=\"line\">    <span class=\"comment\">//  artifacts </span></span><br><span class=\"line\">    <span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>(artifacts, passResults.<span class=\"property\">artifacts</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123; ...baseArtifacts, ...artifacts &#125;; <span class=\"comment\">// Cast to drop Partial&lt;&gt;.</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Gatherer </span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Gatherer</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">get</span> <span class=\"title function_\">name</span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"property\">constructor</span>.<span class=\"property\">name</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"title function_\">beforePass</span>(<span class=\"params\">passContext</span>) &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">pass</span>(<span class=\"params\">passContext</span>) &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">afterPass</span>(<span class=\"params\">passContext, loadData</span>) &#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>runPass  Lighthouse loadBlanksetupPassNetworkcleanBrowserCachesbeforePassbeginRecording devtoolsLog  tracepassendRecording devtoolsLog  traceafterPasscollectArtifactsbeforePasspass  afterPass  gather  artifacts  lighthouse-core  gather&#x2F;gatherers </p>\n<p><img src=\"/images/lighthouse/gatherers.png\" alt=\"gatherers\"></p>\n<p> <code>ImageElements</code>  afterPass </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// image-elements.js</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ImageElements</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">Gatherer</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">async</span> <span class=\"title function_\">afterPass</span>(<span class=\"params\">passContext, loadData</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> driver = passContext.<span class=\"property\">driver</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> indexedNetworkRecords = loadData.<span class=\"property\">networkRecords</span>.<span class=\"title function_\">reduce</span>(</span><br><span class=\"line\">      <span class=\"function\">(<span class=\"params\">map, record</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (</span><br><span class=\"line\">          <span class=\"regexp\">/^image/</span>.<span class=\"title function_\">test</span>(record.<span class=\"property\">mimeType</span>) &amp;&amp;</span><br><span class=\"line\">          record.<span class=\"property\">finished</span> &amp;&amp;</span><br><span class=\"line\">          record.<span class=\"property\">statusCode</span> === <span class=\"number\">200</span></span><br><span class=\"line\">        ) &#123;</span><br><span class=\"line\">          map[record.<span class=\"property\">url</span>] = record;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> map;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> expression = <span class=\"string\">`(function() &#123;</span></span><br><span class=\"line\"><span class=\"string\">      <span class=\"subst\">$&#123;pageFunctions.getElementsInDocumentString&#125;</span>; // define function on page</span></span><br><span class=\"line\"><span class=\"string\">      <span class=\"subst\">$&#123;getClientRect.toString()&#125;</span>;</span></span><br><span class=\"line\"><span class=\"string\">      <span class=\"subst\">$&#123;getHTMLImages.toString()&#125;</span>;</span></span><br><span class=\"line\"><span class=\"string\">      <span class=\"subst\">$&#123;getCSSImages.toString()&#125;</span>;</span></span><br><span class=\"line\"><span class=\"string\">      <span class=\"subst\">$&#123;collectImageElementInfo.toString()&#125;</span>;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">      return collectImageElementInfo();</span></span><br><span class=\"line\"><span class=\"string\">    &#125;)()`</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> elements = <span class=\"keyword\">await</span> driver.evaluateAsync(expression);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> top50Images = <span class=\"title class_\">Object</span>.<span class=\"title function_\">values</span>(indexedNetworkRecords)</span><br><span class=\"line\">      .<span class=\"title function_\">sort</span>(<span class=\"function\">(<span class=\"params\">a, b</span>) =&gt;</span> b.<span class=\"property\">resourceSize</span> - a.<span class=\"property\">resourceSize</span>)</span><br><span class=\"line\">      .<span class=\"title function_\">slice</span>(<span class=\"number\">0</span>, <span class=\"number\">50</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> imageUsage = [];</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> element <span class=\"keyword\">of</span> elements) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">      <span class=\"comment\">// Chrome determineNaturalSize </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> imageUsage;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">determineNaturalSize</span>(<span class=\"params\">url</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> img = <span class=\"keyword\">new</span> <span class=\"title class_\">Image</span>();</span><br><span class=\"line\">    img.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;error&quot;</span>, <span class=\"function\">(<span class=\"params\">_</span>) =&gt;</span></span><br><span class=\"line\">      <span class=\"title function_\">reject</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"string\">&quot;determineNaturalSize failed img load&quot;</span>))</span><br><span class=\"line\">    );</span><br><span class=\"line\">    img.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;load&quot;</span>, <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(&#123;</span><br><span class=\"line\">        <span class=\"attr\">naturalWidth</span>: img.<span class=\"property\">naturalWidth</span>,</span><br><span class=\"line\">        <span class=\"attr\">naturalHeight</span>: img.<span class=\"property\">naturalHeight</span>,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    img.<span class=\"property\">src</span> = url;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> afterPass  beforePass <code>loadData</code></p>\n<p> ImageElements </p>\n<ul>\n<li></li>\n<li>expression driver.evaluateAsync  Chrome, </li>\n<li> 50 </li>\n<li>elements  top50Images imageUsage</li>\n</ul>\n<p><strong> JavaScript  <code>driver.evaluateAsync</code>  Chrome </strong></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> lighthouse-core  audits  gather  audit,</p>\n<p><img src=\"/images/lighthouse/audits.png\" alt=\"audits\"></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  lighthouse-core/index.js </span></span><br><span class=\"line\"><span class=\"keyword\">const</span> auditResults = <span class=\"keyword\">await</span> <span class=\"title class_\">Runner</span>.<span class=\"title function_\">_runAudits</span>(</span><br><span class=\"line\">  settings,</span><br><span class=\"line\">  runOpts.<span class=\"property\">config</span>.<span class=\"property\">audits</span>,</span><br><span class=\"line\">  artifacts, <span class=\"comment\">// </span></span><br><span class=\"line\">  lighthouseRunWarnings</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">_runAudits</span>(<span class=\"params\">settings, audits, artifacts, runWarnings</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// audits</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> auditDefn <span class=\"keyword\">of</span> audits) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> auditResult = <span class=\"keyword\">await</span> <span class=\"title class_\">Runner</span>.<span class=\"title function_\">_runAudit</span>(</span><br><span class=\"line\">      auditDefn,</span><br><span class=\"line\">      artifacts,</span><br><span class=\"line\">      sharedAuditContext,</span><br><span class=\"line\">      runWarnings</span><br><span class=\"line\">    );</span><br><span class=\"line\">    auditResults.<span class=\"title function_\">push</span>(auditResult);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> auditResults;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">_runAudit</span>(<span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">  auditDefn,</span></span><br><span class=\"line\"><span class=\"params\">  artifacts,</span></span><br><span class=\"line\"><span class=\"params\">  sharedAuditContext,</span></span><br><span class=\"line\"><span class=\"params\">  runWarnings</span></span><br><span class=\"line\"><span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> audit = auditDefn.<span class=\"property\">implementation</span>;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> auditResult;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> auditOptions = <span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>(</span><br><span class=\"line\">    &#123;&#125;,</span><br><span class=\"line\">    audit.<span class=\"property\">defaultOptions</span>,</span><br><span class=\"line\">    auditDefn.<span class=\"property\">options</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  <span class=\"keyword\">const</span> auditContext = &#123;</span><br><span class=\"line\">    <span class=\"attr\">options</span>: auditOptions,</span><br><span class=\"line\">    ...sharedAuditContext,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  <span class=\"comment\">//  audit </span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> product = <span class=\"keyword\">await</span> audit.<span class=\"title function_\">audit</span>(narrowedArtifacts, auditContext);</span><br><span class=\"line\"></span><br><span class=\"line\">  auditResult = <span class=\"title class_\">Audit</span>.<span class=\"title function_\">generateAuditResult</span>(audit, product);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> auditResult;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Audit</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// Audit  audit </span></span><br><span class=\"line\">  <span class=\"keyword\">static</span> <span class=\"title function_\">audit</span>(<span class=\"params\">artifacts, context</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"string\">&quot;audit() method must be overriden&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// /audits/image-size-responsive.js</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ImageSizeResponsive</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">Audit</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">static</span> <span class=\"title function_\">audit</span>(<span class=\"params\">artifacts</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"variable constant_\">DPR</span> = artifacts.<span class=\"property\">ViewportDimensions</span>.<span class=\"property\">devicePixelRatio</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> results = <span class=\"title class_\">Array</span>.<span class=\"title function_\">from</span>(artifacts.<span class=\"property\">ImageElements</span>) <span class=\"comment\">//  gather ImageElements</span></span><br><span class=\"line\">      .<span class=\"title function_\">filter</span>(isCandidate) <span class=\"comment\">// </span></span><br><span class=\"line\">      .<span class=\"title function_\">filter</span>(<span class=\"function\"><span class=\"params\">image</span> =&gt;</span> !<span class=\"title function_\">imageHasRightSize</span>(image, <span class=\"variable constant_\">DPR</span>)) <span class=\"comment\">// </span></span><br><span class=\"line\">      .<span class=\"title function_\">filter</span>(</span><br><span class=\"line\">        <span class=\"function\"><span class=\"params\">image</span> =&gt;</span> <span class=\"title function_\">isVisible</span>(image.<span class=\"property\">clientRect</span>, artifacts.<span class=\"property\">ViewportDimensions</span>) <span class=\"comment\">// </span></span><br><span class=\"line\">      )</span><br><span class=\"line\">      .<span class=\"title function_\">map</span>(<span class=\"function\"><span class=\"params\">image</span> =&gt;</span> <span class=\"title function_\">getResult</span>(image, <span class=\"variable constant_\">DPR</span>)); <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> headings = [</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    ];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> finalResults = <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// true</span></span><br><span class=\"line\">      <span class=\"comment\">//  audits  score  true </span></span><br><span class=\"line\">      <span class=\"attr\">score</span>: <span class=\"title class_\">Number</span>(results.<span class=\"property\">length</span> === <span class=\"number\">0</span>),</span><br><span class=\"line\">      <span class=\"attr\">details</span>: <span class=\"title class_\">Audit</span>.<span class=\"title function_\">makeTableDetails</span>(headings, finalResults)</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>gather  audit  2  audit  gather 2 audit  artifacts  gather </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Lighthouse  puppeteer  gather  audit  gather  audit  Driver  DevTools  Chrome </p>"},{"title":"Node.js ","keywords":"Express,Gateway,Node.js ","description":"BFFNode.jsExpress GatewayExpress","date":"2020-04-02T23:17:29.367Z","_content":"\n[ Node.js  CPU ](https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/)**TCP Server**\n\n<!-- more -->\n\n![1.0](/images/monitor-hub/image-20200403185942130.png)\n\n****\n\n Docker  Node.js  Egg.js `Helper Process`\n\n Node.js `Client` TCP `Server`Client CPUEventLoopGC  Server Server  ES \n\n`Admin Web` CPU  ClientClient `FS` Admin Web  FS \n\n**Q:**\n\n- `ES``FS`\n\n**Q:**\n\n- \n-  Server\n- \n\n**Q:**\n\n-  Server \n-  Server  Client `` EurekaConsul  ClientServer  Admin Web \n-  EurekaConsul  Admin Web  Client Server \n-  Helper Process `Worker Process` Client Client  Egg.js  Master  Worker  Helper Process Egg.js  Agent \n-  Client  Helper Process  Master  Helper Process  Client  Server Master  Client  Helper Process  Docker \n-  Admin WebXXXX Client  XXXX  FS  RMQ \n-  Admin Web  Client  Redis  Redis\n\n![2.0](/images/monitor-hub/image-20200403210837664.png)\n\n****Server Admin Web  Client  Egg.js \n","source":"_posts/monitor-hub.md","raw":"---\ntitle: Node.js \ncategory: JavaScript\nkeywords: Express,Gateway,Node.js \ndescription: BFFNode.jsExpress GatewayExpress\ntags:\n  - \n  - Node.js\n  - JavaScript\ndate: 2020-04-03T07:17:29.367Z\n---\n\n[ Node.js  CPU ](https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/)**TCP Server**\n\n<!-- more -->\n\n![1.0](/images/monitor-hub/image-20200403185942130.png)\n\n****\n\n Docker  Node.js  Egg.js `Helper Process`\n\n Node.js `Client` TCP `Server`Client CPUEventLoopGC  Server Server  ES \n\n`Admin Web` CPU  ClientClient `FS` Admin Web  FS \n\n**Q:**\n\n- `ES``FS`\n\n**Q:**\n\n- \n-  Server\n- \n\n**Q:**\n\n-  Server \n-  Server  Client `` EurekaConsul  ClientServer  Admin Web \n-  EurekaConsul  Admin Web  Client Server \n-  Helper Process `Worker Process` Client Client  Egg.js  Master  Worker  Helper Process Egg.js  Agent \n-  Client  Helper Process  Master  Helper Process  Client  Server Master  Client  Helper Process  Docker \n-  Admin WebXXXX Client  XXXX  FS  RMQ \n-  Admin Web  Client  Redis  Redis\n\n![2.0](/images/monitor-hub/image-20200403210837664.png)\n\n****Server Admin Web  Client  Egg.js \n","slug":"monitor-hub","published":1,"updated":"2024-04-08T13:38:53.982Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45we3000p18fdalx87cvb","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p><a href=\"https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/\"> Node.js  CPU </a><strong>TCP Server</strong></p>\n<span id=\"more\"></span>\n\n<p><img src=\"/images/monitor-hub/image-20200403185942130.png\" alt=\"1.0\"></p>\n<p><strong></strong></p>\n<p> Docker  Node.js  Egg.js <code>Helper Process</code></p>\n<p> Node.js <code>Client</code> TCP <code>Server</code>Client CPUEventLoopGC  Server Server  ES </p>\n<p><code>Admin Web</code> CPU  ClientClient <code>FS</code> Admin Web  FS </p>\n<p><strong>Q:</strong></p>\n<ul>\n<li><code>ES</code><code>FS</code></li>\n</ul>\n<p><strong>Q:</strong></p>\n<ul>\n<li></li>\n<li> Server</li>\n<li></li>\n</ul>\n<p><strong>Q:</strong></p>\n<ul>\n<li> Server </li>\n<li> Server  Client <code></code> EurekaConsul  ClientServer  Admin Web </li>\n<li> EurekaConsul  Admin Web  Client Server </li>\n<li> Helper Process <code>Worker Process</code> Client Client  Egg.js  Master  Worker  Helper Process Egg.js  Agent </li>\n<li> Client  Helper Process  Master  Helper Process  Client  Server Master  Client  Helper Process  Docker </li>\n<li> Admin WebXXXX Client  XXXX  FS  RMQ </li>\n<li> Admin Web  Client  Redis  Redis</li>\n</ul>\n<p><img src=\"/images/monitor-hub/image-20200403210837664.png\" alt=\"2.0\"></p>\n<p><strong></strong>Server Admin Web  Client  Egg.js </p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"},{"name":"","path":"tags//"}],"excerpt":"<html><head></head><body><p><a href=\"https://miser.github.io/2020/02/21/node-perf-heapdump-flame-graph/\"> Node.js  CPU </a><strong>TCP Server</strong></p></body></html>","more":"<p><img src=\"/images/monitor-hub/image-20200403185942130.png\" alt=\"1.0\"></p>\n<p><strong></strong></p>\n<p> Docker  Node.js  Egg.js <code>Helper Process</code></p>\n<p> Node.js <code>Client</code> TCP <code>Server</code>Client CPUEventLoopGC  Server Server  ES </p>\n<p><code>Admin Web</code> CPU  ClientClient <code>FS</code> Admin Web  FS </p>\n<p><strong>Q:</strong></p>\n<ul>\n<li><code>ES</code><code>FS</code></li>\n</ul>\n<p><strong>Q:</strong></p>\n<ul>\n<li></li>\n<li> Server</li>\n<li></li>\n</ul>\n<p><strong>Q:</strong></p>\n<ul>\n<li> Server </li>\n<li> Server  Client <code></code> EurekaConsul  ClientServer  Admin Web </li>\n<li> EurekaConsul  Admin Web  Client Server </li>\n<li> Helper Process <code>Worker Process</code> Client Client  Egg.js  Master  Worker  Helper Process Egg.js  Agent </li>\n<li> Client  Helper Process  Master  Helper Process  Client  Server Master  Client  Helper Process  Docker </li>\n<li> Admin WebXXXX Client  XXXX  FS  RMQ </li>\n<li> Admin Web  Client  Redis  Redis</li>\n</ul>\n<p><img src=\"/images/monitor-hub/image-20200403210837664.png\" alt=\"2.0\"></p>\n<p><strong></strong>Server Admin Web  Client  Egg.js </p>"},{"title":"CSSJS","date":"2018-09-23T22:45:00.000Z","_content":"\n\n\n<!-- more -->\n\n## \n\n*localhostchrome 69*\n\n-- css\n  - css1.css 2 body { background-color: #444 }\n  - css2.css  body { font-size: 50px;font-weight: bold; }\n\n-- js\n  - js1.js 1 console.log(\"js1.js loaded\") \n  - js2.js  console.log(\"js2.js loaded\")\n  - js3.js 3 console.log(\"js2.js loaded\")\n\n-- image\n  - img1.png 3 js\n  - img2.png  nodejs\n\n\n\n\n```javascript\nconst Koa = require('koa')\nconst Router = require('koa-router')\nconst views = require('koa-views')\nconst fs = require('fs')\n\nconst app = new Koa()\nconst router = new Router()\n\napp.use(views(__dirname + '/views'))\n\nrouter.get('/', async (ctx, next) => {\n  await ctx.render('index.html')\n})\n\nrouter.get('/css1.css', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'text/css')\n    ctx.body = 'body { background-color: #444 }'\n    resolve()\n  }, 1000 * 2)\n}))\n\nrouter.get('/css2.css', async ctx => {\n  ctx.set('Content-Type', 'text/css')\n  ctx.body = 'body { font-size: 50px;font-weight: bold; }'\n})\n\nrouter.get('/js1.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js1.js loaded\")'\n    resolve()\n  }, 1000)\n}))\n\nrouter.get('/js2.js', async ctx => {\n  ctx.body = 'console.log(\"js2.js loaded\")'\n})\n\nrouter.get('/js3.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js3.js loaded\")'\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img1.png', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'image/png; charset=UTF-8')\n    ctx.body = fs.createReadStream('1.png')\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img2.png', async ctx => {\n  ctx.set('Content-Type', 'image/png; charset=UTF-8')\n  ctx.body = fs.createReadStream('2.png')\n})\n\napp\n  .use(router.routes())\n  .use(router.allowedMethods())\n\napp.listen(3000)\n```\n\n##  CSSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \napp\ntest: 1947.620849609375ms\n-->\n```\n\n app 2 test __CSSDOM__\n\n##  CSSJSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \njs1.js loaded\njs2.js loaded\n(index):17 test: 1921.02099609375ms\n-->\n```\n\nindex.htmlDOM2img1.png\n\njscss1cssjs2.jsjs1.jscss1.cssimg1.png1__CSSJSDOM__\n\n##  JSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \nnull\njs3.js loaded\ntest: 2943.9951171875ms\n-->\n```\n\njs3.js3 app null3 test __JSDOM__\n\n##  DOMDOMContentLoadedonLoad\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n    console.time('testDOMContentLoaded')\n    console.time('testonload')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n    window.onload = function () {\n      console.timeEnd('testonload')\n    }\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n\t<script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \njs1.js loaded\njs2.js loaded\ntest: 1955.489990234375ms\ntestDOMContentLoaded: 1956.044189453125ms\ntestonload: 2964.078857421875ms\n-->\n```\n\n testDOMContentLoaded 2testonload3__DOMContentLoadedjscssonload__\n\n##  script async \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script async type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3js\"async\",\n- testDOMContentLoaded \n- app\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\njs1.js\"async\"\n\n- el  null\n- js1.js loaded\n- testDOMContentLoaded 1\n- js2.js loaded\n- js3.js loaded\n\njs3.js\"async\"\n\n- el  null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\n__asyncjsasyncjsDOMContentLoadedasync__\n\n##  script defer \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n\n```\n\n3js\"defer\",\n\n- app\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\ndeferasync\n\njs1.js\"defer\"\n\n- el  null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\ndeferasync\n\njs3.js\"defer\"\n- js1.js loaded\n- js3.js loaded\n- js2.js loaded\n- testDOMContentLoaded 3\n\n__deferjsdeferjsdeferDOMContentLoadeddefer__\n\n##  script defer & async  \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script async defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3js\"async\",\n- testDOMContentLoaded \n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\nasyncdefer\n\n##  script\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\">\n    varhead = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 3; i++) {\n      varscript = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- testDOMContentLoaded \n- appEl \n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\njs1.jsjs2.jsjs3.js\n\nindex.html\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"js3.js\"></script>\n  <script type=\"text/javascript\">\n    varhead = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 2; i++) {\n      varscript = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- appEl  null \n- js3.js loaded \n- testDOMContentLoaded 3\n- js2.js loaded\n- js1.js loaded\n\n__scriptDOMContentLoaded__\n\n\n## \nCSSDOMJSDOMJSDOMscriptdefer & asyncDOMasync deferdeferscript","source":"_posts/js-css-image-loading.md","raw":"---\ntitle: CSSJS\ncategory: JavaScript\ndate: 2018-09-24T06:45:00.000Z\n---\n\n\n\n<!-- more -->\n\n## \n\n*localhostchrome 69*\n\n-- css\n  - css1.css 2 body { background-color: #444 }\n  - css2.css  body { font-size: 50px;font-weight: bold; }\n\n-- js\n  - js1.js 1 console.log(\"js1.js loaded\") \n  - js2.js  console.log(\"js2.js loaded\")\n  - js3.js 3 console.log(\"js2.js loaded\")\n\n-- image\n  - img1.png 3 js\n  - img2.png  nodejs\n\n\n\n\n```javascript\nconst Koa = require('koa')\nconst Router = require('koa-router')\nconst views = require('koa-views')\nconst fs = require('fs')\n\nconst app = new Koa()\nconst router = new Router()\n\napp.use(views(__dirname + '/views'))\n\nrouter.get('/', async (ctx, next) => {\n  await ctx.render('index.html')\n})\n\nrouter.get('/css1.css', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'text/css')\n    ctx.body = 'body { background-color: #444 }'\n    resolve()\n  }, 1000 * 2)\n}))\n\nrouter.get('/css2.css', async ctx => {\n  ctx.set('Content-Type', 'text/css')\n  ctx.body = 'body { font-size: 50px;font-weight: bold; }'\n})\n\nrouter.get('/js1.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js1.js loaded\")'\n    resolve()\n  }, 1000)\n}))\n\nrouter.get('/js2.js', async ctx => {\n  ctx.body = 'console.log(\"js2.js loaded\")'\n})\n\nrouter.get('/js3.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js3.js loaded\")'\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img1.png', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'image/png; charset=UTF-8')\n    ctx.body = fs.createReadStream('1.png')\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img2.png', async ctx => {\n  ctx.set('Content-Type', 'image/png; charset=UTF-8')\n  ctx.body = fs.createReadStream('2.png')\n})\n\napp\n  .use(router.routes())\n  .use(router.allowedMethods())\n\napp.listen(3000)\n```\n\n##  CSSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \napp\ntest: 1947.620849609375ms\n-->\n```\n\n app 2 test __CSSDOM__\n\n##  CSSJSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \njs1.js loaded\njs2.js loaded\n(index):17 test: 1921.02099609375ms\n-->\n```\n\nindex.htmlDOM2img1.png\n\njscss1cssjs2.jsjs1.jscss1.cssimg1.png1__CSSJSDOM__\n\n##  JSDOM\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \nnull\njs3.js loaded\ntest: 2943.9951171875ms\n-->\n```\n\njs3.js3 app null3 test __JSDOM__\n\n##  DOMDOMContentLoadedonLoad\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n    console.time('testDOMContentLoaded')\n    console.time('testonload')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n    window.onload = function () {\n      console.timeEnd('testonload')\n    }\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n\t<script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console \njs1.js loaded\njs2.js loaded\ntest: 1955.489990234375ms\ntestDOMContentLoaded: 1956.044189453125ms\ntestonload: 2964.078857421875ms\n-->\n```\n\n testDOMContentLoaded 2testonload3__DOMContentLoadedjscssonload__\n\n##  script async \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script async type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3js\"async\",\n- testDOMContentLoaded \n- app\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\njs1.js\"async\"\n\n- el  null\n- js1.js loaded\n- testDOMContentLoaded 1\n- js2.js loaded\n- js3.js loaded\n\njs3.js\"async\"\n\n- el  null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\n__asyncjsasyncjsDOMContentLoadedasync__\n\n##  script defer \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n\n```\n\n3js\"defer\",\n\n- app\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\ndeferasync\n\njs1.js\"defer\"\n\n- el  null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3\n\ndeferasync\n\njs3.js\"defer\"\n- js1.js loaded\n- js3.js loaded\n- js2.js loaded\n- testDOMContentLoaded 3\n\n__deferjsdeferjsdeferDOMContentLoadeddefer__\n\n##  script defer & async  \n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script async defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3js\"async\",\n- testDOMContentLoaded \n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\nasyncdefer\n\n##  script\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\">\n    varhead = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 3; i++) {\n      varscript = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- testDOMContentLoaded \n- appEl \n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\njs1.jsjs2.jsjs3.js\n\nindex.html\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"js3.js\"></script>\n  <script type=\"text/javascript\">\n    varhead = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 2; i++) {\n      varscript = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- appEl  null \n- js3.js loaded \n- testDOMContentLoaded 3\n- js2.js loaded\n- js1.js loaded\n\n__scriptDOMContentLoaded__\n\n\n## \nCSSDOMJSDOMJSDOMscriptdefer & asyncDOMasync deferdeferscript","slug":"js-css-image-loading","published":1,"updated":"2024-04-08T13:34:02.489Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45we5000r18fd128vfj3l","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p></p>\n<span id=\"more\"></span>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><em>localhostchrome 69</em></p>\n<p> css</p>\n<ul>\n<li>css1.css 2 body { background-color: #444 }</li>\n<li>css2.css  body { font-size: 50px;font-weight: bold; }</li>\n</ul>\n<p> js</p>\n<ul>\n<li>js1.js 1 console.log(js1.js loaded) </li>\n<li>js2.js  console.log(js2.js loaded)</li>\n<li>js3.js 3 console.log(js2.js loaded)</li>\n</ul>\n<p> image</p>\n<ul>\n<li>img1.png 3 js</li>\n<li>img2.png  nodejs</li>\n</ul>\n<p></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">Koa</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> <span class=\"title class_\">Router</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa-router'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> views = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa-views'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> fs = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'fs'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Koa</span>()</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> router = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Router</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">use</span>(<span class=\"title function_\">views</span>(__dirname + <span class=\"hljs-string\">'/views'</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"hljs-string\">'/'</span>, <span class=\"hljs-keyword\">async</span> (ctx, next) =&gt; {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">await</span> ctx.<span class=\"title function_\">render</span>(<span class=\"hljs-string\">'index.html'</span>)</span><br><span class=\"line\">})</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"hljs-string\">'/css1.css'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> {</span><br><span class=\"line\">  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    ctx.<span class=\"title function_\">set</span>(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'text/css'</span>)</span><br><span class=\"line\">    ctx.<span class=\"hljs-property\">body</span> = <span class=\"hljs-string\">'body { background-color: #444 }'</span></span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>()</span><br><span class=\"line\">  }, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">2</span>)</span><br><span class=\"line\">}))</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"hljs-string\">'/css2.css'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; {</span><br><span class=\"line\">  ctx.<span class=\"title function_\">set</span>(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'text/css'</span>)</span><br><span class=\"line\">  ctx.<span class=\"hljs-property\">body</span> = <span class=\"hljs-string\">'body { font-size: 50px;font-weight: bold; }'</span></span><br><span class=\"line\">})</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"hljs-string\">'/js1.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> {</span><br><span class=\"line\">  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    ctx.<span class=\"hljs-property\">body</span> = <span class=\"hljs-string\">'console.log(\"js1.js loaded\")'</span></span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>()</span><br><span class=\"line\">  }, <span class=\"hljs-number\">1000</span>)</span><br><span class=\"line\">}))</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"hljs-string\">'/js2.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; {</span><br><span class=\"line\">  ctx.<span class=\"hljs-property\">body</span> = <span class=\"hljs-string\">'console.log(\"js2.js loaded\")'</span></span><br><span class=\"line\">})</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"hljs-string\">'/js3.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> {</span><br><span class=\"line\">  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    ctx.<span class=\"hljs-property\">body</span> = <span class=\"hljs-string\">'console.log(\"js3.js loaded\")'</span></span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>()</span><br><span class=\"line\">  }, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">3</span>)</span><br><span class=\"line\">}))</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"hljs-string\">'/img1.png'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> {</span><br><span class=\"line\">  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    ctx.<span class=\"title function_\">set</span>(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">    ctx.<span class=\"hljs-property\">body</span> = fs.<span class=\"title function_\">createReadStream</span>(<span class=\"hljs-string\">'1.png'</span>)</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>()</span><br><span class=\"line\">  }, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">3</span>)</span><br><span class=\"line\">}))</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"hljs-string\">'/img2.png'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; {</span><br><span class=\"line\">  ctx.<span class=\"title function_\">set</span>(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">  ctx.<span class=\"hljs-property\">body</span> = fs.<span class=\"title function_\">createReadStream</span>(<span class=\"hljs-string\">'2.png'</span>)</span><br><span class=\"line\">})</span><br><span class=\"line\"></span><br><span class=\"line\">app</span><br><span class=\"line\">  .<span class=\"title function_\">use</span>(router.<span class=\"title function_\">routes</span>())</span><br><span class=\"line\">  .<span class=\"title function_\">use</span>(router.<span class=\"title function_\">allowedMethods</span>())</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">listen</span>(<span class=\"hljs-number\">3000</span>)</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"-CSSDOM\"><a href=\"#-CSSDOM\" class=\"headerlink\" title=\" CSSDOM\"></a> CSSDOM</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(el)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-number\">0</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">app</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 1947.620849609375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p> app 2 test __CSSDOM__</p>\n<h2 id=\"-CSSJSDOM\"><a href=\"#-CSSJSDOM\" class=\"headerlink\" title=\" CSSJSDOM\"></a> CSSJSDOM</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">(index):17 test: 1921.02099609375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>index.htmlDOM2img1.png</p>\n<p>jscss1cssjs2.jsjs1.jscss1.cssimg1.png1__CSSJSDOM__</p>\n<h2 id=\"-JSDOM\"><a href=\"#-JSDOM\" class=\"headerlink\" title=\" JSDOM\"></a> JSDOM</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(el)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-number\">0</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">null</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js3.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 2943.9951171875ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>js3.js3 app null3 test __JSDOM__</p>\n<h2 id=\"-DOMDOMContentLoadedonLoad\"><a href=\"#-DOMDOMContentLoadedonLoad\" class=\"headerlink\" title=\" DOMDOMContentLoadedonLoad\"></a> DOMDOMContentLoadedonLoad</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">window</span>.<span class=\"hljs-property\">onload</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"hljs-comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 1955.489990234375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">testDOMContentLoaded: 1956.044189453125ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">testonload: 2964.078857421875ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p> testDOMContentLoaded 2testonload3__DOMContentLoadedjscssonload__</p>\n<h2 id=\"-script-async-\"><a href=\"#-script-async-\" class=\"headerlink\" title=\" script async \"></a> script async </h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(el)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-number\">0</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>3jsasync,</p>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>app</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js1.jsasync</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>testDOMContentLoaded 1</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js3.jsasync</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>__asyncjsasyncjsDOMContentLoadedasync__</p>\n<h2 id=\"-script-defer-\"><a href=\"#-script-defer-\" class=\"headerlink\" title=\" script defer \"></a> script defer </h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(el)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-number\">0</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<p>3jsdefer,</p>\n<ul>\n<li>app</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>deferasync</p>\n<p>js1.jsdefer</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>deferasync</p>\n<p>js3.jsdefer</p>\n<ul>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n<li>js2.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>__deferjsdeferjsdeferDOMContentLoadeddefer__</p>\n<h2 id=\"-script-defer-async--\"><a href=\"#-script-defer-async--\" class=\"headerlink\" title=\" script defer &amp; async  \"></a> script defer &amp; async  </h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>3jsasync,</p>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>asyncdefer</p>\n<h2 id=\"-script\"><a href=\"#-script\" class=\"headerlink\" title=\" script\"></a> script</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">       <span class=\"hljs-keyword\">var</span> appEl = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">       <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(appEl)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-number\">0</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">var</span>&nbsp;head = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"hljs-string\">'head'</span>)[<span class=\"hljs-number\">0</span>]</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">3</span>; i++) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">var</span>&nbsp;script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"hljs-string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      script.<span class=\"hljs-property\">type</span> = <span class=\"hljs-string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      script.<span class=\"hljs-property\">src</span> = <span class=\"hljs-string\">'js'</span> + (i + <span class=\"hljs-number\">1</span>) + <span class=\"hljs-string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      head.<span class=\"title function_\">appendChild</span>(script)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>appEl </li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js1.jsjs2.jsjs3.js</p>\n<p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">       <span class=\"hljs-keyword\">var</span> appEl = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">       <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(appEl)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-number\">0</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"js3.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">var</span>&nbsp;head = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"hljs-string\">'head'</span>)[<span class=\"hljs-number\">0</span>]</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">2</span>; i++) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">var</span>&nbsp;script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"hljs-string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      script.<span class=\"hljs-property\">type</span> = <span class=\"hljs-string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      script.<span class=\"hljs-property\">src</span> = <span class=\"hljs-string\">'js'</span> + (i + <span class=\"hljs-number\">1</span>) + <span class=\"hljs-string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      head.<span class=\"title function_\">appendChild</span>(script)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n<ul>\n<li>appEl  null </li>\n<li>js3.js loaded </li>\n<li>testDOMContentLoaded 3</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n</ul>\n<p>__scriptDOMContentLoaded__</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>CSSDOMJSDOMJSDOMscriptdefer &amp; asyncDOMasync deferdeferscript</p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[],"excerpt":"<html><head></head><body><p></p></body></html>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><em>localhostchrome 69</em></p>\n<p> css</p>\n<ul>\n<li>css1.css 2 body { background-color: #444 }</li>\n<li>css2.css  body { font-size: 50px;font-weight: bold; }</li>\n</ul>\n<p> js</p>\n<ul>\n<li>js1.js 1 console.log(js1.js loaded) </li>\n<li>js2.js  console.log(js2.js loaded)</li>\n<li>js3.js 3 console.log(js2.js loaded)</li>\n</ul>\n<p> image</p>\n<ul>\n<li>img1.png 3 js</li>\n<li>img2.png  nodejs</li>\n</ul>\n<p></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">Koa</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;koa&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">Router</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;koa-router&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> views = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;koa-views&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;fs&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> <span class=\"title class_\">Koa</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> router = <span class=\"keyword\">new</span> <span class=\"title class_\">Router</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">use</span>(<span class=\"title function_\">views</span>(__dirname + <span class=\"string\">&#x27;/views&#x27;</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/&#x27;</span>, <span class=\"keyword\">async</span> (ctx, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">await</span> ctx.<span class=\"title function_\">render</span>(<span class=\"string\">&#x27;index.html&#x27;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/css1.css&#x27;</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    ctx.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;Content-Type&#x27;</span>, <span class=\"string\">&#x27;text/css&#x27;</span>)</span><br><span class=\"line\">    ctx.<span class=\"property\">body</span> = <span class=\"string\">&#x27;body &#123; background-color: #444 &#125;&#x27;</span></span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">2</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/css2.css&#x27;</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;Content-Type&#x27;</span>, <span class=\"string\">&#x27;text/css&#x27;</span>)</span><br><span class=\"line\">  ctx.<span class=\"property\">body</span> = <span class=\"string\">&#x27;body &#123; font-size: 50px;font-weight: bold; &#125;&#x27;</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/js1.js&#x27;</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    ctx.<span class=\"property\">body</span> = <span class=\"string\">&#x27;console.log(&quot;js1.js loaded&quot;)&#x27;</span></span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/js2.js&#x27;</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.<span class=\"property\">body</span> = <span class=\"string\">&#x27;console.log(&quot;js2.js loaded&quot;)&#x27;</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/js3.js&#x27;</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    ctx.<span class=\"property\">body</span> = <span class=\"string\">&#x27;console.log(&quot;js3.js loaded&quot;)&#x27;</span></span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/img1.png&#x27;</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    ctx.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;Content-Type&#x27;</span>, <span class=\"string\">&#x27;image/png; charset=UTF-8&#x27;</span>)</span><br><span class=\"line\">    ctx.<span class=\"property\">body</span> = fs.<span class=\"title function_\">createReadStream</span>(<span class=\"string\">&#x27;1.png&#x27;</span>)</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/img2.png&#x27;</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;Content-Type&#x27;</span>, <span class=\"string\">&#x27;image/png; charset=UTF-8&#x27;</span>)</span><br><span class=\"line\">  ctx.<span class=\"property\">body</span> = fs.<span class=\"title function_\">createReadStream</span>(<span class=\"string\">&#x27;2.png&#x27;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app</span><br><span class=\"line\">  .<span class=\"title function_\">use</span>(router.<span class=\"title function_\">routes</span>())</span><br><span class=\"line\">  .<span class=\"title function_\">use</span>(router.<span class=\"title function_\">allowedMethods</span>())</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">listen</span>(<span class=\"number\">3000</span>)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"-CSSDOM\"><a href=\"#-CSSDOM\" class=\"headerlink\" title=\" CSSDOM\"></a> CSSDOM</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;test&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">const</span> el = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">&#x27;app&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(el)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"number\">0</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/css&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;/css1.css&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/css&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;/css2.css&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;width: 100px&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/img1.png&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;width: 100px&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/img2.png&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;test&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"comment\">app</span></span><br><span class=\"line\"><span class=\"comment\">test: 1947.620849609375ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p> app 2 test __CSSDOM__</p>\n<h2 id=\"-CSSJSDOM\"><a href=\"#-CSSJSDOM\" class=\"headerlink\" title=\" CSSJSDOM\"></a> CSSJSDOM</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;test&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/css&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;/css1.css&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/css&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;/css2.css&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js1.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js2.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;width: 100px&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/img1.png&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;width: 100px&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/img2.png&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;test&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">(index):17 test: 1921.02099609375ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>index.htmlDOM2img1.png</p>\n<p>jscss1cssjs2.jsjs1.jscss1.cssimg1.png1__CSSJSDOM__</p>\n<h2 id=\"-JSDOM\"><a href=\"#-JSDOM\" class=\"headerlink\" title=\" JSDOM\"></a> JSDOM</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;test&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">const</span> el = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">&#x27;app&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(el)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"number\">0</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js3.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;width: 100px&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/img1.png&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;width: 100px&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/img2.png&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;test&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"comment\">null</span></span><br><span class=\"line\"><span class=\"comment\">js3.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">test: 2943.9951171875ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>js3.js3 app null3 test __JSDOM__</p>\n<h2 id=\"-DOMDOMContentLoadedonLoad\"><a href=\"#-DOMDOMContentLoadedonLoad\" class=\"headerlink\" title=\" DOMDOMContentLoadedonLoad\"></a> DOMDOMContentLoadedonLoad</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;test&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;testonload&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;DOMContentLoaded&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">window</span>.<span class=\"property\">onload</span> = <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;testonload&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/css&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;/css1.css&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/css&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;/css2.css&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js1.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js2.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;width: 100px&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/img1.png&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;width: 100px&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/img2.png&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;test&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console </span></span><br><span class=\"line\"><span class=\"comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">test: 1955.489990234375ms</span></span><br><span class=\"line\"><span class=\"comment\">testDOMContentLoaded: 1956.044189453125ms</span></span><br><span class=\"line\"><span class=\"comment\">testonload: 2964.078857421875ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p> testDOMContentLoaded 2testonload3__DOMContentLoadedjscssonload__</p>\n<h2 id=\"-script-async-\"><a href=\"#-script-async-\" class=\"headerlink\" title=\" script async \"></a> script async </h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;DOMContentLoaded&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">const</span> el = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">&#x27;app&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(el)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"number\">0</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js1.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js2.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js3.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>3jsasync,</p>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>app</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js1.jsasync</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>testDOMContentLoaded 1</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js3.jsasync</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>__asyncjsasyncjsDOMContentLoadedasync__</p>\n<h2 id=\"-script-defer-\"><a href=\"#-script-defer-\" class=\"headerlink\" title=\" script defer \"></a> script defer </h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;DOMContentLoaded&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">const</span> el = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">&#x27;app&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(el)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"number\">0</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js1.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js2.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js3.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>3jsdefer,</p>\n<ul>\n<li>app</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>deferasync</p>\n<p>js1.jsdefer</p>\n<ul>\n<li>el  null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>deferasync</p>\n<p>js3.jsdefer</p>\n<ul>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n<li>js2.js loaded</li>\n<li>testDOMContentLoaded 3</li>\n</ul>\n<p>__deferjsdeferjsdeferDOMContentLoadeddefer__</p>\n<h2 id=\"-script-defer-async--\"><a href=\"#-script-defer-async--\" class=\"headerlink\" title=\" script defer &amp; async  \"></a> script defer &amp; async  </h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;DOMContentLoaded&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js1.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js2.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/js3.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>3jsasync,</p>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>asyncdefer</p>\n<h2 id=\"-script\"><a href=\"#-script\" class=\"headerlink\" title=\" script\"></a> script</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;DOMContentLoaded&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">       <span class=\"keyword\">var</span> appEl = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">&#x27;app&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">       <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(appEl)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"number\">0</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span>head = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"string\">&#x27;head&#x27;</span>)[<span class=\"number\">0</span>]</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">3</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">var</span>script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;script&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      script.<span class=\"property\">type</span> = <span class=\"string\">&#x27;text/javascript&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">      script.<span class=\"property\">src</span> = <span class=\"string\">&#x27;js&#x27;</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">&#x27;.js&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">      head.<span class=\"title function_\">appendChild</span>(script)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>testDOMContentLoaded </li>\n<li>appEl </li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>js1.jsjs2.jsjs3.js</p>\n<p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">time</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;DOMContentLoaded&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">timeEnd</span>(<span class=\"string\">&#x27;testDOMContentLoaded&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">       <span class=\"keyword\">var</span> appEl = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">&#x27;app&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">       <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(appEl)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"number\">0</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;js3.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span>head = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"string\">&#x27;head&#x27;</span>)[<span class=\"number\">0</span>]</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">2</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">var</span>script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;script&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      script.<span class=\"property\">type</span> = <span class=\"string\">&#x27;text/javascript&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">      script.<span class=\"property\">src</span> = <span class=\"string\">&#x27;js&#x27;</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">&#x27;.js&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">      head.<span class=\"title function_\">appendChild</span>(script)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>appEl  null </li>\n<li>js3.js loaded </li>\n<li>testDOMContentLoaded 3</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n</ul>\n<p>__scriptDOMContentLoaded__</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>CSSDOMJSDOMJSDOMscriptdefer &amp; asyncDOMasync deferdeferscript</p>"},{"title":"monitorEventLoopDelay ","date":"2020-11-06T08:16:40.000Z","description":"monitorEventLoopDelaylibuvuv_timer_t","keywords":"Node.js,monitorEventLoopDelay","_content":"\n## monitorEventLoopDelay \n\nperf_hooks.monitorEventLoopDelay([options])\n\n- options: Object\n  -- `resolution`: The sampling rate in milliseconds. Must be greater than zero. Default: 10.\n- Returns: Histogram\n  > Creates a Histogram object that samples and reports the event loop delay over time. The delays will be reported in nanoseconds.\n  > Using a timer to detect approximate event loop delay works because the execution of timers is tied specifically to the lifecycle of the libuv event loop. That is, a delay in the loop will cause a delay in the execution of the timer, and those delays are specifically what this API is intended to detect.\n\n EventLoop Node.js  v11 `monitorEventLoopDelay`\n\n<!-- monitorEventLoopDelay  -->\n\n<!-- more -->\n\n****\n\n```c++\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n## \n\n__\n\n```javascript\n// perf_hooks.js\nfunction monitorEventLoopDelay(options = {}) {\n  // _ELDHistogram  C++ \n  return new ELDHistogram(new _ELDHistogram(resolution));\n}\n\n// ELDHistogram  handle \nclass ELDHistogram {\n  constructor(handle) {\n    this[kHandle] = handle;\n  }\n  enable() {\n    // \n    return this[kHandle].enable();\n  }\n}\n```\n\n```c++\n// node_perf.h\nclass ELDHistogram : public HandleWrap, public Histogram {\n public:\n  ELDHistogram(Environment* env,\n               Local<Object> wrap,\n               int32_t resolution);\n  bool Enable();\n private:\n  // Enable  EventLoop\n  static void DelayIntervalCallback(uv_timer_t* req);\n\n  bool enabled_ = false;\n  // EventLoop Handle\n  uv_timer_t timer_;\n};\n\n// node_perf.cc\nbool ELDHistogram::Enable() {\n  if (enabled_ || IsHandleClosing()) return false;\n  enabled_ = true;\n  // resolution_  js \n  // \n  uv_timer_start(&timer_,\n                 DelayIntervalCallback,\n                 resolution_,\n                 resolution_);\n  //   unref\n  uv_unref(reinterpret_cast<uv_handle_t*>(&timer_));\n  return true;\n}\n\n// \nvoid ELDHistogram::DelayIntervalCallback(uv_timer_t* req) {\n  ELDHistogram* histogram = ContainerOf(&ELDHistogram::timer_, req);\n  histogram->RecordDelta();\n  TRACE_COUNTER1(TRACING_CATEGORY_NODE2(perf, event_loop),\n                 \"min\", histogram->Min());\n  TRACE_COUNTER1(TRACING_CATEGORY_NODE2(perf, event_loop),\n                 \"max\", histogram->Max());\n  TRACE_COUNTER1(TRACING_CATEGORY_NODE2(perf, event_loop),\n                 \"mean\", histogram->Mean());\n  TRACE_COUNTER1(TRACING_CATEGORY_NODE2(perf, event_loop),\n                 \"stddev\", histogram->Stddev());\n}\n```\n\njs `ELDHistogram` C++ EventLoop [HdrHistogram_c](https://github.com/HdrHistogram/HdrHistogram_c) C [HdrHistogram](https://github.com/HdrHistogram/HdrHistogram)95 \n\n libuv  uv_timer_t \n","source":"_posts/monitorEventLoopDelay-libuv-uv-timer-start.md","raw":"---\ntitle: monitorEventLoopDelay \ndate: 2020-11-06 16:16:40\ncategory: JavaScript\ndescription: monitorEventLoopDelaylibuvuv_timer_t\ntags:\n  - \n  - V8\n  - Node.js\nkeywords: Node.js,monitorEventLoopDelay\n---\n\n## monitorEventLoopDelay \n\nperf_hooks.monitorEventLoopDelay([options])\n\n- options: Object\n  -- `resolution`: The sampling rate in milliseconds. Must be greater than zero. Default: 10.\n- Returns: Histogram\n  > Creates a Histogram object that samples and reports the event loop delay over time. The delays will be reported in nanoseconds.\n  > Using a timer to detect approximate event loop delay works because the execution of timers is tied specifically to the lifecycle of the libuv event loop. That is, a delay in the loop will cause a delay in the execution of the timer, and those delays are specifically what this API is intended to detect.\n\n EventLoop Node.js  v11 `monitorEventLoopDelay`\n\n<!-- monitorEventLoopDelay  -->\n\n<!-- more -->\n\n****\n\n```c++\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n## \n\n__\n\n```javascript\n// perf_hooks.js\nfunction monitorEventLoopDelay(options = {}) {\n  // _ELDHistogram  C++ \n  return new ELDHistogram(new _ELDHistogram(resolution));\n}\n\n// ELDHistogram  handle \nclass ELDHistogram {\n  constructor(handle) {\n    this[kHandle] = handle;\n  }\n  enable() {\n    // \n    return this[kHandle].enable();\n  }\n}\n```\n\n```c++\n// node_perf.h\nclass ELDHistogram : public HandleWrap, public Histogram {\n public:\n  ELDHistogram(Environment* env,\n               Local<Object> wrap,\n               int32_t resolution);\n  bool Enable();\n private:\n  // Enable  EventLoop\n  static void DelayIntervalCallback(uv_timer_t* req);\n\n  bool enabled_ = false;\n  // EventLoop Handle\n  uv_timer_t timer_;\n};\n\n// node_perf.cc\nbool ELDHistogram::Enable() {\n  if (enabled_ || IsHandleClosing()) return false;\n  enabled_ = true;\n  // resolution_  js \n  // \n  uv_timer_start(&timer_,\n                 DelayIntervalCallback,\n                 resolution_,\n                 resolution_);\n  //   unref\n  uv_unref(reinterpret_cast<uv_handle_t*>(&timer_));\n  return true;\n}\n\n// \nvoid ELDHistogram::DelayIntervalCallback(uv_timer_t* req) {\n  ELDHistogram* histogram = ContainerOf(&ELDHistogram::timer_, req);\n  histogram->RecordDelta();\n  TRACE_COUNTER1(TRACING_CATEGORY_NODE2(perf, event_loop),\n                 \"min\", histogram->Min());\n  TRACE_COUNTER1(TRACING_CATEGORY_NODE2(perf, event_loop),\n                 \"max\", histogram->Max());\n  TRACE_COUNTER1(TRACING_CATEGORY_NODE2(perf, event_loop),\n                 \"mean\", histogram->Mean());\n  TRACE_COUNTER1(TRACING_CATEGORY_NODE2(perf, event_loop),\n                 \"stddev\", histogram->Stddev());\n}\n```\n\njs `ELDHistogram` C++ EventLoop [HdrHistogram_c](https://github.com/HdrHistogram/HdrHistogram_c) C [HdrHistogram](https://github.com/HdrHistogram/HdrHistogram)95 \n\n libuv  uv_timer_t \n","slug":"monitorEventLoopDelay-libuv-uv-timer-start","published":1,"updated":"2024-04-08T13:38:53.380Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45we7000u18fd9i396fha","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><h2 id=\"monitorEventLoopDelay-\"><a href=\"#monitorEventLoopDelay-\" class=\"headerlink\" title=\"monitorEventLoopDelay \"></a>monitorEventLoopDelay </h2><p>perf_hooks.monitorEventLoopDelay([options])</p>\n<ul>\n<li>options: Object<br> <code>resolution</code>: The sampling rate in milliseconds. Must be greater than zero. Default: 10.</li>\n<li>Returns: Histogram<blockquote>\n<p>Creates a Histogram object that samples and reports the event loop delay over time. The delays will be reported in nanoseconds.<br>Using a timer to detect approximate event loop delay works because the execution of timers is tied specifically to the lifecycle of the libuv event loop. That is, a delay in the loop will cause a delay in the execution of the timer, and those delays are specifically what this API is intended to detect.</p>\n</blockquote>\n</li>\n</ul>\n<p> EventLoop Node.js  v11 <code>monitorEventLoopDelay</code></p>\n<!-- monitorEventLoopDelay  -->\n\n<span id=\"more\"></span>\n\n<p><strong></strong></p>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// libuv</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// V8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// Node.js</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><em></em></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// perf_hooks.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">monitorEventLoopDelay</span>(<span class=\"hljs-params\">options = {}</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// _ELDHistogram  C++ </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">ELDHistogram</span>(<span class=\"hljs-keyword\">new</span> <span class=\"title function_\">_ELDHistogram</span>(resolution));</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// ELDHistogram  handle </span></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">ELDHistogram</span> {</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"hljs-params\">handle</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>[kHandle] = handle;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"title function_\">enable</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"variable language_\">this</span>[kHandle].<span class=\"title function_\">enable</span>();</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// node_perf.h</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">ELDHistogram</span> : <span class=\"hljs-keyword\">public</span> HandleWrap, <span class=\"hljs-keyword\">public</span> Histogram {</span><br><span class=\"line\"> <span class=\"hljs-keyword\">public</span>:</span><br><span class=\"line\">  <span class=\"hljs-built_in\">ELDHistogram</span>(Environment* env,</span><br><span class=\"line\">               Local&lt;Object&gt; wrap,</span><br><span class=\"line\">               <span class=\"hljs-type\">int32_t</span> resolution);</span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-type\">bool</span> <span class=\"hljs-title\">Enable</span><span class=\"hljs-params\">()</span></span>;</span><br><span class=\"line\"> <span class=\"hljs-keyword\">private</span>:</span><br><span class=\"line\">  <span class=\"hljs-comment\">// Enable  EventLoop</span></span><br><span class=\"line\">  <span class=\"hljs-function\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title\">DelayIntervalCallback</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_timer_t</span>* req)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-type\">bool</span> enabled_ = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// EventLoop Handle</span></span><br><span class=\"line\">  <span class=\"hljs-type\">uv_timer_t</span> timer_;</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// node_perf.cc</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-type\">bool</span> <span class=\"hljs-title\">ELDHistogram::Enable</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (enabled_ || <span class=\"hljs-built_in\">IsHandleClosing</span>()) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">  enabled_ = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// resolution_  js </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-built_in\">uv_timer_start</span>(&amp;timer_,</span><br><span class=\"line\">                 DelayIntervalCallback,</span><br><span class=\"line\">                 resolution_,</span><br><span class=\"line\">                 resolution_);</span><br><span class=\"line\">  <span class=\"hljs-comment\">//   unref</span></span><br><span class=\"line\">  <span class=\"hljs-built_in\">uv_unref</span>(<span class=\"hljs-built_in\">reinterpret_cast</span>&lt;<span class=\"hljs-type\">uv_handle_t</span>*&gt;(&amp;timer_));</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// </span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-type\">void</span> <span class=\"hljs-title\">ELDHistogram::DelayIntervalCallback</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_timer_t</span>* req)</span> </span>{</span><br><span class=\"line\">  ELDHistogram* histogram = <span class=\"hljs-built_in\">ContainerOf</span>(&amp;ELDHistogram::timer_, req);</span><br><span class=\"line\">  histogram-&gt;<span class=\"hljs-built_in\">RecordDelta</span>();</span><br><span class=\"line\">  <span class=\"hljs-built_in\">TRACE_COUNTER1</span>(<span class=\"hljs-built_in\">TRACING_CATEGORY_NODE2</span>(perf, event_loop),</span><br><span class=\"line\">                 <span class=\"hljs-string\">\"min\"</span>, histogram-&gt;<span class=\"hljs-built_in\">Min</span>());</span><br><span class=\"line\">  <span class=\"hljs-built_in\">TRACE_COUNTER1</span>(<span class=\"hljs-built_in\">TRACING_CATEGORY_NODE2</span>(perf, event_loop),</span><br><span class=\"line\">                 <span class=\"hljs-string\">\"max\"</span>, histogram-&gt;<span class=\"hljs-built_in\">Max</span>());</span><br><span class=\"line\">  <span class=\"hljs-built_in\">TRACE_COUNTER1</span>(<span class=\"hljs-built_in\">TRACING_CATEGORY_NODE2</span>(perf, event_loop),</span><br><span class=\"line\">                 <span class=\"hljs-string\">\"mean\"</span>, histogram-&gt;<span class=\"hljs-built_in\">Mean</span>());</span><br><span class=\"line\">  <span class=\"hljs-built_in\">TRACE_COUNTER1</span>(<span class=\"hljs-built_in\">TRACING_CATEGORY_NODE2</span>(perf, event_loop),</span><br><span class=\"line\">                 <span class=\"hljs-string\">\"stddev\"</span>, histogram-&gt;<span class=\"hljs-built_in\">Stddev</span>());</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>js <code>ELDHistogram</code> C++ EventLoop <a href=\"https://github.com/HdrHistogram/HdrHistogram_c\">HdrHistogram_c</a> C <a href=\"https://github.com/HdrHistogram/HdrHistogram\">HdrHistogram</a>95 </p>\n<p> libuv  uv_timer_t </p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"","path":"tags//"},{"name":"V8","path":"tags/V8/"}],"excerpt":"<html><head></head><body><h2 id=\"monitorEventLoopDelay-\"><a href=\"#monitorEventLoopDelay-\" class=\"headerlink\" title=\"monitorEventLoopDelay \"></a>monitorEventLoopDelay </h2><p>perf_hooks.monitorEventLoopDelay([options])</p>\n<ul>\n<li>options: Object<br> <code>resolution</code>: The sampling rate in milliseconds. Must be greater than zero. Default: 10.</li>\n<li>Returns: Histogram<blockquote>\n<p>Creates a Histogram object that samples and reports the event loop delay over time. The delays will be reported in nanoseconds.<br>Using a timer to detect approximate event loop delay works because the execution of timers is tied specifically to the lifecycle of the libuv event loop. That is, a delay in the loop will cause a delay in the execution of the timer, and those delays are specifically what this API is intended to detect.</p>\n</blockquote>\n</li>\n</ul>\n<p> EventLoop Node.js  v11 <code>monitorEventLoopDelay</code></p>\n<!-- monitorEventLoopDelay  --></body></html>","more":"<p><strong></strong></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// libuv</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// V8</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Node.js</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><em></em></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// perf_hooks.js</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">monitorEventLoopDelay</span>(<span class=\"params\">options = &#123;&#125;</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// _ELDHistogram  C++ </span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ELDHistogram</span>(<span class=\"keyword\">new</span> <span class=\"title function_\">_ELDHistogram</span>(resolution));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ELDHistogram  handle </span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ELDHistogram</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">handle</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>[kHandle] = handle;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"title function_\">enable</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>[kHandle].<span class=\"title function_\">enable</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// node_perf.h</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ELDHistogram</span> : <span class=\"keyword\">public</span> HandleWrap, <span class=\"keyword\">public</span> Histogram &#123;</span><br><span class=\"line\"> <span class=\"keyword\">public</span>:</span><br><span class=\"line\">  <span class=\"built_in\">ELDHistogram</span>(Environment* env,</span><br><span class=\"line\">               Local&lt;Object&gt; wrap,</span><br><span class=\"line\">               <span class=\"type\">int32_t</span> resolution);</span><br><span class=\"line\">  <span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">Enable</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"> <span class=\"keyword\">private</span>:</span><br><span class=\"line\">  <span class=\"comment\">// Enable  EventLoop</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">DelayIntervalCallback</span><span class=\"params\">(<span class=\"type\">uv_timer_t</span>* req)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"type\">bool</span> enabled_ = <span class=\"literal\">false</span>;</span><br><span class=\"line\">  <span class=\"comment\">// EventLoop Handle</span></span><br><span class=\"line\">  <span class=\"type\">uv_timer_t</span> timer_;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// node_perf.cc</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">ELDHistogram::Enable</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (enabled_ || <span class=\"built_in\">IsHandleClosing</span>()) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  enabled_ = <span class=\"literal\">true</span>;</span><br><span class=\"line\">  <span class=\"comment\">// resolution_  js </span></span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"built_in\">uv_timer_start</span>(&amp;timer_,</span><br><span class=\"line\">                 DelayIntervalCallback,</span><br><span class=\"line\">                 resolution_,</span><br><span class=\"line\">                 resolution_);</span><br><span class=\"line\">  <span class=\"comment\">//   unref</span></span><br><span class=\"line\">  <span class=\"built_in\">uv_unref</span>(<span class=\"built_in\">reinterpret_cast</span>&lt;<span class=\"type\">uv_handle_t</span>*&gt;(&amp;timer_));</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ELDHistogram::DelayIntervalCallback</span><span class=\"params\">(<span class=\"type\">uv_timer_t</span>* req)</span> </span>&#123;</span><br><span class=\"line\">  ELDHistogram* histogram = <span class=\"built_in\">ContainerOf</span>(&amp;ELDHistogram::timer_, req);</span><br><span class=\"line\">  histogram-&gt;<span class=\"built_in\">RecordDelta</span>();</span><br><span class=\"line\">  <span class=\"built_in\">TRACE_COUNTER1</span>(<span class=\"built_in\">TRACING_CATEGORY_NODE2</span>(perf, event_loop),</span><br><span class=\"line\">                 <span class=\"string\">&quot;min&quot;</span>, histogram-&gt;<span class=\"built_in\">Min</span>());</span><br><span class=\"line\">  <span class=\"built_in\">TRACE_COUNTER1</span>(<span class=\"built_in\">TRACING_CATEGORY_NODE2</span>(perf, event_loop),</span><br><span class=\"line\">                 <span class=\"string\">&quot;max&quot;</span>, histogram-&gt;<span class=\"built_in\">Max</span>());</span><br><span class=\"line\">  <span class=\"built_in\">TRACE_COUNTER1</span>(<span class=\"built_in\">TRACING_CATEGORY_NODE2</span>(perf, event_loop),</span><br><span class=\"line\">                 <span class=\"string\">&quot;mean&quot;</span>, histogram-&gt;<span class=\"built_in\">Mean</span>());</span><br><span class=\"line\">  <span class=\"built_in\">TRACE_COUNTER1</span>(<span class=\"built_in\">TRACING_CATEGORY_NODE2</span>(perf, event_loop),</span><br><span class=\"line\">                 <span class=\"string\">&quot;stddev&quot;</span>, histogram-&gt;<span class=\"built_in\">Stddev</span>());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>js <code>ELDHistogram</code> C++ EventLoop <a href=\"https://github.com/HdrHistogram/HdrHistogram_c\">HdrHistogram_c</a> C <a href=\"https://github.com/HdrHistogram/HdrHistogram\">HdrHistogram</a>95 </p>\n<p> libuv  uv_timer_t </p>"},{"title":"PPT","date":"2020-11-04T14:30:39.000Z","keys":",gateway,SSR,,","_content":"\n [Node.js  SSR ](/2020/06/29/node-gateway-ssr-multi-version/) SSR  SSR \n\n[ PPT ](/images/node-gateway-ssr-multi-version-2/FE-Schedule.pptx)\n\n<!-- more -->\n\n![](/images/node-gateway-ssr-multi-version-2/0.png)\n![](/images/node-gateway-ssr-multi-version-2/1.png)\n![](/images/node-gateway-ssr-multi-version-2/2.png)\n![](/images/node-gateway-ssr-multi-version-2/3.png)\n![](/images/node-gateway-ssr-multi-version-2/4.png)\n![](/images/node-gateway-ssr-multi-version-2/5.png)\n![](/images/node-gateway-ssr-multi-version-2/6.png)\n![](/images/node-gateway-ssr-multi-version-2/7.png)\n![](/images/node-gateway-ssr-multi-version-2/8.png)\n![](/images/node-gateway-ssr-multi-version-2/9.png)\n","source":"_posts/node-gateway-ssr-multi-version-2.md","raw":"---\ntitle: PPT\ndate: 2020-11-04 22:30:39\ncategory: \ntags:\n  - \nkeys: ,gateway,SSR,,\n---\n\n [Node.js  SSR ](/2020/06/29/node-gateway-ssr-multi-version/) SSR  SSR \n\n[ PPT ](/images/node-gateway-ssr-multi-version-2/FE-Schedule.pptx)\n\n<!-- more -->\n\n![](/images/node-gateway-ssr-multi-version-2/0.png)\n![](/images/node-gateway-ssr-multi-version-2/1.png)\n![](/images/node-gateway-ssr-multi-version-2/2.png)\n![](/images/node-gateway-ssr-multi-version-2/3.png)\n![](/images/node-gateway-ssr-multi-version-2/4.png)\n![](/images/node-gateway-ssr-multi-version-2/5.png)\n![](/images/node-gateway-ssr-multi-version-2/6.png)\n![](/images/node-gateway-ssr-multi-version-2/7.png)\n![](/images/node-gateway-ssr-multi-version-2/8.png)\n![](/images/node-gateway-ssr-multi-version-2/9.png)\n","slug":"node-gateway-ssr-multi-version-2","published":1,"updated":"2024-04-08T13:38:52.741Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45we9000z18fdfaq2b6g3","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p> <a href=\"/2020/06/29/node-gateway-ssr-multi-version/\">Node.js  SSR </a> SSR  SSR </p>\n<p><a href=\"/images/node-gateway-ssr-multi-version-2/FE-Schedule.pptx\"> PPT </a></p>\n<span id=\"more\"></span>\n\n<p><img src=\"/images/node-gateway-ssr-multi-version-2/0.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/1.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/2.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/3.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/4.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/5.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/6.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/7.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/8.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/9.png\"></p>\n</body></html>","_categories":[{"name":"","path":"categories//"}],"_tags":[{"name":"","path":"tags//"}],"excerpt":"<html><head></head><body><p> <a href=\"/2020/06/29/node-gateway-ssr-multi-version/\">Node.js  SSR </a> SSR  SSR </p>\n<p><a href=\"/images/node-gateway-ssr-multi-version-2/FE-Schedule.pptx\"> PPT </a></p></body></html>","more":"<p><img src=\"/images/node-gateway-ssr-multi-version-2/0.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/1.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/2.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/3.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/4.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/5.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/6.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/7.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/8.png\"><br><img src=\"/images/node-gateway-ssr-multi-version-2/9.png\"></p>"},{"title":"Node.jsSSR","date":"2020-06-29T06:59:30.000Z","keys":",gateway,SSR,,","_content":"\n### \n\nBUG  N  \n\n HTTP Header \n\nServer A V1 -> Server B V1\n\nServer A V2 -> Server B \n\n<!-- more -->\n<br/>\n\n### \n\n** SSR  hybrid  Native  HTTP Header  PC  URL Query  Cookie **\n\n1.  SSR \n\n\n\n-  SSR \n\n\n\n-  SSR \n-  SSR  2 \n-  Docker  SSR \n\n2.  SSR  HTTP Header \n\n\n\n-  SSR  Docker\n- SSR\n\n\n\n-  SSR  SSR \n\n****\n\n<br/>\n\n###  SSR \n\n#### CI\\CD \n\n client-manifest.json  server-manifest.jsonclient-manifest.json server-manifest.json  Node.js  SSR \n\n#### \n\n-  ['v1,'v2']\n-  diff \n-  SSR \n-  SSR @babel/parser  @babel/traverse  AST\n-  SSR \n- \n- \n\n Egg.js Agent  Worker [PlugBoard](https://miser.github.io/plugboard/?s=blog)\n\n![](/images/node-gateway-ssr-multi-version/arch.png)\n\n SSR  client-manifest.json\n\n K8S \n","source":"_posts/node-gateway-ssr-multi-version.md","raw":"---\ntitle: Node.jsSSR\ndate: 2020-06-29 14:59:30\ncategory: \ntags:\n  - \nkeys: ,gateway,SSR,,\n---\n\n### \n\nBUG  N  \n\n HTTP Header \n\nServer A V1 -> Server B V1\n\nServer A V2 -> Server B \n\n<!-- more -->\n<br/>\n\n### \n\n** SSR  hybrid  Native  HTTP Header  PC  URL Query  Cookie **\n\n1.  SSR \n\n\n\n-  SSR \n\n\n\n-  SSR \n-  SSR  2 \n-  Docker  SSR \n\n2.  SSR  HTTP Header \n\n\n\n-  SSR  Docker\n- SSR\n\n\n\n-  SSR  SSR \n\n****\n\n<br/>\n\n###  SSR \n\n#### CI\\CD \n\n client-manifest.json  server-manifest.jsonclient-manifest.json server-manifest.json  Node.js  SSR \n\n#### \n\n-  ['v1,'v2']\n-  diff \n-  SSR \n-  SSR @babel/parser  @babel/traverse  AST\n-  SSR \n- \n- \n\n Egg.js Agent  Worker [PlugBoard](https://miser.github.io/plugboard/?s=blog)\n\n![](/images/node-gateway-ssr-multi-version/arch.png)\n\n SSR  client-manifest.json\n\n K8S \n","slug":"node-gateway-ssr-multi-version","published":1,"updated":"2024-04-08T13:38:52.167Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wea001118fddpg5h3jx","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BUG  N  </p>\n<p> HTTP Header </p>\n<p>Server A V1 -&gt; Server B V1</p>\n<p>Server A V2 -&gt; Server B </p>\n<span id=\"more\"></span>\n<br>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong> SSR  hybrid  Native  HTTP Header  PC  URL Query  Cookie </strong></p>\n<ol>\n<li> SSR </li>\n</ol>\n<p></p>\n<ul>\n<li> SSR </li>\n</ul>\n<p></p>\n<ul>\n<li> SSR </li>\n<li> SSR  2 </li>\n<li> Docker  SSR </li>\n</ul>\n<ol start=\"2\">\n<li> SSR  HTTP Header </li>\n</ol>\n<p></p>\n<ul>\n<li> SSR  Docker</li>\n<li>SSR</li>\n</ul>\n<p></p>\n<ul>\n<li> SSR  SSR </li>\n</ul>\n<p><strong></strong></p>\n<br>\n\n<h3 id=\"-SSR-\"><a href=\"#-SSR-\" class=\"headerlink\" title=\" SSR \"></a> SSR </h3><h4 id=\"CI-CD-\"><a href=\"#CI-CD-\" class=\"headerlink\" title=\"CI\\CD \"></a>CI\\CD </h4><p> client-manifest.json  server-manifest.jsonclient-manifest.json server-manifest.json  Node.js  SSR </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li> [v1,v2]</li>\n<li> diff </li>\n<li> SSR </li>\n<li> SSR @babel/parser  @babel/traverse  AST</li>\n<li> SSR </li>\n<li></li>\n<li></li>\n</ul>\n<p> Egg.js Agent  Worker <a href=\"https://miser.github.io/plugboard/?s=blog\">PlugBoard</a></p>\n<p><img src=\"/images/node-gateway-ssr-multi-version/arch.png\" alt=\"\"></p>\n<p> SSR  client-manifest.json</p>\n<p> K8S </p>\n</body></html>","_categories":[{"name":"","path":"categories//"}],"_tags":[{"name":"","path":"tags//"}],"excerpt":"<html><head></head><body><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BUG  N  </p>\n<p> HTTP Header </p>\n<p>Server A V1 -&gt; Server B V1</p>\n<p>Server A V2 -&gt; Server B </p></body></html>","more":"<br/>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong> SSR  hybrid  Native  HTTP Header  PC  URL Query  Cookie </strong></p>\n<ol>\n<li> SSR </li>\n</ol>\n<p></p>\n<ul>\n<li> SSR </li>\n</ul>\n<p></p>\n<ul>\n<li> SSR </li>\n<li> SSR  2 </li>\n<li> Docker  SSR </li>\n</ul>\n<ol start=\"2\">\n<li> SSR  HTTP Header </li>\n</ol>\n<p></p>\n<ul>\n<li> SSR  Docker</li>\n<li>SSR</li>\n</ul>\n<p></p>\n<ul>\n<li> SSR  SSR </li>\n</ul>\n<p><strong></strong></p>\n<br/>\n\n<h3 id=\"-SSR-\"><a href=\"#-SSR-\" class=\"headerlink\" title=\" SSR \"></a> SSR </h3><h4 id=\"CI-CD-\"><a href=\"#CI-CD-\" class=\"headerlink\" title=\"CI\\CD \"></a>CI\\CD </h4><p> client-manifest.json  server-manifest.jsonclient-manifest.json server-manifest.json  Node.js  SSR </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li> [v1,v2]</li>\n<li> diff </li>\n<li> SSR </li>\n<li> SSR @babel&#x2F;parser  @babel&#x2F;traverse  AST</li>\n<li> SSR </li>\n<li></li>\n<li></li>\n</ul>\n<p> Egg.js Agent  Worker <a href=\"https://miser.github.io/plugboard/?s=blog\">PlugBoard</a></p>\n<p><img src=\"/images/node-gateway-ssr-multi-version/arch.png\" alt=\"\"></p>\n<p> SSR  client-manifest.json</p>\n<p> K8S </p>"},{"layout":"minos","title":"Node.js cluster","date":"2020-05-03T07:24:53.000Z","keywords":"child_process,cluster,fork,Node.js,TCP","description":"RoundRobinHandleclusterTCPnetmasterchildchildchildmasterServerRoundRobinHandleserverTCPfreeworkercluster.child","_content":"\nNode.js**child_process**4`exec``execFile``fork``spawn`**cluster**cluster.forkNet Server\n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): \n\n<!-- more -->\n\n<br/>\n\n****\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**cluster**\n\n```markdown\nlib\n  - internal\n    - cluster\n    - child.js\n      - master.js\n      - round_robin_handle.js\n      - shared_handle.js\n      - utils.js\n      - worker.js\n  - cluster.js\n```\n\n<br/>\n\n****\n\n```javascript\nconst cluster = require('cluster');\nconst http = require('http');\nconst numCPUs = require('os').cpus().length;\n\nif (cluster.isMaster) {\n  console.log(` ${process.pid} `);\n\n  // \n  for (let i = 0; i < numCPUs; i++) {\n    cluster.fork();\n  }\n\n  cluster.on('exit', (worker, code, signal) => {\n    console.log(` ${worker.process.pid} `);\n  });\n} else {\n  //  TCP \n  //  HTTP \n  http.createServer((req, res) => {\n    res.writeHead(200);\n    res.end('\\n');\n  }).listen(8000);\n\n  console.log(` ${process.pid} `);\n}\n```\n\n<br/>\n\n### Q:cluster.isMaster\n\n```javascript\n// lib/cluster.js\nconst childOrMaster = 'NODE_UNIQUE_ID' in process.env ? 'child' : 'master';\nmodule.exports = require(`internal/cluster/${childOrMaster}`);\n```\n\n`lib/cluster.js`cluster`NODE_UNIQUE_ID`\n\n`cluster.fork``NODE_UNIQUE_ID`**child_process.fork**\n\n```javascript\n// lib/internal/cluster/master.js\n// ...\ncluster.isMaster = true;\n// ...\n// fork\nconst workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\nreturn fork(cluster.settings.exec, cluster.settings.args, {\n  // ...\n  env: workerEnv,\n});\n\n// lib/internal/cluster/child.js\n// ...\ncluster.isMaster = false;\n```\n\n### Q:cluster.fork\n\n`cluster.setupMaster`\n\n`createWorkerProcess``child_process.fork`\n\n`Worker`workercluster(master)`message``exit``disconnect`**Worker**`lib/internal/cluster/worker.js`\n\n`internalMessage`internalMessage\n\n>  **{cmd: 'NODE_foo'}**  **cmd**  **NODE_**  Node.js  **'message'**  **'internalMessage'**  Node.js  **'internalMessage'** \n\n`internalMessage``internal(worker, onmessage)`**internal**`lib/internal/cluster/master.js`**onmessage**\n\n**onmessage**if-elsecluster.child(`act`)`queryServer`Net Server\n\n```javascript\n// lib/internal/cluster/master.js\ncluster.fork = function (env) {\n  cluster.setupMaster();\n  const id = ++ids;\n  // \n  const workerProcess = createWorkerProcess(id, env);\n  //\n  const worker = new Worker({\n    id: id,\n    process: workerProcess, // \n  });\n  \n  worker.on(\"message\", function (message, handle) {\n    cluster.emit(\"message\", this, message, handle);\n  });\n  worker.process.once(\"exit\", (exitCode, signalCode) => {\n    // ...\n    worker.state = \"dead\";\n    worker.emit(\"exit\", exitCode, signalCode);\n    cluster.emit(\"exit\", worker, exitCode, signalCode);\n  });\n  worker.process.once(\"disconnect\", () => {\n    // ...\n    worker.state = \"disconnected\";\n    worker.emit(\"disconnect\");\n    cluster.emit(\"disconnect\", worker);\n  });\n\n  worker.process.on(\"internalMessage\", internal(worker, onmessage));\n  //  fork \n  process.nextTick(emitForkNT, worker);\n  cluster.workers[worker.id] = worker; \n  return worker;\n};\n\nfunction createWorkerProcess(id, env) {\n  const workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\n  // ... \n  // child_processfork\n  return fork(cluster.settings.exec, cluster.settings.args, {\n    cwd: cluster.settings.cwd,\n    env: workerEnv,\n    silent: cluster.settings.silent,\n    windowsHide: cluster.settings.windowsHide,\n    execArgv: execArgv,\n    stdio: cluster.settings.stdio,\n    gid: cluster.settings.gid,\n    uid: cluster.settings.uid,\n  });\n}\nfunction onmessage(message, handle) {\n  const worker = this;\n  // ... if message.act   queryServer\n  if (message.act === \"queryServer\") queryServer(worker, message);\n}\n```\n\n```javascript\n// lib/internal/cluster/utils.js\n// clusterchilidmastersendsendHelper\nlet seq = 0;\nfunction sendHelper(proc, message, handle, cb) {\n  if (!proc.connected) return false;\n  // NODE_*  internalMessage \n  message = { cmd: \"NODE_CLUSTER\", ...message, seq };\n\n  if (typeof cb === \"function\") callbacks.set(seq, cb); // \n\n  seq += 1;\n  // cluster/child.js handle => null\n  // cluster/master.js handle => null\n  return proc.send(message, handle);\n}\n```\n\ncluster.forkWorkerinternalMessageclusterchildmaster`sendHelper`\n\n### Q:cluster.forkTCP\n\n`net`Servercluster`child``master`\n\n`http``net``net.createServer``listen`\n\n#### Child:\n\ncluster.childTCP`port`8000`host`\n\n`listenInCluster`**cluster**\n\n`listen``cluster._getServer``act`serverQuerycluster.master\n\n#### Master:\n\n`master.onmessage`act`serverQuery`\n\n`queryServer``RoundRobinHandle`\n\n`RoundRobinHandle``net.createServer`Servercluster.master`listenInCluster``server._listen2`new  `TCP`src/tcp_wrap.cc`server._handle`cluster.masterTCPmasterchild\n\n`RoundRobinHandle`server`listening``server._handle``distribute``onconnection`\n\n`distribute`TCPcluster.child`free``add`workerworkercluster.child`act`**newconn**TCP\n\n#### Child:\n\ncluster.child`onconnection``act`**newconn**server`onconnection`child`Socket``onnection`\n\n\n\n**\n\n```javascript\n// lib/net.js\nfunction createServer(options, connectionListener) {\n  return new Server(options, connectionListener);\n}\nfunction Server(options, connectionListener) {\n  // ... \n}\nServer.prototype.listen = function (...args) {\n  // ...\n  // port8000host\n  var backlog;\n  if (typeof options.port === \"number\" || typeof options.port === \"string\") {\n    backlog = options.backlog || backlogFromArgs;\n    if (options.host) {\n      // ...\n    } else {\n      // \n      listenInCluster(\n        this,\n        null,\n        options.port | 0,\n        4,\n        backlog,\n        undefined,\n        options.exclusive\n      );\n    }\n    return this;\n  }\n\t// ...\n};\n\n\nfunction listenInCluster(\n  server,\n  address,\n  port,\n  addressType,\n  backlog,\n  fd,\n  exclusive,\n  flags\n) {\n  exclusive = !!exclusive;\n\n  if (cluster === undefined) cluster = require(\"cluster\");\n\n  if (cluster.isMaster || exclusive) {\n    server._listen2(address, port, addressType, backlog, fd, flags);\n    return;\n  }\n\n  const serverQuery = {\n    address: address,\n    port: port, \n    addressType: addressType,\n    fd: fd,\n    flags,\n  };\n  cluster._getServer(server, serverQuery, listenOnMasterHandle);\n\n  function listenOnMasterHandle(err, handle) {\n    // ...\n    server._handle = handle;\n    server._listen2(address, port, addressType, backlog, fd, flags);\n  }\n}\n```\n\n```javascript\n// lib/internal/cluster/child.js\ncluster._getServer = function (obj, options, cb) {\n  let address = options.address;\n\t// ...\n  // servercluster.child\n  // index\n  const indexesKey = [\n    address, \n    options.port,\n    options.addressType,\n    options.fd,\n  ].join(\":\"); \n\n  let index = indexes.get(indexesKey);\n\n  if (index === undefined) index = 0;\n  else index++;\n\n  indexes.set(indexesKey, index);\n\n  const message = {\n    act: \"queryServer\",\n    index,\n    data: null,\n    ...options,\n  };\n  \n  // ...\n\n  send(message, (reply, handle) => {\n    // ...\n    if (handle) shared(reply, handle, indexesKey, cb);\n    // Shared listen socket.\n    else rr(reply, indexesKey, cb); // Round-robin  handle null\n  });\n  // ...\n};\nfunction rr(message, indexesKey, cb) {\n  if (message.errno) return cb(message.errno, null);\n\n  var key = message.key;\n\n  function listen(backlog) {\n    return 0;\n  }\n\n  function close() {\n    if (key === undefined) return;\n    send({ act: \"close\", key });\n    handles.delete(key);\n    indexes.delete(indexesKey);\n    key = undefined;\n  }\n\n  function getsockname(out) {\n    if (key) Object.assign(out, message.sockname);\n    return 0;\n  }\n\n  const handle = { close, listen, ref: noop, unref: noop };\n\n  if (message.sockname) {\n    handle.getsockname = getsockname; // TCP handles only.\n  }\n\n  assert(handles.has(key) === false);\n  handles.set(key, handle);\n  cb(0, handle); // handlelistenInClusterhandleserver._handle\n}\n// Round-robin connection.\nfunction onconnection(message, handle) {\n  const key = message.key; // maseterkey\n  const server = handles.get(key); // clientserver\n  const accepted = server !== undefined;\n\n  send({ ack: message.seq, accepted }); //  master\n\n  // cluster.child rrserveronconnection\n  // cbnet.jsonconnection\n  if (accepted) server.onconnection(0, handle);\n}\n```\n\n```javascript\n// lib/internal/cluster/master.js\nfunction queryServer(worker, message) {\n  // workercluster.child worker\n  const key =\n    `${message.address}:${message.port}:${message.addressType}:` +\n    `${message.fd}:${message.index}`;\n  var handle = handles.get(key);\n\n  if (handle === undefined) {\n  \n    // RoundRobinShared\n    var constructor = RoundRobinHandle;\n    // ...\n    handle = new constructor(\n      key,\n      address,\n      message.port,\n      message.addressType,\n      message.fd,\n      message.flags\n    );\n    handles.set(key, handle);\n  }\n  // ...\n  // cluster.childworkerhandle\n  handle.add(worker, (errno, reply, handle) => {\n    const { data } = handles.get(key);\n    send(\n      worker,\n      {\n        errno,\n        key,\n        ack: message.seq,\n        data,\n        ...reply,\n      },\n      handle // round_robin_handle null\n    );\n  });\n}\n```\n\n```javascript\n// lib/internal/cluster/round_robin_handle.js\nfunction RoundRobinHandle(key, address, port, addressType, fd, flags) {\n  this.key = key;\n  this.all = new Map();\n  this.free = [];\n  this.handles = [];\n  this.handle = null;\n  this.server = net.createServer(assert.fail);\n\n  if (fd >= 0) this.server.listen({ fd });\n  else if (port >= 0) {\n    this.server.listen({\n      port,\n      host: address,\n      // Currently, net module only supports `ipv6Only` option in `flags`.\n      ipv6Only: Boolean(flags & constants.UV_TCP_IPV6ONLY),\n    });\n  } else this.server.listen(address); // UNIX socket path.\n\n  this.server.once(\"listening\", () => {\n    this.handle = this.server._handle;\n    // onconnection\n    // distribute \n    this.handle.onconnection = (err, handle) => this.distribute(err, handle);\n    this.server._handle = null;\n    this.server = null;\n  });\n}\n\nRoundRobinHandle.prototype.add = function (worker, send) {\n  assert(this.all.has(worker.id) === false);\n  this.all.set(worker.id, worker);\n\n  const done = () => {\n    if (this.handle.getsockname) {\n      // tcp\\udp getsockname\n      const out = {};\n      this.handle.getsockname(out);\n      // TODO(bnoordhuis) Check err.\n      send(null, { sockname: out }, null);\n    } else {\n      send(null, null, null); // UNIX socket.\n    }\n\n    this.handoff(worker); // In case there are connections pending.\n  };\n\n  if (this.server === null) return done();\n\n  // Still busy binding.\n  this.server.once(\"listening\", done);\n  this.server.once(\"error\", (err) => {\n    send(err.errno, null);\n  });\n};\n\nRoundRobinHandle.prototype.distribute = function (err, handle) {\n  this.handles.push(handle);\n  const worker = this.free.shift();\n\n  if (worker) this.handoff(worker);\n};\n\nRoundRobinHandle.prototype.handoff = function (worker) {\n  // worker\n  if (this.all.has(worker.id) === false) {\n    return; // Worker is closing (or has closed) the server.\n  }\n\n  const handle = this.handles.shift(); // \n\n  if (handle === undefined) {\n    this.free.push(worker);  // workerfree\n    return;\n  }\n\n  const message = { act: \"newconn\", key: this.key };\n\n  sendHelper(worker.process, message, handle, (reply) => {\n    if (reply.accepted) handle.close();\n    else this.distribute(0, handle); // Worker is shutting down. Send to another.\n\n    this.handoff(worker);\n  });\n};\n```\n\n### \n\n`cluster`child_processfork`NODE_UNIQUE_ID`require('cluster')`master.js``child.js``RoundRobinHandle``cluster`TCP`net`masterchildchildchildmasterServer`RoundRobinHandle`serverTCP`free`workercluster.child","source":"_posts/node-js-net-cluster-fork.md","raw":"---\nlayout: minos\ntitle: Node.js cluster\ndate: 2020-05-03 15:24:53\ncategory: JavaScript\ntags:\n  - Node.js\n  - JavaScript\nkeywords: child_process,cluster,fork,Node.js,TCP\ndescription: RoundRobinHandleclusterTCPnetmasterchildchildchildmasterServerRoundRobinHandleserverTCPfreeworkercluster.child\n---\n\nNode.js**child_process**4`exec``execFile``fork``spawn`**cluster**cluster.forkNet Server\n\n**cluster**\n\n- [fork](http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env): \n\n<!-- more -->\n\n<br/>\n\n****\n\n```markdown\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n**cluster**\n\n```markdown\nlib\n  - internal\n    - cluster\n    - child.js\n      - master.js\n      - round_robin_handle.js\n      - shared_handle.js\n      - utils.js\n      - worker.js\n  - cluster.js\n```\n\n<br/>\n\n****\n\n```javascript\nconst cluster = require('cluster');\nconst http = require('http');\nconst numCPUs = require('os').cpus().length;\n\nif (cluster.isMaster) {\n  console.log(` ${process.pid} `);\n\n  // \n  for (let i = 0; i < numCPUs; i++) {\n    cluster.fork();\n  }\n\n  cluster.on('exit', (worker, code, signal) => {\n    console.log(` ${worker.process.pid} `);\n  });\n} else {\n  //  TCP \n  //  HTTP \n  http.createServer((req, res) => {\n    res.writeHead(200);\n    res.end('\\n');\n  }).listen(8000);\n\n  console.log(` ${process.pid} `);\n}\n```\n\n<br/>\n\n### Q:cluster.isMaster\n\n```javascript\n// lib/cluster.js\nconst childOrMaster = 'NODE_UNIQUE_ID' in process.env ? 'child' : 'master';\nmodule.exports = require(`internal/cluster/${childOrMaster}`);\n```\n\n`lib/cluster.js`cluster`NODE_UNIQUE_ID`\n\n`cluster.fork``NODE_UNIQUE_ID`**child_process.fork**\n\n```javascript\n// lib/internal/cluster/master.js\n// ...\ncluster.isMaster = true;\n// ...\n// fork\nconst workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\nreturn fork(cluster.settings.exec, cluster.settings.args, {\n  // ...\n  env: workerEnv,\n});\n\n// lib/internal/cluster/child.js\n// ...\ncluster.isMaster = false;\n```\n\n### Q:cluster.fork\n\n`cluster.setupMaster`\n\n`createWorkerProcess``child_process.fork`\n\n`Worker`workercluster(master)`message``exit``disconnect`**Worker**`lib/internal/cluster/worker.js`\n\n`internalMessage`internalMessage\n\n>  **{cmd: 'NODE_foo'}**  **cmd**  **NODE_**  Node.js  **'message'**  **'internalMessage'**  Node.js  **'internalMessage'** \n\n`internalMessage``internal(worker, onmessage)`**internal**`lib/internal/cluster/master.js`**onmessage**\n\n**onmessage**if-elsecluster.child(`act`)`queryServer`Net Server\n\n```javascript\n// lib/internal/cluster/master.js\ncluster.fork = function (env) {\n  cluster.setupMaster();\n  const id = ++ids;\n  // \n  const workerProcess = createWorkerProcess(id, env);\n  //\n  const worker = new Worker({\n    id: id,\n    process: workerProcess, // \n  });\n  \n  worker.on(\"message\", function (message, handle) {\n    cluster.emit(\"message\", this, message, handle);\n  });\n  worker.process.once(\"exit\", (exitCode, signalCode) => {\n    // ...\n    worker.state = \"dead\";\n    worker.emit(\"exit\", exitCode, signalCode);\n    cluster.emit(\"exit\", worker, exitCode, signalCode);\n  });\n  worker.process.once(\"disconnect\", () => {\n    // ...\n    worker.state = \"disconnected\";\n    worker.emit(\"disconnect\");\n    cluster.emit(\"disconnect\", worker);\n  });\n\n  worker.process.on(\"internalMessage\", internal(worker, onmessage));\n  //  fork \n  process.nextTick(emitForkNT, worker);\n  cluster.workers[worker.id] = worker; \n  return worker;\n};\n\nfunction createWorkerProcess(id, env) {\n  const workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };\n  // ... \n  // child_processfork\n  return fork(cluster.settings.exec, cluster.settings.args, {\n    cwd: cluster.settings.cwd,\n    env: workerEnv,\n    silent: cluster.settings.silent,\n    windowsHide: cluster.settings.windowsHide,\n    execArgv: execArgv,\n    stdio: cluster.settings.stdio,\n    gid: cluster.settings.gid,\n    uid: cluster.settings.uid,\n  });\n}\nfunction onmessage(message, handle) {\n  const worker = this;\n  // ... if message.act   queryServer\n  if (message.act === \"queryServer\") queryServer(worker, message);\n}\n```\n\n```javascript\n// lib/internal/cluster/utils.js\n// clusterchilidmastersendsendHelper\nlet seq = 0;\nfunction sendHelper(proc, message, handle, cb) {\n  if (!proc.connected) return false;\n  // NODE_*  internalMessage \n  message = { cmd: \"NODE_CLUSTER\", ...message, seq };\n\n  if (typeof cb === \"function\") callbacks.set(seq, cb); // \n\n  seq += 1;\n  // cluster/child.js handle => null\n  // cluster/master.js handle => null\n  return proc.send(message, handle);\n}\n```\n\ncluster.forkWorkerinternalMessageclusterchildmaster`sendHelper`\n\n### Q:cluster.forkTCP\n\n`net`Servercluster`child``master`\n\n`http``net``net.createServer``listen`\n\n#### Child:\n\ncluster.childTCP`port`8000`host`\n\n`listenInCluster`**cluster**\n\n`listen``cluster._getServer``act`serverQuerycluster.master\n\n#### Master:\n\n`master.onmessage`act`serverQuery`\n\n`queryServer``RoundRobinHandle`\n\n`RoundRobinHandle``net.createServer`Servercluster.master`listenInCluster``server._listen2`new  `TCP`src/tcp_wrap.cc`server._handle`cluster.masterTCPmasterchild\n\n`RoundRobinHandle`server`listening``server._handle``distribute``onconnection`\n\n`distribute`TCPcluster.child`free``add`workerworkercluster.child`act`**newconn**TCP\n\n#### Child:\n\ncluster.child`onconnection``act`**newconn**server`onconnection`child`Socket``onnection`\n\n\n\n**\n\n```javascript\n// lib/net.js\nfunction createServer(options, connectionListener) {\n  return new Server(options, connectionListener);\n}\nfunction Server(options, connectionListener) {\n  // ... \n}\nServer.prototype.listen = function (...args) {\n  // ...\n  // port8000host\n  var backlog;\n  if (typeof options.port === \"number\" || typeof options.port === \"string\") {\n    backlog = options.backlog || backlogFromArgs;\n    if (options.host) {\n      // ...\n    } else {\n      // \n      listenInCluster(\n        this,\n        null,\n        options.port | 0,\n        4,\n        backlog,\n        undefined,\n        options.exclusive\n      );\n    }\n    return this;\n  }\n\t// ...\n};\n\n\nfunction listenInCluster(\n  server,\n  address,\n  port,\n  addressType,\n  backlog,\n  fd,\n  exclusive,\n  flags\n) {\n  exclusive = !!exclusive;\n\n  if (cluster === undefined) cluster = require(\"cluster\");\n\n  if (cluster.isMaster || exclusive) {\n    server._listen2(address, port, addressType, backlog, fd, flags);\n    return;\n  }\n\n  const serverQuery = {\n    address: address,\n    port: port, \n    addressType: addressType,\n    fd: fd,\n    flags,\n  };\n  cluster._getServer(server, serverQuery, listenOnMasterHandle);\n\n  function listenOnMasterHandle(err, handle) {\n    // ...\n    server._handle = handle;\n    server._listen2(address, port, addressType, backlog, fd, flags);\n  }\n}\n```\n\n```javascript\n// lib/internal/cluster/child.js\ncluster._getServer = function (obj, options, cb) {\n  let address = options.address;\n\t// ...\n  // servercluster.child\n  // index\n  const indexesKey = [\n    address, \n    options.port,\n    options.addressType,\n    options.fd,\n  ].join(\":\"); \n\n  let index = indexes.get(indexesKey);\n\n  if (index === undefined) index = 0;\n  else index++;\n\n  indexes.set(indexesKey, index);\n\n  const message = {\n    act: \"queryServer\",\n    index,\n    data: null,\n    ...options,\n  };\n  \n  // ...\n\n  send(message, (reply, handle) => {\n    // ...\n    if (handle) shared(reply, handle, indexesKey, cb);\n    // Shared listen socket.\n    else rr(reply, indexesKey, cb); // Round-robin  handle null\n  });\n  // ...\n};\nfunction rr(message, indexesKey, cb) {\n  if (message.errno) return cb(message.errno, null);\n\n  var key = message.key;\n\n  function listen(backlog) {\n    return 0;\n  }\n\n  function close() {\n    if (key === undefined) return;\n    send({ act: \"close\", key });\n    handles.delete(key);\n    indexes.delete(indexesKey);\n    key = undefined;\n  }\n\n  function getsockname(out) {\n    if (key) Object.assign(out, message.sockname);\n    return 0;\n  }\n\n  const handle = { close, listen, ref: noop, unref: noop };\n\n  if (message.sockname) {\n    handle.getsockname = getsockname; // TCP handles only.\n  }\n\n  assert(handles.has(key) === false);\n  handles.set(key, handle);\n  cb(0, handle); // handlelistenInClusterhandleserver._handle\n}\n// Round-robin connection.\nfunction onconnection(message, handle) {\n  const key = message.key; // maseterkey\n  const server = handles.get(key); // clientserver\n  const accepted = server !== undefined;\n\n  send({ ack: message.seq, accepted }); //  master\n\n  // cluster.child rrserveronconnection\n  // cbnet.jsonconnection\n  if (accepted) server.onconnection(0, handle);\n}\n```\n\n```javascript\n// lib/internal/cluster/master.js\nfunction queryServer(worker, message) {\n  // workercluster.child worker\n  const key =\n    `${message.address}:${message.port}:${message.addressType}:` +\n    `${message.fd}:${message.index}`;\n  var handle = handles.get(key);\n\n  if (handle === undefined) {\n  \n    // RoundRobinShared\n    var constructor = RoundRobinHandle;\n    // ...\n    handle = new constructor(\n      key,\n      address,\n      message.port,\n      message.addressType,\n      message.fd,\n      message.flags\n    );\n    handles.set(key, handle);\n  }\n  // ...\n  // cluster.childworkerhandle\n  handle.add(worker, (errno, reply, handle) => {\n    const { data } = handles.get(key);\n    send(\n      worker,\n      {\n        errno,\n        key,\n        ack: message.seq,\n        data,\n        ...reply,\n      },\n      handle // round_robin_handle null\n    );\n  });\n}\n```\n\n```javascript\n// lib/internal/cluster/round_robin_handle.js\nfunction RoundRobinHandle(key, address, port, addressType, fd, flags) {\n  this.key = key;\n  this.all = new Map();\n  this.free = [];\n  this.handles = [];\n  this.handle = null;\n  this.server = net.createServer(assert.fail);\n\n  if (fd >= 0) this.server.listen({ fd });\n  else if (port >= 0) {\n    this.server.listen({\n      port,\n      host: address,\n      // Currently, net module only supports `ipv6Only` option in `flags`.\n      ipv6Only: Boolean(flags & constants.UV_TCP_IPV6ONLY),\n    });\n  } else this.server.listen(address); // UNIX socket path.\n\n  this.server.once(\"listening\", () => {\n    this.handle = this.server._handle;\n    // onconnection\n    // distribute \n    this.handle.onconnection = (err, handle) => this.distribute(err, handle);\n    this.server._handle = null;\n    this.server = null;\n  });\n}\n\nRoundRobinHandle.prototype.add = function (worker, send) {\n  assert(this.all.has(worker.id) === false);\n  this.all.set(worker.id, worker);\n\n  const done = () => {\n    if (this.handle.getsockname) {\n      // tcp\\udp getsockname\n      const out = {};\n      this.handle.getsockname(out);\n      // TODO(bnoordhuis) Check err.\n      send(null, { sockname: out }, null);\n    } else {\n      send(null, null, null); // UNIX socket.\n    }\n\n    this.handoff(worker); // In case there are connections pending.\n  };\n\n  if (this.server === null) return done();\n\n  // Still busy binding.\n  this.server.once(\"listening\", done);\n  this.server.once(\"error\", (err) => {\n    send(err.errno, null);\n  });\n};\n\nRoundRobinHandle.prototype.distribute = function (err, handle) {\n  this.handles.push(handle);\n  const worker = this.free.shift();\n\n  if (worker) this.handoff(worker);\n};\n\nRoundRobinHandle.prototype.handoff = function (worker) {\n  // worker\n  if (this.all.has(worker.id) === false) {\n    return; // Worker is closing (or has closed) the server.\n  }\n\n  const handle = this.handles.shift(); // \n\n  if (handle === undefined) {\n    this.free.push(worker);  // workerfree\n    return;\n  }\n\n  const message = { act: \"newconn\", key: this.key };\n\n  sendHelper(worker.process, message, handle, (reply) => {\n    if (reply.accepted) handle.close();\n    else this.distribute(0, handle); // Worker is shutting down. Send to another.\n\n    this.handoff(worker);\n  });\n};\n```\n\n### \n\n`cluster`child_processfork`NODE_UNIQUE_ID`require('cluster')`master.js``child.js``RoundRobinHandle``cluster`TCP`net`masterchildchildchildmasterServer`RoundRobinHandle`serverTCP`free`workercluster.child","slug":"node-js-net-cluster-fork","published":1,"updated":"2024-04-08T13:38:51.018Z","comments":1,"photos":[],"_id":"cm3a45web001418fd16ynej5g","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p>Node.js<strong>child_process</strong>4<code>exec</code><code>execFile</code><code>fork</code><code>spawn</code><strong>cluster</strong>cluster.forkNet Server</p>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\">fork</a>: </li>\n</ul>\n<span id=\"more\"></span>\n\n<br>\n\n<p><strong></strong></p>\n<figure class=\"highlight markdown hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"hljs-section\">#define UV<span class=\"hljs-emphasis\">_VERSION_</span>MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV<span class=\"hljs-emphasis\">_VERSION_</span>MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define UV<span class=\"hljs-emphasis\">_VERSION_</span>PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"hljs-section\">#define V8<span class=\"hljs-emphasis\">_MAJOR_</span>VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8<span class=\"hljs-emphasis\">_MINOR_</span>VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8<span class=\"hljs-emphasis\">_BUILD_</span>NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define V8<span class=\"hljs-emphasis\">_PATCH_</span>LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE<span class=\"hljs-emphasis\">_MAJOR_</span>VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE<span class=\"hljs-emphasis\">_MINOR_</span>VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-section\">#define NODE<span class=\"hljs-emphasis\">_PATCH_</span>VERSION 0</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>cluster</strong></p>\n<figure class=\"highlight markdown hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lib</span><br><span class=\"line\"><span class=\"hljs-bullet\">  -</span> internal</span><br><span class=\"line\"><span class=\"hljs-bullet\">    -</span> cluster</span><br><span class=\"line\"><span class=\"hljs-bullet\">    -</span> child.js</span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> master.js</span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> round<span class=\"hljs-emphasis\">_robin_</span>handle.js</span><br><span class=\"line\"><span class=\"hljs-bullet\">      -</span> shared<span class=\"hljs-emphasis\">_handle.js</span></span><br><span class=\"line\"><span class=\"hljs-emphasis\">      - utils.js</span></span><br><span class=\"line\"><span class=\"hljs-emphasis\">      - worker.js</span></span><br><span class=\"line\"><span class=\"hljs-emphasis\">  - cluster.js</span></span><br></pre></td></tr></tbody></table></figure>\n\n<br>\n\n<p><strong></strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> cluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'cluster'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> http = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'http'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> numCPUs = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'os'</span>).<span class=\"title function_\">cpus</span>().<span class=\"hljs-property\">length</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">if</span> (cluster.<span class=\"hljs-property\">isMaster</span>) {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">` <span class=\"hljs-subst\">${process.pid}</span> `</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>; i &lt; numCPUs; i++) {</span><br><span class=\"line\">    cluster.<span class=\"title function_\">fork</span>();</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  cluster.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">'exit'</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">worker, code, signal</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">` <span class=\"hljs-subst\">${worker.process.pid}</span> `</span>);</span><br><span class=\"line\">  });</span><br><span class=\"line\">} <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  TCP </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">//  HTTP </span></span><br><span class=\"line\">  http.<span class=\"title function_\">createServer</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">req, res</span>) =&gt;</span> {</span><br><span class=\"line\">    res.<span class=\"title function_\">writeHead</span>(<span class=\"hljs-number\">200</span>);</span><br><span class=\"line\">    res.<span class=\"title function_\">end</span>(<span class=\"hljs-string\">'\\n'</span>);</span><br><span class=\"line\">  }).<span class=\"title function_\">listen</span>(<span class=\"hljs-number\">8000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">` <span class=\"hljs-subst\">${process.pid}</span> `</span>);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<br>\n\n<h3 id=\"Q-cluster-isMaster\"><a href=\"#Q-cluster-isMaster\" class=\"headerlink\" title=\"Q:cluster.isMaster\"></a>Q:cluster.isMaster</h3><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/cluster.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> childOrMaster = <span class=\"hljs-string\">'NODE_UNIQUE_ID'</span> <span class=\"hljs-keyword\">in</span> process.<span class=\"hljs-property\">env</span> ? <span class=\"hljs-string\">'child'</span> : <span class=\"hljs-string\">'master'</span>;</span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"hljs-property\">exports</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">`internal/cluster/<span class=\"hljs-subst\">${childOrMaster}</span>`</span>);</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>lib/cluster.js</code>cluster<code>NODE_UNIQUE_ID</code></p>\n<p><code>cluster.fork</code><code>NODE_UNIQUE_ID</code><strong>child_process.fork</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">cluster.<span class=\"hljs-property\">isMaster</span> = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// fork</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> workerEnv = { ...process.<span class=\"hljs-property\">env</span>, ...env, <span class=\"hljs-attr\">NODE_UNIQUE_ID</span>: <span class=\"hljs-string\">`<span class=\"hljs-subst\">${id}</span>`</span> };</span><br><span class=\"line\"><span class=\"hljs-keyword\">return</span> <span class=\"title function_\">fork</span>(cluster.<span class=\"hljs-property\">settings</span>.<span class=\"hljs-property\">exec</span>, cluster.<span class=\"hljs-property\">settings</span>.<span class=\"hljs-property\">args</span>, {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-attr\">env</span>: workerEnv,</span><br><span class=\"line\">});</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">cluster.<span class=\"hljs-property\">isMaster</span> = <span class=\"hljs-literal\">false</span>;</span><br></pre></td></tr></tbody></table></figure>\n\n<h3 id=\"Q-cluster-fork\"><a href=\"#Q-cluster-fork\" class=\"headerlink\" title=\"Q:cluster.fork\"></a>Q:cluster.fork</h3><p><code>cluster.setupMaster</code></p>\n<p><code>createWorkerProcess</code><code>child_process.fork</code></p>\n<p><code>Worker</code>workercluster(master)<code>message</code><code>exit</code><code>disconnect</code><strong>Worker</strong><code>lib/internal/cluster/worker.js</code></p>\n<p><code>internalMessage</code>internalMessage</p>\n<blockquote>\n<p> <strong>{cmd: NODE_foo}</strong>  <strong>cmd</strong>  <strong>NODE_</strong>  Node.js  <strong>message<strong>  <strong>internalMessage</strong>  Node.js  </strong>internalMessage</strong> </p>\n</blockquote>\n<p><code>internalMessage</code><code>internal(worker, onmessage)</code><strong>internal</strong><code>lib/internal/cluster/master.js</code><strong>onmessage</strong></p>\n<p><strong>onmessage</strong>if-elsecluster.child(<code>act</code>)<code>queryServer</code>Net Server</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\">cluster.<span class=\"hljs-property\">fork</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">env</span>) {</span><br><span class=\"line\">  cluster.<span class=\"title function_\">setupMaster</span>();</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> id = ++ids;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> workerProcess = <span class=\"title function_\">createWorkerProcess</span>(id, env);</span><br><span class=\"line\">  <span class=\"hljs-comment\">//</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> worker = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Worker</span>({</span><br><span class=\"line\">    <span class=\"hljs-attr\">id</span>: id,</span><br><span class=\"line\">    <span class=\"hljs-attr\">process</span>: workerProcess, <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  });</span><br><span class=\"line\">  </span><br><span class=\"line\">  worker.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">\"message\"</span>, <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">message, handle</span>) {</span><br><span class=\"line\">    cluster.<span class=\"title function_\">emit</span>(<span class=\"hljs-string\">\"message\"</span>, <span class=\"variable language_\">this</span>, message, handle);</span><br><span class=\"line\">  });</span><br><span class=\"line\">  worker.<span class=\"hljs-property\">process</span>.<span class=\"title function_\">once</span>(<span class=\"hljs-string\">\"exit\"</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">exitCode, signalCode</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    worker.<span class=\"hljs-property\">state</span> = <span class=\"hljs-string\">\"dead\"</span>;</span><br><span class=\"line\">    worker.<span class=\"title function_\">emit</span>(<span class=\"hljs-string\">\"exit\"</span>, exitCode, signalCode);</span><br><span class=\"line\">    cluster.<span class=\"title function_\">emit</span>(<span class=\"hljs-string\">\"exit\"</span>, worker, exitCode, signalCode);</span><br><span class=\"line\">  });</span><br><span class=\"line\">  worker.<span class=\"hljs-property\">process</span>.<span class=\"title function_\">once</span>(<span class=\"hljs-string\">\"disconnect\"</span>, <span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    worker.<span class=\"hljs-property\">state</span> = <span class=\"hljs-string\">\"disconnected\"</span>;</span><br><span class=\"line\">    worker.<span class=\"title function_\">emit</span>(<span class=\"hljs-string\">\"disconnect\"</span>);</span><br><span class=\"line\">    cluster.<span class=\"title function_\">emit</span>(<span class=\"hljs-string\">\"disconnect\"</span>, worker);</span><br><span class=\"line\">  });</span><br><span class=\"line\"></span><br><span class=\"line\">  worker.<span class=\"hljs-property\">process</span>.<span class=\"title function_\">on</span>(<span class=\"hljs-string\">\"internalMessage\"</span>, <span class=\"title function_\">internal</span>(worker, onmessage));</span><br><span class=\"line\">  <span class=\"hljs-comment\">//  fork </span></span><br><span class=\"line\">  process.<span class=\"title function_\">nextTick</span>(emitForkNT, worker);</span><br><span class=\"line\">  cluster.<span class=\"hljs-property\">workers</span>[worker.<span class=\"hljs-property\">id</span>] = worker; </span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> worker;</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">createWorkerProcess</span>(<span class=\"hljs-params\">id, env</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> workerEnv = { ...process.<span class=\"hljs-property\">env</span>, ...env, <span class=\"hljs-attr\">NODE_UNIQUE_ID</span>: <span class=\"hljs-string\">`<span class=\"hljs-subst\">${id}</span>`</span> };</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... </span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// child_processfork</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"title function_\">fork</span>(cluster.<span class=\"hljs-property\">settings</span>.<span class=\"hljs-property\">exec</span>, cluster.<span class=\"hljs-property\">settings</span>.<span class=\"hljs-property\">args</span>, {</span><br><span class=\"line\">    <span class=\"hljs-attr\">cwd</span>: cluster.<span class=\"hljs-property\">settings</span>.<span class=\"hljs-property\">cwd</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">env</span>: workerEnv,</span><br><span class=\"line\">    <span class=\"hljs-attr\">silent</span>: cluster.<span class=\"hljs-property\">settings</span>.<span class=\"hljs-property\">silent</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">windowsHide</span>: cluster.<span class=\"hljs-property\">settings</span>.<span class=\"hljs-property\">windowsHide</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">execArgv</span>: execArgv,</span><br><span class=\"line\">    <span class=\"hljs-attr\">stdio</span>: cluster.<span class=\"hljs-property\">settings</span>.<span class=\"hljs-property\">stdio</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">gid</span>: cluster.<span class=\"hljs-property\">settings</span>.<span class=\"hljs-property\">gid</span>,</span><br><span class=\"line\">    <span class=\"hljs-attr\">uid</span>: cluster.<span class=\"hljs-property\">settings</span>.<span class=\"hljs-property\">uid</span>,</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">onmessage</span>(<span class=\"hljs-params\">message, handle</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> worker = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... if message.act   queryServer</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (message.<span class=\"hljs-property\">act</span> === <span class=\"hljs-string\">\"queryServer\"</span>) <span class=\"title function_\">queryServer</span>(worker, message);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/utils.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// clusterchilidmastersendsendHelper</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> seq = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">sendHelper</span>(<span class=\"hljs-params\">proc, message, handle, cb</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!proc.<span class=\"hljs-property\">connected</span>) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// NODE_*  internalMessage </span></span><br><span class=\"line\">  message = { <span class=\"hljs-attr\">cmd</span>: <span class=\"hljs-string\">\"NODE_CLUSTER\"</span>, ...message, seq };</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> cb === <span class=\"hljs-string\">\"function\"</span>) callbacks.<span class=\"title function_\">set</span>(seq, cb); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  seq += <span class=\"hljs-number\">1</span>;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// cluster/child.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// cluster/master.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> proc.<span class=\"title function_\">send</span>(message, handle);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>cluster.forkWorkerinternalMessageclusterchildmaster<code>sendHelper</code></p>\n<h3 id=\"Q-cluster-forkTCP\"><a href=\"#Q-cluster-forkTCP\" class=\"headerlink\" title=\"Q:cluster.forkTCP\"></a>Q:cluster.forkTCP</h3><p><code>net</code>Servercluster<code>child</code><code>master</code></p>\n<p><code>http</code><code>net</code><code>net.createServer</code><code>listen</code></p>\n<h4 id=\"Child\"><a href=\"#Child\" class=\"headerlink\" title=\"Child:\"></a>Child:</h4><p>cluster.childTCP<code>port</code>8000<code>host</code></p>\n<p><code>listenInCluster</code><strong>cluster</strong></p>\n<p><code>listen</code><code>cluster._getServer</code><code>act</code>serverQuerycluster.master</p>\n<h4 id=\"Master\"><a href=\"#Master\" class=\"headerlink\" title=\"Master:\"></a>Master:</h4><p><code>master.onmessage</code>act<code>serverQuery</code></p>\n<p><code>queryServer</code><code>RoundRobinHandle</code></p>\n<p><code>RoundRobinHandle</code><code>net.createServer</code>Servercluster.master<code>listenInCluster</code><code>server._listen2</code>new  <code>TCP</code>src/tcp_wrap.cc<code>server._handle</code>cluster.masterTCPmasterchild</p>\n<p><code>RoundRobinHandle</code>server<code>listening</code><code>server._handle</code><code>distribute</code><code>onconnection</code></p>\n<p><code>distribute</code>TCPcluster.child<code>free</code><code>add</code>workerworkercluster.child<code>act</code><strong>newconn</strong>TCP</p>\n<h4 id=\"Child\"><a href=\"#Child\" class=\"headerlink\" title=\"Child:\"></a>Child:</h4><p>cluster.child<code>onconnection</code><code>act</code><strong>newconn</strong>server<code>onconnection</code>child<code>Socket</code><code>onnection</code></p>\n<p></p>\n<p><em></em></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/net.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">createServer</span>(<span class=\"hljs-params\">options, connectionListener</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Server</span>(options, connectionListener);</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">Server</span>(<span class=\"hljs-params\">options, connectionListener</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... </span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"title class_\">Server</span>.<span class=\"hljs-property\"><span class=\"hljs-keyword\">prototype</span></span>.<span class=\"hljs-property\">listen</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">...args</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// port8000host</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> backlog;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> options.<span class=\"hljs-property\">port</span> === <span class=\"hljs-string\">\"number\"</span> || <span class=\"hljs-keyword\">typeof</span> options.<span class=\"hljs-property\">port</span> === <span class=\"hljs-string\">\"string\"</span>) {</span><br><span class=\"line\">    backlog = options.<span class=\"hljs-property\">backlog</span> || backlogFromArgs;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (options.<span class=\"hljs-property\">host</span>) {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"title function_\">listenInCluster</span>(</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>,</span><br><span class=\"line\">        <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">        options.<span class=\"hljs-property\">port</span> | <span class=\"hljs-number\">0</span>,</span><br><span class=\"line\">        <span class=\"hljs-number\">4</span>,</span><br><span class=\"line\">        backlog,</span><br><span class=\"line\">        <span class=\"hljs-literal\">undefined</span>,</span><br><span class=\"line\">        options.<span class=\"hljs-property\">exclusive</span></span><br><span class=\"line\">      );</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\">\t<span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">listenInCluster</span>(<span class=\"hljs-params\"></span></span><br><span class=\"line\"><span class=\"hljs-params\">  server,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  address,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  port,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  addressType,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  backlog,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  fd,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  exclusive,</span></span><br><span class=\"line\"><span class=\"hljs-params\">  flags</span></span><br><span class=\"line\"><span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">  exclusive = !!exclusive;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (cluster === <span class=\"hljs-literal\">undefined</span>) cluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">\"cluster\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (cluster.<span class=\"hljs-property\">isMaster</span> || exclusive) {</span><br><span class=\"line\">    server.<span class=\"title function_\">_listen2</span>(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> serverQuery = {</span><br><span class=\"line\">    <span class=\"hljs-attr\">address</span>: address,</span><br><span class=\"line\">    <span class=\"hljs-attr\">port</span>: port, </span><br><span class=\"line\">    <span class=\"hljs-attr\">addressType</span>: addressType,</span><br><span class=\"line\">    <span class=\"hljs-attr\">fd</span>: fd,</span><br><span class=\"line\">    flags,</span><br><span class=\"line\">  };</span><br><span class=\"line\">  cluster.<span class=\"title function_\">_getServer</span>(server, serverQuery, listenOnMasterHandle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">listenOnMasterHandle</span>(<span class=\"hljs-params\">err, handle</span>) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    server.<span class=\"hljs-property\">_handle</span> = handle;</span><br><span class=\"line\">    server.<span class=\"title function_\">_listen2</span>(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\">cluster.<span class=\"hljs-property\">_getServer</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">obj, options, cb</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> address = options.<span class=\"hljs-property\">address</span>;</span><br><span class=\"line\">\t<span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// servercluster.child</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// index</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> indexesKey = [</span><br><span class=\"line\">    address, </span><br><span class=\"line\">    options.<span class=\"hljs-property\">port</span>,</span><br><span class=\"line\">    options.<span class=\"hljs-property\">addressType</span>,</span><br><span class=\"line\">    options.<span class=\"hljs-property\">fd</span>,</span><br><span class=\"line\">  ].<span class=\"title function_\">join</span>(<span class=\"hljs-string\">\":\"</span>); </span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> index = indexes.<span class=\"title function_\">get</span>(indexesKey);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (index === <span class=\"hljs-literal\">undefined</span>) index = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">else</span> index++;</span><br><span class=\"line\"></span><br><span class=\"line\">  indexes.<span class=\"title function_\">set</span>(indexesKey, index);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> message = {</span><br><span class=\"line\">    <span class=\"hljs-attr\">act</span>: <span class=\"hljs-string\">\"queryServer\"</span>,</span><br><span class=\"line\">    index,</span><br><span class=\"line\">    <span class=\"hljs-attr\">data</span>: <span class=\"hljs-literal\">null</span>,</span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  };</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">send</span>(message, <span class=\"hljs-function\">(<span class=\"hljs-params\">reply, handle</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (handle) <span class=\"title function_\">shared</span>(reply, handle, indexesKey, cb);</span><br><span class=\"line\">    <span class=\"hljs-comment\">// Shared listen socket.</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">else</span> <span class=\"title function_\">rr</span>(reply, indexesKey, cb); <span class=\"hljs-comment\">// Round-robin  handle null</span></span><br><span class=\"line\">  });</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">};</span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">rr</span>(<span class=\"hljs-params\">message, indexesKey, cb</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (message.<span class=\"hljs-property\">errno</span>) <span class=\"hljs-keyword\">return</span> <span class=\"title function_\">cb</span>(message.<span class=\"hljs-property\">errno</span>, <span class=\"hljs-literal\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> key = message.<span class=\"hljs-property\">key</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">listen</span>(<span class=\"hljs-params\">backlog</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">close</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (key === <span class=\"hljs-literal\">undefined</span>) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"title function_\">send</span>({ <span class=\"hljs-attr\">act</span>: <span class=\"hljs-string\">\"close\"</span>, key });</span><br><span class=\"line\">    handles.<span class=\"title function_\">delete</span>(key);</span><br><span class=\"line\">    indexes.<span class=\"title function_\">delete</span>(indexesKey);</span><br><span class=\"line\">    key = <span class=\"hljs-literal\">undefined</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">getsockname</span>(<span class=\"hljs-params\">out</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (key) <span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>(out, message.<span class=\"hljs-property\">sockname</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> handle = { close, listen, <span class=\"hljs-attr\">ref</span>: noop, <span class=\"hljs-attr\">unref</span>: noop };</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (message.<span class=\"hljs-property\">sockname</span>) {</span><br><span class=\"line\">    handle.<span class=\"hljs-property\">getsockname</span> = getsockname; <span class=\"hljs-comment\">// TCP handles only.</span></span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">assert</span>(handles.<span class=\"title function_\">has</span>(key) === <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">  handles.<span class=\"title function_\">set</span>(key, handle);</span><br><span class=\"line\">  <span class=\"title function_\">cb</span>(<span class=\"hljs-number\">0</span>, handle); <span class=\"hljs-comment\">// handlelistenInClusterhandleserver._handle</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">// Round-robin connection.</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">onconnection</span>(<span class=\"hljs-params\">message, handle</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> key = message.<span class=\"hljs-property\">key</span>; <span class=\"hljs-comment\">// maseterkey</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> server = handles.<span class=\"title function_\">get</span>(key); <span class=\"hljs-comment\">// clientserver</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> accepted = server !== <span class=\"hljs-literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">send</span>({ <span class=\"hljs-attr\">ack</span>: message.<span class=\"hljs-property\">seq</span>, accepted }); <span class=\"hljs-comment\">//  master</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// cluster.child rrserveronconnection</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// cbnet.jsonconnection</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (accepted) server.<span class=\"title function_\">onconnection</span>(<span class=\"hljs-number\">0</span>, handle);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">queryServer</span>(<span class=\"hljs-params\">worker, message</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// workercluster.child worker</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> key =</span><br><span class=\"line\">    <span class=\"hljs-string\">`<span class=\"hljs-subst\">${message.address}</span>:<span class=\"hljs-subst\">${message.port}</span>:<span class=\"hljs-subst\">${message.addressType}</span>:`</span> +</span><br><span class=\"line\">    <span class=\"hljs-string\">`<span class=\"hljs-subst\">${message.fd}</span>:<span class=\"hljs-subst\">${message.index}</span>`</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> handle = handles.<span class=\"title function_\">get</span>(key);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (handle === <span class=\"hljs-literal\">undefined</span>) {</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"hljs-comment\">// RoundRobinShared</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> constructor = <span class=\"title class_\">RoundRobinHandle</span>;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    handle = <span class=\"hljs-keyword\">new</span> <span class=\"title function_\">constructor</span>(<span class=\"hljs-params\"></span></span><br><span class=\"line\"><span class=\"hljs-params\">      key,</span></span><br><span class=\"line\"><span class=\"hljs-params\">      address,</span></span><br><span class=\"line\"><span class=\"hljs-params\">      message.port,</span></span><br><span class=\"line\"><span class=\"hljs-params\">      message.addressType,</span></span><br><span class=\"line\"><span class=\"hljs-params\">      message.fd,</span></span><br><span class=\"line\"><span class=\"hljs-params\">      message.flags</span></span><br><span class=\"line\"><span class=\"hljs-params\">    </span>);</span><br><span class=\"line\">    handles.<span class=\"title function_\">set</span>(key, handle);</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// cluster.childworkerhandle</span></span><br><span class=\"line\">  handle.<span class=\"title function_\">add</span>(worker, <span class=\"hljs-function\">(<span class=\"hljs-params\">errno, reply, handle</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> { data } = handles.<span class=\"title function_\">get</span>(key);</span><br><span class=\"line\">    <span class=\"title function_\">send</span>(</span><br><span class=\"line\">      worker,</span><br><span class=\"line\">      {</span><br><span class=\"line\">        errno,</span><br><span class=\"line\">        key,</span><br><span class=\"line\">        <span class=\"hljs-attr\">ack</span>: message.<span class=\"hljs-property\">seq</span>,</span><br><span class=\"line\">        data,</span><br><span class=\"line\">        ...reply,</span><br><span class=\"line\">      },</span><br><span class=\"line\">      handle <span class=\"hljs-comment\">// round_robin_handle null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// lib/internal/cluster/round_robin_handle.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">RoundRobinHandle</span>(<span class=\"hljs-params\">key, address, port, addressType, fd, flags</span>) {</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">key</span> = key;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">all</span> = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Map</span>();</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">free</span> = [];</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">handles</span> = [];</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">handle</span> = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span> = net.<span class=\"title function_\">createServer</span>(assert.<span class=\"hljs-property\">fail</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (fd &gt;= <span class=\"hljs-number\">0</span>) <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span>.<span class=\"title function_\">listen</span>({ fd });</span><br><span class=\"line\">  <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (port &gt;= <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span>.<span class=\"title function_\">listen</span>({</span><br><span class=\"line\">      port,</span><br><span class=\"line\">      <span class=\"hljs-attr\">host</span>: address,</span><br><span class=\"line\">      <span class=\"hljs-comment\">// Currently, net module only supports `ipv6Only` option in `flags`.</span></span><br><span class=\"line\">      <span class=\"hljs-attr\">ipv6Only</span>: <span class=\"title class_\">Boolean</span>(flags &amp; constants.<span class=\"hljs-property\">UV_TCP_IPV6ONLY</span>),</span><br><span class=\"line\">    });</span><br><span class=\"line\">  } <span class=\"hljs-keyword\">else</span> <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span>.<span class=\"title function_\">listen</span>(address); <span class=\"hljs-comment\">// UNIX socket path.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span>.<span class=\"title function_\">once</span>(<span class=\"hljs-string\">\"listening\"</span>, <span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">handle</span> = <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span>.<span class=\"hljs-property\">_handle</span>;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// onconnection</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// distribute </span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">handle</span>.<span class=\"hljs-property\">onconnection</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">err, handle</span>) =&gt;</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">distribute</span>(err, handle);</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span>.<span class=\"hljs-property\">_handle</span> = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span> = <span class=\"hljs-literal\">null</span>;</span><br><span class=\"line\">  });</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">RoundRobinHandle</span>.<span class=\"hljs-property\"><span class=\"hljs-keyword\">prototype</span></span>.<span class=\"hljs-property\">add</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">worker, send</span>) {</span><br><span class=\"line\">  <span class=\"title function_\">assert</span>(<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">all</span>.<span class=\"title function_\">has</span>(worker.<span class=\"hljs-property\">id</span>) === <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">all</span>.<span class=\"title function_\">set</span>(worker.<span class=\"hljs-property\">id</span>, worker);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> <span class=\"title function_\">done</span> = (<span class=\"hljs-params\"></span>) =&gt; {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">handle</span>.<span class=\"hljs-property\">getsockname</span>) {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// tcp\\udp getsockname</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> out = {};</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">handle</span>.<span class=\"title function_\">getsockname</span>(out);</span><br><span class=\"line\">      <span class=\"hljs-comment\">// TODO(bnoordhuis) Check err.</span></span><br><span class=\"line\">      <span class=\"title function_\">send</span>(<span class=\"hljs-literal\">null</span>, { <span class=\"hljs-attr\">sockname</span>: out }, <span class=\"hljs-literal\">null</span>);</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">      <span class=\"title function_\">send</span>(<span class=\"hljs-literal\">null</span>, <span class=\"hljs-literal\">null</span>, <span class=\"hljs-literal\">null</span>); <span class=\"hljs-comment\">// UNIX socket.</span></span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">handoff</span>(worker); <span class=\"hljs-comment\">// In case there are connections pending.</span></span><br><span class=\"line\">  };</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span> === <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span> <span class=\"title function_\">done</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Still busy binding.</span></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span>.<span class=\"title function_\">once</span>(<span class=\"hljs-string\">\"listening\"</span>, done);</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">server</span>.<span class=\"title function_\">once</span>(<span class=\"hljs-string\">\"error\"</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">err</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"title function_\">send</span>(err.<span class=\"hljs-property\">errno</span>, <span class=\"hljs-literal\">null</span>);</span><br><span class=\"line\">  });</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">RoundRobinHandle</span>.<span class=\"hljs-property\"><span class=\"hljs-keyword\">prototype</span></span>.<span class=\"hljs-property\">distribute</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, handle</span>) {</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">handles</span>.<span class=\"title function_\">push</span>(handle);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> worker = <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">free</span>.<span class=\"title function_\">shift</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (worker) <span class=\"variable language_\">this</span>.<span class=\"title function_\">handoff</span>(worker);</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">RoundRobinHandle</span>.<span class=\"hljs-property\"><span class=\"hljs-keyword\">prototype</span></span>.<span class=\"hljs-property\">handoff</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">worker</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// worker</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">all</span>.<span class=\"title function_\">has</span>(worker.<span class=\"hljs-property\">id</span>) === <span class=\"hljs-literal\">false</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>; <span class=\"hljs-comment\">// Worker is closing (or has closed) the server.</span></span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> handle = <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">handles</span>.<span class=\"title function_\">shift</span>(); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (handle === <span class=\"hljs-literal\">undefined</span>) {</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">free</span>.<span class=\"title function_\">push</span>(worker);  <span class=\"hljs-comment\">// workerfree</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> message = { <span class=\"hljs-attr\">act</span>: <span class=\"hljs-string\">\"newconn\"</span>, <span class=\"hljs-attr\">key</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">key</span> };</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">sendHelper</span>(worker.<span class=\"hljs-property\">process</span>, message, handle, <span class=\"hljs-function\">(<span class=\"hljs-params\">reply</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (reply.<span class=\"hljs-property\">accepted</span>) handle.<span class=\"title function_\">close</span>();</span><br><span class=\"line\">    <span class=\"hljs-keyword\">else</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">distribute</span>(<span class=\"hljs-number\">0</span>, handle); <span class=\"hljs-comment\">// Worker is shutting down. Send to another.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">handoff</span>(worker);</span><br><span class=\"line\">  });</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>cluster</code>child_processfork<code>NODE_UNIQUE_ID</code>require(cluster)<code>master.js</code><code>child.js</code><code>RoundRobinHandle</code><code>cluster</code>TCP<code>net</code>masterchildchildchildmasterServer<code>RoundRobinHandle</code>serverTCP<code>free</code>workercluster.child</p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<html><head></head><body><p>Node.js<strong>child_process</strong>4<code>exec</code><code>execFile</code><code>fork</code><code>spawn</code><strong>cluster</strong>cluster.forkNet Server</p>\n<p><strong>cluster</strong></p>\n<ul>\n<li><a href=\"http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env\">fork</a>: </li>\n</ul></body></html>","more":"<br/>\n\n<p><strong></strong></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// libuv</span><br><span class=\"line\"><span class=\"section\">#define UV<span class=\"emphasis\">_VERSION_</span>MAJOR 1</span></span><br><span class=\"line\"><span class=\"section\">#define UV<span class=\"emphasis\">_VERSION_</span>MINOR 33</span></span><br><span class=\"line\"><span class=\"section\">#define UV<span class=\"emphasis\">_VERSION_</span>PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">// V8</span><br><span class=\"line\"><span class=\"section\">#define V8<span class=\"emphasis\">_MAJOR_</span>VERSION 7</span></span><br><span class=\"line\"><span class=\"section\">#define V8<span class=\"emphasis\">_MINOR_</span>VERSION 8</span></span><br><span class=\"line\"><span class=\"section\">#define V8<span class=\"emphasis\">_BUILD_</span>NUMBER 279</span></span><br><span class=\"line\"><span class=\"section\">#define V8<span class=\"emphasis\">_PATCH_</span>LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Node.js</span><br><span class=\"line\"><span class=\"section\">#define NODE<span class=\"emphasis\">_MAJOR_</span>VERSION 14</span></span><br><span class=\"line\"><span class=\"section\">#define NODE<span class=\"emphasis\">_MINOR_</span>VERSION 0</span></span><br><span class=\"line\"><span class=\"section\">#define NODE<span class=\"emphasis\">_PATCH_</span>VERSION 0</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>cluster</strong></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lib</span><br><span class=\"line\"><span class=\"bullet\">  -</span> internal</span><br><span class=\"line\"><span class=\"bullet\">    -</span> cluster</span><br><span class=\"line\"><span class=\"bullet\">    -</span> child.js</span><br><span class=\"line\"><span class=\"bullet\">      -</span> master.js</span><br><span class=\"line\"><span class=\"bullet\">      -</span> round<span class=\"emphasis\">_robin_</span>handle.js</span><br><span class=\"line\"><span class=\"bullet\">      -</span> shared<span class=\"emphasis\">_handle.js</span></span><br><span class=\"line\"><span class=\"emphasis\">      - utils.js</span></span><br><span class=\"line\"><span class=\"emphasis\">      - worker.js</span></span><br><span class=\"line\"><span class=\"emphasis\">  - cluster.js</span></span><br></pre></td></tr></table></figure>\n\n<br/>\n\n<p><strong></strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> cluster = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;cluster&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> http = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;http&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> numCPUs = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;os&#x27;</span>).<span class=\"title function_\">cpus</span>().<span class=\"property\">length</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (cluster.<span class=\"property\">isMaster</span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">` <span class=\"subst\">$&#123;process.pid&#125;</span> `</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class=\"line\">    cluster.<span class=\"title function_\">fork</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  cluster.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;exit&#x27;</span>, <span class=\"function\">(<span class=\"params\">worker, code, signal</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">` <span class=\"subst\">$&#123;worker.process.pid&#125;</span> `</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">//  TCP </span></span><br><span class=\"line\">  <span class=\"comment\">//  HTTP </span></span><br><span class=\"line\">  http.<span class=\"title function_\">createServer</span>(<span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">writeHead</span>(<span class=\"number\">200</span>);</span><br><span class=\"line\">    res.<span class=\"title function_\">end</span>(<span class=\"string\">&#x27;\\n&#x27;</span>);</span><br><span class=\"line\">  &#125;).<span class=\"title function_\">listen</span>(<span class=\"number\">8000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">` <span class=\"subst\">$&#123;process.pid&#125;</span> `</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<br/>\n\n<h3 id=\"Q-cluster-isMaster\"><a href=\"#Q-cluster-isMaster\" class=\"headerlink\" title=\"Q:cluster.isMaster\"></a>Q:cluster.isMaster</h3><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/cluster.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> childOrMaster = <span class=\"string\">&#x27;NODE_UNIQUE_ID&#x27;</span> <span class=\"keyword\">in</span> process.<span class=\"property\">env</span> ? <span class=\"string\">&#x27;child&#x27;</span> : <span class=\"string\">&#x27;master&#x27;</span>;</span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = <span class=\"built_in\">require</span>(<span class=\"string\">`internal/cluster/<span class=\"subst\">$&#123;childOrMaster&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>\n\n<p><code>lib/cluster.js</code>cluster<code>NODE_UNIQUE_ID</code></p>\n<p><code>cluster.fork</code><code>NODE_UNIQUE_ID</code><strong>child_process.fork</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">cluster.<span class=\"property\">isMaster</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"><span class=\"comment\">// fork</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> workerEnv = &#123; ...process.<span class=\"property\">env</span>, ...env, <span class=\"attr\">NODE_UNIQUE_ID</span>: <span class=\"string\">`<span class=\"subst\">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"title function_\">fork</span>(cluster.<span class=\"property\">settings</span>.<span class=\"property\">exec</span>, cluster.<span class=\"property\">settings</span>.<span class=\"property\">args</span>, &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"attr\">env</span>: workerEnv,</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">cluster.<span class=\"property\">isMaster</span> = <span class=\"literal\">false</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Q-cluster-fork\"><a href=\"#Q-cluster-fork\" class=\"headerlink\" title=\"Q:cluster.fork\"></a>Q:cluster.fork</h3><p><code>cluster.setupMaster</code></p>\n<p><code>createWorkerProcess</code><code>child_process.fork</code></p>\n<p><code>Worker</code>workercluster(master)<code>message</code><code>exit</code><code>disconnect</code><strong>Worker</strong><code>lib/internal/cluster/worker.js</code></p>\n<p><code>internalMessage</code>internalMessage</p>\n<blockquote>\n<p> <strong>{cmd: NODE_foo}</strong>  <strong>cmd</strong>  <strong>NODE_</strong>  Node.js  <strong>message<strong>  <strong>internalMessage</strong>  Node.js  </strong>internalMessage</strong> </p>\n</blockquote>\n<p><code>internalMessage</code><code>internal(worker, onmessage)</code><strong>internal</strong><code>lib/internal/cluster/master.js</code><strong>onmessage</strong></p>\n<p><strong>onmessage</strong>if-elsecluster.child(<code>act</code>)<code>queryServer</code>Net Server</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\">cluster.<span class=\"property\">fork</span> = <span class=\"keyword\">function</span> (<span class=\"params\">env</span>) &#123;</span><br><span class=\"line\">  cluster.<span class=\"title function_\">setupMaster</span>();</span><br><span class=\"line\">  <span class=\"keyword\">const</span> id = ++ids;</span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> workerProcess = <span class=\"title function_\">createWorkerProcess</span>(id, env);</span><br><span class=\"line\">  <span class=\"comment\">//</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> worker = <span class=\"keyword\">new</span> <span class=\"title class_\">Worker</span>(&#123;</span><br><span class=\"line\">    <span class=\"attr\">id</span>: id,</span><br><span class=\"line\">    <span class=\"attr\">process</span>: workerProcess, <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  </span><br><span class=\"line\">  worker.<span class=\"title function_\">on</span>(<span class=\"string\">&quot;message&quot;</span>, <span class=\"keyword\">function</span> (<span class=\"params\">message, handle</span>) &#123;</span><br><span class=\"line\">    cluster.<span class=\"title function_\">emit</span>(<span class=\"string\">&quot;message&quot;</span>, <span class=\"variable language_\">this</span>, message, handle);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  worker.<span class=\"property\">process</span>.<span class=\"title function_\">once</span>(<span class=\"string\">&quot;exit&quot;</span>, <span class=\"function\">(<span class=\"params\">exitCode, signalCode</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    worker.<span class=\"property\">state</span> = <span class=\"string\">&quot;dead&quot;</span>;</span><br><span class=\"line\">    worker.<span class=\"title function_\">emit</span>(<span class=\"string\">&quot;exit&quot;</span>, exitCode, signalCode);</span><br><span class=\"line\">    cluster.<span class=\"title function_\">emit</span>(<span class=\"string\">&quot;exit&quot;</span>, worker, exitCode, signalCode);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  worker.<span class=\"property\">process</span>.<span class=\"title function_\">once</span>(<span class=\"string\">&quot;disconnect&quot;</span>, <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    worker.<span class=\"property\">state</span> = <span class=\"string\">&quot;disconnected&quot;</span>;</span><br><span class=\"line\">    worker.<span class=\"title function_\">emit</span>(<span class=\"string\">&quot;disconnect&quot;</span>);</span><br><span class=\"line\">    cluster.<span class=\"title function_\">emit</span>(<span class=\"string\">&quot;disconnect&quot;</span>, worker);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  worker.<span class=\"property\">process</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&quot;internalMessage&quot;</span>, <span class=\"title function_\">internal</span>(worker, onmessage));</span><br><span class=\"line\">  <span class=\"comment\">//  fork </span></span><br><span class=\"line\">  process.<span class=\"title function_\">nextTick</span>(emitForkNT, worker);</span><br><span class=\"line\">  cluster.<span class=\"property\">workers</span>[worker.<span class=\"property\">id</span>] = worker; </span><br><span class=\"line\">  <span class=\"keyword\">return</span> worker;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">createWorkerProcess</span>(<span class=\"params\">id, env</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> workerEnv = &#123; ...process.<span class=\"property\">env</span>, ...env, <span class=\"attr\">NODE_UNIQUE_ID</span>: <span class=\"string\">`<span class=\"subst\">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class=\"line\">  <span class=\"comment\">// ... </span></span><br><span class=\"line\">  <span class=\"comment\">// child_processfork</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"title function_\">fork</span>(cluster.<span class=\"property\">settings</span>.<span class=\"property\">exec</span>, cluster.<span class=\"property\">settings</span>.<span class=\"property\">args</span>, &#123;</span><br><span class=\"line\">    <span class=\"attr\">cwd</span>: cluster.<span class=\"property\">settings</span>.<span class=\"property\">cwd</span>,</span><br><span class=\"line\">    <span class=\"attr\">env</span>: workerEnv,</span><br><span class=\"line\">    <span class=\"attr\">silent</span>: cluster.<span class=\"property\">settings</span>.<span class=\"property\">silent</span>,</span><br><span class=\"line\">    <span class=\"attr\">windowsHide</span>: cluster.<span class=\"property\">settings</span>.<span class=\"property\">windowsHide</span>,</span><br><span class=\"line\">    <span class=\"attr\">execArgv</span>: execArgv,</span><br><span class=\"line\">    <span class=\"attr\">stdio</span>: cluster.<span class=\"property\">settings</span>.<span class=\"property\">stdio</span>,</span><br><span class=\"line\">    <span class=\"attr\">gid</span>: cluster.<span class=\"property\">settings</span>.<span class=\"property\">gid</span>,</span><br><span class=\"line\">    <span class=\"attr\">uid</span>: cluster.<span class=\"property\">settings</span>.<span class=\"property\">uid</span>,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">onmessage</span>(<span class=\"params\">message, handle</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> worker = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">  <span class=\"comment\">// ... if message.act   queryServer</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (message.<span class=\"property\">act</span> === <span class=\"string\">&quot;queryServer&quot;</span>) <span class=\"title function_\">queryServer</span>(worker, message);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/utils.js</span></span><br><span class=\"line\"><span class=\"comment\">// clusterchilidmastersendsendHelper</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> seq = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">sendHelper</span>(<span class=\"params\">proc, message, handle, cb</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!proc.<span class=\"property\">connected</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  <span class=\"comment\">// NODE_*  internalMessage </span></span><br><span class=\"line\">  message = &#123; <span class=\"attr\">cmd</span>: <span class=\"string\">&quot;NODE_CLUSTER&quot;</span>, ...message, seq &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> cb === <span class=\"string\">&quot;function&quot;</span>) callbacks.<span class=\"title function_\">set</span>(seq, cb); <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  seq += <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"comment\">// cluster/child.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"comment\">// cluster/master.js handle =&gt; null</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> proc.<span class=\"title function_\">send</span>(message, handle);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>cluster.forkWorkerinternalMessageclusterchildmaster<code>sendHelper</code></p>\n<h3 id=\"Q-cluster-forkTCP\"><a href=\"#Q-cluster-forkTCP\" class=\"headerlink\" title=\"Q:cluster.forkTCP\"></a>Q:cluster.forkTCP</h3><p><code>net</code>Servercluster<code>child</code><code>master</code></p>\n<p><code>http</code><code>net</code><code>net.createServer</code><code>listen</code></p>\n<h4 id=\"Child\"><a href=\"#Child\" class=\"headerlink\" title=\"Child:\"></a>Child:</h4><p>cluster.childTCP<code>port</code>8000<code>host</code></p>\n<p><code>listenInCluster</code><strong>cluster</strong></p>\n<p><code>listen</code><code>cluster._getServer</code><code>act</code>serverQuerycluster.master</p>\n<h4 id=\"Master\"><a href=\"#Master\" class=\"headerlink\" title=\"Master:\"></a>Master:</h4><p><code>master.onmessage</code>act<code>serverQuery</code></p>\n<p><code>queryServer</code><code>RoundRobinHandle</code></p>\n<p><code>RoundRobinHandle</code><code>net.createServer</code>Servercluster.master<code>listenInCluster</code><code>server._listen2</code>new  <code>TCP</code>src&#x2F;tcp_wrap.cc<code>server._handle</code>cluster.masterTCPmasterchild</p>\n<p><code>RoundRobinHandle</code>server<code>listening</code><code>server._handle</code><code>distribute</code><code>onconnection</code></p>\n<p><code>distribute</code>TCPcluster.child<code>free</code><code>add</code>workerworkercluster.child<code>act</code><strong>newconn</strong>TCP</p>\n<h4 id=\"Child\"><a href=\"#Child\" class=\"headerlink\" title=\"Child:\"></a>Child:</h4><p>cluster.child<code>onconnection</code><code>act</code><strong>newconn</strong>server<code>onconnection</code>child<code>Socket</code><code>onnection</code></p>\n<p></p>\n<p><em></em></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/net.js</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">createServer</span>(<span class=\"params\">options, connectionListener</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Server</span>(options, connectionListener);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">Server</span>(<span class=\"params\">options, connectionListener</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ... </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title class_\">Server</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">listen</span> = <span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"comment\">// port8000host</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> backlog;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options.<span class=\"property\">port</span> === <span class=\"string\">&quot;number&quot;</span> || <span class=\"keyword\">typeof</span> options.<span class=\"property\">port</span> === <span class=\"string\">&quot;string&quot;</span>) &#123;</span><br><span class=\"line\">    backlog = options.<span class=\"property\">backlog</span> || backlogFromArgs;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (options.<span class=\"property\">host</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"title function_\">listenInCluster</span>(</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>,</span><br><span class=\"line\">        <span class=\"literal\">null</span>,</span><br><span class=\"line\">        options.<span class=\"property\">port</span> | <span class=\"number\">0</span>,</span><br><span class=\"line\">        <span class=\"number\">4</span>,</span><br><span class=\"line\">        backlog,</span><br><span class=\"line\">        <span class=\"literal\">undefined</span>,</span><br><span class=\"line\">        options.<span class=\"property\">exclusive</span></span><br><span class=\"line\">      );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">\t<span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">listenInCluster</span>(<span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">  server,</span></span><br><span class=\"line\"><span class=\"params\">  address,</span></span><br><span class=\"line\"><span class=\"params\">  port,</span></span><br><span class=\"line\"><span class=\"params\">  addressType,</span></span><br><span class=\"line\"><span class=\"params\">  backlog,</span></span><br><span class=\"line\"><span class=\"params\">  fd,</span></span><br><span class=\"line\"><span class=\"params\">  exclusive,</span></span><br><span class=\"line\"><span class=\"params\">  flags</span></span><br><span class=\"line\"><span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  exclusive = !!exclusive;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (cluster === <span class=\"literal\">undefined</span>) cluster = <span class=\"built_in\">require</span>(<span class=\"string\">&quot;cluster&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (cluster.<span class=\"property\">isMaster</span> || exclusive) &#123;</span><br><span class=\"line\">    server.<span class=\"title function_\">_listen2</span>(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> serverQuery = &#123;</span><br><span class=\"line\">    <span class=\"attr\">address</span>: address,</span><br><span class=\"line\">    <span class=\"attr\">port</span>: port, </span><br><span class=\"line\">    <span class=\"attr\">addressType</span>: addressType,</span><br><span class=\"line\">    <span class=\"attr\">fd</span>: fd,</span><br><span class=\"line\">    flags,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  cluster.<span class=\"title function_\">_getServer</span>(server, serverQuery, listenOnMasterHandle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">listenOnMasterHandle</span>(<span class=\"params\">err, handle</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    server.<span class=\"property\">_handle</span> = handle;</span><br><span class=\"line\">    server.<span class=\"title function_\">_listen2</span>(address, port, addressType, backlog, fd, flags);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/child.js</span></span><br><span class=\"line\">cluster.<span class=\"property\">_getServer</span> = <span class=\"keyword\">function</span> (<span class=\"params\">obj, options, cb</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> address = options.<span class=\"property\">address</span>;</span><br><span class=\"line\">\t<span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"comment\">// servercluster.child</span></span><br><span class=\"line\">  <span class=\"comment\">// index</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> indexesKey = [</span><br><span class=\"line\">    address, </span><br><span class=\"line\">    options.<span class=\"property\">port</span>,</span><br><span class=\"line\">    options.<span class=\"property\">addressType</span>,</span><br><span class=\"line\">    options.<span class=\"property\">fd</span>,</span><br><span class=\"line\">  ].<span class=\"title function_\">join</span>(<span class=\"string\">&quot;:&quot;</span>); </span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">let</span> index = indexes.<span class=\"title function_\">get</span>(indexesKey);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (index === <span class=\"literal\">undefined</span>) index = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> index++;</span><br><span class=\"line\"></span><br><span class=\"line\">  indexes.<span class=\"title function_\">set</span>(indexesKey, index);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> message = &#123;</span><br><span class=\"line\">    <span class=\"attr\">act</span>: <span class=\"string\">&quot;queryServer&quot;</span>,</span><br><span class=\"line\">    index,</span><br><span class=\"line\">    <span class=\"attr\">data</span>: <span class=\"literal\">null</span>,</span><br><span class=\"line\">    ...options,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">send</span>(message, <span class=\"function\">(<span class=\"params\">reply, handle</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (handle) <span class=\"title function_\">shared</span>(reply, handle, indexesKey, cb);</span><br><span class=\"line\">    <span class=\"comment\">// Shared listen socket.</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"title function_\">rr</span>(reply, indexesKey, cb); <span class=\"comment\">// Round-robin  handle null</span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">rr</span>(<span class=\"params\">message, indexesKey, cb</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (message.<span class=\"property\">errno</span>) <span class=\"keyword\">return</span> <span class=\"title function_\">cb</span>(message.<span class=\"property\">errno</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> key = message.<span class=\"property\">key</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">listen</span>(<span class=\"params\">backlog</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">close</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (key === <span class=\"literal\">undefined</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"title function_\">send</span>(&#123; <span class=\"attr\">act</span>: <span class=\"string\">&quot;close&quot;</span>, key &#125;);</span><br><span class=\"line\">    handles.<span class=\"title function_\">delete</span>(key);</span><br><span class=\"line\">    indexes.<span class=\"title function_\">delete</span>(indexesKey);</span><br><span class=\"line\">    key = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">getsockname</span>(<span class=\"params\">out</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (key) <span class=\"title class_\">Object</span>.<span class=\"title function_\">assign</span>(out, message.<span class=\"property\">sockname</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> handle = &#123; close, listen, <span class=\"attr\">ref</span>: noop, <span class=\"attr\">unref</span>: noop &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (message.<span class=\"property\">sockname</span>) &#123;</span><br><span class=\"line\">    handle.<span class=\"property\">getsockname</span> = getsockname; <span class=\"comment\">// TCP handles only.</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">assert</span>(handles.<span class=\"title function_\">has</span>(key) === <span class=\"literal\">false</span>);</span><br><span class=\"line\">  handles.<span class=\"title function_\">set</span>(key, handle);</span><br><span class=\"line\">  <span class=\"title function_\">cb</span>(<span class=\"number\">0</span>, handle); <span class=\"comment\">// handlelistenInClusterhandleserver._handle</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Round-robin connection.</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">onconnection</span>(<span class=\"params\">message, handle</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> key = message.<span class=\"property\">key</span>; <span class=\"comment\">// maseterkey</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> server = handles.<span class=\"title function_\">get</span>(key); <span class=\"comment\">// clientserver</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> accepted = server !== <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">send</span>(&#123; <span class=\"attr\">ack</span>: message.<span class=\"property\">seq</span>, accepted &#125;); <span class=\"comment\">//  master</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// cluster.child rrserveronconnection</span></span><br><span class=\"line\">  <span class=\"comment\">// cbnet.jsonconnection</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (accepted) server.<span class=\"title function_\">onconnection</span>(<span class=\"number\">0</span>, handle);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/master.js</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">queryServer</span>(<span class=\"params\">worker, message</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// workercluster.child worker</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> key =</span><br><span class=\"line\">    <span class=\"string\">`<span class=\"subst\">$&#123;message.address&#125;</span>:<span class=\"subst\">$&#123;message.port&#125;</span>:<span class=\"subst\">$&#123;message.addressType&#125;</span>:`</span> +</span><br><span class=\"line\">    <span class=\"string\">`<span class=\"subst\">$&#123;message.fd&#125;</span>:<span class=\"subst\">$&#123;message.index&#125;</span>`</span>;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> handle = handles.<span class=\"title function_\">get</span>(key);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (handle === <span class=\"literal\">undefined</span>) &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">// RoundRobinShared</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> constructor = <span class=\"title class_\">RoundRobinHandle</span>;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    handle = <span class=\"keyword\">new</span> <span class=\"title function_\">constructor</span>(<span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">      key,</span></span><br><span class=\"line\"><span class=\"params\">      address,</span></span><br><span class=\"line\"><span class=\"params\">      message.port,</span></span><br><span class=\"line\"><span class=\"params\">      message.addressType,</span></span><br><span class=\"line\"><span class=\"params\">      message.fd,</span></span><br><span class=\"line\"><span class=\"params\">      message.flags</span></span><br><span class=\"line\"><span class=\"params\">    </span>);</span><br><span class=\"line\">    handles.<span class=\"title function_\">set</span>(key, handle);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"comment\">// cluster.childworkerhandle</span></span><br><span class=\"line\">  handle.<span class=\"title function_\">add</span>(worker, <span class=\"function\">(<span class=\"params\">errno, reply, handle</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; data &#125; = handles.<span class=\"title function_\">get</span>(key);</span><br><span class=\"line\">    <span class=\"title function_\">send</span>(</span><br><span class=\"line\">      worker,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        errno,</span><br><span class=\"line\">        key,</span><br><span class=\"line\">        <span class=\"attr\">ack</span>: message.<span class=\"property\">seq</span>,</span><br><span class=\"line\">        data,</span><br><span class=\"line\">        ...reply,</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      handle <span class=\"comment\">// round_robin_handle null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lib/internal/cluster/round_robin_handle.js</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">RoundRobinHandle</span>(<span class=\"params\">key, address, port, addressType, fd, flags</span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">key</span> = key;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">all</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Map</span>();</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">free</span> = [];</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">handles</span> = [];</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">handle</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">server</span> = net.<span class=\"title function_\">createServer</span>(assert.<span class=\"property\">fail</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fd &gt;= <span class=\"number\">0</span>) <span class=\"variable language_\">this</span>.<span class=\"property\">server</span>.<span class=\"title function_\">listen</span>(&#123; fd &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (port &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">server</span>.<span class=\"title function_\">listen</span>(&#123;</span><br><span class=\"line\">      port,</span><br><span class=\"line\">      <span class=\"attr\">host</span>: address,</span><br><span class=\"line\">      <span class=\"comment\">// Currently, net module only supports `ipv6Only` option in `flags`.</span></span><br><span class=\"line\">      <span class=\"attr\">ipv6Only</span>: <span class=\"title class_\">Boolean</span>(flags &amp; constants.<span class=\"property\">UV_TCP_IPV6ONLY</span>),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"variable language_\">this</span>.<span class=\"property\">server</span>.<span class=\"title function_\">listen</span>(address); <span class=\"comment\">// UNIX socket path.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">server</span>.<span class=\"title function_\">once</span>(<span class=\"string\">&quot;listening&quot;</span>, <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">handle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">server</span>.<span class=\"property\">_handle</span>;</span><br><span class=\"line\">    <span class=\"comment\">// onconnection</span></span><br><span class=\"line\">    <span class=\"comment\">// distribute </span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">handle</span>.<span class=\"property\">onconnection</span> = <span class=\"function\">(<span class=\"params\">err, handle</span>) =&gt;</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">distribute</span>(err, handle);</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">server</span>.<span class=\"property\">_handle</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">server</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">RoundRobinHandle</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">add</span> = <span class=\"keyword\">function</span> (<span class=\"params\">worker, send</span>) &#123;</span><br><span class=\"line\">  <span class=\"title function_\">assert</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">all</span>.<span class=\"title function_\">has</span>(worker.<span class=\"property\">id</span>) === <span class=\"literal\">false</span>);</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">all</span>.<span class=\"title function_\">set</span>(worker.<span class=\"property\">id</span>, worker);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> <span class=\"title function_\">done</span> = (<span class=\"params\"></span>) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">handle</span>.<span class=\"property\">getsockname</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// tcp\\udp getsockname</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> out = &#123;&#125;;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">handle</span>.<span class=\"title function_\">getsockname</span>(out);</span><br><span class=\"line\">      <span class=\"comment\">// TODO(bnoordhuis) Check err.</span></span><br><span class=\"line\">      <span class=\"title function_\">send</span>(<span class=\"literal\">null</span>, &#123; <span class=\"attr\">sockname</span>: out &#125;, <span class=\"literal\">null</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">send</span>(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"literal\">null</span>); <span class=\"comment\">// UNIX socket.</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">handoff</span>(worker); <span class=\"comment\">// In case there are connections pending.</span></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">server</span> === <span class=\"literal\">null</span>) <span class=\"keyword\">return</span> <span class=\"title function_\">done</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Still busy binding.</span></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">server</span>.<span class=\"title function_\">once</span>(<span class=\"string\">&quot;listening&quot;</span>, done);</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">server</span>.<span class=\"title function_\">once</span>(<span class=\"string\">&quot;error&quot;</span>, <span class=\"function\">(<span class=\"params\">err</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">send</span>(err.<span class=\"property\">errno</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">RoundRobinHandle</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">distribute</span> = <span class=\"keyword\">function</span> (<span class=\"params\">err, handle</span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">handles</span>.<span class=\"title function_\">push</span>(handle);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> worker = <span class=\"variable language_\">this</span>.<span class=\"property\">free</span>.<span class=\"title function_\">shift</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (worker) <span class=\"variable language_\">this</span>.<span class=\"title function_\">handoff</span>(worker);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">RoundRobinHandle</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">handoff</span> = <span class=\"keyword\">function</span> (<span class=\"params\">worker</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// worker</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">all</span>.<span class=\"title function_\">has</span>(worker.<span class=\"property\">id</span>) === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>; <span class=\"comment\">// Worker is closing (or has closed) the server.</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> handle = <span class=\"variable language_\">this</span>.<span class=\"property\">handles</span>.<span class=\"title function_\">shift</span>(); <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (handle === <span class=\"literal\">undefined</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">free</span>.<span class=\"title function_\">push</span>(worker);  <span class=\"comment\">// workerfree</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> message = &#123; <span class=\"attr\">act</span>: <span class=\"string\">&quot;newconn&quot;</span>, <span class=\"attr\">key</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">key</span> &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">sendHelper</span>(worker.<span class=\"property\">process</span>, message, handle, <span class=\"function\">(<span class=\"params\">reply</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (reply.<span class=\"property\">accepted</span>) handle.<span class=\"title function_\">close</span>();</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">distribute</span>(<span class=\"number\">0</span>, handle); <span class=\"comment\">// Worker is shutting down. Send to another.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">handoff</span>(worker);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>cluster</code>child_processfork<code>NODE_UNIQUE_ID</code>require(cluster)<code>master.js</code><code>child.js</code><code>RoundRobinHandle</code><code>cluster</code>TCP<code>net</code>masterchildchildchildmasterServer<code>RoundRobinHandle</code>serverTCP<code>free</code>workercluster.child</p>"},{"title":"Node.jsCPU","keywords":",CPU","description":"CPUAlinode","date":"2020-02-20T23:31:54.489Z","_content":"\nCPU[Alinode](https://cn.aliyun.com/product/nodejs)\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n## \n\n*Node.jsEgg.jsAgentWorker*\n\n#### \n\n- CPUEventLoopGC\n-  `os.loadavg()`\n\nNode.js APIC++V8 API[IBM appmetrics](https://github.com/RuntimeTools/appmetrics)``ElasticsearchGrafana\n\n<br/>\n\n#### \n\n- \n\n#### [CPU](http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html)\n\n- CPU\n\n2``DB``Node.js````\n\n<br/>\n\n<br/>\n\n## &\n\nNode.jsCPU``Node.jsNode.jsTCPHTTP\n\nTCP**HTTPTCP**\n\n![](/images/node-perf-heapdump-flame-graph/connection_01.png)\n\n- ****Web\n- **Hub**TCPNode.js\n- **Node.js Process:** DockerNode.jsExpressEgg.jsNode.js\n- **DFS**Docker\n\n<br/>\n\n<br/>\n\n## \n\nNode.js Process``[heapdump](https://www.npmjs.com/package/heapdump)DFS`Alinode`[devtools-frontend](https://github.com/ChromeDevTools/devtools-frontend)\n\n![devtools ](/images/node-perf-heapdump-flame-graph/heapdump_01.png)\n\n<br/>\n\n<br/>\n\n## CPU\n\n[](https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/)[perf](http://www.brendangregg.com/perf.html)[FlameGraph](https://github.com/brendangregg/FlameGraph)Google\n\nNode.js`socket.on(\"readable\",callback)`  `socket.on(\"data\",callback)`callback`perf`shell\n\nNode.jsJavaScript``IOJavaScript`callback`shell``callbackCPUJavaScriptperfCPU`perf`\n\nJavaScriptshell\n\n### \n\nperfLinuxDockerNode.jsNode.js 12\n\nNode.js Docker`--privileged`perf\n\n```shell\ndocker run --privileged -itd node:12-buster /bin/bash // \n\ndocker attach xxxx  // \n```\n\nDocker`perf`\n\n```shell\napt-get update\n\napt-get install linux-perf\n\nperf_4.19 // linuxperf\n```\n\n[](https://github.com/miser/test-perf)\n\n```javascript\n// index.js\nconst {fork } = require('child_process')\nfork('./helper')\n\nfibonacci(50)\n\nfunction fibonacci(n) {\n  if(n==0 || n == 1) return n;\n  return fibonacci(n-1) + fibonacci(n-2);\n}\n\n// helper.js\nconst fs = require('fs');\nconst path = require('path');\nconst { spawn, exec } = require('child_process');\nconst unzipper = require(\"unzipper\");\n\nconst perfCMD = 'perf_4.19'\nconst perfTime = 60;\n\n\nfunction execCMD(cmd, callback) {\n  return new Promise((resolve, reject) => {\n    exec(cmd, (error, stdout, stderr) => {\n      console.log('shell: ',cmd)\n      if (error) {\n        console.error(`: ${error}`);\n        reject(error)\n      }\n      if(callback) {\n        callback(stdout, stderr, resolve, reject);\n      } else {\n        resolve()\n      }\n    });\n  })\n}\n\nclass Flame {\n  constructor() {\n\n    this.nodes = [];\n\n    this._init().catch(function(e){\n      console.log(e)\n    })\n  }\n\n  _init () {\n    return new Promise((resolve, reject) => {\n      const zipFilePath = path.join('.', 'FlameGraph.zip')\n      const saveDir = process.cwd();\n      fs.createReadStream(zipFilePath)\n        .pipe(unzipper.Extract({ path: saveDir }))\n        .on(\"error\", reject)\n        .on(\"finish\", () => {\n          console.log(\"zip finish\");\n          resolve();\n        });\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/stackcollapse-perf.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/flamegraph.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '{print $2}'`;\n      return execCMD(cmd, (stdout, stderr, resolve, reject) => {\n        this.nodes = stdout.split('\\n').filter( pid => pid && pid != process.pid)\n        resolve();\n      });\n    });\n  }\n\n  _chownMapFile(){\n    const cmd = `chown root /tmp/perf-${this.nodes[0]}.map && ${perfCMD} script > nodestacks`;\n    execCMD(cmd).then(() => {\n      this._genFlameGraph();\n    })\n  }\n\n  _genFlameGraph(){\n    const cmd = `./FlameGraph/stackcollapse-perf.pl < nodestacks | ./FlameGraph/flamegraph.pl --colors js > node-flamegraph-${process.pid}.svg`\n    execCMD(cmd).then(() => {\n      console.log('had completed');\n    })\n  }\n\n  record() {\n    const cmd = `${perfCMD} record -F 99 -p ${this.nodes[0]} -g -- sleep ${perfTime}`;\n    execCMD(cmd).then(() => {\n      const t = 1000 * (perfTime + 5);\n      setTimeout(() => {\n        this._chownMapFile()\n      }, 1000 * (perfTime + 5))\n    })\n  }\n}\n\nconst flame = new Flame();\nsetTimeout(() => {\n  // tcp\n  flame.record();\n}, 1000 * 5)\n\n```\n\n```javascripton\n// package.json\n{\n  \"name\": \"test-perf\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"dev\": \"node --perf-basic-prof index.js\",\n    \"clear\": \"rm isolate-* & rm node-flamegraph-*.svg & rm -rf FlameGraph\"\n  },\n  \"keywords\": [],\n  \"author\": \"\",\n  \"license\": \"ISC\",\n  \"dependencies\": {\n    \"unzipper\": \"^0.10.8\"\n  }\n}\n\n```\n\n\n\n- index.js: \n- hepler.js: FlameGraph.zip =>  => Node.js=>  =>  perf record => 5\n- package.json:  index.js `--perf-basic-prof``unzipper`\n\ndocker cp dockernpm i\n\n```shell\nnpm run dev // \n```\n\nCPU\n\n![CPU](/images/node-perf-heapdump-flame-graph/node-flamegraph.png)\n\nHelper.js\n\n![](/images/node-perf-heapdump-flame-graph/connection_02.png)\n\n\n\n\n\n#### \n\n","source":"_posts/node-perf-heapdump-flame-graph.md","raw":"---\ntitle: Node.jsCPU\ncategory: JavaScript\nkeywords: ,CPU\ndescription: CPUAlinode\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-02-21T07:31:54.489Z\n---\n\nCPU[Alinode](https://cn.aliyun.com/product/nodejs)\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n## \n\n*Node.jsEgg.jsAgentWorker*\n\n#### \n\n- CPUEventLoopGC\n-  `os.loadavg()`\n\nNode.js APIC++V8 API[IBM appmetrics](https://github.com/RuntimeTools/appmetrics)``ElasticsearchGrafana\n\n<br/>\n\n#### \n\n- \n\n#### [CPU](http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html)\n\n- CPU\n\n2``DB``Node.js````\n\n<br/>\n\n<br/>\n\n## &\n\nNode.jsCPU``Node.jsNode.jsTCPHTTP\n\nTCP**HTTPTCP**\n\n![](/images/node-perf-heapdump-flame-graph/connection_01.png)\n\n- ****Web\n- **Hub**TCPNode.js\n- **Node.js Process:** DockerNode.jsExpressEgg.jsNode.js\n- **DFS**Docker\n\n<br/>\n\n<br/>\n\n## \n\nNode.js Process``[heapdump](https://www.npmjs.com/package/heapdump)DFS`Alinode`[devtools-frontend](https://github.com/ChromeDevTools/devtools-frontend)\n\n![devtools ](/images/node-perf-heapdump-flame-graph/heapdump_01.png)\n\n<br/>\n\n<br/>\n\n## CPU\n\n[](https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/)[perf](http://www.brendangregg.com/perf.html)[FlameGraph](https://github.com/brendangregg/FlameGraph)Google\n\nNode.js`socket.on(\"readable\",callback)`  `socket.on(\"data\",callback)`callback`perf`shell\n\nNode.jsJavaScript``IOJavaScript`callback`shell``callbackCPUJavaScriptperfCPU`perf`\n\nJavaScriptshell\n\n### \n\nperfLinuxDockerNode.jsNode.js 12\n\nNode.js Docker`--privileged`perf\n\n```shell\ndocker run --privileged -itd node:12-buster /bin/bash // \n\ndocker attach xxxx  // \n```\n\nDocker`perf`\n\n```shell\napt-get update\n\napt-get install linux-perf\n\nperf_4.19 // linuxperf\n```\n\n[](https://github.com/miser/test-perf)\n\n```javascript\n// index.js\nconst {fork } = require('child_process')\nfork('./helper')\n\nfibonacci(50)\n\nfunction fibonacci(n) {\n  if(n==0 || n == 1) return n;\n  return fibonacci(n-1) + fibonacci(n-2);\n}\n\n// helper.js\nconst fs = require('fs');\nconst path = require('path');\nconst { spawn, exec } = require('child_process');\nconst unzipper = require(\"unzipper\");\n\nconst perfCMD = 'perf_4.19'\nconst perfTime = 60;\n\n\nfunction execCMD(cmd, callback) {\n  return new Promise((resolve, reject) => {\n    exec(cmd, (error, stdout, stderr) => {\n      console.log('shell: ',cmd)\n      if (error) {\n        console.error(`: ${error}`);\n        reject(error)\n      }\n      if(callback) {\n        callback(stdout, stderr, resolve, reject);\n      } else {\n        resolve()\n      }\n    });\n  })\n}\n\nclass Flame {\n  constructor() {\n\n    this.nodes = [];\n\n    this._init().catch(function(e){\n      console.log(e)\n    })\n  }\n\n  _init () {\n    return new Promise((resolve, reject) => {\n      const zipFilePath = path.join('.', 'FlameGraph.zip')\n      const saveDir = process.cwd();\n      fs.createReadStream(zipFilePath)\n        .pipe(unzipper.Extract({ path: saveDir }))\n        .on(\"error\", reject)\n        .on(\"finish\", () => {\n          console.log(\"zip finish\");\n          resolve();\n        });\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/stackcollapse-perf.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `chmod 700 ./FlameGraph/flamegraph.pl`;\n      return execCMD(cmd);\n    }).then(() => {\n      const cmd = `ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '{print $2}'`;\n      return execCMD(cmd, (stdout, stderr, resolve, reject) => {\n        this.nodes = stdout.split('\\n').filter( pid => pid && pid != process.pid)\n        resolve();\n      });\n    });\n  }\n\n  _chownMapFile(){\n    const cmd = `chown root /tmp/perf-${this.nodes[0]}.map && ${perfCMD} script > nodestacks`;\n    execCMD(cmd).then(() => {\n      this._genFlameGraph();\n    })\n  }\n\n  _genFlameGraph(){\n    const cmd = `./FlameGraph/stackcollapse-perf.pl < nodestacks | ./FlameGraph/flamegraph.pl --colors js > node-flamegraph-${process.pid}.svg`\n    execCMD(cmd).then(() => {\n      console.log('had completed');\n    })\n  }\n\n  record() {\n    const cmd = `${perfCMD} record -F 99 -p ${this.nodes[0]} -g -- sleep ${perfTime}`;\n    execCMD(cmd).then(() => {\n      const t = 1000 * (perfTime + 5);\n      setTimeout(() => {\n        this._chownMapFile()\n      }, 1000 * (perfTime + 5))\n    })\n  }\n}\n\nconst flame = new Flame();\nsetTimeout(() => {\n  // tcp\n  flame.record();\n}, 1000 * 5)\n\n```\n\n```javascripton\n// package.json\n{\n  \"name\": \"test-perf\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"dev\": \"node --perf-basic-prof index.js\",\n    \"clear\": \"rm isolate-* & rm node-flamegraph-*.svg & rm -rf FlameGraph\"\n  },\n  \"keywords\": [],\n  \"author\": \"\",\n  \"license\": \"ISC\",\n  \"dependencies\": {\n    \"unzipper\": \"^0.10.8\"\n  }\n}\n\n```\n\n\n\n- index.js: \n- hepler.js: FlameGraph.zip =>  => Node.js=>  =>  perf record => 5\n- package.json:  index.js `--perf-basic-prof``unzipper`\n\ndocker cp dockernpm i\n\n```shell\nnpm run dev // \n```\n\nCPU\n\n![CPU](/images/node-perf-heapdump-flame-graph/node-flamegraph.png)\n\nHelper.js\n\n![](/images/node-perf-heapdump-flame-graph/connection_02.png)\n\n\n\n\n\n#### \n\n","slug":"node-perf-heapdump-flame-graph","published":1,"updated":"2024-04-08T13:34:02.489Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wed001818fd3hd28ffx","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p>CPU<a href=\"https://cn.aliyun.com/product/nodejs\">Alinode</a></p>\n<span id=\"more\"></span>\n\n<br>\n\n<br>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><em>Node.jsEgg.jsAgentWorker</em></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>CPUEventLoopGC</li>\n<li> <code>os.loadavg()</code></li>\n</ul>\n<p>Node.js APIC++V8 API<a href=\"https://github.com/RuntimeTools/appmetrics\">IBM appmetrics</a><code></code>ElasticsearchGrafana</p>\n<br>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li></li>\n</ul>\n<h4 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a><a href=\"http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html\">CPU</a></h4><ul>\n<li>CPU</li>\n</ul>\n<p>2<code></code>DB<code></code>Node.js<code></code><code></code></p>\n<br>\n\n<br>\n\n<h2 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"&amp;\"></a>&amp;</h2><p>Node.jsCPU<code></code>Node.jsNode.jsTCPHTTP</p>\n<p>TCP<strong>HTTPTCP</strong></p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_01.png\" alt=\"\"></p>\n<ul>\n<li><strong></strong>Web</li>\n<li><strong>Hub</strong>TCPNode.js</li>\n<li><strong>Node.js Process:</strong> DockerNode.jsExpressEgg.jsNode.js</li>\n<li><strong>DFS</strong>Docker</li>\n</ul>\n<br>\n\n<br>\n\n<h2 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h2><p>Node.js Process<code></code><a href=\"https://www.npmjs.com/package/heapdump\">heapdump</a>DFS<code>Alinode</code><a href=\"https://github.com/ChromeDevTools/devtools-frontend\">devtools-frontend</a></p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/heapdump_01.png\" alt=\"devtools \"></p>\n<br>\n\n<br>\n\n<h2 id=\"CPU-1\"><a href=\"#CPU-1\" class=\"headerlink\" title=\"CPU\"></a>CPU</h2><p><a href=\"https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/\"></a><a href=\"http://www.brendangregg.com/perf.html\">perf</a><a href=\"https://github.com/brendangregg/FlameGraph\">FlameGraph</a>Google</p>\n<p>Node.js<code>socket.on(\"readable\",callback)</code>  <code>socket.on(\"data\",callback)</code>callback<code>perf</code>shell</p>\n<p>Node.jsJavaScript<code></code>IOJavaScript<code>callback</code>shell<code></code>callbackCPUJavaScriptperfCPU<code>perf</code></p>\n<p>JavaScriptshell</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>perfLinuxDockerNode.jsNode.js 12</p>\n<p>Node.js Docker<code>--privileged</code>perf</p>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --privileged -itd node:12-buster /bin/bash // </span><br><span class=\"line\"></span><br><span class=\"line\">docker attach xxxx  // </span><br></pre></td></tr></tbody></table></figure>\n\n<p>Docker<code>perf</code></p>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\">apt-get install linux-perf</span><br><span class=\"line\"></span><br><span class=\"line\">perf_4.19 // linuxperf</span><br></pre></td></tr></tbody></table></figure>\n\n<p><a href=\"https://github.com/miser/test-perf\"></a></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// index.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> {fork } = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>)</span><br><span class=\"line\"><span class=\"title function_\">fork</span>(<span class=\"hljs-string\">'./helper'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">fibonacci</span>(<span class=\"hljs-number\">50</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">fibonacci</span>(<span class=\"hljs-params\">n</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span>(n==<span class=\"hljs-number\">0</span> || n == <span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">return</span> n;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"title function_\">fibonacci</span>(n-<span class=\"hljs-number\">1</span>) + <span class=\"title function_\">fibonacci</span>(n-<span class=\"hljs-number\">2</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// helper.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> fs = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'fs'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> path = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'path'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> { spawn, exec } = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> unzipper = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">\"unzipper\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> perfCMD = <span class=\"hljs-string\">'perf_4.19'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> perfTime = <span class=\"hljs-number\">60</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">execCMD</span>(<span class=\"hljs-params\">cmd, callback</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> {</span><br><span class=\"line\">    <span class=\"title function_\">exec</span>(cmd, <span class=\"hljs-function\">(<span class=\"hljs-params\">error, stdout, stderr</span>) =&gt;</span> {</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">'shell: '</span>,cmd)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (error) {</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">error</span>(<span class=\"hljs-string\">`: <span class=\"hljs-subst\">${error}</span>`</span>);</span><br><span class=\"line\">        <span class=\"title function_\">reject</span>(error)</span><br><span class=\"line\">      }</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span>(callback) {</span><br><span class=\"line\">        <span class=\"title function_\">callback</span>(stdout, stderr, resolve, reject);</span><br><span class=\"line\">      } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>()</span><br><span class=\"line\">      }</span><br><span class=\"line\">    });</span><br><span class=\"line\">  })</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">class</span> <span class=\"title class_\">Flame</span> {</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">nodes</span> = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_init</span>().<span class=\"title function_\">catch</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>){</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e)</span><br><span class=\"line\">    })</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  _init () {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> zipFilePath = path.<span class=\"title function_\">join</span>(<span class=\"hljs-string\">'.'</span>, <span class=\"hljs-string\">'FlameGraph.zip'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> saveDir = process.<span class=\"title function_\">cwd</span>();</span><br><span class=\"line\">      fs.<span class=\"title function_\">createReadStream</span>(zipFilePath)</span><br><span class=\"line\">        .<span class=\"title function_\">pipe</span>(unzipper.<span class=\"title class_\">Extract</span>({ <span class=\"hljs-attr\">path</span>: saveDir }))</span><br><span class=\"line\">        .<span class=\"title function_\">on</span>(<span class=\"hljs-string\">\"error\"</span>, reject)</span><br><span class=\"line\">        .<span class=\"title function_\">on</span>(<span class=\"hljs-string\">\"finish\"</span>, <span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">          <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">\"zip finish\"</span>);</span><br><span class=\"line\">          <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">        });</span><br><span class=\"line\">    }).<span class=\"title function_\">then</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`chmod 700 ./FlameGraph/stackcollapse-perf.pl`</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"title function_\">execCMD</span>(cmd);</span><br><span class=\"line\">    }).<span class=\"title function_\">then</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`chmod 700 ./FlameGraph/flamegraph.pl`</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"title function_\">execCMD</span>(cmd);</span><br><span class=\"line\">    }).<span class=\"title function_\">then</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk '{print $2}'`</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"title function_\">execCMD</span>(cmd, <span class=\"hljs-function\">(<span class=\"hljs-params\">stdout, stderr, resolve, reject</span>) =&gt;</span> {</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">nodes</span> = stdout.<span class=\"title function_\">split</span>(<span class=\"hljs-string\">'\\n'</span>).<span class=\"title function_\">filter</span>( <span class=\"hljs-function\"><span class=\"hljs-params\">pid</span> =&gt;</span> pid &amp;&amp; pid != process.<span class=\"hljs-property\">pid</span>)</span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">      });</span><br><span class=\"line\">    });</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">_chownMapFile</span>(<span class=\"hljs-params\"></span>){</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`chown root /tmp/perf-<span class=\"hljs-subst\">${<span class=\"variable language_\">this</span>.nodes[<span class=\"hljs-number\">0</span>]}</span>.map &amp;&amp; <span class=\"hljs-subst\">${perfCMD}</span> script &gt; nodestacks`</span>;</span><br><span class=\"line\">    <span class=\"title function_\">execCMD</span>(cmd).<span class=\"title function_\">then</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">_genFlameGraph</span>();</span><br><span class=\"line\">    })</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">_genFlameGraph</span>(<span class=\"hljs-params\"></span>){</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`./FlameGraph/stackcollapse-perf.pl &lt; nodestacks | ./FlameGraph/flamegraph.pl --colors js &gt; node-flamegraph-<span class=\"hljs-subst\">${process.pid}</span>.svg`</span></span><br><span class=\"line\">    <span class=\"title function_\">execCMD</span>(cmd).<span class=\"title function_\">then</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">'had completed'</span>);</span><br><span class=\"line\">    })</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">record</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> cmd = <span class=\"hljs-string\">`<span class=\"hljs-subst\">${perfCMD}</span> record -F 99 -p <span class=\"hljs-subst\">${<span class=\"variable language_\">this</span>.nodes[<span class=\"hljs-number\">0</span>]}</span> -g -- sleep <span class=\"hljs-subst\">${perfTime}</span>`</span>;</span><br><span class=\"line\">    <span class=\"title function_\">execCMD</span>(cmd).<span class=\"title function_\">then</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> t = <span class=\"hljs-number\">1000</span> * (perfTime + <span class=\"hljs-number\">5</span>);</span><br><span class=\"line\">      <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">_chownMapFile</span>()</span><br><span class=\"line\">      }, <span class=\"hljs-number\">1000</span> * (perfTime + <span class=\"hljs-number\">5</span>))</span><br><span class=\"line\">    })</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> flame = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Flame</span>();</span><br><span class=\"line\"><span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// tcp</span></span><br><span class=\"line\">  flame.<span class=\"title function_\">record</span>();</span><br><span class=\"line\">}, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">5</span>)</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight plaintext hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// package.json</span><br><span class=\"line\">{</span><br><span class=\"line\">  \"name\": \"test-perf\",</span><br><span class=\"line\">  \"version\": \"1.0.0\",</span><br><span class=\"line\">  \"description\": \"\",</span><br><span class=\"line\">  \"main\": \"index.js\",</span><br><span class=\"line\">  \"scripts\": {</span><br><span class=\"line\">    \"dev\": \"node --perf-basic-prof index.js\",</span><br><span class=\"line\">    \"clear\": \"rm isolate-* &amp; rm node-flamegraph-*.svg &amp; rm -rf FlameGraph\"</span><br><span class=\"line\">  },</span><br><span class=\"line\">  \"keywords\": [],</span><br><span class=\"line\">  \"author\": \"\",</span><br><span class=\"line\">  \"license\": \"ISC\",</span><br><span class=\"line\">  \"dependencies\": {</span><br><span class=\"line\">    \"unzipper\": \"^0.10.8\"</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n\n\n<ul>\n<li>index.js: </li>\n<li>hepler.js: FlameGraph.zip =&gt;  =&gt; Node.js=&gt;  =&gt;  perf record =&gt; 5</li>\n<li>package.json:  index.js <code>--perf-basic-prof</code><code>unzipper</code></li>\n</ul>\n<p>docker cp dockernpm i</p>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run dev // </span><br></pre></td></tr></tbody></table></figure>\n\n<p>CPU</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/node-flamegraph.png\" alt=\"CPU\"></p>\n<p>Helper.js</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_02.png\" alt=\"\"></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<html><head></head><body><p>CPU<a href=\"https://cn.aliyun.com/product/nodejs\">Alinode</a></p></body></html>","more":"<br/>\n\n<br/>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><em>Node.jsEgg.jsAgentWorker</em></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>CPUEventLoopGC</li>\n<li> <code>os.loadavg()</code></li>\n</ul>\n<p>Node.js APIC++V8 API<a href=\"https://github.com/RuntimeTools/appmetrics\">IBM appmetrics</a><code></code>ElasticsearchGrafana</p>\n<br/>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li></li>\n</ul>\n<h4 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a><a href=\"http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html\">CPU</a></h4><ul>\n<li>CPU</li>\n</ul>\n<p>2<code></code>DB<code></code>Node.js<code></code><code></code></p>\n<br/>\n\n<br/>\n\n<h2 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"&amp;\"></a>&amp;</h2><p>Node.jsCPU<code></code>Node.jsNode.jsTCPHTTP</p>\n<p>TCP<strong>HTTPTCP</strong></p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_01.png\" alt=\"\"></p>\n<ul>\n<li><strong></strong>Web</li>\n<li><strong>Hub</strong>TCPNode.js</li>\n<li><strong>Node.js Process:</strong> DockerNode.jsExpressEgg.jsNode.js</li>\n<li><strong>DFS</strong>Docker</li>\n</ul>\n<br/>\n\n<br/>\n\n<h2 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h2><p>Node.js Process<code></code><a href=\"https://www.npmjs.com/package/heapdump\">heapdump</a>DFS<code>Alinode</code><a href=\"https://github.com/ChromeDevTools/devtools-frontend\">devtools-frontend</a></p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/heapdump_01.png\" alt=\"devtools \"></p>\n<br/>\n\n<br/>\n\n<h2 id=\"CPU-1\"><a href=\"#CPU-1\" class=\"headerlink\" title=\"CPU\"></a>CPU</h2><p><a href=\"https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/\"></a><a href=\"http://www.brendangregg.com/perf.html\">perf</a><a href=\"https://github.com/brendangregg/FlameGraph\">FlameGraph</a>Google</p>\n<p>Node.js<code>socket.on(&quot;readable&quot;,callback)</code>  <code>socket.on(&quot;data&quot;,callback)</code>callback<code>perf</code>shell</p>\n<p>Node.jsJavaScript<code></code>IOJavaScript<code>callback</code>shell<code></code>callbackCPUJavaScriptperfCPU<code>perf</code></p>\n<p>JavaScriptshell</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>perfLinuxDockerNode.jsNode.js 12</p>\n<p>Node.js Docker<code>--privileged</code>perf</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --privileged -itd node:12-buster /bin/bash // </span><br><span class=\"line\"></span><br><span class=\"line\">docker attach xxxx  // </span><br></pre></td></tr></table></figure>\n\n<p>Docker<code>perf</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\">apt-get install linux-perf</span><br><span class=\"line\"></span><br><span class=\"line\">perf_4.19 // linuxperf</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://github.com/miser/test-perf\"></a></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// index.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123;fork &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;child_process&#x27;</span>)</span><br><span class=\"line\"><span class=\"title function_\">fork</span>(<span class=\"string\">&#x27;./helper&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">fibonacci</span>(<span class=\"number\">50</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">fibonacci</span>(<span class=\"params\">n</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(n==<span class=\"number\">0</span> || n == <span class=\"number\">1</span>) <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"title function_\">fibonacci</span>(n-<span class=\"number\">1</span>) + <span class=\"title function_\">fibonacci</span>(n-<span class=\"number\">2</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// helper.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;fs&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;path&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; spawn, exec &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;child_process&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> unzipper = <span class=\"built_in\">require</span>(<span class=\"string\">&quot;unzipper&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> perfCMD = <span class=\"string\">&#x27;perf_4.19&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> perfTime = <span class=\"number\">60</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">execCMD</span>(<span class=\"params\">cmd, callback</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">exec</span>(cmd, <span class=\"function\">(<span class=\"params\">error, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;shell: &#x27;</span>,cmd)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (error) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">error</span>(<span class=\"string\">`: <span class=\"subst\">$&#123;error&#125;</span>`</span>);</span><br><span class=\"line\">        <span class=\"title function_\">reject</span>(error)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(callback) &#123;</span><br><span class=\"line\">        <span class=\"title function_\">callback</span>(stdout, stderr, resolve, reject);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Flame</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">nodes</span> = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_init</span>().<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>)&#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  _init () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> zipFilePath = path.<span class=\"title function_\">join</span>(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;FlameGraph.zip&#x27;</span>)</span><br><span class=\"line\">      <span class=\"keyword\">const</span> saveDir = process.<span class=\"title function_\">cwd</span>();</span><br><span class=\"line\">      fs.<span class=\"title function_\">createReadStream</span>(zipFilePath)</span><br><span class=\"line\">        .<span class=\"title function_\">pipe</span>(unzipper.<span class=\"title class_\">Extract</span>(&#123; <span class=\"attr\">path</span>: saveDir &#125;))</span><br><span class=\"line\">        .<span class=\"title function_\">on</span>(<span class=\"string\">&quot;error&quot;</span>, reject)</span><br><span class=\"line\">        .<span class=\"title function_\">on</span>(<span class=\"string\">&quot;finish&quot;</span>, <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;zip finish&quot;</span>);</span><br><span class=\"line\">          <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> cmd = <span class=\"string\">`chmod 700 ./FlameGraph/stackcollapse-perf.pl`</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"title function_\">execCMD</span>(cmd);</span><br><span class=\"line\">    &#125;).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> cmd = <span class=\"string\">`chmod 700 ./FlameGraph/flamegraph.pl`</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"title function_\">execCMD</span>(cmd);</span><br><span class=\"line\">    &#125;).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> cmd = <span class=\"string\">`ps -ef|grep node|grep -v grep|grep -v FlameGraph|awk &#x27;&#123;print $2&#125;&#x27;`</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"title function_\">execCMD</span>(cmd, <span class=\"function\">(<span class=\"params\">stdout, stderr, resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">nodes</span> = stdout.<span class=\"title function_\">split</span>(<span class=\"string\">&#x27;\\n&#x27;</span>).<span class=\"title function_\">filter</span>( <span class=\"function\"><span class=\"params\">pid</span> =&gt;</span> pid &amp;&amp; pid != process.<span class=\"property\">pid</span>)</span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">_chownMapFile</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cmd = <span class=\"string\">`chown root /tmp/perf-<span class=\"subst\">$&#123;<span class=\"variable language_\">this</span>.nodes[<span class=\"number\">0</span>]&#125;</span>.map &amp;&amp; <span class=\"subst\">$&#123;perfCMD&#125;</span> script &gt; nodestacks`</span>;</span><br><span class=\"line\">    <span class=\"title function_\">execCMD</span>(cmd).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">_genFlameGraph</span>();</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">_genFlameGraph</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cmd = <span class=\"string\">`./FlameGraph/stackcollapse-perf.pl &lt; nodestacks | ./FlameGraph/flamegraph.pl --colors js &gt; node-flamegraph-<span class=\"subst\">$&#123;process.pid&#125;</span>.svg`</span></span><br><span class=\"line\">    <span class=\"title function_\">execCMD</span>(cmd).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;had completed&#x27;</span>);</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">record</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cmd = <span class=\"string\">`<span class=\"subst\">$&#123;perfCMD&#125;</span> record -F 99 -p <span class=\"subst\">$&#123;<span class=\"variable language_\">this</span>.nodes[<span class=\"number\">0</span>]&#125;</span> -g -- sleep <span class=\"subst\">$&#123;perfTime&#125;</span>`</span>;</span><br><span class=\"line\">    <span class=\"title function_\">execCMD</span>(cmd).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> t = <span class=\"number\">1000</span> * (perfTime + <span class=\"number\">5</span>);</span><br><span class=\"line\">      <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">_chownMapFile</span>()</span><br><span class=\"line\">      &#125;, <span class=\"number\">1000</span> * (perfTime + <span class=\"number\">5</span>))</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> flame = <span class=\"keyword\">new</span> <span class=\"title class_\">Flame</span>();</span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// tcp</span></span><br><span class=\"line\">  flame.<span class=\"title function_\">record</span>();</span><br><span class=\"line\">&#125;, <span class=\"number\">1000</span> * <span class=\"number\">5</span>)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// package.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot;: &quot;test-perf&quot;,</span><br><span class=\"line\">  &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class=\"line\">  &quot;description&quot;: &quot;&quot;,</span><br><span class=\"line\">  &quot;main&quot;: &quot;index.js&quot;,</span><br><span class=\"line\">  &quot;scripts&quot;: &#123;</span><br><span class=\"line\">    &quot;dev&quot;: &quot;node --perf-basic-prof index.js&quot;,</span><br><span class=\"line\">    &quot;clear&quot;: &quot;rm isolate-* &amp; rm node-flamegraph-*.svg &amp; rm -rf FlameGraph&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;keywords&quot;: [],</span><br><span class=\"line\">  &quot;author&quot;: &quot;&quot;,</span><br><span class=\"line\">  &quot;license&quot;: &quot;ISC&quot;,</span><br><span class=\"line\">  &quot;dependencies&quot;: &#123;</span><br><span class=\"line\">    &quot;unzipper&quot;: &quot;^0.10.8&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li>index.js: </li>\n<li>hepler.js: FlameGraph.zip &#x3D;&gt;  &#x3D;&gt; Node.js&#x3D;&gt;  &#x3D;&gt;  perf record &#x3D;&gt; 5</li>\n<li>package.json:  index.js <code>--perf-basic-prof</code><code>unzipper</code></li>\n</ul>\n<p>docker cp dockernpm i</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run dev // </span><br></pre></td></tr></table></figure>\n\n<p>CPU</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/node-flamegraph.png\" alt=\"CPU\"></p>\n<p>Helper.js</p>\n<p><img src=\"/images/node-perf-heapdump-flame-graph/connection_02.png\" alt=\"\"></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>"},{"layout":"minos","title":"Istio","date":"2020-06-28T02:00:00.000Z","keywords":"Istio,Node.js,JavaScript,","description":"IstioK8s DockerBFF  ","_content":"\n_ Istio _\n\n Istio  K8sDocker  BFF \n\n### JavaScript \n\n JavaScript  3 React\\Vue\\Angular Node.js Express\\Koa\\Egg.js JavaScript  CLI  Express  JavaScript __\n\n<br/>\n\n### BFF \n\n BFF  Nginx  Node.js Server SSRNode.js GraphQL ...\n\n<br/>\n\n### Node.js \n\n Node.js  SDK  Java Node.js  Java  Node.js \n\n** SDK **\n\n<!-- more -->\n\n<br/>\n\n### \n\n  Docker   K8s\n\n K8s Docker  K8s\n\n- \n- \n- Docker \n- \n- \n- \n- \n- ...\n\nK8s SDK  SDK  SDK \n\n<br/>\n\n### \n\n SDK \n\nIstio  K8s \n\n![Istio ](/images/nodejs-istio-k8s-docker/arch.jpg)\n\n A  B  HTTP/1.1HTTP/2gRPC  TCP \n\n#### Envoy\n\n Istio **Envoy** Sidecar SDK  Sidecar \n\n\n\n- HTTP 7 \n- \n- \n- \n- \n-  Mixer \n\nK8s  Pod  Sidecar \n\n#### Pilot\n\n Envoy  API  Envoy \n\n#### Mixer\n\nEnvoy  Mixer \n\n\n\n- Istio \n- Istio \n\n#### Citadel\n\n\n\n#### Galley\n\nGalley  Istio \n\n### \n\n [Bookinfo ](https://istio.io/latest/zh/docs/examples/bookinfo/) PythonJavaRubyNode.js4 \n\n![Bookinfo  ](/images/nodejs-istio-k8s-docker/book-app.png)\n\n\n","source":"_posts/nodejs-istio-k8s-docker.md","raw":"---\nlayout: minos\ntitle: Istio\ndate: 2020-06-28 10:00:00\ncategory: \ntags:\n  - \n  - \nkeywords: Istio,Node.js,JavaScript,\ndescription: IstioK8s DockerBFF  \n---\n\n_ Istio _\n\n Istio  K8sDocker  BFF \n\n### JavaScript \n\n JavaScript  3 React\\Vue\\Angular Node.js Express\\Koa\\Egg.js JavaScript  CLI  Express  JavaScript __\n\n<br/>\n\n### BFF \n\n BFF  Nginx  Node.js Server SSRNode.js GraphQL ...\n\n<br/>\n\n### Node.js \n\n Node.js  SDK  Java Node.js  Java  Node.js \n\n** SDK **\n\n<!-- more -->\n\n<br/>\n\n### \n\n  Docker   K8s\n\n K8s Docker  K8s\n\n- \n- \n- Docker \n- \n- \n- \n- \n- ...\n\nK8s SDK  SDK  SDK \n\n<br/>\n\n### \n\n SDK \n\nIstio  K8s \n\n![Istio ](/images/nodejs-istio-k8s-docker/arch.jpg)\n\n A  B  HTTP/1.1HTTP/2gRPC  TCP \n\n#### Envoy\n\n Istio **Envoy** Sidecar SDK  Sidecar \n\n\n\n- HTTP 7 \n- \n- \n- \n- \n-  Mixer \n\nK8s  Pod  Sidecar \n\n#### Pilot\n\n Envoy  API  Envoy \n\n#### Mixer\n\nEnvoy  Mixer \n\n\n\n- Istio \n- Istio \n\n#### Citadel\n\n\n\n#### Galley\n\nGalley  Istio \n\n### \n\n [Bookinfo ](https://istio.io/latest/zh/docs/examples/bookinfo/) PythonJavaRubyNode.js4 \n\n![Bookinfo  ](/images/nodejs-istio-k8s-docker/book-app.png)\n\n\n","slug":"nodejs-istio-k8s-docker","published":1,"updated":"2024-04-08T13:38:49.265Z","comments":1,"photos":[],"_id":"cm3a45wef001c18fd2p1k6h1k","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p><em> Istio </em></p>\n<p> Istio  K8sDocker  BFF </p>\n<h3 id=\"JavaScript-\"><a href=\"#JavaScript-\" class=\"headerlink\" title=\"JavaScript \"></a>JavaScript </h3><p> JavaScript  3 React\\Vue\\Angular Node.js Express\\Koa\\Egg.js JavaScript  CLI  Express  JavaScript <em></em></p>\n<br>\n\n<h3 id=\"BFF-\"><a href=\"#BFF-\" class=\"headerlink\" title=\"BFF \"></a>BFF </h3><p> BFF  Nginx  Node.js Server SSRNode.js GraphQL </p>\n<br>\n\n<h3 id=\"Node-js-\"><a href=\"#Node-js-\" class=\"headerlink\" title=\"Node.js \"></a>Node.js </h3><p> Node.js  SDK  Java Node.js  Java  Node.js </p>\n<p><strong> SDK </strong></p>\n<span id=\"more\"></span>\n\n<br>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>  Docker   K8s</p>\n<p> K8s Docker  K8s</p>\n<ul>\n<li></li>\n<li></li>\n<li>Docker </li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p>K8s SDK  SDK  SDK </p>\n<br>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> SDK </p>\n<p>Istio  K8s </p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/arch.jpg\" alt=\"Istio \"></p>\n<p> A  B  HTTP/1.1HTTP/2gRPC  TCP </p>\n<h4 id=\"Envoy\"><a href=\"#Envoy\" class=\"headerlink\" title=\"Envoy\"></a>Envoy</h4><p> Istio <strong>Envoy</strong> Sidecar SDK  Sidecar </p>\n<p></p>\n<ul>\n<li>HTTP 7 </li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li> Mixer </li>\n</ul>\n<p>K8s  Pod  Sidecar </p>\n<h4 id=\"Pilot\"><a href=\"#Pilot\" class=\"headerlink\" title=\"Pilot\"></a>Pilot</h4><p> Envoy  API  Envoy </p>\n<h4 id=\"Mixer\"><a href=\"#Mixer\" class=\"headerlink\" title=\"Mixer\"></a>Mixer</h4><p>Envoy  Mixer </p>\n<p></p>\n<ul>\n<li>Istio </li>\n<li>Istio </li>\n</ul>\n<h4 id=\"Citadel\"><a href=\"#Citadel\" class=\"headerlink\" title=\"Citadel\"></a>Citadel</h4><p></p>\n<h4 id=\"Galley\"><a href=\"#Galley\" class=\"headerlink\" title=\"Galley\"></a>Galley</h4><p>Galley  Istio </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> <a href=\"https://istio.io/latest/zh/docs/examples/bookinfo/\">Bookinfo </a> PythonJavaRubyNode.js4 </p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/book-app.png\" alt=\"Bookinfo  \"></p>\n<p></p>\n</body></html>","_categories":[{"name":"","path":"categories//"}],"_tags":[{"name":"","path":"tags//"},{"name":"","path":"tags//"}],"excerpt":"<html><head></head><body><p><em> Istio </em></p>\n<p> Istio  K8sDocker  BFF </p>\n<h3 id=\"JavaScript-\"><a href=\"#JavaScript-\" class=\"headerlink\" title=\"JavaScript \"></a>JavaScript </h3><p> JavaScript  3 React\\Vue\\Angular Node.js Express\\Koa\\Egg.js JavaScript  CLI  Express  JavaScript <em></em></p>\n<br>\n\n<h3 id=\"BFF-\"><a href=\"#BFF-\" class=\"headerlink\" title=\"BFF \"></a>BFF </h3><p> BFF  Nginx  Node.js Server SSRNode.js GraphQL </p>\n<br>\n\n<h3 id=\"Node-js-\"><a href=\"#Node-js-\" class=\"headerlink\" title=\"Node.js \"></a>Node.js </h3><p> Node.js  SDK  Java Node.js  Java  Node.js </p>\n<p><strong> SDK </strong></p></body></html>","more":"<br/>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>  Docker   K8s</p>\n<p> K8s Docker  K8s</p>\n<ul>\n<li></li>\n<li></li>\n<li>Docker </li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p>K8s SDK  SDK  SDK </p>\n<br/>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> SDK </p>\n<p>Istio  K8s </p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/arch.jpg\" alt=\"Istio \"></p>\n<p> A  B  HTTP&#x2F;1.1HTTP&#x2F;2gRPC  TCP </p>\n<h4 id=\"Envoy\"><a href=\"#Envoy\" class=\"headerlink\" title=\"Envoy\"></a>Envoy</h4><p> Istio <strong>Envoy</strong> Sidecar SDK  Sidecar </p>\n<p></p>\n<ul>\n<li>HTTP 7 </li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li> Mixer </li>\n</ul>\n<p>K8s  Pod  Sidecar </p>\n<h4 id=\"Pilot\"><a href=\"#Pilot\" class=\"headerlink\" title=\"Pilot\"></a>Pilot</h4><p> Envoy  API  Envoy </p>\n<h4 id=\"Mixer\"><a href=\"#Mixer\" class=\"headerlink\" title=\"Mixer\"></a>Mixer</h4><p>Envoy  Mixer </p>\n<p></p>\n<ul>\n<li>Istio </li>\n<li>Istio </li>\n</ul>\n<h4 id=\"Citadel\"><a href=\"#Citadel\" class=\"headerlink\" title=\"Citadel\"></a>Citadel</h4><p></p>\n<h4 id=\"Galley\"><a href=\"#Galley\" class=\"headerlink\" title=\"Galley\"></a>Galley</h4><p>Galley  Istio </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> <a href=\"https://istio.io/latest/zh/docs/examples/bookinfo/\">Bookinfo </a> PythonJavaRubyNode.js4 </p>\n<p><img src=\"/images/nodejs-istio-k8s-docker/book-app.png\" alt=\"Bookinfo  \"></p>\n<p></p>"},{"layout":"minos","title":"Node.js  Cluster  Worker Threads","description":"Cluster  Node.js  K8s Pod  Cluster Egg.js  18  Node.js  Worker Threads ","keywords":"Node.js,Worker Threads,Cluster,,","date":"2020-09-01T16:00:00.000Z","_content":"\n#### [Cluster](https://nodejs.org/dist/latest-v14.x/docs/api/cluster.html)\n\n Node.js V0.8  Web  CPU PM2   Egg.js  [ Node.js  cluster](https://miser.github.io/2020/05/03/node-js-net-cluster-fork/?s=node-js-net-cluster-fork) \n\n Cluster \n\n- \n-  Cluster \n-  Cluster  Docker  Cluster \n-  Cluster  Egg.js PM2\n\n<br />\n\n#### [Worker Threads](https://nodejs.org/dist/latest-v14.x/docs/api/worker_threads.html)\n\n Node.js V10.5.0 `--experimental-worker` V12 \n\nSSR) Egg.js  Cluster  Egg.js  Express  Koa \n\n Worker Threads  CPU\n\n<!-- more -->\n\n<br />\n\n#### \n\n****\n\n List100 \n\n****\n\n- MacBook Pro (Retina, 13-inch, Mid 2014)\n- CPU 2.6 GHz  Intel Core i5\n-  8 GB 1600 MHz DDR3\n\n****\n\n[ssr-thread-test](https://github.com/miser/ssr-thread-test)\n\n```javascript\nnode one.js //  web\n```\n\n```javascript\nnode multiple.js //  web\n```\n\n[](https://nodejs.org/dist/latest-v14.x/docs/api/async_hooks.html#async_hooks_using_asyncresource_for_a_worker_thread_pool)\n\n 2W  30 \n\n```shell\nab -n 20000 -c 30 -k \"http://localhost:9000/test\"\n```\n\n****\n 10 \n\n|                       |   |   |\n| --------------------- | ------- | ------- |\n| Time Taken For Tests  | 47.187  | 45.147  |\n| Requests Per Second   | 423.938 | 444.377 |\n| 95% | 44.571  | 40      |\n\n SSR \n\nCluster  Node.js  K8s Pod  Cluster Egg.js  18  Node.js  Worker Threads \n","source":"_posts/ssr-nodejs-thread-test.md","raw":"---\nlayout: minos\ntitle: Node.js  Cluster  Worker Threads\ncategory: JavaScript\ndescription: Cluster  Node.js  K8s Pod  Cluster Egg.js  18  Node.js  Worker Threads \ntags:\n  - SSR\nkeywords: Node.js,Worker Threads,Cluster,,\n\ndate: 2020-09-02\n---\n\n#### [Cluster](https://nodejs.org/dist/latest-v14.x/docs/api/cluster.html)\n\n Node.js V0.8  Web  CPU PM2   Egg.js  [ Node.js  cluster](https://miser.github.io/2020/05/03/node-js-net-cluster-fork/?s=node-js-net-cluster-fork) \n\n Cluster \n\n- \n-  Cluster \n-  Cluster  Docker  Cluster \n-  Cluster  Egg.js PM2\n\n<br />\n\n#### [Worker Threads](https://nodejs.org/dist/latest-v14.x/docs/api/worker_threads.html)\n\n Node.js V10.5.0 `--experimental-worker` V12 \n\nSSR) Egg.js  Cluster  Egg.js  Express  Koa \n\n Worker Threads  CPU\n\n<!-- more -->\n\n<br />\n\n#### \n\n****\n\n List100 \n\n****\n\n- MacBook Pro (Retina, 13-inch, Mid 2014)\n- CPU 2.6 GHz  Intel Core i5\n-  8 GB 1600 MHz DDR3\n\n****\n\n[ssr-thread-test](https://github.com/miser/ssr-thread-test)\n\n```javascript\nnode one.js //  web\n```\n\n```javascript\nnode multiple.js //  web\n```\n\n[](https://nodejs.org/dist/latest-v14.x/docs/api/async_hooks.html#async_hooks_using_asyncresource_for_a_worker_thread_pool)\n\n 2W  30 \n\n```shell\nab -n 20000 -c 30 -k \"http://localhost:9000/test\"\n```\n\n****\n 10 \n\n|                       |   |   |\n| --------------------- | ------- | ------- |\n| Time Taken For Tests  | 47.187  | 45.147  |\n| Requests Per Second   | 423.938 | 444.377 |\n| 95% | 44.571  | 40      |\n\n SSR \n\nCluster  Node.js  K8s Pod  Cluster Egg.js  18  Node.js  Worker Threads \n","slug":"ssr-nodejs-thread-test","published":1,"updated":"2024-04-08T13:38:47.808Z","comments":1,"photos":[],"_id":"cm3a45weg001g18fd6khfg48v","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><h4 id=\"Cluster\"><a href=\"#Cluster\" class=\"headerlink\" title=\"Cluster\"></a><a href=\"https://nodejs.org/dist/latest-v14.x/docs/api/cluster.html\">Cluster</a></h4><p> Node.js V0.8  Web  CPU PM2   Egg.js  <a href=\"https://miser.github.io/2020/05/03/node-js-net-cluster-fork/?s=node-js-net-cluster-fork\"> Node.js  cluster</a> </p>\n<p> Cluster </p>\n<ul>\n<li></li>\n<li> Cluster </li>\n<li> Cluster  Docker  Cluster </li>\n<li> Cluster  Egg.js PM2</li>\n</ul>\n<br>\n\n<h4 id=\"Worker-Threads\"><a href=\"#Worker-Threads\" class=\"headerlink\" title=\"Worker Threads\"></a><a href=\"https://nodejs.org/dist/latest-v14.x/docs/api/worker_threads.html\">Worker Threads</a></h4><p> Node.js V10.5.0 <code>--experimental-worker</code> V12 </p>\n<p>SSR) Egg.js  Cluster  Egg.js  Express  Koa </p>\n<p> Worker Threads  CPU</p>\n<span id=\"more\"></span>\n\n<br>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong></p>\n<p> List100 </p>\n<p><strong></strong></p>\n<ul>\n<li>MacBook Pro (Retina, 13-inch, Mid 2014)</li>\n<li>CPU 2.6 GHz  Intel Core i5</li>\n<li> 8 GB 1600 MHz DDR3</li>\n</ul>\n<p><strong></strong></p>\n<p><a href=\"https://github.com/miser/ssr-thread-test\">ssr-thread-test</a></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">node one.<span class=\"hljs-property\">js</span> <span class=\"hljs-comment\">//  web</span></span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">node multiple.<span class=\"hljs-property\">js</span> <span class=\"hljs-comment\">//  web</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><a href=\"https://nodejs.org/dist/latest-v14.x/docs/api/async_hooks.html#async_hooks_using_asyncresource_for_a_worker_thread_pool\"></a></p>\n<p> 2W  30 </p>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ab -n 20000 -c 30 -k \"http://localhost:9000/test\"</span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong></strong><br> 10 </p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Time Taken For Tests</td>\n<td>47.187</td>\n<td>45.147</td>\n</tr>\n<tr>\n<td>Requests Per Second</td>\n<td>423.938</td>\n<td>444.377</td>\n</tr>\n<tr>\n<td>95%</td>\n<td>44.571</td>\n<td>40</td>\n</tr>\n</tbody></table>\n<p> SSR </p>\n<p>Cluster  Node.js  K8s Pod  Cluster Egg.js  18  Node.js  Worker Threads </p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"SSR","path":"tags/SSR/"}],"excerpt":"<html><head></head><body><h4 id=\"Cluster\"><a href=\"#Cluster\" class=\"headerlink\" title=\"Cluster\"></a><a href=\"https://nodejs.org/dist/latest-v14.x/docs/api/cluster.html\">Cluster</a></h4><p> Node.js V0.8  Web  CPU PM2   Egg.js  <a href=\"https://miser.github.io/2020/05/03/node-js-net-cluster-fork/?s=node-js-net-cluster-fork\"> Node.js  cluster</a> </p>\n<p> Cluster </p>\n<ul>\n<li></li>\n<li> Cluster </li>\n<li> Cluster  Docker  Cluster </li>\n<li> Cluster  Egg.js PM2</li>\n</ul>\n<br>\n\n<h4 id=\"Worker-Threads\"><a href=\"#Worker-Threads\" class=\"headerlink\" title=\"Worker Threads\"></a><a href=\"https://nodejs.org/dist/latest-v14.x/docs/api/worker_threads.html\">Worker Threads</a></h4><p> Node.js V10.5.0 <code>--experimental-worker</code> V12 </p>\n<p>SSR) Egg.js  Cluster  Egg.js  Express  Koa </p>\n<p> Worker Threads  CPU</p></body></html>","more":"<br />\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong></p>\n<p> List100 </p>\n<p><strong></strong></p>\n<ul>\n<li>MacBook Pro (Retina, 13-inch, Mid 2014)</li>\n<li>CPU 2.6 GHz  Intel Core i5</li>\n<li> 8 GB 1600 MHz DDR3</li>\n</ul>\n<p><strong></strong></p>\n<p><a href=\"https://github.com/miser/ssr-thread-test\">ssr-thread-test</a></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">node one.<span class=\"property\">js</span> <span class=\"comment\">//  web</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">node multiple.<span class=\"property\">js</span> <span class=\"comment\">//  web</span></span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://nodejs.org/dist/latest-v14.x/docs/api/async_hooks.html#async_hooks_using_asyncresource_for_a_worker_thread_pool\"></a></p>\n<p> 2W  30 </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ab -n 20000 -c 30 -k &quot;http://localhost:9000/test&quot;</span><br></pre></td></tr></table></figure>\n\n<p><strong></strong><br> 10 </p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Time Taken For Tests</td>\n<td>47.187</td>\n<td>45.147</td>\n</tr>\n<tr>\n<td>Requests Per Second</td>\n<td>423.938</td>\n<td>444.377</td>\n</tr>\n<tr>\n<td>95%</td>\n<td>44.571</td>\n<td>40</td>\n</tr>\n</tbody></table>\n<p> SSR </p>\n<p>Cluster  Node.js  K8s Pod  Cluster Egg.js  18  Node.js  Worker Threads </p>"},{"title":"2019 ","date":"2019-12-30T15:30:00.000Z","_content":"\n> It was the best of times, it was the worst of times.\n\n2019****2018Node.jsJava[Eureka](https://github.com/Netflix/eureka)[ZooKeeper](https://zookeeper.apache.org/)[Discon](https://disconf.readthedocs.io/zh_CN/latest/)[Cat](https://github.com/dianping/cat)[RocketMQ](https://rocketmq.apache.org/)[SeaweedFS](https://github.com/chrislusf/seaweedfs)[MySQL](https://www.mysql.com/cn/).NET C# + JavascriptWebNode.js[](http://aimianwu.com)`Egg.js`Node.jsEventLoopMemory Leak\n\n\n\n<!-- more -->\n\n\n\n<br/>\n\n### EventLoop\n\nNode.jsTCP `Close Wait`TCPClose WaitNode.jsJavascript\n\n**Node.js**\n\n`alinode`Docker```Cat`C++EventLoopNode.js\n![catMessageSenderFun](/images/summary-2019/1.png)\n\n****\n\n3\n\n1. Node.js****BFF\n2. Node.js\n3. Docker`Cat`CPU\n\n<br/>\n\n### Memory Leak\n\n2\n\n**** ...\n\n**Vue SSR** VueGithub[](https://github.com/vuejs/vue/issues/5089)\n\n![https://github.com/vuejs/vue/issues/5089](/images/summary-2019/2.jpg)\n\n**Node.jsHubTCPNode.js**\n\n<br/>\n\n### \n\n`Webpack`NBCI`Egg.js`\n\n**Egg.js**\n\nEgg.jsWebpackNode.jsNode.js\n\n<br/>\n\n<br/>\n\n## 20192020\n\n20192020BFF\n\n\n\n\n\n\n","source":"_posts/summary-2019.md","raw":"---\ntitle: 2019 \ncategory: work\ndate: 2019-12-30 23:30:00\n---\n\n> It was the best of times, it was the worst of times.\n\n2019****2018Node.jsJava[Eureka](https://github.com/Netflix/eureka)[ZooKeeper](https://zookeeper.apache.org/)[Discon](https://disconf.readthedocs.io/zh_CN/latest/)[Cat](https://github.com/dianping/cat)[RocketMQ](https://rocketmq.apache.org/)[SeaweedFS](https://github.com/chrislusf/seaweedfs)[MySQL](https://www.mysql.com/cn/).NET C# + JavascriptWebNode.js[](http://aimianwu.com)`Egg.js`Node.jsEventLoopMemory Leak\n\n\n\n<!-- more -->\n\n\n\n<br/>\n\n### EventLoop\n\nNode.jsTCP `Close Wait`TCPClose WaitNode.jsJavascript\n\n**Node.js**\n\n`alinode`Docker```Cat`C++EventLoopNode.js\n![catMessageSenderFun](/images/summary-2019/1.png)\n\n****\n\n3\n\n1. Node.js****BFF\n2. Node.js\n3. Docker`Cat`CPU\n\n<br/>\n\n### Memory Leak\n\n2\n\n**** ...\n\n**Vue SSR** VueGithub[](https://github.com/vuejs/vue/issues/5089)\n\n![https://github.com/vuejs/vue/issues/5089](/images/summary-2019/2.jpg)\n\n**Node.jsHubTCPNode.js**\n\n<br/>\n\n### \n\n`Webpack`NBCI`Egg.js`\n\n**Egg.js**\n\nEgg.jsWebpackNode.jsNode.js\n\n<br/>\n\n<br/>\n\n## 20192020\n\n20192020BFF\n\n\n\n\n\n\n","slug":"summary-2019","published":1,"updated":"2024-04-08T13:38:47.059Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45weh001j18fdexuhd9hk","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><blockquote>\n<p>It was the best of times, it was the worst of times.</p>\n</blockquote>\n<p>2019<strong></strong>2018Node.jsJava<a href=\"https://github.com/Netflix/eureka\">Eureka</a><a href=\"https://zookeeper.apache.org/\">ZooKeeper</a><a href=\"https://disconf.readthedocs.io/zh_CN/latest/\">Discon</a><a href=\"https://github.com/dianping/cat\">Cat</a><a href=\"https://rocketmq.apache.org/\">RocketMQ</a><a href=\"https://github.com/chrislusf/seaweedfs\">SeaweedFS</a><a href=\"https://www.mysql.com/cn/\">MySQL</a>.NET C# + JavascriptWebNode.js<a href=\"http://aimianwu.com/\"></a><code>Egg.js</code>Node.jsEventLoopMemory Leak</p>\n<span id=\"more\"></span>\n\n\n\n<br>\n\n<h3 id=\"EventLoop\"><a href=\"#EventLoop\" class=\"headerlink\" title=\"EventLoop\"></a>EventLoop</h3><p>Node.jsTCP <code>Close Wait</code>TCPClose WaitNode.jsJavascript</p>\n<p><strong>Node.js</strong></p>\n<p><code>alinode</code>Docker<code></code><code>Cat</code>C++EventLoopNode.js<br><img src=\"/images/summary-2019/1.png\" alt=\"catMessageSenderFun\"></p>\n<p><strong></strong></p>\n<p>3</p>\n<ol>\n<li>Node.js<strong></strong>BFF</li>\n<li>Node.js</li>\n<li>Docker<code>Cat</code>CPU</li>\n</ol>\n<br>\n\n<h3 id=\"Memory-Leak\"><a href=\"#Memory-Leak\" class=\"headerlink\" title=\"Memory Leak\"></a>Memory Leak</h3><p>2</p>\n<p><strong></strong> </p>\n<p><strong>Vue SSR</strong> VueGithub<a href=\"https://github.com/vuejs/vue/issues/5089\"></a></p>\n<p><img src=\"/images/summary-2019/2.jpg\" alt=\"https://github.com/vuejs/vue/issues/5089\"></p>\n<p><strong>Node.jsHubTCPNode.js</strong></p>\n<br>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>Webpack</code>NBCI<code>Egg.js</code></p>\n<p><strong>Egg.js</strong></p>\n<p>Egg.jsWebpackNode.jsNode.js</p>\n<br>\n\n<br>\n\n<h2 id=\"20192020\"><a href=\"#20192020\" class=\"headerlink\" title=\"20192020\"></a>20192020</h2><p>20192020BFF</p>\n</body></html>","_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"<html><head></head><body><blockquote>\n<p>It was the best of times, it was the worst of times.</p>\n</blockquote>\n<p>2019<strong></strong>2018Node.jsJava<a href=\"https://github.com/Netflix/eureka\">Eureka</a><a href=\"https://zookeeper.apache.org/\">ZooKeeper</a><a href=\"https://disconf.readthedocs.io/zh_CN/latest/\">Discon</a><a href=\"https://github.com/dianping/cat\">Cat</a><a href=\"https://rocketmq.apache.org/\">RocketMQ</a><a href=\"https://github.com/chrislusf/seaweedfs\">SeaweedFS</a><a href=\"https://www.mysql.com/cn/\">MySQL</a>.NET C# + JavascriptWebNode.js<a href=\"http://aimianwu.com/\"></a><code>Egg.js</code>Node.jsEventLoopMemory Leak</p></body></html>","more":"<br/>\n\n<h3 id=\"EventLoop\"><a href=\"#EventLoop\" class=\"headerlink\" title=\"EventLoop\"></a>EventLoop</h3><p>Node.jsTCP <code>Close Wait</code>TCPClose WaitNode.jsJavascript</p>\n<p><strong>Node.js</strong></p>\n<p><code>alinode</code>Docker<code></code><code>Cat</code>C++EventLoopNode.js<br><img src=\"/images/summary-2019/1.png\" alt=\"catMessageSenderFun\"></p>\n<p><strong></strong></p>\n<p>3</p>\n<ol>\n<li>Node.js<strong></strong>BFF</li>\n<li>Node.js</li>\n<li>Docker<code>Cat</code>CPU</li>\n</ol>\n<br/>\n\n<h3 id=\"Memory-Leak\"><a href=\"#Memory-Leak\" class=\"headerlink\" title=\"Memory Leak\"></a>Memory Leak</h3><p>2</p>\n<p><strong></strong> </p>\n<p><strong>Vue SSR</strong> VueGithub<a href=\"https://github.com/vuejs/vue/issues/5089\"></a></p>\n<p><img src=\"/images/summary-2019/2.jpg\" alt=\"https://github.com/vuejs/vue/issues/5089\"></p>\n<p><strong>Node.jsHubTCPNode.js</strong></p>\n<br/>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>Webpack</code>NBCI<code>Egg.js</code></p>\n<p><strong>Egg.js</strong></p>\n<p>Egg.jsWebpackNode.jsNode.js</p>\n<br/>\n\n<br/>\n\n<h2 id=\"20192020\"><a href=\"#20192020\" class=\"headerlink\" title=\"20192020\"></a>20192020</h2><p>20192020BFF</p>"},{"title":"HR","date":"2018-07-20T09:01:34.000Z","_content":"****\n\nHR\n\n1.HR\n\n2.HR\n\n3.HR\n\nHRHRHR\n<!-- more -->\n****\n\n- offerHRHR\n- HR\n- HR\n- offerofferHR\n\n****\n\n\n\n\n\n\n\n****\n\n","source":"_posts/the-quality-of-a-company-first-look-at-HR-department.md","raw":"---\ntitle: HR\ncategory: work\ndate: 2018-07-20 17:01:34\n---\n****\n\nHR\n\n1.HR\n\n2.HR\n\n3.HR\n\nHRHRHR\n<!-- more -->\n****\n\n- offerHRHR\n- HR\n- HR\n- offerofferHR\n\n****\n\n\n\n\n\n\n\n****\n\n","slug":"the-quality-of-a-company-first-look-at-HR-department","published":1,"updated":"2024-04-08T13:38:46.333Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wej001n18fda3ppdxmo","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p><strong></strong></p>\n<p>HR</p>\n<p>1.HR</p>\n<p>2.HR</p>\n<p>3.HR</p>\n<p>HRHRHR</p>\n<span id=\"more\"></span>\n<p><strong></strong></p>\n<ul>\n<li>offerHRHR</li>\n<li>HR</li>\n<li>HR</li>\n<li>offerofferHR</li>\n</ul>\n<p><strong></strong></p>\n<p></p>\n<p></p>\n<p><strong></strong></p>\n<p></p>\n</body></html>","_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"<html><head></head><body><p><strong></strong></p>\n<p>HR</p>\n<p>1.HR</p>\n<p>2.HR</p>\n<p>3.HR</p>\n<p>HRHRHR</p></body></html>","more":"<p><strong></strong></p>\n<ul>\n<li>offerHRHR</li>\n<li>HR</li>\n<li>HR</li>\n<li>offerofferHR</li>\n</ul>\n<p><strong></strong></p>\n<p></p>\n<p></p>\n<p><strong></strong></p>\n<p></p>"},{"title":"2019","date":"2019-10-05T22:11:21.849Z","_content":"\n\n\n<!-- more -->\n\n<br/>\n\n### **#**\n\n`Airbnb`111132600100:(``\n\n![](/images/travel-zhoushan/travel-zhoushan-01.png)\n\n``\n\n![](/images/travel-zhoushan/travel-zhoushan-03.png)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg)\n\n<br/>\n\n### **#**\n\n2``13``\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg )\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg)\n\n<video width=\"100%\" muted controls>\n  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\">\n  Your browser does not support the video tag.\n</video>\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg)\n\n``730``\n\n<br/>\n\n### **#**\n\n__\n\n200\n\n![](/images/travel-zhoushan/travel-zhoushan-16.png)\n\n![6](/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg)\n\n![&1](/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg)\n\n![&2](/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg)\n\n![& ](/images/travel-zhoushan/travel-zhoushan-23.png)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg)\n\n![3](/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg)\n\n![ ](/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg)\n\n````\n\n> 114.9692000\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg)\n\n\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg)\n\nU``\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg)\n\n![3](/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg)\n\n![4](/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg)\n\n![](/images/travel-zhoushan/travel-zhoushan-32.png)\n\n\n\n### **#**\n\n3\n\n","source":"_posts/travel-zhoushan.md","raw":"---\ntitle: 2019\ncategory: travel\ndate: 2019-10-06T06:11:21.849Z\n---\n\n\n\n<!-- more -->\n\n<br/>\n\n### **#**\n\n`Airbnb`111132600100:(``\n\n![](/images/travel-zhoushan/travel-zhoushan-01.png)\n\n``\n\n![](/images/travel-zhoushan/travel-zhoushan-03.png)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg)\n\n<br/>\n\n### **#**\n\n2``13``\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg )\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg)\n\n<video width=\"100%\" muted controls>\n  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\">\n  Your browser does not support the video tag.\n</video>\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg)\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg)\n\n``730``\n\n<br/>\n\n### **#**\n\n__\n\n200\n\n![](/images/travel-zhoushan/travel-zhoushan-16.png)\n\n![6](/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg)\n\n![&1](/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg)\n\n![&2](/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg)\n\n![& ](/images/travel-zhoushan/travel-zhoushan-23.png)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg)\n\n![3](/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg)\n\n![ ](/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg)\n\n````\n\n> 114.9692000\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg)\n\n\n\n![](/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg)\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg)\n\nU``\n\n![1](/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg)\n\n![2](/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg)\n\n![3](/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg)\n\n![4](/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg)\n\n![](/images/travel-zhoushan/travel-zhoushan-32.png)\n\n\n\n### **#**\n\n3\n\n","slug":"travel-zhoushan","published":1,"updated":"2024-04-08T13:38:45.561Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wek001q18fd71265mqf","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p></p>\n<span id=\"more\"></span>\n\n<br>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p><code>Airbnb</code>111132600100:(<code></code></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-01.png\" alt=\"\"></p>\n<p><code></code></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-03.png\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg\" alt=\"\"></p>\n<br>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>2<code></code>13<code></code></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg\" alt=\"1\"></p>\n<video width=\"100%\" muted=\"\" controls=\"\">\n  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\">\n  Your browser does not support the video tag.\n</video>\n\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg\" alt=\"\"></p>\n<p><code></code>730<code></code></p>\n<br>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p><em></em></p>\n<p>200</p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-16.png\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg\" alt=\"6\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg\" alt=\"&amp;1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg\" alt=\"&amp;2\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-23.png\" alt=\"&amp; \"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg\" alt=\"3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg\" alt=\" \"></p>\n<p><code></code><code></code></p>\n<blockquote>\n<p>114.9692000</p>\n</blockquote>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg\" alt=\"\"></p>\n<p></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg\" alt=\"2\"></p>\n<p>U<code></code></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg\" alt=\"3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg\" alt=\"4\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-32.png\" alt=\"\"></p>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>3</p>\n</body></html>","_categories":[{"name":"travel","path":"categories/travel/"}],"_tags":[],"excerpt":"<html><head></head><body><p></p></body></html>","more":"<br/>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p><code>Airbnb</code>111132600100:(<code></code></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-01.png\" alt=\"\"></p>\n<p><code></code></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-03.png\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-02.jpg\" alt=\"\"></p>\n<br/>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>2<code></code>13<code></code></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-04.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-05.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-06.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-07.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-08.jpg\" alt=\"1\"></p>\n<video width=\"100%\" muted controls>\n  <source id=\"mp4\" src=\"/images/travel-zhoushan/travel-zhoushan-15.mp4\">\n  Your browser does not support the video tag.\n</video>\n\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-09.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-10.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-11.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-12.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-13.jpg\" alt=\"\"></p>\n<p><code></code>730<code></code></p>\n<br/>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p><em></em></p>\n<p>200</p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-16.png\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-17.jpg\" alt=\"6\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-18.jpg\" alt=\"&amp;1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-19.jpg\" alt=\"&amp;2\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-23.png\" alt=\"&amp; \"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-20.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-22.jpg\" alt=\"3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-21.jpg\" alt=\" \"></p>\n<p><code></code><code></code></p>\n<blockquote>\n<p>114.9692000</p>\n</blockquote>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-24.jpg\" alt=\"\"></p>\n<p></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-25.jpg\" alt=\"\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-26.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-27.jpg\" alt=\"2\"></p>\n<p>U<code></code></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-28.jpg\" alt=\"1\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-30.jpg\" alt=\"2\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-29.jpg\" alt=\"3\"></p>\n<p><img src=\"/images/travel-zhoushan/optimize/travel-zhoushan-31.jpg\" alt=\"4\"></p>\n<p><img src=\"/images/travel-zhoushan/travel-zhoushan-32.png\" alt=\"\"></p>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"#\"></a><strong>#</strong></h3><p>3</p>"},{"title":"","date":"2018-09-24T06:45:00.000Z","_content":"\n\n![](/images/traveling-to-the-philippines/1.jpg)\n\n<!-- more -->\n\nLoading\n\n![](/images/traveling-to-the-philippines/2.jpg)\n\n### \n\n9BGC5MIN3\n\nBGCHSBC,Google\n\n\n\n![](/images/traveling-to-the-philippines/3.jpg)\n\n![](/images/traveling-to-the-philippines/4.jpg)\n\n![A](/images/traveling-to-the-philippines/7.jpg)\n\n![B](/images/traveling-to-the-philippines/8.jpg)\n\n![](/images/traveling-to-the-philippines/6.jpg)\n\n![](/images/traveling-to-the-philippines/9.jpg)\n\n### \n\nBGC1500Php\n\n![](/images/traveling-to-the-philippines/10.jpg)\n\n![A](/images/traveling-to-the-philippines/11.jpg)\n\n![B](/images/traveling-to-the-philippines/12.jpg)\n\n![C](/images/traveling-to-the-philippines/27.jpg)\n\n![](/images/traveling-to-the-philippines/13.jpg)\n\n![ %](/images/traveling-to-the-philippines/14.jpg)\n\n![](/images/traveling-to-the-philippines/15.jpg)\n\n![712Php 100](/images/traveling-to-the-philippines/16.jpg)\n\n![300Php](/images/traveling-to-the-philippines/17.jpg)\n\n2\n\n![](/images/traveling-to-the-philippines/19.jpg)\n\n![](/images/traveling-to-the-philippines/21.jpg)\n\n![](/images/traveling-to-the-philippines/20.jpg)\n\n![7000+ 5500  T_T](/images/traveling-to-the-philippines/22.jpg)\n\n![A ](/images/traveling-to-the-philippines/23.jpg)\n\n![B ](/images/traveling-to-the-philippines/24.jpg)\n\n![C ](/images/traveling-to-the-philippines/25.jpg)\n\n![ 23](/images/traveling-to-the-philippines/26.jpg)\n\n### \n\nGrab\n\n![A](/images/traveling-to-the-philippines/28.jpg)\n\n**\n\n![A](/images/traveling-to-the-philippines/29.jpg)\n\n\n![B](/images/traveling-to-the-philippines/30.jpg)\n\n### \n\nBGCAB\n\n\n\n![](/images/traveling-to-the-philippines/31.jpg)\n\n![](/images/traveling-to-the-philippines/34.jpg)\n\n![](/images/traveling-to-the-philippines/33.jpeg)\n\n![ATM](/images/traveling-to-the-philippines/32.jpg)\n\n\n## \n\n72:)\n\n","source":"_posts/traveling-to-the-philippines.md","raw":"---\ntitle: \ncategory: work\ndate: 2018-09-24 14:45:00\n---\n\n\n![](/images/traveling-to-the-philippines/1.jpg)\n\n<!-- more -->\n\nLoading\n\n![](/images/traveling-to-the-philippines/2.jpg)\n\n### \n\n9BGC5MIN3\n\nBGCHSBC,Google\n\n\n\n![](/images/traveling-to-the-philippines/3.jpg)\n\n![](/images/traveling-to-the-philippines/4.jpg)\n\n![A](/images/traveling-to-the-philippines/7.jpg)\n\n![B](/images/traveling-to-the-philippines/8.jpg)\n\n![](/images/traveling-to-the-philippines/6.jpg)\n\n![](/images/traveling-to-the-philippines/9.jpg)\n\n### \n\nBGC1500Php\n\n![](/images/traveling-to-the-philippines/10.jpg)\n\n![A](/images/traveling-to-the-philippines/11.jpg)\n\n![B](/images/traveling-to-the-philippines/12.jpg)\n\n![C](/images/traveling-to-the-philippines/27.jpg)\n\n![](/images/traveling-to-the-philippines/13.jpg)\n\n![ %](/images/traveling-to-the-philippines/14.jpg)\n\n![](/images/traveling-to-the-philippines/15.jpg)\n\n![712Php 100](/images/traveling-to-the-philippines/16.jpg)\n\n![300Php](/images/traveling-to-the-philippines/17.jpg)\n\n2\n\n![](/images/traveling-to-the-philippines/19.jpg)\n\n![](/images/traveling-to-the-philippines/21.jpg)\n\n![](/images/traveling-to-the-philippines/20.jpg)\n\n![7000+ 5500  T_T](/images/traveling-to-the-philippines/22.jpg)\n\n![A ](/images/traveling-to-the-philippines/23.jpg)\n\n![B ](/images/traveling-to-the-philippines/24.jpg)\n\n![C ](/images/traveling-to-the-philippines/25.jpg)\n\n![ 23](/images/traveling-to-the-philippines/26.jpg)\n\n### \n\nGrab\n\n![A](/images/traveling-to-the-philippines/28.jpg)\n\n**\n\n![A](/images/traveling-to-the-philippines/29.jpg)\n\n\n![B](/images/traveling-to-the-philippines/30.jpg)\n\n### \n\nBGCAB\n\n\n\n![](/images/traveling-to-the-philippines/31.jpg)\n\n![](/images/traveling-to-the-philippines/34.jpg)\n\n![](/images/traveling-to-the-philippines/33.jpeg)\n\n![ATM](/images/traveling-to-the-philippines/32.jpg)\n\n\n## \n\n72:)\n\n","slug":"traveling-to-the-philippines","published":1,"updated":"2024-04-08T13:38:44.770Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wel001u18fd56w03cox","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p></p>\n<p><img src=\"/images/traveling-to-the-philippines/1.jpg\" alt=\"\"></p>\n<span id=\"more\"></span>\n\n<p>Loading</p>\n<p><img src=\"/images/traveling-to-the-philippines/2.jpg\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>9BGC5MIN3</p>\n<p>BGCHSBC,Google</p>\n<p></p>\n<p><img src=\"/images/traveling-to-the-philippines/3.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/4.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/7.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/8.jpg\" alt=\"B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/6.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/9.jpg\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BGC1500Php</p>\n<p><img src=\"/images/traveling-to-the-philippines/10.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/11.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/12.jpg\" alt=\"B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/27.jpg\" alt=\"C\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/13.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/14.jpg\" alt=\" %\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/15.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/16.jpg\" alt=\"712Php 100\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/17.jpg\" alt=\"300Php\"></p>\n<p>2</p>\n<p><img src=\"/images/traveling-to-the-philippines/19.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/21.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/20.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/22.jpg\" alt=\"7000+ 5500  T_T\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/23.jpg\" alt=\"A \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/24.jpg\" alt=\"B \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/25.jpg\" alt=\"C \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/26.jpg\" alt=\" 23\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Grab</p>\n<p><img src=\"/images/traveling-to-the-philippines/28.jpg\" alt=\"A\"></p>\n<p><em></em></p>\n<p><img src=\"/images/traveling-to-the-philippines/29.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/30.jpg\" alt=\"B\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BGCAB</p>\n<p></p>\n<p><img src=\"/images/traveling-to-the-philippines/31.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/34.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/33.jpeg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/32.jpg\" alt=\"ATM\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>72:)</p>\n</body></html>","_categories":[{"name":"work","path":"categories/work/"}],"_tags":[],"excerpt":"<html><head></head><body><p></p>\n<p><img src=\"/images/traveling-to-the-philippines/1.jpg\" alt=\"\"></p></body></html>","more":"<p>Loading</p>\n<p><img src=\"/images/traveling-to-the-philippines/2.jpg\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>9BGC5MIN3</p>\n<p>BGCHSBC,Google</p>\n<p></p>\n<p><img src=\"/images/traveling-to-the-philippines/3.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/4.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/7.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/8.jpg\" alt=\"B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/6.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/9.jpg\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BGC1500Php</p>\n<p><img src=\"/images/traveling-to-the-philippines/10.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/11.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/12.jpg\" alt=\"B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/27.jpg\" alt=\"C\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/13.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/14.jpg\" alt=\" %\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/15.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/16.jpg\" alt=\"712Php 100\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/17.jpg\" alt=\"300Php\"></p>\n<p>2</p>\n<p><img src=\"/images/traveling-to-the-philippines/19.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/21.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/20.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/22.jpg\" alt=\"7000+ 5500  T_T\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/23.jpg\" alt=\"A \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/24.jpg\" alt=\"B \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/25.jpg\" alt=\"C \"></p>\n<p><img src=\"/images/traveling-to-the-philippines/26.jpg\" alt=\" 23\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Grab</p>\n<p><img src=\"/images/traveling-to-the-philippines/28.jpg\" alt=\"A\"></p>\n<p><em></em></p>\n<p><img src=\"/images/traveling-to-the-philippines/29.jpg\" alt=\"A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/30.jpg\" alt=\"B\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>BGCAB</p>\n<p></p>\n<p><img src=\"/images/traveling-to-the-philippines/31.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/34.jpg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/33.jpeg\" alt=\"\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/32.jpg\" alt=\"ATM\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>72:)</p>"},{"title":"V8JavaScript","keywords":"V8,Node.js,","description":"ParerCompiler2V8JavaScript","date":"2020-02-08T01:18:53.485Z","_content":"\n> ``172020****\n\n\n\n**Parer****Compiler**2V8JavaScript\n\n![Parser15-20%](/images/v8-parser-compiler/v8-pare-compile-cost.png)\n\n<!-- more -->\n\n\n\n# **Parser**\n\n![Parser](/images/v8-parser-compiler/parser-phase.png)\n\n** `1 MB / s`**\n\n<br/>\n\n#### **V8Parser2**\n\n`LayzePre-Parsing`\n\n- \n- `AST``Scopes`\n- Eage2\n- JavaScript\n\n`EageFull-Parsing`\n\n- \n- `AST`\n- `Scopes`\n- \n\n<br/>\n\n#### Q:2\n\nFull-ParsingDevTools`coverage`\n\n<br/>\n\n#### Q:2\n\nPre-ParsingFull-Parser: `0.5 * parse + 1 * parse = 1.5 parse` \n\n<br/>\n\n#### Q: `Pre-Parsing`  `Full-Parsing` \n\n```javascript\nlet a = 0; // Top-Level  Full-Parsing\n\n//  IIFE = Immediately Invoked Function Expression\n(function eager() {...})(); //  Full-Parsing\n                   \n// IIFE\nfunction lazy() {...} //  Pre-Parsing\n\nlazy(); // -> Full-Parsing \n                 \n// Full-Parsing\n!function eager2() {...}, function eager3() {...} // All eager\n \nlet f1 = function lazy() { ... }; //  Pre-Parsing\n              \nlet f2 = function lazy() {...}(); // lazy , eager\n```\n\n<br/>\n\n#### Q:Full-Parsing eager \n\n- lazy 2 lazy  eager '!|~'\n-  [optimize-js](https://github.com/nolanlawson/optimize-js) Github\n\n<br/>\n\n#### Q:\n\n```javascript\nfunction lazy_outer() { // lazy parse this\n  function inner() {\n    function inner2() {\n      // ...\n    }\n  }\n}\n\nlazy_outer(); // lazy parsing inner & inner2\ninner(); // lazy parsing inner & inner2 (3rd time!)\n```\n\n`Pre-Parsing`\n\n<br/>\n\n#### Q:Parser\n\n1. ****DevTools`coverage`\n2. V8Parser72bundlebundleParser\n\n<br/>\n\n#### Q:ParserCompiler\n\n1. `chrome://tracing/`[](http://aimianwu.com)\n\n2.tracing`Record`\n\n3.`Web developer`Edit categories`v8.runtime_stats`\n\n4.Tab http://aimianwu.com tracing Tab\n\n5.\"\"\n\n6.Process\n\n![](/images/v8-parser-compiler/parse-time.png)\n\n![](/images/v8-parser-compiler/parse-time-1.png)\n\n7.V8ParseCompile\n\n![](/images/v8-parser-compiler/parse-time-2.png)\n\n<br/>\n\n<br/>\n\n# **Compiler Pipeline**\n\nV8Compiler PipelineV8 5.9 Ignition + TurboFan 2010Full-codegen + Crankshaft Ignition + TurboFan Full-codegen + CrankshaftTurboFan[PPT](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389)\n\n<br/>\n\n#### Q:[](https://v8.dev/blog/launching-ignition-and-turbofan)\nJavaScript\n\n* JavaScriptV81/3Crankshaft\n* Crankshaft trycatchfinally  ESWebAssembly\nPC\n\n<br/>\n\n#### Q: V8 Compiler \n\nJavaScriptV8TurboFanIgnitionTurboFan`Optimize`DeoptimizeIgnition\n\n2[](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n* \n* JavaScript\n\n![](/images/v8-parser-compiler/not-change-types-1.png)\n\n![](/images/v8-parser-compiler/not-change-types-2.png)\n\n![](/images/v8-parser-compiler/not-change-types-3.png)\n\n> ObjectsV8De-optimisation\n\n```javascript\nfunction load(obj) {\n  return obj.x\n}\n\nvar obj = {\n  x: 1,\n  y: 4\n} \n```\n\n\n\n `obj = {}`  `obj = { x: \"Number\" }` `obj = { y: \"Number\" }` C++Java\n\n\n\n```javascript\nload({ x: 4, a: 7 });\nload({ x: 4, b: 9 });\nload({ x: 4, c: 3 });\nload({ x: 4, d: 1 });\n```\n\n\n\n```javascript\nload({ x: 4, a: 7, b: undefined, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: 9, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: 3, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: undefined, d: 1 });\n\n```\n\nTypeScript\n\n\n\n# \n\n`V8`[Script Streaming](https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html) https://v8.dev/ JavaScriptV8\n\nWebAssemblyNode.jsC++JavaScriptArduinoJavaScriptC/C++C/C++\n\n\n\n\n\n### \n\n[Parsing JavaScript - better lazy than eager](https://www.youtube.com/watch?v=Fg7niTmNNLg)\n\n[JavaScript engines - how do they even? ](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n[JavaScript Start-up Performance](https://medium.com/reloading/javascript-start-up-performance-69200f43b201)\n\n[V8: Hooking up the Ignition to the Turbofan](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103)","source":"_posts/v8-parser-compiler-javascript.md","raw":"---\ntitle: V8JavaScript\ncategory: JavaScript\nkeywords: V8,Node.js,\ndescription: ParerCompiler2V8JavaScript\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-02-08T09:18:53.485Z\n---\n\n> ``172020****\n\n\n\n**Parer****Compiler**2V8JavaScript\n\n![Parser15-20%](/images/v8-parser-compiler/v8-pare-compile-cost.png)\n\n<!-- more -->\n\n\n\n# **Parser**\n\n![Parser](/images/v8-parser-compiler/parser-phase.png)\n\n** `1 MB / s`**\n\n<br/>\n\n#### **V8Parser2**\n\n`LayzePre-Parsing`\n\n- \n- `AST``Scopes`\n- Eage2\n- JavaScript\n\n`EageFull-Parsing`\n\n- \n- `AST`\n- `Scopes`\n- \n\n<br/>\n\n#### Q:2\n\nFull-ParsingDevTools`coverage`\n\n<br/>\n\n#### Q:2\n\nPre-ParsingFull-Parser: `0.5 * parse + 1 * parse = 1.5 parse` \n\n<br/>\n\n#### Q: `Pre-Parsing`  `Full-Parsing` \n\n```javascript\nlet a = 0; // Top-Level  Full-Parsing\n\n//  IIFE = Immediately Invoked Function Expression\n(function eager() {...})(); //  Full-Parsing\n                   \n// IIFE\nfunction lazy() {...} //  Pre-Parsing\n\nlazy(); // -> Full-Parsing \n                 \n// Full-Parsing\n!function eager2() {...}, function eager3() {...} // All eager\n \nlet f1 = function lazy() { ... }; //  Pre-Parsing\n              \nlet f2 = function lazy() {...}(); // lazy , eager\n```\n\n<br/>\n\n#### Q:Full-Parsing eager \n\n- lazy 2 lazy  eager '!|~'\n-  [optimize-js](https://github.com/nolanlawson/optimize-js) Github\n\n<br/>\n\n#### Q:\n\n```javascript\nfunction lazy_outer() { // lazy parse this\n  function inner() {\n    function inner2() {\n      // ...\n    }\n  }\n}\n\nlazy_outer(); // lazy parsing inner & inner2\ninner(); // lazy parsing inner & inner2 (3rd time!)\n```\n\n`Pre-Parsing`\n\n<br/>\n\n#### Q:Parser\n\n1. ****DevTools`coverage`\n2. V8Parser72bundlebundleParser\n\n<br/>\n\n#### Q:ParserCompiler\n\n1. `chrome://tracing/`[](http://aimianwu.com)\n\n2.tracing`Record`\n\n3.`Web developer`Edit categories`v8.runtime_stats`\n\n4.Tab http://aimianwu.com tracing Tab\n\n5.\"\"\n\n6.Process\n\n![](/images/v8-parser-compiler/parse-time.png)\n\n![](/images/v8-parser-compiler/parse-time-1.png)\n\n7.V8ParseCompile\n\n![](/images/v8-parser-compiler/parse-time-2.png)\n\n<br/>\n\n<br/>\n\n# **Compiler Pipeline**\n\nV8Compiler PipelineV8 5.9 Ignition + TurboFan 2010Full-codegen + Crankshaft Ignition + TurboFan Full-codegen + CrankshaftTurboFan[PPT](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389)\n\n<br/>\n\n#### Q:[](https://v8.dev/blog/launching-ignition-and-turbofan)\nJavaScript\n\n* JavaScriptV81/3Crankshaft\n* Crankshaft trycatchfinally  ESWebAssembly\nPC\n\n<br/>\n\n#### Q: V8 Compiler \n\nJavaScriptV8TurboFanIgnitionTurboFan`Optimize`DeoptimizeIgnition\n\n2[](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n* \n* JavaScript\n\n![](/images/v8-parser-compiler/not-change-types-1.png)\n\n![](/images/v8-parser-compiler/not-change-types-2.png)\n\n![](/images/v8-parser-compiler/not-change-types-3.png)\n\n> ObjectsV8De-optimisation\n\n```javascript\nfunction load(obj) {\n  return obj.x\n}\n\nvar obj = {\n  x: 1,\n  y: 4\n} \n```\n\n\n\n `obj = {}`  `obj = { x: \"Number\" }` `obj = { y: \"Number\" }` C++Java\n\n\n\n```javascript\nload({ x: 4, a: 7 });\nload({ x: 4, b: 9 });\nload({ x: 4, c: 3 });\nload({ x: 4, d: 1 });\n```\n\n\n\n```javascript\nload({ x: 4, a: 7, b: undefined, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: 9, c: undefined, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: 3, d: undefined });\nload({ x: 4, a: undefined, b: undefined, c: undefined, d: 1 });\n\n```\n\nTypeScript\n\n\n\n# \n\n`V8`[Script Streaming](https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html) https://v8.dev/ JavaScriptV8\n\nWebAssemblyNode.jsC++JavaScriptArduinoJavaScriptC/C++C/C++\n\n\n\n\n\n### \n\n[Parsing JavaScript - better lazy than eager](https://www.youtube.com/watch?v=Fg7niTmNNLg)\n\n[JavaScript engines - how do they even? ](https://www.youtube.com/watch?v=p-iiEDtpy6I)\n\n[JavaScript Start-up Performance](https://medium.com/reloading/javascript-start-up-performance-69200f43b201)\n\n[V8: Hooking up the Ignition to the Turbofan](https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103)","slug":"v8-parser-compiler-javascript","published":1,"updated":"2024-04-08T13:38:42.870Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wev002y18fd7nxm5gqa","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><blockquote>\n<p><code></code>172020<strong></strong></p>\n</blockquote>\n<p><strong>Parer</strong><strong>Compiler</strong>2V8JavaScript</p>\n<p><img src=\"/images/v8-parser-compiler/v8-pare-compile-cost.png\" alt=\"Parser15-20%\"></p>\n<span id=\"more\"></span>\n\n\n\n<h1 id=\"Parser\"><a href=\"#Parser\" class=\"headerlink\" title=\"Parser\"></a><strong>Parser</strong></h1><p><img src=\"/images/v8-parser-compiler/parser-phase.png\" alt=\"Parser\"></p>\n<p><strong> <code>1 MB / s</code></strong></p>\n<br>\n\n<h4 id=\"V8Parser2\"><a href=\"#V8Parser2\" class=\"headerlink\" title=\"V8Parser2\"></a><strong>V8Parser2</strong></h4><p><code>LayzePre-Parsing</code></p>\n<ul>\n<li></li>\n<li><code>AST</code><code>Scopes</code></li>\n<li>Eage2</li>\n<li>JavaScript</li>\n</ul>\n<p><code>EageFull-Parsing</code></p>\n<ul>\n<li></li>\n<li><code>AST</code></li>\n<li><code>Scopes</code></li>\n<li></li>\n</ul>\n<br>\n\n<h4 id=\"Q-2\"><a href=\"#Q-2\" class=\"headerlink\" title=\"Q:2\"></a>Q:2</h4><p>Full-ParsingDevTools<code>coverage</code></p>\n<br>\n\n<h4 id=\"Q-2\"><a href=\"#Q-2\" class=\"headerlink\" title=\"Q:2\"></a>Q:2</h4><p>Pre-ParsingFull-Parser: <code>0.5 * parse + 1 * parse = 1.5 parse</code> </p>\n<br>\n\n<h4 id=\"Q--Pre-Parsing--Full-Parsing-\"><a href=\"#Q--Pre-Parsing--Full-Parsing-\" class=\"headerlink\" title=\"Q: Pre-Parsing  Full-Parsing \"></a>Q: <code>Pre-Parsing</code>  <code>Full-Parsing</code> </h4><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">let</span> a = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// Top-Level  Full-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//  IIFE = Immediately Invoked Function Expression</span></span><br><span class=\"line\">(<span class=\"hljs-keyword\">function</span> <span class=\"title function_\">eager</span>(<span class=\"hljs-params\"></span>) {...})(); <span class=\"hljs-comment\">//  Full-Parsing</span></span><br><span class=\"line\">                   </span><br><span class=\"line\"><span class=\"hljs-comment\">// IIFE</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">lazy</span>(<span class=\"hljs-params\"></span>) {...} <span class=\"hljs-comment\">//  Pre-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">lazy</span>(); <span class=\"hljs-comment\">// -&gt; Full-Parsing </span></span><br><span class=\"line\">                 </span><br><span class=\"line\"><span class=\"hljs-comment\">// Full-Parsing</span></span><br><span class=\"line\">!<span class=\"hljs-keyword\">function</span> <span class=\"title function_\">eager2</span>(<span class=\"hljs-params\"></span>) {...}, <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">eager3</span>(<span class=\"hljs-params\"></span>) {...} <span class=\"hljs-comment\">// All eager</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> f1 = <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">lazy</span>(<span class=\"hljs-params\"></span>) { ... }; <span class=\"hljs-comment\">//  Pre-Parsing</span></span><br><span class=\"line\">              </span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> f2 = <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">lazy</span>(<span class=\"hljs-params\"></span>) {...}(); <span class=\"hljs-comment\">// lazy , eager</span></span><br></pre></td></tr></tbody></table></figure>\n\n<br>\n\n<h4 id=\"Q-Full-Parsing-eager-\"><a href=\"#Q-Full-Parsing-eager-\" class=\"headerlink\" title=\"Q:Full-Parsing eager \"></a>Q:Full-Parsing eager </h4><ul>\n<li>lazy 2 lazy  eager !|~</li>\n<li> <a href=\"https://github.com/nolanlawson/optimize-js\">optimize-js</a> Github</li>\n</ul>\n<br>\n\n<h4 id=\"Q-\"><a href=\"#Q-\" class=\"headerlink\" title=\"Q:\"></a>Q:</h4><figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">lazy_outer</span>(<span class=\"hljs-params\"></span>) { <span class=\"hljs-comment\">// lazy parse this</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">inner</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">inner2</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">lazy_outer</span>(); <span class=\"hljs-comment\">// lazy parsing inner &amp; inner2</span></span><br><span class=\"line\"><span class=\"title function_\">inner</span>(); <span class=\"hljs-comment\">// lazy parsing inner &amp; inner2 (3rd time!)</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>Pre-Parsing</code></p>\n<br>\n\n<h4 id=\"Q-Parser\"><a href=\"#Q-Parser\" class=\"headerlink\" title=\"Q:Parser\"></a>Q:Parser</h4><ol>\n<li><strong></strong>DevTools<code>coverage</code></li>\n<li>V8Parser72bundlebundleParser</li>\n</ol>\n<br>\n\n<h4 id=\"Q-ParserCompiler\"><a href=\"#Q-ParserCompiler\" class=\"headerlink\" title=\"Q:ParserCompiler\"></a>Q:ParserCompiler</h4><p>1. <code>chrome://tracing/</code><a href=\"http://aimianwu.com/\"></a></p>\n<p>2.tracing<code>Record</code></p>\n<p>3.<code>Web developer</code>Edit categories<code>v8.runtime_stats</code></p>\n<p>4.Tab <a href=\"http://aimianwu.com/\">http://aimianwu.com</a> tracing Tab</p>\n<p>5.</p>\n<p>6.Process</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time.png\"></p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-1.png\"></p>\n<p>7.V8ParseCompile</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-2.png\"></p>\n<br>\n\n<br>\n\n<h1 id=\"Compiler-Pipeline\"><a href=\"#Compiler-Pipeline\" class=\"headerlink\" title=\"Compiler Pipeline\"></a><strong>Compiler Pipeline</strong></h1><p>V8Compiler PipelineV8 5.9 Ignition + TurboFan 2010Full-codegen + Crankshaft Ignition + TurboFan Full-codegen + CrankshaftTurboFan<a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389\">PPT</a></p>\n<br>\n\n<h4 id=\"Q-\"><a href=\"#Q-\" class=\"headerlink\" title=\"Q:\"></a>Q:<a href=\"https://v8.dev/blog/launching-ignition-and-turbofan\"></a></h4><p>JavaScript</p>\n<ul>\n<li>JavaScriptV81/3Crankshaft</li>\n<li>Crankshaft trycatchfinally  ESWebAssembly<br>PC</li>\n</ul>\n<br>\n\n<h4 id=\"Q--V8-Compiler-\"><a href=\"#Q--V8-Compiler-\" class=\"headerlink\" title=\"Q: V8 Compiler \"></a>Q: V8 Compiler </h4><p>JavaScriptV8TurboFanIgnitionTurboFan<code>Optimize</code>DeoptimizeIgnition</p>\n<p>2<a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\"></a></p>\n<ul>\n<li></li>\n<li>JavaScript</li>\n</ul>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-1.png\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-2.png\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-3.png\"></p>\n<blockquote>\n<p>ObjectsV8De-optimisation</p>\n</blockquote>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">load</span>(<span class=\"hljs-params\">obj</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> obj.<span class=\"hljs-property\">x</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">var</span> obj = {</span><br><span class=\"line\">  <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">1</span>,</span><br><span class=\"line\">  <span class=\"hljs-attr\">y</span>: <span class=\"hljs-number\">4</span></span><br><span class=\"line\">} </span><br></pre></td></tr></tbody></table></figure>\n\n\n\n<p> <code>obj = {}</code>  <code>obj = { x: \"Number\" }</code> <code>obj = { y: \"Number\" }</code> C++Java</p>\n<p></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">load</span>({ <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-number\">7</span> });</span><br><span class=\"line\"><span class=\"title function_\">load</span>({ <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-number\">9</span> });</span><br><span class=\"line\"><span class=\"title function_\">load</span>({ <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-number\">3</span> });</span><br><span class=\"line\"><span class=\"title function_\">load</span>({ <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-number\">1</span> });</span><br></pre></td></tr></tbody></table></figure>\n\n<p></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">load</span>({ <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-number\">7</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-literal\">undefined</span> });</span><br><span class=\"line\"><span class=\"title function_\">load</span>({ <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-number\">9</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-literal\">undefined</span> });</span><br><span class=\"line\"><span class=\"title function_\">load</span>({ <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-literal\">undefined</span> });</span><br><span class=\"line\"><span class=\"title function_\">load</span>({ <span class=\"hljs-attr\">x</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">a</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">c</span>: <span class=\"hljs-literal\">undefined</span>, <span class=\"hljs-attr\">d</span>: <span class=\"hljs-number\">1</span> });</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<p>TypeScript</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><code>V8</code><a href=\"https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html\">Script Streaming</a> <a href=\"https://v8.dev/\">https://v8.dev/</a> JavaScriptV8</p>\n<p>WebAssemblyNode.jsC++JavaScriptArduinoJavaScriptC/C++C/C++</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"https://www.youtube.com/watch?v=Fg7niTmNNLg\">Parsing JavaScript - better lazy than eager</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\">JavaScript engines - how do they even? </a></p>\n<p><a href=\"https://medium.com/reloading/javascript-start-up-performance-69200f43b201\">JavaScript Start-up Performance</a></p>\n<p><a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103\">V8: Hooking up the Ignition to the Turbofan</a></p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<html><head></head><body><blockquote>\n<p><code></code>172020<strong></strong></p>\n</blockquote>\n<p><strong>Parer</strong><strong>Compiler</strong>2V8JavaScript</p>\n<p><img src=\"/images/v8-parser-compiler/v8-pare-compile-cost.png\" alt=\"Parser15-20%\"></p></body></html>","more":"<h1 id=\"Parser\"><a href=\"#Parser\" class=\"headerlink\" title=\"Parser\"></a><strong>Parser</strong></h1><p><img src=\"/images/v8-parser-compiler/parser-phase.png\" alt=\"Parser\"></p>\n<p><strong> <code>1 MB / s</code></strong></p>\n<br/>\n\n<h4 id=\"V8Parser2\"><a href=\"#V8Parser2\" class=\"headerlink\" title=\"V8Parser2\"></a><strong>V8Parser2</strong></h4><p><code>LayzePre-Parsing</code></p>\n<ul>\n<li></li>\n<li><code>AST</code><code>Scopes</code></li>\n<li>Eage2</li>\n<li>JavaScript</li>\n</ul>\n<p><code>EageFull-Parsing</code></p>\n<ul>\n<li></li>\n<li><code>AST</code></li>\n<li><code>Scopes</code></li>\n<li></li>\n</ul>\n<br/>\n\n<h4 id=\"Q-2\"><a href=\"#Q-2\" class=\"headerlink\" title=\"Q:2\"></a>Q:2</h4><p>Full-ParsingDevTools<code>coverage</code></p>\n<br/>\n\n<h4 id=\"Q-2\"><a href=\"#Q-2\" class=\"headerlink\" title=\"Q:2\"></a>Q:2</h4><p>Pre-ParsingFull-Parser: <code>0.5 * parse + 1 * parse = 1.5 parse</code> </p>\n<br/>\n\n<h4 id=\"Q--Pre-Parsing--Full-Parsing-\"><a href=\"#Q--Pre-Parsing--Full-Parsing-\" class=\"headerlink\" title=\"Q: Pre-Parsing  Full-Parsing \"></a>Q: <code>Pre-Parsing</code>  <code>Full-Parsing</code> </h4><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> a = <span class=\"number\">0</span>; <span class=\"comment\">// Top-Level  Full-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//  IIFE = Immediately Invoked Function Expression</span></span><br><span class=\"line\">(<span class=\"keyword\">function</span> <span class=\"title function_\">eager</span>(<span class=\"params\"></span>) &#123;...&#125;)(); <span class=\"comment\">//  Full-Parsing</span></span><br><span class=\"line\">                   </span><br><span class=\"line\"><span class=\"comment\">// IIFE</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">lazy</span>(<span class=\"params\"></span>) &#123;...&#125; <span class=\"comment\">//  Pre-Parsing</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">lazy</span>(); <span class=\"comment\">// -&gt; Full-Parsing </span></span><br><span class=\"line\">                 </span><br><span class=\"line\"><span class=\"comment\">// Full-Parsing</span></span><br><span class=\"line\">!<span class=\"keyword\">function</span> <span class=\"title function_\">eager2</span>(<span class=\"params\"></span>) &#123;...&#125;, <span class=\"keyword\">function</span> <span class=\"title function_\">eager3</span>(<span class=\"params\"></span>) &#123;...&#125; <span class=\"comment\">// All eager</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">let</span> f1 = <span class=\"keyword\">function</span> <span class=\"title function_\">lazy</span>(<span class=\"params\"></span>) &#123; ... &#125;; <span class=\"comment\">//  Pre-Parsing</span></span><br><span class=\"line\">              </span><br><span class=\"line\"><span class=\"keyword\">let</span> f2 = <span class=\"keyword\">function</span> <span class=\"title function_\">lazy</span>(<span class=\"params\"></span>) &#123;...&#125;(); <span class=\"comment\">// lazy , eager</span></span><br></pre></td></tr></table></figure>\n\n<br/>\n\n<h4 id=\"Q-Full-Parsing-eager-\"><a href=\"#Q-Full-Parsing-eager-\" class=\"headerlink\" title=\"Q:Full-Parsing eager \"></a>Q:Full-Parsing eager </h4><ul>\n<li>lazy 2 lazy  eager !|~</li>\n<li> <a href=\"https://github.com/nolanlawson/optimize-js\">optimize-js</a> Github</li>\n</ul>\n<br/>\n\n<h4 id=\"Q-\"><a href=\"#Q-\" class=\"headerlink\" title=\"Q:\"></a>Q:</h4><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">lazy_outer</span>(<span class=\"params\"></span>) &#123; <span class=\"comment\">// lazy parse this</span></span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">inner</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">inner2</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">lazy_outer</span>(); <span class=\"comment\">// lazy parsing inner &amp; inner2</span></span><br><span class=\"line\"><span class=\"title function_\">inner</span>(); <span class=\"comment\">// lazy parsing inner &amp; inner2 (3rd time!)</span></span><br></pre></td></tr></table></figure>\n\n<p><code>Pre-Parsing</code></p>\n<br/>\n\n<h4 id=\"Q-Parser\"><a href=\"#Q-Parser\" class=\"headerlink\" title=\"Q:Parser\"></a>Q:Parser</h4><ol>\n<li><strong></strong>DevTools<code>coverage</code></li>\n<li>V8Parser72bundlebundleParser</li>\n</ol>\n<br/>\n\n<h4 id=\"Q-ParserCompiler\"><a href=\"#Q-ParserCompiler\" class=\"headerlink\" title=\"Q:ParserCompiler\"></a>Q:ParserCompiler</h4><p>1. <code>chrome://tracing/</code><a href=\"http://aimianwu.com/\"></a></p>\n<p>2.tracing<code>Record</code></p>\n<p>3.<code>Web developer</code>Edit categories<code>v8.runtime_stats</code></p>\n<p>4.Tab <a href=\"http://aimianwu.com/\">http://aimianwu.com</a> tracing Tab</p>\n<p>5.</p>\n<p>6.Process</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time.png\"></p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-1.png\"></p>\n<p>7.V8ParseCompile</p>\n<p><img src=\"/images/v8-parser-compiler/parse-time-2.png\"></p>\n<br/>\n\n<br/>\n\n<h1 id=\"Compiler-Pipeline\"><a href=\"#Compiler-Pipeline\" class=\"headerlink\" title=\"Compiler Pipeline\"></a><strong>Compiler Pipeline</strong></h1><p>V8Compiler PipelineV8 5.9 Ignition + TurboFan 2010Full-codegen + Crankshaft Ignition + TurboFan Full-codegen + CrankshaftTurboFan<a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_389\">PPT</a></p>\n<br/>\n\n<h4 id=\"Q-\"><a href=\"#Q-\" class=\"headerlink\" title=\"Q:\"></a>Q:<a href=\"https://v8.dev/blog/launching-ignition-and-turbofan\"></a></h4><p>JavaScript</p>\n<ul>\n<li>JavaScriptV81&#x2F;3Crankshaft</li>\n<li>Crankshaft trycatchfinally  ESWebAssembly<br>PC</li>\n</ul>\n<br/>\n\n<h4 id=\"Q--V8-Compiler-\"><a href=\"#Q--V8-Compiler-\" class=\"headerlink\" title=\"Q: V8 Compiler \"></a>Q: V8 Compiler </h4><p>JavaScriptV8TurboFanIgnitionTurboFan<code>Optimize</code>DeoptimizeIgnition</p>\n<p>2<a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\"></a></p>\n<ul>\n<li></li>\n<li>JavaScript</li>\n</ul>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-1.png\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-2.png\"></p>\n<p><img src=\"/images/v8-parser-compiler/not-change-types-3.png\"></p>\n<blockquote>\n<p>ObjectsV8De-optimisation</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">load</span>(<span class=\"params\">obj</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> obj.<span class=\"property\">x</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> obj = &#123;</span><br><span class=\"line\">  <span class=\"attr\">x</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">  <span class=\"attr\">y</span>: <span class=\"number\">4</span></span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n\n\n\n<p> <code>obj = &#123;&#125;</code>  <code>obj = &#123; x: &quot;Number&quot; &#125;</code> <code>obj = &#123; y: &quot;Number&quot; &#125;</code> C++Java</p>\n<p></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">load</span>(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"number\">7</span> &#125;);</span><br><span class=\"line\"><span class=\"title function_\">load</span>(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">9</span> &#125;);</span><br><span class=\"line\"><span class=\"title function_\">load</span>(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">c</span>: <span class=\"number\">3</span> &#125;);</span><br><span class=\"line\"><span class=\"title function_\">load</span>(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">d</span>: <span class=\"number\">1</span> &#125;);</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">load</span>(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"number\">7</span>, <span class=\"attr\">b</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">c</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">d</span>: <span class=\"literal\">undefined</span> &#125;);</span><br><span class=\"line\"><span class=\"title function_\">load</span>(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">b</span>: <span class=\"number\">9</span>, <span class=\"attr\">c</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">d</span>: <span class=\"literal\">undefined</span> &#125;);</span><br><span class=\"line\"><span class=\"title function_\">load</span>(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">b</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">c</span>: <span class=\"number\">3</span>, <span class=\"attr\">d</span>: <span class=\"literal\">undefined</span> &#125;);</span><br><span class=\"line\"><span class=\"title function_\">load</span>(&#123; <span class=\"attr\">x</span>: <span class=\"number\">4</span>, <span class=\"attr\">a</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">b</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">c</span>: <span class=\"literal\">undefined</span>, <span class=\"attr\">d</span>: <span class=\"number\">1</span> &#125;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>TypeScript</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><code>V8</code><a href=\"https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html\">Script Streaming</a> <a href=\"https://v8.dev/\">https://v8.dev/</a> JavaScriptV8</p>\n<p>WebAssemblyNode.jsC++JavaScriptArduinoJavaScriptC&#x2F;C++C&#x2F;C++</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"https://www.youtube.com/watch?v=Fg7niTmNNLg\">Parsing JavaScript - better lazy than eager</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=p-iiEDtpy6I\">JavaScript engines - how do they even? </a></p>\n<p><a href=\"https://medium.com/reloading/javascript-start-up-performance-69200f43b201\">JavaScript Start-up Performance</a></p>\n<p><a href=\"https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g1ba5e472dd_0_103\">V8: Hooking up the Ignition to the Turbofan</a></p>"},{"title":"libuv & Node.js EventLoop ","keywords":"libuv,EventLoop,V8","description":"libuvNode.js EventLoopsetTimeout `nextTick`","date":"2020-02-29T21:39:36.647Z","_content":"\n[libuv](https://libuv.org/)EventLoop\n\n- `libuv``V8`\n- JavaScriptC/C++\n\n\n\n****\n\n```c++\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n20102020\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n### libuv & EventLoop\n\n![_images/loop_iteration.png](/images/v8-libuv-timer-event-loop/loop_iteration.png)\n\n`libuv`[The I/O loop](http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop)\n\n![image-20200301145547994](/images/v8-libuv-timer-event-loop/image-20200301145547994.png)\n\n[Event Loop Explained](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained)`pending callbacks``I/O callbacks`\n\n> Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point.  libuv\n\n**libuv**`pending callbacks`I/O callbackspollingpending callbacks\n\n<br/>\n\n> This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives `ECONNREFUSED` when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the **pending callbacks** phase.  Node.js\n\n**Node.js**`pending callbacks`callbacksTCP\n\n`pending callbacks`libuvI/ONode.jsI/OI/O `poll`\n\n<br/>\n\n<br/>\n\n## libuv\n\n```c\nint uv_run(uv_loop_t* loop, uv_run_mode mode) { //  mode  UV_RUN_DEFAULT\n  int timeout;\n  int r;\n  int ran_pending;\n\n  // alive\n  r = uv__loop_alive(loop);\n  if (!r)\n    uv__update_time(loop); // libuv\n\n  while (r != 0 && loop->stop_flag == 0) {\n    uv__update_time(loop); // libuv Update loop time\n    uv__run_timers(loop); //  timers \n    ran_pending = uv__run_pending(loop); // pending 01\n    uv__run_idle(loop); // idle  Node.js\n    uv__run_prepare(loop); // prepare  Node.js\n\n    timeout = 0; //  poll \n    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)\n      timeout = uv_backend_timeout(loop); //  poll \n    // timers diff = loop.time - min.timeout\n    //  diff >= 0 , timeout = 0\n    //  timeout = min(diff, INT_MAX)\n    \n    uv__io_poll(loop, timeout); //  poll \n    uv__run_check(loop); //  check \n    uv__run_closing_handles(loop); //  close \n\n    // mode  UV_RUN_DEFAULT \n    if (mode == UV_RUN_ONCE) {\n      uv__update_time(loop);\n      uv__run_timers(loop);\n    }\n\n    // alive\n    r = uv__loop_alive(loop);\n    if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)\n      break;\n  }\n\n  /* The if statement lets gcc compile it to a conditional store. Avoids\n   * dirtying a cache line.\n   */\n  if (loop->stop_flag != 0)\n    loop->stop_flag = 0;\n\n  return r;\n}\n```\n\n`uv_run`\n\n<br/>\n\n```c\nvoid uv__run_timers(uv_loop_t* loop) {\n  struct heap_node* heap_node; // timers \n  uv_timer_t* handle;\n\n  for (;;) {\n    heap_node = heap_min(timer_heap(loop)); // \n    if (heap_node == NULL) // \n      break;\n\n    handle = container_of(heap_node, uv_timer_t, heap_node); \n    if (handle->timeout > loop->time) // \n      break;\n\n    uv_timer_stop(handle);\n    uv_timer_again(handle);\n    \n    handle->timer_cb(handle); // \n  }\n}\n```\n\ntimers`loop->time`**`handle->timer_cb`JavaScriptsetTimeout**\n\n<br/>\n\n```c\nstatic int uv__run_pending(uv_loop_t* loop) {\n  QUEUE* q;\n  QUEUE pq;\n  uv__io_t* w;\n\n  if (QUEUE_EMPTY(&loop->pending_queue))\n    return 0;\n\n  QUEUE_MOVE(&loop->pending_queue, &pq);\n\n  while (!QUEUE_EMPTY(&pq)) { // \n    q = QUEUE_HEAD(&pq);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n    w = QUEUE_DATA(q, uv__io_t, pending_queue);\n    w->cb(loop, w, POLLOUT); // \n  }\n\n  return 1;\n}\n```\n\nlibuv\n\n<br/>\n\n```c\n#define UV_LOOP_WATCHER_DEFINE(name, type)                                    \\\n\tvoid uv__run_##name(uv_loop_t* loop) {                                      \\\n    uv_##name##_t* h;                                                         \\\n    QUEUE queue;                                                              \\\n    QUEUE* q;                                                                 \\\n    QUEUE_MOVE(&loop->name##_handles, &queue);                                \\\n    while (!QUEUE_EMPTY(&queue)) {                                            \\\n      q = QUEUE_HEAD(&queue);                                                 \\\n      h = QUEUE_DATA(q, uv_##name##_t, queue);                                \\\n      QUEUE_REMOVE(q);                                                        \\\n      QUEUE_INSERT_TAIL(&loop->name##_handles, q);                            \\\n      h->name##_cb(h);                                                        \\\n    }                                                                         \\\n  }     \n\nUV_LOOP_WATCHER_DEFINE(prepare, PREPARE)\nUV_LOOP_WATCHER_DEFINE(check, CHECK)\nUV_LOOP_WATCHER_DEFINE(idle, IDLE)\n```\n\n`UV_LOOP_WATCHER_DEFINE``prepare``check``idle`3\n\n<br/>\n\n```c\n// uv__io_poll \nvoid uv__io_poll(uv_loop_t* loop, int timeout) {\n  // ...\n  if (loop->nfds == 0) { //  \n    assert(QUEUE_EMPTY(&loop->watcher_queue));\n    return;\n  }\n\n  // loop->watcher_queueepoll\n  while (!QUEUE_EMPTY(&loop->watcher_queue)) {\n    q = QUEUE_HEAD(&loop->watcher_queue);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n\n    w = QUEUE_DATA(q, uv__io_t, watcher_queue);\n    // ...\n    if (w->events == 0)\n      op = EPOLL_CTL_ADD; // \n    else\n      op = EPOLL_CTL_MOD; // \n\n    epoll_ctl(loop->backend_fd, op, w->fd, &e) // epoll_ctl \n\n    w->events = w->pevents;\n  }\n\n  sigmask = 0;\n  if (loop->flags & UV_LOOP_BLOCK_SIGPROF) {\n    sigemptyset(&sigset);\n    sigaddset(&sigset, SIGPROF);\n    sigmask |= 1 << (SIGPROF - 1);\n  }\n\n  base = loop->time;\n  real_timeout = timeout;\n\n  for (;;) {\n    nfds = epoll_wait(loop->backend_fd,\n                        events,\n                        ARRAY_SIZE(events),\n                        timeout);\n    \n    if (nfds == 0) { // \n      assert(timeout != -1); // -1 nfds0\n      if (timeout == 0) // \n        return;\n      \n      goto update_timeout; //   epoll_wait \n    }\n\n    if (nfds == -1) { // \n      if (errno == ENOSYS) {\n        /* epoll_wait() or epoll_pwait() failed, try the other system call. */\n        assert(no_epoll_wait == 0 || no_epoll_pwait == 0);\n        continue;\n      }\n\n      if (errno != EINTR)\n        abort();\n\n      if (timeout == -1)\n        continue;\n\n      if (timeout == 0)\n        return;\n\n      goto update_timeout;\n    }\n\n    have_signals = 0;\n    nevents = 0;\n\n    loop->watchers[loop->nwatchers] = (void*) events;\n    loop->watchers[loop->nwatchers + 1] = (void*) (uintptr_t) nfds;\n    for (i = 0; i < nfds; i++) {\n      pe = events + i;\n      fd = pe->data.fd;\n      w = loop->watchers[fd];\n      w->cb(loop, w, pe->events); // forIO\n    }\n\n    if (timeout == 0)\n      return;\n\n    if (timeout == -1)\n      continue;\n\nupdate_timeout:\n    assert(timeout > 0);\n\n    real_timeout -= (loop->time - base);\n    if (real_timeout <= 0)\n      return;\n\n    timeout = real_timeout;\n  }\n}\n```\n\n`uv__io_poll`timeout`timers``epoll`IO`select``poll``epoll`\n\n> epoll[Linux](https://baike.baidu.com/item/Linux)[](https://baike.baidu.com/item//9809582)pollLinuxIOselect/poll[](https://baike.baidu.com/item//3763280)[CPU](https://baike.baidu.com/item/CPU/120556)IOReadyepollselect/pollIOLevel TriggeredEdge TriggeredIOepoll_wait/epoll_pwait \n\nlibuvepoll\n\n- epollselect/poll\n- epollselect/pollselect/pollNode.jslibuv\n\n<br/>\n\n```c\nstatic void uv__run_closing_handles(uv_loop_t* loop) {\n  uv_handle_t* p;\n  uv_handle_t* q;\n\n  p = loop->closing_handles;\n  loop->closing_handles = NULL;\n\n  while (p) {\n    q = p->next_closing;\n    uv__finish_close(p);\n    p = q;\n  }\n}\n```\n\n`close`\n\n<br/>\n\nlibuv`poll`\n\n<br/>\n\n<br/>\n\n\n\n## Node.js setTimeout\n\n**`handle->timer_cb`JavaScriptsetTimeout**\n\nNode.js`setTimemout`\n\n```javascript\nfunction setTimeout(callback, after, arg1, arg2, arg3) {\n  var args = [arg1, arg2, arg3]; // \n  const timeout = new Timeout(callback, after, args, false);\n  active(timeout);\n\n  return timeout;\n}\nfunction Timeout(callback, after, args, isRepeat) {\n  // \n  after *= 1; \n  if (!(after >= 1 && after <= TIMEOUT_MAX)) {\n    after = 1; //  1 \n  }\n  this._idleTimeout = after;\n  this._onTimeout = callback;\n  this._timerArgs = args;\n}\nfunction active(item) {\n  insert(item, true, getLibuvNow());  // getLibuvNow  loop->time\n}\nfunction insert(item, refed, start) {\n  let msecs = item._idleTimeout;\n  if (msecs < 0 || msecs === undefined)\n    return;\n\n  // Truncate so that accuracy of sub-millisecond timers is not assumed.\n  msecs = Math.trunc(msecs);\n\n  item._idleStart = start;\n\n  // Use an existing list if there is one, otherwise we need to make a new one.\n  // timerListMap key value TimersList\n  var list = timerListMap[msecs];\n  if (list === undefined) {\n    const expiry = start + msecs; // \n    timerListMap[msecs] = list = new TimersList(expiry, msecs); // \n    timerListQueue.insert(list); // timerListQueue \n\n    if (nextExpiry > expiry) {\n      scheduleTimer(msecs); //  V8 scheduleTimer\n      nextExpiry = expiry;\n    }\n  }\n  // ... \n  L.append(list, item); // setTimeoutTimeoutlist\n}\n```\n\nJavaScripttimerssetTimeoutV8V8`scheduleTimer(msecs);`V8\n\n```c\n// timers.cc\nvoid ScheduleTimer(const FunctionCallbackInfo<Value>& args) {\n  auto env = Environment::GetCurrent(args);\n  env->ScheduleTimer(args[0]->IntegerValue(env->context()).FromJust());\n}\n// env.cc\nvoid Environment::ScheduleTimer(int64_t duration_ms) {\n  if (started_cleanup_) return;\n  uv_timer_start(timer_handle(), RunTimers, duration_ms, 0);\n}\nvoid Environment::RunTimers(uv_timer_t* handle) {\n  Environment* env = Environment::from_timer_handle(handle);\n  \n  // timers_callback_function \n  Local<Function> cb = env->timers_callback_function();\n  do {\n    ret = cb->Call(env->context(), process, 1, &arg);\n  } while (ret.IsEmpty() && env->can_call_into_js());\n}\n// uv/timer.c\nint uv_timer_start(uv_timer_t* handle,\n                   uv_timer_cb cb,\n                   uint64_t timeout,\n                   uint64_t repeat) {\n  // uv_timer_t\n  // JavaScriptC++RunTimers\n  handle->timer_cb = cb;\n  handle->timeout = clamped_timeout;\n  handle->repeat = repeat;\n  handle->start_id = handle->loop->timer_counter++;\n\n  // uv_timer_ttimer_heap\n  heap_insert(timer_heap(handle->loop),\n              (struct heap_node*) &handle->heap_node,\n              timer_less_than);\n  uv__handle_start(handle);\n\n  return 0;\n}\n\n```\n\n**V8timersC++**`timers_callback_function`\n\n```c++\n// timers.cc\nvoid SetupTimers(const FunctionCallbackInfo<Value>& args) {\n  CHECK(args[0]->IsFunction());\n  CHECK(args[1]->IsFunction());\n  auto env = Environment::GetCurrent(args);\n\n  env->set_immediate_callback_function(args[0].As<Function>()); // immediate\n  env->set_timers_callback_function(args[1].As<Function>()); // timers\n}\n```\n\n```javascript\n// node.js\nconst {\n  setupTaskQueue,\n  queueMicrotask\n} = require('internal/process/task_queues');\nconst { nextTick, runNextTicks } = setupTaskQueue();\nprocess.nextTick = nextTick;\nprocess._tickCallback = runNextTicks;\n\nconst { getTimerCallbacks } = require('internal/timers');\nconst { setupTimers } = internalBinding('timers'); // c++ SetupTimers JavaScript\nconst { processImmediate, processTimers } = getTimerCallbacks(runNextTicks);\nsetupTimers(processImmediate, processTimers);\n```\n\n`node.js``processImmediate``processTimers`JavaScriptC++`timers_callback_function``processTimers`\n\n```getTimerCallbacks`\n\n```javascript\nfunction getTimerCallbacks(runNextTicks) {\n  function processImmediate() {\n    // \n  }\n\n\n  function processTimers(now) {\n    nextExpiry = Infinity;\n\n    let list;\n    let ranAtLeastOneList = false;\n    while (list = timerListQueue.peek()) {\n      if (list.expiry > now) { // now(libuv loop->time), \n        nextExpiry = list.expiry; // nextExpiry  \n        return refCount > 0 ? nextExpiry : -nextExpiry;\n      }\n      if (ranAtLeastOneList)\n        runNextTicks(); // \n      else\n        ranAtLeastOneList = true;\n      listOnTimeout(list, now);\n    }\n    return 0;\n  }\n\n  function listOnTimeout(list, now) {\n    const msecs = list.msecs;\n\n    debug('timeout callback %d', msecs);\n\n    var diff, timer;\n    let ranAtLeastOneTimer = false;\n    while (timer = L.peek(list)) { // list\n      // _idleStart libuv (loop->time)\n      // now libuv callback\n      diff = now - timer._idleStart; \n\n      // Check if this loop iteration is too early for the next timer.\n      // This happens if there are more timers scheduled for later in the list.\n      if (diff < msecs) {\n        list.expiry = Math.max(timer._idleStart + msecs, now + 1);\n        list.id = timerListId++;\n        timerListQueue.percolateDown(1);\n        debug('%d list wait because diff is %d', msecs, diff);\n        return;\n      }\n\n      if (ranAtLeastOneTimer)\n        runNextTicks(); // \n      else\n        ranAtLeastOneTimer = true;\n\n      // The actual logic for when a timeout happens.\n      L.remove(timer);\n\n      const asyncId = timer[async_id_symbol];\n      if (!timer._onTimeout) {\n        continue;\n      }\n      try {\n        const args = timer._timerArgs;\n        if (args === undefined)\n          timer._onTimeout(); // _onTimeout setTimeout \n        else\n          timer._onTimeout(...args);\n      } finally {\n        // ...\n      }\n    }\n    if (list === timerListMap[msecs]) {\n      delete timerListMap[msecs];\n      timerListQueue.shift();\n    }\n  }\n\n  return {\n    processImmediate,\n    processTimers\n  };\n}\n```\n\n`libuv``runNextTicks`**setTimeoutcallback``timerNode.js 11**\n\n> Timers\n> Interval timers will be rescheduled even if previous interval threw an error. #20002\n> **nextTick queue will be run after each immediate and timer. [#22842](https://github.com/nodejs/node/pull/22842)**\n\n11\n\n```javascript\nsetTimeout(() => {\n  console.log('time1');\n  Promise.resolve().then(() => {\n    console.log('promise1');\n  });\n});\n\nsetTimeout(() => {\n  console.log('time2');\n  Promise.resolve().then(() => {\n    console.log('promise2');\n  });\n});\n\n/* 11\ntime1\npromise1\ntime2\npromise2\n*/\n\n/* 11\ntime1\ntime2\npromise1\npromise2\n*/\n\n```\n\n\n\n<br/>\n\n<br/>\n\n## \n\nlibuvNode.js EventLoop```setTimeout` `nextTick`","source":"_posts/v8-libuv-timer-event-loop.md","raw":"---\ntitle: libuv & Node.js EventLoop \ncategory: JavaScript\nkeywords: libuv,EventLoop,V8\ndescription: libuvNode.js EventLoopsetTimeout `nextTick`\ntags:\n  - Node.js\n  - JavaScript\ndate: 2020-03-01T05:39:36.647Z\n---\n\n[libuv](https://libuv.org/)EventLoop\n\n- `libuv``V8`\n- JavaScriptC/C++\n\n\n\n****\n\n```c++\n// libuv\n#define UV_VERSION_MAJOR 1\n#define UV_VERSION_MINOR 33\n#define UV_VERSION_PATCH 1\n\n// V8\n#define V8_MAJOR_VERSION 7\n#define V8_MINOR_VERSION 8\n#define V8_BUILD_NUMBER 279\n#define V8_PATCH_LEVEL 17\n\n// Node.js\n#define NODE_MAJOR_VERSION 14\n#define NODE_MINOR_VERSION 0\n#define NODE_PATCH_VERSION 0\n```\n\n20102020\n\n<!-- more -->\n\n<br/>\n\n<br/>\n\n### libuv & EventLoop\n\n![_images/loop_iteration.png](/images/v8-libuv-timer-event-loop/loop_iteration.png)\n\n`libuv`[The I/O loop](http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop)\n\n![image-20200301145547994](/images/v8-libuv-timer-event-loop/image-20200301145547994.png)\n\n[Event Loop Explained](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained)`pending callbacks``I/O callbacks`\n\n> Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point.  libuv\n\n**libuv**`pending callbacks`I/O callbackspollingpending callbacks\n\n<br/>\n\n> This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives `ECONNREFUSED` when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the **pending callbacks** phase.  Node.js\n\n**Node.js**`pending callbacks`callbacksTCP\n\n`pending callbacks`libuvI/ONode.jsI/OI/O `poll`\n\n<br/>\n\n<br/>\n\n## libuv\n\n```c\nint uv_run(uv_loop_t* loop, uv_run_mode mode) { //  mode  UV_RUN_DEFAULT\n  int timeout;\n  int r;\n  int ran_pending;\n\n  // alive\n  r = uv__loop_alive(loop);\n  if (!r)\n    uv__update_time(loop); // libuv\n\n  while (r != 0 && loop->stop_flag == 0) {\n    uv__update_time(loop); // libuv Update loop time\n    uv__run_timers(loop); //  timers \n    ran_pending = uv__run_pending(loop); // pending 01\n    uv__run_idle(loop); // idle  Node.js\n    uv__run_prepare(loop); // prepare  Node.js\n\n    timeout = 0; //  poll \n    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)\n      timeout = uv_backend_timeout(loop); //  poll \n    // timers diff = loop.time - min.timeout\n    //  diff >= 0 , timeout = 0\n    //  timeout = min(diff, INT_MAX)\n    \n    uv__io_poll(loop, timeout); //  poll \n    uv__run_check(loop); //  check \n    uv__run_closing_handles(loop); //  close \n\n    // mode  UV_RUN_DEFAULT \n    if (mode == UV_RUN_ONCE) {\n      uv__update_time(loop);\n      uv__run_timers(loop);\n    }\n\n    // alive\n    r = uv__loop_alive(loop);\n    if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)\n      break;\n  }\n\n  /* The if statement lets gcc compile it to a conditional store. Avoids\n   * dirtying a cache line.\n   */\n  if (loop->stop_flag != 0)\n    loop->stop_flag = 0;\n\n  return r;\n}\n```\n\n`uv_run`\n\n<br/>\n\n```c\nvoid uv__run_timers(uv_loop_t* loop) {\n  struct heap_node* heap_node; // timers \n  uv_timer_t* handle;\n\n  for (;;) {\n    heap_node = heap_min(timer_heap(loop)); // \n    if (heap_node == NULL) // \n      break;\n\n    handle = container_of(heap_node, uv_timer_t, heap_node); \n    if (handle->timeout > loop->time) // \n      break;\n\n    uv_timer_stop(handle);\n    uv_timer_again(handle);\n    \n    handle->timer_cb(handle); // \n  }\n}\n```\n\ntimers`loop->time`**`handle->timer_cb`JavaScriptsetTimeout**\n\n<br/>\n\n```c\nstatic int uv__run_pending(uv_loop_t* loop) {\n  QUEUE* q;\n  QUEUE pq;\n  uv__io_t* w;\n\n  if (QUEUE_EMPTY(&loop->pending_queue))\n    return 0;\n\n  QUEUE_MOVE(&loop->pending_queue, &pq);\n\n  while (!QUEUE_EMPTY(&pq)) { // \n    q = QUEUE_HEAD(&pq);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n    w = QUEUE_DATA(q, uv__io_t, pending_queue);\n    w->cb(loop, w, POLLOUT); // \n  }\n\n  return 1;\n}\n```\n\nlibuv\n\n<br/>\n\n```c\n#define UV_LOOP_WATCHER_DEFINE(name, type)                                    \\\n\tvoid uv__run_##name(uv_loop_t* loop) {                                      \\\n    uv_##name##_t* h;                                                         \\\n    QUEUE queue;                                                              \\\n    QUEUE* q;                                                                 \\\n    QUEUE_MOVE(&loop->name##_handles, &queue);                                \\\n    while (!QUEUE_EMPTY(&queue)) {                                            \\\n      q = QUEUE_HEAD(&queue);                                                 \\\n      h = QUEUE_DATA(q, uv_##name##_t, queue);                                \\\n      QUEUE_REMOVE(q);                                                        \\\n      QUEUE_INSERT_TAIL(&loop->name##_handles, q);                            \\\n      h->name##_cb(h);                                                        \\\n    }                                                                         \\\n  }     \n\nUV_LOOP_WATCHER_DEFINE(prepare, PREPARE)\nUV_LOOP_WATCHER_DEFINE(check, CHECK)\nUV_LOOP_WATCHER_DEFINE(idle, IDLE)\n```\n\n`UV_LOOP_WATCHER_DEFINE``prepare``check``idle`3\n\n<br/>\n\n```c\n// uv__io_poll \nvoid uv__io_poll(uv_loop_t* loop, int timeout) {\n  // ...\n  if (loop->nfds == 0) { //  \n    assert(QUEUE_EMPTY(&loop->watcher_queue));\n    return;\n  }\n\n  // loop->watcher_queueepoll\n  while (!QUEUE_EMPTY(&loop->watcher_queue)) {\n    q = QUEUE_HEAD(&loop->watcher_queue);\n    QUEUE_REMOVE(q);\n    QUEUE_INIT(q);\n\n    w = QUEUE_DATA(q, uv__io_t, watcher_queue);\n    // ...\n    if (w->events == 0)\n      op = EPOLL_CTL_ADD; // \n    else\n      op = EPOLL_CTL_MOD; // \n\n    epoll_ctl(loop->backend_fd, op, w->fd, &e) // epoll_ctl \n\n    w->events = w->pevents;\n  }\n\n  sigmask = 0;\n  if (loop->flags & UV_LOOP_BLOCK_SIGPROF) {\n    sigemptyset(&sigset);\n    sigaddset(&sigset, SIGPROF);\n    sigmask |= 1 << (SIGPROF - 1);\n  }\n\n  base = loop->time;\n  real_timeout = timeout;\n\n  for (;;) {\n    nfds = epoll_wait(loop->backend_fd,\n                        events,\n                        ARRAY_SIZE(events),\n                        timeout);\n    \n    if (nfds == 0) { // \n      assert(timeout != -1); // -1 nfds0\n      if (timeout == 0) // \n        return;\n      \n      goto update_timeout; //   epoll_wait \n    }\n\n    if (nfds == -1) { // \n      if (errno == ENOSYS) {\n        /* epoll_wait() or epoll_pwait() failed, try the other system call. */\n        assert(no_epoll_wait == 0 || no_epoll_pwait == 0);\n        continue;\n      }\n\n      if (errno != EINTR)\n        abort();\n\n      if (timeout == -1)\n        continue;\n\n      if (timeout == 0)\n        return;\n\n      goto update_timeout;\n    }\n\n    have_signals = 0;\n    nevents = 0;\n\n    loop->watchers[loop->nwatchers] = (void*) events;\n    loop->watchers[loop->nwatchers + 1] = (void*) (uintptr_t) nfds;\n    for (i = 0; i < nfds; i++) {\n      pe = events + i;\n      fd = pe->data.fd;\n      w = loop->watchers[fd];\n      w->cb(loop, w, pe->events); // forIO\n    }\n\n    if (timeout == 0)\n      return;\n\n    if (timeout == -1)\n      continue;\n\nupdate_timeout:\n    assert(timeout > 0);\n\n    real_timeout -= (loop->time - base);\n    if (real_timeout <= 0)\n      return;\n\n    timeout = real_timeout;\n  }\n}\n```\n\n`uv__io_poll`timeout`timers``epoll`IO`select``poll``epoll`\n\n> epoll[Linux](https://baike.baidu.com/item/Linux)[](https://baike.baidu.com/item//9809582)pollLinuxIOselect/poll[](https://baike.baidu.com/item//3763280)[CPU](https://baike.baidu.com/item/CPU/120556)IOReadyepollselect/pollIOLevel TriggeredEdge TriggeredIOepoll_wait/epoll_pwait \n\nlibuvepoll\n\n- epollselect/poll\n- epollselect/pollselect/pollNode.jslibuv\n\n<br/>\n\n```c\nstatic void uv__run_closing_handles(uv_loop_t* loop) {\n  uv_handle_t* p;\n  uv_handle_t* q;\n\n  p = loop->closing_handles;\n  loop->closing_handles = NULL;\n\n  while (p) {\n    q = p->next_closing;\n    uv__finish_close(p);\n    p = q;\n  }\n}\n```\n\n`close`\n\n<br/>\n\nlibuv`poll`\n\n<br/>\n\n<br/>\n\n\n\n## Node.js setTimeout\n\n**`handle->timer_cb`JavaScriptsetTimeout**\n\nNode.js`setTimemout`\n\n```javascript\nfunction setTimeout(callback, after, arg1, arg2, arg3) {\n  var args = [arg1, arg2, arg3]; // \n  const timeout = new Timeout(callback, after, args, false);\n  active(timeout);\n\n  return timeout;\n}\nfunction Timeout(callback, after, args, isRepeat) {\n  // \n  after *= 1; \n  if (!(after >= 1 && after <= TIMEOUT_MAX)) {\n    after = 1; //  1 \n  }\n  this._idleTimeout = after;\n  this._onTimeout = callback;\n  this._timerArgs = args;\n}\nfunction active(item) {\n  insert(item, true, getLibuvNow());  // getLibuvNow  loop->time\n}\nfunction insert(item, refed, start) {\n  let msecs = item._idleTimeout;\n  if (msecs < 0 || msecs === undefined)\n    return;\n\n  // Truncate so that accuracy of sub-millisecond timers is not assumed.\n  msecs = Math.trunc(msecs);\n\n  item._idleStart = start;\n\n  // Use an existing list if there is one, otherwise we need to make a new one.\n  // timerListMap key value TimersList\n  var list = timerListMap[msecs];\n  if (list === undefined) {\n    const expiry = start + msecs; // \n    timerListMap[msecs] = list = new TimersList(expiry, msecs); // \n    timerListQueue.insert(list); // timerListQueue \n\n    if (nextExpiry > expiry) {\n      scheduleTimer(msecs); //  V8 scheduleTimer\n      nextExpiry = expiry;\n    }\n  }\n  // ... \n  L.append(list, item); // setTimeoutTimeoutlist\n}\n```\n\nJavaScripttimerssetTimeoutV8V8`scheduleTimer(msecs);`V8\n\n```c\n// timers.cc\nvoid ScheduleTimer(const FunctionCallbackInfo<Value>& args) {\n  auto env = Environment::GetCurrent(args);\n  env->ScheduleTimer(args[0]->IntegerValue(env->context()).FromJust());\n}\n// env.cc\nvoid Environment::ScheduleTimer(int64_t duration_ms) {\n  if (started_cleanup_) return;\n  uv_timer_start(timer_handle(), RunTimers, duration_ms, 0);\n}\nvoid Environment::RunTimers(uv_timer_t* handle) {\n  Environment* env = Environment::from_timer_handle(handle);\n  \n  // timers_callback_function \n  Local<Function> cb = env->timers_callback_function();\n  do {\n    ret = cb->Call(env->context(), process, 1, &arg);\n  } while (ret.IsEmpty() && env->can_call_into_js());\n}\n// uv/timer.c\nint uv_timer_start(uv_timer_t* handle,\n                   uv_timer_cb cb,\n                   uint64_t timeout,\n                   uint64_t repeat) {\n  // uv_timer_t\n  // JavaScriptC++RunTimers\n  handle->timer_cb = cb;\n  handle->timeout = clamped_timeout;\n  handle->repeat = repeat;\n  handle->start_id = handle->loop->timer_counter++;\n\n  // uv_timer_ttimer_heap\n  heap_insert(timer_heap(handle->loop),\n              (struct heap_node*) &handle->heap_node,\n              timer_less_than);\n  uv__handle_start(handle);\n\n  return 0;\n}\n\n```\n\n**V8timersC++**`timers_callback_function`\n\n```c++\n// timers.cc\nvoid SetupTimers(const FunctionCallbackInfo<Value>& args) {\n  CHECK(args[0]->IsFunction());\n  CHECK(args[1]->IsFunction());\n  auto env = Environment::GetCurrent(args);\n\n  env->set_immediate_callback_function(args[0].As<Function>()); // immediate\n  env->set_timers_callback_function(args[1].As<Function>()); // timers\n}\n```\n\n```javascript\n// node.js\nconst {\n  setupTaskQueue,\n  queueMicrotask\n} = require('internal/process/task_queues');\nconst { nextTick, runNextTicks } = setupTaskQueue();\nprocess.nextTick = nextTick;\nprocess._tickCallback = runNextTicks;\n\nconst { getTimerCallbacks } = require('internal/timers');\nconst { setupTimers } = internalBinding('timers'); // c++ SetupTimers JavaScript\nconst { processImmediate, processTimers } = getTimerCallbacks(runNextTicks);\nsetupTimers(processImmediate, processTimers);\n```\n\n`node.js``processImmediate``processTimers`JavaScriptC++`timers_callback_function``processTimers`\n\n```getTimerCallbacks`\n\n```javascript\nfunction getTimerCallbacks(runNextTicks) {\n  function processImmediate() {\n    // \n  }\n\n\n  function processTimers(now) {\n    nextExpiry = Infinity;\n\n    let list;\n    let ranAtLeastOneList = false;\n    while (list = timerListQueue.peek()) {\n      if (list.expiry > now) { // now(libuv loop->time), \n        nextExpiry = list.expiry; // nextExpiry  \n        return refCount > 0 ? nextExpiry : -nextExpiry;\n      }\n      if (ranAtLeastOneList)\n        runNextTicks(); // \n      else\n        ranAtLeastOneList = true;\n      listOnTimeout(list, now);\n    }\n    return 0;\n  }\n\n  function listOnTimeout(list, now) {\n    const msecs = list.msecs;\n\n    debug('timeout callback %d', msecs);\n\n    var diff, timer;\n    let ranAtLeastOneTimer = false;\n    while (timer = L.peek(list)) { // list\n      // _idleStart libuv (loop->time)\n      // now libuv callback\n      diff = now - timer._idleStart; \n\n      // Check if this loop iteration is too early for the next timer.\n      // This happens if there are more timers scheduled for later in the list.\n      if (diff < msecs) {\n        list.expiry = Math.max(timer._idleStart + msecs, now + 1);\n        list.id = timerListId++;\n        timerListQueue.percolateDown(1);\n        debug('%d list wait because diff is %d', msecs, diff);\n        return;\n      }\n\n      if (ranAtLeastOneTimer)\n        runNextTicks(); // \n      else\n        ranAtLeastOneTimer = true;\n\n      // The actual logic for when a timeout happens.\n      L.remove(timer);\n\n      const asyncId = timer[async_id_symbol];\n      if (!timer._onTimeout) {\n        continue;\n      }\n      try {\n        const args = timer._timerArgs;\n        if (args === undefined)\n          timer._onTimeout(); // _onTimeout setTimeout \n        else\n          timer._onTimeout(...args);\n      } finally {\n        // ...\n      }\n    }\n    if (list === timerListMap[msecs]) {\n      delete timerListMap[msecs];\n      timerListQueue.shift();\n    }\n  }\n\n  return {\n    processImmediate,\n    processTimers\n  };\n}\n```\n\n`libuv``runNextTicks`**setTimeoutcallback``timerNode.js 11**\n\n> Timers\n> Interval timers will be rescheduled even if previous interval threw an error. #20002\n> **nextTick queue will be run after each immediate and timer. [#22842](https://github.com/nodejs/node/pull/22842)**\n\n11\n\n```javascript\nsetTimeout(() => {\n  console.log('time1');\n  Promise.resolve().then(() => {\n    console.log('promise1');\n  });\n});\n\nsetTimeout(() => {\n  console.log('time2');\n  Promise.resolve().then(() => {\n    console.log('promise2');\n  });\n});\n\n/* 11\ntime1\npromise1\ntime2\npromise2\n*/\n\n/* 11\ntime1\ntime2\npromise1\npromise2\n*/\n\n```\n\n\n\n<br/>\n\n<br/>\n\n## \n\nlibuvNode.js EventLoop```setTimeout` `nextTick`","slug":"v8-libuv-timer-event-loop","published":1,"updated":"2024-04-08T13:38:43.885Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wew002z18fd9hji387h","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p><a href=\"https://libuv.org/\">libuv</a>EventLoop</p>\n<ul>\n<li><code>libuv</code><code>V8</code></li>\n<li>JavaScriptC/C++</li>\n</ul>\n<p></p>\n<p><strong></strong></p>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// libuv</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// V8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// Node.js</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>20102020</p>\n<span id=\"more\"></span>\n\n<br>\n\n<br>\n\n<h3 id=\"libuv-EventLoop\"><a href=\"#libuv-EventLoop\" class=\"headerlink\" title=\"libuv &amp; EventLoop\"></a>libuv &amp; EventLoop</h3><p><img src=\"/images/v8-libuv-timer-event-loop/loop_iteration.png\" alt=\"_images/loop_iteration.png\"></p>\n<p><code>libuv</code><a href=\"http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop\">The I/O loop</a></p>\n<p><img src=\"/images/v8-libuv-timer-event-loop/image-20200301145547994.png\" alt=\"image-20200301145547994\"></p>\n<p><a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained\">Event Loop Explained</a><code>pending callbacks</code><code>I/O callbacks</code></p>\n<blockquote>\n<p>Pending callbacks are called. All I/O callbacks are called right after polling for I/O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I/O callback it will be run at this point.  libuv</p>\n</blockquote>\n<p><strong>libuv</strong><code>pending callbacks</code>I/O callbackspollingpending callbacks</p>\n<br>\n\n<blockquote>\n<p>This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives <code>ECONNREFUSED</code> when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the <strong>pending callbacks</strong> phase.  Node.js</p>\n</blockquote>\n<p><strong>Node.js</strong><code>pending callbacks</code>callbacksTCP</p>\n<p><code>pending callbacks</code>libuvI/ONode.jsI/OI/O <code>poll</code></p>\n<br>\n\n<br>\n\n<h2 id=\"libuv\"><a href=\"#libuv\" class=\"headerlink\" title=\"libuv\"></a>libuv</h2><figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-type\">int</span> <span class=\"title function_\">uv_run</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_loop_t</span>* loop, uv_run_mode mode)</span> { <span class=\"hljs-comment\">//  mode  UV_RUN_DEFAULT</span></span><br><span class=\"line\">  <span class=\"hljs-type\">int</span> timeout;</span><br><span class=\"line\">  <span class=\"hljs-type\">int</span> r;</span><br><span class=\"line\">  <span class=\"hljs-type\">int</span> ran_pending;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// alive</span></span><br><span class=\"line\">  r = uv__loop_alive(loop);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!r)</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"hljs-comment\">// libuv</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (r != <span class=\"hljs-number\">0</span> &amp;&amp; loop-&gt;stop_flag == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"hljs-comment\">// libuv Update loop time</span></span><br><span class=\"line\">    uv__run_timers(loop); <span class=\"hljs-comment\">//  timers </span></span><br><span class=\"line\">    ran_pending = uv__run_pending(loop); <span class=\"hljs-comment\">// pending 01</span></span><br><span class=\"line\">    uv__run_idle(loop); <span class=\"hljs-comment\">// idle  Node.js</span></span><br><span class=\"line\">    uv__run_prepare(loop); <span class=\"hljs-comment\">// prepare  Node.js</span></span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">//  poll </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> ((mode == UV_RUN_ONCE &amp;&amp; !ran_pending) || mode == UV_RUN_DEFAULT)</span><br><span class=\"line\">      timeout = uv_backend_timeout(loop); <span class=\"hljs-comment\">//  poll </span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// timers diff = loop.time - min.timeout</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">//  diff &gt;= 0 , timeout = 0</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">//  timeout = min(diff, INT_MAX)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    uv__io_poll(loop, timeout); <span class=\"hljs-comment\">//  poll </span></span><br><span class=\"line\">    uv__run_check(loop); <span class=\"hljs-comment\">//  check </span></span><br><span class=\"line\">    uv__run_closing_handles(loop); <span class=\"hljs-comment\">//  close </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// mode  UV_RUN_DEFAULT </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (mode == UV_RUN_ONCE) {</span><br><span class=\"line\">      uv__update_time(loop);</span><br><span class=\"line\">      uv__run_timers(loop);</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// alive</span></span><br><span class=\"line\">    r = uv__loop_alive(loop);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">/* The if statement lets gcc compile it to a conditional store. Avoids</span></span><br><span class=\"line\"><span class=\"hljs-comment\">   * dirtying a cache line.</span></span><br><span class=\"line\"><span class=\"hljs-comment\">   */</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (loop-&gt;stop_flag != <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">    loop-&gt;stop_flag = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> r;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>uv_run</code></p>\n<br>\n\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-type\">void</span> <span class=\"title function_\">uv__run_timers</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_loop_t</span>* loop)</span> {</span><br><span class=\"line\">  <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">heap_node</span>* <span class=\"hljs-title\">heap_node</span>;</span> <span class=\"hljs-comment\">// timers </span></span><br><span class=\"line\">  <span class=\"hljs-type\">uv_timer_t</span>* handle;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (;;) {</span><br><span class=\"line\">    heap_node = heap_min(timer_heap(loop)); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (heap_node == <span class=\"hljs-literal\">NULL</span>) <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    handle = container_of(heap_node, <span class=\"hljs-type\">uv_timer_t</span>, heap_node); </span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (handle-&gt;timeout &gt; loop-&gt;time) <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    uv_timer_stop(handle);</span><br><span class=\"line\">    uv_timer_again(handle);</span><br><span class=\"line\">    </span><br><span class=\"line\">    handle-&gt;timer_cb(handle); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>timers<code>loop-&gt;time</code><strong><code>handle-&gt;timer_cb</code>JavaScriptsetTimeout</strong></p>\n<br>\n\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"title function_\">uv__run_pending</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_loop_t</span>* loop)</span> {</span><br><span class=\"line\">  QUEUE* q;</span><br><span class=\"line\">  QUEUE pq;</span><br><span class=\"line\">  <span class=\"hljs-type\">uv__io_t</span>* w;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (QUEUE_EMPTY(&amp;loop-&gt;pending_queue))</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  QUEUE_MOVE(&amp;loop-&gt;pending_queue, &amp;pq);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (!QUEUE_EMPTY(&amp;pq)) { <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;pq);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"hljs-type\">uv__io_t</span>, pending_queue);</span><br><span class=\"line\">    w-&gt;cb(loop, w, POLLOUT); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>libuv</p>\n<br>\n\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> UV_LOOP_WATCHER_DEFINE(name, type)                                    \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">\tvoid uv__run_##name(uv_loop_t* loop) {                                      \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">    uv_##name##_t* h;                                                         \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">    QUEUE queue;                                                              \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">    QUEUE* q;                                                                 \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">    QUEUE_MOVE(&amp;loop-&gt;name##_handles, &amp;queue);                                \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">    while (!QUEUE_EMPTY(&amp;queue)) {                                            \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">      q = QUEUE_HEAD(&amp;queue);                                                 \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">      h = QUEUE_DATA(q, uv_##name##_t, queue);                                \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">      QUEUE_REMOVE(q);                                                        \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">      QUEUE_INSERT_TAIL(&amp;loop-&gt;name##_handles, q);                            \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">      h-&gt;name##_cb(h);                                                        \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">    }                                                                         \\</span></span><br><span class=\"line\"><span class=\"hljs-meta\">  }     </span></span><br><span class=\"line\"></span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(prepare, PREPARE)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(check, CHECK)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(idle, IDLE)</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>UV_LOOP_WATCHER_DEFINE</code><code>prepare</code><code>check</code><code>idle</code>3</p>\n<br>\n\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// uv__io_poll </span></span><br><span class=\"line\"><span class=\"hljs-type\">void</span> <span class=\"title function_\">uv__io_poll</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_loop_t</span>* loop, <span class=\"hljs-type\">int</span> timeout)</span> {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (loop-&gt;nfds == <span class=\"hljs-number\">0</span>) { <span class=\"hljs-comment\">//  </span></span><br><span class=\"line\">    assert(QUEUE_EMPTY(&amp;loop-&gt;watcher_queue));</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// loop-&gt;watcher_queueepoll</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (!QUEUE_EMPTY(&amp;loop-&gt;watcher_queue)) {</span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;loop-&gt;watcher_queue);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\"></span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"hljs-type\">uv__io_t</span>, watcher_queue);</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (w-&gt;events == <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      op = EPOLL_CTL_ADD; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">      op = EPOLL_CTL_MOD; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_ctl(loop-&gt;backend_fd, op, w-&gt;fd, &amp;e) <span class=\"hljs-comment\">// epoll_ctl </span></span><br><span class=\"line\"></span><br><span class=\"line\">    w-&gt;events = w-&gt;pevents;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  sigmask = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (loop-&gt;flags &amp; UV_LOOP_BLOCK_SIGPROF) {</span><br><span class=\"line\">    sigemptyset(&amp;sigset);</span><br><span class=\"line\">    sigaddset(&amp;sigset, SIGPROF);</span><br><span class=\"line\">    sigmask |= <span class=\"hljs-number\">1</span> &lt;&lt; (SIGPROF - <span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  base = loop-&gt;time;</span><br><span class=\"line\">  real_timeout = timeout;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (;;) {</span><br><span class=\"line\">    nfds = epoll_wait(loop-&gt;backend_fd,</span><br><span class=\"line\">                        events,</span><br><span class=\"line\">                        ARRAY_SIZE(events),</span><br><span class=\"line\">                        timeout);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (nfds == <span class=\"hljs-number\">0</span>) { <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      assert(timeout != <span class=\"hljs-number\">-1</span>); <span class=\"hljs-comment\">// -1 nfds0</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">0</span>) <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"hljs-keyword\">goto</span> update_timeout; <span class=\"hljs-comment\">//   epoll_wait </span></span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (nfds == <span class=\"hljs-number\">-1</span>) { <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (errno == ENOSYS) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">/* epoll_wait() or epoll_pwait() failed, try the other system call. */</span></span><br><span class=\"line\">        assert(no_epoll_wait == <span class=\"hljs-number\">0</span> || no_epoll_pwait == <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">      }</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (errno != EINTR)</span><br><span class=\"line\">        <span class=\"hljs-built_in\">abort</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">-1</span>)</span><br><span class=\"line\">        <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">goto</span> update_timeout;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    have_signals = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">    nevents = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers] = (<span class=\"hljs-type\">void</span>*) events;</span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers + <span class=\"hljs-number\">1</span>] = (<span class=\"hljs-type\">void</span>*) (<span class=\"hljs-type\">uintptr_t</span>) nfds;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; nfds; i++) {</span><br><span class=\"line\">      pe = events + i;</span><br><span class=\"line\">      fd = pe-&gt;data.fd;</span><br><span class=\"line\">      w = loop-&gt;watchers[fd];</span><br><span class=\"line\">      w-&gt;cb(loop, w, pe-&gt;events); <span class=\"hljs-comment\">// forIO</span></span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (timeout == <span class=\"hljs-number\">-1</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">update_timeout:</span><br><span class=\"line\">    assert(timeout &gt; <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    real_timeout -= (loop-&gt;time - base);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (real_timeout &lt;= <span class=\"hljs-number\">0</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = real_timeout;</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>uv__io_poll</code>timeout<code>timers</code><code>epoll</code>IO<code>select</code><code>poll</code><code>epoll</code></p>\n<blockquote>\n<p>epoll<a href=\"https://baike.baidu.com/item/Linux%E5%86%85%E6%A0%B8\">Linux</a><a href=\"https://baike.baidu.com/item/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/9809582\"></a>pollLinuxIOselect/poll<a href=\"https://baike.baidu.com/item/%E5%B9%B6%E5%8F%91%E8%BF%9E%E6%8E%A5/3763280\"></a><a href=\"https://baike.baidu.com/item/CPU/120556\">CPU</a>IOReadyepollselect/pollIOLevel TriggeredEdge TriggeredIOepoll_wait/epoll_pwait </p>\n</blockquote>\n<p>libuvepoll</p>\n<ul>\n<li>epollselect/poll</li>\n<li>epollselect/pollselect/pollNode.jslibuv</li>\n</ul>\n<br>\n\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"title function_\">uv__run_closing_handles</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_loop_t</span>* loop)</span> {</span><br><span class=\"line\">  <span class=\"hljs-type\">uv_handle_t</span>* p;</span><br><span class=\"line\">  <span class=\"hljs-type\">uv_handle_t</span>* q;</span><br><span class=\"line\"></span><br><span class=\"line\">  p = loop-&gt;closing_handles;</span><br><span class=\"line\">  loop-&gt;closing_handles = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (p) {</span><br><span class=\"line\">    q = p-&gt;next_closing;</span><br><span class=\"line\">    uv__finish_close(p);</span><br><span class=\"line\">    p = q;</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>close</code></p>\n<br>\n\n<p>libuv<code>poll</code></p>\n<br>\n\n<br>\n\n\n\n<h2 id=\"Node-js-setTimeout\"><a href=\"#Node-js-setTimeout\" class=\"headerlink\" title=\"Node.js setTimeout\"></a>Node.js setTimeout</h2><p><strong><code>handle-&gt;timer_cb</code>JavaScriptsetTimeout</strong></p>\n<p>Node.js<code>setTimemout</code></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">setTimeout</span>(<span class=\"hljs-params\">callback, after, arg1, arg2, arg3</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> args = [arg1, arg2, arg3]; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">const</span> timeout = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Timeout</span>(callback, after, args, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">  <span class=\"title function_\">active</span>(timeout);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> timeout;</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">Timeout</span>(<span class=\"hljs-params\">callback, after, args, isRepeat</span>) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  after *= <span class=\"hljs-number\">1</span>; </span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!(after &gt;= <span class=\"hljs-number\">1</span> &amp;&amp; after &lt;= <span class=\"variable constant_\">TIMEOUT_MAX</span>)) {</span><br><span class=\"line\">    after = <span class=\"hljs-number\">1</span>; <span class=\"hljs-comment\">//  1 </span></span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">_idleTimeout</span> = after;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">_onTimeout</span> = callback;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">_timerArgs</span> = args;</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">active</span>(<span class=\"hljs-params\">item</span>) {</span><br><span class=\"line\">  <span class=\"title function_\">insert</span>(item, <span class=\"hljs-literal\">true</span>, <span class=\"title function_\">getLibuvNow</span>());  <span class=\"hljs-comment\">// getLibuvNow  loop-&gt;time</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">insert</span>(<span class=\"hljs-params\">item, refed, start</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> msecs = item.<span class=\"hljs-property\">_idleTimeout</span>;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (msecs &lt; <span class=\"hljs-number\">0</span> || msecs === <span class=\"hljs-literal\">undefined</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Truncate so that accuracy of sub-millisecond timers is not assumed.</span></span><br><span class=\"line\">  msecs = <span class=\"title class_\">Math</span>.<span class=\"title function_\">trunc</span>(msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">  item.<span class=\"hljs-property\">_idleStart</span> = start;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Use an existing list if there is one, otherwise we need to make a new one.</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// timerListMap key value TimersList</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">var</span> list = timerListMap[msecs];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (list === <span class=\"hljs-literal\">undefined</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> expiry = start + msecs; <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    timerListMap[msecs] = list = <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">TimersList</span>(expiry, msecs); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">    timerListQueue.<span class=\"title function_\">insert</span>(list); <span class=\"hljs-comment\">// timerListQueue </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (nextExpiry &gt; expiry) {</span><br><span class=\"line\">      <span class=\"title function_\">scheduleTimer</span>(msecs); <span class=\"hljs-comment\">//  V8 scheduleTimer</span></span><br><span class=\"line\">      nextExpiry = expiry;</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ... </span></span><br><span class=\"line\">  L.<span class=\"title function_\">append</span>(list, item); <span class=\"hljs-comment\">// setTimeoutTimeoutlist</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>JavaScripttimerssetTimeoutV8V8<code>scheduleTimer(msecs);</code>V8</p>\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"hljs-type\">void</span> <span class=\"title function_\">ScheduleTimer</span><span class=\"hljs-params\">(<span class=\"hljs-type\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">auto</span> env = Environment::GetCurrent(args);</span><br><span class=\"line\">  env-&gt;ScheduleTimer(args[<span class=\"hljs-number\">0</span>]-&gt;IntegerValue(env-&gt;context()).FromJust());</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">// env.cc</span></span><br><span class=\"line\"><span class=\"hljs-type\">void</span> <span class=\"title function_\">Environment::ScheduleTimer</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int64_t</span> duration_ms)</span> {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (started_cleanup_) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  uv_timer_start(timer_handle(), RunTimers, duration_ms, <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-type\">void</span> <span class=\"title function_\">Environment::RunTimers</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_timer_t</span>* handle)</span> {</span><br><span class=\"line\">  Environment* env = Environment::from_timer_handle(handle);</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"hljs-comment\">// timers_callback_function </span></span><br><span class=\"line\">  Local&lt;Function&gt; cb = env-&gt;timers_callback_function();</span><br><span class=\"line\">  <span class=\"hljs-keyword\">do</span> {</span><br><span class=\"line\">    ret = cb-&gt;Call(env-&gt;context(), process, <span class=\"hljs-number\">1</span>, &amp;arg);</span><br><span class=\"line\">  } <span class=\"hljs-keyword\">while</span> (ret.IsEmpty() &amp;&amp; env-&gt;can_call_into_js());</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">// uv/timer.c</span></span><br><span class=\"line\"><span class=\"hljs-type\">int</span> <span class=\"title function_\">uv_timer_start</span><span class=\"hljs-params\">(<span class=\"hljs-type\">uv_timer_t</span>* handle,</span></span><br><span class=\"line\"><span class=\"hljs-params\">                   uv_timer_cb cb,</span></span><br><span class=\"line\"><span class=\"hljs-params\">                   <span class=\"hljs-type\">uint64_t</span> timeout,</span></span><br><span class=\"line\"><span class=\"hljs-params\">                   <span class=\"hljs-type\">uint64_t</span> repeat)</span> {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// uv_timer_t</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// JavaScriptC++RunTimers</span></span><br><span class=\"line\">  handle-&gt;timer_cb = cb;</span><br><span class=\"line\">  handle-&gt;timeout = clamped_timeout;</span><br><span class=\"line\">  handle-&gt;repeat = repeat;</span><br><span class=\"line\">  handle-&gt;start_id = handle-&gt;loop-&gt;timer_counter++;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// uv_timer_ttimer_heap</span></span><br><span class=\"line\">  heap_insert(timer_heap(handle-&gt;loop),</span><br><span class=\"line\">              (<span class=\"hljs-keyword\">struct</span> heap_node*) &amp;handle-&gt;heap_node,</span><br><span class=\"line\">              timer_less_than);</span><br><span class=\"line\">  uv__handle_start(handle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>V8timersC++</strong><code>timers_callback_function</code></p>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-type\">void</span> <span class=\"hljs-title\">SetupTimers</span><span class=\"hljs-params\">(<span class=\"hljs-type\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>{</span><br><span class=\"line\">  <span class=\"hljs-built_in\">CHECK</span>(args[<span class=\"hljs-number\">0</span>]-&gt;<span class=\"hljs-built_in\">IsFunction</span>());</span><br><span class=\"line\">  <span class=\"hljs-built_in\">CHECK</span>(args[<span class=\"hljs-number\">1</span>]-&gt;<span class=\"hljs-built_in\">IsFunction</span>());</span><br><span class=\"line\">  <span class=\"hljs-keyword\">auto</span> env = Environment::<span class=\"hljs-built_in\">GetCurrent</span>(args);</span><br><span class=\"line\"></span><br><span class=\"line\">  env-&gt;<span class=\"hljs-built_in\">set_immediate_callback_function</span>(args[<span class=\"hljs-number\">0</span>].<span class=\"hljs-built_in\">As</span>&lt;Function&gt;()); <span class=\"hljs-comment\">// immediate</span></span><br><span class=\"line\">  env-&gt;<span class=\"hljs-built_in\">set_timers_callback_function</span>(args[<span class=\"hljs-number\">1</span>].<span class=\"hljs-built_in\">As</span>&lt;Function&gt;()); <span class=\"hljs-comment\">// timers</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// node.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> {</span><br><span class=\"line\">  setupTaskQueue,</span><br><span class=\"line\">  queueMicrotask</span><br><span class=\"line\">} = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'internal/process/task_queues'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> { nextTick, runNextTicks } = <span class=\"title function_\">setupTaskQueue</span>();</span><br><span class=\"line\">process.<span class=\"hljs-property\">nextTick</span> = nextTick;</span><br><span class=\"line\">process.<span class=\"hljs-property\">_tickCallback</span> = runNextTicks;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> { getTimerCallbacks } = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'internal/timers'</span>);</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> { setupTimers } = <span class=\"title function_\">internalBinding</span>(<span class=\"hljs-string\">'timers'</span>); <span class=\"hljs-comment\">// c++ SetupTimers JavaScript</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> { processImmediate, processTimers } = <span class=\"title function_\">getTimerCallbacks</span>(runNextTicks);</span><br><span class=\"line\"><span class=\"title function_\">setupTimers</span>(processImmediate, processTimers);</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>node.js</code><code>processImmediate</code><code>processTimers</code>JavaScriptC++<code>timers_callback_function</code><code>processTimers</code></p>\n<p><code></code><code>getTimerCallbacks</code></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">getTimerCallbacks</span>(<span class=\"hljs-params\">runNextTicks</span>) {</span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">processImmediate</span>(<span class=\"hljs-params\"></span>) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">processTimers</span>(<span class=\"hljs-params\">now</span>) {</span><br><span class=\"line\">    nextExpiry = <span class=\"title class_\">Infinity</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> list;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> ranAtLeastOneList = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">while</span> (list = timerListQueue.<span class=\"title function_\">peek</span>()) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (list.<span class=\"hljs-property\">expiry</span> &gt; now) { <span class=\"hljs-comment\">// now(libuv loop-&gt;time), </span></span><br><span class=\"line\">        nextExpiry = list.<span class=\"hljs-property\">expiry</span>; <span class=\"hljs-comment\">// nextExpiry  </span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> refCount &gt; <span class=\"hljs-number\">0</span> ? nextExpiry : -nextExpiry;</span><br><span class=\"line\">      }</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (ranAtLeastOneList)</span><br><span class=\"line\">        <span class=\"title function_\">runNextTicks</span>(); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneList = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">      <span class=\"title function_\">listOnTimeout</span>(list, now);</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">function</span> <span class=\"title function_\">listOnTimeout</span>(<span class=\"hljs-params\">list, now</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> msecs = list.<span class=\"hljs-property\">msecs</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">debug</span>(<span class=\"hljs-string\">'timeout callback %d'</span>, msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">var</span> diff, timer;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> ranAtLeastOneTimer = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">while</span> (timer = L.<span class=\"title function_\">peek</span>(list)) { <span class=\"hljs-comment\">// list</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// _idleStart libuv (loop-&gt;time)</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// now libuv callback</span></span><br><span class=\"line\">      diff = now - timer.<span class=\"hljs-property\">_idleStart</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// Check if this loop iteration is too early for the next timer.</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">// This happens if there are more timers scheduled for later in the list.</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (diff &lt; msecs) {</span><br><span class=\"line\">        list.<span class=\"hljs-property\">expiry</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">max</span>(timer.<span class=\"hljs-property\">_idleStart</span> + msecs, now + <span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">        list.<span class=\"hljs-property\">id</span> = timerListId++;</span><br><span class=\"line\">        timerListQueue.<span class=\"title function_\">percolateDown</span>(<span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">        <span class=\"title function_\">debug</span>(<span class=\"hljs-string\">'%d list wait because diff is %d'</span>, msecs, diff);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">      }</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (ranAtLeastOneTimer)</span><br><span class=\"line\">        <span class=\"title function_\">runNextTicks</span>(); <span class=\"hljs-comment\">// </span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneTimer = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// The actual logic for when a timeout happens.</span></span><br><span class=\"line\">      L.<span class=\"title function_\">remove</span>(timer);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> asyncId = timer[async_id_symbol];</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (!timer.<span class=\"hljs-property\">_onTimeout</span>) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">      }</span><br><span class=\"line\">      <span class=\"hljs-keyword\">try</span> {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> args = timer.<span class=\"hljs-property\">_timerArgs</span>;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (args === <span class=\"hljs-literal\">undefined</span>)</span><br><span class=\"line\">          timer.<span class=\"title function_\">_onTimeout</span>(); <span class=\"hljs-comment\">// _onTimeout setTimeout </span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">else</span></span><br><span class=\"line\">          timer.<span class=\"title function_\">_onTimeout</span>(...args);</span><br><span class=\"line\">      } <span class=\"hljs-keyword\">finally</span> {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">      }</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (list === timerListMap[msecs]) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">delete</span> timerListMap[msecs];</span><br><span class=\"line\">      timerListQueue.<span class=\"title function_\">shift</span>();</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> {</span><br><span class=\"line\">    processImmediate,</span><br><span class=\"line\">    processTimers</span><br><span class=\"line\">  };</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><code>libuv</code><code>runNextTicks</code><strong>setTimeoutcallback<code></code>timerNode.js 11</strong></p>\n<blockquote>\n<p>Timers<br>Interval timers will be rescheduled even if previous interval threw an error. #20002<br><strong>nextTick queue will be run after each immediate and timer. <a href=\"https://github.com/nodejs/node/pull/22842\">#22842</a></strong></p>\n</blockquote>\n<p>11</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">'time1'</span>);</span><br><span class=\"line\">  <span class=\"title class_\">Promise</span>.<span class=\"title function_\">resolve</span>().<span class=\"title function_\">then</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">'promise1'</span>);</span><br><span class=\"line\">  });</span><br><span class=\"line\">});</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">'time2'</span>);</span><br><span class=\"line\">  <span class=\"title class_\">Promise</span>.<span class=\"title function_\">resolve</span>().<span class=\"title function_\">then</span>(<span class=\"hljs-function\">() =&gt;</span> {</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">'promise2'</span>);</span><br><span class=\"line\">  });</span><br><span class=\"line\">});</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* 11</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* 11</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">time2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise1</span></span><br><span class=\"line\"><span class=\"hljs-comment\">promise2</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n\n\n<br>\n\n<br>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>libuvNode.js EventLoop<code></code><code>setTimeout</code> <code>nextTick</code></p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[{"name":"Node.js","path":"tags/Node-js/"},{"name":"JavaScript","path":"tags/JavaScript/"}],"excerpt":"<html><head></head><body><p><a href=\"https://libuv.org/\">libuv</a>EventLoop</p>\n<ul>\n<li><code>libuv</code><code>V8</code></li>\n<li>JavaScriptC/C++</li>\n</ul>\n<p></p>\n<p><strong></strong></p>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// libuv</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> UV_VERSION_MAJOR 1</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> UV_VERSION_MINOR 33</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> UV_VERSION_PATCH 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// V8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_MAJOR_VERSION 7</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_MINOR_VERSION 8</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_BUILD_NUMBER 279</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> V8_PATCH_LEVEL 17</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// Node.js</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> NODE_MAJOR_VERSION 14</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> NODE_MINOR_VERSION 0</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>20102020</p></body></html>","more":"<br/>\n\n<br/>\n\n<h3 id=\"libuv-EventLoop\"><a href=\"#libuv-EventLoop\" class=\"headerlink\" title=\"libuv &amp; EventLoop\"></a>libuv &amp; EventLoop</h3><p><img src=\"/images/v8-libuv-timer-event-loop/loop_iteration.png\" alt=\"_images/loop_iteration.png\"></p>\n<p><code>libuv</code><a href=\"http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop\">The I&#x2F;O loop</a></p>\n<p><img src=\"/images/v8-libuv-timer-event-loop/image-20200301145547994.png\" alt=\"image-20200301145547994\"></p>\n<p><a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained\">Event Loop Explained</a><code>pending callbacks</code><code>I/O callbacks</code></p>\n<blockquote>\n<p>Pending callbacks are called. All I&#x2F;O callbacks are called right after polling for I&#x2F;O, for the most part. There are cases, however, in which calling such a callback is deferred for the next loop iteration. If the previous iteration deferred any I&#x2F;O callback it will be run at this point.  libuv</p>\n</blockquote>\n<p><strong>libuv</strong><code>pending callbacks</code>I&#x2F;O callbackspollingpending callbacks</p>\n<br/>\n\n<blockquote>\n<p>This phase executes callbacks for some system operations such as types of TCP errors. For example if a TCP socket receives <code>ECONNREFUSED</code> when attempting to connect, some *nix systems want to wait to report the error. This will be queued to execute in the <strong>pending callbacks</strong> phase.  Node.js</p>\n</blockquote>\n<p><strong>Node.js</strong><code>pending callbacks</code>callbacksTCP</p>\n<p><code>pending callbacks</code>libuvI&#x2F;ONode.jsI&#x2F;OI&#x2F;O <code>poll</code></p>\n<br/>\n\n<br/>\n\n<h2 id=\"libuv\"><a href=\"#libuv\" class=\"headerlink\" title=\"libuv\"></a>libuv</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">uv_run</span><span class=\"params\">(<span class=\"type\">uv_loop_t</span>* loop, uv_run_mode mode)</span> &#123; <span class=\"comment\">//  mode  UV_RUN_DEFAULT</span></span><br><span class=\"line\">  <span class=\"type\">int</span> timeout;</span><br><span class=\"line\">  <span class=\"type\">int</span> r;</span><br><span class=\"line\">  <span class=\"type\">int</span> ran_pending;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// alive</span></span><br><span class=\"line\">  r = uv__loop_alive(loop);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!r)</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"comment\">// libuv</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (r != <span class=\"number\">0</span> &amp;&amp; loop-&gt;stop_flag == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    uv__update_time(loop); <span class=\"comment\">// libuv Update loop time</span></span><br><span class=\"line\">    uv__run_timers(loop); <span class=\"comment\">//  timers </span></span><br><span class=\"line\">    ran_pending = uv__run_pending(loop); <span class=\"comment\">// pending 01</span></span><br><span class=\"line\">    uv__run_idle(loop); <span class=\"comment\">// idle  Node.js</span></span><br><span class=\"line\">    uv__run_prepare(loop); <span class=\"comment\">// prepare  Node.js</span></span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = <span class=\"number\">0</span>; <span class=\"comment\">//  poll </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((mode == UV_RUN_ONCE &amp;&amp; !ran_pending) || mode == UV_RUN_DEFAULT)</span><br><span class=\"line\">      timeout = uv_backend_timeout(loop); <span class=\"comment\">//  poll </span></span><br><span class=\"line\">    <span class=\"comment\">// timers diff = loop.time - min.timeout</span></span><br><span class=\"line\">    <span class=\"comment\">//  diff &gt;= 0 , timeout = 0</span></span><br><span class=\"line\">    <span class=\"comment\">//  timeout = min(diff, INT_MAX)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    uv__io_poll(loop, timeout); <span class=\"comment\">//  poll </span></span><br><span class=\"line\">    uv__run_check(loop); <span class=\"comment\">//  check </span></span><br><span class=\"line\">    uv__run_closing_handles(loop); <span class=\"comment\">//  close </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// mode  UV_RUN_DEFAULT </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mode == UV_RUN_ONCE) &#123;</span><br><span class=\"line\">      uv__update_time(loop);</span><br><span class=\"line\">      uv__run_timers(loop);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// alive</span></span><br><span class=\"line\">    r = uv__loop_alive(loop);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* The if statement lets gcc compile it to a conditional store. Avoids</span></span><br><span class=\"line\"><span class=\"comment\">   * dirtying a cache line.</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loop-&gt;stop_flag != <span class=\"number\">0</span>)</span><br><span class=\"line\">    loop-&gt;stop_flag = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>uv_run</code></p>\n<br/>\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">uv__run_timers</span><span class=\"params\">(<span class=\"type\">uv_loop_t</span>* loop)</span> &#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">heap_node</span>* <span class=\"title\">heap_node</span>;</span> <span class=\"comment\">// timers </span></span><br><span class=\"line\">  <span class=\"type\">uv_timer_t</span>* handle;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    heap_node = heap_min(timer_heap(loop)); <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (heap_node == <span class=\"literal\">NULL</span>) <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    handle = container_of(heap_node, <span class=\"type\">uv_timer_t</span>, heap_node); </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (handle-&gt;timeout &gt; loop-&gt;time) <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    uv_timer_stop(handle);</span><br><span class=\"line\">    uv_timer_again(handle);</span><br><span class=\"line\">    </span><br><span class=\"line\">    handle-&gt;timer_cb(handle); <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>timers<code>loop-&gt;time</code><strong><code>handle-&gt;timer_cb</code>JavaScriptsetTimeout</strong></p>\n<br/>\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">uv__run_pending</span><span class=\"params\">(<span class=\"type\">uv_loop_t</span>* loop)</span> &#123;</span><br><span class=\"line\">  QUEUE* q;</span><br><span class=\"line\">  QUEUE pq;</span><br><span class=\"line\">  <span class=\"type\">uv__io_t</span>* w;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (QUEUE_EMPTY(&amp;loop-&gt;pending_queue))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  QUEUE_MOVE(&amp;loop-&gt;pending_queue, &amp;pq);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (!QUEUE_EMPTY(&amp;pq)) &#123; <span class=\"comment\">// </span></span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;pq);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"type\">uv__io_t</span>, pending_queue);</span><br><span class=\"line\">    w-&gt;cb(loop, w, POLLOUT); <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>libuv</p>\n<br/>\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> UV_LOOP_WATCHER_DEFINE(name, type)                                    \\</span></span><br><span class=\"line\"><span class=\"meta\">\tvoid uv__run_##name(uv_loop_t* loop) &#123;                                      \\</span></span><br><span class=\"line\"><span class=\"meta\">    uv_##name##_t* h;                                                         \\</span></span><br><span class=\"line\"><span class=\"meta\">    QUEUE queue;                                                              \\</span></span><br><span class=\"line\"><span class=\"meta\">    QUEUE* q;                                                                 \\</span></span><br><span class=\"line\"><span class=\"meta\">    QUEUE_MOVE(&amp;loop-&gt;name##_handles, &amp;queue);                                \\</span></span><br><span class=\"line\"><span class=\"meta\">    while (!QUEUE_EMPTY(&amp;queue)) &#123;                                            \\</span></span><br><span class=\"line\"><span class=\"meta\">      q = QUEUE_HEAD(&amp;queue);                                                 \\</span></span><br><span class=\"line\"><span class=\"meta\">      h = QUEUE_DATA(q, uv_##name##_t, queue);                                \\</span></span><br><span class=\"line\"><span class=\"meta\">      QUEUE_REMOVE(q);                                                        \\</span></span><br><span class=\"line\"><span class=\"meta\">      QUEUE_INSERT_TAIL(&amp;loop-&gt;name##_handles, q);                            \\</span></span><br><span class=\"line\"><span class=\"meta\">      h-&gt;name##_cb(h);                                                        \\</span></span><br><span class=\"line\"><span class=\"meta\">    &#125;                                                                         \\</span></span><br><span class=\"line\"><span class=\"meta\">  &#125;     </span></span><br><span class=\"line\"></span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(prepare, PREPARE)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(check, CHECK)</span><br><span class=\"line\">UV_LOOP_WATCHER_DEFINE(idle, IDLE)</span><br></pre></td></tr></table></figure>\n\n<p><code>UV_LOOP_WATCHER_DEFINE</code><code>prepare</code><code>check</code><code>idle</code>3</p>\n<br/>\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// uv__io_poll </span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">uv__io_poll</span><span class=\"params\">(<span class=\"type\">uv_loop_t</span>* loop, <span class=\"type\">int</span> timeout)</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loop-&gt;nfds == <span class=\"number\">0</span>) &#123; <span class=\"comment\">//  </span></span><br><span class=\"line\">    assert(QUEUE_EMPTY(&amp;loop-&gt;watcher_queue));</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// loop-&gt;watcher_queueepoll</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (!QUEUE_EMPTY(&amp;loop-&gt;watcher_queue)) &#123;</span><br><span class=\"line\">    q = QUEUE_HEAD(&amp;loop-&gt;watcher_queue);</span><br><span class=\"line\">    QUEUE_REMOVE(q);</span><br><span class=\"line\">    QUEUE_INIT(q);</span><br><span class=\"line\"></span><br><span class=\"line\">    w = QUEUE_DATA(q, <span class=\"type\">uv__io_t</span>, watcher_queue);</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (w-&gt;events == <span class=\"number\">0</span>)</span><br><span class=\"line\">      op = EPOLL_CTL_ADD; <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      op = EPOLL_CTL_MOD; <span class=\"comment\">// </span></span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_ctl(loop-&gt;backend_fd, op, w-&gt;fd, &amp;e) <span class=\"comment\">// epoll_ctl </span></span><br><span class=\"line\"></span><br><span class=\"line\">    w-&gt;events = w-&gt;pevents;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  sigmask = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loop-&gt;flags &amp; UV_LOOP_BLOCK_SIGPROF) &#123;</span><br><span class=\"line\">    sigemptyset(&amp;sigset);</span><br><span class=\"line\">    sigaddset(&amp;sigset, SIGPROF);</span><br><span class=\"line\">    sigmask |= <span class=\"number\">1</span> &lt;&lt; (SIGPROF - <span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  base = loop-&gt;time;</span><br><span class=\"line\">  real_timeout = timeout;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    nfds = epoll_wait(loop-&gt;backend_fd,</span><br><span class=\"line\">                        events,</span><br><span class=\"line\">                        ARRAY_SIZE(events),</span><br><span class=\"line\">                        timeout);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nfds == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// </span></span><br><span class=\"line\">      assert(timeout != <span class=\"number\">-1</span>); <span class=\"comment\">// -1 nfds0</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (timeout == <span class=\"number\">0</span>) <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"keyword\">goto</span> update_timeout; <span class=\"comment\">//   epoll_wait </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nfds == <span class=\"number\">-1</span>) &#123; <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (errno == ENOSYS) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/* epoll_wait() or epoll_pwait() failed, try the other system call. */</span></span><br><span class=\"line\">        assert(no_epoll_wait == <span class=\"number\">0</span> || no_epoll_pwait == <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (errno != EINTR)</span><br><span class=\"line\">        <span class=\"built_in\">abort</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (timeout == <span class=\"number\">-1</span>)</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (timeout == <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> update_timeout;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    have_signals = <span class=\"number\">0</span>;</span><br><span class=\"line\">    nevents = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers] = (<span class=\"type\">void</span>*) events;</span><br><span class=\"line\">    loop-&gt;watchers[loop-&gt;nwatchers + <span class=\"number\">1</span>] = (<span class=\"type\">void</span>*) (<span class=\"type\">uintptr_t</span>) nfds;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; nfds; i++) &#123;</span><br><span class=\"line\">      pe = events + i;</span><br><span class=\"line\">      fd = pe-&gt;data.fd;</span><br><span class=\"line\">      w = loop-&gt;watchers[fd];</span><br><span class=\"line\">      w-&gt;cb(loop, w, pe-&gt;events); <span class=\"comment\">// forIO</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout == <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout == <span class=\"number\">-1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">update_timeout:</span><br><span class=\"line\">    assert(timeout &gt; <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    real_timeout -= (loop-&gt;time - base);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (real_timeout &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    timeout = real_timeout;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>uv__io_poll</code>timeout<code>timers</code><code>epoll</code>IO<code>select</code><code>poll</code><code>epoll</code></p>\n<blockquote>\n<p>epoll<a href=\"https://baike.baidu.com/item/Linux%E5%86%85%E6%A0%B8\">Linux</a><a href=\"https://baike.baidu.com/item/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/9809582\"></a>pollLinuxIOselect&#x2F;poll<a href=\"https://baike.baidu.com/item/%E5%B9%B6%E5%8F%91%E8%BF%9E%E6%8E%A5/3763280\"></a><a href=\"https://baike.baidu.com/item/CPU/120556\">CPU</a>IOReadyepollselect&#x2F;pollIOLevel TriggeredEdge TriggeredIOepoll_wait&#x2F;epoll_pwait </p>\n</blockquote>\n<p>libuvepoll</p>\n<ul>\n<li>epollselect&#x2F;poll</li>\n<li>epollselect&#x2F;pollselect&#x2F;pollNode.jslibuv</li>\n</ul>\n<br/>\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">uv__run_closing_handles</span><span class=\"params\">(<span class=\"type\">uv_loop_t</span>* loop)</span> &#123;</span><br><span class=\"line\">  <span class=\"type\">uv_handle_t</span>* p;</span><br><span class=\"line\">  <span class=\"type\">uv_handle_t</span>* q;</span><br><span class=\"line\"></span><br><span class=\"line\">  p = loop-&gt;closing_handles;</span><br><span class=\"line\">  loop-&gt;closing_handles = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (p) &#123;</span><br><span class=\"line\">    q = p-&gt;next_closing;</span><br><span class=\"line\">    uv__finish_close(p);</span><br><span class=\"line\">    p = q;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>close</code></p>\n<br/>\n\n<p>libuv<code>poll</code></p>\n<br/>\n\n<br/>\n\n\n\n<h2 id=\"Node-js-setTimeout\"><a href=\"#Node-js-setTimeout\" class=\"headerlink\" title=\"Node.js setTimeout\"></a>Node.js setTimeout</h2><p><strong><code>handle-&gt;timer_cb</code>JavaScriptsetTimeout</strong></p>\n<p>Node.js<code>setTimemout</code></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">setTimeout</span>(<span class=\"params\">callback, after, arg1, arg2, arg3</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> args = [arg1, arg2, arg3]; <span class=\"comment\">// </span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> timeout = <span class=\"keyword\">new</span> <span class=\"title class_\">Timeout</span>(callback, after, args, <span class=\"literal\">false</span>);</span><br><span class=\"line\">  <span class=\"title function_\">active</span>(timeout);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> timeout;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">Timeout</span>(<span class=\"params\">callback, after, args, isRepeat</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// </span></span><br><span class=\"line\">  after *= <span class=\"number\">1</span>; </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!(after &gt;= <span class=\"number\">1</span> &amp;&amp; after &lt;= <span class=\"variable constant_\">TIMEOUT_MAX</span>)) &#123;</span><br><span class=\"line\">    after = <span class=\"number\">1</span>; <span class=\"comment\">//  1 </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">_idleTimeout</span> = after;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">_onTimeout</span> = callback;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">_timerArgs</span> = args;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">active</span>(<span class=\"params\">item</span>) &#123;</span><br><span class=\"line\">  <span class=\"title function_\">insert</span>(item, <span class=\"literal\">true</span>, <span class=\"title function_\">getLibuvNow</span>());  <span class=\"comment\">// getLibuvNow  loop-&gt;time</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">insert</span>(<span class=\"params\">item, refed, start</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> msecs = item.<span class=\"property\">_idleTimeout</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (msecs &lt; <span class=\"number\">0</span> || msecs === <span class=\"literal\">undefined</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Truncate so that accuracy of sub-millisecond timers is not assumed.</span></span><br><span class=\"line\">  msecs = <span class=\"title class_\">Math</span>.<span class=\"title function_\">trunc</span>(msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">  item.<span class=\"property\">_idleStart</span> = start;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Use an existing list if there is one, otherwise we need to make a new one.</span></span><br><span class=\"line\">  <span class=\"comment\">// timerListMap key value TimersList</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> list = timerListMap[msecs];</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (list === <span class=\"literal\">undefined</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> expiry = start + msecs; <span class=\"comment\">// </span></span><br><span class=\"line\">    timerListMap[msecs] = list = <span class=\"keyword\">new</span> <span class=\"title class_\">TimersList</span>(expiry, msecs); <span class=\"comment\">// </span></span><br><span class=\"line\">    timerListQueue.<span class=\"title function_\">insert</span>(list); <span class=\"comment\">// timerListQueue </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nextExpiry &gt; expiry) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">scheduleTimer</span>(msecs); <span class=\"comment\">//  V8 scheduleTimer</span></span><br><span class=\"line\">      nextExpiry = expiry;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ... </span></span><br><span class=\"line\">  L.<span class=\"title function_\">append</span>(list, item); <span class=\"comment\">// setTimeoutTimeoutlist</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>JavaScripttimerssetTimeoutV8V8<code>scheduleTimer(msecs);</code>V8</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">ScheduleTimer</span><span class=\"params\">(<span class=\"type\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">auto</span> env = Environment::GetCurrent(args);</span><br><span class=\"line\">  env-&gt;ScheduleTimer(args[<span class=\"number\">0</span>]-&gt;IntegerValue(env-&gt;context()).FromJust());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// env.cc</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">Environment::ScheduleTimer</span><span class=\"params\">(<span class=\"type\">int64_t</span> duration_ms)</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (started_cleanup_) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  uv_timer_start(timer_handle(), RunTimers, duration_ms, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">Environment::RunTimers</span><span class=\"params\">(<span class=\"type\">uv_timer_t</span>* handle)</span> &#123;</span><br><span class=\"line\">  Environment* env = Environment::from_timer_handle(handle);</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// timers_callback_function </span></span><br><span class=\"line\">  Local&lt;Function&gt; cb = env-&gt;timers_callback_function();</span><br><span class=\"line\">  <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">    ret = cb-&gt;Call(env-&gt;context(), process, <span class=\"number\">1</span>, &amp;arg);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">while</span> (ret.IsEmpty() &amp;&amp; env-&gt;can_call_into_js());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// uv/timer.c</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">uv_timer_start</span><span class=\"params\">(<span class=\"type\">uv_timer_t</span>* handle,</span></span><br><span class=\"line\"><span class=\"params\">                   uv_timer_cb cb,</span></span><br><span class=\"line\"><span class=\"params\">                   <span class=\"type\">uint64_t</span> timeout,</span></span><br><span class=\"line\"><span class=\"params\">                   <span class=\"type\">uint64_t</span> repeat)</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// uv_timer_t</span></span><br><span class=\"line\">  <span class=\"comment\">// JavaScriptC++RunTimers</span></span><br><span class=\"line\">  handle-&gt;timer_cb = cb;</span><br><span class=\"line\">  handle-&gt;timeout = clamped_timeout;</span><br><span class=\"line\">  handle-&gt;repeat = repeat;</span><br><span class=\"line\">  handle-&gt;start_id = handle-&gt;loop-&gt;timer_counter++;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// uv_timer_ttimer_heap</span></span><br><span class=\"line\">  heap_insert(timer_heap(handle-&gt;loop),</span><br><span class=\"line\">              (<span class=\"keyword\">struct</span> heap_node*) &amp;handle-&gt;heap_node,</span><br><span class=\"line\">              timer_less_than);</span><br><span class=\"line\">  uv__handle_start(handle);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong>V8timersC++</strong><code>timers_callback_function</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// timers.cc</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">SetupTimers</span><span class=\"params\">(<span class=\"type\">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">CHECK</span>(args[<span class=\"number\">0</span>]-&gt;<span class=\"built_in\">IsFunction</span>());</span><br><span class=\"line\">  <span class=\"built_in\">CHECK</span>(args[<span class=\"number\">1</span>]-&gt;<span class=\"built_in\">IsFunction</span>());</span><br><span class=\"line\">  <span class=\"keyword\">auto</span> env = Environment::<span class=\"built_in\">GetCurrent</span>(args);</span><br><span class=\"line\"></span><br><span class=\"line\">  env-&gt;<span class=\"built_in\">set_immediate_callback_function</span>(args[<span class=\"number\">0</span>].<span class=\"built_in\">As</span>&lt;Function&gt;()); <span class=\"comment\">// immediate</span></span><br><span class=\"line\">  env-&gt;<span class=\"built_in\">set_timers_callback_function</span>(args[<span class=\"number\">1</span>].<span class=\"built_in\">As</span>&lt;Function&gt;()); <span class=\"comment\">// timers</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// node.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123;</span><br><span class=\"line\">  setupTaskQueue,</span><br><span class=\"line\">  queueMicrotask</span><br><span class=\"line\">&#125; = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;internal/process/task_queues&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; nextTick, runNextTicks &#125; = <span class=\"title function_\">setupTaskQueue</span>();</span><br><span class=\"line\">process.<span class=\"property\">nextTick</span> = nextTick;</span><br><span class=\"line\">process.<span class=\"property\">_tickCallback</span> = runNextTicks;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; getTimerCallbacks &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;internal/timers&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; setupTimers &#125; = <span class=\"title function_\">internalBinding</span>(<span class=\"string\">&#x27;timers&#x27;</span>); <span class=\"comment\">// c++ SetupTimers JavaScript</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; processImmediate, processTimers &#125; = <span class=\"title function_\">getTimerCallbacks</span>(runNextTicks);</span><br><span class=\"line\"><span class=\"title function_\">setupTimers</span>(processImmediate, processTimers);</span><br></pre></td></tr></table></figure>\n\n<p><code>node.js</code><code>processImmediate</code><code>processTimers</code>JavaScriptC++<code>timers_callback_function</code><code>processTimers</code></p>\n<p><code></code><code>getTimerCallbacks</code></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTimerCallbacks</span>(<span class=\"params\">runNextTicks</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">processImmediate</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">processTimers</span>(<span class=\"params\">now</span>) &#123;</span><br><span class=\"line\">    nextExpiry = <span class=\"title class_\">Infinity</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">let</span> list;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> ranAtLeastOneList = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (list = timerListQueue.<span class=\"title function_\">peek</span>()) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (list.<span class=\"property\">expiry</span> &gt; now) &#123; <span class=\"comment\">// now(libuv loop-&gt;time), </span></span><br><span class=\"line\">        nextExpiry = list.<span class=\"property\">expiry</span>; <span class=\"comment\">// nextExpiry  </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> refCount &gt; <span class=\"number\">0</span> ? nextExpiry : -nextExpiry;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (ranAtLeastOneList)</span><br><span class=\"line\">        <span class=\"title function_\">runNextTicks</span>(); <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneList = <span class=\"literal\">true</span>;</span><br><span class=\"line\">      <span class=\"title function_\">listOnTimeout</span>(list, now);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">function</span> <span class=\"title function_\">listOnTimeout</span>(<span class=\"params\">list, now</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> msecs = list.<span class=\"property\">msecs</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">debug</span>(<span class=\"string\">&#x27;timeout callback %d&#x27;</span>, msecs);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> diff, timer;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> ranAtLeastOneTimer = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (timer = L.<span class=\"title function_\">peek</span>(list)) &#123; <span class=\"comment\">// list</span></span><br><span class=\"line\">      <span class=\"comment\">// _idleStart libuv (loop-&gt;time)</span></span><br><span class=\"line\">      <span class=\"comment\">// now libuv callback</span></span><br><span class=\"line\">      diff = now - timer.<span class=\"property\">_idleStart</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Check if this loop iteration is too early for the next timer.</span></span><br><span class=\"line\">      <span class=\"comment\">// This happens if there are more timers scheduled for later in the list.</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (diff &lt; msecs) &#123;</span><br><span class=\"line\">        list.<span class=\"property\">expiry</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">max</span>(timer.<span class=\"property\">_idleStart</span> + msecs, now + <span class=\"number\">1</span>);</span><br><span class=\"line\">        list.<span class=\"property\">id</span> = timerListId++;</span><br><span class=\"line\">        timerListQueue.<span class=\"title function_\">percolateDown</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"title function_\">debug</span>(<span class=\"string\">&#x27;%d list wait because diff is %d&#x27;</span>, msecs, diff);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (ranAtLeastOneTimer)</span><br><span class=\"line\">        <span class=\"title function_\">runNextTicks</span>(); <span class=\"comment\">// </span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        ranAtLeastOneTimer = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// The actual logic for when a timeout happens.</span></span><br><span class=\"line\">      L.<span class=\"title function_\">remove</span>(timer);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> asyncId = timer[async_id_symbol];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!timer.<span class=\"property\">_onTimeout</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> args = timer.<span class=\"property\">_timerArgs</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (args === <span class=\"literal\">undefined</span>)</span><br><span class=\"line\">          timer.<span class=\"title function_\">_onTimeout</span>(); <span class=\"comment\">// _onTimeout setTimeout </span></span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          timer.<span class=\"title function_\">_onTimeout</span>(...args);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (list === timerListMap[msecs]) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">delete</span> timerListMap[msecs];</span><br><span class=\"line\">      timerListQueue.<span class=\"title function_\">shift</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">    processImmediate,</span><br><span class=\"line\">    processTimers</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>libuv</code><code>runNextTicks</code><strong>setTimeoutcallback<code></code>timerNode.js 11</strong></p>\n<blockquote>\n<p>Timers<br>Interval timers will be rescheduled even if previous interval threw an error. #20002<br><strong>nextTick queue will be run after each immediate and timer. <a href=\"https://github.com/nodejs/node/pull/22842\">#22842</a></strong></p>\n</blockquote>\n<p>11</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;time1&#x27;</span>);</span><br><span class=\"line\">  <span class=\"title class_\">Promise</span>.<span class=\"title function_\">resolve</span>().<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;promise1&#x27;</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;time2&#x27;</span>);</span><br><span class=\"line\">  <span class=\"title class_\">Promise</span>.<span class=\"title function_\">resolve</span>().<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;promise2&#x27;</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* 11</span></span><br><span class=\"line\"><span class=\"comment\">time1</span></span><br><span class=\"line\"><span class=\"comment\">promise1</span></span><br><span class=\"line\"><span class=\"comment\">time2</span></span><br><span class=\"line\"><span class=\"comment\">promise2</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* 11</span></span><br><span class=\"line\"><span class=\"comment\">time1</span></span><br><span class=\"line\"><span class=\"comment\">time2</span></span><br><span class=\"line\"><span class=\"comment\">promise1</span></span><br><span class=\"line\"><span class=\"comment\">promise2</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<br/>\n\n<br/>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>libuvNode.js EventLoop<code></code><code>setTimeout</code> <code>nextTick</code></p>"},{"title":"Vue Component ","date":"2018-11-17T06:45:00.000Z","_content":"WebUIJS\n\nJSES6Class[Vue](https://vuejs.org/)\n\n<!-- more -->\n\n### \n\n2\n\n![ \"\"](/images/vue-component-extends/1.jpg)\n\n![ \"\"](/images/vue-component-extends/2.jpg)\n\n2\n![ ](/images/vue-component-extends/3.jpg)\n\n### \n\n- Vue  2.5\n\n- [Element-UI](http://element.eleme.io/) Demo\n\n- [](https://github.com/miser/vue-compoent-extends-experiment)\n\n\n### \n\nvue cli\n```javascript\nvue create vue-component-extedns\n```\n\nVue\n\n\n__Element-UI__\n\n```javascript\n// main.js \nimport Vue from 'vue'\nimport ElementUI from 'element-ui'\nimport 'element-ui/lib/theme-chalk/index.css'\nimport App from './App.vue'\n\nVue.config.productionTip = false\nVue.use(ElementUI)\n\nnew Vue({\n  render: h => h(App)\n}).$mount('#app')\n\n```\n\ncomponentsListPageAbstract.vueAdminPageAbstract.vueButtonClick.vueTitle.vue\n\n**\n\n```html\n// ButtonClick.vue\n<template>\n<div>\n  <el-button size=\"small\" plain type=\"primary\" @click.stop=\"click\">\n    {{ label }}\n  </el-button>\n</div>\n</template>\n<script type=\"text/javascript\">\n  export default {\n    props: ['click', 'label', 'opt'],\n    mounted () {\n      console.log('ButtonClick mounted')\n    }\n  }\n</script>\n\n// Title.vue\n<template>\n  <div class=\"title\">{{ title }}</div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['title']\n}\n</script>\n\n// ListPageAbstract.vue\n<template>\n  <div>\n    <Title :title=\"title\" />\n    <div>\n      <el-form v-if=\"config && config.filter\" ref='form' :inline=\"true\" :model=\"filterForm\">\n        <el-form-item v-if=\"config.filter.conditions.indexOf('name') >= 0\" label=\"\" prop=\"name\">\n          <el-input v-model=\"filterForm.name\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('phone') >= 0\" label=\"\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('date') >= 0\" label=\"\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('status') >= 0\" label=\"\" prop=\"status\">\n          <el-select v-model=\"filterForm.status\" placeholder=\"\">\n            <el-option v-for=\"option in statusOptions\" :label=\"option.text\" :value=\"option.value\" :key=\"option.value\"></el-option>\n          </el-select>\n        </el-form-item>\n        <!-- <div>\n        <slot name=\"filter-slot\"></slot>\n        </div> -->\n        <el-form-item>\n          <el-button type=\"primary\" @click.stop=\"config.filter.action\"></el-button>\n        </el-form-item>\n      </el-form>\n    </div>\n    <el-table v-if=\"config\" :data=\"list\" >\n      <el-table-column v-for=\"(item, index) in config.table.column\" :key=\"index\"\n      :prop=\"item.key\" :label=\"item.label\">\n      </el-table-column>\n      <el-table-column v-if=\"config.table.action\" :label=\"config.table.action.headerLabel\">\n      <template slot-scope=\"scope\">\n      <Button :click=\"config.table.action.click.bind(null, scope.row)\" :label=\"config.table.action.label\" :opt=\"config.table.action\" />\n      </template>\n      </el-table-column>\n    </el-table>\n  </div>\n</template>\n<script type=\"text/javascript\">\nimport Button from './ButtonClick.vue'\nimport Title from './Title.vue'\n\nexport default {\n  components: { Button, Title },\n  data: function () {\n    return {\n      filterForm: { },\n      statusOptions: [],\n      list: [],\n      title: null,\n      config: null\n    }\n  },\n  mounted: function () {\n    this.config = this.createConfig()\n    this.fetchOptions()\n    this.fetchData()\n  },\n  methods: {\n    createConfig () {\n      let config = {}\n      config.filter = {\n        conditions: [ 'name', 'status' ],\n        action: () => {\n          this.fetchData(this.filterForm)\n        }\n      }\n      config.table = {\n        column: [\n          { key: 'name', label: '' },\n          { key: 'phone', label: '' },\n          { key: 'status', label: '' }\n        ],\n        action: {\n          headerLabel: '',\n          label: '',\n          click: this.editRow\n        }\n      }\n      return config\n    },\n    fetchOptions () {\n      this.statusOptions = [\n        { value: 1, text: 'status1' },\n        { value: 2, text: 'status2' }\n      ]\n    },\n    async fetchData () { },\n    editRow (item) {\n      console.log(`update data => ${item.name}`)\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  color: red;\n  margin-bottom: 20px;\n}\n</style>\n\n// AdminListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract'\n// ajax\n// \nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'Admin Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'Admin Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'Admin Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'Admin Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  data () {\n    return {\n      title: ''\n    }\n  },\n  methods: {\n    fetchOptions () {\n      ListPageAbstract.methods.fetchOptions.call(this)\n      console.log('to do other thing')\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    }\n  }\n}\n</script>\n```\n\n\n\n- Title.vue ListPageAbstract.vuecss\n- ButtonClick.vue \n- ListPageAbstract.vue \n- AdminListPage.vue \n\nAdminListPage[extends](https://cn.vuejs.org/v2/api/#extends)ListPageAbstractJSListPageAbstractnamephonedatestatusVue[Slot](https://cn.vuejs.org/v2/api/#slot)ListPageAbstract.vue__filter-slot__AdminListPage.vueslot\n\n```html\n// AdminListPage.vue add template \n<template slot=\"filter-slot\">\n  <div slot=\"filter-slot\">\n    other input filter\n  </div>\n</template>\n<script type=\"text/javascript\">\n```\n\nother input filter\n\n![ other input filter](/images/vue-component-extends/4.jpg)\n\n```html\n// AdminListPage.vue \n<template slot=\"filter-slot\">\n  <Page>\n    <div slot=\"filter-slot\">\n      other input filter\n    </div>\n  </Page>\n</template>\nexport default {\n  extends: ListPageAbstract,\n  components: {\n    Page: ListPageAbstract,\n  }\n  // ...\n}\n```\n\nUIListPageAbstractmounted22ListPageAbstractAdminVuegithubfeature [#6811](https://github.com/vuejs/vue/issues/6811)\n\nfilterUserListPageButtonPop.vueUserListPage.vue\n\n**\n\n```html\n// ButtonPop.vue\n<template>\n  <div>\n    <el-button size=\"small\" plain type=\"primary\"\n      @click.stop=\"dialogVisible = true\">{{ label }}</el-button>\n    <el-dialog\n      title=\"\"\n      :visible.sync=\"dialogVisible\"\n      width=\"30%\">\n      <span></span>\n      <span slot=\"footer\" class=\"dialog-footer\">\n      <el-button @click=\"dialogVisible = false\"> </el-button>\n      <el-button type=\"primary\" @click=\"deleteInfo\"> </el-button>\n      </span>\n    </el-dialog>\n  </div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['click', 'label', 'opt'],\n  data () {\n    return {\n      dialogVisible: false\n    }\n  },\n  mounted () {\n    console.log('ButtonPop mounted')\n  },\n  methods: {\n    async deleteInfo () {\n      await this.click()\n      this.dialogVisible = false\n    }\n  }\n}\n</script>\n\n// UserListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract.vue'\nimport Button from './ButtonPop.vue'\n// ajax\n// \nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'User Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'User Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'User Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'User Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  components: { Button },\n  data: function () { return {} },\n  mounted: function () {\n    this.title = ''\n  },\n  methods: {\n    createConfig () {\n      // \n      let config = ListPageAbstract.methods.createConfig.call(this)\n      config.filter.conditions.splice(1, 0, 'phone')\n\n      let table = config.table\n      table.column.push({ key: 'date', label: '' })\n      table.action = {\n        headerLabel: '',\n        label: '',\n        click: this.deleteRow\n      }\n      return config\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    },\n    deleteRow (item) {\n      return new Promise((resolve, reject) => {\n        console.log(`delete date: ${item.name}`)\n        setTimeout(() => {\n          this.list.splice(this.list.indexOf(item), 1)\n          resolve()\n        }, 1000)\n      })\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  margin-bottom: 50px;\n  color: blue;\n}\n</style>\n```\n\nApp.vuePageAdminListPageUserListPage\n\n\n\n```javascript\n  components: { Button }\n```\n\nButtonButtonClickUserButtonPopFilter\n\n__VueVueoptionsmerge__\n\n4Userstylecss\n\nVuemixinslot\n","source":"_posts/vue-component-extends.md","raw":"---\ntitle: Vue Component \ncategory: JavaScript\ndate: 2018-11-17 14:45:00\n---\nWebUIJS\n\nJSES6Class[Vue](https://vuejs.org/)\n\n<!-- more -->\n\n### \n\n2\n\n![ \"\"](/images/vue-component-extends/1.jpg)\n\n![ \"\"](/images/vue-component-extends/2.jpg)\n\n2\n![ ](/images/vue-component-extends/3.jpg)\n\n### \n\n- Vue  2.5\n\n- [Element-UI](http://element.eleme.io/) Demo\n\n- [](https://github.com/miser/vue-compoent-extends-experiment)\n\n\n### \n\nvue cli\n```javascript\nvue create vue-component-extedns\n```\n\nVue\n\n\n__Element-UI__\n\n```javascript\n// main.js \nimport Vue from 'vue'\nimport ElementUI from 'element-ui'\nimport 'element-ui/lib/theme-chalk/index.css'\nimport App from './App.vue'\n\nVue.config.productionTip = false\nVue.use(ElementUI)\n\nnew Vue({\n  render: h => h(App)\n}).$mount('#app')\n\n```\n\ncomponentsListPageAbstract.vueAdminPageAbstract.vueButtonClick.vueTitle.vue\n\n**\n\n```html\n// ButtonClick.vue\n<template>\n<div>\n  <el-button size=\"small\" plain type=\"primary\" @click.stop=\"click\">\n    {{ label }}\n  </el-button>\n</div>\n</template>\n<script type=\"text/javascript\">\n  export default {\n    props: ['click', 'label', 'opt'],\n    mounted () {\n      console.log('ButtonClick mounted')\n    }\n  }\n</script>\n\n// Title.vue\n<template>\n  <div class=\"title\">{{ title }}</div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['title']\n}\n</script>\n\n// ListPageAbstract.vue\n<template>\n  <div>\n    <Title :title=\"title\" />\n    <div>\n      <el-form v-if=\"config && config.filter\" ref='form' :inline=\"true\" :model=\"filterForm\">\n        <el-form-item v-if=\"config.filter.conditions.indexOf('name') >= 0\" label=\"\" prop=\"name\">\n          <el-input v-model=\"filterForm.name\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('phone') >= 0\" label=\"\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('date') >= 0\" label=\"\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('status') >= 0\" label=\"\" prop=\"status\">\n          <el-select v-model=\"filterForm.status\" placeholder=\"\">\n            <el-option v-for=\"option in statusOptions\" :label=\"option.text\" :value=\"option.value\" :key=\"option.value\"></el-option>\n          </el-select>\n        </el-form-item>\n        <!-- <div>\n        <slot name=\"filter-slot\"></slot>\n        </div> -->\n        <el-form-item>\n          <el-button type=\"primary\" @click.stop=\"config.filter.action\"></el-button>\n        </el-form-item>\n      </el-form>\n    </div>\n    <el-table v-if=\"config\" :data=\"list\" >\n      <el-table-column v-for=\"(item, index) in config.table.column\" :key=\"index\"\n      :prop=\"item.key\" :label=\"item.label\">\n      </el-table-column>\n      <el-table-column v-if=\"config.table.action\" :label=\"config.table.action.headerLabel\">\n      <template slot-scope=\"scope\">\n      <Button :click=\"config.table.action.click.bind(null, scope.row)\" :label=\"config.table.action.label\" :opt=\"config.table.action\" />\n      </template>\n      </el-table-column>\n    </el-table>\n  </div>\n</template>\n<script type=\"text/javascript\">\nimport Button from './ButtonClick.vue'\nimport Title from './Title.vue'\n\nexport default {\n  components: { Button, Title },\n  data: function () {\n    return {\n      filterForm: { },\n      statusOptions: [],\n      list: [],\n      title: null,\n      config: null\n    }\n  },\n  mounted: function () {\n    this.config = this.createConfig()\n    this.fetchOptions()\n    this.fetchData()\n  },\n  methods: {\n    createConfig () {\n      let config = {}\n      config.filter = {\n        conditions: [ 'name', 'status' ],\n        action: () => {\n          this.fetchData(this.filterForm)\n        }\n      }\n      config.table = {\n        column: [\n          { key: 'name', label: '' },\n          { key: 'phone', label: '' },\n          { key: 'status', label: '' }\n        ],\n        action: {\n          headerLabel: '',\n          label: '',\n          click: this.editRow\n        }\n      }\n      return config\n    },\n    fetchOptions () {\n      this.statusOptions = [\n        { value: 1, text: 'status1' },\n        { value: 2, text: 'status2' }\n      ]\n    },\n    async fetchData () { },\n    editRow (item) {\n      console.log(`update data => ${item.name}`)\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  color: red;\n  margin-bottom: 20px;\n}\n</style>\n\n// AdminListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract'\n// ajax\n// \nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'Admin Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'Admin Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'Admin Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'Admin Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  data () {\n    return {\n      title: ''\n    }\n  },\n  methods: {\n    fetchOptions () {\n      ListPageAbstract.methods.fetchOptions.call(this)\n      console.log('to do other thing')\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    }\n  }\n}\n</script>\n```\n\n\n\n- Title.vue ListPageAbstract.vuecss\n- ButtonClick.vue \n- ListPageAbstract.vue \n- AdminListPage.vue \n\nAdminListPage[extends](https://cn.vuejs.org/v2/api/#extends)ListPageAbstractJSListPageAbstractnamephonedatestatusVue[Slot](https://cn.vuejs.org/v2/api/#slot)ListPageAbstract.vue__filter-slot__AdminListPage.vueslot\n\n```html\n// AdminListPage.vue add template \n<template slot=\"filter-slot\">\n  <div slot=\"filter-slot\">\n    other input filter\n  </div>\n</template>\n<script type=\"text/javascript\">\n```\n\nother input filter\n\n![ other input filter](/images/vue-component-extends/4.jpg)\n\n```html\n// AdminListPage.vue \n<template slot=\"filter-slot\">\n  <Page>\n    <div slot=\"filter-slot\">\n      other input filter\n    </div>\n  </Page>\n</template>\nexport default {\n  extends: ListPageAbstract,\n  components: {\n    Page: ListPageAbstract,\n  }\n  // ...\n}\n```\n\nUIListPageAbstractmounted22ListPageAbstractAdminVuegithubfeature [#6811](https://github.com/vuejs/vue/issues/6811)\n\nfilterUserListPageButtonPop.vueUserListPage.vue\n\n**\n\n```html\n// ButtonPop.vue\n<template>\n  <div>\n    <el-button size=\"small\" plain type=\"primary\"\n      @click.stop=\"dialogVisible = true\">{{ label }}</el-button>\n    <el-dialog\n      title=\"\"\n      :visible.sync=\"dialogVisible\"\n      width=\"30%\">\n      <span></span>\n      <span slot=\"footer\" class=\"dialog-footer\">\n      <el-button @click=\"dialogVisible = false\"> </el-button>\n      <el-button type=\"primary\" @click=\"deleteInfo\"> </el-button>\n      </span>\n    </el-dialog>\n  </div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['click', 'label', 'opt'],\n  data () {\n    return {\n      dialogVisible: false\n    }\n  },\n  mounted () {\n    console.log('ButtonPop mounted')\n  },\n  methods: {\n    async deleteInfo () {\n      await this.click()\n      this.dialogVisible = false\n    }\n  }\n}\n</script>\n\n// UserListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract.vue'\nimport Button from './ButtonPop.vue'\n// ajax\n// \nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'User Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'User Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'User Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'User Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  components: { Button },\n  data: function () { return {} },\n  mounted: function () {\n    this.title = ''\n  },\n  methods: {\n    createConfig () {\n      // \n      let config = ListPageAbstract.methods.createConfig.call(this)\n      config.filter.conditions.splice(1, 0, 'phone')\n\n      let table = config.table\n      table.column.push({ key: 'date', label: '' })\n      table.action = {\n        headerLabel: '',\n        label: '',\n        click: this.deleteRow\n      }\n      return config\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    },\n    deleteRow (item) {\n      return new Promise((resolve, reject) => {\n        console.log(`delete date: ${item.name}`)\n        setTimeout(() => {\n          this.list.splice(this.list.indexOf(item), 1)\n          resolve()\n        }, 1000)\n      })\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  margin-bottom: 50px;\n  color: blue;\n}\n</style>\n```\n\nApp.vuePageAdminListPageUserListPage\n\n\n\n```javascript\n  components: { Button }\n```\n\nButtonButtonClickUserButtonPopFilter\n\n__VueVueoptionsmerge__\n\n4Userstylecss\n\nVuemixinslot\n","slug":"vue-component-extends","published":1,"updated":"2024-04-08T13:34:02.491Z","comments":1,"layout":"post","photos":[],"_id":"cm3a45wex003118fd4qsa9rfk","content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js\"></script></head><body><p>WebUIJS</p>\n<p>JSES6Class<a href=\"https://vuejs.org/\">Vue</a></p>\n<span id=\"more\"></span>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>2</p>\n<p><img src=\"/images/vue-component-extends/1.jpg\" alt=\" &quot;&quot;\"></p>\n<p><img src=\"/images/vue-component-extends/2.jpg\" alt=\" &quot;&quot;\"></p>\n<p>2<br><img src=\"/images/vue-component-extends/3.jpg\" alt=\" \"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>Vue  2.5</p>\n</li>\n<li><p><a href=\"http://element.eleme.io/\">Element-UI</a> Demo</p>\n</li>\n<li><p><a href=\"https://github.com/miser/vue-compoent-extends-experiment\"></a></p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>vue cli</p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vue create vue-component-extedns</span><br></pre></td></tr></tbody></table></figure>\n\n<p>Vue</p>\n<p><strong>Element-UI</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// main.js </span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> <span class=\"title class_\">Vue</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'vue'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> <span class=\"title class_\">ElementUI</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'element-ui'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> <span class=\"hljs-string\">'element-ui/lib/theme-chalk/index.css'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> <span class=\"title class_\">App</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./App.vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"hljs-property\">config</span>.<span class=\"hljs-property\">productionTip</span> = <span class=\"hljs-literal\">false</span></span><br><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"title function_\">use</span>(<span class=\"title class_\">ElementUI</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Vue</span>({</span><br><span class=\"line\">  <span class=\"hljs-attr\">render</span>: <span class=\"hljs-function\"><span class=\"hljs-params\">h</span> =&gt;</span> <span class=\"title function_\">h</span>(<span class=\"title class_\">App</span>)</span><br><span class=\"line\">}).$mount(<span class=\"hljs-string\">'#app'</span>)</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<p>componentsListPageAbstract.vueAdminPageAbstract.vueButtonClick.vueTitle.vue</p>\n<p><em></em></p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonClick.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">\"small\"</span> <span class=\"hljs-attr\">plain</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"click\"</span>&gt;</span></span><br><span class=\"line\">    {{ label }}</span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-attr\">props</span>: [<span class=\"hljs-string\">'click'</span>, <span class=\"hljs-string\">'label'</span>, <span class=\"hljs-string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    mounted () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">'ButtonClick mounted'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Title.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"title\"</span>&gt;</span>{{ title }}<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">props</span>: [<span class=\"hljs-string\">'title'</span>]</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">}</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// ListPageAbstract.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Title</span> <span class=\"hljs-attr\">:title</span>=<span class=\"hljs-string\">\"title\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config &amp;&amp; config.filter\"</span> <span class=\"hljs-attr\">ref</span>=<span class=\"hljs-string\">'form'</span> <span class=\"hljs-attr\">:inline</span>=<span class=\"hljs-string\">\"true\"</span> <span class=\"hljs-attr\">:model</span>=<span class=\"hljs-string\">\"filterForm\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('name') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"name\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.name\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('phone') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.date\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('date') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.date\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('status') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"status\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-select</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.status\"</span> <span class=\"hljs-attr\">placeholder</span>=<span class=\"hljs-string\">\"\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-option</span> <span class=\"hljs-attr\">v-for</span>=<span class=\"hljs-string\">\"option in statusOptions\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"option.text\"</span> <span class=\"hljs-attr\">:value</span>=<span class=\"hljs-string\">\"option.value\"</span> <span class=\"hljs-attr\">:key</span>=<span class=\"hljs-string\">\"option.value\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-option</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-select</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">&lt;!-- &lt;div&gt;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">        &lt;slot name=\"filter-slot\"&gt;&lt;/slot&gt;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">        &lt;/div&gt; --&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"config.filter.action\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config\"</span> <span class=\"hljs-attr\">:data</span>=<span class=\"hljs-string\">\"list\"</span> &gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table-column</span> <span class=\"hljs-attr\">v-for</span>=<span class=\"hljs-string\">\"(item, index) in config.table.column\"</span> <span class=\"hljs-attr\">:key</span>=<span class=\"hljs-string\">\"index\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">:prop</span>=<span class=\"hljs-string\">\"item.key\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"item.label\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table-column</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.table.action\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"config.table.action.headerLabel\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot-scope</span>=<span class=\"hljs-string\">\"scope\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Button</span> <span class=\"hljs-attr\">:click</span>=<span class=\"hljs-string\">\"config.table.action.click.bind(null, scope.row)\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"config.table.action.label\"</span> <span class=\"hljs-attr\">:opt</span>=<span class=\"hljs-string\">\"config.table.action\"</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">import</span> <span class=\"title class_\">Button</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ButtonClick.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">import</span> <span class=\"title class_\">Title</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./Title.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">components</span>: { <span class=\"title class_\">Button</span>, <span class=\"title class_\">Title</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">data</span>: <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">return</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-attr\">filterForm</span>: { },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-attr\">statusOptions</span>: [],</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-attr\">list</span>: [],</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-attr\">title</span>: <span class=\"hljs-literal\">null</span>,</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-attr\">config</span>: <span class=\"hljs-literal\">null</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">mounted</span>: <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">config</span> = <span class=\"variable language_\">this</span>.<span class=\"title function_\">createConfig</span>()</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetchOptions</span>()</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetchData</span>()</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">methods</span>: {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    createConfig () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">let</span> config = {}</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      config.<span class=\"hljs-property\">filter</span> = {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        <span class=\"hljs-attr\">conditions</span>: [ <span class=\"hljs-string\">'name'</span>, <span class=\"hljs-string\">'status'</span> ],</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        <span class=\"hljs-attr\">action</span>: <span class=\"hljs-function\">() =&gt;</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">          <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetchData</span>(<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">filterForm</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      config.<span class=\"hljs-property\">table</span> = {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        <span class=\"hljs-attr\">column</span>: [</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">          { <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'name'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">''</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">          { <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'phone'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">''</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">          { <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'status'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">''</span> }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        ],</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        <span class=\"hljs-attr\">action</span>: {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">          <span class=\"hljs-attr\">headerLabel</span>: <span class=\"hljs-string\">''</span>,</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">          <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">''</span>,</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">          <span class=\"hljs-attr\">click</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">editRow</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    fetchOptions () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">statusOptions</span> = [</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        { <span class=\"hljs-attr\">value</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">text</span>: <span class=\"hljs-string\">'status1'</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        { <span class=\"hljs-attr\">value</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-attr\">text</span>: <span class=\"hljs-string\">'status2'</span> }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      ]</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () { },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    editRow (item) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">`update data =&gt; <span class=\"hljs-subst\">${item.name}</span>`</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">}</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">style</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span>&gt;</span><span class=\"hljs-language-css\"></span></span><br><span class=\"line\"><span class=\"hljs-language-css\"><span class=\"hljs-selector-class\">.title</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-css\">  <span class=\"hljs-attribute\">color</span>: red;</span></span><br><span class=\"line\"><span class=\"hljs-language-css\">  <span class=\"hljs-attribute\">margin-bottom</span>: <span class=\"hljs-number\">20px</span>;</span></span><br><span class=\"line\"><span class=\"hljs-language-css\">}</span></span><br><span class=\"line\"><span class=\"hljs-language-css\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">style</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// AdminListPage.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">import</span> <span class=\"title class_\">ListPageAbstract</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ListPageAbstract'</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-comment\">// ajax</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-comment\">// </span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">search</span> (opt) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve</span>) =&gt;</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Peter'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'313141414'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-10-10'</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Marry'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'123931873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status2'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-11-11'</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Sue'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'342391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-01-01'</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Join'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'143391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-12-12'</span> }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    ]</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">if</span> (opt.<span class=\"hljs-property\">name</span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      list = list.<span class=\"title function_\">filter</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">item</span> =&gt;</span> item.<span class=\"hljs-property\">name</span>.<span class=\"title function_\">match</span>(opt.<span class=\"hljs-property\">name</span>))</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =&gt;</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"title function_\">resolve</span>(list)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-number\">1000</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  })</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">}</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">extends</span>: <span class=\"title class_\">ListPageAbstract</span>,</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  data () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">return</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-attr\">title</span>: <span class=\"hljs-string\">''</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">methods</span>: {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    fetchOptions () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"title class_\">ListPageAbstract</span>.<span class=\"hljs-property\">methods</span>.<span class=\"hljs-property\">fetchOptions</span>.<span class=\"title function_\">call</span>(<span class=\"variable language_\">this</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">'to do other thing'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">let</span> list = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">search</span>(<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">filterForm</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">list</span> = list</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">}</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p></p>\n<ul>\n<li>Title.vue ListPageAbstract.vuecss</li>\n<li>ButtonClick.vue </li>\n<li>ListPageAbstract.vue </li>\n<li>AdminListPage.vue </li>\n</ul>\n<p>AdminListPage<a href=\"https://cn.vuejs.org/v2/api/#extends\">extends</a>ListPageAbstractJSListPageAbstractnamephonedatestatusVue<a href=\"https://cn.vuejs.org/v2/api/#slot\">Slot</a>ListPageAbstract.vue__filter-slot__AdminListPage.vueslot</p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue add template </span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">    other input filter</span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>other input filter</p>\n<p><img src=\"/images/vue-component-extends/4.jpg\" alt=\" other input filter\"></p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue </span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">      other input filter</span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Page</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">export default {</span><br><span class=\"line\">  extends: ListPageAbstract,</span><br><span class=\"line\">  components: {</span><br><span class=\"line\">    Page: ListPageAbstract,</span><br><span class=\"line\">  }</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>UIListPageAbstractmounted22ListPageAbstractAdminVuegithubfeature <a href=\"https://github.com/vuejs/vue/issues/6811\">#6811</a></p>\n<p>filterUserListPageButtonPop.vueUserListPage.vue</p>\n<p><em></em></p>\n<figure class=\"highlight html hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonPop.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">\"small\"</span> <span class=\"hljs-attr\">plain</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"dialogVisible = true\"</span>&gt;</span>{{ label }}<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-dialog</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">title</span>=<span class=\"hljs-string\">\"\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">:visible.sync</span>=<span class=\"hljs-string\">\"dialogVisible\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">width</span>=<span class=\"hljs-string\">\"30%\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"footer\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"dialog-footer\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> @<span class=\"hljs-attr\">click</span>=<span class=\"hljs-string\">\"dialogVisible = false\"</span>&gt;</span> <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click</span>=<span class=\"hljs-string\">\"deleteInfo\"</span>&gt;</span> <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-dialog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">props</span>: [<span class=\"hljs-string\">'click'</span>, <span class=\"hljs-string\">'label'</span>, <span class=\"hljs-string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  data () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">return</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-attr\">dialogVisible</span>: <span class=\"hljs-literal\">false</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  mounted () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">'ButtonPop mounted'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">methods</span>: {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">async</span> deleteInfo () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">await</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">click</span>()</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">dialogVisible</span> = <span class=\"hljs-literal\">false</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">}</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// UserListPage.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">import</span> <span class=\"title class_\">ListPageAbstract</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ListPageAbstract.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">import</span> <span class=\"title class_\">Button</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ButtonPop.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-comment\">// ajax</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-comment\">// </span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">function</span> <span class=\"title function_\">search</span> (opt) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve</span>) =&gt;</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Peter'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'313141414'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-10-10'</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Marry'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'123931873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status2'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-11-11'</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Sue'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'342391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-01-01'</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      { <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Join'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'143391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-12-12'</span> }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    ]</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">if</span> (opt.<span class=\"hljs-property\">name</span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      list = list.<span class=\"title function_\">filter</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">item</span> =&gt;</span> item.<span class=\"hljs-property\">name</span>.<span class=\"title function_\">match</span>(opt.<span class=\"hljs-property\">name</span>))</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =&gt;</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"title function_\">resolve</span>(list)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }, <span class=\"hljs-number\">1000</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  })</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">}</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">extends</span>: <span class=\"title class_\">ListPageAbstract</span>,</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">components</span>: { <span class=\"title class_\">Button</span> },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">data</span>: <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) { <span class=\"hljs-keyword\">return</span> {} },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">mounted</span>: <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">title</span> = <span class=\"hljs-string\">''</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  <span class=\"hljs-attr\">methods</span>: {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    createConfig () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-comment\">// </span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">let</span> config = <span class=\"title class_\">ListPageAbstract</span>.<span class=\"hljs-property\">methods</span>.<span class=\"hljs-property\">createConfig</span>.<span class=\"title function_\">call</span>(<span class=\"variable language_\">this</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      config.<span class=\"hljs-property\">filter</span>.<span class=\"hljs-property\">conditions</span>.<span class=\"title function_\">splice</span>(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-string\">'phone'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">let</span> table = config.<span class=\"hljs-property\">table</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      table.<span class=\"hljs-property\">column</span>.<span class=\"title function_\">push</span>({ <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'date'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">''</span> })</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      table.<span class=\"hljs-property\">action</span> = {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        <span class=\"hljs-attr\">headerLabel</span>: <span class=\"hljs-string\">''</span>,</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">''</span>,</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        <span class=\"hljs-attr\">click</span>: <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">deleteRow</span></span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">let</span> list = <span class=\"hljs-keyword\">await</span> <span class=\"title function_\">search</span>(<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">filterForm</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">list</span> = list</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    },</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    deleteRow (item) {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"hljs-string\">`delete date: <span class=\"hljs-subst\">${item.name}</span>`</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =&gt;</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">          <span class=\"variable language_\">this</span>.<span class=\"hljs-property\">list</span>.<span class=\"title function_\">splice</span>(<span class=\"variable language_\">this</span>.<span class=\"hljs-property\">list</span>.<span class=\"title function_\">indexOf</span>(item), <span class=\"hljs-number\">1</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">          <span class=\"title function_\">resolve</span>()</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">        }, <span class=\"hljs-number\">1000</span>)</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">      })</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">    }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">  }</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\">}</span></span><br><span class=\"line\"><span class=\"hljs-language-javascript\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">style</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span>&gt;</span><span class=\"hljs-language-css\"></span></span><br><span class=\"line\"><span class=\"hljs-language-css\"><span class=\"hljs-selector-class\">.title</span> {</span></span><br><span class=\"line\"><span class=\"hljs-language-css\">  <span class=\"hljs-attribute\">margin-bottom</span>: <span class=\"hljs-number\">50px</span>;</span></span><br><span class=\"line\"><span class=\"hljs-language-css\">  <span class=\"hljs-attribute\">color</span>: blue;</span></span><br><span class=\"line\"><span class=\"hljs-language-css\">}</span></span><br><span class=\"line\"><span class=\"hljs-language-css\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">style</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>App.vuePageAdminListPageUserListPage</p>\n<p></p>\n<figure class=\"highlight javascript hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-attr\">components</span>: { <span class=\"title class_\">Button</span> }</span><br></pre></td></tr></tbody></table></figure>\n\n<p>ButtonButtonClickUserButtonPopFilter</p>\n<p><strong>VueVueoptionsmerge</strong></p>\n<p>4Userstylecss</p>\n<p>Vuemixinslot</p>\n</body></html>","_categories":[{"name":"JavaScript","path":"categories/JavaScript/"}],"_tags":[],"excerpt":"<html><head></head><body><p>WebUIJS</p>\n<p>JSES6Class<a href=\"https://vuejs.org/\">Vue</a></p></body></html>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>2</p>\n<p><img src=\"/images/vue-component-extends/1.jpg\" alt=\" &quot;&quot;\"></p>\n<p><img src=\"/images/vue-component-extends/2.jpg\" alt=\" &quot;&quot;\"></p>\n<p>2<br><img src=\"/images/vue-component-extends/3.jpg\" alt=\" \"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>Vue  2.5</p>\n</li>\n<li><p><a href=\"http://element.eleme.io/\">Element-UI</a> Demo</p>\n</li>\n<li><p><a href=\"https://github.com/miser/vue-compoent-extends-experiment\"></a></p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>vue cli</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vue create vue-component-extedns</span><br></pre></td></tr></table></figure>\n\n<p>Vue</p>\n<p><strong>Element-UI</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// main.js </span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"title class_\">Vue</span> <span class=\"keyword\">from</span> <span class=\"string\">&#x27;vue&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"title class_\">ElementUI</span> <span class=\"keyword\">from</span> <span class=\"string\">&#x27;element-ui&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">&#x27;element-ui/lib/theme-chalk/index.css&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"title class_\">App</span> <span class=\"keyword\">from</span> <span class=\"string\">&#x27;./App.vue&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"property\">config</span>.<span class=\"property\">productionTip</span> = <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"title class_\">Vue</span>.<span class=\"title function_\">use</span>(<span class=\"title class_\">ElementUI</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Vue</span>(&#123;</span><br><span class=\"line\">  <span class=\"attr\">render</span>: <span class=\"function\"><span class=\"params\">h</span> =&gt;</span> <span class=\"title function_\">h</span>(<span class=\"title class_\">App</span>)</span><br><span class=\"line\">&#125;).$mount(<span class=\"string\">&#x27;#app&#x27;</span>)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>componentsListPageAbstract.vueAdminPageAbstract.vueButtonClick.vueTitle.vue</p>\n<p><em></em></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonClick.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">size</span>=<span class=\"string\">&quot;small&quot;</span> <span class=\"attr\">plain</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;primary&quot;</span> @<span class=\"attr\">click.stop</span>=<span class=\"string\">&quot;click&quot;</span>&gt;</span></span><br><span class=\"line\">    &#123;&#123; label &#125;&#125;</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"attr\">props</span>: [<span class=\"string\">&#x27;click&#x27;</span>, <span class=\"string\">&#x27;label&#x27;</span>, <span class=\"string\">&#x27;opt&#x27;</span>],</span></span><br><span class=\"line\"><span class=\"language-javascript\">    mounted () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;ButtonClick mounted&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Title.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;title&quot;</span>&gt;</span>&#123;&#123; title &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">props</span>: [<span class=\"string\">&#x27;title&#x27;</span>]</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// ListPageAbstract.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Title</span> <span class=\"attr\">:title</span>=<span class=\"string\">&quot;title&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-form</span> <span class=\"attr\">v-if</span>=<span class=\"string\">&quot;config &amp;&amp; config.filter&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&#x27;form&#x27;</span> <span class=\"attr\">:inline</span>=<span class=\"string\">&quot;true&quot;</span> <span class=\"attr\">:model</span>=<span class=\"string\">&quot;filterForm&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">&quot;config.filter.conditions.indexOf(&#x27;name&#x27;) &gt;= 0&quot;</span> <span class=\"attr\">label</span>=<span class=\"string\">&quot;&quot;</span> <span class=\"attr\">prop</span>=<span class=\"string\">&quot;name&quot;</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">&quot;filterForm.name&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">&quot;config.filter.conditions.indexOf(&#x27;phone&#x27;) &gt;= 0&quot;</span> <span class=\"attr\">label</span>=<span class=\"string\">&quot;&quot;</span> <span class=\"attr\">prop</span>=<span class=\"string\">&quot;date&quot;</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">&quot;filterForm.date&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">&quot;config.filter.conditions.indexOf(&#x27;date&#x27;) &gt;= 0&quot;</span> <span class=\"attr\">label</span>=<span class=\"string\">&quot;&quot;</span> <span class=\"attr\">prop</span>=<span class=\"string\">&quot;date&quot;</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">&quot;filterForm.date&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">&quot;config.filter.conditions.indexOf(&#x27;status&#x27;) &gt;= 0&quot;</span> <span class=\"attr\">label</span>=<span class=\"string\">&quot;&quot;</span> <span class=\"attr\">prop</span>=<span class=\"string\">&quot;status&quot;</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-select</span> <span class=\"attr\">v-model</span>=<span class=\"string\">&quot;filterForm.status&quot;</span> <span class=\"attr\">placeholder</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">el-option</span> <span class=\"attr\">v-for</span>=<span class=\"string\">&quot;option in statusOptions&quot;</span> <span class=\"attr\">:label</span>=<span class=\"string\">&quot;option.text&quot;</span> <span class=\"attr\">:value</span>=<span class=\"string\">&quot;option.value&quot;</span> <span class=\"attr\">:key</span>=<span class=\"string\">&quot;option.value&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-option</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">el-select</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- &lt;div&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;slot name=&quot;filter-slot&quot;&gt;&lt;/slot&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;/div&gt; --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;primary&quot;</span> @<span class=\"attr\">click.stop</span>=<span class=\"string\">&quot;config.filter.action&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-form</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-table</span> <span class=\"attr\">v-if</span>=<span class=\"string\">&quot;config&quot;</span> <span class=\"attr\">:data</span>=<span class=\"string\">&quot;list&quot;</span> &gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-table-column</span> <span class=\"attr\">v-for</span>=<span class=\"string\">&quot;(item, index) in config.table.column&quot;</span> <span class=\"attr\">:key</span>=<span class=\"string\">&quot;index&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">:prop</span>=<span class=\"string\">&quot;item.key&quot;</span> <span class=\"attr\">:label</span>=<span class=\"string\">&quot;item.label&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-table-column</span> <span class=\"attr\">v-if</span>=<span class=\"string\">&quot;config.table.action&quot;</span> <span class=\"attr\">:label</span>=<span class=\"string\">&quot;config.table.action.headerLabel&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot-scope</span>=<span class=\"string\">&quot;scope&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Button</span> <span class=\"attr\">:click</span>=<span class=\"string\">&quot;config.table.action.click.bind(null, scope.row)&quot;</span> <span class=\"attr\">:label</span>=<span class=\"string\">&quot;config.table.action.label&quot;</span> <span class=\"attr\">:opt</span>=<span class=\"string\">&quot;config.table.action&quot;</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">el-table</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">import</span> <span class=\"title class_\">Button</span> <span class=\"keyword\">from</span> <span class=\"string\">&#x27;./ButtonClick.vue&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">import</span> <span class=\"title class_\">Title</span> <span class=\"keyword\">from</span> <span class=\"string\">&#x27;./Title.vue&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">components</span>: &#123; <span class=\"title class_\">Button</span>, <span class=\"title class_\">Title</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">data</span>: <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"attr\">filterForm</span>: &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"attr\">statusOptions</span>: [],</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"attr\">list</span>: [],</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"attr\">title</span>: <span class=\"literal\">null</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"attr\">config</span>: <span class=\"literal\">null</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">mounted</span>: <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">this</span>.<span class=\"property\">config</span> = <span class=\"variable language_\">this</span>.<span class=\"title function_\">createConfig</span>()</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetchOptions</span>()</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetchData</span>()</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">methods</span>: &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">let</span> config = &#123;&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      config.<span class=\"property\">filter</span> = &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"attr\">conditions</span>: [ <span class=\"string\">&#x27;name&#x27;</span>, <span class=\"string\">&#x27;status&#x27;</span> ],</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"attr\">action</span>: <span class=\"function\">() =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"variable language_\">this</span>.<span class=\"title function_\">fetchData</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">filterForm</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      config.<span class=\"property\">table</span> = &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"attr\">column</span>: [</span></span><br><span class=\"line\"><span class=\"language-javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">&#x27;name&#x27;</span>, <span class=\"attr\">label</span>: <span class=\"string\">&#x27;&#x27;</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">&#x27;phone&#x27;</span>, <span class=\"attr\">label</span>: <span class=\"string\">&#x27;&#x27;</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">&#x27;status&#x27;</span>, <span class=\"attr\">label</span>: <span class=\"string\">&#x27;&#x27;</span> &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        ],</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"attr\">action</span>: &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"attr\">headerLabel</span>: <span class=\"string\">&#x27;&#x27;</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"attr\">label</span>: <span class=\"string\">&#x27;&#x27;</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"attr\">click</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">editRow</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">this</span>.<span class=\"property\">statusOptions</span> = [</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#123; <span class=\"attr\">value</span>: <span class=\"number\">1</span>, <span class=\"attr\">text</span>: <span class=\"string\">&#x27;status1&#x27;</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#123; <span class=\"attr\">value</span>: <span class=\"number\">2</span>, <span class=\"attr\">text</span>: <span class=\"string\">&#x27;status2&#x27;</span> &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      ]</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">async</span> fetchData () &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">    editRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">`update data =&gt; <span class=\"subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">style</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/css&quot;</span>&gt;</span><span class=\"language-css\"></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"selector-class\">.title</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-css\">  <span class=\"attribute\">color</span>: red;</span></span><br><span class=\"line\"><span class=\"language-css\">  <span class=\"attribute\">margin-bottom</span>: <span class=\"number\">20px</span>;</span></span><br><span class=\"line\"><span class=\"language-css\">&#125;</span></span><br><span class=\"line\"><span class=\"language-css\"></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// AdminListPage.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">import</span> <span class=\"title class_\">ListPageAbstract</span> <span class=\"keyword\">from</span> <span class=\"string\">&#x27;./ListPageAbstract&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"comment\">// ajax</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"comment\">// </span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">function</span> <span class=\"title function_\">search</span> (opt) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;Admin Peter&#x27;</span>, <span class=\"attr\">phone</span>: <span class=\"string\">&#x27;313141414&#x27;</span>, <span class=\"attr\">status</span>: <span class=\"string\">&#x27;status1&#x27;</span>, <span class=\"attr\">date</span>: <span class=\"string\">&#x27;2018-10-10&#x27;</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;Admin Marry&#x27;</span>, <span class=\"attr\">phone</span>: <span class=\"string\">&#x27;123931873&#x27;</span>, <span class=\"attr\">status</span>: <span class=\"string\">&#x27;status2&#x27;</span>, <span class=\"attr\">date</span>: <span class=\"string\">&#x27;2018-11-11&#x27;</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;Admin Sue&#x27;</span>, <span class=\"attr\">phone</span>: <span class=\"string\">&#x27;342391873&#x27;</span>, <span class=\"attr\">status</span>: <span class=\"string\">&#x27;status1&#x27;</span>, <span class=\"attr\">date</span>: <span class=\"string\">&#x27;2018-01-01&#x27;</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;Admin Join&#x27;</span>, <span class=\"attr\">phone</span>: <span class=\"string\">&#x27;143391873&#x27;</span>, <span class=\"attr\">status</span>: <span class=\"string\">&#x27;status1&#x27;</span>, <span class=\"attr\">date</span>: <span class=\"string\">&#x27;2018-12-12&#x27;</span> &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    ]</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">if</span> (opt.<span class=\"property\">name</span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      list = list.<span class=\"title function_\">filter</span>(<span class=\"function\"><span class=\"params\">item</span> =&gt;</span> item.<span class=\"property\">name</span>.<span class=\"title function_\">match</span>(opt.<span class=\"property\">name</span>))</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"title function_\">resolve</span>(list)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"number\">1000</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;)</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">extends</span>: <span class=\"title class_\">ListPageAbstract</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"attr\">title</span>: <span class=\"string\">&#x27;&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">methods</span>: &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"title class_\">ListPageAbstract</span>.<span class=\"property\">methods</span>.<span class=\"property\">fetchOptions</span>.<span class=\"title function_\">call</span>(<span class=\"variable language_\">this</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;to do other thing&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">let</span> list = <span class=\"keyword\">await</span> <span class=\"title function_\">search</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">filterForm</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">this</span>.<span class=\"property\">list</span> = list</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li>Title.vue ListPageAbstract.vuecss</li>\n<li>ButtonClick.vue </li>\n<li>ListPageAbstract.vue </li>\n<li>AdminListPage.vue </li>\n</ul>\n<p>AdminListPage<a href=\"https://cn.vuejs.org/v2/api/#extends\">extends</a>ListPageAbstractJSListPageAbstractnamephonedatestatusVue<a href=\"https://cn.vuejs.org/v2/api/#slot\">Slot</a>ListPageAbstract.vue__filter-slot__AdminListPage.vueslot</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue add template </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot</span>=<span class=\"string\">&quot;filter-slot&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">slot</span>=<span class=\"string\">&quot;filter-slot&quot;</span>&gt;</span></span><br><span class=\"line\">    other input filter</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>other input filter</p>\n<p><img src=\"/images/vue-component-extends/4.jpg\" alt=\" other input filter\"></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot</span>=<span class=\"string\">&quot;filter-slot&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">slot</span>=<span class=\"string\">&quot;filter-slot&quot;</span>&gt;</span></span><br><span class=\"line\">      other input filter</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">Page</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">export default &#123;</span><br><span class=\"line\">  extends: ListPageAbstract,</span><br><span class=\"line\">  components: &#123;</span><br><span class=\"line\">    Page: ListPageAbstract,</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>UIListPageAbstractmounted22ListPageAbstractAdminVuegithubfeature <a href=\"https://github.com/vuejs/vue/issues/6811\">#6811</a></p>\n<p>filterUserListPageButtonPop.vueUserListPage.vue</p>\n<p><em></em></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonPop.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">size</span>=<span class=\"string\">&quot;small&quot;</span> <span class=\"attr\">plain</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;primary&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">      @<span class=\"attr\">click.stop</span>=<span class=\"string\">&quot;dialogVisible = true&quot;</span>&gt;</span>&#123;&#123; label &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-dialog</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">title</span>=<span class=\"string\">&quot;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">:visible.sync</span>=<span class=\"string\">&quot;dialogVisible&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">width</span>=<span class=\"string\">&quot;30%&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">slot</span>=<span class=\"string\">&quot;footer&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;dialog-footer&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-button</span> @<span class=\"attr\">click</span>=<span class=\"string\">&quot;dialogVisible = false&quot;</span>&gt;</span> <span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;primary&quot;</span> @<span class=\"attr\">click</span>=<span class=\"string\">&quot;deleteInfo&quot;</span>&gt;</span> <span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">el-dialog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">props</span>: [<span class=\"string\">&#x27;click&#x27;</span>, <span class=\"string\">&#x27;label&#x27;</span>, <span class=\"string\">&#x27;opt&#x27;</span>],</span></span><br><span class=\"line\"><span class=\"language-javascript\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"attr\">dialogVisible</span>: <span class=\"literal\">false</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  mounted () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;ButtonPop mounted&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">methods</span>: &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">async</span> deleteInfo () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">await</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">click</span>()</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">this</span>.<span class=\"property\">dialogVisible</span> = <span class=\"literal\">false</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// UserListPage.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">import</span> <span class=\"title class_\">ListPageAbstract</span> <span class=\"keyword\">from</span> <span class=\"string\">&#x27;./ListPageAbstract.vue&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">import</span> <span class=\"title class_\">Button</span> <span class=\"keyword\">from</span> <span class=\"string\">&#x27;./ButtonPop.vue&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"comment\">// ajax</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"comment\">// </span></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">function</span> <span class=\"title function_\">search</span> (opt) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;User Peter&#x27;</span>, <span class=\"attr\">phone</span>: <span class=\"string\">&#x27;313141414&#x27;</span>, <span class=\"attr\">status</span>: <span class=\"string\">&#x27;status1&#x27;</span>, <span class=\"attr\">date</span>: <span class=\"string\">&#x27;2018-10-10&#x27;</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;User Marry&#x27;</span>, <span class=\"attr\">phone</span>: <span class=\"string\">&#x27;123931873&#x27;</span>, <span class=\"attr\">status</span>: <span class=\"string\">&#x27;status2&#x27;</span>, <span class=\"attr\">date</span>: <span class=\"string\">&#x27;2018-11-11&#x27;</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;User Sue&#x27;</span>, <span class=\"attr\">phone</span>: <span class=\"string\">&#x27;342391873&#x27;</span>, <span class=\"attr\">status</span>: <span class=\"string\">&#x27;status1&#x27;</span>, <span class=\"attr\">date</span>: <span class=\"string\">&#x27;2018-01-01&#x27;</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;User Join&#x27;</span>, <span class=\"attr\">phone</span>: <span class=\"string\">&#x27;143391873&#x27;</span>, <span class=\"attr\">status</span>: <span class=\"string\">&#x27;status1&#x27;</span>, <span class=\"attr\">date</span>: <span class=\"string\">&#x27;2018-12-12&#x27;</span> &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    ]</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">if</span> (opt.<span class=\"property\">name</span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      list = list.<span class=\"title function_\">filter</span>(<span class=\"function\"><span class=\"params\">item</span> =&gt;</span> item.<span class=\"property\">name</span>.<span class=\"title function_\">match</span>(opt.<span class=\"property\">name</span>))</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"title function_\">resolve</span>(list)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;, <span class=\"number\">1000</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;)</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">extends</span>: <span class=\"title class_\">ListPageAbstract</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">components</span>: &#123; <span class=\"title class_\">Button</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">data</span>: <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123; <span class=\"keyword\">return</span> &#123;&#125; &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">mounted</span>: <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"variable language_\">this</span>.<span class=\"property\">title</span> = <span class=\"string\">&#x27;&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"attr\">methods</span>: &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"comment\">// </span></span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">let</span> config = <span class=\"title class_\">ListPageAbstract</span>.<span class=\"property\">methods</span>.<span class=\"property\">createConfig</span>.<span class=\"title function_\">call</span>(<span class=\"variable language_\">this</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      config.<span class=\"property\">filter</span>.<span class=\"property\">conditions</span>.<span class=\"title function_\">splice</span>(<span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"string\">&#x27;phone&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">let</span> table = config.<span class=\"property\">table</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">      table.<span class=\"property\">column</span>.<span class=\"title function_\">push</span>(&#123; <span class=\"attr\">key</span>: <span class=\"string\">&#x27;date&#x27;</span>, <span class=\"attr\">label</span>: <span class=\"string\">&#x27;&#x27;</span> &#125;)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      table.<span class=\"property\">action</span> = &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"attr\">headerLabel</span>: <span class=\"string\">&#x27;&#x27;</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"attr\">label</span>: <span class=\"string\">&#x27;&#x27;</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"attr\">click</span>: <span class=\"variable language_\">this</span>.<span class=\"property\">deleteRow</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">let</span> list = <span class=\"keyword\">await</span> <span class=\"title function_\">search</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">filterForm</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"variable language_\">this</span>.<span class=\"property\">list</span> = list</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">    deleteRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">`delete date: <span class=\"subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"variable language_\">this</span>.<span class=\"property\">list</span>.<span class=\"title function_\">splice</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">list</span>.<span class=\"title function_\">indexOf</span>(item), <span class=\"number\">1</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"title function_\">resolve</span>()</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;, <span class=\"number\">1000</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#125;)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">style</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/css&quot;</span>&gt;</span><span class=\"language-css\"></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"selector-class\">.title</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-css\">  <span class=\"attribute\">margin-bottom</span>: <span class=\"number\">50px</span>;</span></span><br><span class=\"line\"><span class=\"language-css\">  <span class=\"attribute\">color</span>: blue;</span></span><br><span class=\"line\"><span class=\"language-css\">&#125;</span></span><br><span class=\"line\"><span class=\"language-css\"></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>App.vuePageAdminListPageUserListPage</p>\n<p></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">components</span>: &#123; <span class=\"title class_\">Button</span> &#125;</span><br></pre></td></tr></table></figure>\n\n<p>ButtonButtonClickUserButtonPopFilter</p>\n<p><strong>VueVueoptionsmerge</strong></p>\n<p>4Userstylecss</p>\n<p>Vuemixinslot</p>"},{"title":"","date":"2024-11-06T13:15:05.000Z","_content":"\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/jdsxZlgkqmM?si=Ff0un1-XIpIcFt2F\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" referrerpolicy=\"strict-origin-when-cross-origin\" allowfullscreen style=\"width:100%\"></iframe>\n\n\n\n\n\n\n\n\n\n\n\n\n[Brave Heart](https://y.qq.com/n/ryqq/songDetail/268995652?songtype=0)\n","source":"_posts/2024-11/me.md","raw":"---\ntitle: \ndate: 2024-11-06 21:15:05\ncategory: \n---\n\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/jdsxZlgkqmM?si=Ff0un1-XIpIcFt2F\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" referrerpolicy=\"strict-origin-when-cross-origin\" allowfullscreen style=\"width:100%\"></iframe>\n\n\n\n\n\n\n\n\n\n\n\n\n[Brave Heart](https://y.qq.com/n/ryqq/songDetail/268995652?songtype=0)\n","slug":"2024-11/me","published":1,"updated":"2024-11-09T12:25:11.179Z","_id":"cm3a45wey003318fdak850osc","comments":1,"layout":"post","photos":[],"content":"<html><head><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"https://cdn.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.css\"><script src=\"https://cdn.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"https://cdn.jsdelivr.net/npm/meting@1/dist/Meting.min.js\"></script></head><body><iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/jdsxZlgkqmM?si=Ff0un1-XIpIcFt2F\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" referrerpolicy=\"strict-origin-when-cross-origin\" allowfullscreen=\"\" style=\"width:100%\"></iframe>\n\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p><br><a href=\"https://y.qq.com/n/ryqq/songDetail/268995652?songtype=0\">Brave Heart</a></p>\n</body></html>","_categories":[{"name":"","path":"categories//"}],"_tags":[],"excerpt":"","more":"<iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/jdsxZlgkqmM?si=Ff0un1-XIpIcFt2F\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" referrerpolicy=\"strict-origin-when-cross-origin\" allowfullscreen style=\"width:100%\"></iframe>\n\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p><br><a href=\"https://y.qq.com/n/ryqq/songDetail/268995652?songtype=0\">Brave Heart</a></p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cm3a45wdc000018fd7nynekj9","category_id":"cm3a45wdm000218fdemr5cdmp","_id":"cm3a45wdx000c18fdf8kmc2dk"},{"post_id":"cm3a45wdj000118fd0whhbcta","category_id":"cm3a45wdt000718fd8jmtcqq6","_id":"cm3a45we0000i18fdfvbs13p8"},{"post_id":"cm3a45wdo000318fd5es8aahd","category_id":"cm3a45wdx000d18fdfmuc3seo","_id":"cm3a45we3000n18fd4jt7eitr"},{"post_id":"cm3a45we1000k18fdf3m25dyr","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45we5000s18fd8ngu3i0i"},{"post_id":"cm3a45wdr000518fd1arq7m43","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45we8000v18fdhgsy3dma"},{"post_id":"cm3a45we3000p18fdalx87cvb","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45wea001018fd99ot6i91"},{"post_id":"cm3a45we5000r18fd128vfj3l","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45web001218fde2phf9z5"},{"post_id":"cm3a45wdt000618fdb7snh7ob","category_id":"cm3a45we3000o18fdcnlxeuzn","_id":"cm3a45wec001518fdcfll5dw2"},{"post_id":"cm3a45we7000u18fd9i396fha","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45wee001918fd60f91fqf"},{"post_id":"cm3a45we9000z18fdfaq2b6g3","category_id":"cm3a45wdx000d18fdfmuc3seo","_id":"cm3a45wef001d18fdcw913kdc"},{"post_id":"cm3a45wdu000818fd0hspcv1m","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45weh001h18fd1asq5g4n"},{"post_id":"cm3a45wea001118fddpg5h3jx","category_id":"cm3a45wdx000d18fdfmuc3seo","_id":"cm3a45wei001k18fd451f0ll7"},{"post_id":"cm3a45web001418fd16ynej5g","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45wek001o18fdddn0623o"},{"post_id":"cm3a45wdw000b18fd6gku6rg7","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45wek001r18fd4mozhju4"},{"post_id":"cm3a45wed001818fd3hd28ffx","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45wem001v18fdhycc9ca3"},{"post_id":"cm3a45wef001c18fd2p1k6h1k","category_id":"cm3a45wdx000d18fdfmuc3seo","_id":"cm3a45wen001y18fd7nukfeyn"},{"post_id":"cm3a45wdz000g18fd6fsr6pkq","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45wen002118fd5bqzdfp5"},{"post_id":"cm3a45weg001g18fd6khfg48v","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45wen002318fda4uz8kp0"},{"post_id":"cm3a45weh001j18fdexuhd9hk","category_id":"cm3a45wdm000218fdemr5cdmp","_id":"cm3a45weo002618fdb5ka9lty"},{"post_id":"cm3a45wej001n18fda3ppdxmo","category_id":"cm3a45wdm000218fdemr5cdmp","_id":"cm3a45weo002818fd6jdy1nwd"},{"post_id":"cm3a45wel001u18fd56w03cox","category_id":"cm3a45wdm000218fdemr5cdmp","_id":"cm3a45weo002a18fd16zb6vgc"},{"post_id":"cm3a45wek001q18fd71265mqf","category_id":"cm3a45wem001w18fdhy506zak","_id":"cm3a45weo002b18fd43yp5rw2"},{"post_id":"cm3a45wev002y18fd7nxm5gqa","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45wez003418fd7y9s4tzf"},{"post_id":"cm3a45wew002z18fd9hji387h","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45wez003618fd3vj2175m"},{"post_id":"cm3a45wex003118fd4qsa9rfk","category_id":"cm3a45we0000j18fdezycd5dy","_id":"cm3a45wf0003918fderc50e6l"},{"post_id":"cm3a45wey003318fdak850osc","category_id":"cm3a45wez003718fd0rzr3ex9","_id":"cm3a45wf0003a18fdc5pk4ekg"}],"PostTag":[{"post_id":"cm3a45wdj000118fd0whhbcta","tag_id":"cm3a45wdq000418fdb6ou9p1v","_id":"cm3a45wdw000a18fd5stfbjfq"},{"post_id":"cm3a45wdo000318fd5es8aahd","tag_id":"cm3a45wdv000918fd3u5c014a","_id":"cm3a45we0000h18fdhfk6c6xm"},{"post_id":"cm3a45wdr000518fd1arq7m43","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45we7000t18fd1tle15zq"},{"post_id":"cm3a45wdr000518fd1arq7m43","tag_id":"cm3a45we2000l18fddkogbwrv","_id":"cm3a45we8000x18fdb6kkei4h"},{"post_id":"cm3a45wdt000618fdb7snh7ob","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45wed001718fd5vy483eg"},{"post_id":"cm3a45wdt000618fdb7snh7ob","tag_id":"cm3a45we8000y18fd9u0s6gvr","_id":"cm3a45wee001b18fdc8nf7mz5"},{"post_id":"cm3a45web001418fd16ynej5g","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45weg001f18fdeqjb7vw6"},{"post_id":"cm3a45web001418fd16ynej5g","tag_id":"cm3a45we2000l18fddkogbwrv","_id":"cm3a45weh001i18fd4w1ofkj8"},{"post_id":"cm3a45wed001818fd3hd28ffx","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45wej001m18fd10jq4aph"},{"post_id":"cm3a45wed001818fd3hd28ffx","tag_id":"cm3a45we2000l18fddkogbwrv","_id":"cm3a45wek001p18fd4u0d9rkk"},{"post_id":"cm3a45wdu000818fd0hspcv1m","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45wel001t18fdc9iaebwx"},{"post_id":"cm3a45wdu000818fd0hspcv1m","tag_id":"cm3a45we2000l18fddkogbwrv","_id":"cm3a45wen001x18fd870357k6"},{"post_id":"cm3a45wdw000b18fd6gku6rg7","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45wen002018fd11am45mp"},{"post_id":"cm3a45wdw000b18fd6gku6rg7","tag_id":"cm3a45we2000l18fddkogbwrv","_id":"cm3a45wen002218fdac45dh56"},{"post_id":"cm3a45we1000k18fdf3m25dyr","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45weo002518fd7biygd6w"},{"post_id":"cm3a45we1000k18fdf3m25dyr","tag_id":"cm3a45we2000l18fddkogbwrv","_id":"cm3a45weo002718fdgu892s14"},{"post_id":"cm3a45we2000m18fd4rya1sis","tag_id":"cm3a45wen002418fd6ksygj6s","_id":"cm3a45wep002d18fd63sy96n0"},{"post_id":"cm3a45we2000m18fd4rya1sis","tag_id":"cm3a45we2000l18fddkogbwrv","_id":"cm3a45wep002e18fdhxsna327"},{"post_id":"cm3a45we2000m18fd4rya1sis","tag_id":"cm3a45weo002918fd2ainal9h","_id":"cm3a45wep002g18fd04iqfw64"},{"post_id":"cm3a45we3000p18fdalx87cvb","tag_id":"cm3a45wen002418fd6ksygj6s","_id":"cm3a45wep002h18fdhf5vaplj"},{"post_id":"cm3a45we3000p18fdalx87cvb","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45weq002j18fd34i48etc"},{"post_id":"cm3a45we3000p18fdalx87cvb","tag_id":"cm3a45we2000l18fddkogbwrv","_id":"cm3a45weq002k18fdfbsi0z27"},{"post_id":"cm3a45we7000u18fd9i396fha","tag_id":"cm3a45wep002f18fdek6ihf84","_id":"cm3a45weq002m18fde0gmb0m8"},{"post_id":"cm3a45we7000u18fd9i396fha","tag_id":"cm3a45wep002i18fd630thn2i","_id":"cm3a45weq002n18fd984l0yst"},{"post_id":"cm3a45we7000u18fd9i396fha","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45weq002p18fdhdjs562n"},{"post_id":"cm3a45we9000z18fdfaq2b6g3","tag_id":"cm3a45weq002l18fd06yg7oy3","_id":"cm3a45wer002q18fd8ilf816x"},{"post_id":"cm3a45wea001118fddpg5h3jx","tag_id":"cm3a45weq002l18fd06yg7oy3","_id":"cm3a45wer002s18fdfsrkezl8"},{"post_id":"cm3a45wef001c18fd2p1k6h1k","tag_id":"cm3a45weq002l18fd06yg7oy3","_id":"cm3a45wes002v18fd4nzq1n7c"},{"post_id":"cm3a45wef001c18fd2p1k6h1k","tag_id":"cm3a45wer002t18fdhfi1cjcx","_id":"cm3a45wes002w18fdh94s3hxr"},{"post_id":"cm3a45weg001g18fd6khfg48v","tag_id":"cm3a45wer002u18fd0ugt0d0u","_id":"cm3a45wes002x18fdaw9tdgok"},{"post_id":"cm3a45wev002y18fd7nxm5gqa","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45wex003018fd6j1f679y"},{"post_id":"cm3a45wev002y18fd7nxm5gqa","tag_id":"cm3a45we2000l18fddkogbwrv","_id":"cm3a45wey003218fdfvaka06w"},{"post_id":"cm3a45wew002z18fd9hji387h","tag_id":"cm3a45wdy000f18fd8waj3zso","_id":"cm3a45wez003518fd82koeww8"},{"post_id":"cm3a45wew002z18fd9hji387h","tag_id":"cm3a45we2000l18fddkogbwrv","_id":"cm3a45wez003818fd05qtaf6e"}],"Tag":[{"name":"life","_id":"cm3a45wdq000418fdb6ou9p1v"},{"name":"","_id":"cm3a45wdv000918fd3u5c014a"},{"name":"Node.js","_id":"cm3a45wdy000f18fd8waj3zso"},{"name":"JavaScript","_id":"cm3a45we2000l18fddkogbwrv"},{"name":"libuv","_id":"cm3a45we8000y18fd9u0s6gvr"},{"name":"","_id":"cm3a45wen002418fd6ksygj6s"},{"name":"Web","_id":"cm3a45weo002918fd2ainal9h"},{"name":"","_id":"cm3a45wep002f18fdek6ihf84"},{"name":"V8","_id":"cm3a45wep002i18fd630thn2i"},{"name":"","_id":"cm3a45weq002l18fd06yg7oy3"},{"name":"","_id":"cm3a45wer002t18fdhfi1cjcx"},{"name":"SSR","_id":"cm3a45wer002u18fd0ugt0d0u"}]}}