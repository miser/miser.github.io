<!DOCTYPE html>
<html class="has-navbar-fixed-top">
  <head>
    <meta charset="utf-8" />
<title>简单梳理Node.js创建子进程的方法（下）—— cluster - Miser 胡言</title>
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1"
/>

<link
  rel="stylesheet"
  href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"
/>
<meta name="baidu-site-verification" content="CXKjj3fklD" />

<meta name="description" content="在默认的RoundRobinHandle模式下，从上可以看出，cluster子进程之所以可以共同监听同个TCP端口，是在net模块里面做了master和child区分，child并没有真正的监听端口，而是child会去master查询该Server是否已经存在，如果没有会在RoundRobinHandle中创建中创建server，一旦有新的TCP连接进入，会转发给free里的worker（cluster.child）处理" />
 
<meta name="keywords" content="child_process,cluster,fork,Node.js,共同监听TCP端口" />
   

<link
  rel="stylesheet"
  href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro"
/>
<link
  rel="stylesheet"
  href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css"
/>


<link
  rel="stylesheet"
  href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"
/>
<link
  rel="stylesheet"
  href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css"
/>


<link
  rel="stylesheet"
  href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"
/>


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>

      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZKHJQL3QC0"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-ZKHJQL3QC0');
</script>

  

    <style type="text/css">
      body {
        font-family: Consolas, Mononoki, "Roboto Sans", "Liberation Mono",
          monospace;
        color: #586e75;
        line-height: 1.6;
        background-color: #fdf6e3;
      }
      .gallery-item .caption {
        text-align: center;
      }
      div.adv {
        margin-bottom: 60px;
      }
      ul .img {
        text-align: center;
      }
    </style>
  <meta name="generator" content="Hexo 7.1.1"></head>
  <body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    胡言
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            
            <a class="navbar-item" title="Twitter" href="https://twitter.com/ud_miser">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" title="GitHub" href="https://github.com/miser">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>
 <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            简单梳理Node.js创建子进程的方法（下）—— cluster
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2020-05-03T07:24:53.000Z" itemprop="datePublished">May 3 2020</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>前文简单梳理了Node.js使用<strong>child_process</strong>模块创建子进程的4种方法，<code>exec</code>、<code>execFile</code>、<code>fork</code>和<code>spawn</code>。接下来我们看看<strong>cluster</strong>模块如何创建子进程，后续更多内容会介绍cluster.fork启动Net Server时候为何不会因为共同监听同一个端口而不报错。</p>
<p><strong>cluster</strong></p>
<ul>
<li><a href="http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env">fork</a>: 衍生出一个新的工作进程，这只能通过主进程调用。</li>
</ul>
<span id="more"></span>

<br/>

<p><strong>翻翻源码看看他们怎么实现的</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// libuv</span><br><span class="line"><span class="section">#define UV<span class="emphasis">_VERSION_</span>MAJOR 1</span></span><br><span class="line"><span class="section">#define UV<span class="emphasis">_VERSION_</span>MINOR 33</span></span><br><span class="line"><span class="section">#define UV<span class="emphasis">_VERSION_</span>PATCH 1</span></span><br><span class="line"></span><br><span class="line">// V8</span><br><span class="line"><span class="section">#define V8<span class="emphasis">_MAJOR_</span>VERSION 7</span></span><br><span class="line"><span class="section">#define V8<span class="emphasis">_MINOR_</span>VERSION 8</span></span><br><span class="line"><span class="section">#define V8<span class="emphasis">_BUILD_</span>NUMBER 279</span></span><br><span class="line"><span class="section">#define V8<span class="emphasis">_PATCH_</span>LEVEL 17</span></span><br><span class="line"></span><br><span class="line">// Node.js</span><br><span class="line"><span class="section">#define NODE<span class="emphasis">_MAJOR_</span>VERSION 14</span></span><br><span class="line"><span class="section">#define NODE<span class="emphasis">_MINOR_</span>VERSION 0</span></span><br><span class="line"><span class="section">#define NODE<span class="emphasis">_PATCH_</span>VERSION 0</span></span><br></pre></td></tr></table></figure>

<p><strong>cluster</strong>源码位置</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lib</span><br><span class="line"><span class="bullet">  -</span> internal</span><br><span class="line"><span class="bullet">    -</span> cluster</span><br><span class="line"><span class="bullet">    -</span> child.js</span><br><span class="line"><span class="bullet">      -</span> master.js</span><br><span class="line"><span class="bullet">      -</span> round<span class="emphasis">_robin_</span>handle.js</span><br><span class="line"><span class="bullet">      -</span> shared<span class="emphasis">_handle.js</span></span><br><span class="line"><span class="emphasis">      - utils.js</span></span><br><span class="line"><span class="emphasis">      - worker.js</span></span><br><span class="line"><span class="emphasis">  - cluster.js</span></span><br></pre></td></tr></table></figure>

<br/>

<p><strong>官方示例</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cluster = <span class="built_in">require</span>(<span class="string">&#x27;cluster&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> numCPUs = <span class="built_in">require</span>(<span class="string">&#x27;os&#x27;</span>).<span class="title function_">cpus</span>().<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cluster.<span class="property">isMaster</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`主进程 <span class="subst">$&#123;process.pid&#125;</span> 正在运行`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 衍生工作进程。</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class="line">    cluster.<span class="title function_">fork</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cluster.<span class="title function_">on</span>(<span class="string">&#x27;exit&#x27;</span>, <span class="function">(<span class="params">worker, code, signal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`工作进程 <span class="subst">$&#123;worker.process.pid&#125;</span> 已退出`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 工作进程可以共享任何 TCP 连接。</span></span><br><span class="line">  <span class="comment">// 在本例子中，共享的是 HTTP 服务器。</span></span><br><span class="line">  http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">writeHead</span>(<span class="number">200</span>);</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;你好世界\n&#x27;</span>);</span><br><span class="line">  &#125;).<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`工作进程 <span class="subst">$&#123;process.pid&#125;</span> 已启动`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="Q-cluster-isMaster模块如何区分是主进程还是子进程的？"><a href="#Q-cluster-isMaster模块如何区分是主进程还是子进程的？" class="headerlink" title="Q:cluster.isMaster模块如何区分是主进程还是子进程的？"></a>Q:cluster.isMaster模块如何区分是主进程还是子进程的？</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/cluster.js</span></span><br><span class="line"><span class="keyword">const</span> childOrMaster = <span class="string">&#x27;NODE_UNIQUE_ID&#x27;</span> <span class="keyword">in</span> process.<span class="property">env</span> ? <span class="string">&#x27;child&#x27;</span> : <span class="string">&#x27;master&#x27;</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="built_in">require</span>(<span class="string">`internal/cluster/<span class="subst">$&#123;childOrMaster&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>

<p><code>lib/cluster.js</code>是整个cluster的入口，根据环境变量中是否有<code>NODE_UNIQUE_ID</code>来区分主或子进程。</p>
<p>主进程通过<code>cluster.fork</code>创建子进程的时候，会将<code>NODE_UNIQUE_ID</code>传入子进程的环境变量中，最后通过<strong>child_process.fork</strong>去创建新的子进程。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/internal/cluster/master.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">cluster.<span class="property">isMaster</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// fork的代码下文还会提到</span></span><br><span class="line"><span class="keyword">const</span> workerEnv = &#123; ...process.<span class="property">env</span>, ...env, <span class="attr">NODE_UNIQUE_ID</span>: <span class="string">`<span class="subst">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">fork</span>(cluster.<span class="property">settings</span>.<span class="property">exec</span>, cluster.<span class="property">settings</span>.<span class="property">args</span>, &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">env</span>: workerEnv,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// lib/internal/cluster/child.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">cluster.<span class="property">isMaster</span> = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Q-cluster-fork创建子进程过程中做了些什么？"><a href="#Q-cluster-fork创建子进程过程中做了些什么？" class="headerlink" title="Q:cluster.fork创建子进程过程中做了些什么？"></a>Q:cluster.fork创建子进程过程中做了些什么？</h3><p><code>cluster.setupMaster</code>是对整个环境参数的配置；</p>
<p>通过<code>createWorkerProcess</code>里的<code>child_process.fork</code>去创建子进程；</p>
<p>之后将其和一个<code>Worker</code>对象做关联，worker、其子进程和当前cluster(master)都会收到几乎相同的<code>message</code>、<code>exit</code>和<code>disconnect</code>事件，<strong>Worker</strong>这边不多扩展，可以查阅<code>lib/internal/cluster/worker.js</code>；</p>
<p>子进程会监听<code>internalMessage</code>事件，什么是internalMessage事件呢？看看下面官方的介绍。</p>
<blockquote>
<p>当发送 <strong>{cmd: ‘NODE_foo’}</strong> 消息时有一种特殊情况。 <strong>cmd</strong> 属性中包含 <strong>NODE_</strong> 前缀的消息是预留给 Node.js 内核内部使用的，将不会触发子进程的 <strong>‘message’<strong>事件。 相反，这种消息可使用 <strong>‘internalMessage’</strong> 事件触发，且会被 Node.js 内部消费。 应用程序应避免使用此类消息或监听</strong>‘internalMessage’</strong> 事件，因为它可能会被更改且不会通知。</p>
</blockquote>
<p>此处<code>internalMessage</code>事件的回调方法是<code>internal(worker, onmessage)</code>，<strong>internal</strong>是<code>lib/internal/cluster/master.js</code>里的方法，主要作用是判断监听的消息里面是否存在需要执行的回调，如果没有就会执行入参回调，这里指的是<strong>onmessage</strong>；</p>
<p><strong>onmessage</strong>里面有很多if-else语句，主要是根据cluster.child传送进来的消息类型(<code>act</code>)做出不同的处理，这里列出了一个<code>queryServer</code>（因为后面会介绍Net Server里多个子进程如何监听同一个端口的）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/internal/cluster/master.js</span></span><br><span class="line">cluster.<span class="property">fork</span> = <span class="keyword">function</span> (<span class="params">env</span>) &#123;</span><br><span class="line">  cluster.<span class="title function_">setupMaster</span>();</span><br><span class="line">  <span class="keyword">const</span> id = ++ids;</span><br><span class="line">  <span class="comment">// 创建子进程</span></span><br><span class="line">  <span class="keyword">const</span> workerProcess = <span class="title function_">createWorkerProcess</span>(id, env);</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">const</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(&#123;</span><br><span class="line">    <span class="attr">id</span>: id,</span><br><span class="line">    <span class="attr">process</span>: workerProcess, <span class="comment">// 新建的子进程</span></span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  worker.<span class="title function_">on</span>(<span class="string">&quot;message&quot;</span>, <span class="keyword">function</span> (<span class="params">message, handle</span>) &#123;</span><br><span class="line">    cluster.<span class="title function_">emit</span>(<span class="string">&quot;message&quot;</span>, <span class="variable language_">this</span>, message, handle);</span><br><span class="line">  &#125;);</span><br><span class="line">  worker.<span class="property">process</span>.<span class="title function_">once</span>(<span class="string">&quot;exit&quot;</span>, <span class="function">(<span class="params">exitCode, signalCode</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    worker.<span class="property">state</span> = <span class="string">&quot;dead&quot;</span>;</span><br><span class="line">    worker.<span class="title function_">emit</span>(<span class="string">&quot;exit&quot;</span>, exitCode, signalCode);</span><br><span class="line">    cluster.<span class="title function_">emit</span>(<span class="string">&quot;exit&quot;</span>, worker, exitCode, signalCode);</span><br><span class="line">  &#125;);</span><br><span class="line">  worker.<span class="property">process</span>.<span class="title function_">once</span>(<span class="string">&quot;disconnect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    worker.<span class="property">state</span> = <span class="string">&quot;disconnected&quot;</span>;</span><br><span class="line">    worker.<span class="title function_">emit</span>(<span class="string">&quot;disconnect&quot;</span>);</span><br><span class="line">    cluster.<span class="title function_">emit</span>(<span class="string">&quot;disconnect&quot;</span>, worker);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  worker.<span class="property">process</span>.<span class="title function_">on</span>(<span class="string">&quot;internalMessage&quot;</span>, <span class="title function_">internal</span>(worker, onmessage));</span><br><span class="line">  <span class="comment">// 触发 fork 事件</span></span><br><span class="line">  process.<span class="title function_">nextTick</span>(emitForkNT, worker);</span><br><span class="line">  cluster.<span class="property">workers</span>[worker.<span class="property">id</span>] = worker; </span><br><span class="line">  <span class="keyword">return</span> worker;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createWorkerProcess</span>(<span class="params">id, env</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> workerEnv = &#123; ...process.<span class="property">env</span>, ...env, <span class="attr">NODE_UNIQUE_ID</span>: <span class="string">`<span class="subst">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class="line">  <span class="comment">// ... 对一些参数的组合和设定</span></span><br><span class="line">  <span class="comment">// 调用child_process的fork方法创建子进程</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fork</span>(cluster.<span class="property">settings</span>.<span class="property">exec</span>, cluster.<span class="property">settings</span>.<span class="property">args</span>, &#123;</span><br><span class="line">    <span class="attr">cwd</span>: cluster.<span class="property">settings</span>.<span class="property">cwd</span>,</span><br><span class="line">    <span class="attr">env</span>: workerEnv,</span><br><span class="line">    <span class="attr">silent</span>: cluster.<span class="property">settings</span>.<span class="property">silent</span>,</span><br><span class="line">    <span class="attr">windowsHide</span>: cluster.<span class="property">settings</span>.<span class="property">windowsHide</span>,</span><br><span class="line">    <span class="attr">execArgv</span>: execArgv,</span><br><span class="line">    <span class="attr">stdio</span>: cluster.<span class="property">settings</span>.<span class="property">stdio</span>,</span><br><span class="line">    <span class="attr">gid</span>: cluster.<span class="property">settings</span>.<span class="property">gid</span>,</span><br><span class="line">    <span class="attr">uid</span>: cluster.<span class="property">settings</span>.<span class="property">uid</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onmessage</span>(<span class="params">message, handle</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> worker = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="comment">// ... if message.act 类型很多 这里主要讲 queryServer</span></span><br><span class="line">  <span class="keyword">if</span> (message.<span class="property">act</span> === <span class="string">&quot;queryServer&quot;</span>) <span class="title function_">queryServer</span>(worker, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/internal/cluster/utils.js</span></span><br><span class="line"><span class="comment">// 在cluster的chilid和master里的send都会调用sendHelper</span></span><br><span class="line"><span class="keyword">let</span> seq = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendHelper</span>(<span class="params">proc, message, handle, cb</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!proc.<span class="property">connected</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// NODE_* 开头的命令触发 internalMessage </span></span><br><span class="line">  message = &#123; <span class="attr">cmd</span>: <span class="string">&quot;NODE_CLUSTER&quot;</span>, ...message, seq &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> cb === <span class="string">&quot;function&quot;</span>) callbacks.<span class="title function_">set</span>(seq, cb); <span class="comment">// 缓存回调</span></span><br><span class="line"></span><br><span class="line">  seq += <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// cluster/child.js handle =&gt; null</span></span><br><span class="line">  <span class="comment">// cluster/master.js handle =&gt; null</span></span><br><span class="line">  <span class="keyword">return</span> proc.<span class="title function_">send</span>(message, handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上就是cluster.fork的大致过程，引入一个Worker和internalMessage概念，之后会用得到。cluster的child和master之间传输信息，都是通过<code>sendHelper</code>方法。</p>
<h3 id="Q-cluster-fork创建的子进程如何共同监听TCP端口？"><a href="#Q-cluster-fork创建的子进程如何共同监听TCP端口？" class="headerlink" title="Q:cluster.fork创建的子进程如何共同监听TCP端口？"></a>Q:cluster.fork创建的子进程如何共同监听TCP端口？</h3><p>解答这个问题，主要是看<code>net</code>模块如何创建Server的，还有就是cluster中<code>child</code>和<code>master</code>如何通信的。</p>
<p>官方示例虽然用的是<code>http</code>创建的服务，但它底层是继承的<code>net</code>模块，为了方便梳理，我们从<code>net.createServer</code>入手一步步查看源码，主要的逻辑从<code>listen</code>开始。</p>
<h4 id="Child部分"><a href="#Child部分" class="headerlink" title="Child部分:"></a>Child部分:</h4><p>cluster.child里创建一个TCP服务，参数<code>port</code>是8000，<code>host</code>没有传参；</p>
<p>调用<code>listenInCluster</code>方法，一看这名字就知道和<strong>cluster</strong>有关；</p>
<p><code>listen</code>是在子进程里触发的，它会通过<code>cluster._getServer</code>拼出一个<code>act</code>为serverQuery的消息发送给cluster.master；</p>
<h4 id="Master部分"><a href="#Master部分" class="headerlink" title="Master部分:"></a>Master部分:</h4><p>前文提到，<code>master.onmessage</code>方法会根据消息的act不同而做出不同的处理，此处正是<code>serverQuery</code>；</p>
<p>进入<code>queryServer</code>方法，默认使用<code>RoundRobinHandle</code>循环分配任务；</p>
<p>在<code>RoundRobinHandle</code>构造函数中，会调用<code>net.createServer</code>创建一个Server，由于是在cluster.master里调用的，所以会在<code>listenInCluster</code>里调用<code>server._listen2</code>，会new 出 <code>TCP</code>（src&#x2F;tcp_wrap.cc）作为句柄，并将其赋给<code>server._handle</code>，至此cluster.master已经拥有了处理TCP请求的能力，不过master有该能力是不行的，还需要让child拥有才行；</p>
<p><code>RoundRobinHandle</code>中一旦server触发了<code>listening</code>事件后，它会接管<code>server._handle</code>，用<code>distribute</code>重置其<code>onconnection</code>方法；</p>
<p><code>distribute</code>的作用就是转发新的请求TCP给cluster.child，从<code>free</code>列队中取出一个之前<code>add</code>进来的worker（这个worker和cluster.child有关联关系），发送一个<code>act</code>为<strong>newconn</strong>的消息让其处理这个TCP；</p>
<h4 id="回到Child部分"><a href="#回到Child部分" class="headerlink" title="回到Child部分:"></a>回到Child部分:</h4><p>cluster.child的<code>onconnection</code>收到<code>act</code>为<strong>newconn</strong>的请求后，会找到之前的创建的server，然后调用其<code>onconnection</code>（child里的该方法没有被重置）方法，然后封装出一个<code>Socket</code>对象，触发<code>onnection</code>事件；</p>
<p>到此，后面的就是普通业务逻辑代码了。</p>
<p><em>下面贴上了部分相关代码，还是比较多的，细节部分我也加上了注释。</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/net.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createServer</span>(<span class="params">options, connectionListener</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Server</span>(options, connectionListener);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Server</span>(<span class="params">options, connectionListener</span>) &#123;</span><br><span class="line">  <span class="comment">// ... 大量内置属性和参数的初始化</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Server</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">listen</span> = <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 传了port参数（8000），没有host</span></span><br><span class="line">  <span class="keyword">var</span> backlog;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> options.<span class="property">port</span> === <span class="string">&quot;number&quot;</span> || <span class="keyword">typeof</span> options.<span class="property">port</span> === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">    backlog = options.<span class="property">backlog</span> || backlogFromArgs;</span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">host</span>) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// </span></span><br><span class="line">      <span class="title function_">listenInCluster</span>(</span><br><span class="line">        <span class="variable language_">this</span>,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        options.<span class="property">port</span> | <span class="number">0</span>,</span><br><span class="line">        <span class="number">4</span>,</span><br><span class="line">        backlog,</span><br><span class="line">        <span class="literal">undefined</span>,</span><br><span class="line">        options.<span class="property">exclusive</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">listenInCluster</span>(<span class="params"></span></span><br><span class="line"><span class="params">  server,</span></span><br><span class="line"><span class="params">  address,</span></span><br><span class="line"><span class="params">  port,</span></span><br><span class="line"><span class="params">  addressType,</span></span><br><span class="line"><span class="params">  backlog,</span></span><br><span class="line"><span class="params">  fd,</span></span><br><span class="line"><span class="params">  exclusive,</span></span><br><span class="line"><span class="params">  flags</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  exclusive = !!exclusive;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cluster === <span class="literal">undefined</span>) cluster = <span class="built_in">require</span>(<span class="string">&quot;cluster&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cluster.<span class="property">isMaster</span> || exclusive) &#123;</span><br><span class="line">    server.<span class="title function_">_listen2</span>(address, port, addressType, backlog, fd, flags);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> serverQuery = &#123;</span><br><span class="line">    <span class="attr">address</span>: address,</span><br><span class="line">    <span class="attr">port</span>: port, </span><br><span class="line">    <span class="attr">addressType</span>: addressType,</span><br><span class="line">    <span class="attr">fd</span>: fd,</span><br><span class="line">    flags,</span><br><span class="line">  &#125;;</span><br><span class="line">  cluster.<span class="title function_">_getServer</span>(server, serverQuery, listenOnMasterHandle);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">listenOnMasterHandle</span>(<span class="params">err, handle</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    server.<span class="property">_handle</span> = handle;</span><br><span class="line">    server.<span class="title function_">_listen2</span>(address, port, addressType, backlog, fd, flags);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/internal/cluster/child.js</span></span><br><span class="line">cluster.<span class="property">_getServer</span> = <span class="keyword">function</span> (<span class="params">obj, options, cb</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> address = options.<span class="property">address</span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 当前创建的server信息是否之前已经在cluster.child里查询过</span></span><br><span class="line">  <span class="comment">// 有的话就累加计数index值</span></span><br><span class="line">  <span class="keyword">const</span> indexesKey = [</span><br><span class="line">    address, </span><br><span class="line">    options.<span class="property">port</span>,</span><br><span class="line">    options.<span class="property">addressType</span>,</span><br><span class="line">    options.<span class="property">fd</span>,</span><br><span class="line">  ].<span class="title function_">join</span>(<span class="string">&quot;:&quot;</span>); </span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> index = indexes.<span class="title function_">get</span>(indexesKey);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (index === <span class="literal">undefined</span>) index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span> index++;</span><br><span class="line"></span><br><span class="line">  indexes.<span class="title function_">set</span>(indexesKey, index);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> message = &#123;</span><br><span class="line">    <span class="attr">act</span>: <span class="string">&quot;queryServer&quot;</span>,</span><br><span class="line">    index,</span><br><span class="line">    <span class="attr">data</span>: <span class="literal">null</span>,</span><br><span class="line">    ...options,</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">send</span>(message, <span class="function">(<span class="params">reply, handle</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (handle) <span class="title function_">shared</span>(reply, handle, indexesKey, cb);</span><br><span class="line">    <span class="comment">// Shared listen socket.</span></span><br><span class="line">    <span class="keyword">else</span> <span class="title function_">rr</span>(reply, indexesKey, cb); <span class="comment">// Round-robin 返回的 handle 是null</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">rr</span>(<span class="params">message, indexesKey, cb</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (message.<span class="property">errno</span>) <span class="keyword">return</span> <span class="title function_">cb</span>(message.<span class="property">errno</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> key = message.<span class="property">key</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">listen</span>(<span class="params">backlog</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">close</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="literal">undefined</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="title function_">send</span>(&#123; <span class="attr">act</span>: <span class="string">&quot;close&quot;</span>, key &#125;);</span><br><span class="line">    handles.<span class="title function_">delete</span>(key);</span><br><span class="line">    indexes.<span class="title function_">delete</span>(indexesKey);</span><br><span class="line">    key = <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getsockname</span>(<span class="params">out</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key) <span class="title class_">Object</span>.<span class="title function_">assign</span>(out, message.<span class="property">sockname</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handle = &#123; close, listen, <span class="attr">ref</span>: noop, <span class="attr">unref</span>: noop &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (message.<span class="property">sockname</span>) &#123;</span><br><span class="line">    handle.<span class="property">getsockname</span> = getsockname; <span class="comment">// TCP handles only.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">assert</span>(handles.<span class="title function_">has</span>(key) === <span class="literal">false</span>);</span><br><span class="line">  handles.<span class="title function_">set</span>(key, handle);</span><br><span class="line">  <span class="title function_">cb</span>(<span class="number">0</span>, handle); <span class="comment">// 将封装好的handle，作为listenInCluster的回调handle，赋给server._handle</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Round-robin connection.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onconnection</span>(<span class="params">message, handle</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> key = message.<span class="property">key</span>; <span class="comment">// maseter里的key</span></span><br><span class="line">  <span class="keyword">const</span> server = handles.<span class="title function_">get</span>(key); <span class="comment">// 是client创建的server？</span></span><br><span class="line">  <span class="keyword">const</span> accepted = server !== <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">send</span>(&#123; <span class="attr">ack</span>: message.<span class="property">seq</span>, accepted &#125;); <span class="comment">// 答复 master</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 虽然cluster.child rr里没有为server绑定，onconnection</span></span><br><span class="line">  <span class="comment">// 但是在cb回到net.js里，后面的逻辑绑定了onconnection方法</span></span><br><span class="line">  <span class="keyword">if</span> (accepted) server.<span class="title function_">onconnection</span>(<span class="number">0</span>, handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/internal/cluster/master.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">queryServer</span>(<span class="params">worker, message</span>) &#123;</span><br><span class="line">  <span class="comment">// worker是cluster.child worker</span></span><br><span class="line">  <span class="keyword">const</span> key =</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;message.address&#125;</span>:<span class="subst">$&#123;message.port&#125;</span>:<span class="subst">$&#123;message.addressType&#125;</span>:`</span> +</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;message.fd&#125;</span>:<span class="subst">$&#123;message.index&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">var</span> handle = handles.<span class="title function_">get</span>(key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (handle === <span class="literal">undefined</span>) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 默认是RoundRobin，Shared模式暂不讨论有兴趣可以看源码</span></span><br><span class="line">    <span class="keyword">var</span> constructor = <span class="title class_">RoundRobinHandle</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    handle = <span class="keyword">new</span> <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">      key,</span></span><br><span class="line"><span class="params">      address,</span></span><br><span class="line"><span class="params">      message.port,</span></span><br><span class="line"><span class="params">      message.addressType,</span></span><br><span class="line"><span class="params">      message.fd,</span></span><br><span class="line"><span class="params">      message.flags</span></span><br><span class="line"><span class="params">    </span>);</span><br><span class="line">    handles.<span class="title function_">set</span>(key, handle);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 将cluster.child的worker添加到handle中</span></span><br><span class="line">  handle.<span class="title function_">add</span>(worker, <span class="function">(<span class="params">errno, reply, handle</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = handles.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="title function_">send</span>(</span><br><span class="line">      worker,</span><br><span class="line">      &#123;</span><br><span class="line">        errno,</span><br><span class="line">        key,</span><br><span class="line">        <span class="attr">ack</span>: message.<span class="property">seq</span>,</span><br><span class="line">        data,</span><br><span class="line">        ...reply,</span><br><span class="line">      &#125;,</span><br><span class="line">      handle <span class="comment">// round_robin_handle 里返回的是一个null</span></span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/internal/cluster/round_robin_handle.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">RoundRobinHandle</span>(<span class="params">key, address, port, addressType, fd, flags</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">key</span> = key;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">all</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">free</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">handles</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">handle</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">server</span> = net.<span class="title function_">createServer</span>(assert.<span class="property">fail</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) <span class="variable language_">this</span>.<span class="property">server</span>.<span class="title function_">listen</span>(&#123; fd &#125;);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (port &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">server</span>.<span class="title function_">listen</span>(&#123;</span><br><span class="line">      port,</span><br><span class="line">      <span class="attr">host</span>: address,</span><br><span class="line">      <span class="comment">// Currently, net module only supports `ipv6Only` option in `flags`.</span></span><br><span class="line">      <span class="attr">ipv6Only</span>: <span class="title class_">Boolean</span>(flags &amp; constants.<span class="property">UV_TCP_IPV6ONLY</span>),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="variable language_">this</span>.<span class="property">server</span>.<span class="title function_">listen</span>(address); <span class="comment">// UNIX socket path.</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">server</span>.<span class="title function_">once</span>(<span class="string">&quot;listening&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handle</span> = <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">_handle</span>;</span><br><span class="line">    <span class="comment">// 重置onconnection方法</span></span><br><span class="line">    <span class="comment">// distribute 做任务派发</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handle</span>.<span class="property">onconnection</span> = <span class="function">(<span class="params">err, handle</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">distribute</span>(err, handle);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">_handle</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">server</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">RoundRobinHandle</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">add</span> = <span class="keyword">function</span> (<span class="params">worker, send</span>) &#123;</span><br><span class="line">  <span class="title function_">assert</span>(<span class="variable language_">this</span>.<span class="property">all</span>.<span class="title function_">has</span>(worker.<span class="property">id</span>) === <span class="literal">false</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">all</span>.<span class="title function_">set</span>(worker.<span class="property">id</span>, worker);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">done</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handle</span>.<span class="property">getsockname</span>) &#123;</span><br><span class="line">      <span class="comment">// tcp\udp 会有getsockname</span></span><br><span class="line">      <span class="keyword">const</span> out = &#123;&#125;;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handle</span>.<span class="title function_">getsockname</span>(out);</span><br><span class="line">      <span class="comment">// TODO(bnoordhuis) Check err.</span></span><br><span class="line">      <span class="title function_">send</span>(<span class="literal">null</span>, &#123; <span class="attr">sockname</span>: out &#125;, <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">send</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>); <span class="comment">// UNIX socket.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">handoff</span>(worker); <span class="comment">// In case there are connections pending.</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">server</span> === <span class="literal">null</span>) <span class="keyword">return</span> <span class="title function_">done</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Still busy binding.</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">server</span>.<span class="title function_">once</span>(<span class="string">&quot;listening&quot;</span>, done);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">server</span>.<span class="title function_">once</span>(<span class="string">&quot;error&quot;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">send</span>(err.<span class="property">errno</span>, <span class="literal">null</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">RoundRobinHandle</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">distribute</span> = <span class="keyword">function</span> (<span class="params">err, handle</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">handles</span>.<span class="title function_">push</span>(handle);</span><br><span class="line">  <span class="keyword">const</span> worker = <span class="variable language_">this</span>.<span class="property">free</span>.<span class="title function_">shift</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (worker) <span class="variable language_">this</span>.<span class="title function_">handoff</span>(worker);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">RoundRobinHandle</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">handoff</span> = <span class="keyword">function</span> (<span class="params">worker</span>) &#123;</span><br><span class="line">  <span class="comment">// worker如果不存在那就跳出</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">all</span>.<span class="title function_">has</span>(worker.<span class="property">id</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>; <span class="comment">// Worker is closing (or has closed) the server.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handle = <span class="variable language_">this</span>.<span class="property">handles</span>.<span class="title function_">shift</span>(); <span class="comment">// 取出第一个待处理任务</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (handle === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">free</span>.<span class="title function_">push</span>(worker);  <span class="comment">// 没有的话就会将worker归还到free里</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> message = &#123; <span class="attr">act</span>: <span class="string">&quot;newconn&quot;</span>, <span class="attr">key</span>: <span class="variable language_">this</span>.<span class="property">key</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">sendHelper</span>(worker.<span class="property">process</span>, message, handle, <span class="function">(<span class="params">reply</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (reply.<span class="property">accepted</span>) handle.<span class="title function_">close</span>();</span><br><span class="line">    <span class="keyword">else</span> <span class="variable language_">this</span>.<span class="title function_">distribute</span>(<span class="number">0</span>, handle); <span class="comment">// Worker is shutting down. Send to another.</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">handoff</span>(worker);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><p><code>cluster</code>利用child_process的fork方法创建子进程，并传入新的环境变量<code>NODE_UNIQUE_ID</code>用于区分主子进程从而在require(‘cluster’)时候可以加载到对应的<code>master.js</code>和<code>child.js</code>文件。另外在默认的<code>RoundRobinHandle</code>模式下，<code>cluster</code>子进程之所以可以共同监听同个TCP端口，是在<code>net</code>模块里面做了master和child区分，child并没有真正的监听端口，而是child会去master查询该Server是否已经存在，如果没有会在<code>RoundRobinHandle</code>中创建中创建server，一旦有新的TCP连接进入，会转发给<code>free</code>里的worker（cluster.child）处理。</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Node-js/">#Node.js</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/JavaScript/">#JavaScript</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2020/06/28/nodejs-istio-k8s-docker/">Istio简单概念</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2020/04/06/child_process-exec-fork-spawn/">简单梳理Node.js创建子进程的方法（上）</a>
            
        </span>
    </div>
    
</article>



<div class="comments">
    <div class="adv">
  <!-- <ul>
    <li class="img"><img src="/images/give-a-reward.png" alt="reward" /></li>
    <li>
      欢迎加入<a href="https://oriente.com/" target="_blank">Oriente</a
      >前端组，<a
        href="https://www.lagou.com/jobs/4927018.html?source=pl&i=pl-3"
        target="_blank"
        >岗位信息</a
      >
    </li>
    <li>
      同时也欢迎光顾我的小店<a href="http://aimianwu.com" target="_blank"
        >爱眠物</a
      >
    </li>
  </ul> -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1234567890123456" crossorigin="anonymous"></script>
  <!-- 尾部广告 -->
  <!-- <ins
    class="adsbygoogle"
    style="display: block"
    data-ad-client="ca-pub-6006630417531788"
    data-ad-slot="2988625841"
    data-ad-format="auto"
    data-full-width-responsive="true"
  ></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script> -->
</div>

    <h3 class="title is-4">Comments</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://miser.github.io/2020/05/03/node-js-net-cluster-fork/';
        this.page.identifier = '2020/05/03/node-js-net-cluster-fork/';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'mblof' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section> <footer class="footer">
  <div class="container">
    <div class="columns content">
      <div class="column is-narrow has-text-centered">
        &copy; 2024 Miser&nbsp; Powered by
        <a href="http://hexo.io/" target="_blank">Hexo</a> &
        <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
      </div>
      <div class="column is-hidden-mobile"></div>

       
    </div>
  </div>
</footer>
 <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    

    



<script src="/js/script.js"></script>
 
  </body>
</html>
